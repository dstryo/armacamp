/*! For license information please see 565cbd06c7042a835653.bundle.js.LICENSE.txt */
(()=>{var e,g,t={52:e=>{"use strict";e.exports=function(e,g){if(null==e)throw new TypeError("expected first argument to be an object.");if(void 0===g||"undefined"==typeof Symbol)return e;if("function"!=typeof Object.getOwnPropertySymbols)return e;for(var t=Object.prototype.propertyIsEnumerable,I=Object(e),n=arguments.length,i=0;++i<n;)for(var C=Object(arguments[i]),o=Object.getOwnPropertySymbols(C),a=0;a<o.length;a++){var s=o[a];t.call(C,s)&&(I[s]=C[s])}return I}},363:(e,g)=>{"use strict";g.Z=function(e,g){if(e&&g){var t=Array.isArray(g)?g:g.split(","),I=e.name||"",n=(e.type||"").toLowerCase(),i=n.replace(/\/.*$/,"");return t.some((function(e){var g=e.trim().toLowerCase();return"."===g.charAt(0)?I.toLowerCase().endsWith(g):g.endsWith("/*")?i===g.replace(/\/.*$/,""):n===g}))}return!0}},447:(e,g,t)=>{"use strict";t.d(g,{Z:()=>o});var I=t(81),n=t.n(I),i=t(645),C=t.n(i)()(n());C.push([e.id,"html,body,#root{height:100%;margin:0;background:#000;font-family:monospace;color:#fff}#instructions{position:absolute;left:50%;top:10px;margin-left:-200px;filter:drop-shadow(1px 1px 1px #000000)}#instructions a{color:#fff}",""]);const o=C},645:e=>{"use strict";e.exports=function(e){var g=[];return g.toString=function(){return this.map((function(g){var t="",I=void 0!==g[5];return g[4]&&(t+="@supports (".concat(g[4],") {")),g[2]&&(t+="@media ".concat(g[2]," {")),I&&(t+="@layer".concat(g[5].length>0?" ".concat(g[5]):""," {")),t+=e(g),I&&(t+="}"),g[2]&&(t+="}"),g[4]&&(t+="}"),t})).join("")},g.i=function(e,t,I,n,i){"string"==typeof e&&(e=[[null,e,void 0]]);var C={};if(I)for(var o=0;o<this.length;o++){var a=this[o][0];null!=a&&(C[a]=!0)}for(var s=0;s<e.length;s++){var l=[].concat(e[s]);I&&C[l[0]]||(void 0!==i&&(void 0===l[5]||(l[1]="@layer".concat(l[5].length>0?" ".concat(l[5]):""," {").concat(l[1],"}")),l[5]=i),t&&(l[2]?(l[1]="@media ".concat(l[2]," {").concat(l[1],"}"),l[2]=t):l[2]=t),n&&(l[4]?(l[1]="@supports (".concat(l[4],") {").concat(l[1],"}"),l[4]=n):l[4]="".concat(n)),g.push(l))}},g}},81:e=>{"use strict";e.exports=function(e){return e[1]}},296:e=>{function g(e,g,t){var I,n,i,C,o;function a(){var s=Date.now()-C;s<g&&s>=0?I=setTimeout(a,g-s):(I=null,t||(o=e.apply(i,n),i=n=null))}null==g&&(g=100);var s=function(){i=this,n=arguments,C=Date.now();var s=t&&!I;return I||(I=setTimeout(a,g)),s&&(o=e.apply(i,n),i=n=null),o};return s.clear=function(){I&&(clearTimeout(I),I=null)},s.flush=function(){I&&(o=e.apply(i,n),i=n=null,clearTimeout(I),I=null)},s}g.debounce=g,e.exports=g},919:(e,g,t)=>{"use strict";var I=t(104);function n(e,g){for(var t in g)i(g,t)&&(e[t]=g[t])}function i(e,g){return Object.prototype.hasOwnProperty.call(e,g)}e.exports=function(e){I(e)||(e={});for(var g=arguments.length,t=1;t<g;t++){var i=arguments[t];I(i)&&n(e,i)}return e}},104:e=>{"use strict";e.exports=function(e){return null!=e&&("object"==typeof e||"function"==typeof e)}},561:e=>{"use strict";e.exports=function(e,g,t){for(var I in e)if(!1===g.call(t,e[I],I,e))break}},200:e=>{function g(e){return e?Array.isArray(e)?e.join("."):e:""}e.exports=function(e,t,I,n,i){if(null===(C=e)||"object"!=typeof C&&"function"!=typeof C||!t)return e;var C;if(t=g(t),I&&(t+="."+g(I)),n&&(t+="."+g(n)),i&&(t+="."+g(i)),t in e)return e[t];for(var o=t.split("."),a=o.length,s=-1;e&&++s<a;){for(var l=o[s];"\\"===l[l.length-1];)l=l.slice(0,-1)+"."+o[++s];e=e[l]}return e}},833:(e,g,t)=>{"use strict";var I=t(299);e.exports=function(e){return I(e)||"function"==typeof e||Array.isArray(e)}},299:(e,g,t)=>{"use strict";var I=t(682);function n(e){return!0===I(e)&&"[object Object]"===Object.prototype.toString.call(e)}e.exports=function(e){var g,t;return!1!==n(e)&&"function"==typeof(g=e.constructor)&&!1!==n(t=g.prototype)&&!1!==t.hasOwnProperty("isPrototypeOf")}},682:e=>{"use strict";e.exports=function(e){return null!=e&&"object"==typeof e&&!1===Array.isArray(e)}},529:(e,g,t)=>{"use strict";var I=t(833),n=t(386),i=t(200),C=t(86);e.exports=function(e,g,t){if(!I(e))throw new TypeError("expected an object");if("string"!=typeof g||null==t)return n.apply(null,arguments);if("string"==typeof t)return C(e,g,t),e;var o=i(e,g);return I(t)&&I(o)&&(t=n({},o,t)),C(e,g,t),e}},386:(e,g,t)=>{"use strict";var I=t(833),n=t(561);function i(e,g){for(var t=arguments.length,I=0;++I<t;){var i=arguments[I];o(i)&&n(i,C,e)}return e}function C(e,g){if(function(e){return"__proto__"!==e&&"constructor"!==e&&"prototype"!==e}(g)){var t=this[g];o(e)&&o(t)?i(t,e):this[g]=e}}function o(e){return I(e)&&!Array.isArray(e)}e.exports=i},703:(e,g,t)=>{"use strict";var I=t(414);function n(){}function i(){}i.resetWarningCache=n,e.exports=function(){function e(e,g,t,n,i,C){if(C!==I){var o=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw o.name="Invariant Violation",o}}function g(){return e}e.isRequired=e;var t={array:e,bigint:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:g,element:e,elementType:e,instanceOf:g,node:e,objectOf:g,oneOf:g,oneOfType:g,shape:g,exact:g,checkPropTypes:i,resetWarningCache:n};return t.PropTypes=t,t}},697:(e,g,t)=>{e.exports=t(703)()},414:e=>{"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},448:(e,g,t)=>{"use strict";var I=t(294),n=t(142);function i(e){for(var g="https://reactjs.org/docs/error-decoder.html?invariant="+e,t=1;t<arguments.length;t++)g+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+e+"; visit "+g+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var C=new Set,o={};function a(e,g){s(e,g),s(e+"Capture",g)}function s(e,g){for(o[e]=g,e=0;e<g.length;e++)C.add(g[e])}var l=!("undefined"==typeof window||void 0===window.document||void 0===window.document.createElement),r=Object.prototype.hasOwnProperty,A=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,c={},d={};function u(e,g,t,I,n,i,C){this.acceptsBooleans=2===g||3===g||4===g,this.attributeName=I,this.attributeNamespace=n,this.mustUseProperty=t,this.propertyName=e,this.type=g,this.sanitizeURL=i,this.removeEmptyString=C}var h={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(e){h[e]=new u(e,0,!1,e,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(e){var g=e[0];h[g]=new u(g,1,!1,e[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(e){h[e]=new u(e,2,!1,e.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(e){h[e]=new u(e,2,!1,e,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(e){h[e]=new u(e,3,!1,e.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(e){h[e]=new u(e,3,!0,e,null,!1,!1)})),["capture","download"].forEach((function(e){h[e]=new u(e,4,!1,e,null,!1,!1)})),["cols","rows","size","span"].forEach((function(e){h[e]=new u(e,6,!1,e,null,!1,!1)})),["rowSpan","start"].forEach((function(e){h[e]=new u(e,5,!1,e.toLowerCase(),null,!1,!1)}));var b=/[\-:]([a-z])/g;function m(e){return e[1].toUpperCase()}function p(e,g,t,I){var n=h.hasOwnProperty(g)?h[g]:null;(null!==n?0!==n.type:I||!(2<g.length)||"o"!==g[0]&&"O"!==g[0]||"n"!==g[1]&&"N"!==g[1])&&(function(e,g,t,I){if(null==g||function(e,g,t,I){if(null!==t&&0===t.type)return!1;switch(typeof g){case"function":case"symbol":return!0;case"boolean":return!I&&(null!==t?!t.acceptsBooleans:"data-"!==(e=e.toLowerCase().slice(0,5))&&"aria-"!==e);default:return!1}}(e,g,t,I))return!0;if(I)return!1;if(null!==t)switch(t.type){case 3:return!g;case 4:return!1===g;case 5:return isNaN(g);case 6:return isNaN(g)||1>g}return!1}(g,t,n,I)&&(t=null),I||null===n?function(e){return!!r.call(d,e)||!r.call(c,e)&&(A.test(e)?d[e]=!0:(c[e]=!0,!1))}(g)&&(null===t?e.removeAttribute(g):e.setAttribute(g,""+t)):n.mustUseProperty?e[n.propertyName]=null===t?3!==n.type&&"":t:(g=n.attributeName,I=n.attributeNamespace,null===t?e.removeAttribute(g):(t=3===(n=n.type)||4===n&&!0===t?"":""+t,I?e.setAttributeNS(I,g,t):e.setAttribute(g,t))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(e){var g=e.replace(b,m);h[g]=new u(g,1,!1,e,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(e){var g=e.replace(b,m);h[g]=new u(g,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(e){var g=e.replace(b,m);h[g]=new u(g,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(e){h[e]=new u(e,1,!1,e.toLowerCase(),null,!1,!1)})),h.xlinkHref=new u("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(e){h[e]=new u(e,1,!1,e.toLowerCase(),null,!0,!0)}));var G=I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,B=Symbol.for("react.element"),Z=Symbol.for("react.portal"),y=Symbol.for("react.fragment"),v=Symbol.for("react.strict_mode"),W=Symbol.for("react.profiler"),f=Symbol.for("react.provider"),w=Symbol.for("react.context"),R=Symbol.for("react.forward_ref"),V=Symbol.for("react.suspense"),X=Symbol.for("react.suspense_list"),S=Symbol.for("react.memo"),Y=Symbol.for("react.lazy");Symbol.for("react.scope"),Symbol.for("react.debug_trace_mode");var K=Symbol.for("react.offscreen");Symbol.for("react.legacy_hidden"),Symbol.for("react.cache"),Symbol.for("react.tracing_marker");var H=Symbol.iterator;function N(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=H&&e[H]||e["@@iterator"])?e:null}var F,x=Object.assign;function z(e){if(void 0===F)try{throw Error()}catch(e){var g=e.stack.trim().match(/\n( *(at )?)/);F=g&&g[1]||""}return"\n"+F+e}var k=!1;function M(e,g){if(!e||k)return"";k=!0;var t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(g)if(g=function(){throw Error()},Object.defineProperty(g.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(g,[])}catch(e){var I=e}Reflect.construct(e,[],g)}else{try{g.call()}catch(e){I=e}e.call(g.prototype)}else{try{throw Error()}catch(e){I=e}e()}}catch(g){if(g&&I&&"string"==typeof g.stack){for(var n=g.stack.split("\n"),i=I.stack.split("\n"),C=n.length-1,o=i.length-1;1<=C&&0<=o&&n[C]!==i[o];)o--;for(;1<=C&&0<=o;C--,o--)if(n[C]!==i[o]){if(1!==C||1!==o)do{if(C--,0>--o||n[C]!==i[o]){var a="\n"+n[C].replace(" at new "," at ");return e.displayName&&a.includes("<anonymous>")&&(a=a.replace("<anonymous>",e.displayName)),a}}while(1<=C&&0<=o);break}}}finally{k=!1,Error.prepareStackTrace=t}return(e=e?e.displayName||e.name:"")?z(e):""}function L(e){switch(e.tag){case 5:return z(e.type);case 16:return z("Lazy");case 13:return z("Suspense");case 19:return z("SuspenseList");case 0:case 2:case 15:return M(e.type,!1);case 11:return M(e.type.render,!1);case 1:return M(e.type,!0);default:return""}}function J(e){if(null==e)return null;if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case y:return"Fragment";case Z:return"Portal";case W:return"Profiler";case v:return"StrictMode";case V:return"Suspense";case X:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case w:return(e.displayName||"Context")+".Consumer";case f:return(e._context.displayName||"Context")+".Provider";case R:var g=e.render;return(e=e.displayName)||(e=""!==(e=g.displayName||g.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case S:return null!==(g=e.displayName||null)?g:J(e.type)||"Memo";case Y:g=e._payload,e=e._init;try{return J(e(g))}catch(e){}}return null}function E(e){var g=e.type;switch(e.tag){case 24:return"Cache";case 9:return(g.displayName||"Context")+".Consumer";case 10:return(g._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=(e=g.render).displayName||e.name||"",g.displayName||(""!==e?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return g;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return J(g);case 8:return g===v?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"==typeof g)return g.displayName||g.name||null;if("string"==typeof g)return g}return null}function T(e){switch(typeof e){case"boolean":case"number":case"string":case"undefined":case"object":return e;default:return""}}function U(e){var g=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===g||"radio"===g)}function Q(e){e._valueTracker||(e._valueTracker=function(e){var g=U(e)?"checked":"value",t=Object.getOwnPropertyDescriptor(e.constructor.prototype,g),I=""+e[g];if(!e.hasOwnProperty(g)&&void 0!==t&&"function"==typeof t.get&&"function"==typeof t.set){var n=t.get,i=t.set;return Object.defineProperty(e,g,{configurable:!0,get:function(){return n.call(this)},set:function(e){I=""+e,i.call(this,e)}}),Object.defineProperty(e,g,{enumerable:t.enumerable}),{getValue:function(){return I},setValue:function(e){I=""+e},stopTracking:function(){e._valueTracker=null,delete e[g]}}}}(e))}function D(e){if(!e)return!1;var g=e._valueTracker;if(!g)return!0;var t=g.getValue(),I="";return e&&(I=U(e)?e.checked?"true":"false":e.value),(e=I)!==t&&(g.setValue(e),!0)}function O(e){if(void 0===(e=e||("undefined"!=typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(g){return e.body}}function j(e,g){var t=g.checked;return x({},g,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=t?t:e._wrapperState.initialChecked})}function P(e,g){var t=null==g.defaultValue?"":g.defaultValue,I=null!=g.checked?g.checked:g.defaultChecked;t=T(null!=g.value?g.value:t),e._wrapperState={initialChecked:I,initialValue:t,controlled:"checkbox"===g.type||"radio"===g.type?null!=g.checked:null!=g.value}}function _(e,g){null!=(g=g.checked)&&p(e,"checked",g,!1)}function q(e,g){_(e,g);var t=T(g.value),I=g.type;if(null!=t)"number"===I?(0===t&&""===e.value||e.value!=t)&&(e.value=""+t):e.value!==""+t&&(e.value=""+t);else if("submit"===I||"reset"===I)return void e.removeAttribute("value");g.hasOwnProperty("value")?ee(e,g.type,t):g.hasOwnProperty("defaultValue")&&ee(e,g.type,T(g.defaultValue)),null==g.checked&&null!=g.defaultChecked&&(e.defaultChecked=!!g.defaultChecked)}function $(e,g,t){if(g.hasOwnProperty("value")||g.hasOwnProperty("defaultValue")){var I=g.type;if(!("submit"!==I&&"reset"!==I||void 0!==g.value&&null!==g.value))return;g=""+e._wrapperState.initialValue,t||g===e.value||(e.value=g),e.defaultValue=g}""!==(t=e.name)&&(e.name=""),e.defaultChecked=!!e._wrapperState.initialChecked,""!==t&&(e.name=t)}function ee(e,g,t){"number"===g&&O(e.ownerDocument)===e||(null==t?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+t&&(e.defaultValue=""+t))}var ge=Array.isArray;function te(e,g,t,I){if(e=e.options,g){g={};for(var n=0;n<t.length;n++)g["$"+t[n]]=!0;for(t=0;t<e.length;t++)n=g.hasOwnProperty("$"+e[t].value),e[t].selected!==n&&(e[t].selected=n),n&&I&&(e[t].defaultSelected=!0)}else{for(t=""+T(t),g=null,n=0;n<e.length;n++){if(e[n].value===t)return e[n].selected=!0,void(I&&(e[n].defaultSelected=!0));null!==g||e[n].disabled||(g=e[n])}null!==g&&(g.selected=!0)}}function Ie(e,g){if(null!=g.dangerouslySetInnerHTML)throw Error(i(91));return x({},g,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function ne(e,g){var t=g.value;if(null==t){if(t=g.children,g=g.defaultValue,null!=t){if(null!=g)throw Error(i(92));if(ge(t)){if(1<t.length)throw Error(i(93));t=t[0]}g=t}null==g&&(g=""),t=g}e._wrapperState={initialValue:T(t)}}function ie(e,g){var t=T(g.value),I=T(g.defaultValue);null!=t&&((t=""+t)!==e.value&&(e.value=t),null==g.defaultValue&&e.defaultValue!==t&&(e.defaultValue=t)),null!=I&&(e.defaultValue=""+I)}function Ce(e){var g=e.textContent;g===e._wrapperState.initialValue&&""!==g&&null!==g&&(e.value=g)}function oe(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function ae(e,g){return null==e||"http://www.w3.org/1999/xhtml"===e?oe(g):"http://www.w3.org/2000/svg"===e&&"foreignObject"===g?"http://www.w3.org/1999/xhtml":e}var se,le,re=(le=function(e,g){if("http://www.w3.org/2000/svg"!==e.namespaceURI||"innerHTML"in e)e.innerHTML=g;else{for((se=se||document.createElement("div")).innerHTML="<svg>"+g.valueOf().toString()+"</svg>",g=se.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;g.firstChild;)e.appendChild(g.firstChild)}},"undefined"!=typeof MSApp&&MSApp.execUnsafeLocalFunction?function(e,g,t,I){MSApp.execUnsafeLocalFunction((function(){return le(e,g)}))}:le);function Ae(e,g){if(g){var t=e.firstChild;if(t&&t===e.lastChild&&3===t.nodeType)return void(t.nodeValue=g)}e.textContent=g}var ce={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},de=["Webkit","ms","Moz","O"];function ue(e,g,t){return null==g||"boolean"==typeof g||""===g?"":t||"number"!=typeof g||0===g||ce.hasOwnProperty(e)&&ce[e]?(""+g).trim():g+"px"}function he(e,g){for(var t in e=e.style,g)if(g.hasOwnProperty(t)){var I=0===t.indexOf("--"),n=ue(t,g[t],I);"float"===t&&(t="cssFloat"),I?e.setProperty(t,n):e[t]=n}}Object.keys(ce).forEach((function(e){de.forEach((function(g){g=g+e.charAt(0).toUpperCase()+e.substring(1),ce[g]=ce[e]}))}));var be=x({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function me(e,g){if(g){if(be[e]&&(null!=g.children||null!=g.dangerouslySetInnerHTML))throw Error(i(137,e));if(null!=g.dangerouslySetInnerHTML){if(null!=g.children)throw Error(i(60));if("object"!=typeof g.dangerouslySetInnerHTML||!("__html"in g.dangerouslySetInnerHTML))throw Error(i(61))}if(null!=g.style&&"object"!=typeof g.style)throw Error(i(62))}}function pe(e,g){if(-1===e.indexOf("-"))return"string"==typeof g.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Ge=null;function Be(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}var Ze=null,ye=null,ve=null;function We(e){if(e=hn(e)){if("function"!=typeof Ze)throw Error(i(280));var g=e.stateNode;g&&(g=mn(g),Ze(e.stateNode,e.type,g))}}function fe(e){ye?ve?ve.push(e):ve=[e]:ye=e}function we(){if(ye){var e=ye,g=ve;if(ve=ye=null,We(e),g)for(e=0;e<g.length;e++)We(g[e])}}function Re(e,g){return e(g)}function Ve(){}var Xe=!1;function Se(e,g,t){if(Xe)return e(g,t);Xe=!0;try{return Re(e,g,t)}finally{Xe=!1,(null!==ye||null!==ve)&&(Ve(),we())}}function Ye(e,g){var t=e.stateNode;if(null===t)return null;var I=mn(t);if(null===I)return null;t=I[g];e:switch(g){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(I=!I.disabled)||(I=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!I;break e;default:e=!1}if(e)return null;if(t&&"function"!=typeof t)throw Error(i(231,g,typeof t));return t}var Ke=!1;if(l)try{var He={};Object.defineProperty(He,"passive",{get:function(){Ke=!0}}),window.addEventListener("test",He,He),window.removeEventListener("test",He,He)}catch(le){Ke=!1}function Ne(e,g,t,I,n,i,C,o,a){var s=Array.prototype.slice.call(arguments,3);try{g.apply(t,s)}catch(e){this.onError(e)}}var Fe=!1,xe=null,ze=!1,ke=null,Me={onError:function(e){Fe=!0,xe=e}};function Le(e,g,t,I,n,i,C,o,a){Fe=!1,xe=null,Ne.apply(Me,arguments)}function Je(e){var g=e,t=e;if(e.alternate)for(;g.return;)g=g.return;else{e=g;do{0!=(4098&(g=e).flags)&&(t=g.return),e=g.return}while(e)}return 3===g.tag?t:null}function Ee(e){if(13===e.tag){var g=e.memoizedState;if(null===g&&null!==(e=e.alternate)&&(g=e.memoizedState),null!==g)return g.dehydrated}return null}function Te(e){if(Je(e)!==e)throw Error(i(188))}function Ue(e){return null!==(e=function(e){var g=e.alternate;if(!g){if(null===(g=Je(e)))throw Error(i(188));return g!==e?null:e}for(var t=e,I=g;;){var n=t.return;if(null===n)break;var C=n.alternate;if(null===C){if(null!==(I=n.return)){t=I;continue}break}if(n.child===C.child){for(C=n.child;C;){if(C===t)return Te(n),e;if(C===I)return Te(n),g;C=C.sibling}throw Error(i(188))}if(t.return!==I.return)t=n,I=C;else{for(var o=!1,a=n.child;a;){if(a===t){o=!0,t=n,I=C;break}if(a===I){o=!0,I=n,t=C;break}a=a.sibling}if(!o){for(a=C.child;a;){if(a===t){o=!0,t=C,I=n;break}if(a===I){o=!0,I=C,t=n;break}a=a.sibling}if(!o)throw Error(i(189))}}if(t.alternate!==I)throw Error(i(190))}if(3!==t.tag)throw Error(i(188));return t.stateNode.current===t?e:g}(e))?Qe(e):null}function Qe(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){var g=Qe(e);if(null!==g)return g;e=e.sibling}return null}var De=n.unstable_scheduleCallback,Oe=n.unstable_cancelCallback,je=n.unstable_shouldYield,Pe=n.unstable_requestPaint,_e=n.unstable_now,qe=n.unstable_getCurrentPriorityLevel,$e=n.unstable_ImmediatePriority,eg=n.unstable_UserBlockingPriority,gg=n.unstable_NormalPriority,tg=n.unstable_LowPriority,Ig=n.unstable_IdlePriority,ng=null,ig=null,Cg=Math.clz32?Math.clz32:function(e){return 0==(e>>>=0)?32:31-(og(e)/ag|0)|0},og=Math.log,ag=Math.LN2,sg=64,lg=4194304;function rg(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&e;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&e;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function Ag(e,g){var t=e.pendingLanes;if(0===t)return 0;var I=0,n=e.suspendedLanes,i=e.pingedLanes,C=268435455&t;if(0!==C){var o=C&~n;0!==o?I=rg(o):0!=(i&=C)&&(I=rg(i))}else 0!=(C=t&~n)?I=rg(C):0!==i&&(I=rg(i));if(0===I)return 0;if(0!==g&&g!==I&&0==(g&n)&&((n=I&-I)>=(i=g&-g)||16===n&&0!=(4194240&i)))return g;if(0!=(4&I)&&(I|=16&t),0!==(g=e.entangledLanes))for(e=e.entanglements,g&=I;0<g;)n=1<<(t=31-Cg(g)),I|=e[t],g&=~n;return I}function cg(e,g){switch(e){case 1:case 2:case 4:return g+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return g+5e3;default:return-1}}function dg(e){return 0!=(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function ug(){var e=sg;return 0==(4194240&(sg<<=1))&&(sg=64),e}function hg(e){for(var g=[],t=0;31>t;t++)g.push(e);return g}function bg(e,g,t){e.pendingLanes|=g,536870912!==g&&(e.suspendedLanes=0,e.pingedLanes=0),(e=e.eventTimes)[g=31-Cg(g)]=t}function mg(e,g){var t=e.entangledLanes|=g;for(e=e.entanglements;t;){var I=31-Cg(t),n=1<<I;n&g|e[I]&g&&(e[I]|=g),t&=~n}}var pg=0;function Gg(e){return 1<(e&=-e)?4<e?0!=(268435455&e)?16:536870912:4:1}var Bg,Zg,yg,vg,Wg,fg=!1,wg=[],Rg=null,Vg=null,Xg=null,Sg=new Map,Yg=new Map,Kg=[],Hg="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Ng(e,g){switch(e){case"focusin":case"focusout":Rg=null;break;case"dragenter":case"dragleave":Vg=null;break;case"mouseover":case"mouseout":Xg=null;break;case"pointerover":case"pointerout":Sg.delete(g.pointerId);break;case"gotpointercapture":case"lostpointercapture":Yg.delete(g.pointerId)}}function Fg(e,g,t,I,n,i){return null===e||e.nativeEvent!==i?(e={blockedOn:g,domEventName:t,eventSystemFlags:I,nativeEvent:i,targetContainers:[n]},null!==g&&null!==(g=hn(g))&&Zg(g),e):(e.eventSystemFlags|=I,g=e.targetContainers,null!==n&&-1===g.indexOf(n)&&g.push(n),e)}function xg(e){var g=un(e.target);if(null!==g){var t=Je(g);if(null!==t)if(13===(g=t.tag)){if(null!==(g=Ee(t)))return e.blockedOn=g,void Wg(e.priority,(function(){yg(t)}))}else if(3===g&&t.stateNode.current.memoizedState.isDehydrated)return void(e.blockedOn=3===t.tag?t.stateNode.containerInfo:null)}e.blockedOn=null}function zg(e){if(null!==e.blockedOn)return!1;for(var g=e.targetContainers;0<g.length;){var t=jg(e.domEventName,e.eventSystemFlags,g[0],e.nativeEvent);if(null!==t)return null!==(g=hn(t))&&Zg(g),e.blockedOn=t,!1;var I=new(t=e.nativeEvent).constructor(t.type,t);Ge=I,t.target.dispatchEvent(I),Ge=null,g.shift()}return!0}function kg(e,g,t){zg(e)&&t.delete(g)}function Mg(){fg=!1,null!==Rg&&zg(Rg)&&(Rg=null),null!==Vg&&zg(Vg)&&(Vg=null),null!==Xg&&zg(Xg)&&(Xg=null),Sg.forEach(kg),Yg.forEach(kg)}function Lg(e,g){e.blockedOn===g&&(e.blockedOn=null,fg||(fg=!0,n.unstable_scheduleCallback(n.unstable_NormalPriority,Mg)))}function Jg(e){function g(g){return Lg(g,e)}if(0<wg.length){Lg(wg[0],e);for(var t=1;t<wg.length;t++){var I=wg[t];I.blockedOn===e&&(I.blockedOn=null)}}for(null!==Rg&&Lg(Rg,e),null!==Vg&&Lg(Vg,e),null!==Xg&&Lg(Xg,e),Sg.forEach(g),Yg.forEach(g),t=0;t<Kg.length;t++)(I=Kg[t]).blockedOn===e&&(I.blockedOn=null);for(;0<Kg.length&&null===(t=Kg[0]).blockedOn;)xg(t),null===t.blockedOn&&Kg.shift()}var Eg=G.ReactCurrentBatchConfig,Tg=!0;function Ug(e,g,t,I){var n=pg,i=Eg.transition;Eg.transition=null;try{pg=1,Dg(e,g,t,I)}finally{pg=n,Eg.transition=i}}function Qg(e,g,t,I){var n=pg,i=Eg.transition;Eg.transition=null;try{pg=4,Dg(e,g,t,I)}finally{pg=n,Eg.transition=i}}function Dg(e,g,t,I){if(Tg){var n=jg(e,g,t,I);if(null===n)MI(e,g,I,Og,t),Ng(e,I);else if(function(e,g,t,I,n){switch(g){case"focusin":return Rg=Fg(Rg,e,g,t,I,n),!0;case"dragenter":return Vg=Fg(Vg,e,g,t,I,n),!0;case"mouseover":return Xg=Fg(Xg,e,g,t,I,n),!0;case"pointerover":var i=n.pointerId;return Sg.set(i,Fg(Sg.get(i)||null,e,g,t,I,n)),!0;case"gotpointercapture":return i=n.pointerId,Yg.set(i,Fg(Yg.get(i)||null,e,g,t,I,n)),!0}return!1}(n,e,g,t,I))I.stopPropagation();else if(Ng(e,I),4&g&&-1<Hg.indexOf(e)){for(;null!==n;){var i=hn(n);if(null!==i&&Bg(i),null===(i=jg(e,g,t,I))&&MI(e,g,I,Og,t),i===n)break;n=i}null!==n&&I.stopPropagation()}else MI(e,g,I,null,t)}}var Og=null;function jg(e,g,t,I){if(Og=null,null!==(e=un(e=Be(I))))if(null===(g=Je(e)))e=null;else if(13===(t=g.tag)){if(null!==(e=Ee(g)))return e;e=null}else if(3===t){if(g.stateNode.current.memoizedState.isDehydrated)return 3===g.tag?g.stateNode.containerInfo:null;e=null}else g!==e&&(e=null);return Og=e,null}function Pg(e){switch(e){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(qe()){case $e:return 1;case eg:return 4;case gg:case tg:return 16;case Ig:return 536870912;default:return 16}default:return 16}}var _g=null,qg=null,$g=null;function et(){if($g)return $g;var e,g,t=qg,I=t.length,n="value"in _g?_g.value:_g.textContent,i=n.length;for(e=0;e<I&&t[e]===n[e];e++);var C=I-e;for(g=1;g<=C&&t[I-g]===n[i-g];g++);return $g=n.slice(e,1<g?1-g:void 0)}function gt(e){var g=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===g&&(e=13):e=g,10===e&&(e=13),32<=e||13===e?e:0}function tt(){return!0}function It(){return!1}function nt(e){function g(g,t,I,n,i){for(var C in this._reactName=g,this._targetInst=I,this.type=t,this.nativeEvent=n,this.target=i,this.currentTarget=null,e)e.hasOwnProperty(C)&&(g=e[C],this[C]=g?g(n):n[C]);return this.isDefaultPrevented=(null!=n.defaultPrevented?n.defaultPrevented:!1===n.returnValue)?tt:It,this.isPropagationStopped=It,this}return x(g.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!=typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=tt)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!=typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=tt)},persist:function(){},isPersistent:tt}),g}var it,Ct,ot,at={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},st=nt(at),lt=x({},at,{view:0,detail:0}),rt=nt(lt),At=x({},lt,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:yt,button:0,buttons:0,relatedTarget:function(e){return void 0===e.relatedTarget?e.fromElement===e.srcElement?e.toElement:e.fromElement:e.relatedTarget},movementX:function(e){return"movementX"in e?e.movementX:(e!==ot&&(ot&&"mousemove"===e.type?(it=e.screenX-ot.screenX,Ct=e.screenY-ot.screenY):Ct=it=0,ot=e),it)},movementY:function(e){return"movementY"in e?e.movementY:Ct}}),ct=nt(At),dt=nt(x({},At,{dataTransfer:0})),ut=nt(x({},lt,{relatedTarget:0})),ht=nt(x({},at,{animationName:0,elapsedTime:0,pseudoElement:0})),bt=nt(x({},at,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}})),mt=nt(x({},at,{data:0})),pt={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Gt={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Bt={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Zt(e){var g=this.nativeEvent;return g.getModifierState?g.getModifierState(e):!!(e=Bt[e])&&!!g[e]}function yt(){return Zt}var vt=nt(x({},lt,{key:function(e){if(e.key){var g=pt[e.key]||e.key;if("Unidentified"!==g)return g}return"keypress"===e.type?13===(e=gt(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?Gt[e.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:yt,charCode:function(e){return"keypress"===e.type?gt(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?gt(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}})),Wt=nt(x({},At,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),ft=nt(x({},lt,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:yt})),wt=nt(x({},at,{propertyName:0,elapsedTime:0,pseudoElement:0})),Rt=nt(x({},At,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:0,deltaMode:0})),Vt=[9,13,27,32],Xt=l&&"CompositionEvent"in window,St=null;l&&"documentMode"in document&&(St=document.documentMode);var Yt=l&&"TextEvent"in window&&!St,Kt=l&&(!Xt||St&&8<St&&11>=St),Ht=String.fromCharCode(32),Nt=!1;function Ft(e,g){switch(e){case"keyup":return-1!==Vt.indexOf(g.keyCode);case"keydown":return 229!==g.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function xt(e){return"object"==typeof(e=e.detail)&&"data"in e?e.data:null}var zt=!1,kt={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Mt(e){var g=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===g?!!kt[e.type]:"textarea"===g}function Lt(e,g,t,I){fe(I),0<(g=JI(g,"onChange")).length&&(t=new st("onChange","change",null,t,I),e.push({event:t,listeners:g}))}var Jt=null,Et=null;function Tt(e){HI(e,0)}function Ut(e){if(D(bn(e)))return e}function Qt(e,g){if("change"===e)return g}var Dt=!1;if(l){var Ot;if(l){var jt="oninput"in document;if(!jt){var Pt=document.createElement("div");Pt.setAttribute("oninput","return;"),jt="function"==typeof Pt.oninput}Ot=jt}else Ot=!1;Dt=Ot&&(!document.documentMode||9<document.documentMode)}function _t(){Jt&&(Jt.detachEvent("onpropertychange",qt),Et=Jt=null)}function qt(e){if("value"===e.propertyName&&Ut(Et)){var g=[];Lt(g,Et,e,Be(e)),Se(Tt,g)}}function $t(e,g,t){"focusin"===e?(_t(),Et=t,(Jt=g).attachEvent("onpropertychange",qt)):"focusout"===e&&_t()}function eI(e){if("selectionchange"===e||"keyup"===e||"keydown"===e)return Ut(Et)}function gI(e,g){if("click"===e)return Ut(g)}function tI(e,g){if("input"===e||"change"===e)return Ut(g)}var II="function"==typeof Object.is?Object.is:function(e,g){return e===g&&(0!==e||1/e==1/g)||e!=e&&g!=g};function nI(e,g){if(II(e,g))return!0;if("object"!=typeof e||null===e||"object"!=typeof g||null===g)return!1;var t=Object.keys(e),I=Object.keys(g);if(t.length!==I.length)return!1;for(I=0;I<t.length;I++){var n=t[I];if(!r.call(g,n)||!II(e[n],g[n]))return!1}return!0}function iI(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function CI(e,g){var t,I=iI(e);for(e=0;I;){if(3===I.nodeType){if(t=e+I.textContent.length,e<=g&&t>=g)return{node:I,offset:g-e};e=t}e:{for(;I;){if(I.nextSibling){I=I.nextSibling;break e}I=I.parentNode}I=void 0}I=iI(I)}}function oI(e,g){return!(!e||!g)&&(e===g||(!e||3!==e.nodeType)&&(g&&3===g.nodeType?oI(e,g.parentNode):"contains"in e?e.contains(g):!!e.compareDocumentPosition&&!!(16&e.compareDocumentPosition(g))))}function aI(){for(var e=window,g=O();g instanceof e.HTMLIFrameElement;){try{var t="string"==typeof g.contentWindow.location.href}catch(e){t=!1}if(!t)break;g=O((e=g.contentWindow).document)}return g}function sI(e){var g=e&&e.nodeName&&e.nodeName.toLowerCase();return g&&("input"===g&&("text"===e.type||"search"===e.type||"tel"===e.type||"url"===e.type||"password"===e.type)||"textarea"===g||"true"===e.contentEditable)}function lI(e){var g=aI(),t=e.focusedElem,I=e.selectionRange;if(g!==t&&t&&t.ownerDocument&&oI(t.ownerDocument.documentElement,t)){if(null!==I&&sI(t))if(g=I.start,void 0===(e=I.end)&&(e=g),"selectionStart"in t)t.selectionStart=g,t.selectionEnd=Math.min(e,t.value.length);else if((e=(g=t.ownerDocument||document)&&g.defaultView||window).getSelection){e=e.getSelection();var n=t.textContent.length,i=Math.min(I.start,n);I=void 0===I.end?i:Math.min(I.end,n),!e.extend&&i>I&&(n=I,I=i,i=n),n=CI(t,i);var C=CI(t,I);n&&C&&(1!==e.rangeCount||e.anchorNode!==n.node||e.anchorOffset!==n.offset||e.focusNode!==C.node||e.focusOffset!==C.offset)&&((g=g.createRange()).setStart(n.node,n.offset),e.removeAllRanges(),i>I?(e.addRange(g),e.extend(C.node,C.offset)):(g.setEnd(C.node,C.offset),e.addRange(g)))}for(g=[],e=t;e=e.parentNode;)1===e.nodeType&&g.push({element:e,left:e.scrollLeft,top:e.scrollTop});for("function"==typeof t.focus&&t.focus(),t=0;t<g.length;t++)(e=g[t]).element.scrollLeft=e.left,e.element.scrollTop=e.top}}var rI=l&&"documentMode"in document&&11>=document.documentMode,AI=null,cI=null,dI=null,uI=!1;function hI(e,g,t){var I=t.window===t?t.document:9===t.nodeType?t:t.ownerDocument;uI||null==AI||AI!==O(I)||(I="selectionStart"in(I=AI)&&sI(I)?{start:I.selectionStart,end:I.selectionEnd}:{anchorNode:(I=(I.ownerDocument&&I.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:I.anchorOffset,focusNode:I.focusNode,focusOffset:I.focusOffset},dI&&nI(dI,I)||(dI=I,0<(I=JI(cI,"onSelect")).length&&(g=new st("onSelect","select",null,g,t),e.push({event:g,listeners:I}),g.target=AI)))}function bI(e,g){var t={};return t[e.toLowerCase()]=g.toLowerCase(),t["Webkit"+e]="webkit"+g,t["Moz"+e]="moz"+g,t}var mI={animationend:bI("Animation","AnimationEnd"),animationiteration:bI("Animation","AnimationIteration"),animationstart:bI("Animation","AnimationStart"),transitionend:bI("Transition","TransitionEnd")},pI={},GI={};function BI(e){if(pI[e])return pI[e];if(!mI[e])return e;var g,t=mI[e];for(g in t)if(t.hasOwnProperty(g)&&g in GI)return pI[e]=t[g];return e}l&&(GI=document.createElement("div").style,"AnimationEvent"in window||(delete mI.animationend.animation,delete mI.animationiteration.animation,delete mI.animationstart.animation),"TransitionEvent"in window||delete mI.transitionend.transition);var ZI=BI("animationend"),yI=BI("animationiteration"),vI=BI("animationstart"),WI=BI("transitionend"),fI=new Map,wI="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function RI(e,g){fI.set(e,g),a(g,[e])}for(var VI=0;VI<wI.length;VI++){var XI=wI[VI];RI(XI.toLowerCase(),"on"+(XI[0].toUpperCase()+XI.slice(1)))}RI(ZI,"onAnimationEnd"),RI(yI,"onAnimationIteration"),RI(vI,"onAnimationStart"),RI("dblclick","onDoubleClick"),RI("focusin","onFocus"),RI("focusout","onBlur"),RI(WI,"onTransitionEnd"),s("onMouseEnter",["mouseout","mouseover"]),s("onMouseLeave",["mouseout","mouseover"]),s("onPointerEnter",["pointerout","pointerover"]),s("onPointerLeave",["pointerout","pointerover"]),a("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),a("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),a("onBeforeInput",["compositionend","keypress","textInput","paste"]),a("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),a("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),a("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var SI="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),YI=new Set("cancel close invalid load scroll toggle".split(" ").concat(SI));function KI(e,g,t){var I=e.type||"unknown-event";e.currentTarget=t,function(e,g,t,I,n,C,o,a,s){if(Le.apply(this,arguments),Fe){if(!Fe)throw Error(i(198));var l=xe;Fe=!1,xe=null,ze||(ze=!0,ke=l)}}(I,g,void 0,e),e.currentTarget=null}function HI(e,g){g=0!=(4&g);for(var t=0;t<e.length;t++){var I=e[t],n=I.event;I=I.listeners;e:{var i=void 0;if(g)for(var C=I.length-1;0<=C;C--){var o=I[C],a=o.instance,s=o.currentTarget;if(o=o.listener,a!==i&&n.isPropagationStopped())break e;KI(n,o,s),i=a}else for(C=0;C<I.length;C++){if(a=(o=I[C]).instance,s=o.currentTarget,o=o.listener,a!==i&&n.isPropagationStopped())break e;KI(n,o,s),i=a}}}if(ze)throw e=ke,ze=!1,ke=null,e}function NI(e,g){var t=g[An];void 0===t&&(t=g[An]=new Set);var I=e+"__bubble";t.has(I)||(kI(g,e,2,!1),t.add(I))}function FI(e,g,t){var I=0;g&&(I|=4),kI(t,e,I,g)}var xI="_reactListening"+Math.random().toString(36).slice(2);function zI(e){if(!e[xI]){e[xI]=!0,C.forEach((function(g){"selectionchange"!==g&&(YI.has(g)||FI(g,!1,e),FI(g,!0,e))}));var g=9===e.nodeType?e:e.ownerDocument;null===g||g[xI]||(g[xI]=!0,FI("selectionchange",!1,g))}}function kI(e,g,t,I){switch(Pg(g)){case 1:var n=Ug;break;case 4:n=Qg;break;default:n=Dg}t=n.bind(null,g,t,e),n=void 0,!Ke||"touchstart"!==g&&"touchmove"!==g&&"wheel"!==g||(n=!0),I?void 0!==n?e.addEventListener(g,t,{capture:!0,passive:n}):e.addEventListener(g,t,!0):void 0!==n?e.addEventListener(g,t,{passive:n}):e.addEventListener(g,t,!1)}function MI(e,g,t,I,n){var i=I;if(0==(1&g)&&0==(2&g)&&null!==I)e:for(;;){if(null===I)return;var C=I.tag;if(3===C||4===C){var o=I.stateNode.containerInfo;if(o===n||8===o.nodeType&&o.parentNode===n)break;if(4===C)for(C=I.return;null!==C;){var a=C.tag;if((3===a||4===a)&&((a=C.stateNode.containerInfo)===n||8===a.nodeType&&a.parentNode===n))return;C=C.return}for(;null!==o;){if(null===(C=un(o)))return;if(5===(a=C.tag)||6===a){I=i=C;continue e}o=o.parentNode}}I=I.return}Se((function(){var I=i,n=Be(t),C=[];e:{var o=fI.get(e);if(void 0!==o){var a=st,s=e;switch(e){case"keypress":if(0===gt(t))break e;case"keydown":case"keyup":a=vt;break;case"focusin":s="focus",a=ut;break;case"focusout":s="blur",a=ut;break;case"beforeblur":case"afterblur":a=ut;break;case"click":if(2===t.button)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":a=ct;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":a=dt;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":a=ft;break;case ZI:case yI:case vI:a=ht;break;case WI:a=wt;break;case"scroll":a=rt;break;case"wheel":a=Rt;break;case"copy":case"cut":case"paste":a=bt;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":a=Wt}var l=0!=(4&g),r=!l&&"scroll"===e,A=l?null!==o?o+"Capture":null:o;l=[];for(var c,d=I;null!==d;){var u=(c=d).stateNode;if(5===c.tag&&null!==u&&(c=u,null!==A&&null!=(u=Ye(d,A))&&l.push(LI(d,u,c))),r)break;d=d.return}0<l.length&&(o=new a(o,s,null,t,n),C.push({event:o,listeners:l}))}}if(0==(7&g)){if(a="mouseout"===e||"pointerout"===e,(!(o="mouseover"===e||"pointerover"===e)||t===Ge||!(s=t.relatedTarget||t.fromElement)||!un(s)&&!s[rn])&&(a||o)&&(o=n.window===n?n:(o=n.ownerDocument)?o.defaultView||o.parentWindow:window,a?(a=I,null!==(s=(s=t.relatedTarget||t.toElement)?un(s):null)&&(s!==(r=Je(s))||5!==s.tag&&6!==s.tag)&&(s=null)):(a=null,s=I),a!==s)){if(l=ct,u="onMouseLeave",A="onMouseEnter",d="mouse","pointerout"!==e&&"pointerover"!==e||(l=Wt,u="onPointerLeave",A="onPointerEnter",d="pointer"),r=null==a?o:bn(a),c=null==s?o:bn(s),(o=new l(u,d+"leave",a,t,n)).target=r,o.relatedTarget=c,u=null,un(n)===I&&((l=new l(A,d+"enter",s,t,n)).target=c,l.relatedTarget=r,u=l),r=u,a&&s)e:{for(A=s,d=0,c=l=a;c;c=EI(c))d++;for(c=0,u=A;u;u=EI(u))c++;for(;0<d-c;)l=EI(l),d--;for(;0<c-d;)A=EI(A),c--;for(;d--;){if(l===A||null!==A&&l===A.alternate)break e;l=EI(l),A=EI(A)}l=null}else l=null;null!==a&&TI(C,o,a,l,!1),null!==s&&null!==r&&TI(C,r,s,l,!0)}if("select"===(a=(o=I?bn(I):window).nodeName&&o.nodeName.toLowerCase())||"input"===a&&"file"===o.type)var h=Qt;else if(Mt(o))if(Dt)h=tI;else{h=eI;var b=$t}else(a=o.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===o.type||"radio"===o.type)&&(h=gI);switch(h&&(h=h(e,I))?Lt(C,h,t,n):(b&&b(e,o,I),"focusout"===e&&(b=o._wrapperState)&&b.controlled&&"number"===o.type&&ee(o,"number",o.value)),b=I?bn(I):window,e){case"focusin":(Mt(b)||"true"===b.contentEditable)&&(AI=b,cI=I,dI=null);break;case"focusout":dI=cI=AI=null;break;case"mousedown":uI=!0;break;case"contextmenu":case"mouseup":case"dragend":uI=!1,hI(C,t,n);break;case"selectionchange":if(rI)break;case"keydown":case"keyup":hI(C,t,n)}var m;if(Xt)e:{switch(e){case"compositionstart":var p="onCompositionStart";break e;case"compositionend":p="onCompositionEnd";break e;case"compositionupdate":p="onCompositionUpdate";break e}p=void 0}else zt?Ft(e,t)&&(p="onCompositionEnd"):"keydown"===e&&229===t.keyCode&&(p="onCompositionStart");p&&(Kt&&"ko"!==t.locale&&(zt||"onCompositionStart"!==p?"onCompositionEnd"===p&&zt&&(m=et()):(qg="value"in(_g=n)?_g.value:_g.textContent,zt=!0)),0<(b=JI(I,p)).length&&(p=new mt(p,e,null,t,n),C.push({event:p,listeners:b}),(m||null!==(m=xt(t)))&&(p.data=m))),(m=Yt?function(e,g){switch(e){case"compositionend":return xt(g);case"keypress":return 32!==g.which?null:(Nt=!0,Ht);case"textInput":return(e=g.data)===Ht&&Nt?null:e;default:return null}}(e,t):function(e,g){if(zt)return"compositionend"===e||!Xt&&Ft(e,g)?(e=et(),$g=qg=_g=null,zt=!1,e):null;switch(e){case"paste":default:return null;case"keypress":if(!(g.ctrlKey||g.altKey||g.metaKey)||g.ctrlKey&&g.altKey){if(g.char&&1<g.char.length)return g.char;if(g.which)return String.fromCharCode(g.which)}return null;case"compositionend":return Kt&&"ko"!==g.locale?null:g.data}}(e,t))&&0<(I=JI(I,"onBeforeInput")).length&&(n=new mt("onBeforeInput","beforeinput",null,t,n),C.push({event:n,listeners:I}),n.data=m)}HI(C,g)}))}function LI(e,g,t){return{instance:e,listener:g,currentTarget:t}}function JI(e,g){for(var t=g+"Capture",I=[];null!==e;){var n=e,i=n.stateNode;5===n.tag&&null!==i&&(n=i,null!=(i=Ye(e,t))&&I.unshift(LI(e,i,n)),null!=(i=Ye(e,g))&&I.push(LI(e,i,n))),e=e.return}return I}function EI(e){if(null===e)return null;do{e=e.return}while(e&&5!==e.tag);return e||null}function TI(e,g,t,I,n){for(var i=g._reactName,C=[];null!==t&&t!==I;){var o=t,a=o.alternate,s=o.stateNode;if(null!==a&&a===I)break;5===o.tag&&null!==s&&(o=s,n?null!=(a=Ye(t,i))&&C.unshift(LI(t,a,o)):n||null!=(a=Ye(t,i))&&C.push(LI(t,a,o))),t=t.return}0!==C.length&&e.push({event:g,listeners:C})}var UI=/\r\n?/g,QI=/\u0000|\uFFFD/g;function DI(e){return("string"==typeof e?e:""+e).replace(UI,"\n").replace(QI,"")}function OI(e,g,t){if(g=DI(g),DI(e)!==g&&t)throw Error(i(425))}function jI(){}var PI=null,_I=null;function qI(e,g){return"textarea"===e||"noscript"===e||"string"==typeof g.children||"number"==typeof g.children||"object"==typeof g.dangerouslySetInnerHTML&&null!==g.dangerouslySetInnerHTML&&null!=g.dangerouslySetInnerHTML.__html}var $I="function"==typeof setTimeout?setTimeout:void 0,en="function"==typeof clearTimeout?clearTimeout:void 0,gn="function"==typeof Promise?Promise:void 0,tn="function"==typeof queueMicrotask?queueMicrotask:void 0!==gn?function(e){return gn.resolve(null).then(e).catch(In)}:$I;function In(e){setTimeout((function(){throw e}))}function nn(e,g){var t=g,I=0;do{var n=t.nextSibling;if(e.removeChild(t),n&&8===n.nodeType)if("/$"===(t=n.data)){if(0===I)return e.removeChild(n),void Jg(g);I--}else"$"!==t&&"$?"!==t&&"$!"!==t||I++;t=n}while(t);Jg(g)}function Cn(e){for(;null!=e;e=e.nextSibling){var g=e.nodeType;if(1===g||3===g)break;if(8===g){if("$"===(g=e.data)||"$!"===g||"$?"===g)break;if("/$"===g)return null}}return e}function on(e){e=e.previousSibling;for(var g=0;e;){if(8===e.nodeType){var t=e.data;if("$"===t||"$!"===t||"$?"===t){if(0===g)return e;g--}else"/$"===t&&g++}e=e.previousSibling}return null}var an=Math.random().toString(36).slice(2),sn="__reactFiber$"+an,ln="__reactProps$"+an,rn="__reactContainer$"+an,An="__reactEvents$"+an,cn="__reactListeners$"+an,dn="__reactHandles$"+an;function un(e){var g=e[sn];if(g)return g;for(var t=e.parentNode;t;){if(g=t[rn]||t[sn]){if(t=g.alternate,null!==g.child||null!==t&&null!==t.child)for(e=on(e);null!==e;){if(t=e[sn])return t;e=on(e)}return g}t=(e=t).parentNode}return null}function hn(e){return!(e=e[sn]||e[rn])||5!==e.tag&&6!==e.tag&&13!==e.tag&&3!==e.tag?null:e}function bn(e){if(5===e.tag||6===e.tag)return e.stateNode;throw Error(i(33))}function mn(e){return e[ln]||null}var pn=[],Gn=-1;function Bn(e){return{current:e}}function Zn(e){0>Gn||(e.current=pn[Gn],pn[Gn]=null,Gn--)}function yn(e,g){Gn++,pn[Gn]=e.current,e.current=g}var vn={},Wn=Bn(vn),fn=Bn(!1),wn=vn;function Rn(e,g){var t=e.type.contextTypes;if(!t)return vn;var I=e.stateNode;if(I&&I.__reactInternalMemoizedUnmaskedChildContext===g)return I.__reactInternalMemoizedMaskedChildContext;var n,i={};for(n in t)i[n]=g[n];return I&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=g,e.__reactInternalMemoizedMaskedChildContext=i),i}function Vn(e){return null!=e.childContextTypes}function Xn(){Zn(fn),Zn(Wn)}function Sn(e,g,t){if(Wn.current!==vn)throw Error(i(168));yn(Wn,g),yn(fn,t)}function Yn(e,g,t){var I=e.stateNode;if(g=g.childContextTypes,"function"!=typeof I.getChildContext)return t;for(var n in I=I.getChildContext())if(!(n in g))throw Error(i(108,E(e)||"Unknown",n));return x({},t,I)}function Kn(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||vn,wn=Wn.current,yn(Wn,e),yn(fn,fn.current),!0}function Hn(e,g,t){var I=e.stateNode;if(!I)throw Error(i(169));t?(e=Yn(e,g,wn),I.__reactInternalMemoizedMergedChildContext=e,Zn(fn),Zn(Wn),yn(Wn,e)):Zn(fn),yn(fn,t)}var Nn=null,Fn=!1,xn=!1;function zn(e){null===Nn?Nn=[e]:Nn.push(e)}function kn(){if(!xn&&null!==Nn){xn=!0;var e=0,g=pg;try{var t=Nn;for(pg=1;e<t.length;e++){var I=t[e];do{I=I(!0)}while(null!==I)}Nn=null,Fn=!1}catch(g){throw null!==Nn&&(Nn=Nn.slice(e+1)),De($e,kn),g}finally{pg=g,xn=!1}}return null}var Mn=[],Ln=0,Jn=null,En=0,Tn=[],Un=0,Qn=null,Dn=1,On="";function jn(e,g){Mn[Ln++]=En,Mn[Ln++]=Jn,Jn=e,En=g}function Pn(e,g,t){Tn[Un++]=Dn,Tn[Un++]=On,Tn[Un++]=Qn,Qn=e;var I=Dn;e=On;var n=32-Cg(I)-1;I&=~(1<<n),t+=1;var i=32-Cg(g)+n;if(30<i){var C=n-n%5;i=(I&(1<<C)-1).toString(32),I>>=C,n-=C,Dn=1<<32-Cg(g)+n|t<<n|I,On=i+e}else Dn=1<<i|t<<n|I,On=e}function _n(e){null!==e.return&&(jn(e,1),Pn(e,1,0))}function qn(e){for(;e===Jn;)Jn=Mn[--Ln],Mn[Ln]=null,En=Mn[--Ln],Mn[Ln]=null;for(;e===Qn;)Qn=Tn[--Un],Tn[Un]=null,On=Tn[--Un],Tn[Un]=null,Dn=Tn[--Un],Tn[Un]=null}var $n=null,ei=null,gi=!1,ti=null;function Ii(e,g){var t=Vs(5,null,null,0);t.elementType="DELETED",t.stateNode=g,t.return=e,null===(g=e.deletions)?(e.deletions=[t],e.flags|=16):g.push(t)}function ni(e,g){switch(e.tag){case 5:var t=e.type;return null!==(g=1!==g.nodeType||t.toLowerCase()!==g.nodeName.toLowerCase()?null:g)&&(e.stateNode=g,$n=e,ei=Cn(g.firstChild),!0);case 6:return null!==(g=""===e.pendingProps||3!==g.nodeType?null:g)&&(e.stateNode=g,$n=e,ei=null,!0);case 13:return null!==(g=8!==g.nodeType?null:g)&&(t=null!==Qn?{id:Dn,overflow:On}:null,e.memoizedState={dehydrated:g,treeContext:t,retryLane:1073741824},(t=Vs(18,null,null,0)).stateNode=g,t.return=e,e.child=t,$n=e,ei=null,!0);default:return!1}}function ii(e){return 0!=(1&e.mode)&&0==(128&e.flags)}function Ci(e){if(gi){var g=ei;if(g){var t=g;if(!ni(e,g)){if(ii(e))throw Error(i(418));g=Cn(t.nextSibling);var I=$n;g&&ni(e,g)?Ii(I,t):(e.flags=-4097&e.flags|2,gi=!1,$n=e)}}else{if(ii(e))throw Error(i(418));e.flags=-4097&e.flags|2,gi=!1,$n=e}}}function oi(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;$n=e}function ai(e){if(e!==$n)return!1;if(!gi)return oi(e),gi=!0,!1;var g;if((g=3!==e.tag)&&!(g=5!==e.tag)&&(g="head"!==(g=e.type)&&"body"!==g&&!qI(e.type,e.memoizedProps)),g&&(g=ei)){if(ii(e))throw si(),Error(i(418));for(;g;)Ii(e,g),g=Cn(g.nextSibling)}if(oi(e),13===e.tag){if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(i(317));e:{for(e=e.nextSibling,g=0;e;){if(8===e.nodeType){var t=e.data;if("/$"===t){if(0===g){ei=Cn(e.nextSibling);break e}g--}else"$"!==t&&"$!"!==t&&"$?"!==t||g++}e=e.nextSibling}ei=null}}else ei=$n?Cn(e.stateNode.nextSibling):null;return!0}function si(){for(var e=ei;e;)e=Cn(e.nextSibling)}function li(){ei=$n=null,gi=!1}function ri(e){null===ti?ti=[e]:ti.push(e)}var Ai=G.ReactCurrentBatchConfig;function ci(e,g){if(e&&e.defaultProps){for(var t in g=x({},g),e=e.defaultProps)void 0===g[t]&&(g[t]=e[t]);return g}return g}var di=Bn(null),ui=null,hi=null,bi=null;function mi(){bi=hi=ui=null}function pi(e){var g=di.current;Zn(di),e._currentValue=g}function Gi(e,g,t){for(;null!==e;){var I=e.alternate;if((e.childLanes&g)!==g?(e.childLanes|=g,null!==I&&(I.childLanes|=g)):null!==I&&(I.childLanes&g)!==g&&(I.childLanes|=g),e===t)break;e=e.return}}function Bi(e,g){ui=e,bi=hi=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(0!=(e.lanes&g)&&(bo=!0),e.firstContext=null)}function Zi(e){var g=e._currentValue;if(bi!==e)if(e={context:e,memoizedValue:g,next:null},null===hi){if(null===ui)throw Error(i(308));hi=e,ui.dependencies={lanes:0,firstContext:e}}else hi=hi.next=e;return g}var yi=null;function vi(e){null===yi?yi=[e]:yi.push(e)}function Wi(e,g,t,I){var n=g.interleaved;return null===n?(t.next=t,vi(g)):(t.next=n.next,n.next=t),g.interleaved=t,fi(e,I)}function fi(e,g){e.lanes|=g;var t=e.alternate;for(null!==t&&(t.lanes|=g),t=e,e=e.return;null!==e;)e.childLanes|=g,null!==(t=e.alternate)&&(t.childLanes|=g),t=e,e=e.return;return 3===t.tag?t.stateNode:null}var wi=!1;function Ri(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function Vi(e,g){e=e.updateQueue,g.updateQueue===e&&(g.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function Xi(e,g){return{eventTime:e,lane:g,tag:0,payload:null,callback:null,next:null}}function Si(e,g,t){var I=e.updateQueue;if(null===I)return null;if(I=I.shared,0!=(2&fa)){var n=I.pending;return null===n?g.next=g:(g.next=n.next,n.next=g),I.pending=g,fi(e,t)}return null===(n=I.interleaved)?(g.next=g,vi(I)):(g.next=n.next,n.next=g),I.interleaved=g,fi(e,t)}function Yi(e,g,t){if(null!==(g=g.updateQueue)&&(g=g.shared,0!=(4194240&t))){var I=g.lanes;t|=I&=e.pendingLanes,g.lanes=t,mg(e,t)}}function Ki(e,g){var t=e.updateQueue,I=e.alternate;if(null!==I&&t===(I=I.updateQueue)){var n=null,i=null;if(null!==(t=t.firstBaseUpdate)){do{var C={eventTime:t.eventTime,lane:t.lane,tag:t.tag,payload:t.payload,callback:t.callback,next:null};null===i?n=i=C:i=i.next=C,t=t.next}while(null!==t);null===i?n=i=g:i=i.next=g}else n=i=g;return t={baseState:I.baseState,firstBaseUpdate:n,lastBaseUpdate:i,shared:I.shared,effects:I.effects},void(e.updateQueue=t)}null===(e=t.lastBaseUpdate)?t.firstBaseUpdate=g:e.next=g,t.lastBaseUpdate=g}function Hi(e,g,t,I){var n=e.updateQueue;wi=!1;var i=n.firstBaseUpdate,C=n.lastBaseUpdate,o=n.shared.pending;if(null!==o){n.shared.pending=null;var a=o,s=a.next;a.next=null,null===C?i=s:C.next=s,C=a;var l=e.alternate;null!==l&&(o=(l=l.updateQueue).lastBaseUpdate)!==C&&(null===o?l.firstBaseUpdate=s:o.next=s,l.lastBaseUpdate=a)}if(null!==i){var r=n.baseState;for(C=0,l=s=a=null,o=i;;){var A=o.lane,c=o.eventTime;if((I&A)===A){null!==l&&(l=l.next={eventTime:c,lane:0,tag:o.tag,payload:o.payload,callback:o.callback,next:null});e:{var d=e,u=o;switch(A=g,c=t,u.tag){case 1:if("function"==typeof(d=u.payload)){r=d.call(c,r,A);break e}r=d;break e;case 3:d.flags=-65537&d.flags|128;case 0:if(null==(A="function"==typeof(d=u.payload)?d.call(c,r,A):d))break e;r=x({},r,A);break e;case 2:wi=!0}}null!==o.callback&&0!==o.lane&&(e.flags|=64,null===(A=n.effects)?n.effects=[o]:A.push(o))}else c={eventTime:c,lane:A,tag:o.tag,payload:o.payload,callback:o.callback,next:null},null===l?(s=l=c,a=r):l=l.next=c,C|=A;if(null===(o=o.next)){if(null===(o=n.shared.pending))break;o=(A=o).next,A.next=null,n.lastBaseUpdate=A,n.shared.pending=null}}if(null===l&&(a=r),n.baseState=a,n.firstBaseUpdate=s,n.lastBaseUpdate=l,null!==(g=n.shared.interleaved)){n=g;do{C|=n.lane,n=n.next}while(n!==g)}else null===i&&(n.shared.lanes=0);Ha|=C,e.lanes=C,e.memoizedState=r}}function Ni(e,g,t){if(e=g.effects,g.effects=null,null!==e)for(g=0;g<e.length;g++){var I=e[g],n=I.callback;if(null!==n){if(I.callback=null,I=t,"function"!=typeof n)throw Error(i(191,n));n.call(I)}}}var Fi=(new I.Component).refs;function xi(e,g,t,I){t=null==(t=t(I,g=e.memoizedState))?g:x({},g,t),e.memoizedState=t,0===e.lanes&&(e.updateQueue.baseState=t)}var zi={isMounted:function(e){return!!(e=e._reactInternals)&&Je(e)===e},enqueueSetState:function(e,g,t){e=e._reactInternals;var I=qa(),n=$a(e),i=Xi(I,n);i.payload=g,null!=t&&(i.callback=t),null!==(g=Si(e,i,n))&&(es(g,e,n,I),Yi(g,e,n))},enqueueReplaceState:function(e,g,t){e=e._reactInternals;var I=qa(),n=$a(e),i=Xi(I,n);i.tag=1,i.payload=g,null!=t&&(i.callback=t),null!==(g=Si(e,i,n))&&(es(g,e,n,I),Yi(g,e,n))},enqueueForceUpdate:function(e,g){e=e._reactInternals;var t=qa(),I=$a(e),n=Xi(t,I);n.tag=2,null!=g&&(n.callback=g),null!==(g=Si(e,n,I))&&(es(g,e,I,t),Yi(g,e,I))}};function ki(e,g,t,I,n,i,C){return"function"==typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(I,i,C):!(g.prototype&&g.prototype.isPureReactComponent&&nI(t,I)&&nI(n,i))}function Mi(e,g,t){var I=!1,n=vn,i=g.contextType;return"object"==typeof i&&null!==i?i=Zi(i):(n=Vn(g)?wn:Wn.current,i=(I=null!=(I=g.contextTypes))?Rn(e,n):vn),g=new g(t,i),e.memoizedState=null!==g.state&&void 0!==g.state?g.state:null,g.updater=zi,e.stateNode=g,g._reactInternals=e,I&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=n,e.__reactInternalMemoizedMaskedChildContext=i),g}function Li(e,g,t,I){e=g.state,"function"==typeof g.componentWillReceiveProps&&g.componentWillReceiveProps(t,I),"function"==typeof g.UNSAFE_componentWillReceiveProps&&g.UNSAFE_componentWillReceiveProps(t,I),g.state!==e&&zi.enqueueReplaceState(g,g.state,null)}function Ji(e,g,t,I){var n=e.stateNode;n.props=t,n.state=e.memoizedState,n.refs=Fi,Ri(e);var i=g.contextType;"object"==typeof i&&null!==i?n.context=Zi(i):(i=Vn(g)?wn:Wn.current,n.context=Rn(e,i)),n.state=e.memoizedState,"function"==typeof(i=g.getDerivedStateFromProps)&&(xi(e,g,i,t),n.state=e.memoizedState),"function"==typeof g.getDerivedStateFromProps||"function"==typeof n.getSnapshotBeforeUpdate||"function"!=typeof n.UNSAFE_componentWillMount&&"function"!=typeof n.componentWillMount||(g=n.state,"function"==typeof n.componentWillMount&&n.componentWillMount(),"function"==typeof n.UNSAFE_componentWillMount&&n.UNSAFE_componentWillMount(),g!==n.state&&zi.enqueueReplaceState(n,n.state,null),Hi(e,t,n,I),n.state=e.memoizedState),"function"==typeof n.componentDidMount&&(e.flags|=4194308)}function Ei(e,g,t){if(null!==(e=t.ref)&&"function"!=typeof e&&"object"!=typeof e){if(t._owner){if(t=t._owner){if(1!==t.tag)throw Error(i(309));var I=t.stateNode}if(!I)throw Error(i(147,e));var n=I,C=""+e;return null!==g&&null!==g.ref&&"function"==typeof g.ref&&g.ref._stringRef===C?g.ref:(g=function(e){var g=n.refs;g===Fi&&(g=n.refs={}),null===e?delete g[C]:g[C]=e},g._stringRef=C,g)}if("string"!=typeof e)throw Error(i(284));if(!t._owner)throw Error(i(290,e))}return e}function Ti(e,g){throw e=Object.prototype.toString.call(g),Error(i(31,"[object Object]"===e?"object with keys {"+Object.keys(g).join(", ")+"}":e))}function Ui(e){return(0,e._init)(e._payload)}function Qi(e){function g(g,t){if(e){var I=g.deletions;null===I?(g.deletions=[t],g.flags|=16):I.push(t)}}function t(t,I){if(!e)return null;for(;null!==I;)g(t,I),I=I.sibling;return null}function I(e,g){for(e=new Map;null!==g;)null!==g.key?e.set(g.key,g):e.set(g.index,g),g=g.sibling;return e}function n(e,g){return(e=Ss(e,g)).index=0,e.sibling=null,e}function C(g,t,I){return g.index=I,e?null!==(I=g.alternate)?(I=I.index)<t?(g.flags|=2,t):I:(g.flags|=2,t):(g.flags|=1048576,t)}function o(g){return e&&null===g.alternate&&(g.flags|=2),g}function a(e,g,t,I){return null===g||6!==g.tag?((g=Ns(t,e.mode,I)).return=e,g):((g=n(g,t)).return=e,g)}function s(e,g,t,I){var i=t.type;return i===y?r(e,g,t.props.children,I,t.key):null!==g&&(g.elementType===i||"object"==typeof i&&null!==i&&i.$$typeof===Y&&Ui(i)===g.type)?((I=n(g,t.props)).ref=Ei(e,g,t),I.return=e,I):((I=Ys(t.type,t.key,t.props,null,e.mode,I)).ref=Ei(e,g,t),I.return=e,I)}function l(e,g,t,I){return null===g||4!==g.tag||g.stateNode.containerInfo!==t.containerInfo||g.stateNode.implementation!==t.implementation?((g=Fs(t,e.mode,I)).return=e,g):((g=n(g,t.children||[])).return=e,g)}function r(e,g,t,I,i){return null===g||7!==g.tag?((g=Ks(t,e.mode,I,i)).return=e,g):((g=n(g,t)).return=e,g)}function A(e,g,t){if("string"==typeof g&&""!==g||"number"==typeof g)return(g=Ns(""+g,e.mode,t)).return=e,g;if("object"==typeof g&&null!==g){switch(g.$$typeof){case B:return(t=Ys(g.type,g.key,g.props,null,e.mode,t)).ref=Ei(e,null,g),t.return=e,t;case Z:return(g=Fs(g,e.mode,t)).return=e,g;case Y:return A(e,(0,g._init)(g._payload),t)}if(ge(g)||N(g))return(g=Ks(g,e.mode,t,null)).return=e,g;Ti(e,g)}return null}function c(e,g,t,I){var n=null!==g?g.key:null;if("string"==typeof t&&""!==t||"number"==typeof t)return null!==n?null:a(e,g,""+t,I);if("object"==typeof t&&null!==t){switch(t.$$typeof){case B:return t.key===n?s(e,g,t,I):null;case Z:return t.key===n?l(e,g,t,I):null;case Y:return c(e,g,(n=t._init)(t._payload),I)}if(ge(t)||N(t))return null!==n?null:r(e,g,t,I,null);Ti(e,t)}return null}function d(e,g,t,I,n){if("string"==typeof I&&""!==I||"number"==typeof I)return a(g,e=e.get(t)||null,""+I,n);if("object"==typeof I&&null!==I){switch(I.$$typeof){case B:return s(g,e=e.get(null===I.key?t:I.key)||null,I,n);case Z:return l(g,e=e.get(null===I.key?t:I.key)||null,I,n);case Y:return d(e,g,t,(0,I._init)(I._payload),n)}if(ge(I)||N(I))return r(g,e=e.get(t)||null,I,n,null);Ti(g,I)}return null}function u(n,i,o,a){for(var s=null,l=null,r=i,u=i=0,h=null;null!==r&&u<o.length;u++){r.index>u?(h=r,r=null):h=r.sibling;var b=c(n,r,o[u],a);if(null===b){null===r&&(r=h);break}e&&r&&null===b.alternate&&g(n,r),i=C(b,i,u),null===l?s=b:l.sibling=b,l=b,r=h}if(u===o.length)return t(n,r),gi&&jn(n,u),s;if(null===r){for(;u<o.length;u++)null!==(r=A(n,o[u],a))&&(i=C(r,i,u),null===l?s=r:l.sibling=r,l=r);return gi&&jn(n,u),s}for(r=I(n,r);u<o.length;u++)null!==(h=d(r,n,u,o[u],a))&&(e&&null!==h.alternate&&r.delete(null===h.key?u:h.key),i=C(h,i,u),null===l?s=h:l.sibling=h,l=h);return e&&r.forEach((function(e){return g(n,e)})),gi&&jn(n,u),s}function h(n,o,a,s){var l=N(a);if("function"!=typeof l)throw Error(i(150));if(null==(a=l.call(a)))throw Error(i(151));for(var r=l=null,u=o,h=o=0,b=null,m=a.next();null!==u&&!m.done;h++,m=a.next()){u.index>h?(b=u,u=null):b=u.sibling;var p=c(n,u,m.value,s);if(null===p){null===u&&(u=b);break}e&&u&&null===p.alternate&&g(n,u),o=C(p,o,h),null===r?l=p:r.sibling=p,r=p,u=b}if(m.done)return t(n,u),gi&&jn(n,h),l;if(null===u){for(;!m.done;h++,m=a.next())null!==(m=A(n,m.value,s))&&(o=C(m,o,h),null===r?l=m:r.sibling=m,r=m);return gi&&jn(n,h),l}for(u=I(n,u);!m.done;h++,m=a.next())null!==(m=d(u,n,h,m.value,s))&&(e&&null!==m.alternate&&u.delete(null===m.key?h:m.key),o=C(m,o,h),null===r?l=m:r.sibling=m,r=m);return e&&u.forEach((function(e){return g(n,e)})),gi&&jn(n,h),l}return function e(I,i,C,a){if("object"==typeof C&&null!==C&&C.type===y&&null===C.key&&(C=C.props.children),"object"==typeof C&&null!==C){switch(C.$$typeof){case B:e:{for(var s=C.key,l=i;null!==l;){if(l.key===s){if((s=C.type)===y){if(7===l.tag){t(I,l.sibling),(i=n(l,C.props.children)).return=I,I=i;break e}}else if(l.elementType===s||"object"==typeof s&&null!==s&&s.$$typeof===Y&&Ui(s)===l.type){t(I,l.sibling),(i=n(l,C.props)).ref=Ei(I,l,C),i.return=I,I=i;break e}t(I,l);break}g(I,l),l=l.sibling}C.type===y?((i=Ks(C.props.children,I.mode,a,C.key)).return=I,I=i):((a=Ys(C.type,C.key,C.props,null,I.mode,a)).ref=Ei(I,i,C),a.return=I,I=a)}return o(I);case Z:e:{for(l=C.key;null!==i;){if(i.key===l){if(4===i.tag&&i.stateNode.containerInfo===C.containerInfo&&i.stateNode.implementation===C.implementation){t(I,i.sibling),(i=n(i,C.children||[])).return=I,I=i;break e}t(I,i);break}g(I,i),i=i.sibling}(i=Fs(C,I.mode,a)).return=I,I=i}return o(I);case Y:return e(I,i,(l=C._init)(C._payload),a)}if(ge(C))return u(I,i,C,a);if(N(C))return h(I,i,C,a);Ti(I,C)}return"string"==typeof C&&""!==C||"number"==typeof C?(C=""+C,null!==i&&6===i.tag?(t(I,i.sibling),(i=n(i,C)).return=I,I=i):(t(I,i),(i=Ns(C,I.mode,a)).return=I,I=i),o(I)):t(I,i)}}var Di=Qi(!0),Oi=Qi(!1),ji={},Pi=Bn(ji),_i=Bn(ji),qi=Bn(ji);function $i(e){if(e===ji)throw Error(i(174));return e}function eC(e,g){switch(yn(qi,g),yn(_i,e),yn(Pi,ji),e=g.nodeType){case 9:case 11:g=(g=g.documentElement)?g.namespaceURI:ae(null,"");break;default:g=ae(g=(e=8===e?g.parentNode:g).namespaceURI||null,e=e.tagName)}Zn(Pi),yn(Pi,g)}function gC(){Zn(Pi),Zn(_i),Zn(qi)}function tC(e){$i(qi.current);var g=$i(Pi.current),t=ae(g,e.type);g!==t&&(yn(_i,e),yn(Pi,t))}function IC(e){_i.current===e&&(Zn(Pi),Zn(_i))}var nC=Bn(0);function iC(e){for(var g=e;null!==g;){if(13===g.tag){var t=g.memoizedState;if(null!==t&&(null===(t=t.dehydrated)||"$?"===t.data||"$!"===t.data))return g}else if(19===g.tag&&void 0!==g.memoizedProps.revealOrder){if(0!=(128&g.flags))return g}else if(null!==g.child){g.child.return=g,g=g.child;continue}if(g===e)break;for(;null===g.sibling;){if(null===g.return||g.return===e)return null;g=g.return}g.sibling.return=g.return,g=g.sibling}return null}var CC=[];function oC(){for(var e=0;e<CC.length;e++)CC[e]._workInProgressVersionPrimary=null;CC.length=0}var aC=G.ReactCurrentDispatcher,sC=G.ReactCurrentBatchConfig,lC=0,rC=null,AC=null,cC=null,dC=!1,uC=!1,hC=0,bC=0;function mC(){throw Error(i(321))}function pC(e,g){if(null===g)return!1;for(var t=0;t<g.length&&t<e.length;t++)if(!II(e[t],g[t]))return!1;return!0}function GC(e,g,t,I,n,C){if(lC=C,rC=g,g.memoizedState=null,g.updateQueue=null,g.lanes=0,aC.current=null===e||null===e.memoizedState?Io:no,e=t(I,n),uC){C=0;do{if(uC=!1,hC=0,25<=C)throw Error(i(301));C+=1,cC=AC=null,g.updateQueue=null,aC.current=io,e=t(I,n)}while(uC)}if(aC.current=to,g=null!==AC&&null!==AC.next,lC=0,cC=AC=rC=null,dC=!1,g)throw Error(i(300));return e}function BC(){var e=0!==hC;return hC=0,e}function ZC(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===cC?rC.memoizedState=cC=e:cC=cC.next=e,cC}function yC(){if(null===AC){var e=rC.alternate;e=null!==e?e.memoizedState:null}else e=AC.next;var g=null===cC?rC.memoizedState:cC.next;if(null!==g)cC=g,AC=e;else{if(null===e)throw Error(i(310));e={memoizedState:(AC=e).memoizedState,baseState:AC.baseState,baseQueue:AC.baseQueue,queue:AC.queue,next:null},null===cC?rC.memoizedState=cC=e:cC=cC.next=e}return cC}function vC(e,g){return"function"==typeof g?g(e):g}function WC(e){var g=yC(),t=g.queue;if(null===t)throw Error(i(311));t.lastRenderedReducer=e;var I=AC,n=I.baseQueue,C=t.pending;if(null!==C){if(null!==n){var o=n.next;n.next=C.next,C.next=o}I.baseQueue=n=C,t.pending=null}if(null!==n){C=n.next,I=I.baseState;var a=o=null,s=null,l=C;do{var r=l.lane;if((lC&r)===r)null!==s&&(s=s.next={lane:0,action:l.action,hasEagerState:l.hasEagerState,eagerState:l.eagerState,next:null}),I=l.hasEagerState?l.eagerState:e(I,l.action);else{var A={lane:r,action:l.action,hasEagerState:l.hasEagerState,eagerState:l.eagerState,next:null};null===s?(a=s=A,o=I):s=s.next=A,rC.lanes|=r,Ha|=r}l=l.next}while(null!==l&&l!==C);null===s?o=I:s.next=a,II(I,g.memoizedState)||(bo=!0),g.memoizedState=I,g.baseState=o,g.baseQueue=s,t.lastRenderedState=I}if(null!==(e=t.interleaved)){n=e;do{C=n.lane,rC.lanes|=C,Ha|=C,n=n.next}while(n!==e)}else null===n&&(t.lanes=0);return[g.memoizedState,t.dispatch]}function fC(e){var g=yC(),t=g.queue;if(null===t)throw Error(i(311));t.lastRenderedReducer=e;var I=t.dispatch,n=t.pending,C=g.memoizedState;if(null!==n){t.pending=null;var o=n=n.next;do{C=e(C,o.action),o=o.next}while(o!==n);II(C,g.memoizedState)||(bo=!0),g.memoizedState=C,null===g.baseQueue&&(g.baseState=C),t.lastRenderedState=C}return[C,I]}function wC(){}function RC(e,g){var t=rC,I=yC(),n=g(),C=!II(I.memoizedState,n);if(C&&(I.memoizedState=n,bo=!0),I=I.queue,MC(SC.bind(null,t,I,e),[e]),I.getSnapshot!==g||C||null!==cC&&1&cC.memoizedState.tag){if(t.flags|=2048,NC(9,XC.bind(null,t,I,n,g),void 0,null),null===wa)throw Error(i(349));0!=(30&lC)||VC(t,g,n)}return n}function VC(e,g,t){e.flags|=16384,e={getSnapshot:g,value:t},null===(g=rC.updateQueue)?(g={lastEffect:null,stores:null},rC.updateQueue=g,g.stores=[e]):null===(t=g.stores)?g.stores=[e]:t.push(e)}function XC(e,g,t,I){g.value=t,g.getSnapshot=I,YC(g)&&KC(e)}function SC(e,g,t){return t((function(){YC(g)&&KC(e)}))}function YC(e){var g=e.getSnapshot;e=e.value;try{var t=g();return!II(e,t)}catch(e){return!0}}function KC(e){var g=fi(e,1);null!==g&&es(g,e,1,-1)}function HC(e){var g=ZC();return"function"==typeof e&&(e=e()),g.memoizedState=g.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:vC,lastRenderedState:e},g.queue=e,e=e.dispatch=qC.bind(null,rC,e),[g.memoizedState,e]}function NC(e,g,t,I){return e={tag:e,create:g,destroy:t,deps:I,next:null},null===(g=rC.updateQueue)?(g={lastEffect:null,stores:null},rC.updateQueue=g,g.lastEffect=e.next=e):null===(t=g.lastEffect)?g.lastEffect=e.next=e:(I=t.next,t.next=e,e.next=I,g.lastEffect=e),e}function FC(){return yC().memoizedState}function xC(e,g,t,I){var n=ZC();rC.flags|=e,n.memoizedState=NC(1|g,t,void 0,void 0===I?null:I)}function zC(e,g,t,I){var n=yC();I=void 0===I?null:I;var i=void 0;if(null!==AC){var C=AC.memoizedState;if(i=C.destroy,null!==I&&pC(I,C.deps))return void(n.memoizedState=NC(g,t,i,I))}rC.flags|=e,n.memoizedState=NC(1|g,t,i,I)}function kC(e,g){return xC(8390656,8,e,g)}function MC(e,g){return zC(2048,8,e,g)}function LC(e,g){return zC(4,2,e,g)}function JC(e,g){return zC(4,4,e,g)}function EC(e,g){return"function"==typeof g?(e=e(),g(e),function(){g(null)}):null!=g?(e=e(),g.current=e,function(){g.current=null}):void 0}function TC(e,g,t){return t=null!=t?t.concat([e]):null,zC(4,4,EC.bind(null,g,e),t)}function UC(){}function QC(e,g){var t=yC();g=void 0===g?null:g;var I=t.memoizedState;return null!==I&&null!==g&&pC(g,I[1])?I[0]:(t.memoizedState=[e,g],e)}function DC(e,g){var t=yC();g=void 0===g?null:g;var I=t.memoizedState;return null!==I&&null!==g&&pC(g,I[1])?I[0]:(e=e(),t.memoizedState=[e,g],e)}function OC(e,g,t){return 0==(21&lC)?(e.baseState&&(e.baseState=!1,bo=!0),e.memoizedState=t):(II(t,g)||(t=ug(),rC.lanes|=t,Ha|=t,e.baseState=!0),g)}function jC(e,g){var t=pg;pg=0!==t&&4>t?t:4,e(!0);var I=sC.transition;sC.transition={};try{e(!1),g()}finally{pg=t,sC.transition=I}}function PC(){return yC().memoizedState}function _C(e,g,t){var I=$a(e);t={lane:I,action:t,hasEagerState:!1,eagerState:null,next:null},$C(e)?eo(g,t):null!==(t=Wi(e,g,t,I))&&(es(t,e,I,qa()),go(t,g,I))}function qC(e,g,t){var I=$a(e),n={lane:I,action:t,hasEagerState:!1,eagerState:null,next:null};if($C(e))eo(g,n);else{var i=e.alternate;if(0===e.lanes&&(null===i||0===i.lanes)&&null!==(i=g.lastRenderedReducer))try{var C=g.lastRenderedState,o=i(C,t);if(n.hasEagerState=!0,n.eagerState=o,II(o,C)){var a=g.interleaved;return null===a?(n.next=n,vi(g)):(n.next=a.next,a.next=n),void(g.interleaved=n)}}catch(e){}null!==(t=Wi(e,g,n,I))&&(es(t,e,I,n=qa()),go(t,g,I))}}function $C(e){var g=e.alternate;return e===rC||null!==g&&g===rC}function eo(e,g){uC=dC=!0;var t=e.pending;null===t?g.next=g:(g.next=t.next,t.next=g),e.pending=g}function go(e,g,t){if(0!=(4194240&t)){var I=g.lanes;t|=I&=e.pendingLanes,g.lanes=t,mg(e,t)}}var to={readContext:Zi,useCallback:mC,useContext:mC,useEffect:mC,useImperativeHandle:mC,useInsertionEffect:mC,useLayoutEffect:mC,useMemo:mC,useReducer:mC,useRef:mC,useState:mC,useDebugValue:mC,useDeferredValue:mC,useTransition:mC,useMutableSource:mC,useSyncExternalStore:mC,useId:mC,unstable_isNewReconciler:!1},Io={readContext:Zi,useCallback:function(e,g){return ZC().memoizedState=[e,void 0===g?null:g],e},useContext:Zi,useEffect:kC,useImperativeHandle:function(e,g,t){return t=null!=t?t.concat([e]):null,xC(4194308,4,EC.bind(null,g,e),t)},useLayoutEffect:function(e,g){return xC(4194308,4,e,g)},useInsertionEffect:function(e,g){return xC(4,2,e,g)},useMemo:function(e,g){var t=ZC();return g=void 0===g?null:g,e=e(),t.memoizedState=[e,g],e},useReducer:function(e,g,t){var I=ZC();return g=void 0!==t?t(g):g,I.memoizedState=I.baseState=g,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:g},I.queue=e,e=e.dispatch=_C.bind(null,rC,e),[I.memoizedState,e]},useRef:function(e){return e={current:e},ZC().memoizedState=e},useState:HC,useDebugValue:UC,useDeferredValue:function(e){return ZC().memoizedState=e},useTransition:function(){var e=HC(!1),g=e[0];return e=jC.bind(null,e[1]),ZC().memoizedState=e,[g,e]},useMutableSource:function(){},useSyncExternalStore:function(e,g,t){var I=rC,n=ZC();if(gi){if(void 0===t)throw Error(i(407));t=t()}else{if(t=g(),null===wa)throw Error(i(349));0!=(30&lC)||VC(I,g,t)}n.memoizedState=t;var C={value:t,getSnapshot:g};return n.queue=C,kC(SC.bind(null,I,C,e),[e]),I.flags|=2048,NC(9,XC.bind(null,I,C,t,g),void 0,null),t},useId:function(){var e=ZC(),g=wa.identifierPrefix;if(gi){var t=On;g=":"+g+"R"+(t=(Dn&~(1<<32-Cg(Dn)-1)).toString(32)+t),0<(t=hC++)&&(g+="H"+t.toString(32)),g+=":"}else g=":"+g+"r"+(t=bC++).toString(32)+":";return e.memoizedState=g},unstable_isNewReconciler:!1},no={readContext:Zi,useCallback:QC,useContext:Zi,useEffect:MC,useImperativeHandle:TC,useInsertionEffect:LC,useLayoutEffect:JC,useMemo:DC,useReducer:WC,useRef:FC,useState:function(){return WC(vC)},useDebugValue:UC,useDeferredValue:function(e){return OC(yC(),AC.memoizedState,e)},useTransition:function(){return[WC(vC)[0],yC().memoizedState]},useMutableSource:wC,useSyncExternalStore:RC,useId:PC,unstable_isNewReconciler:!1},io={readContext:Zi,useCallback:QC,useContext:Zi,useEffect:MC,useImperativeHandle:TC,useInsertionEffect:LC,useLayoutEffect:JC,useMemo:DC,useReducer:fC,useRef:FC,useState:function(){return fC(vC)},useDebugValue:UC,useDeferredValue:function(e){var g=yC();return null===AC?g.memoizedState=e:OC(g,AC.memoizedState,e)},useTransition:function(){return[fC(vC)[0],yC().memoizedState]},useMutableSource:wC,useSyncExternalStore:RC,useId:PC,unstable_isNewReconciler:!1};function Co(e,g){try{var t="",I=g;do{t+=L(I),I=I.return}while(I);var n=t}catch(e){n="\nError generating stack: "+e.message+"\n"+e.stack}return{value:e,source:g,stack:n,digest:null}}function oo(e,g,t){return{value:e,source:null,stack:null!=t?t:null,digest:null!=g?g:null}}function ao(e,g){try{console.error(g.value)}catch(e){setTimeout((function(){throw e}))}}var so="function"==typeof WeakMap?WeakMap:Map;function lo(e,g,t){(t=Xi(-1,t)).tag=3,t.payload={element:null};var I=g.value;return t.callback=function(){Ja||(Ja=!0,Ea=I),ao(0,g)},t}function ro(e,g,t){(t=Xi(-1,t)).tag=3;var I=e.type.getDerivedStateFromError;if("function"==typeof I){var n=g.value;t.payload=function(){return I(n)},t.callback=function(){ao(0,g)}}var i=e.stateNode;return null!==i&&"function"==typeof i.componentDidCatch&&(t.callback=function(){ao(0,g),"function"!=typeof I&&(null===Ta?Ta=new Set([this]):Ta.add(this));var e=g.stack;this.componentDidCatch(g.value,{componentStack:null!==e?e:""})}),t}function Ao(e,g,t){var I=e.pingCache;if(null===I){I=e.pingCache=new so;var n=new Set;I.set(g,n)}else void 0===(n=I.get(g))&&(n=new Set,I.set(g,n));n.has(t)||(n.add(t),e=ys.bind(null,e,g,t),g.then(e,e))}function co(e){do{var g;if((g=13===e.tag)&&(g=null===(g=e.memoizedState)||null!==g.dehydrated),g)return e;e=e.return}while(null!==e);return null}function uo(e,g,t,I,n){return 0==(1&e.mode)?(e===g?e.flags|=65536:(e.flags|=128,t.flags|=131072,t.flags&=-52805,1===t.tag&&(null===t.alternate?t.tag=17:((g=Xi(-1,1)).tag=2,Si(t,g,1))),t.lanes|=1),e):(e.flags|=65536,e.lanes=n,e)}var ho=G.ReactCurrentOwner,bo=!1;function mo(e,g,t,I){g.child=null===e?Oi(g,null,t,I):Di(g,e.child,t,I)}function po(e,g,t,I,n){t=t.render;var i=g.ref;return Bi(g,n),I=GC(e,g,t,I,i,n),t=BC(),null===e||bo?(gi&&t&&_n(g),g.flags|=1,mo(e,g,I,n),g.child):(g.updateQueue=e.updateQueue,g.flags&=-2053,e.lanes&=~n,Jo(e,g,n))}function Go(e,g,t,I,n){if(null===e){var i=t.type;return"function"!=typeof i||Xs(i)||void 0!==i.defaultProps||null!==t.compare||void 0!==t.defaultProps?((e=Ys(t.type,null,I,g,g.mode,n)).ref=g.ref,e.return=g,g.child=e):(g.tag=15,g.type=i,Bo(e,g,i,I,n))}if(i=e.child,0==(e.lanes&n)){var C=i.memoizedProps;if((t=null!==(t=t.compare)?t:nI)(C,I)&&e.ref===g.ref)return Jo(e,g,n)}return g.flags|=1,(e=Ss(i,I)).ref=g.ref,e.return=g,g.child=e}function Bo(e,g,t,I,n){if(null!==e){var i=e.memoizedProps;if(nI(i,I)&&e.ref===g.ref){if(bo=!1,g.pendingProps=I=i,0==(e.lanes&n))return g.lanes=e.lanes,Jo(e,g,n);0!=(131072&e.flags)&&(bo=!0)}}return vo(e,g,t,I,n)}function Zo(e,g,t){var I=g.pendingProps,n=I.children,i=null!==e?e.memoizedState:null;if("hidden"===I.mode)if(0==(1&g.mode))g.memoizedState={baseLanes:0,cachePool:null,transitions:null},yn(Sa,Xa),Xa|=t;else{if(0==(1073741824&t))return e=null!==i?i.baseLanes|t:t,g.lanes=g.childLanes=1073741824,g.memoizedState={baseLanes:e,cachePool:null,transitions:null},g.updateQueue=null,yn(Sa,Xa),Xa|=e,null;g.memoizedState={baseLanes:0,cachePool:null,transitions:null},I=null!==i?i.baseLanes:t,yn(Sa,Xa),Xa|=I}else null!==i?(I=i.baseLanes|t,g.memoizedState=null):I=t,yn(Sa,Xa),Xa|=I;return mo(e,g,n,t),g.child}function yo(e,g){var t=g.ref;(null===e&&null!==t||null!==e&&e.ref!==t)&&(g.flags|=512,g.flags|=2097152)}function vo(e,g,t,I,n){var i=Vn(t)?wn:Wn.current;return i=Rn(g,i),Bi(g,n),t=GC(e,g,t,I,i,n),I=BC(),null===e||bo?(gi&&I&&_n(g),g.flags|=1,mo(e,g,t,n),g.child):(g.updateQueue=e.updateQueue,g.flags&=-2053,e.lanes&=~n,Jo(e,g,n))}function Wo(e,g,t,I,n){if(Vn(t)){var i=!0;Kn(g)}else i=!1;if(Bi(g,n),null===g.stateNode)Lo(e,g),Mi(g,t,I),Ji(g,t,I,n),I=!0;else if(null===e){var C=g.stateNode,o=g.memoizedProps;C.props=o;var a=C.context,s=t.contextType;s="object"==typeof s&&null!==s?Zi(s):Rn(g,s=Vn(t)?wn:Wn.current);var l=t.getDerivedStateFromProps,r="function"==typeof l||"function"==typeof C.getSnapshotBeforeUpdate;r||"function"!=typeof C.UNSAFE_componentWillReceiveProps&&"function"!=typeof C.componentWillReceiveProps||(o!==I||a!==s)&&Li(g,C,I,s),wi=!1;var A=g.memoizedState;C.state=A,Hi(g,I,C,n),a=g.memoizedState,o!==I||A!==a||fn.current||wi?("function"==typeof l&&(xi(g,t,l,I),a=g.memoizedState),(o=wi||ki(g,t,o,I,A,a,s))?(r||"function"!=typeof C.UNSAFE_componentWillMount&&"function"!=typeof C.componentWillMount||("function"==typeof C.componentWillMount&&C.componentWillMount(),"function"==typeof C.UNSAFE_componentWillMount&&C.UNSAFE_componentWillMount()),"function"==typeof C.componentDidMount&&(g.flags|=4194308)):("function"==typeof C.componentDidMount&&(g.flags|=4194308),g.memoizedProps=I,g.memoizedState=a),C.props=I,C.state=a,C.context=s,I=o):("function"==typeof C.componentDidMount&&(g.flags|=4194308),I=!1)}else{C=g.stateNode,Vi(e,g),o=g.memoizedProps,s=g.type===g.elementType?o:ci(g.type,o),C.props=s,r=g.pendingProps,A=C.context,a="object"==typeof(a=t.contextType)&&null!==a?Zi(a):Rn(g,a=Vn(t)?wn:Wn.current);var c=t.getDerivedStateFromProps;(l="function"==typeof c||"function"==typeof C.getSnapshotBeforeUpdate)||"function"!=typeof C.UNSAFE_componentWillReceiveProps&&"function"!=typeof C.componentWillReceiveProps||(o!==r||A!==a)&&Li(g,C,I,a),wi=!1,A=g.memoizedState,C.state=A,Hi(g,I,C,n);var d=g.memoizedState;o!==r||A!==d||fn.current||wi?("function"==typeof c&&(xi(g,t,c,I),d=g.memoizedState),(s=wi||ki(g,t,s,I,A,d,a)||!1)?(l||"function"!=typeof C.UNSAFE_componentWillUpdate&&"function"!=typeof C.componentWillUpdate||("function"==typeof C.componentWillUpdate&&C.componentWillUpdate(I,d,a),"function"==typeof C.UNSAFE_componentWillUpdate&&C.UNSAFE_componentWillUpdate(I,d,a)),"function"==typeof C.componentDidUpdate&&(g.flags|=4),"function"==typeof C.getSnapshotBeforeUpdate&&(g.flags|=1024)):("function"!=typeof C.componentDidUpdate||o===e.memoizedProps&&A===e.memoizedState||(g.flags|=4),"function"!=typeof C.getSnapshotBeforeUpdate||o===e.memoizedProps&&A===e.memoizedState||(g.flags|=1024),g.memoizedProps=I,g.memoizedState=d),C.props=I,C.state=d,C.context=a,I=s):("function"!=typeof C.componentDidUpdate||o===e.memoizedProps&&A===e.memoizedState||(g.flags|=4),"function"!=typeof C.getSnapshotBeforeUpdate||o===e.memoizedProps&&A===e.memoizedState||(g.flags|=1024),I=!1)}return fo(e,g,t,I,i,n)}function fo(e,g,t,I,n,i){yo(e,g);var C=0!=(128&g.flags);if(!I&&!C)return n&&Hn(g,t,!1),Jo(e,g,i);I=g.stateNode,ho.current=g;var o=C&&"function"!=typeof t.getDerivedStateFromError?null:I.render();return g.flags|=1,null!==e&&C?(g.child=Di(g,e.child,null,i),g.child=Di(g,null,o,i)):mo(e,g,o,i),g.memoizedState=I.state,n&&Hn(g,t,!0),g.child}function wo(e){var g=e.stateNode;g.pendingContext?Sn(0,g.pendingContext,g.pendingContext!==g.context):g.context&&Sn(0,g.context,!1),eC(e,g.containerInfo)}function Ro(e,g,t,I,n){return li(),ri(n),g.flags|=256,mo(e,g,t,I),g.child}var Vo,Xo,So,Yo,Ko={dehydrated:null,treeContext:null,retryLane:0};function Ho(e){return{baseLanes:e,cachePool:null,transitions:null}}function No(e,g,t){var I,n=g.pendingProps,C=nC.current,o=!1,a=0!=(128&g.flags);if((I=a)||(I=(null===e||null!==e.memoizedState)&&0!=(2&C)),I?(o=!0,g.flags&=-129):null!==e&&null===e.memoizedState||(C|=1),yn(nC,1&C),null===e)return Ci(g),null!==(e=g.memoizedState)&&null!==(e=e.dehydrated)?(0==(1&g.mode)?g.lanes=1:"$!"===e.data?g.lanes=8:g.lanes=1073741824,null):(a=n.children,e=n.fallback,o?(n=g.mode,o=g.child,a={mode:"hidden",children:a},0==(1&n)&&null!==o?(o.childLanes=0,o.pendingProps=a):o=Hs(a,n,0,null),e=Ks(e,n,t,null),o.return=g,e.return=g,o.sibling=e,g.child=o,g.child.memoizedState=Ho(t),g.memoizedState=Ko,e):Fo(g,a));if(null!==(C=e.memoizedState)&&null!==(I=C.dehydrated))return function(e,g,t,I,n,C,o){if(t)return 256&g.flags?(g.flags&=-257,xo(e,g,o,I=oo(Error(i(422))))):null!==g.memoizedState?(g.child=e.child,g.flags|=128,null):(C=I.fallback,n=g.mode,I=Hs({mode:"visible",children:I.children},n,0,null),(C=Ks(C,n,o,null)).flags|=2,I.return=g,C.return=g,I.sibling=C,g.child=I,0!=(1&g.mode)&&Di(g,e.child,null,o),g.child.memoizedState=Ho(o),g.memoizedState=Ko,C);if(0==(1&g.mode))return xo(e,g,o,null);if("$!"===n.data){if(I=n.nextSibling&&n.nextSibling.dataset)var a=I.dgst;return I=a,xo(e,g,o,I=oo(C=Error(i(419)),I,void 0))}if(a=0!=(o&e.childLanes),bo||a){if(null!==(I=wa)){switch(o&-o){case 4:n=2;break;case 16:n=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:n=32;break;case 536870912:n=268435456;break;default:n=0}0!==(n=0!=(n&(I.suspendedLanes|o))?0:n)&&n!==C.retryLane&&(C.retryLane=n,fi(e,n),es(I,e,n,-1))}return cs(),xo(e,g,o,I=oo(Error(i(421))))}return"$?"===n.data?(g.flags|=128,g.child=e.child,g=Ws.bind(null,e),n._reactRetry=g,null):(e=C.treeContext,ei=Cn(n.nextSibling),$n=g,gi=!0,ti=null,null!==e&&(Tn[Un++]=Dn,Tn[Un++]=On,Tn[Un++]=Qn,Dn=e.id,On=e.overflow,Qn=g),(g=Fo(g,I.children)).flags|=4096,g)}(e,g,a,n,I,C,t);if(o){o=n.fallback,a=g.mode,I=(C=e.child).sibling;var s={mode:"hidden",children:n.children};return 0==(1&a)&&g.child!==C?((n=g.child).childLanes=0,n.pendingProps=s,g.deletions=null):(n=Ss(C,s)).subtreeFlags=14680064&C.subtreeFlags,null!==I?o=Ss(I,o):(o=Ks(o,a,t,null)).flags|=2,o.return=g,n.return=g,n.sibling=o,g.child=n,n=o,o=g.child,a=null===(a=e.child.memoizedState)?Ho(t):{baseLanes:a.baseLanes|t,cachePool:null,transitions:a.transitions},o.memoizedState=a,o.childLanes=e.childLanes&~t,g.memoizedState=Ko,n}return e=(o=e.child).sibling,n=Ss(o,{mode:"visible",children:n.children}),0==(1&g.mode)&&(n.lanes=t),n.return=g,n.sibling=null,null!==e&&(null===(t=g.deletions)?(g.deletions=[e],g.flags|=16):t.push(e)),g.child=n,g.memoizedState=null,n}function Fo(e,g){return(g=Hs({mode:"visible",children:g},e.mode,0,null)).return=e,e.child=g}function xo(e,g,t,I){return null!==I&&ri(I),Di(g,e.child,null,t),(e=Fo(g,g.pendingProps.children)).flags|=2,g.memoizedState=null,e}function zo(e,g,t){e.lanes|=g;var I=e.alternate;null!==I&&(I.lanes|=g),Gi(e.return,g,t)}function ko(e,g,t,I,n){var i=e.memoizedState;null===i?e.memoizedState={isBackwards:g,rendering:null,renderingStartTime:0,last:I,tail:t,tailMode:n}:(i.isBackwards=g,i.rendering=null,i.renderingStartTime=0,i.last=I,i.tail=t,i.tailMode=n)}function Mo(e,g,t){var I=g.pendingProps,n=I.revealOrder,i=I.tail;if(mo(e,g,I.children,t),0!=(2&(I=nC.current)))I=1&I|2,g.flags|=128;else{if(null!==e&&0!=(128&e.flags))e:for(e=g.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&zo(e,t,g);else if(19===e.tag)zo(e,t,g);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===g)break e;for(;null===e.sibling;){if(null===e.return||e.return===g)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}I&=1}if(yn(nC,I),0==(1&g.mode))g.memoizedState=null;else switch(n){case"forwards":for(t=g.child,n=null;null!==t;)null!==(e=t.alternate)&&null===iC(e)&&(n=t),t=t.sibling;null===(t=n)?(n=g.child,g.child=null):(n=t.sibling,t.sibling=null),ko(g,!1,n,t,i);break;case"backwards":for(t=null,n=g.child,g.child=null;null!==n;){if(null!==(e=n.alternate)&&null===iC(e)){g.child=n;break}e=n.sibling,n.sibling=t,t=n,n=e}ko(g,!0,t,null,i);break;case"together":ko(g,!1,null,null,void 0);break;default:g.memoizedState=null}return g.child}function Lo(e,g){0==(1&g.mode)&&null!==e&&(e.alternate=null,g.alternate=null,g.flags|=2)}function Jo(e,g,t){if(null!==e&&(g.dependencies=e.dependencies),Ha|=g.lanes,0==(t&g.childLanes))return null;if(null!==e&&g.child!==e.child)throw Error(i(153));if(null!==g.child){for(t=Ss(e=g.child,e.pendingProps),g.child=t,t.return=g;null!==e.sibling;)e=e.sibling,(t=t.sibling=Ss(e,e.pendingProps)).return=g;t.sibling=null}return g.child}function Eo(e,g){if(!gi)switch(e.tailMode){case"hidden":g=e.tail;for(var t=null;null!==g;)null!==g.alternate&&(t=g),g=g.sibling;null===t?e.tail=null:t.sibling=null;break;case"collapsed":t=e.tail;for(var I=null;null!==t;)null!==t.alternate&&(I=t),t=t.sibling;null===I?g||null===e.tail?e.tail=null:e.tail.sibling=null:I.sibling=null}}function To(e){var g=null!==e.alternate&&e.alternate.child===e.child,t=0,I=0;if(g)for(var n=e.child;null!==n;)t|=n.lanes|n.childLanes,I|=14680064&n.subtreeFlags,I|=14680064&n.flags,n.return=e,n=n.sibling;else for(n=e.child;null!==n;)t|=n.lanes|n.childLanes,I|=n.subtreeFlags,I|=n.flags,n.return=e,n=n.sibling;return e.subtreeFlags|=I,e.childLanes=t,g}function Uo(e,g,t){var I=g.pendingProps;switch(qn(g),g.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return To(g),null;case 1:case 17:return Vn(g.type)&&Xn(),To(g),null;case 3:return I=g.stateNode,gC(),Zn(fn),Zn(Wn),oC(),I.pendingContext&&(I.context=I.pendingContext,I.pendingContext=null),null!==e&&null!==e.child||(ai(g)?g.flags|=4:null===e||e.memoizedState.isDehydrated&&0==(256&g.flags)||(g.flags|=1024,null!==ti&&(ns(ti),ti=null))),Xo(e,g),To(g),null;case 5:IC(g);var n=$i(qi.current);if(t=g.type,null!==e&&null!=g.stateNode)So(e,g,t,I,n),e.ref!==g.ref&&(g.flags|=512,g.flags|=2097152);else{if(!I){if(null===g.stateNode)throw Error(i(166));return To(g),null}if(e=$i(Pi.current),ai(g)){I=g.stateNode,t=g.type;var C=g.memoizedProps;switch(I[sn]=g,I[ln]=C,e=0!=(1&g.mode),t){case"dialog":NI("cancel",I),NI("close",I);break;case"iframe":case"object":case"embed":NI("load",I);break;case"video":case"audio":for(n=0;n<SI.length;n++)NI(SI[n],I);break;case"source":NI("error",I);break;case"img":case"image":case"link":NI("error",I),NI("load",I);break;case"details":NI("toggle",I);break;case"input":P(I,C),NI("invalid",I);break;case"select":I._wrapperState={wasMultiple:!!C.multiple},NI("invalid",I);break;case"textarea":ne(I,C),NI("invalid",I)}for(var a in me(t,C),n=null,C)if(C.hasOwnProperty(a)){var s=C[a];"children"===a?"string"==typeof s?I.textContent!==s&&(!0!==C.suppressHydrationWarning&&OI(I.textContent,s,e),n=["children",s]):"number"==typeof s&&I.textContent!==""+s&&(!0!==C.suppressHydrationWarning&&OI(I.textContent,s,e),n=["children",""+s]):o.hasOwnProperty(a)&&null!=s&&"onScroll"===a&&NI("scroll",I)}switch(t){case"input":Q(I),$(I,C,!0);break;case"textarea":Q(I),Ce(I);break;case"select":case"option":break;default:"function"==typeof C.onClick&&(I.onclick=jI)}I=n,g.updateQueue=I,null!==I&&(g.flags|=4)}else{a=9===n.nodeType?n:n.ownerDocument,"http://www.w3.org/1999/xhtml"===e&&(e=oe(t)),"http://www.w3.org/1999/xhtml"===e?"script"===t?((e=a.createElement("div")).innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):"string"==typeof I.is?e=a.createElement(t,{is:I.is}):(e=a.createElement(t),"select"===t&&(a=e,I.multiple?a.multiple=!0:I.size&&(a.size=I.size))):e=a.createElementNS(e,t),e[sn]=g,e[ln]=I,Vo(e,g,!1,!1),g.stateNode=e;e:{switch(a=pe(t,I),t){case"dialog":NI("cancel",e),NI("close",e),n=I;break;case"iframe":case"object":case"embed":NI("load",e),n=I;break;case"video":case"audio":for(n=0;n<SI.length;n++)NI(SI[n],e);n=I;break;case"source":NI("error",e),n=I;break;case"img":case"image":case"link":NI("error",e),NI("load",e),n=I;break;case"details":NI("toggle",e),n=I;break;case"input":P(e,I),n=j(e,I),NI("invalid",e);break;case"option":default:n=I;break;case"select":e._wrapperState={wasMultiple:!!I.multiple},n=x({},I,{value:void 0}),NI("invalid",e);break;case"textarea":ne(e,I),n=Ie(e,I),NI("invalid",e)}for(C in me(t,n),s=n)if(s.hasOwnProperty(C)){var l=s[C];"style"===C?he(e,l):"dangerouslySetInnerHTML"===C?null!=(l=l?l.__html:void 0)&&re(e,l):"children"===C?"string"==typeof l?("textarea"!==t||""!==l)&&Ae(e,l):"number"==typeof l&&Ae(e,""+l):"suppressContentEditableWarning"!==C&&"suppressHydrationWarning"!==C&&"autoFocus"!==C&&(o.hasOwnProperty(C)?null!=l&&"onScroll"===C&&NI("scroll",e):null!=l&&p(e,C,l,a))}switch(t){case"input":Q(e),$(e,I,!1);break;case"textarea":Q(e),Ce(e);break;case"option":null!=I.value&&e.setAttribute("value",""+T(I.value));break;case"select":e.multiple=!!I.multiple,null!=(C=I.value)?te(e,!!I.multiple,C,!1):null!=I.defaultValue&&te(e,!!I.multiple,I.defaultValue,!0);break;default:"function"==typeof n.onClick&&(e.onclick=jI)}switch(t){case"button":case"input":case"select":case"textarea":I=!!I.autoFocus;break e;case"img":I=!0;break e;default:I=!1}}I&&(g.flags|=4)}null!==g.ref&&(g.flags|=512,g.flags|=2097152)}return To(g),null;case 6:if(e&&null!=g.stateNode)Yo(e,g,e.memoizedProps,I);else{if("string"!=typeof I&&null===g.stateNode)throw Error(i(166));if(t=$i(qi.current),$i(Pi.current),ai(g)){if(I=g.stateNode,t=g.memoizedProps,I[sn]=g,(C=I.nodeValue!==t)&&null!==(e=$n))switch(e.tag){case 3:OI(I.nodeValue,t,0!=(1&e.mode));break;case 5:!0!==e.memoizedProps.suppressHydrationWarning&&OI(I.nodeValue,t,0!=(1&e.mode))}C&&(g.flags|=4)}else(I=(9===t.nodeType?t:t.ownerDocument).createTextNode(I))[sn]=g,g.stateNode=I}return To(g),null;case 13:if(Zn(nC),I=g.memoizedState,null===e||null!==e.memoizedState&&null!==e.memoizedState.dehydrated){if(gi&&null!==ei&&0!=(1&g.mode)&&0==(128&g.flags))si(),li(),g.flags|=98560,C=!1;else if(C=ai(g),null!==I&&null!==I.dehydrated){if(null===e){if(!C)throw Error(i(318));if(!(C=null!==(C=g.memoizedState)?C.dehydrated:null))throw Error(i(317));C[sn]=g}else li(),0==(128&g.flags)&&(g.memoizedState=null),g.flags|=4;To(g),C=!1}else null!==ti&&(ns(ti),ti=null),C=!0;if(!C)return 65536&g.flags?g:null}return 0!=(128&g.flags)?(g.lanes=t,g):((I=null!==I)!=(null!==e&&null!==e.memoizedState)&&I&&(g.child.flags|=8192,0!=(1&g.mode)&&(null===e||0!=(1&nC.current)?0===Ya&&(Ya=3):cs())),null!==g.updateQueue&&(g.flags|=4),To(g),null);case 4:return gC(),Xo(e,g),null===e&&zI(g.stateNode.containerInfo),To(g),null;case 10:return pi(g.type._context),To(g),null;case 19:if(Zn(nC),null===(C=g.memoizedState))return To(g),null;if(I=0!=(128&g.flags),null===(a=C.rendering))if(I)Eo(C,!1);else{if(0!==Ya||null!==e&&0!=(128&e.flags))for(e=g.child;null!==e;){if(null!==(a=iC(e))){for(g.flags|=128,Eo(C,!1),null!==(I=a.updateQueue)&&(g.updateQueue=I,g.flags|=4),g.subtreeFlags=0,I=t,t=g.child;null!==t;)e=I,(C=t).flags&=14680066,null===(a=C.alternate)?(C.childLanes=0,C.lanes=e,C.child=null,C.subtreeFlags=0,C.memoizedProps=null,C.memoizedState=null,C.updateQueue=null,C.dependencies=null,C.stateNode=null):(C.childLanes=a.childLanes,C.lanes=a.lanes,C.child=a.child,C.subtreeFlags=0,C.deletions=null,C.memoizedProps=a.memoizedProps,C.memoizedState=a.memoizedState,C.updateQueue=a.updateQueue,C.type=a.type,e=a.dependencies,C.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext}),t=t.sibling;return yn(nC,1&nC.current|2),g.child}e=e.sibling}null!==C.tail&&_e()>Ma&&(g.flags|=128,I=!0,Eo(C,!1),g.lanes=4194304)}else{if(!I)if(null!==(e=iC(a))){if(g.flags|=128,I=!0,null!==(t=e.updateQueue)&&(g.updateQueue=t,g.flags|=4),Eo(C,!0),null===C.tail&&"hidden"===C.tailMode&&!a.alternate&&!gi)return To(g),null}else 2*_e()-C.renderingStartTime>Ma&&1073741824!==t&&(g.flags|=128,I=!0,Eo(C,!1),g.lanes=4194304);C.isBackwards?(a.sibling=g.child,g.child=a):(null!==(t=C.last)?t.sibling=a:g.child=a,C.last=a)}return null!==C.tail?(g=C.tail,C.rendering=g,C.tail=g.sibling,C.renderingStartTime=_e(),g.sibling=null,t=nC.current,yn(nC,I?1&t|2:1&t),g):(To(g),null);case 22:case 23:return ss(),I=null!==g.memoizedState,null!==e&&null!==e.memoizedState!==I&&(g.flags|=8192),I&&0!=(1&g.mode)?0!=(1073741824&Xa)&&(To(g),6&g.subtreeFlags&&(g.flags|=8192)):To(g),null;case 24:case 25:return null}throw Error(i(156,g.tag))}function Qo(e,g){switch(qn(g),g.tag){case 1:return Vn(g.type)&&Xn(),65536&(e=g.flags)?(g.flags=-65537&e|128,g):null;case 3:return gC(),Zn(fn),Zn(Wn),oC(),0!=(65536&(e=g.flags))&&0==(128&e)?(g.flags=-65537&e|128,g):null;case 5:return IC(g),null;case 13:if(Zn(nC),null!==(e=g.memoizedState)&&null!==e.dehydrated){if(null===g.alternate)throw Error(i(340));li()}return 65536&(e=g.flags)?(g.flags=-65537&e|128,g):null;case 19:return Zn(nC),null;case 4:return gC(),null;case 10:return pi(g.type._context),null;case 22:case 23:return ss(),null;default:return null}}Vo=function(e,g){for(var t=g.child;null!==t;){if(5===t.tag||6===t.tag)e.appendChild(t.stateNode);else if(4!==t.tag&&null!==t.child){t.child.return=t,t=t.child;continue}if(t===g)break;for(;null===t.sibling;){if(null===t.return||t.return===g)return;t=t.return}t.sibling.return=t.return,t=t.sibling}},Xo=function(){},So=function(e,g,t,I){var n=e.memoizedProps;if(n!==I){e=g.stateNode,$i(Pi.current);var i,C=null;switch(t){case"input":n=j(e,n),I=j(e,I),C=[];break;case"select":n=x({},n,{value:void 0}),I=x({},I,{value:void 0}),C=[];break;case"textarea":n=Ie(e,n),I=Ie(e,I),C=[];break;default:"function"!=typeof n.onClick&&"function"==typeof I.onClick&&(e.onclick=jI)}for(l in me(t,I),t=null,n)if(!I.hasOwnProperty(l)&&n.hasOwnProperty(l)&&null!=n[l])if("style"===l){var a=n[l];for(i in a)a.hasOwnProperty(i)&&(t||(t={}),t[i]="")}else"dangerouslySetInnerHTML"!==l&&"children"!==l&&"suppressContentEditableWarning"!==l&&"suppressHydrationWarning"!==l&&"autoFocus"!==l&&(o.hasOwnProperty(l)?C||(C=[]):(C=C||[]).push(l,null));for(l in I){var s=I[l];if(a=null!=n?n[l]:void 0,I.hasOwnProperty(l)&&s!==a&&(null!=s||null!=a))if("style"===l)if(a){for(i in a)!a.hasOwnProperty(i)||s&&s.hasOwnProperty(i)||(t||(t={}),t[i]="");for(i in s)s.hasOwnProperty(i)&&a[i]!==s[i]&&(t||(t={}),t[i]=s[i])}else t||(C||(C=[]),C.push(l,t)),t=s;else"dangerouslySetInnerHTML"===l?(s=s?s.__html:void 0,a=a?a.__html:void 0,null!=s&&a!==s&&(C=C||[]).push(l,s)):"children"===l?"string"!=typeof s&&"number"!=typeof s||(C=C||[]).push(l,""+s):"suppressContentEditableWarning"!==l&&"suppressHydrationWarning"!==l&&(o.hasOwnProperty(l)?(null!=s&&"onScroll"===l&&NI("scroll",e),C||a===s||(C=[])):(C=C||[]).push(l,s))}t&&(C=C||[]).push("style",t);var l=C;(g.updateQueue=l)&&(g.flags|=4)}},Yo=function(e,g,t,I){t!==I&&(g.flags|=4)};var Do=!1,Oo=!1,jo="function"==typeof WeakSet?WeakSet:Set,Po=null;function _o(e,g){var t=e.ref;if(null!==t)if("function"==typeof t)try{t(null)}catch(t){Zs(e,g,t)}else t.current=null}function qo(e,g,t){try{t()}catch(t){Zs(e,g,t)}}var $o=!1;function ea(e,g,t){var I=g.updateQueue;if(null!==(I=null!==I?I.lastEffect:null)){var n=I=I.next;do{if((n.tag&e)===e){var i=n.destroy;n.destroy=void 0,void 0!==i&&qo(g,t,i)}n=n.next}while(n!==I)}}function ga(e,g){if(null!==(g=null!==(g=g.updateQueue)?g.lastEffect:null)){var t=g=g.next;do{if((t.tag&e)===e){var I=t.create;t.destroy=I()}t=t.next}while(t!==g)}}function ta(e){var g=e.ref;if(null!==g){var t=e.stateNode;e.tag,e=t,"function"==typeof g?g(e):g.current=e}}function Ia(e){var g=e.alternate;null!==g&&(e.alternate=null,Ia(g)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag&&null!==(g=e.stateNode)&&(delete g[sn],delete g[ln],delete g[An],delete g[cn],delete g[dn]),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function na(e){return 5===e.tag||3===e.tag||4===e.tag}function ia(e){e:for(;;){for(;null===e.sibling;){if(null===e.return||na(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;5!==e.tag&&6!==e.tag&&18!==e.tag;){if(2&e.flags)continue e;if(null===e.child||4===e.tag)continue e;e.child.return=e,e=e.child}if(!(2&e.flags))return e.stateNode}}function Ca(e,g,t){var I=e.tag;if(5===I||6===I)e=e.stateNode,g?8===t.nodeType?t.parentNode.insertBefore(e,g):t.insertBefore(e,g):(8===t.nodeType?(g=t.parentNode).insertBefore(e,t):(g=t).appendChild(e),null!=(t=t._reactRootContainer)||null!==g.onclick||(g.onclick=jI));else if(4!==I&&null!==(e=e.child))for(Ca(e,g,t),e=e.sibling;null!==e;)Ca(e,g,t),e=e.sibling}function oa(e,g,t){var I=e.tag;if(5===I||6===I)e=e.stateNode,g?t.insertBefore(e,g):t.appendChild(e);else if(4!==I&&null!==(e=e.child))for(oa(e,g,t),e=e.sibling;null!==e;)oa(e,g,t),e=e.sibling}var aa=null,sa=!1;function la(e,g,t){for(t=t.child;null!==t;)ra(e,g,t),t=t.sibling}function ra(e,g,t){if(ig&&"function"==typeof ig.onCommitFiberUnmount)try{ig.onCommitFiberUnmount(ng,t)}catch(e){}switch(t.tag){case 5:Oo||_o(t,g);case 6:var I=aa,n=sa;aa=null,la(e,g,t),sa=n,null!==(aa=I)&&(sa?(e=aa,t=t.stateNode,8===e.nodeType?e.parentNode.removeChild(t):e.removeChild(t)):aa.removeChild(t.stateNode));break;case 18:null!==aa&&(sa?(e=aa,t=t.stateNode,8===e.nodeType?nn(e.parentNode,t):1===e.nodeType&&nn(e,t),Jg(e)):nn(aa,t.stateNode));break;case 4:I=aa,n=sa,aa=t.stateNode.containerInfo,sa=!0,la(e,g,t),aa=I,sa=n;break;case 0:case 11:case 14:case 15:if(!Oo&&null!==(I=t.updateQueue)&&null!==(I=I.lastEffect)){n=I=I.next;do{var i=n,C=i.destroy;i=i.tag,void 0!==C&&(0!=(2&i)||0!=(4&i))&&qo(t,g,C),n=n.next}while(n!==I)}la(e,g,t);break;case 1:if(!Oo&&(_o(t,g),"function"==typeof(I=t.stateNode).componentWillUnmount))try{I.props=t.memoizedProps,I.state=t.memoizedState,I.componentWillUnmount()}catch(e){Zs(t,g,e)}la(e,g,t);break;case 21:la(e,g,t);break;case 22:1&t.mode?(Oo=(I=Oo)||null!==t.memoizedState,la(e,g,t),Oo=I):la(e,g,t);break;default:la(e,g,t)}}function Aa(e){var g=e.updateQueue;if(null!==g){e.updateQueue=null;var t=e.stateNode;null===t&&(t=e.stateNode=new jo),g.forEach((function(g){var I=fs.bind(null,e,g);t.has(g)||(t.add(g),g.then(I,I))}))}}function ca(e,g){var t=g.deletions;if(null!==t)for(var I=0;I<t.length;I++){var n=t[I];try{var C=e,o=g,a=o;e:for(;null!==a;){switch(a.tag){case 5:aa=a.stateNode,sa=!1;break e;case 3:case 4:aa=a.stateNode.containerInfo,sa=!0;break e}a=a.return}if(null===aa)throw Error(i(160));ra(C,o,n),aa=null,sa=!1;var s=n.alternate;null!==s&&(s.return=null),n.return=null}catch(e){Zs(n,g,e)}}if(12854&g.subtreeFlags)for(g=g.child;null!==g;)da(g,e),g=g.sibling}function da(e,g){var t=e.alternate,I=e.flags;switch(e.tag){case 0:case 11:case 14:case 15:if(ca(g,e),ua(e),4&I){try{ea(3,e,e.return),ga(3,e)}catch(g){Zs(e,e.return,g)}try{ea(5,e,e.return)}catch(g){Zs(e,e.return,g)}}break;case 1:ca(g,e),ua(e),512&I&&null!==t&&_o(t,t.return);break;case 5:if(ca(g,e),ua(e),512&I&&null!==t&&_o(t,t.return),32&e.flags){var n=e.stateNode;try{Ae(n,"")}catch(g){Zs(e,e.return,g)}}if(4&I&&null!=(n=e.stateNode)){var C=e.memoizedProps,o=null!==t?t.memoizedProps:C,a=e.type,s=e.updateQueue;if(e.updateQueue=null,null!==s)try{"input"===a&&"radio"===C.type&&null!=C.name&&_(n,C),pe(a,o);var l=pe(a,C);for(o=0;o<s.length;o+=2){var r=s[o],A=s[o+1];"style"===r?he(n,A):"dangerouslySetInnerHTML"===r?re(n,A):"children"===r?Ae(n,A):p(n,r,A,l)}switch(a){case"input":q(n,C);break;case"textarea":ie(n,C);break;case"select":var c=n._wrapperState.wasMultiple;n._wrapperState.wasMultiple=!!C.multiple;var d=C.value;null!=d?te(n,!!C.multiple,d,!1):c!==!!C.multiple&&(null!=C.defaultValue?te(n,!!C.multiple,C.defaultValue,!0):te(n,!!C.multiple,C.multiple?[]:"",!1))}n[ln]=C}catch(g){Zs(e,e.return,g)}}break;case 6:if(ca(g,e),ua(e),4&I){if(null===e.stateNode)throw Error(i(162));n=e.stateNode,C=e.memoizedProps;try{n.nodeValue=C}catch(g){Zs(e,e.return,g)}}break;case 3:if(ca(g,e),ua(e),4&I&&null!==t&&t.memoizedState.isDehydrated)try{Jg(g.containerInfo)}catch(g){Zs(e,e.return,g)}break;case 4:default:ca(g,e),ua(e);break;case 13:ca(g,e),ua(e),8192&(n=e.child).flags&&(C=null!==n.memoizedState,n.stateNode.isHidden=C,!C||null!==n.alternate&&null!==n.alternate.memoizedState||(ka=_e())),4&I&&Aa(e);break;case 22:if(r=null!==t&&null!==t.memoizedState,1&e.mode?(Oo=(l=Oo)||r,ca(g,e),Oo=l):ca(g,e),ua(e),8192&I){if(l=null!==e.memoizedState,(e.stateNode.isHidden=l)&&!r&&0!=(1&e.mode))for(Po=e,r=e.child;null!==r;){for(A=Po=r;null!==Po;){switch(d=(c=Po).child,c.tag){case 0:case 11:case 14:case 15:ea(4,c,c.return);break;case 1:_o(c,c.return);var u=c.stateNode;if("function"==typeof u.componentWillUnmount){I=c,t=c.return;try{g=I,u.props=g.memoizedProps,u.state=g.memoizedState,u.componentWillUnmount()}catch(e){Zs(I,t,e)}}break;case 5:_o(c,c.return);break;case 22:if(null!==c.memoizedState){pa(A);continue}}null!==d?(d.return=c,Po=d):pa(A)}r=r.sibling}e:for(r=null,A=e;;){if(5===A.tag){if(null===r){r=A;try{n=A.stateNode,l?"function"==typeof(C=n.style).setProperty?C.setProperty("display","none","important"):C.display="none":(a=A.stateNode,o=null!=(s=A.memoizedProps.style)&&s.hasOwnProperty("display")?s.display:null,a.style.display=ue("display",o))}catch(g){Zs(e,e.return,g)}}}else if(6===A.tag){if(null===r)try{A.stateNode.nodeValue=l?"":A.memoizedProps}catch(g){Zs(e,e.return,g)}}else if((22!==A.tag&&23!==A.tag||null===A.memoizedState||A===e)&&null!==A.child){A.child.return=A,A=A.child;continue}if(A===e)break e;for(;null===A.sibling;){if(null===A.return||A.return===e)break e;r===A&&(r=null),A=A.return}r===A&&(r=null),A.sibling.return=A.return,A=A.sibling}}break;case 19:ca(g,e),ua(e),4&I&&Aa(e);case 21:}}function ua(e){var g=e.flags;if(2&g){try{e:{for(var t=e.return;null!==t;){if(na(t)){var I=t;break e}t=t.return}throw Error(i(160))}switch(I.tag){case 5:var n=I.stateNode;32&I.flags&&(Ae(n,""),I.flags&=-33),oa(e,ia(e),n);break;case 3:case 4:var C=I.stateNode.containerInfo;Ca(e,ia(e),C);break;default:throw Error(i(161))}}catch(g){Zs(e,e.return,g)}e.flags&=-3}4096&g&&(e.flags&=-4097)}function ha(e,g,t){Po=e,ba(e,g,t)}function ba(e,g,t){for(var I=0!=(1&e.mode);null!==Po;){var n=Po,i=n.child;if(22===n.tag&&I){var C=null!==n.memoizedState||Do;if(!C){var o=n.alternate,a=null!==o&&null!==o.memoizedState||Oo;o=Do;var s=Oo;if(Do=C,(Oo=a)&&!s)for(Po=n;null!==Po;)a=(C=Po).child,22===C.tag&&null!==C.memoizedState?Ga(n):null!==a?(a.return=C,Po=a):Ga(n);for(;null!==i;)Po=i,ba(i,g,t),i=i.sibling;Po=n,Do=o,Oo=s}ma(e)}else 0!=(8772&n.subtreeFlags)&&null!==i?(i.return=n,Po=i):ma(e)}}function ma(e){for(;null!==Po;){var g=Po;if(0!=(8772&g.flags)){var t=g.alternate;try{if(0!=(8772&g.flags))switch(g.tag){case 0:case 11:case 15:Oo||ga(5,g);break;case 1:var I=g.stateNode;if(4&g.flags&&!Oo)if(null===t)I.componentDidMount();else{var n=g.elementType===g.type?t.memoizedProps:ci(g.type,t.memoizedProps);I.componentDidUpdate(n,t.memoizedState,I.__reactInternalSnapshotBeforeUpdate)}var C=g.updateQueue;null!==C&&Ni(g,C,I);break;case 3:var o=g.updateQueue;if(null!==o){if(t=null,null!==g.child)switch(g.child.tag){case 5:case 1:t=g.child.stateNode}Ni(g,o,t)}break;case 5:var a=g.stateNode;if(null===t&&4&g.flags){t=a;var s=g.memoizedProps;switch(g.type){case"button":case"input":case"select":case"textarea":s.autoFocus&&t.focus();break;case"img":s.src&&(t.src=s.src)}}break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:case 25:break;case 13:if(null===g.memoizedState){var l=g.alternate;if(null!==l){var r=l.memoizedState;if(null!==r){var A=r.dehydrated;null!==A&&Jg(A)}}}break;default:throw Error(i(163))}Oo||512&g.flags&&ta(g)}catch(e){Zs(g,g.return,e)}}if(g===e){Po=null;break}if(null!==(t=g.sibling)){t.return=g.return,Po=t;break}Po=g.return}}function pa(e){for(;null!==Po;){var g=Po;if(g===e){Po=null;break}var t=g.sibling;if(null!==t){t.return=g.return,Po=t;break}Po=g.return}}function Ga(e){for(;null!==Po;){var g=Po;try{switch(g.tag){case 0:case 11:case 15:var t=g.return;try{ga(4,g)}catch(e){Zs(g,t,e)}break;case 1:var I=g.stateNode;if("function"==typeof I.componentDidMount){var n=g.return;try{I.componentDidMount()}catch(e){Zs(g,n,e)}}var i=g.return;try{ta(g)}catch(e){Zs(g,i,e)}break;case 5:var C=g.return;try{ta(g)}catch(e){Zs(g,C,e)}}}catch(e){Zs(g,g.return,e)}if(g===e){Po=null;break}var o=g.sibling;if(null!==o){o.return=g.return,Po=o;break}Po=g.return}}var Ba,Za=Math.ceil,ya=G.ReactCurrentDispatcher,va=G.ReactCurrentOwner,Wa=G.ReactCurrentBatchConfig,fa=0,wa=null,Ra=null,Va=0,Xa=0,Sa=Bn(0),Ya=0,Ka=null,Ha=0,Na=0,Fa=0,xa=null,za=null,ka=0,Ma=1/0,La=null,Ja=!1,Ea=null,Ta=null,Ua=!1,Qa=null,Da=0,Oa=0,ja=null,Pa=-1,_a=0;function qa(){return 0!=(6&fa)?_e():-1!==Pa?Pa:Pa=_e()}function $a(e){return 0==(1&e.mode)?1:0!=(2&fa)&&0!==Va?Va&-Va:null!==Ai.transition?(0===_a&&(_a=ug()),_a):0!==(e=pg)?e:e=void 0===(e=window.event)?16:Pg(e.type)}function es(e,g,t,I){if(50<Oa)throw Oa=0,ja=null,Error(i(185));bg(e,t,I),0!=(2&fa)&&e===wa||(e===wa&&(0==(2&fa)&&(Na|=t),4===Ya&&is(e,Va)),gs(e,I),1===t&&0===fa&&0==(1&g.mode)&&(Ma=_e()+500,Fn&&kn()))}function gs(e,g){var t=e.callbackNode;!function(e,g){for(var t=e.suspendedLanes,I=e.pingedLanes,n=e.expirationTimes,i=e.pendingLanes;0<i;){var C=31-Cg(i),o=1<<C,a=n[C];-1===a?0!=(o&t)&&0==(o&I)||(n[C]=cg(o,g)):a<=g&&(e.expiredLanes|=o),i&=~o}}(e,g);var I=Ag(e,e===wa?Va:0);if(0===I)null!==t&&Oe(t),e.callbackNode=null,e.callbackPriority=0;else if(g=I&-I,e.callbackPriority!==g){if(null!=t&&Oe(t),1===g)0===e.tag?function(e){Fn=!0,zn(e)}(Cs.bind(null,e)):zn(Cs.bind(null,e)),tn((function(){0==(6&fa)&&kn()})),t=null;else{switch(Gg(I)){case 1:t=$e;break;case 4:t=eg;break;case 16:default:t=gg;break;case 536870912:t=Ig}t=ws(t,ts.bind(null,e))}e.callbackPriority=g,e.callbackNode=t}}function ts(e,g){if(Pa=-1,_a=0,0!=(6&fa))throw Error(i(327));var t=e.callbackNode;if(Gs()&&e.callbackNode!==t)return null;var I=Ag(e,e===wa?Va:0);if(0===I)return null;if(0!=(30&I)||0!=(I&e.expiredLanes)||g)g=ds(e,I);else{g=I;var n=fa;fa|=2;var C=As();for(wa===e&&Va===g||(La=null,Ma=_e()+500,ls(e,g));;)try{hs();break}catch(g){rs(e,g)}mi(),ya.current=C,fa=n,null!==Ra?g=0:(wa=null,Va=0,g=Ya)}if(0!==g){if(2===g&&0!==(n=dg(e))&&(I=n,g=Is(e,n)),1===g)throw t=Ka,ls(e,0),is(e,I),gs(e,_e()),t;if(6===g)is(e,I);else{if(n=e.current.alternate,0==(30&I)&&!function(e){for(var g=e;;){if(16384&g.flags){var t=g.updateQueue;if(null!==t&&null!==(t=t.stores))for(var I=0;I<t.length;I++){var n=t[I],i=n.getSnapshot;n=n.value;try{if(!II(i(),n))return!1}catch(e){return!1}}}if(t=g.child,16384&g.subtreeFlags&&null!==t)t.return=g,g=t;else{if(g===e)break;for(;null===g.sibling;){if(null===g.return||g.return===e)return!0;g=g.return}g.sibling.return=g.return,g=g.sibling}}return!0}(n)&&(2===(g=ds(e,I))&&0!==(C=dg(e))&&(I=C,g=Is(e,C)),1===g))throw t=Ka,ls(e,0),is(e,I),gs(e,_e()),t;switch(e.finishedWork=n,e.finishedLanes=I,g){case 0:case 1:throw Error(i(345));case 2:case 5:ps(e,za,La);break;case 3:if(is(e,I),(130023424&I)===I&&10<(g=ka+500-_e())){if(0!==Ag(e,0))break;if(((n=e.suspendedLanes)&I)!==I){qa(),e.pingedLanes|=e.suspendedLanes&n;break}e.timeoutHandle=$I(ps.bind(null,e,za,La),g);break}ps(e,za,La);break;case 4:if(is(e,I),(4194240&I)===I)break;for(g=e.eventTimes,n=-1;0<I;){var o=31-Cg(I);C=1<<o,(o=g[o])>n&&(n=o),I&=~C}if(I=n,10<(I=(120>(I=_e()-I)?120:480>I?480:1080>I?1080:1920>I?1920:3e3>I?3e3:4320>I?4320:1960*Za(I/1960))-I)){e.timeoutHandle=$I(ps.bind(null,e,za,La),I);break}ps(e,za,La);break;default:throw Error(i(329))}}}return gs(e,_e()),e.callbackNode===t?ts.bind(null,e):null}function Is(e,g){var t=xa;return e.current.memoizedState.isDehydrated&&(ls(e,g).flags|=256),2!==(e=ds(e,g))&&(g=za,za=t,null!==g&&ns(g)),e}function ns(e){null===za?za=e:za.push.apply(za,e)}function is(e,g){for(g&=~Fa,g&=~Na,e.suspendedLanes|=g,e.pingedLanes&=~g,e=e.expirationTimes;0<g;){var t=31-Cg(g),I=1<<t;e[t]=-1,g&=~I}}function Cs(e){if(0!=(6&fa))throw Error(i(327));Gs();var g=Ag(e,0);if(0==(1&g))return gs(e,_e()),null;var t=ds(e,g);if(0!==e.tag&&2===t){var I=dg(e);0!==I&&(g=I,t=Is(e,I))}if(1===t)throw t=Ka,ls(e,0),is(e,g),gs(e,_e()),t;if(6===t)throw Error(i(345));return e.finishedWork=e.current.alternate,e.finishedLanes=g,ps(e,za,La),gs(e,_e()),null}function os(e,g){var t=fa;fa|=1;try{return e(g)}finally{0===(fa=t)&&(Ma=_e()+500,Fn&&kn())}}function as(e){null!==Qa&&0===Qa.tag&&0==(6&fa)&&Gs();var g=fa;fa|=1;var t=Wa.transition,I=pg;try{if(Wa.transition=null,pg=1,e)return e()}finally{pg=I,Wa.transition=t,0==(6&(fa=g))&&kn()}}function ss(){Xa=Sa.current,Zn(Sa)}function ls(e,g){e.finishedWork=null,e.finishedLanes=0;var t=e.timeoutHandle;if(-1!==t&&(e.timeoutHandle=-1,en(t)),null!==Ra)for(t=Ra.return;null!==t;){var I=t;switch(qn(I),I.tag){case 1:null!=(I=I.type.childContextTypes)&&Xn();break;case 3:gC(),Zn(fn),Zn(Wn),oC();break;case 5:IC(I);break;case 4:gC();break;case 13:case 19:Zn(nC);break;case 10:pi(I.type._context);break;case 22:case 23:ss()}t=t.return}if(wa=e,Ra=e=Ss(e.current,null),Va=Xa=g,Ya=0,Ka=null,Fa=Na=Ha=0,za=xa=null,null!==yi){for(g=0;g<yi.length;g++)if(null!==(I=(t=yi[g]).interleaved)){t.interleaved=null;var n=I.next,i=t.pending;if(null!==i){var C=i.next;i.next=n,I.next=C}t.pending=I}yi=null}return e}function rs(e,g){for(;;){var t=Ra;try{if(mi(),aC.current=to,dC){for(var I=rC.memoizedState;null!==I;){var n=I.queue;null!==n&&(n.pending=null),I=I.next}dC=!1}if(lC=0,cC=AC=rC=null,uC=!1,hC=0,va.current=null,null===t||null===t.return){Ya=1,Ka=g,Ra=null;break}e:{var C=e,o=t.return,a=t,s=g;if(g=Va,a.flags|=32768,null!==s&&"object"==typeof s&&"function"==typeof s.then){var l=s,r=a,A=r.tag;if(0==(1&r.mode)&&(0===A||11===A||15===A)){var c=r.alternate;c?(r.updateQueue=c.updateQueue,r.memoizedState=c.memoizedState,r.lanes=c.lanes):(r.updateQueue=null,r.memoizedState=null)}var d=co(o);if(null!==d){d.flags&=-257,uo(d,o,a,0,g),1&d.mode&&Ao(C,l,g),s=l;var u=(g=d).updateQueue;if(null===u){var h=new Set;h.add(s),g.updateQueue=h}else u.add(s);break e}if(0==(1&g)){Ao(C,l,g),cs();break e}s=Error(i(426))}else if(gi&&1&a.mode){var b=co(o);if(null!==b){0==(65536&b.flags)&&(b.flags|=256),uo(b,o,a,0,g),ri(Co(s,a));break e}}C=s=Co(s,a),4!==Ya&&(Ya=2),null===xa?xa=[C]:xa.push(C),C=o;do{switch(C.tag){case 3:C.flags|=65536,g&=-g,C.lanes|=g,Ki(C,lo(0,s,g));break e;case 1:a=s;var m=C.type,p=C.stateNode;if(0==(128&C.flags)&&("function"==typeof m.getDerivedStateFromError||null!==p&&"function"==typeof p.componentDidCatch&&(null===Ta||!Ta.has(p)))){C.flags|=65536,g&=-g,C.lanes|=g,Ki(C,ro(C,a,g));break e}}C=C.return}while(null!==C)}ms(t)}catch(e){g=e,Ra===t&&null!==t&&(Ra=t=t.return);continue}break}}function As(){var e=ya.current;return ya.current=to,null===e?to:e}function cs(){0!==Ya&&3!==Ya&&2!==Ya||(Ya=4),null===wa||0==(268435455&Ha)&&0==(268435455&Na)||is(wa,Va)}function ds(e,g){var t=fa;fa|=2;var I=As();for(wa===e&&Va===g||(La=null,ls(e,g));;)try{us();break}catch(g){rs(e,g)}if(mi(),fa=t,ya.current=I,null!==Ra)throw Error(i(261));return wa=null,Va=0,Ya}function us(){for(;null!==Ra;)bs(Ra)}function hs(){for(;null!==Ra&&!je();)bs(Ra)}function bs(e){var g=Ba(e.alternate,e,Xa);e.memoizedProps=e.pendingProps,null===g?ms(e):Ra=g,va.current=null}function ms(e){var g=e;do{var t=g.alternate;if(e=g.return,0==(32768&g.flags)){if(null!==(t=Uo(t,g,Xa)))return void(Ra=t)}else{if(null!==(t=Qo(t,g)))return t.flags&=32767,void(Ra=t);if(null===e)return Ya=6,void(Ra=null);e.flags|=32768,e.subtreeFlags=0,e.deletions=null}if(null!==(g=g.sibling))return void(Ra=g);Ra=g=e}while(null!==g);0===Ya&&(Ya=5)}function ps(e,g,t){var I=pg,n=Wa.transition;try{Wa.transition=null,pg=1,function(e,g,t,I){do{Gs()}while(null!==Qa);if(0!=(6&fa))throw Error(i(327));t=e.finishedWork;var n=e.finishedLanes;if(null===t)return null;if(e.finishedWork=null,e.finishedLanes=0,t===e.current)throw Error(i(177));e.callbackNode=null,e.callbackPriority=0;var C=t.lanes|t.childLanes;if(function(e,g){var t=e.pendingLanes&~g;e.pendingLanes=g,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=g,e.mutableReadLanes&=g,e.entangledLanes&=g,g=e.entanglements;var I=e.eventTimes;for(e=e.expirationTimes;0<t;){var n=31-Cg(t),i=1<<n;g[n]=0,I[n]=-1,e[n]=-1,t&=~i}}(e,C),e===wa&&(Ra=wa=null,Va=0),0==(2064&t.subtreeFlags)&&0==(2064&t.flags)||Ua||(Ua=!0,ws(gg,(function(){return Gs(),null}))),C=0!=(15990&t.flags),0!=(15990&t.subtreeFlags)||C){C=Wa.transition,Wa.transition=null;var o=pg;pg=1;var a=fa;fa|=4,va.current=null,function(e,g){if(PI=Tg,sI(e=aI())){if("selectionStart"in e)var t={start:e.selectionStart,end:e.selectionEnd};else e:{var I=(t=(t=e.ownerDocument)&&t.defaultView||window).getSelection&&t.getSelection();if(I&&0!==I.rangeCount){t=I.anchorNode;var n=I.anchorOffset,C=I.focusNode;I=I.focusOffset;try{t.nodeType,C.nodeType}catch(e){t=null;break e}var o=0,a=-1,s=-1,l=0,r=0,A=e,c=null;g:for(;;){for(var d;A!==t||0!==n&&3!==A.nodeType||(a=o+n),A!==C||0!==I&&3!==A.nodeType||(s=o+I),3===A.nodeType&&(o+=A.nodeValue.length),null!==(d=A.firstChild);)c=A,A=d;for(;;){if(A===e)break g;if(c===t&&++l===n&&(a=o),c===C&&++r===I&&(s=o),null!==(d=A.nextSibling))break;c=(A=c).parentNode}A=d}t=-1===a||-1===s?null:{start:a,end:s}}else t=null}t=t||{start:0,end:0}}else t=null;for(_I={focusedElem:e,selectionRange:t},Tg=!1,Po=g;null!==Po;)if(e=(g=Po).child,0!=(1028&g.subtreeFlags)&&null!==e)e.return=g,Po=e;else for(;null!==Po;){g=Po;try{var u=g.alternate;if(0!=(1024&g.flags))switch(g.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==u){var h=u.memoizedProps,b=u.memoizedState,m=g.stateNode,p=m.getSnapshotBeforeUpdate(g.elementType===g.type?h:ci(g.type,h),b);m.__reactInternalSnapshotBeforeUpdate=p}break;case 3:var G=g.stateNode.containerInfo;1===G.nodeType?G.textContent="":9===G.nodeType&&G.documentElement&&G.removeChild(G.documentElement);break;default:throw Error(i(163))}}catch(e){Zs(g,g.return,e)}if(null!==(e=g.sibling)){e.return=g.return,Po=e;break}Po=g.return}u=$o,$o=!1}(e,t),da(t,e),lI(_I),Tg=!!PI,_I=PI=null,e.current=t,ha(t,e,n),Pe(),fa=a,pg=o,Wa.transition=C}else e.current=t;if(Ua&&(Ua=!1,Qa=e,Da=n),0===(C=e.pendingLanes)&&(Ta=null),function(e){if(ig&&"function"==typeof ig.onCommitFiberRoot)try{ig.onCommitFiberRoot(ng,e,void 0,128==(128&e.current.flags))}catch(e){}}(t.stateNode),gs(e,_e()),null!==g)for(I=e.onRecoverableError,t=0;t<g.length;t++)I((n=g[t]).value,{componentStack:n.stack,digest:n.digest});if(Ja)throw Ja=!1,e=Ea,Ea=null,e;0!=(1&Da)&&0!==e.tag&&Gs(),0!=(1&(C=e.pendingLanes))?e===ja?Oa++:(Oa=0,ja=e):Oa=0,kn()}(e,g,t,I)}finally{Wa.transition=n,pg=I}return null}function Gs(){if(null!==Qa){var e=Gg(Da),g=Wa.transition,t=pg;try{if(Wa.transition=null,pg=16>e?16:e,null===Qa)var I=!1;else{if(e=Qa,Qa=null,Da=0,0!=(6&fa))throw Error(i(331));var n=fa;for(fa|=4,Po=e.current;null!==Po;){var C=Po,o=C.child;if(0!=(16&Po.flags)){var a=C.deletions;if(null!==a){for(var s=0;s<a.length;s++){var l=a[s];for(Po=l;null!==Po;){var r=Po;switch(r.tag){case 0:case 11:case 15:ea(8,r,C)}var A=r.child;if(null!==A)A.return=r,Po=A;else for(;null!==Po;){var c=(r=Po).sibling,d=r.return;if(Ia(r),r===l){Po=null;break}if(null!==c){c.return=d,Po=c;break}Po=d}}}var u=C.alternate;if(null!==u){var h=u.child;if(null!==h){u.child=null;do{var b=h.sibling;h.sibling=null,h=b}while(null!==h)}}Po=C}}if(0!=(2064&C.subtreeFlags)&&null!==o)o.return=C,Po=o;else e:for(;null!==Po;){if(0!=(2048&(C=Po).flags))switch(C.tag){case 0:case 11:case 15:ea(9,C,C.return)}var m=C.sibling;if(null!==m){m.return=C.return,Po=m;break e}Po=C.return}}var p=e.current;for(Po=p;null!==Po;){var G=(o=Po).child;if(0!=(2064&o.subtreeFlags)&&null!==G)G.return=o,Po=G;else e:for(o=p;null!==Po;){if(0!=(2048&(a=Po).flags))try{switch(a.tag){case 0:case 11:case 15:ga(9,a)}}catch(e){Zs(a,a.return,e)}if(a===o){Po=null;break e}var B=a.sibling;if(null!==B){B.return=a.return,Po=B;break e}Po=a.return}}if(fa=n,kn(),ig&&"function"==typeof ig.onPostCommitFiberRoot)try{ig.onPostCommitFiberRoot(ng,e)}catch(e){}I=!0}return I}finally{pg=t,Wa.transition=g}}return!1}function Bs(e,g,t){e=Si(e,g=lo(0,g=Co(t,g),1),1),g=qa(),null!==e&&(bg(e,1,g),gs(e,g))}function Zs(e,g,t){if(3===e.tag)Bs(e,e,t);else for(;null!==g;){if(3===g.tag){Bs(g,e,t);break}if(1===g.tag){var I=g.stateNode;if("function"==typeof g.type.getDerivedStateFromError||"function"==typeof I.componentDidCatch&&(null===Ta||!Ta.has(I))){g=Si(g,e=ro(g,e=Co(t,e),1),1),e=qa(),null!==g&&(bg(g,1,e),gs(g,e));break}}g=g.return}}function ys(e,g,t){var I=e.pingCache;null!==I&&I.delete(g),g=qa(),e.pingedLanes|=e.suspendedLanes&t,wa===e&&(Va&t)===t&&(4===Ya||3===Ya&&(130023424&Va)===Va&&500>_e()-ka?ls(e,0):Fa|=t),gs(e,g)}function vs(e,g){0===g&&(0==(1&e.mode)?g=1:(g=lg,0==(130023424&(lg<<=1))&&(lg=4194304)));var t=qa();null!==(e=fi(e,g))&&(bg(e,g,t),gs(e,t))}function Ws(e){var g=e.memoizedState,t=0;null!==g&&(t=g.retryLane),vs(e,t)}function fs(e,g){var t=0;switch(e.tag){case 13:var I=e.stateNode,n=e.memoizedState;null!==n&&(t=n.retryLane);break;case 19:I=e.stateNode;break;default:throw Error(i(314))}null!==I&&I.delete(g),vs(e,t)}function ws(e,g){return De(e,g)}function Rs(e,g,t,I){this.tag=e,this.key=t,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=g,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=I,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Vs(e,g,t,I){return new Rs(e,g,t,I)}function Xs(e){return!(!(e=e.prototype)||!e.isReactComponent)}function Ss(e,g){var t=e.alternate;return null===t?((t=Vs(e.tag,g,e.key,e.mode)).elementType=e.elementType,t.type=e.type,t.stateNode=e.stateNode,t.alternate=e,e.alternate=t):(t.pendingProps=g,t.type=e.type,t.flags=0,t.subtreeFlags=0,t.deletions=null),t.flags=14680064&e.flags,t.childLanes=e.childLanes,t.lanes=e.lanes,t.child=e.child,t.memoizedProps=e.memoizedProps,t.memoizedState=e.memoizedState,t.updateQueue=e.updateQueue,g=e.dependencies,t.dependencies=null===g?null:{lanes:g.lanes,firstContext:g.firstContext},t.sibling=e.sibling,t.index=e.index,t.ref=e.ref,t}function Ys(e,g,t,I,n,C){var o=2;if(I=e,"function"==typeof e)Xs(e)&&(o=1);else if("string"==typeof e)o=5;else e:switch(e){case y:return Ks(t.children,n,C,g);case v:o=8,n|=8;break;case W:return(e=Vs(12,t,g,2|n)).elementType=W,e.lanes=C,e;case V:return(e=Vs(13,t,g,n)).elementType=V,e.lanes=C,e;case X:return(e=Vs(19,t,g,n)).elementType=X,e.lanes=C,e;case K:return Hs(t,n,C,g);default:if("object"==typeof e&&null!==e)switch(e.$$typeof){case f:o=10;break e;case w:o=9;break e;case R:o=11;break e;case S:o=14;break e;case Y:o=16,I=null;break e}throw Error(i(130,null==e?e:typeof e,""))}return(g=Vs(o,t,g,n)).elementType=e,g.type=I,g.lanes=C,g}function Ks(e,g,t,I){return(e=Vs(7,e,I,g)).lanes=t,e}function Hs(e,g,t,I){return(e=Vs(22,e,I,g)).elementType=K,e.lanes=t,e.stateNode={isHidden:!1},e}function Ns(e,g,t){return(e=Vs(6,e,null,g)).lanes=t,e}function Fs(e,g,t){return(g=Vs(4,null!==e.children?e.children:[],e.key,g)).lanes=t,g.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},g}function xs(e,g,t,I,n){this.tag=g,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=hg(0),this.expirationTimes=hg(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=hg(0),this.identifierPrefix=I,this.onRecoverableError=n,this.mutableSourceEagerHydrationData=null}function zs(e,g,t,I,n,i,C,o,a){return e=new xs(e,g,t,o,a),1===g?(g=1,!0===i&&(g|=8)):g=0,i=Vs(3,null,null,g),e.current=i,i.stateNode=e,i.memoizedState={element:I,isDehydrated:t,cache:null,transitions:null,pendingSuspenseBoundaries:null},Ri(i),e}function ks(e){if(!e)return vn;e:{if(Je(e=e._reactInternals)!==e||1!==e.tag)throw Error(i(170));var g=e;do{switch(g.tag){case 3:g=g.stateNode.context;break e;case 1:if(Vn(g.type)){g=g.stateNode.__reactInternalMemoizedMergedChildContext;break e}}g=g.return}while(null!==g);throw Error(i(171))}if(1===e.tag){var t=e.type;if(Vn(t))return Yn(e,t,g)}return g}function Ms(e,g,t,I,n,i,C,o,a){return(e=zs(t,I,!0,e,0,i,0,o,a)).context=ks(null),t=e.current,(i=Xi(I=qa(),n=$a(t))).callback=null!=g?g:null,Si(t,i,n),e.current.lanes=n,bg(e,n,I),gs(e,I),e}function Ls(e,g,t,I){var n=g.current,i=qa(),C=$a(n);return t=ks(t),null===g.context?g.context=t:g.pendingContext=t,(g=Xi(i,C)).payload={element:e},null!==(I=void 0===I?null:I)&&(g.callback=I),null!==(e=Si(n,g,C))&&(es(e,n,C,i),Yi(e,n,C)),C}function Js(e){return(e=e.current).child?(e.child.tag,e.child.stateNode):null}function Es(e,g){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var t=e.retryLane;e.retryLane=0!==t&&t<g?t:g}}function Ts(e,g){Es(e,g),(e=e.alternate)&&Es(e,g)}Ba=function(e,g,t){if(null!==e)if(e.memoizedProps!==g.pendingProps||fn.current)bo=!0;else{if(0==(e.lanes&t)&&0==(128&g.flags))return bo=!1,function(e,g,t){switch(g.tag){case 3:wo(g),li();break;case 5:tC(g);break;case 1:Vn(g.type)&&Kn(g);break;case 4:eC(g,g.stateNode.containerInfo);break;case 10:var I=g.type._context,n=g.memoizedProps.value;yn(di,I._currentValue),I._currentValue=n;break;case 13:if(null!==(I=g.memoizedState))return null!==I.dehydrated?(yn(nC,1&nC.current),g.flags|=128,null):0!=(t&g.child.childLanes)?No(e,g,t):(yn(nC,1&nC.current),null!==(e=Jo(e,g,t))?e.sibling:null);yn(nC,1&nC.current);break;case 19:if(I=0!=(t&g.childLanes),0!=(128&e.flags)){if(I)return Mo(e,g,t);g.flags|=128}if(null!==(n=g.memoizedState)&&(n.rendering=null,n.tail=null,n.lastEffect=null),yn(nC,nC.current),I)break;return null;case 22:case 23:return g.lanes=0,Zo(e,g,t)}return Jo(e,g,t)}(e,g,t);bo=0!=(131072&e.flags)}else bo=!1,gi&&0!=(1048576&g.flags)&&Pn(g,En,g.index);switch(g.lanes=0,g.tag){case 2:var I=g.type;Lo(e,g),e=g.pendingProps;var n=Rn(g,Wn.current);Bi(g,t),n=GC(null,g,I,e,n,t);var C=BC();return g.flags|=1,"object"==typeof n&&null!==n&&"function"==typeof n.render&&void 0===n.$$typeof?(g.tag=1,g.memoizedState=null,g.updateQueue=null,Vn(I)?(C=!0,Kn(g)):C=!1,g.memoizedState=null!==n.state&&void 0!==n.state?n.state:null,Ri(g),n.updater=zi,g.stateNode=n,n._reactInternals=g,Ji(g,I,e,t),g=fo(null,g,I,!0,C,t)):(g.tag=0,gi&&C&&_n(g),mo(null,g,n,t),g=g.child),g;case 16:I=g.elementType;e:{switch(Lo(e,g),e=g.pendingProps,I=(n=I._init)(I._payload),g.type=I,n=g.tag=function(e){if("function"==typeof e)return Xs(e)?1:0;if(null!=e){if((e=e.$$typeof)===R)return 11;if(e===S)return 14}return 2}(I),e=ci(I,e),n){case 0:g=vo(null,g,I,e,t);break e;case 1:g=Wo(null,g,I,e,t);break e;case 11:g=po(null,g,I,e,t);break e;case 14:g=Go(null,g,I,ci(I.type,e),t);break e}throw Error(i(306,I,""))}return g;case 0:return I=g.type,n=g.pendingProps,vo(e,g,I,n=g.elementType===I?n:ci(I,n),t);case 1:return I=g.type,n=g.pendingProps,Wo(e,g,I,n=g.elementType===I?n:ci(I,n),t);case 3:e:{if(wo(g),null===e)throw Error(i(387));I=g.pendingProps,n=(C=g.memoizedState).element,Vi(e,g),Hi(g,I,null,t);var o=g.memoizedState;if(I=o.element,C.isDehydrated){if(C={element:I,isDehydrated:!1,cache:o.cache,pendingSuspenseBoundaries:o.pendingSuspenseBoundaries,transitions:o.transitions},g.updateQueue.baseState=C,g.memoizedState=C,256&g.flags){g=Ro(e,g,I,t,n=Co(Error(i(423)),g));break e}if(I!==n){g=Ro(e,g,I,t,n=Co(Error(i(424)),g));break e}for(ei=Cn(g.stateNode.containerInfo.firstChild),$n=g,gi=!0,ti=null,t=Oi(g,null,I,t),g.child=t;t;)t.flags=-3&t.flags|4096,t=t.sibling}else{if(li(),I===n){g=Jo(e,g,t);break e}mo(e,g,I,t)}g=g.child}return g;case 5:return tC(g),null===e&&Ci(g),I=g.type,n=g.pendingProps,C=null!==e?e.memoizedProps:null,o=n.children,qI(I,n)?o=null:null!==C&&qI(I,C)&&(g.flags|=32),yo(e,g),mo(e,g,o,t),g.child;case 6:return null===e&&Ci(g),null;case 13:return No(e,g,t);case 4:return eC(g,g.stateNode.containerInfo),I=g.pendingProps,null===e?g.child=Di(g,null,I,t):mo(e,g,I,t),g.child;case 11:return I=g.type,n=g.pendingProps,po(e,g,I,n=g.elementType===I?n:ci(I,n),t);case 7:return mo(e,g,g.pendingProps,t),g.child;case 8:case 12:return mo(e,g,g.pendingProps.children,t),g.child;case 10:e:{if(I=g.type._context,n=g.pendingProps,C=g.memoizedProps,o=n.value,yn(di,I._currentValue),I._currentValue=o,null!==C)if(II(C.value,o)){if(C.children===n.children&&!fn.current){g=Jo(e,g,t);break e}}else for(null!==(C=g.child)&&(C.return=g);null!==C;){var a=C.dependencies;if(null!==a){o=C.child;for(var s=a.firstContext;null!==s;){if(s.context===I){if(1===C.tag){(s=Xi(-1,t&-t)).tag=2;var l=C.updateQueue;if(null!==l){var r=(l=l.shared).pending;null===r?s.next=s:(s.next=r.next,r.next=s),l.pending=s}}C.lanes|=t,null!==(s=C.alternate)&&(s.lanes|=t),Gi(C.return,t,g),a.lanes|=t;break}s=s.next}}else if(10===C.tag)o=C.type===g.type?null:C.child;else if(18===C.tag){if(null===(o=C.return))throw Error(i(341));o.lanes|=t,null!==(a=o.alternate)&&(a.lanes|=t),Gi(o,t,g),o=C.sibling}else o=C.child;if(null!==o)o.return=C;else for(o=C;null!==o;){if(o===g){o=null;break}if(null!==(C=o.sibling)){C.return=o.return,o=C;break}o=o.return}C=o}mo(e,g,n.children,t),g=g.child}return g;case 9:return n=g.type,I=g.pendingProps.children,Bi(g,t),I=I(n=Zi(n)),g.flags|=1,mo(e,g,I,t),g.child;case 14:return n=ci(I=g.type,g.pendingProps),Go(e,g,I,n=ci(I.type,n),t);case 15:return Bo(e,g,g.type,g.pendingProps,t);case 17:return I=g.type,n=g.pendingProps,n=g.elementType===I?n:ci(I,n),Lo(e,g),g.tag=1,Vn(I)?(e=!0,Kn(g)):e=!1,Bi(g,t),Mi(g,I,n),Ji(g,I,n,t),fo(null,g,I,!0,e,t);case 19:return Mo(e,g,t);case 22:return Zo(e,g,t)}throw Error(i(156,g.tag))};var Us="function"==typeof reportError?reportError:function(e){console.error(e)};function Qs(e){this._internalRoot=e}function Ds(e){this._internalRoot=e}function Os(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType)}function js(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}function Ps(){}function _s(e,g,t,I,n){var i=t._reactRootContainer;if(i){var C=i;if("function"==typeof n){var o=n;n=function(){var e=Js(C);o.call(e)}}Ls(g,C,e,n)}else C=function(e,g,t,I,n){if(n){if("function"==typeof I){var i=I;I=function(){var e=Js(C);i.call(e)}}var C=Ms(g,I,e,0,null,!1,0,"",Ps);return e._reactRootContainer=C,e[rn]=C.current,zI(8===e.nodeType?e.parentNode:e),as(),C}for(;n=e.lastChild;)e.removeChild(n);if("function"==typeof I){var o=I;I=function(){var e=Js(a);o.call(e)}}var a=zs(e,0,!1,null,0,!1,0,"",Ps);return e._reactRootContainer=a,e[rn]=a.current,zI(8===e.nodeType?e.parentNode:e),as((function(){Ls(g,a,t,I)})),a}(t,g,e,n,I);return Js(C)}Ds.prototype.render=Qs.prototype.render=function(e){var g=this._internalRoot;if(null===g)throw Error(i(409));Ls(e,g,null,null)},Ds.prototype.unmount=Qs.prototype.unmount=function(){var e=this._internalRoot;if(null!==e){this._internalRoot=null;var g=e.containerInfo;as((function(){Ls(null,e,null,null)})),g[rn]=null}},Ds.prototype.unstable_scheduleHydration=function(e){if(e){var g=vg();e={blockedOn:null,target:e,priority:g};for(var t=0;t<Kg.length&&0!==g&&g<Kg[t].priority;t++);Kg.splice(t,0,e),0===t&&xg(e)}},Bg=function(e){switch(e.tag){case 3:var g=e.stateNode;if(g.current.memoizedState.isDehydrated){var t=rg(g.pendingLanes);0!==t&&(mg(g,1|t),gs(g,_e()),0==(6&fa)&&(Ma=_e()+500,kn()))}break;case 13:as((function(){var g=fi(e,1);if(null!==g){var t=qa();es(g,e,1,t)}})),Ts(e,1)}},Zg=function(e){if(13===e.tag){var g=fi(e,134217728);null!==g&&es(g,e,134217728,qa()),Ts(e,134217728)}},yg=function(e){if(13===e.tag){var g=$a(e),t=fi(e,g);null!==t&&es(t,e,g,qa()),Ts(e,g)}},vg=function(){return pg},Wg=function(e,g){var t=pg;try{return pg=e,g()}finally{pg=t}},Ze=function(e,g,t){switch(g){case"input":if(q(e,t),g=t.name,"radio"===t.type&&null!=g){for(t=e;t.parentNode;)t=t.parentNode;for(t=t.querySelectorAll("input[name="+JSON.stringify(""+g)+'][type="radio"]'),g=0;g<t.length;g++){var I=t[g];if(I!==e&&I.form===e.form){var n=mn(I);if(!n)throw Error(i(90));D(I),q(I,n)}}}break;case"textarea":ie(e,t);break;case"select":null!=(g=t.value)&&te(e,!!t.multiple,g,!1)}},Re=os,Ve=as;var qs={usingClientEntryPoint:!1,Events:[hn,bn,mn,fe,we,os]},$s={findFiberByHostInstance:un,bundleType:0,version:"18.2.0",rendererPackageName:"react-dom"},el={bundleType:$s.bundleType,version:$s.version,rendererPackageName:$s.rendererPackageName,rendererConfig:$s.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:G.ReactCurrentDispatcher,findHostInstanceByFiber:function(e){return null===(e=Ue(e))?null:e.stateNode},findFiberByHostInstance:$s.findFiberByHostInstance||function(){return null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.2.0-next-9e3b772b8-20220608"};if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var gl=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!gl.isDisabled&&gl.supportsFiber)try{ng=gl.inject(el),ig=gl}catch(le){}}g.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=qs,g.createPortal=function(e,g){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!Os(g))throw Error(i(200));return function(e,g,t){var I=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:Z,key:null==I?null:""+I,children:e,containerInfo:g,implementation:t}}(e,g,null,t)},g.createRoot=function(e,g){if(!Os(e))throw Error(i(299));var t=!1,I="",n=Us;return null!=g&&(!0===g.unstable_strictMode&&(t=!0),void 0!==g.identifierPrefix&&(I=g.identifierPrefix),void 0!==g.onRecoverableError&&(n=g.onRecoverableError)),g=zs(e,1,!1,null,0,t,0,I,n),e[rn]=g.current,zI(8===e.nodeType?e.parentNode:e),new Qs(g)},g.findDOMNode=function(e){if(null==e)return null;if(1===e.nodeType)return e;var g=e._reactInternals;if(void 0===g){if("function"==typeof e.render)throw Error(i(188));throw e=Object.keys(e).join(","),Error(i(268,e))}return null===(e=Ue(g))?null:e.stateNode},g.flushSync=function(e){return as(e)},g.hydrate=function(e,g,t){if(!js(g))throw Error(i(200));return _s(null,e,g,!0,t)},g.hydrateRoot=function(e,g,t){if(!Os(e))throw Error(i(405));var I=null!=t&&t.hydratedSources||null,n=!1,C="",o=Us;if(null!=t&&(!0===t.unstable_strictMode&&(n=!0),void 0!==t.identifierPrefix&&(C=t.identifierPrefix),void 0!==t.onRecoverableError&&(o=t.onRecoverableError)),g=Ms(g,null,e,1,null!=t?t:null,n,0,C,o),e[rn]=g.current,zI(e),I)for(e=0;e<I.length;e++)n=(n=(t=I[e])._getVersion)(t._source),null==g.mutableSourceEagerHydrationData?g.mutableSourceEagerHydrationData=[t,n]:g.mutableSourceEagerHydrationData.push(t,n);return new Ds(g)},g.render=function(e,g,t){if(!js(g))throw Error(i(200));return _s(null,e,g,!1,t)},g.unmountComponentAtNode=function(e){if(!js(e))throw Error(i(40));return!!e._reactRootContainer&&(as((function(){_s(null,null,e,!1,(function(){e._reactRootContainer=null,e[rn]=null}))})),!0)},g.unstable_batchedUpdates=os,g.unstable_renderSubtreeIntoContainer=function(e,g,t,I){if(!js(t))throw Error(i(200));if(null==e||void 0===e._reactInternals)throw Error(i(38));return _s(e,g,t,!1,I)},g.version="18.2.0-next-9e3b772b8-20220608"},745:(e,g,t)=>{"use strict";var I=t(935);g.s=I.createRoot,I.hydrateRoot},935:(e,g,t)=>{"use strict";!function e(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(e){console.error(e)}}(),e.exports=t(448)},203:(e,g)=>{"use strict";function t(e,g){var t=e.length;e.push(g);e:for(;0<t;){var I=t-1>>>1,n=e[I];if(!(0<i(n,g)))break e;e[I]=g,e[t]=n,t=I}}function I(e){return 0===e.length?null:e[0]}function n(e){if(0===e.length)return null;var g=e[0],t=e.pop();if(t!==g){e[0]=t;e:for(var I=0,n=e.length,C=n>>>1;I<C;){var o=2*(I+1)-1,a=e[o],s=o+1,l=e[s];if(0>i(a,t))s<n&&0>i(l,a)?(e[I]=l,e[s]=t,I=s):(e[I]=a,e[o]=t,I=o);else{if(!(s<n&&0>i(l,t)))break e;e[I]=l,e[s]=t,I=s}}}return g}function i(e,g){var t=e.sortIndex-g.sortIndex;return 0!==t?t:e.id-g.id}if("object"==typeof performance&&"function"==typeof performance.now){var C=performance;g.unstable_now=function(){return C.now()}}else{var o=Date,a=o.now();g.unstable_now=function(){return o.now()-a}}var s=[],l=[],r=1,A=null,c=3,d=!1,u=!1,h=!1,b="function"==typeof setTimeout?setTimeout:null,m="function"==typeof clearTimeout?clearTimeout:null,p="undefined"!=typeof setImmediate?setImmediate:null;function G(e){for(var g=I(l);null!==g;){if(null===g.callback)n(l);else{if(!(g.startTime<=e))break;n(l),g.sortIndex=g.expirationTime,t(s,g)}g=I(l)}}function B(e){if(h=!1,G(e),!u)if(null!==I(s))u=!0,K(Z);else{var g=I(l);null!==g&&H(B,g.startTime-e)}}function Z(e,t){u=!1,h&&(h=!1,m(f),f=-1),d=!0;var i=c;try{for(G(t),A=I(s);null!==A&&(!(A.expirationTime>t)||e&&!V());){var C=A.callback;if("function"==typeof C){A.callback=null,c=A.priorityLevel;var o=C(A.expirationTime<=t);t=g.unstable_now(),"function"==typeof o?A.callback=o:A===I(s)&&n(s),G(t)}else n(s);A=I(s)}if(null!==A)var a=!0;else{var r=I(l);null!==r&&H(B,r.startTime-t),a=!1}return a}finally{A=null,c=i,d=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var y,v=!1,W=null,f=-1,w=5,R=-1;function V(){return!(g.unstable_now()-R<w)}function X(){if(null!==W){var e=g.unstable_now();R=e;var t=!0;try{t=W(!0,e)}finally{t?y():(v=!1,W=null)}}else v=!1}if("function"==typeof p)y=function(){p(X)};else if("undefined"!=typeof MessageChannel){var S=new MessageChannel,Y=S.port2;S.port1.onmessage=X,y=function(){Y.postMessage(null)}}else y=function(){b(X,0)};function K(e){W=e,v||(v=!0,y())}function H(e,t){f=b((function(){e(g.unstable_now())}),t)}g.unstable_IdlePriority=5,g.unstable_ImmediatePriority=1,g.unstable_LowPriority=4,g.unstable_NormalPriority=3,g.unstable_Profiling=null,g.unstable_UserBlockingPriority=2,g.unstable_cancelCallback=function(e){e.callback=null},g.unstable_continueExecution=function(){u||d||(u=!0,K(Z))},g.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):w=0<e?Math.floor(1e3/e):5},g.unstable_getCurrentPriorityLevel=function(){return c},g.unstable_getFirstCallbackNode=function(){return I(s)},g.unstable_next=function(e){switch(c){case 1:case 2:case 3:var g=3;break;default:g=c}var t=c;c=g;try{return e()}finally{c=t}},g.unstable_pauseExecution=function(){},g.unstable_requestPaint=function(){},g.unstable_runWithPriority=function(e,g){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var t=c;c=e;try{return g()}finally{c=t}},g.unstable_scheduleCallback=function(e,n,i){var C=g.unstable_now();switch(i="object"==typeof i&&null!==i&&"number"==typeof(i=i.delay)&&0<i?C+i:C,e){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return e={id:r++,callback:n,priorityLevel:e,startTime:i,expirationTime:o=i+o,sortIndex:-1},i>C?(e.sortIndex=i,t(l,e),null===I(s)&&e===I(l)&&(h?(m(f),f=-1):h=!0,H(B,i-C))):(e.sortIndex=o,t(s,e),u||d||(u=!0,K(Z))),e},g.unstable_shouldYield=V,g.unstable_wrapCallback=function(e){var g=c;return function(){var t=c;c=g;try{return e.apply(this,arguments)}finally{c=t}}}},142:(e,g,t)=>{"use strict";e.exports=t(203)},511:(e,g)=>{"use strict";g.ConcurrentRoot=1,g.ContinuousEventPriority=4,g.DefaultEventPriority=16,g.DiscreteEventPriority=1},287:(e,g,t)=>{e.exports=function(e){var g={},I=t(294),n=t(840),i=Object.assign;function C(e){for(var g="https://reactjs.org/docs/error-decoder.html?invariant="+e,t=1;t<arguments.length;t++)g+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+e+"; visit "+g+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var o=I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,a=Symbol.for("react.element"),s=Symbol.for("react.portal"),l=Symbol.for("react.fragment"),r=Symbol.for("react.strict_mode"),A=Symbol.for("react.profiler"),c=Symbol.for("react.provider"),d=Symbol.for("react.context"),u=Symbol.for("react.forward_ref"),h=Symbol.for("react.suspense"),b=Symbol.for("react.suspense_list"),m=Symbol.for("react.memo"),p=Symbol.for("react.lazy");Symbol.for("react.scope"),Symbol.for("react.debug_trace_mode");var G=Symbol.for("react.offscreen");Symbol.for("react.legacy_hidden"),Symbol.for("react.cache"),Symbol.for("react.tracing_marker");var B=Symbol.iterator;function Z(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=B&&e[B]||e["@@iterator"])?e:null}function y(e){if(null==e)return null;if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case l:return"Fragment";case s:return"Portal";case A:return"Profiler";case r:return"StrictMode";case h:return"Suspense";case b:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case d:return(e.displayName||"Context")+".Consumer";case c:return(e._context.displayName||"Context")+".Provider";case u:var g=e.render;return(e=e.displayName)||(e=""!==(e=g.displayName||g.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case m:return null!==(g=e.displayName||null)?g:y(e.type)||"Memo";case p:g=e._payload,e=e._init;try{return y(e(g))}catch(e){}}return null}function v(e){var g=e.type;switch(e.tag){case 24:return"Cache";case 9:return(g.displayName||"Context")+".Consumer";case 10:return(g._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=(e=g.render).displayName||e.name||"",g.displayName||(""!==e?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return g;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return y(g);case 8:return g===r?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"==typeof g)return g.displayName||g.name||null;if("string"==typeof g)return g}return null}function W(e){var g=e,t=e;if(e.alternate)for(;g.return;)g=g.return;else{e=g;do{0!=(4098&(g=e).flags)&&(t=g.return),e=g.return}while(e)}return 3===g.tag?t:null}function f(e){if(W(e)!==e)throw Error(C(188))}function w(e){var g=e.alternate;if(!g){if(null===(g=W(e)))throw Error(C(188));return g!==e?null:e}for(var t=e,I=g;;){var n=t.return;if(null===n)break;var i=n.alternate;if(null===i){if(null!==(I=n.return)){t=I;continue}break}if(n.child===i.child){for(i=n.child;i;){if(i===t)return f(n),e;if(i===I)return f(n),g;i=i.sibling}throw Error(C(188))}if(t.return!==I.return)t=n,I=i;else{for(var o=!1,a=n.child;a;){if(a===t){o=!0,t=n,I=i;break}if(a===I){o=!0,I=n,t=i;break}a=a.sibling}if(!o){for(a=i.child;a;){if(a===t){o=!0,t=i,I=n;break}if(a===I){o=!0,I=i,t=n;break}a=a.sibling}if(!o)throw Error(C(189))}}if(t.alternate!==I)throw Error(C(190))}if(3!==t.tag)throw Error(C(188));return t.stateNode.current===t?e:g}function R(e){return null!==(e=w(e))?V(e):null}function V(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){var g=V(e);if(null!==g)return g;e=e.sibling}return null}function X(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){if(4!==e.tag){var g=X(e);if(null!==g)return g}e=e.sibling}return null}var S,Y=Array.isArray,K=e.getPublicInstance,H=e.getRootHostContext,N=e.getChildHostContext,F=e.prepareForCommit,x=e.resetAfterCommit,z=e.createInstance,k=e.appendInitialChild,M=e.finalizeInitialChildren,L=e.prepareUpdate,J=e.shouldSetTextContent,E=e.createTextInstance,T=e.scheduleTimeout,U=e.cancelTimeout,Q=e.noTimeout,D=e.isPrimaryRenderer,O=e.supportsMutation,j=e.supportsPersistence,P=e.supportsHydration,_=e.getInstanceFromNode,q=e.preparePortalMount,$=e.getCurrentEventPriority,ee=e.detachDeletedInstance,ge=e.supportsMicrotasks,te=e.scheduleMicrotask,Ie=e.supportsTestSelectors,ne=e.findFiberRoot,ie=e.getBoundingRect,Ce=e.getTextContent,oe=e.isHiddenSubtree,ae=e.matchAccessibilityRole,se=e.setFocusIfFocusable,le=e.setupIntersectionObserver,re=e.appendChild,Ae=e.appendChildToContainer,ce=e.commitTextUpdate,de=e.commitMount,ue=e.commitUpdate,he=e.insertBefore,be=e.insertInContainerBefore,me=e.removeChild,pe=e.removeChildFromContainer,Ge=e.resetTextContent,Be=e.hideInstance,Ze=e.hideTextInstance,ye=e.unhideInstance,ve=e.unhideTextInstance,We=e.clearContainer,fe=e.cloneInstance,we=e.createContainerChildSet,Re=e.appendChildToContainerChildSet,Ve=e.finalizeContainerChildren,Xe=e.replaceContainerChildren,Se=e.cloneHiddenInstance,Ye=e.cloneHiddenTextInstance,Ke=e.canHydrateInstance,He=e.canHydrateTextInstance,Ne=e.canHydrateSuspenseInstance,Fe=e.isSuspenseInstancePending,xe=e.isSuspenseInstanceFallback,ze=e.registerSuspenseInstanceRetry,ke=e.getNextHydratableSibling,Me=e.getFirstHydratableChild,Le=e.getFirstHydratableChildWithinContainer,Je=e.getFirstHydratableChildWithinSuspenseInstance,Ee=e.hydrateInstance,Te=e.hydrateTextInstance,Ue=e.hydrateSuspenseInstance,Qe=e.getNextHydratableInstanceAfterSuspenseInstance,De=e.commitHydratedContainer,Oe=e.commitHydratedSuspenseInstance,je=e.clearSuspenseBoundary,Pe=e.clearSuspenseBoundaryFromContainer,_e=e.shouldDeleteUnhydratedTailInstances,qe=e.didNotMatchHydratedContainerTextInstance,$e=e.didNotMatchHydratedTextInstance;function eg(e){if(void 0===S)try{throw Error()}catch(e){var g=e.stack.trim().match(/\n( *(at )?)/);S=g&&g[1]||""}return"\n"+S+e}var gg=!1;function tg(e,g){if(!e||gg)return"";gg=!0;var t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(g)if(g=function(){throw Error()},Object.defineProperty(g.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(g,[])}catch(e){var I=e}Reflect.construct(e,[],g)}else{try{g.call()}catch(e){I=e}e.call(g.prototype)}else{try{throw Error()}catch(e){I=e}e()}}catch(g){if(g&&I&&"string"==typeof g.stack){for(var n=g.stack.split("\n"),i=I.stack.split("\n"),C=n.length-1,o=i.length-1;1<=C&&0<=o&&n[C]!==i[o];)o--;for(;1<=C&&0<=o;C--,o--)if(n[C]!==i[o]){if(1!==C||1!==o)do{if(C--,0>--o||n[C]!==i[o]){var a="\n"+n[C].replace(" at new "," at ");return e.displayName&&a.includes("<anonymous>")&&(a=a.replace("<anonymous>",e.displayName)),a}}while(1<=C&&0<=o);break}}}finally{gg=!1,Error.prepareStackTrace=t}return(e=e?e.displayName||e.name:"")?eg(e):""}var Ig=Object.prototype.hasOwnProperty,ng=[],ig=-1;function Cg(e){return{current:e}}function og(e){0>ig||(e.current=ng[ig],ng[ig]=null,ig--)}function ag(e,g){ig++,ng[ig]=e.current,e.current=g}var sg={},lg=Cg(sg),rg=Cg(!1),Ag=sg;function cg(e,g){var t=e.type.contextTypes;if(!t)return sg;var I=e.stateNode;if(I&&I.__reactInternalMemoizedUnmaskedChildContext===g)return I.__reactInternalMemoizedMaskedChildContext;var n,i={};for(n in t)i[n]=g[n];return I&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=g,e.__reactInternalMemoizedMaskedChildContext=i),i}function dg(e){return null!=e.childContextTypes}function ug(){og(rg),og(lg)}function hg(e,g,t){if(lg.current!==sg)throw Error(C(168));ag(lg,g),ag(rg,t)}function bg(e,g,t){var I=e.stateNode;if(g=g.childContextTypes,"function"!=typeof I.getChildContext)return t;for(var n in I=I.getChildContext())if(!(n in g))throw Error(C(108,v(e)||"Unknown",n));return i({},t,I)}function mg(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||sg,Ag=lg.current,ag(lg,e),ag(rg,rg.current),!0}function pg(e,g,t){var I=e.stateNode;if(!I)throw Error(C(169));t?(e=bg(e,g,Ag),I.__reactInternalMemoizedMergedChildContext=e,og(rg),og(lg),ag(lg,e)):og(rg),ag(rg,t)}var Gg=Math.clz32?Math.clz32:function(e){return 0==(e>>>=0)?32:31-(Bg(e)/Zg|0)|0},Bg=Math.log,Zg=Math.LN2,yg=64,vg=4194304;function Wg(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&e;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&e;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function fg(e,g){var t=e.pendingLanes;if(0===t)return 0;var I=0,n=e.suspendedLanes,i=e.pingedLanes,C=268435455&t;if(0!==C){var o=C&~n;0!==o?I=Wg(o):0!=(i&=C)&&(I=Wg(i))}else 0!=(C=t&~n)?I=Wg(C):0!==i&&(I=Wg(i));if(0===I)return 0;if(0!==g&&g!==I&&0==(g&n)&&((n=I&-I)>=(i=g&-g)||16===n&&0!=(4194240&i)))return g;if(0!=(4&I)&&(I|=16&t),0!==(g=e.entangledLanes))for(e=e.entanglements,g&=I;0<g;)n=1<<(t=31-Gg(g)),I|=e[t],g&=~n;return I}function wg(e,g){switch(e){case 1:case 2:case 4:return g+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return g+5e3;default:return-1}}function Rg(e){return 0!=(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function Vg(e){for(var g=[],t=0;31>t;t++)g.push(e);return g}function Xg(e,g,t){e.pendingLanes|=g,536870912!==g&&(e.suspendedLanes=0,e.pingedLanes=0),(e=e.eventTimes)[g=31-Gg(g)]=t}function Sg(e,g){var t=e.entangledLanes|=g;for(e=e.entanglements;t;){var I=31-Gg(t),n=1<<I;n&g|e[I]&g&&(e[I]|=g),t&=~n}}var Yg=0;function Kg(e){return 1<(e&=-e)?4<e?0!=(268435455&e)?16:536870912:4:1}var Hg=n.unstable_scheduleCallback,Ng=n.unstable_cancelCallback,Fg=n.unstable_shouldYield,xg=n.unstable_requestPaint,zg=n.unstable_now,kg=n.unstable_ImmediatePriority,Mg=n.unstable_UserBlockingPriority,Lg=n.unstable_NormalPriority,Jg=n.unstable_IdlePriority,Eg=null,Tg=null,Ug="function"==typeof Object.is?Object.is:function(e,g){return e===g&&(0!==e||1/e==1/g)||e!=e&&g!=g},Qg=null,Dg=!1,Og=!1;function jg(e){null===Qg?Qg=[e]:Qg.push(e)}function Pg(){if(!Og&&null!==Qg){Og=!0;var e=0,g=Yg;try{var t=Qg;for(Yg=1;e<t.length;e++){var I=t[e];do{I=I(!0)}while(null!==I)}Qg=null,Dg=!1}catch(g){throw null!==Qg&&(Qg=Qg.slice(e+1)),Hg(kg,Pg),g}finally{Yg=g,Og=!1}}return null}var _g=o.ReactCurrentBatchConfig;function qg(e,g){if(Ug(e,g))return!0;if("object"!=typeof e||null===e||"object"!=typeof g||null===g)return!1;var t=Object.keys(e),I=Object.keys(g);if(t.length!==I.length)return!1;for(I=0;I<t.length;I++){var n=t[I];if(!Ig.call(g,n)||!Ug(e[n],g[n]))return!1}return!0}function $g(e){switch(e.tag){case 5:return eg(e.type);case 16:return eg("Lazy");case 13:return eg("Suspense");case 19:return eg("SuspenseList");case 0:case 2:case 15:return tg(e.type,!1);case 11:return tg(e.type.render,!1);case 1:return tg(e.type,!0);default:return""}}function et(e,g){if(e&&e.defaultProps){for(var t in g=i({},g),e=e.defaultProps)void 0===g[t]&&(g[t]=e[t]);return g}return g}var gt=Cg(null),tt=null,It=null,nt=null;function it(){nt=It=tt=null}function Ct(e,g,t){D?(ag(gt,g._currentValue),g._currentValue=t):(ag(gt,g._currentValue2),g._currentValue2=t)}function ot(e){var g=gt.current;og(gt),D?e._currentValue=g:e._currentValue2=g}function at(e,g,t){for(;null!==e;){var I=e.alternate;if((e.childLanes&g)!==g?(e.childLanes|=g,null!==I&&(I.childLanes|=g)):null!==I&&(I.childLanes&g)!==g&&(I.childLanes|=g),e===t)break;e=e.return}}function st(e,g){tt=e,nt=It=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(0!=(e.lanes&g)&&(Fn=!0),e.firstContext=null)}function lt(e){var g=D?e._currentValue:e._currentValue2;if(nt!==e)if(e={context:e,memoizedValue:g,next:null},null===It){if(null===tt)throw Error(C(308));It=e,tt.dependencies={lanes:0,firstContext:e}}else It=It.next=e;return g}var rt=null,At=!1;function ct(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function dt(e,g){e=e.updateQueue,g.updateQueue===e&&(g.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function ut(e,g){return{eventTime:e,lane:g,tag:0,payload:null,callback:null,next:null}}function ht(e,g){var t=e.updateQueue;null!==t&&(t=t.shared,null!==Oi&&0!=(1&e.mode)&&0==(2&Di)?(null===(e=t.interleaved)?(g.next=g,null===rt?rt=[t]:rt.push(t)):(g.next=e.next,e.next=g),t.interleaved=g):(null===(e=t.pending)?g.next=g:(g.next=e.next,e.next=g),t.pending=g))}function bt(e,g,t){if(null!==(g=g.updateQueue)&&(g=g.shared,0!=(4194240&t))){var I=g.lanes;t|=I&=e.pendingLanes,g.lanes=t,Sg(e,t)}}function mt(e,g){var t=e.updateQueue,I=e.alternate;if(null!==I&&t===(I=I.updateQueue)){var n=null,i=null;if(null!==(t=t.firstBaseUpdate)){do{var C={eventTime:t.eventTime,lane:t.lane,tag:t.tag,payload:t.payload,callback:t.callback,next:null};null===i?n=i=C:i=i.next=C,t=t.next}while(null!==t);null===i?n=i=g:i=i.next=g}else n=i=g;return t={baseState:I.baseState,firstBaseUpdate:n,lastBaseUpdate:i,shared:I.shared,effects:I.effects},void(e.updateQueue=t)}null===(e=t.lastBaseUpdate)?t.firstBaseUpdate=g:e.next=g,t.lastBaseUpdate=g}function pt(e,g,t,I){var n=e.updateQueue;At=!1;var C=n.firstBaseUpdate,o=n.lastBaseUpdate,a=n.shared.pending;if(null!==a){n.shared.pending=null;var s=a,l=s.next;s.next=null,null===o?C=l:o.next=l,o=s;var r=e.alternate;null!==r&&(a=(r=r.updateQueue).lastBaseUpdate)!==o&&(null===a?r.firstBaseUpdate=l:a.next=l,r.lastBaseUpdate=s)}if(null!==C){var A=n.baseState;for(o=0,r=l=s=null,a=C;;){var c=a.lane,d=a.eventTime;if((I&c)===c){null!==r&&(r=r.next={eventTime:d,lane:0,tag:a.tag,payload:a.payload,callback:a.callback,next:null});e:{var u=e,h=a;switch(c=g,d=t,h.tag){case 1:if("function"==typeof(u=h.payload)){A=u.call(d,A,c);break e}A=u;break e;case 3:u.flags=-65537&u.flags|128;case 0:if(null==(c="function"==typeof(u=h.payload)?u.call(d,A,c):u))break e;A=i({},A,c);break e;case 2:At=!0}}null!==a.callback&&0!==a.lane&&(e.flags|=64,null===(c=n.effects)?n.effects=[a]:c.push(a))}else d={eventTime:d,lane:c,tag:a.tag,payload:a.payload,callback:a.callback,next:null},null===r?(l=r=d,s=A):r=r.next=d,o|=c;if(null===(a=a.next)){if(null===(a=n.shared.pending))break;a=(c=a).next,c.next=null,n.lastBaseUpdate=c,n.shared.pending=null}}if(null===r&&(s=A),n.baseState=s,n.firstBaseUpdate=l,n.lastBaseUpdate=r,null!==(g=n.shared.interleaved)){n=g;do{o|=n.lane,n=n.next}while(n!==g)}else null===C&&(n.shared.lanes=0);gC|=o,e.lanes=o,e.memoizedState=A}}function Gt(e,g,t){if(e=g.effects,g.effects=null,null!==e)for(g=0;g<e.length;g++){var I=e[g],n=I.callback;if(null!==n){if(I.callback=null,I=t,"function"!=typeof n)throw Error(C(191,n));n.call(I)}}}var Bt=(new I.Component).refs;function Zt(e,g,t,I){t=null==(t=t(I,g=e.memoizedState))?g:i({},g,t),e.memoizedState=t,0===e.lanes&&(e.updateQueue.baseState=t)}var yt={isMounted:function(e){return!!(e=e._reactInternals)&&W(e)===e},enqueueSetState:function(e,g,t){e=e._reactInternals;var I=GC(),n=BC(e),i=ut(I,n);i.payload=g,null!=t&&(i.callback=t),ht(e,i),null!==(g=ZC(e,n,I))&&bt(g,e,n)},enqueueReplaceState:function(e,g,t){e=e._reactInternals;var I=GC(),n=BC(e),i=ut(I,n);i.tag=1,i.payload=g,null!=t&&(i.callback=t),ht(e,i),null!==(g=ZC(e,n,I))&&bt(g,e,n)},enqueueForceUpdate:function(e,g){e=e._reactInternals;var t=GC(),I=BC(e),n=ut(t,I);n.tag=2,null!=g&&(n.callback=g),ht(e,n),null!==(g=ZC(e,I,t))&&bt(g,e,I)}};function vt(e,g,t,I,n,i,C){return"function"==typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(I,i,C):!(g.prototype&&g.prototype.isPureReactComponent&&qg(t,I)&&qg(n,i))}function Wt(e,g,t){var I=!1,n=sg,i=g.contextType;return"object"==typeof i&&null!==i?i=lt(i):(n=dg(g)?Ag:lg.current,i=(I=null!=(I=g.contextTypes))?cg(e,n):sg),g=new g(t,i),e.memoizedState=null!==g.state&&void 0!==g.state?g.state:null,g.updater=yt,e.stateNode=g,g._reactInternals=e,I&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=n,e.__reactInternalMemoizedMaskedChildContext=i),g}function ft(e,g,t,I){e=g.state,"function"==typeof g.componentWillReceiveProps&&g.componentWillReceiveProps(t,I),"function"==typeof g.UNSAFE_componentWillReceiveProps&&g.UNSAFE_componentWillReceiveProps(t,I),g.state!==e&&yt.enqueueReplaceState(g,g.state,null)}function wt(e,g,t,I){var n=e.stateNode;n.props=t,n.state=e.memoizedState,n.refs=Bt,ct(e);var i=g.contextType;"object"==typeof i&&null!==i?n.context=lt(i):(i=dg(g)?Ag:lg.current,n.context=cg(e,i)),n.state=e.memoizedState,"function"==typeof(i=g.getDerivedStateFromProps)&&(Zt(e,g,i,t),n.state=e.memoizedState),"function"==typeof g.getDerivedStateFromProps||"function"==typeof n.getSnapshotBeforeUpdate||"function"!=typeof n.UNSAFE_componentWillMount&&"function"!=typeof n.componentWillMount||(g=n.state,"function"==typeof n.componentWillMount&&n.componentWillMount(),"function"==typeof n.UNSAFE_componentWillMount&&n.UNSAFE_componentWillMount(),g!==n.state&&yt.enqueueReplaceState(n,n.state,null),pt(e,t,n,I),n.state=e.memoizedState),"function"==typeof n.componentDidMount&&(e.flags|=4194308)}var Rt=[],Vt=0,Xt=null,St=0,Yt=[],Kt=0,Ht=null,Nt=1,Ft="";function xt(e,g){Rt[Vt++]=St,Rt[Vt++]=Xt,Xt=e,St=g}function zt(e,g,t){Yt[Kt++]=Nt,Yt[Kt++]=Ft,Yt[Kt++]=Ht,Ht=e;var I=Nt;e=Ft;var n=32-Gg(I)-1;I&=~(1<<n),t+=1;var i=32-Gg(g)+n;if(30<i){var C=n-n%5;i=(I&(1<<C)-1).toString(32),I>>=C,n-=C,Nt=1<<32-Gg(g)+n|t<<n|I,Ft=i+e}else Nt=1<<i|t<<n|I,Ft=e}function kt(e){null!==e.return&&(xt(e,1),zt(e,1,0))}function Mt(e){for(;e===Xt;)Xt=Rt[--Vt],Rt[Vt]=null,St=Rt[--Vt],Rt[Vt]=null;for(;e===Ht;)Ht=Yt[--Kt],Yt[Kt]=null,Ft=Yt[--Kt],Yt[Kt]=null,Nt=Yt[--Kt],Yt[Kt]=null}var Lt=null,Jt=null,Et=!1,Tt=!1,Ut=null;function Qt(e,g){var t=_C(5,null,null,0);t.elementType="DELETED",t.stateNode=g,t.return=e,null===(g=e.deletions)?(e.deletions=[t],e.flags|=16):g.push(t)}function Dt(e,g){switch(e.tag){case 5:return null!==(g=Ke(g,e.type,e.pendingProps))&&(e.stateNode=g,Lt=e,Jt=Me(g),!0);case 6:return null!==(g=He(g,e.pendingProps))&&(e.stateNode=g,Lt=e,Jt=null,!0);case 13:if(null!==(g=Ne(g))){var t=null!==Ht?{id:Nt,overflow:Ft}:null;return e.memoizedState={dehydrated:g,treeContext:t,retryLane:1073741824},(t=_C(18,null,null,0)).stateNode=g,t.return=e,e.child=t,Lt=e,Jt=null,!0}return!1;default:return!1}}function Ot(e){return 0!=(1&e.mode)&&0==(128&e.flags)}function jt(e){if(Et){var g=Jt;if(g){var t=g;if(!Dt(e,g)){if(Ot(e))throw Error(C(418));g=ke(t);var I=Lt;g&&Dt(e,g)?Qt(I,t):(e.flags=-4097&e.flags|2,Et=!1,Lt=e)}}else{if(Ot(e))throw Error(C(418));e.flags=-4097&e.flags|2,Et=!1,Lt=e}}}function Pt(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;Lt=e}function _t(e){if(!P||e!==Lt)return!1;if(!Et)return Pt(e),Et=!0,!1;if(3!==e.tag&&(5!==e.tag||_e(e.type)&&!J(e.type,e.memoizedProps))){var g=Jt;if(g){if(Ot(e)){for(e=Jt;e;)e=ke(e);throw Error(C(418))}for(;g;)Qt(e,g),g=ke(g)}}if(Pt(e),13===e.tag){if(!P)throw Error(C(316));if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(C(317));Jt=Qe(e)}else Jt=Lt?ke(e.stateNode):null;return!0}function qt(){P&&(Jt=Lt=null,Tt=Et=!1)}function $t(e){null===Ut?Ut=[e]:Ut.push(e)}function eI(e,g,t){if(null!==(e=t.ref)&&"function"!=typeof e&&"object"!=typeof e){if(t._owner){if(t=t._owner){if(1!==t.tag)throw Error(C(309));var I=t.stateNode}if(!I)throw Error(C(147,e));var n=I,i=""+e;return null!==g&&null!==g.ref&&"function"==typeof g.ref&&g.ref._stringRef===i?g.ref:(g=function(e){var g=n.refs;g===Bt&&(g=n.refs={}),null===e?delete g[i]:g[i]=e},g._stringRef=i,g)}if("string"!=typeof e)throw Error(C(284));if(!t._owner)throw Error(C(290,e))}return e}function gI(e,g){throw e=Object.prototype.toString.call(g),Error(C(31,"[object Object]"===e?"object with keys {"+Object.keys(g).join(", ")+"}":e))}function tI(e){return(0,e._init)(e._payload)}function II(e){function g(g,t){if(e){var I=g.deletions;null===I?(g.deletions=[t],g.flags|=16):I.push(t)}}function t(t,I){if(!e)return null;for(;null!==I;)g(t,I),I=I.sibling;return null}function I(e,g){for(e=new Map;null!==g;)null!==g.key?e.set(g.key,g):e.set(g.index,g),g=g.sibling;return e}function n(e,g){return(e=$C(e,g)).index=0,e.sibling=null,e}function i(g,t,I){return g.index=I,e?null!==(I=g.alternate)?(I=I.index)<t?(g.flags|=2,t):I:(g.flags|=2,t):(g.flags|=1048576,t)}function o(g){return e&&null===g.alternate&&(g.flags|=2),g}function r(e,g,t,I){return null===g||6!==g.tag?((g=Io(t,e.mode,I)).return=e,g):((g=n(g,t)).return=e,g)}function A(e,g,t,I){var i=t.type;return i===l?d(e,g,t.props.children,I,t.key):null!==g&&(g.elementType===i||"object"==typeof i&&null!==i&&i.$$typeof===p&&tI(i)===g.type)?((I=n(g,t.props)).ref=eI(e,g,t),I.return=e,I):((I=eo(t.type,t.key,t.props,null,e.mode,I)).ref=eI(e,g,t),I.return=e,I)}function c(e,g,t,I){return null===g||4!==g.tag||g.stateNode.containerInfo!==t.containerInfo||g.stateNode.implementation!==t.implementation?((g=no(t,e.mode,I)).return=e,g):((g=n(g,t.children||[])).return=e,g)}function d(e,g,t,I,i){return null===g||7!==g.tag?((g=go(t,e.mode,I,i)).return=e,g):((g=n(g,t)).return=e,g)}function u(e,g,t){if("string"==typeof g&&""!==g||"number"==typeof g)return(g=Io(""+g,e.mode,t)).return=e,g;if("object"==typeof g&&null!==g){switch(g.$$typeof){case a:return(t=eo(g.type,g.key,g.props,null,e.mode,t)).ref=eI(e,null,g),t.return=e,t;case s:return(g=no(g,e.mode,t)).return=e,g;case p:return u(e,(0,g._init)(g._payload),t)}if(Y(g)||Z(g))return(g=go(g,e.mode,t,null)).return=e,g;gI(e,g)}return null}function h(e,g,t,I){var n=null!==g?g.key:null;if("string"==typeof t&&""!==t||"number"==typeof t)return null!==n?null:r(e,g,""+t,I);if("object"==typeof t&&null!==t){switch(t.$$typeof){case a:return t.key===n?A(e,g,t,I):null;case s:return t.key===n?c(e,g,t,I):null;case p:return h(e,g,(n=t._init)(t._payload),I)}if(Y(t)||Z(t))return null!==n?null:d(e,g,t,I,null);gI(e,t)}return null}function b(e,g,t,I,n){if("string"==typeof I&&""!==I||"number"==typeof I)return r(g,e=e.get(t)||null,""+I,n);if("object"==typeof I&&null!==I){switch(I.$$typeof){case a:return A(g,e=e.get(null===I.key?t:I.key)||null,I,n);case s:return c(g,e=e.get(null===I.key?t:I.key)||null,I,n);case p:return b(e,g,t,(0,I._init)(I._payload),n)}if(Y(I)||Z(I))return d(g,e=e.get(t)||null,I,n,null);gI(g,I)}return null}function m(n,C,o,a){for(var s=null,l=null,r=C,A=C=0,c=null;null!==r&&A<o.length;A++){r.index>A?(c=r,r=null):c=r.sibling;var d=h(n,r,o[A],a);if(null===d){null===r&&(r=c);break}e&&r&&null===d.alternate&&g(n,r),C=i(d,C,A),null===l?s=d:l.sibling=d,l=d,r=c}if(A===o.length)return t(n,r),Et&&xt(n,A),s;if(null===r){for(;A<o.length;A++)null!==(r=u(n,o[A],a))&&(C=i(r,C,A),null===l?s=r:l.sibling=r,l=r);return Et&&xt(n,A),s}for(r=I(n,r);A<o.length;A++)null!==(c=b(r,n,A,o[A],a))&&(e&&null!==c.alternate&&r.delete(null===c.key?A:c.key),C=i(c,C,A),null===l?s=c:l.sibling=c,l=c);return e&&r.forEach((function(e){return g(n,e)})),Et&&xt(n,A),s}function G(n,o,a,s){var l=Z(a);if("function"!=typeof l)throw Error(C(150));if(null==(a=l.call(a)))throw Error(C(151));for(var r=l=null,A=o,c=o=0,d=null,m=a.next();null!==A&&!m.done;c++,m=a.next()){A.index>c?(d=A,A=null):d=A.sibling;var p=h(n,A,m.value,s);if(null===p){null===A&&(A=d);break}e&&A&&null===p.alternate&&g(n,A),o=i(p,o,c),null===r?l=p:r.sibling=p,r=p,A=d}if(m.done)return t(n,A),Et&&xt(n,c),l;if(null===A){for(;!m.done;c++,m=a.next())null!==(m=u(n,m.value,s))&&(o=i(m,o,c),null===r?l=m:r.sibling=m,r=m);return Et&&xt(n,c),l}for(A=I(n,A);!m.done;c++,m=a.next())null!==(m=b(A,n,c,m.value,s))&&(e&&null!==m.alternate&&A.delete(null===m.key?c:m.key),o=i(m,o,c),null===r?l=m:r.sibling=m,r=m);return e&&A.forEach((function(e){return g(n,e)})),Et&&xt(n,c),l}return function e(I,i,C,r){if("object"==typeof C&&null!==C&&C.type===l&&null===C.key&&(C=C.props.children),"object"==typeof C&&null!==C){switch(C.$$typeof){case a:e:{for(var A=C.key,c=i;null!==c;){if(c.key===A){if((A=C.type)===l){if(7===c.tag){t(I,c.sibling),(i=n(c,C.props.children)).return=I,I=i;break e}}else if(c.elementType===A||"object"==typeof A&&null!==A&&A.$$typeof===p&&tI(A)===c.type){t(I,c.sibling),(i=n(c,C.props)).ref=eI(I,c,C),i.return=I,I=i;break e}t(I,c);break}g(I,c),c=c.sibling}C.type===l?((i=go(C.props.children,I.mode,r,C.key)).return=I,I=i):((r=eo(C.type,C.key,C.props,null,I.mode,r)).ref=eI(I,i,C),r.return=I,I=r)}return o(I);case s:e:{for(c=C.key;null!==i;){if(i.key===c){if(4===i.tag&&i.stateNode.containerInfo===C.containerInfo&&i.stateNode.implementation===C.implementation){t(I,i.sibling),(i=n(i,C.children||[])).return=I,I=i;break e}t(I,i);break}g(I,i),i=i.sibling}(i=no(C,I.mode,r)).return=I,I=i}return o(I);case p:return e(I,i,(c=C._init)(C._payload),r)}if(Y(C))return m(I,i,C,r);if(Z(C))return G(I,i,C,r);gI(I,C)}return"string"==typeof C&&""!==C||"number"==typeof C?(C=""+C,null!==i&&6===i.tag?(t(I,i.sibling),(i=n(i,C)).return=I,I=i):(t(I,i),(i=Io(C,I.mode,r)).return=I,I=i),o(I)):t(I,i)}}var nI=II(!0),iI=II(!1),CI={},oI=Cg(CI),aI=Cg(CI),sI=Cg(CI);function lI(e){if(e===CI)throw Error(C(174));return e}function rI(e,g){ag(sI,g),ag(aI,e),ag(oI,CI),e=H(g),og(oI),ag(oI,e)}function AI(){og(oI),og(aI),og(sI)}function cI(e){var g=lI(sI.current),t=lI(oI.current);t!==(g=N(t,e.type,g))&&(ag(aI,e),ag(oI,g))}function dI(e){aI.current===e&&(og(oI),og(aI))}var uI=Cg(0);function hI(e){for(var g=e;null!==g;){if(13===g.tag){var t=g.memoizedState;if(null!==t&&(null===(t=t.dehydrated)||Fe(t)||xe(t)))return g}else if(19===g.tag&&void 0!==g.memoizedProps.revealOrder){if(0!=(128&g.flags))return g}else if(null!==g.child){g.child.return=g,g=g.child;continue}if(g===e)break;for(;null===g.sibling;){if(null===g.return||g.return===e)return null;g=g.return}g.sibling.return=g.return,g=g.sibling}return null}var bI=[];function mI(){for(var e=0;e<bI.length;e++){var g=bI[e];D?g._workInProgressVersionPrimary=null:g._workInProgressVersionSecondary=null}bI.length=0}var pI=o.ReactCurrentDispatcher,GI=o.ReactCurrentBatchConfig,BI=0,ZI=null,yI=null,vI=null,WI=!1,fI=!1,wI=0,RI=0;function VI(){throw Error(C(321))}function XI(e,g){if(null===g)return!1;for(var t=0;t<g.length&&t<e.length;t++)if(!Ug(e[t],g[t]))return!1;return!0}function SI(e,g,t,I,n,i){if(BI=i,ZI=g,g.memoizedState=null,g.updateQueue=null,g.lanes=0,pI.current=null===e||null===e.memoizedState?dn:un,e=t(I,n),fI){i=0;do{if(fI=!1,wI=0,25<=i)throw Error(C(301));i+=1,vI=yI=null,g.updateQueue=null,pI.current=hn,e=t(I,n)}while(fI)}if(pI.current=cn,g=null!==yI&&null!==yI.next,BI=0,vI=yI=ZI=null,WI=!1,g)throw Error(C(300));return e}function YI(){var e=0!==wI;return wI=0,e}function KI(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===vI?ZI.memoizedState=vI=e:vI=vI.next=e,vI}function HI(){if(null===yI){var e=ZI.alternate;e=null!==e?e.memoizedState:null}else e=yI.next;var g=null===vI?ZI.memoizedState:vI.next;if(null!==g)vI=g,yI=e;else{if(null===e)throw Error(C(310));e={memoizedState:(yI=e).memoizedState,baseState:yI.baseState,baseQueue:yI.baseQueue,queue:yI.queue,next:null},null===vI?ZI.memoizedState=vI=e:vI=vI.next=e}return vI}function NI(e,g){return"function"==typeof g?g(e):g}function FI(e){var g=HI(),t=g.queue;if(null===t)throw Error(C(311));t.lastRenderedReducer=e;var I=yI,n=I.baseQueue,i=t.pending;if(null!==i){if(null!==n){var o=n.next;n.next=i.next,i.next=o}I.baseQueue=n=i,t.pending=null}if(null!==n){i=n.next,I=I.baseState;var a=o=null,s=null,l=i;do{var r=l.lane;if((BI&r)===r)null!==s&&(s=s.next={lane:0,action:l.action,hasEagerState:l.hasEagerState,eagerState:l.eagerState,next:null}),I=l.hasEagerState?l.eagerState:e(I,l.action);else{var A={lane:r,action:l.action,hasEagerState:l.hasEagerState,eagerState:l.eagerState,next:null};null===s?(a=s=A,o=I):s=s.next=A,ZI.lanes|=r,gC|=r}l=l.next}while(null!==l&&l!==i);null===s?o=I:s.next=a,Ug(I,g.memoizedState)||(Fn=!0),g.memoizedState=I,g.baseState=o,g.baseQueue=s,t.lastRenderedState=I}if(null!==(e=t.interleaved)){n=e;do{i=n.lane,ZI.lanes|=i,gC|=i,n=n.next}while(n!==e)}else null===n&&(t.lanes=0);return[g.memoizedState,t.dispatch]}function xI(e){var g=HI(),t=g.queue;if(null===t)throw Error(C(311));t.lastRenderedReducer=e;var I=t.dispatch,n=t.pending,i=g.memoizedState;if(null!==n){t.pending=null;var o=n=n.next;do{i=e(i,o.action),o=o.next}while(o!==n);Ug(i,g.memoizedState)||(Fn=!0),g.memoizedState=i,null===g.baseQueue&&(g.baseState=i),t.lastRenderedState=i}return[i,I]}function zI(){}function kI(e,g){var t=ZI,I=HI(),n=g(),i=!Ug(I.memoizedState,n);if(i&&(I.memoizedState=n,Fn=!0),I=I.queue,PI(JI.bind(null,t,I,e),[e]),I.getSnapshot!==g||i||null!==vI&&1&vI.memoizedState.tag){if(t.flags|=2048,UI(9,LI.bind(null,t,I,n,g),void 0,null),null===Oi)throw Error(C(349));0!=(30&BI)||MI(t,g,n)}return n}function MI(e,g,t){e.flags|=16384,e={getSnapshot:g,value:t},null===(g=ZI.updateQueue)?(g={lastEffect:null,stores:null},ZI.updateQueue=g,g.stores=[e]):null===(t=g.stores)?g.stores=[e]:t.push(e)}function LI(e,g,t,I){g.value=t,g.getSnapshot=I,EI(g)&&ZC(e,1,-1)}function JI(e,g,t){return t((function(){EI(g)&&ZC(e,1,-1)}))}function EI(e){var g=e.getSnapshot;e=e.value;try{var t=g();return!Ug(e,t)}catch(e){return!0}}function TI(e){var g=KI();return"function"==typeof e&&(e=e()),g.memoizedState=g.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:NI,lastRenderedState:e},g.queue=e,e=e.dispatch=an.bind(null,ZI,e),[g.memoizedState,e]}function UI(e,g,t,I){return e={tag:e,create:g,destroy:t,deps:I,next:null},null===(g=ZI.updateQueue)?(g={lastEffect:null,stores:null},ZI.updateQueue=g,g.lastEffect=e.next=e):null===(t=g.lastEffect)?g.lastEffect=e.next=e:(I=t.next,t.next=e,e.next=I,g.lastEffect=e),e}function QI(){return HI().memoizedState}function DI(e,g,t,I){var n=KI();ZI.flags|=e,n.memoizedState=UI(1|g,t,void 0,void 0===I?null:I)}function OI(e,g,t,I){var n=HI();I=void 0===I?null:I;var i=void 0;if(null!==yI){var C=yI.memoizedState;if(i=C.destroy,null!==I&&XI(I,C.deps))return void(n.memoizedState=UI(g,t,i,I))}ZI.flags|=e,n.memoizedState=UI(1|g,t,i,I)}function jI(e,g){return DI(8390656,8,e,g)}function PI(e,g){return OI(2048,8,e,g)}function _I(e,g){return OI(4,2,e,g)}function qI(e,g){return OI(4,4,e,g)}function $I(e,g){return"function"==typeof g?(e=e(),g(e),function(){g(null)}):null!=g?(e=e(),g.current=e,function(){g.current=null}):void 0}function en(e,g,t){return t=null!=t?t.concat([e]):null,OI(4,4,$I.bind(null,g,e),t)}function gn(){}function tn(e,g){var t=HI();g=void 0===g?null:g;var I=t.memoizedState;return null!==I&&null!==g&&XI(g,I[1])?I[0]:(t.memoizedState=[e,g],e)}function In(e,g){var t=HI();g=void 0===g?null:g;var I=t.memoizedState;return null!==I&&null!==g&&XI(g,I[1])?I[0]:(e=e(),t.memoizedState=[e,g],e)}function nn(e,g){var t=Yg;Yg=0!==t&&4>t?t:4,e(!0);var I=GI.transition;GI.transition={};try{e(!1),g()}finally{Yg=t,GI.transition=I}}function Cn(){return HI().memoizedState}function on(e,g,t){var I=BC(e);t={lane:I,action:t,hasEagerState:!1,eagerState:null,next:null},sn(e)?ln(g,t):(rn(e,g,t),null!==(e=ZC(e,I,t=GC()))&&An(e,g,I))}function an(e,g,t){var I=BC(e),n={lane:I,action:t,hasEagerState:!1,eagerState:null,next:null};if(sn(e))ln(g,n);else{rn(e,g,n);var i=e.alternate;if(0===e.lanes&&(null===i||0===i.lanes)&&null!==(i=g.lastRenderedReducer))try{var C=g.lastRenderedState,o=i(C,t);if(n.hasEagerState=!0,n.eagerState=o,Ug(o,C))return}catch(e){}null!==(e=ZC(e,I,t=GC()))&&An(e,g,I)}}function sn(e){var g=e.alternate;return e===ZI||null!==g&&g===ZI}function ln(e,g){fI=WI=!0;var t=e.pending;null===t?g.next=g:(g.next=t.next,t.next=g),e.pending=g}function rn(e,g,t){null!==Oi&&0!=(1&e.mode)&&0==(2&Di)?(null===(e=g.interleaved)?(t.next=t,null===rt?rt=[g]:rt.push(g)):(t.next=e.next,e.next=t),g.interleaved=t):(null===(e=g.pending)?t.next=t:(t.next=e.next,e.next=t),g.pending=t)}function An(e,g,t){if(0!=(4194240&t)){var I=g.lanes;t|=I&=e.pendingLanes,g.lanes=t,Sg(e,t)}}var cn={readContext:lt,useCallback:VI,useContext:VI,useEffect:VI,useImperativeHandle:VI,useInsertionEffect:VI,useLayoutEffect:VI,useMemo:VI,useReducer:VI,useRef:VI,useState:VI,useDebugValue:VI,useDeferredValue:VI,useTransition:VI,useMutableSource:VI,useSyncExternalStore:VI,useId:VI,unstable_isNewReconciler:!1},dn={readContext:lt,useCallback:function(e,g){return KI().memoizedState=[e,void 0===g?null:g],e},useContext:lt,useEffect:jI,useImperativeHandle:function(e,g,t){return t=null!=t?t.concat([e]):null,DI(4194308,4,$I.bind(null,g,e),t)},useLayoutEffect:function(e,g){return DI(4194308,4,e,g)},useInsertionEffect:function(e,g){return DI(4,2,e,g)},useMemo:function(e,g){var t=KI();return g=void 0===g?null:g,e=e(),t.memoizedState=[e,g],e},useReducer:function(e,g,t){var I=KI();return g=void 0!==t?t(g):g,I.memoizedState=I.baseState=g,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:g},I.queue=e,e=e.dispatch=on.bind(null,ZI,e),[I.memoizedState,e]},useRef:function(e){return e={current:e},KI().memoizedState=e},useState:TI,useDebugValue:gn,useDeferredValue:function(e){var g=TI(e),t=g[0],I=g[1];return jI((function(){var g=GI.transition;GI.transition={};try{I(e)}finally{GI.transition=g}}),[e]),t},useTransition:function(){var e=TI(!1),g=e[0];return e=nn.bind(null,e[1]),KI().memoizedState=e,[g,e]},useMutableSource:function(){},useSyncExternalStore:function(e,g,t){var I=ZI,n=KI();if(Et){if(void 0===t)throw Error(C(407));t=t()}else{if(t=g(),null===Oi)throw Error(C(349));0!=(30&BI)||MI(I,g,t)}n.memoizedState=t;var i={value:t,getSnapshot:g};return n.queue=i,jI(JI.bind(null,I,i,e),[e]),I.flags|=2048,UI(9,LI.bind(null,I,i,t,g),void 0,null),t},useId:function(){var e=KI(),g=Oi.identifierPrefix;if(Et){var t=Ft;g=":"+g+"R"+(t=(Nt&~(1<<32-Gg(Nt)-1)).toString(32)+t),0<(t=wI++)&&(g+="H"+t.toString(32)),g+=":"}else g=":"+g+"r"+(t=RI++).toString(32)+":";return e.memoizedState=g},unstable_isNewReconciler:!1},un={readContext:lt,useCallback:tn,useContext:lt,useEffect:PI,useImperativeHandle:en,useInsertionEffect:_I,useLayoutEffect:qI,useMemo:In,useReducer:FI,useRef:QI,useState:function(){return FI(NI)},useDebugValue:gn,useDeferredValue:function(e){var g=FI(NI),t=g[0],I=g[1];return PI((function(){var g=GI.transition;GI.transition={};try{I(e)}finally{GI.transition=g}}),[e]),t},useTransition:function(){return[FI(NI)[0],HI().memoizedState]},useMutableSource:zI,useSyncExternalStore:kI,useId:Cn,unstable_isNewReconciler:!1},hn={readContext:lt,useCallback:tn,useContext:lt,useEffect:PI,useImperativeHandle:en,useInsertionEffect:_I,useLayoutEffect:qI,useMemo:In,useReducer:xI,useRef:QI,useState:function(){return xI(NI)},useDebugValue:gn,useDeferredValue:function(e){var g=xI(NI),t=g[0],I=g[1];return PI((function(){var g=GI.transition;GI.transition={};try{I(e)}finally{GI.transition=g}}),[e]),t},useTransition:function(){return[xI(NI)[0],HI().memoizedState]},useMutableSource:zI,useSyncExternalStore:kI,useId:Cn,unstable_isNewReconciler:!1};function bn(e,g){try{var t="",I=g;do{t+=$g(I),I=I.return}while(I);var n=t}catch(e){n="\nError generating stack: "+e.message+"\n"+e.stack}return{value:e,source:g,stack:n}}function mn(e,g){try{console.error(g.value)}catch(e){setTimeout((function(){throw e}))}}var pn,Gn,Bn,Zn,yn="function"==typeof WeakMap?WeakMap:Map;function vn(e,g,t){(t=ut(-1,t)).tag=3,t.payload={element:null};var I=g.value;return t.callback=function(){lC||(lC=!0,rC=I),mn(0,g)},t}function Wn(e,g,t){(t=ut(-1,t)).tag=3;var I=e.type.getDerivedStateFromError;if("function"==typeof I){var n=g.value;t.payload=function(){return I(n)},t.callback=function(){mn(0,g)}}var i=e.stateNode;return null!==i&&"function"==typeof i.componentDidCatch&&(t.callback=function(){mn(0,g),"function"!=typeof I&&(null===AC?AC=new Set([this]):AC.add(this));var e=g.stack;this.componentDidCatch(g.value,{componentStack:null!==e?e:""})}),t}function fn(e,g,t){var I=e.pingCache;if(null===I){I=e.pingCache=new yn;var n=new Set;I.set(g,n)}else void 0===(n=I.get(g))&&(n=new Set,I.set(g,n));n.has(t)||(n.add(t),e=UC.bind(null,e,g,t),g.then(e,e))}function wn(e){do{var g;if((g=13===e.tag)&&(g=null===(g=e.memoizedState)||null!==g.dehydrated),g)return e;e=e.return}while(null!==e);return null}function Rn(e,g,t,I,n){return 0==(1&e.mode)?(e===g?e.flags|=65536:(e.flags|=128,t.flags|=131072,t.flags&=-52805,1===t.tag&&(null===t.alternate?t.tag=17:((g=ut(-1,1)).tag=2,ht(t,g))),t.lanes|=1),e):(e.flags|=65536,e.lanes=n,e)}function Vn(e){e.flags|=4}function Xn(e,g){if(null!==e&&e.child===g.child)return!0;if(0!=(16&g.flags))return!1;for(e=g.child;null!==e;){if(0!=(12854&e.flags)||0!=(12854&e.subtreeFlags))return!1;e=e.sibling}return!0}if(O)pn=function(e,g){for(var t=g.child;null!==t;){if(5===t.tag||6===t.tag)k(e,t.stateNode);else if(4!==t.tag&&null!==t.child){t.child.return=t,t=t.child;continue}if(t===g)break;for(;null===t.sibling;){if(null===t.return||t.return===g)return;t=t.return}t.sibling.return=t.return,t=t.sibling}},Gn=function(){},Bn=function(e,g,t,I,n){if((e=e.memoizedProps)!==I){var i=g.stateNode,C=lI(oI.current);t=L(i,t,e,I,n,C),(g.updateQueue=t)&&Vn(g)}},Zn=function(e,g,t,I){t!==I&&Vn(g)};else if(j){pn=function(e,g,t,I){for(var n=g.child;null!==n;){if(5===n.tag){var i=n.stateNode;t&&I&&(i=Se(i,n.type,n.memoizedProps,n)),k(e,i)}else if(6===n.tag)i=n.stateNode,t&&I&&(i=Ye(i,n.memoizedProps,n)),k(e,i);else if(4!==n.tag)if(22===n.tag&&null!==n.memoizedState)null!==(i=n.child)&&(i.return=n),pn(e,n,!0,!0);else if(null!==n.child){n.child.return=n,n=n.child;continue}if(n===g)break;for(;null===n.sibling;){if(null===n.return||n.return===g)return;n=n.return}n.sibling.return=n.return,n=n.sibling}};var Sn=function(e,g,t,I){for(var n=g.child;null!==n;){if(5===n.tag){var i=n.stateNode;t&&I&&(i=Se(i,n.type,n.memoizedProps,n)),Re(e,i)}else if(6===n.tag)i=n.stateNode,t&&I&&(i=Ye(i,n.memoizedProps,n)),Re(e,i);else if(4!==n.tag)if(22===n.tag&&null!==n.memoizedState)null!==(i=n.child)&&(i.return=n),Sn(e,n,!0,!0);else if(null!==n.child){n.child.return=n,n=n.child;continue}if(n===g)break;for(;null===n.sibling;){if(null===n.return||n.return===g)return;n=n.return}n.sibling.return=n.return,n=n.sibling}};Gn=function(e,g){var t=g.stateNode;if(!Xn(e,g)){e=t.containerInfo;var I=we(e);Sn(I,g,!1,!1),t.pendingChildren=I,Vn(g),Ve(e,I)}},Bn=function(e,g,t,I,n){var i=e.stateNode,C=e.memoizedProps;if((e=Xn(e,g))&&C===I)g.stateNode=i;else{var o=g.stateNode,a=lI(oI.current),s=null;C!==I&&(s=L(o,t,C,I,n,a)),e&&null===s?g.stateNode=i:(i=fe(i,s,t,C,I,g,e,o),M(i,t,I,n,a)&&Vn(g),g.stateNode=i,e?Vn(g):pn(i,g,!1,!1))}},Zn=function(e,g,t,I){t!==I?(e=lI(sI.current),t=lI(oI.current),g.stateNode=E(I,e,t,g),Vn(g)):g.stateNode=e.stateNode}}else Gn=function(){},Bn=function(){},Zn=function(){};function Yn(e,g){if(!Et)switch(e.tailMode){case"hidden":g=e.tail;for(var t=null;null!==g;)null!==g.alternate&&(t=g),g=g.sibling;null===t?e.tail=null:t.sibling=null;break;case"collapsed":t=e.tail;for(var I=null;null!==t;)null!==t.alternate&&(I=t),t=t.sibling;null===I?g||null===e.tail?e.tail=null:e.tail.sibling=null:I.sibling=null}}function Kn(e){var g=null!==e.alternate&&e.alternate.child===e.child,t=0,I=0;if(g)for(var n=e.child;null!==n;)t|=n.lanes|n.childLanes,I|=14680064&n.subtreeFlags,I|=14680064&n.flags,n.return=e,n=n.sibling;else for(n=e.child;null!==n;)t|=n.lanes|n.childLanes,I|=n.subtreeFlags,I|=n.flags,n.return=e,n=n.sibling;return e.subtreeFlags|=I,e.childLanes=t,g}function Hn(e,g,t){var I=g.pendingProps;switch(Mt(g),g.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Kn(g),null;case 1:case 17:return dg(g.type)&&ug(),Kn(g),null;case 3:return I=g.stateNode,AI(),og(rg),og(lg),mI(),I.pendingContext&&(I.context=I.pendingContext,I.pendingContext=null),null!==e&&null!==e.child||(_t(g)?Vn(g):null===e||e.memoizedState.isDehydrated&&0==(256&g.flags)||(g.flags|=1024,null!==Ut&&(wC(Ut),Ut=null))),Gn(e,g),Kn(g),null;case 5:dI(g),t=lI(sI.current);var n=g.type;if(null!==e&&null!=g.stateNode)Bn(e,g,n,I,t),e.ref!==g.ref&&(g.flags|=512,g.flags|=2097152);else{if(!I){if(null===g.stateNode)throw Error(C(166));return Kn(g),null}if(e=lI(oI.current),_t(g)){if(!P)throw Error(C(175));e=Ee(g.stateNode,g.type,g.memoizedProps,t,e,g,!Tt),g.updateQueue=e,null!==e&&Vn(g)}else{var i=z(n,I,t,e,g);pn(i,g,!1,!1),g.stateNode=i,M(i,n,I,t,e)&&Vn(g)}null!==g.ref&&(g.flags|=512,g.flags|=2097152)}return Kn(g),null;case 6:if(e&&null!=g.stateNode)Zn(e,g,e.memoizedProps,I);else{if("string"!=typeof I&&null===g.stateNode)throw Error(C(166));if(e=lI(sI.current),t=lI(oI.current),_t(g)){if(!P)throw Error(C(176));if(e=g.stateNode,I=g.memoizedProps,(t=Te(e,I,g,!Tt))&&null!==(n=Lt))switch(i=0!=(1&n.mode),n.tag){case 3:qe(n.stateNode.containerInfo,e,I,i);break;case 5:$e(n.type,n.memoizedProps,n.stateNode,e,I,i)}t&&Vn(g)}else g.stateNode=E(I,e,t,g)}return Kn(g),null;case 13:if(og(uI),I=g.memoizedState,Et&&null!==Jt&&0!=(1&g.mode)&&0==(128&g.flags)){for(e=Jt;e;)e=ke(e);return qt(),g.flags|=98560,g}if(null!==I&&null!==I.dehydrated){if(I=_t(g),null===e){if(!I)throw Error(C(318));if(!P)throw Error(C(344));if(!(e=null!==(e=g.memoizedState)?e.dehydrated:null))throw Error(C(317));Ue(e,g)}else qt(),0==(128&g.flags)&&(g.memoizedState=null),g.flags|=4;return Kn(g),null}return null!==Ut&&(wC(Ut),Ut=null),0!=(128&g.flags)?(g.lanes=t,g):(I=null!==I,t=!1,null===e?_t(g):t=null!==e.memoizedState,I&&!t&&(g.child.flags|=8192,0!=(1&g.mode)&&(null===e||0!=(1&uI.current)?0===$i&&($i=3):NC())),null!==g.updateQueue&&(g.flags|=4),Kn(g),null);case 4:return AI(),Gn(e,g),null===e&&q(g.stateNode.containerInfo),Kn(g),null;case 10:return ot(g.type._context),Kn(g),null;case 19:if(og(uI),null===(n=g.memoizedState))return Kn(g),null;if(I=0!=(128&g.flags),null===(i=n.rendering))if(I)Yn(n,!1);else{if(0!==$i||null!==e&&0!=(128&e.flags))for(e=g.child;null!==e;){if(null!==(i=hI(e))){for(g.flags|=128,Yn(n,!1),null!==(e=i.updateQueue)&&(g.updateQueue=e,g.flags|=4),g.subtreeFlags=0,e=t,I=g.child;null!==I;)n=e,(t=I).flags&=14680066,null===(i=t.alternate)?(t.childLanes=0,t.lanes=n,t.child=null,t.subtreeFlags=0,t.memoizedProps=null,t.memoizedState=null,t.updateQueue=null,t.dependencies=null,t.stateNode=null):(t.childLanes=i.childLanes,t.lanes=i.lanes,t.child=i.child,t.subtreeFlags=0,t.deletions=null,t.memoizedProps=i.memoizedProps,t.memoizedState=i.memoizedState,t.updateQueue=i.updateQueue,t.type=i.type,n=i.dependencies,t.dependencies=null===n?null:{lanes:n.lanes,firstContext:n.firstContext}),I=I.sibling;return ag(uI,1&uI.current|2),g.child}e=e.sibling}null!==n.tail&&zg()>oC&&(g.flags|=128,I=!0,Yn(n,!1),g.lanes=4194304)}else{if(!I)if(null!==(e=hI(i))){if(g.flags|=128,I=!0,null!==(e=e.updateQueue)&&(g.updateQueue=e,g.flags|=4),Yn(n,!0),null===n.tail&&"hidden"===n.tailMode&&!i.alternate&&!Et)return Kn(g),null}else 2*zg()-n.renderingStartTime>oC&&1073741824!==t&&(g.flags|=128,I=!0,Yn(n,!1),g.lanes=4194304);n.isBackwards?(i.sibling=g.child,g.child=i):(null!==(e=n.last)?e.sibling=i:g.child=i,n.last=i)}return null!==n.tail?(g=n.tail,n.rendering=g,n.tail=g.sibling,n.renderingStartTime=zg(),g.sibling=null,e=uI.current,ag(uI,I?1&e|2:1&e),g):(Kn(g),null);case 22:case 23:return SC(),I=null!==g.memoizedState,null!==e&&null!==e.memoizedState!==I&&(g.flags|=8192),I&&0!=(1&g.mode)?0!=(1073741824&_i)&&(Kn(g),O&&6&g.subtreeFlags&&(g.flags|=8192)):Kn(g),null;case 24:case 25:return null}throw Error(C(156,g.tag))}var Nn=o.ReactCurrentOwner,Fn=!1;function xn(e,g,t,I){g.child=null===e?iI(g,null,t,I):nI(g,e.child,t,I)}function zn(e,g,t,I,n){t=t.render;var i=g.ref;return st(g,n),I=SI(e,g,t,I,i,n),t=YI(),null===e||Fn?(Et&&t&&kt(g),g.flags|=1,xn(e,g,I,n),g.child):(g.updateQueue=e.updateQueue,g.flags&=-2053,e.lanes&=~n,ni(e,g,n))}function kn(e,g,t,I,n){if(null===e){var i=t.type;return"function"!=typeof i||qC(i)||void 0!==i.defaultProps||null!==t.compare||void 0!==t.defaultProps?((e=eo(t.type,null,I,g,g.mode,n)).ref=g.ref,e.return=g,g.child=e):(g.tag=15,g.type=i,Mn(e,g,i,I,n))}if(i=e.child,0==(e.lanes&n)){var C=i.memoizedProps;if((t=null!==(t=t.compare)?t:qg)(C,I)&&e.ref===g.ref)return ni(e,g,n)}return g.flags|=1,(e=$C(i,I)).ref=g.ref,e.return=g,g.child=e}function Mn(e,g,t,I,n){if(null!==e&&qg(e.memoizedProps,I)&&e.ref===g.ref){if(Fn=!1,0==(e.lanes&n))return g.lanes=e.lanes,ni(e,g,n);0!=(131072&e.flags)&&(Fn=!0)}return En(e,g,t,I,n)}function Ln(e,g,t){var I=g.pendingProps,n=I.children,i=null!==e?e.memoizedState:null;if("hidden"===I.mode)if(0==(1&g.mode))g.memoizedState={baseLanes:0,cachePool:null},ag(qi,_i),_i|=t;else{if(0==(1073741824&t))return e=null!==i?i.baseLanes|t:t,g.lanes=g.childLanes=1073741824,g.memoizedState={baseLanes:e,cachePool:null},g.updateQueue=null,ag(qi,_i),_i|=e,null;g.memoizedState={baseLanes:0,cachePool:null},I=null!==i?i.baseLanes:t,ag(qi,_i),_i|=I}else null!==i?(I=i.baseLanes|t,g.memoizedState=null):I=t,ag(qi,_i),_i|=I;return xn(e,g,n,t),g.child}function Jn(e,g){var t=g.ref;(null===e&&null!==t||null!==e&&e.ref!==t)&&(g.flags|=512,g.flags|=2097152)}function En(e,g,t,I,n){var i=dg(t)?Ag:lg.current;return i=cg(g,i),st(g,n),t=SI(e,g,t,I,i,n),I=YI(),null===e||Fn?(Et&&I&&kt(g),g.flags|=1,xn(e,g,t,n),g.child):(g.updateQueue=e.updateQueue,g.flags&=-2053,e.lanes&=~n,ni(e,g,n))}function Tn(e,g,t,I,n){if(dg(t)){var i=!0;mg(g)}else i=!1;if(st(g,n),null===g.stateNode)null!==e&&(e.alternate=null,g.alternate=null,g.flags|=2),Wt(g,t,I),wt(g,t,I,n),I=!0;else if(null===e){var C=g.stateNode,o=g.memoizedProps;C.props=o;var a=C.context,s=t.contextType;s="object"==typeof s&&null!==s?lt(s):cg(g,s=dg(t)?Ag:lg.current);var l=t.getDerivedStateFromProps,r="function"==typeof l||"function"==typeof C.getSnapshotBeforeUpdate;r||"function"!=typeof C.UNSAFE_componentWillReceiveProps&&"function"!=typeof C.componentWillReceiveProps||(o!==I||a!==s)&&ft(g,C,I,s),At=!1;var A=g.memoizedState;C.state=A,pt(g,I,C,n),a=g.memoizedState,o!==I||A!==a||rg.current||At?("function"==typeof l&&(Zt(g,t,l,I),a=g.memoizedState),(o=At||vt(g,t,o,I,A,a,s))?(r||"function"!=typeof C.UNSAFE_componentWillMount&&"function"!=typeof C.componentWillMount||("function"==typeof C.componentWillMount&&C.componentWillMount(),"function"==typeof C.UNSAFE_componentWillMount&&C.UNSAFE_componentWillMount()),"function"==typeof C.componentDidMount&&(g.flags|=4194308)):("function"==typeof C.componentDidMount&&(g.flags|=4194308),g.memoizedProps=I,g.memoizedState=a),C.props=I,C.state=a,C.context=s,I=o):("function"==typeof C.componentDidMount&&(g.flags|=4194308),I=!1)}else{C=g.stateNode,dt(e,g),o=g.memoizedProps,s=g.type===g.elementType?o:et(g.type,o),C.props=s,r=g.pendingProps,A=C.context,a="object"==typeof(a=t.contextType)&&null!==a?lt(a):cg(g,a=dg(t)?Ag:lg.current);var c=t.getDerivedStateFromProps;(l="function"==typeof c||"function"==typeof C.getSnapshotBeforeUpdate)||"function"!=typeof C.UNSAFE_componentWillReceiveProps&&"function"!=typeof C.componentWillReceiveProps||(o!==r||A!==a)&&ft(g,C,I,a),At=!1,A=g.memoizedState,C.state=A,pt(g,I,C,n);var d=g.memoizedState;o!==r||A!==d||rg.current||At?("function"==typeof c&&(Zt(g,t,c,I),d=g.memoizedState),(s=At||vt(g,t,s,I,A,d,a)||!1)?(l||"function"!=typeof C.UNSAFE_componentWillUpdate&&"function"!=typeof C.componentWillUpdate||("function"==typeof C.componentWillUpdate&&C.componentWillUpdate(I,d,a),"function"==typeof C.UNSAFE_componentWillUpdate&&C.UNSAFE_componentWillUpdate(I,d,a)),"function"==typeof C.componentDidUpdate&&(g.flags|=4),"function"==typeof C.getSnapshotBeforeUpdate&&(g.flags|=1024)):("function"!=typeof C.componentDidUpdate||o===e.memoizedProps&&A===e.memoizedState||(g.flags|=4),"function"!=typeof C.getSnapshotBeforeUpdate||o===e.memoizedProps&&A===e.memoizedState||(g.flags|=1024),g.memoizedProps=I,g.memoizedState=d),C.props=I,C.state=d,C.context=a,I=s):("function"!=typeof C.componentDidUpdate||o===e.memoizedProps&&A===e.memoizedState||(g.flags|=4),"function"!=typeof C.getSnapshotBeforeUpdate||o===e.memoizedProps&&A===e.memoizedState||(g.flags|=1024),I=!1)}return Un(e,g,t,I,i,n)}function Un(e,g,t,I,n,i){Jn(e,g);var C=0!=(128&g.flags);if(!I&&!C)return n&&pg(g,t,!1),ni(e,g,i);I=g.stateNode,Nn.current=g;var o=C&&"function"!=typeof t.getDerivedStateFromError?null:I.render();return g.flags|=1,null!==e&&C?(g.child=nI(g,e.child,null,i),g.child=nI(g,null,o,i)):xn(e,g,o,i),g.memoizedState=I.state,n&&pg(g,t,!0),g.child}function Qn(e){var g=e.stateNode;g.pendingContext?hg(0,g.pendingContext,g.pendingContext!==g.context):g.context&&hg(0,g.context,!1),rI(e,g.containerInfo)}function Dn(e,g,t,I,n){return qt(),$t(n),g.flags|=256,xn(e,g,t,I),g.child}var On={dehydrated:null,treeContext:null,retryLane:0};function jn(e){return{baseLanes:e,cachePool:null}}function Pn(e,g,t){var I,n=g.pendingProps,i=uI.current,o=!1,a=0!=(128&g.flags);if((I=a)||(I=(null===e||null!==e.memoizedState)&&0!=(2&i)),I?(o=!0,g.flags&=-129):null!==e&&null===e.memoizedState||(i|=1),ag(uI,1&i),null===e)return jt(g),null!==(e=g.memoizedState)&&null!==(e=e.dehydrated)?(0==(1&g.mode)?g.lanes=1:xe(e)?g.lanes=8:g.lanes=1073741824,null):(i=n.children,e=n.fallback,o?(n=g.mode,o=g.child,i={mode:"hidden",children:i},0==(1&n)&&null!==o?(o.childLanes=0,o.pendingProps=i):o=to(i,n,0,null),e=go(e,n,t,null),o.return=g,e.return=g,o.sibling=e,g.child=o,g.child.memoizedState=jn(t),g.memoizedState=On,e):_n(g,i));if(null!==(i=e.memoizedState)){if(null!==(I=i.dehydrated)){if(a)return 256&g.flags?(g.flags&=-257,ei(e,g,t,Error(C(422)))):null!==g.memoizedState?(g.child=e.child,g.flags|=128,null):(o=n.fallback,i=g.mode,n=to({mode:"visible",children:n.children},i,0,null),(o=go(o,i,t,null)).flags|=2,n.return=g,o.return=g,n.sibling=o,g.child=n,0!=(1&g.mode)&&nI(g,e.child,null,t),g.child.memoizedState=jn(t),g.memoizedState=On,o);if(0==(1&g.mode))g=ei(e,g,t,null);else if(xe(I))g=ei(e,g,t,Error(C(419)));else if(n=0!=(t&e.childLanes),Fn||n){if(null!==(n=Oi)){switch(t&-t){case 4:o=2;break;case 16:o=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:o=32;break;case 536870912:o=268435456;break;default:o=0}0!==(n=0!=(o&(n.suspendedLanes|t))?0:o)&&n!==i.retryLane&&(i.retryLane=n,ZC(e,n,-1))}NC(),g=ei(e,g,t,Error(C(421)))}else Fe(I)?(g.flags|=128,g.child=e.child,g=DC.bind(null,e),ze(I,g),g=null):(t=i.treeContext,P&&(Jt=Je(I),Lt=g,Et=!0,Ut=null,Tt=!1,null!==t&&(Yt[Kt++]=Nt,Yt[Kt++]=Ft,Yt[Kt++]=Ht,Nt=t.id,Ft=t.overflow,Ht=g)),(g=_n(g,g.pendingProps.children)).flags|=4096);return g}return o?(n=$n(e,g,n.children,n.fallback,t),o=g.child,i=e.child.memoizedState,o.memoizedState=null===i?jn(t):{baseLanes:i.baseLanes|t,cachePool:null},o.childLanes=e.childLanes&~t,g.memoizedState=On,n):(t=qn(e,g,n.children,t),g.memoizedState=null,t)}return o?(n=$n(e,g,n.children,n.fallback,t),o=g.child,i=e.child.memoizedState,o.memoizedState=null===i?jn(t):{baseLanes:i.baseLanes|t,cachePool:null},o.childLanes=e.childLanes&~t,g.memoizedState=On,n):(t=qn(e,g,n.children,t),g.memoizedState=null,t)}function _n(e,g){return(g=to({mode:"visible",children:g},e.mode,0,null)).return=e,e.child=g}function qn(e,g,t,I){var n=e.child;return e=n.sibling,t=$C(n,{mode:"visible",children:t}),0==(1&g.mode)&&(t.lanes=I),t.return=g,t.sibling=null,null!==e&&(null===(I=g.deletions)?(g.deletions=[e],g.flags|=16):I.push(e)),g.child=t}function $n(e,g,t,I,n){var i=g.mode,C=(e=e.child).sibling,o={mode:"hidden",children:t};return 0==(1&i)&&g.child!==e?((t=g.child).childLanes=0,t.pendingProps=o,g.deletions=null):(t=$C(e,o)).subtreeFlags=14680064&e.subtreeFlags,null!==C?I=$C(C,I):(I=go(I,i,n,null)).flags|=2,I.return=g,t.return=g,t.sibling=I,g.child=t,I}function ei(e,g,t,I){return null!==I&&$t(I),nI(g,e.child,null,t),(e=_n(g,g.pendingProps.children)).flags|=2,g.memoizedState=null,e}function gi(e,g,t){e.lanes|=g;var I=e.alternate;null!==I&&(I.lanes|=g),at(e.return,g,t)}function ti(e,g,t,I,n){var i=e.memoizedState;null===i?e.memoizedState={isBackwards:g,rendering:null,renderingStartTime:0,last:I,tail:t,tailMode:n}:(i.isBackwards=g,i.rendering=null,i.renderingStartTime=0,i.last=I,i.tail=t,i.tailMode=n)}function Ii(e,g,t){var I=g.pendingProps,n=I.revealOrder,i=I.tail;if(xn(e,g,I.children,t),0!=(2&(I=uI.current)))I=1&I|2,g.flags|=128;else{if(null!==e&&0!=(128&e.flags))e:for(e=g.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&gi(e,t,g);else if(19===e.tag)gi(e,t,g);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===g)break e;for(;null===e.sibling;){if(null===e.return||e.return===g)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}I&=1}if(ag(uI,I),0==(1&g.mode))g.memoizedState=null;else switch(n){case"forwards":for(t=g.child,n=null;null!==t;)null!==(e=t.alternate)&&null===hI(e)&&(n=t),t=t.sibling;null===(t=n)?(n=g.child,g.child=null):(n=t.sibling,t.sibling=null),ti(g,!1,n,t,i);break;case"backwards":for(t=null,n=g.child,g.child=null;null!==n;){if(null!==(e=n.alternate)&&null===hI(e)){g.child=n;break}e=n.sibling,n.sibling=t,t=n,n=e}ti(g,!0,t,null,i);break;case"together":ti(g,!1,null,null,void 0);break;default:g.memoizedState=null}return g.child}function ni(e,g,t){if(null!==e&&(g.dependencies=e.dependencies),gC|=g.lanes,0==(t&g.childLanes))return null;if(null!==e&&g.child!==e.child)throw Error(C(153));if(null!==g.child){for(t=$C(e=g.child,e.pendingProps),g.child=t,t.return=g;null!==e.sibling;)e=e.sibling,(t=t.sibling=$C(e,e.pendingProps)).return=g;t.sibling=null}return g.child}function ii(e,g){switch(Mt(g),g.tag){case 1:return dg(g.type)&&ug(),65536&(e=g.flags)?(g.flags=-65537&e|128,g):null;case 3:return AI(),og(rg),og(lg),mI(),0!=(65536&(e=g.flags))&&0==(128&e)?(g.flags=-65537&e|128,g):null;case 5:return dI(g),null;case 13:if(og(uI),null!==(e=g.memoizedState)&&null!==e.dehydrated){if(null===g.alternate)throw Error(C(340));qt()}return 65536&(e=g.flags)?(g.flags=-65537&e|128,g):null;case 19:return og(uI),null;case 4:return AI(),null;case 10:return ot(g.type._context),null;case 22:case 23:return SC(),null;default:return null}}var Ci=!1,oi=!1,ai="function"==typeof WeakSet?WeakSet:Set,si=null;function li(e,g){var t=e.ref;if(null!==t)if("function"==typeof t)try{t(null)}catch(t){TC(e,g,t)}else t.current=null}function ri(e,g,t){try{t()}catch(t){TC(e,g,t)}}var Ai=!1;function ci(e,g,t){var I=g.updateQueue;if(null!==(I=null!==I?I.lastEffect:null)){var n=I=I.next;do{if((n.tag&e)===e){var i=n.destroy;n.destroy=void 0,void 0!==i&&ri(g,t,i)}n=n.next}while(n!==I)}}function di(e,g){if(null!==(g=null!==(g=g.updateQueue)?g.lastEffect:null)){var t=g=g.next;do{if((t.tag&e)===e){var I=t.create;t.destroy=I()}t=t.next}while(t!==g)}}function ui(e){var g=e.ref;if(null!==g){var t=e.stateNode;e=5===e.tag?K(t):t,"function"==typeof g?g(e):g.current=e}}function hi(e,g,t){if(Tg&&"function"==typeof Tg.onCommitFiberUnmount)try{Tg.onCommitFiberUnmount(Eg,g)}catch(e){}switch(g.tag){case 0:case 11:case 14:case 15:if(null!==(e=g.updateQueue)&&null!==(e=e.lastEffect)){var I=e=e.next;do{var n=I,i=n.destroy;n=n.tag,void 0!==i&&(0!=(2&n)||0!=(4&n))&&ri(g,t,i),I=I.next}while(I!==e)}break;case 1:if(li(g,t),"function"==typeof(e=g.stateNode).componentWillUnmount)try{e.props=g.memoizedProps,e.state=g.memoizedState,e.componentWillUnmount()}catch(e){TC(g,t,e)}break;case 5:li(g,t);break;case 4:O?vi(e,g,t):j&&j&&(g=g.stateNode.containerInfo,t=we(g),Xe(g,t))}}function bi(e,g,t){for(var I=g;;)if(hi(e,I,t),null===I.child||O&&4===I.tag){if(I===g)break;for(;null===I.sibling;){if(null===I.return||I.return===g)return;I=I.return}I.sibling.return=I.return,I=I.sibling}else I.child.return=I,I=I.child}function mi(e){var g=e.alternate;null!==g&&(e.alternate=null,mi(g)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag&&null!==(g=e.stateNode)&&ee(g),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function pi(e){return 5===e.tag||3===e.tag||4===e.tag}function Gi(e){e:for(;;){for(;null===e.sibling;){if(null===e.return||pi(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;5!==e.tag&&6!==e.tag&&18!==e.tag;){if(2&e.flags)continue e;if(null===e.child||4===e.tag)continue e;e.child.return=e,e=e.child}if(!(2&e.flags))return e.stateNode}}function Bi(e){if(O){e:{for(var g=e.return;null!==g;){if(pi(g))break e;g=g.return}throw Error(C(160))}var t=g;switch(t.tag){case 5:g=t.stateNode,32&t.flags&&(Ge(g),t.flags&=-33),yi(e,t=Gi(e),g);break;case 3:case 4:g=t.stateNode.containerInfo,Zi(e,t=Gi(e),g);break;default:throw Error(C(161))}}}function Zi(e,g,t){var I=e.tag;if(5===I||6===I)e=e.stateNode,g?be(t,e,g):Ae(t,e);else if(4!==I&&null!==(e=e.child))for(Zi(e,g,t),e=e.sibling;null!==e;)Zi(e,g,t),e=e.sibling}function yi(e,g,t){var I=e.tag;if(5===I||6===I)e=e.stateNode,g?he(t,e,g):re(t,e);else if(4!==I&&null!==(e=e.child))for(yi(e,g,t),e=e.sibling;null!==e;)yi(e,g,t),e=e.sibling}function vi(e,g,t){for(var I,n,i=g,o=!1;;){if(!o){o=i.return;e:for(;;){if(null===o)throw Error(C(160));switch(I=o.stateNode,o.tag){case 5:n=!1;break e;case 3:case 4:I=I.containerInfo,n=!0;break e}o=o.return}o=!0}if(5===i.tag||6===i.tag)bi(e,i,t),n?pe(I,i.stateNode):me(I,i.stateNode);else if(18===i.tag)n?Pe(I,i.stateNode):je(I,i.stateNode);else if(4===i.tag){if(null!==i.child){I=i.stateNode.containerInfo,n=!0,i.child.return=i,i=i.child;continue}}else if(hi(e,i,t),null!==i.child){i.child.return=i,i=i.child;continue}if(i===g)break;for(;null===i.sibling;){if(null===i.return||i.return===g)return;4===(i=i.return).tag&&(o=!1)}i.sibling.return=i.return,i=i.sibling}}function Wi(e,g){if(O){switch(g.tag){case 0:case 11:case 14:case 15:return ci(3,g,g.return),di(3,g),void ci(5,g,g.return);case 1:case 12:case 17:return;case 5:var t=g.stateNode;if(null!=t){var I=g.memoizedProps;e=null!==e?e.memoizedProps:I;var n=g.type,i=g.updateQueue;g.updateQueue=null,null!==i&&ue(t,i,n,e,I,g)}return;case 6:if(null===g.stateNode)throw Error(C(162));return t=g.memoizedProps,void ce(g.stateNode,null!==e?e.memoizedProps:t,t);case 3:return void(P&&null!==e&&e.memoizedState.isDehydrated&&De(g.stateNode.containerInfo));case 13:case 19:return void fi(g)}throw Error(C(163))}switch(g.tag){case 0:case 11:case 14:case 15:return ci(3,g,g.return),di(3,g),void ci(5,g,g.return);case 12:case 22:case 23:return;case 13:case 19:return void fi(g);case 3:P&&null!==e&&e.memoizedState.isDehydrated&&De(g.stateNode.containerInfo)}e:if(j){switch(g.tag){case 1:case 5:case 6:break e;case 3:case 4:g=g.stateNode,Xe(g.containerInfo,g.pendingChildren);break e}throw Error(C(163))}}function fi(e){var g=e.updateQueue;if(null!==g){e.updateQueue=null;var t=e.stateNode;null===t&&(t=e.stateNode=new ai),g.forEach((function(g){var I=OC.bind(null,e,g);t.has(g)||(t.add(g),g.then(I,I))}))}}function wi(e,g,t){si=e,Ri(e,g,t)}function Ri(e,g,t){for(var I=0!=(1&e.mode);null!==si;){var n=si,i=n.child;if(22===n.tag&&I){var C=null!==n.memoizedState||Ci;if(!C){var o=n.alternate,a=null!==o&&null!==o.memoizedState||oi;o=Ci;var s=oi;if(Ci=C,(oi=a)&&!s)for(si=n;null!==si;)a=(C=si).child,22===C.tag&&null!==C.memoizedState?Si(n):null!==a?(a.return=C,si=a):Si(n);for(;null!==i;)si=i,Ri(i,g,t),i=i.sibling;si=n,Ci=o,oi=s}Vi(e)}else 0!=(8772&n.subtreeFlags)&&null!==i?(i.return=n,si=i):Vi(e)}}function Vi(e){for(;null!==si;){var g=si;if(0!=(8772&g.flags)){var t=g.alternate;try{if(0!=(8772&g.flags))switch(g.tag){case 0:case 11:case 15:oi||di(5,g);break;case 1:var I=g.stateNode;if(4&g.flags&&!oi)if(null===t)I.componentDidMount();else{var n=g.elementType===g.type?t.memoizedProps:et(g.type,t.memoizedProps);I.componentDidUpdate(n,t.memoizedState,I.__reactInternalSnapshotBeforeUpdate)}var i=g.updateQueue;null!==i&&Gt(g,i,I);break;case 3:var o=g.updateQueue;if(null!==o){if(t=null,null!==g.child)switch(g.child.tag){case 5:t=K(g.child.stateNode);break;case 1:t=g.child.stateNode}Gt(g,o,t)}break;case 5:var a=g.stateNode;null===t&&4&g.flags&&de(a,g.type,g.memoizedProps,g);break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:break;case 13:if(P&&null===g.memoizedState){var s=g.alternate;if(null!==s){var l=s.memoizedState;if(null!==l){var r=l.dehydrated;null!==r&&Oe(r)}}}break;default:throw Error(C(163))}oi||512&g.flags&&ui(g)}catch(e){TC(g,g.return,e)}}if(g===e){si=null;break}if(null!==(t=g.sibling)){t.return=g.return,si=t;break}si=g.return}}function Xi(e){for(;null!==si;){var g=si;if(g===e){si=null;break}var t=g.sibling;if(null!==t){t.return=g.return,si=t;break}si=g.return}}function Si(e){for(;null!==si;){var g=si;try{switch(g.tag){case 0:case 11:case 15:var t=g.return;try{di(4,g)}catch(e){TC(g,t,e)}break;case 1:var I=g.stateNode;if("function"==typeof I.componentDidMount){var n=g.return;try{I.componentDidMount()}catch(e){TC(g,n,e)}}var i=g.return;try{ui(g)}catch(e){TC(g,i,e)}break;case 5:var C=g.return;try{ui(g)}catch(e){TC(g,C,e)}}}catch(e){TC(g,g.return,e)}if(g===e){si=null;break}var o=g.sibling;if(null!==o){o.return=g.return,si=o;break}si=g.return}}var Yi=0,Ki=1,Hi=2,Ni=3,Fi=4;if("function"==typeof Symbol&&Symbol.for){var xi=Symbol.for;Yi=xi("selector.component"),Ki=xi("selector.has_pseudo_class"),Hi=xi("selector.role"),Ni=xi("selector.test_id"),Fi=xi("selector.text")}function zi(e){var g=_(e);if(null!=g){if("string"!=typeof g.memoizedProps["data-testname"])throw Error(C(364));return g}if(null===(e=ne(e)))throw Error(C(362));return e.stateNode.current}function ki(e,g){switch(g.$$typeof){case Yi:if(e.type===g.value)return!0;break;case Ki:e:{g=g.value,e=[e,0];for(var t=0;t<e.length;){var I=e[t++],n=e[t++],i=g[n];if(5!==I.tag||!oe(I)){for(;null!=i&&ki(I,i);)i=g[++n];if(n===g.length){g=!0;break e}for(I=I.child;null!==I;)e.push(I,n),I=I.sibling}}g=!1}return g;case Hi:if(5===e.tag&&ae(e.stateNode,g.value))return!0;break;case Fi:if((5===e.tag||6===e.tag)&&null!==(e=Ce(e))&&0<=e.indexOf(g.value))return!0;break;case Ni:if(5===e.tag&&"string"==typeof(e=e.memoizedProps["data-testname"])&&e.toLowerCase()===g.value.toLowerCase())return!0;break;default:throw Error(C(365))}return!1}function Mi(e){switch(e.$$typeof){case Yi:return"<"+(y(e.value)||"Unknown")+">";case Ki:return":has("+(Mi(e)||"")+")";case Hi:return'[role="'+e.value+'"]';case Fi:return'"'+e.value+'"';case Ni:return'[data-testname="'+e.value+'"]';default:throw Error(C(365))}}function Li(e,g){var t=[];e=[e,0];for(var I=0;I<e.length;){var n=e[I++],i=e[I++],C=g[i];if(5!==n.tag||!oe(n)){for(;null!=C&&ki(n,C);)C=g[++i];if(i===g.length)t.push(n);else for(n=n.child;null!==n;)e.push(n,i),n=n.sibling}}return t}function Ji(e,g){if(!Ie)throw Error(C(363));e=Li(e=zi(e),g),g=[],e=Array.from(e);for(var t=0;t<e.length;){var I=e[t++];if(5===I.tag)oe(I)||g.push(I.stateNode);else for(I=I.child;null!==I;)e.push(I),I=I.sibling}return g}var Ei=Math.ceil,Ti=o.ReactCurrentDispatcher,Ui=o.ReactCurrentOwner,Qi=o.ReactCurrentBatchConfig,Di=0,Oi=null,ji=null,Pi=0,_i=0,qi=Cg(0),$i=0,eC=null,gC=0,tC=0,IC=0,nC=null,iC=null,CC=0,oC=1/0;function aC(){oC=zg()+500}var sC,lC=!1,rC=null,AC=null,cC=!1,dC=null,uC=0,hC=0,bC=null,mC=-1,pC=0;function GC(){return 0!=(6&Di)?zg():-1!==mC?mC:mC=zg()}function BC(e){return 0==(1&e.mode)?1:0!=(2&Di)&&0!==Pi?Pi&-Pi:null!==_g.transition?(0===pC&&(e=yg,0==(4194240&(yg<<=1))&&(yg=64),pC=e),pC):0!==(e=Yg)?e:$()}function ZC(e,g,t){if(50<hC)throw hC=0,bC=null,Error(C(185));var I=yC(e,g);return null===I?null:(Xg(I,g,t),0!=(2&Di)&&I===Oi||(I===Oi&&(0==(2&Di)&&(tC|=g),4===$i&&RC(I,Pi)),vC(I,t),1===g&&0===Di&&0==(1&e.mode)&&(aC(),Dg&&Pg())),I)}function yC(e,g){e.lanes|=g;var t=e.alternate;for(null!==t&&(t.lanes|=g),t=e,e=e.return;null!==e;)e.childLanes|=g,null!==(t=e.alternate)&&(t.childLanes|=g),t=e,e=e.return;return 3===t.tag?t.stateNode:null}function vC(e,g){var t=e.callbackNode;!function(e,g){for(var t=e.suspendedLanes,I=e.pingedLanes,n=e.expirationTimes,i=e.pendingLanes;0<i;){var C=31-Gg(i),o=1<<C,a=n[C];-1===a?0!=(o&t)&&0==(o&I)||(n[C]=wg(o,g)):a<=g&&(e.expiredLanes|=o),i&=~o}}(e,g);var I=fg(e,e===Oi?Pi:0);if(0===I)null!==t&&Ng(t),e.callbackNode=null,e.callbackPriority=0;else if(g=I&-I,e.callbackPriority!==g){if(null!=t&&Ng(t),1===g)0===e.tag?function(e){Dg=!0,jg(e)}(VC.bind(null,e)):jg(VC.bind(null,e)),ge?te((function(){0===Di&&Pg()})):Hg(kg,Pg),t=null;else{switch(Kg(I)){case 1:t=kg;break;case 4:t=Mg;break;case 16:default:t=Lg;break;case 536870912:t=Jg}t=jC(t,WC.bind(null,e))}e.callbackPriority=g,e.callbackNode=t}}function WC(e,g){if(mC=-1,pC=0,0!=(6&Di))throw Error(C(327));var t=e.callbackNode;if(JC()&&e.callbackNode!==t)return null;var I=fg(e,e===Oi?Pi:0);if(0===I)return null;if(0!=(30&I)||0!=(I&e.expiredLanes)||g)g=FC(e,I);else{g=I;var n=Di;Di|=2;var i=HC();for(Oi===e&&Pi===g||(aC(),YC(e,g));;)try{zC();break}catch(g){KC(e,g)}it(),Ti.current=i,Di=n,null!==ji?g=0:(Oi=null,Pi=0,g=$i)}if(0!==g){if(2===g&&0!==(n=Rg(e))&&(I=n,g=fC(e,n)),1===g)throw t=eC,YC(e,0),RC(e,I),vC(e,zg()),t;if(6===g)RC(e,I);else{if(n=e.current.alternate,0==(30&I)&&!function(e){for(var g=e;;){if(16384&g.flags){var t=g.updateQueue;if(null!==t&&null!==(t=t.stores))for(var I=0;I<t.length;I++){var n=t[I],i=n.getSnapshot;n=n.value;try{if(!Ug(i(),n))return!1}catch(e){return!1}}}if(t=g.child,16384&g.subtreeFlags&&null!==t)t.return=g,g=t;else{if(g===e)break;for(;null===g.sibling;){if(null===g.return||g.return===e)return!0;g=g.return}g.sibling.return=g.return,g=g.sibling}}return!0}(n)&&(2===(g=FC(e,I))&&0!==(i=Rg(e))&&(I=i,g=fC(e,i)),1===g))throw t=eC,YC(e,0),RC(e,I),vC(e,zg()),t;switch(e.finishedWork=n,e.finishedLanes=I,g){case 0:case 1:throw Error(C(345));case 2:case 5:LC(e,iC);break;case 3:if(RC(e,I),(130023424&I)===I&&10<(g=CC+500-zg())){if(0!==fg(e,0))break;if(((n=e.suspendedLanes)&I)!==I){GC(),e.pingedLanes|=e.suspendedLanes&n;break}e.timeoutHandle=T(LC.bind(null,e,iC),g);break}LC(e,iC);break;case 4:if(RC(e,I),(4194240&I)===I)break;for(g=e.eventTimes,n=-1;0<I;){var o=31-Gg(I);i=1<<o,(o=g[o])>n&&(n=o),I&=~i}if(I=n,10<(I=(120>(I=zg()-I)?120:480>I?480:1080>I?1080:1920>I?1920:3e3>I?3e3:4320>I?4320:1960*Ei(I/1960))-I)){e.timeoutHandle=T(LC.bind(null,e,iC),I);break}LC(e,iC);break;default:throw Error(C(329))}}}return vC(e,zg()),e.callbackNode===t?WC.bind(null,e):null}function fC(e,g){var t=nC;return e.current.memoizedState.isDehydrated&&(YC(e,g).flags|=256),2!==(e=FC(e,g))&&(g=iC,iC=t,null!==g&&wC(g)),e}function wC(e){null===iC?iC=e:iC.push.apply(iC,e)}function RC(e,g){for(g&=~IC,g&=~tC,e.suspendedLanes|=g,e.pingedLanes&=~g,e=e.expirationTimes;0<g;){var t=31-Gg(g),I=1<<t;e[t]=-1,g&=~I}}function VC(e){if(0!=(6&Di))throw Error(C(327));JC();var g=fg(e,0);if(0==(1&g))return vC(e,zg()),null;var t=FC(e,g);if(0!==e.tag&&2===t){var I=Rg(e);0!==I&&(g=I,t=fC(e,I))}if(1===t)throw t=eC,YC(e,0),RC(e,g),vC(e,zg()),t;if(6===t)throw Error(C(345));return e.finishedWork=e.current.alternate,e.finishedLanes=g,LC(e,iC),vC(e,zg()),null}function XC(e){null!==dC&&0===dC.tag&&0==(6&Di)&&JC();var g=Di;Di|=1;var t=Qi.transition,I=Yg;try{if(Qi.transition=null,Yg=1,e)return e()}finally{Yg=I,Qi.transition=t,0==(6&(Di=g))&&Pg()}}function SC(){_i=qi.current,og(qi)}function YC(e,g){e.finishedWork=null,e.finishedLanes=0;var t=e.timeoutHandle;if(t!==Q&&(e.timeoutHandle=Q,U(t)),null!==ji)for(t=ji.return;null!==t;){var I=t;switch(Mt(I),I.tag){case 1:null!=(I=I.type.childContextTypes)&&ug();break;case 3:AI(),og(rg),og(lg),mI();break;case 5:dI(I);break;case 4:AI();break;case 13:case 19:og(uI);break;case 10:ot(I.type._context);break;case 22:case 23:SC()}t=t.return}if(Oi=e,ji=e=$C(e.current,null),Pi=_i=g,$i=0,eC=null,IC=tC=gC=0,iC=nC=null,null!==rt){for(g=0;g<rt.length;g++)if(null!==(I=(t=rt[g]).interleaved)){t.interleaved=null;var n=I.next,i=t.pending;if(null!==i){var C=i.next;i.next=n,I.next=C}t.pending=I}rt=null}return e}function KC(e,g){for(;;){var t=ji;try{if(it(),pI.current=cn,WI){for(var I=ZI.memoizedState;null!==I;){var n=I.queue;null!==n&&(n.pending=null),I=I.next}WI=!1}if(BI=0,vI=yI=ZI=null,fI=!1,wI=0,Ui.current=null,null===t||null===t.return){$i=1,eC=g,ji=null;break}e:{var i=e,o=t.return,a=t,s=g;if(g=Pi,a.flags|=32768,null!==s&&"object"==typeof s&&"function"==typeof s.then){var l=s,r=a,A=r.tag;if(0==(1&r.mode)&&(0===A||11===A||15===A)){var c=r.alternate;c?(r.updateQueue=c.updateQueue,r.memoizedState=c.memoizedState,r.lanes=c.lanes):(r.updateQueue=null,r.memoizedState=null)}var d=wn(o);if(null!==d){d.flags&=-257,Rn(d,o,a,0,g),1&d.mode&&fn(i,l,g),s=l;var u=(g=d).updateQueue;if(null===u){var h=new Set;h.add(s),g.updateQueue=h}else u.add(s);break e}if(0==(1&g)){fn(i,l,g),NC();break e}s=Error(C(426))}else if(Et&&1&a.mode){var b=wn(o);if(null!==b){0==(65536&b.flags)&&(b.flags|=256),Rn(b,o,a,0,g),$t(s);break e}}i=s,4!==$i&&($i=2),null===nC?nC=[i]:nC.push(i),s=bn(s,a),a=o;do{switch(a.tag){case 3:a.flags|=65536,g&=-g,a.lanes|=g,mt(a,vn(0,s,g));break e;case 1:i=s;var m=a.type,p=a.stateNode;if(0==(128&a.flags)&&("function"==typeof m.getDerivedStateFromError||null!==p&&"function"==typeof p.componentDidCatch&&(null===AC||!AC.has(p)))){a.flags|=65536,g&=-g,a.lanes|=g,mt(a,Wn(a,i,g));break e}}a=a.return}while(null!==a)}MC(t)}catch(e){g=e,ji===t&&null!==t&&(ji=t=t.return);continue}break}}function HC(){var e=Ti.current;return Ti.current=cn,null===e?cn:e}function NC(){0!==$i&&3!==$i&&2!==$i||($i=4),null===Oi||0==(268435455&gC)&&0==(268435455&tC)||RC(Oi,Pi)}function FC(e,g){var t=Di;Di|=2;var I=HC();for(Oi===e&&Pi===g||YC(e,g);;)try{xC();break}catch(g){KC(e,g)}if(it(),Di=t,Ti.current=I,null!==ji)throw Error(C(261));return Oi=null,Pi=0,$i}function xC(){for(;null!==ji;)kC(ji)}function zC(){for(;null!==ji&&!Fg();)kC(ji)}function kC(e){var g=sC(e.alternate,e,_i);e.memoizedProps=e.pendingProps,null===g?MC(e):ji=g,Ui.current=null}function MC(e){var g=e;do{var t=g.alternate;if(e=g.return,0==(32768&g.flags)){if(null!==(t=Hn(t,g,_i)))return void(ji=t)}else{if(null!==(t=ii(t,g)))return t.flags&=32767,void(ji=t);if(null===e)return $i=6,void(ji=null);e.flags|=32768,e.subtreeFlags=0,e.deletions=null}if(null!==(g=g.sibling))return void(ji=g);ji=g=e}while(null!==g);0===$i&&($i=5)}function LC(e,g){var t=Yg,I=Qi.transition;try{Qi.transition=null,Yg=1,function(e,g,t){do{JC()}while(null!==dC);if(0!=(6&Di))throw Error(C(327));var I=e.finishedWork,n=e.finishedLanes;if(null===I)return null;if(e.finishedWork=null,e.finishedLanes=0,I===e.current)throw Error(C(177));e.callbackNode=null,e.callbackPriority=0;var i=I.lanes|I.childLanes;if(function(e,g){var t=e.pendingLanes&~g;e.pendingLanes=g,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=g,e.mutableReadLanes&=g,e.entangledLanes&=g,g=e.entanglements;var I=e.eventTimes;for(e=e.expirationTimes;0<t;){var n=31-Gg(t),i=1<<n;g[n]=0,I[n]=-1,e[n]=-1,t&=~i}}(e,i),e===Oi&&(ji=Oi=null,Pi=0),0==(2064&I.subtreeFlags)&&0==(2064&I.flags)||cC||(cC=!0,jC(Lg,(function(){return JC(),null}))),i=0!=(15990&I.flags),0!=(15990&I.subtreeFlags)||i){i=Qi.transition,Qi.transition=null;var o=Yg;Yg=1;var a=Di;Di|=4,Ui.current=null,function(e,g){for(F(e.containerInfo),si=g;null!==si;)if(g=(e=si).child,0!=(1028&e.subtreeFlags)&&null!==g)g.return=e,si=g;else for(;null!==si;){e=si;try{var t=e.alternate;if(0!=(1024&e.flags))switch(e.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==t){var I=t.memoizedProps,n=t.memoizedState,i=e.stateNode,o=i.getSnapshotBeforeUpdate(e.elementType===e.type?I:et(e.type,I),n);i.__reactInternalSnapshotBeforeUpdate=o}break;case 3:O&&We(e.stateNode.containerInfo);break;default:throw Error(C(163))}}catch(g){TC(e,e.return,g)}if(null!==(g=e.sibling)){g.return=e.return,si=g;break}si=e.return}t=Ai,Ai=!1}(e,I),function(e,g){for(si=g;null!==si;){var t=(g=si).deletions;if(null!==t)for(var I=0;I<t.length;I++){var n=t[I];try{var i=e;O?vi(i,n,g):bi(i,n,g);var C=n.alternate;null!==C&&(C.return=null),n.return=null}catch(e){TC(n,g,e)}}if(t=g.child,0!=(12854&g.subtreeFlags)&&null!==t)t.return=g,si=t;else for(;null!==si;){g=si;try{var o=g.flags;if(32&o&&O&&Ge(g.stateNode),512&o){var a=g.alternate;if(null!==a){var s=a.ref;null!==s&&("function"==typeof s?s(null):s.current=null)}}if(8192&o)switch(g.tag){case 13:if(null!==g.memoizedState){var l=g.alternate;null!==l&&null!==l.memoizedState||(CC=zg())}break;case 22:var r=null!==g.memoizedState,A=g.alternate,c=null!==A&&null!==A.memoizedState;if(t=g,O)e:if(I=t,n=r,i=null,O)for(var d=I;;){if(5===d.tag){if(null===i){i=d;var u=d.stateNode;n?Be(u):ye(d.stateNode,d.memoizedProps)}}else if(6===d.tag){if(null===i){var h=d.stateNode;n?Ze(h):ve(h,d.memoizedProps)}}else if((22!==d.tag&&23!==d.tag||null===d.memoizedState||d===I)&&null!==d.child){d.child.return=d,d=d.child;continue}if(d===I)break;for(;null===d.sibling;){if(null===d.return||d.return===I)break e;i===d&&(i=null),d=d.return}i===d&&(i=null),d.sibling.return=d.return,d=d.sibling}if(r&&!c&&0!=(1&t.mode)){si=t;for(var b=t.child;null!==b;){for(t=si=b;null!==si;){var m=(I=si).child;switch(I.tag){case 0:case 11:case 14:case 15:ci(4,I,I.return);break;case 1:li(I,I.return);var p=I.stateNode;if("function"==typeof p.componentWillUnmount){var G=I.return;try{p.props=I.memoizedProps,p.state=I.memoizedState,p.componentWillUnmount()}catch(e){TC(I,G,e)}}break;case 5:li(I,I.return);break;case 22:if(null!==I.memoizedState){Xi(t);continue}}null!==m?(m.return=I,si=m):Xi(t)}b=b.sibling}}}switch(4102&o){case 2:Bi(g),g.flags&=-3;break;case 6:Bi(g),g.flags&=-3,Wi(g.alternate,g);break;case 4096:g.flags&=-4097;break;case 4100:g.flags&=-4097,Wi(g.alternate,g);break;case 4:Wi(g.alternate,g)}}catch(e){TC(g,g.return,e)}if(null!==(t=g.sibling)){t.return=g.return,si=t;break}si=g.return}}}(e,I),x(e.containerInfo),e.current=I,wi(I,e,n),xg(),Di=a,Yg=o,Qi.transition=i}else e.current=I;if(cC&&(cC=!1,dC=e,uC=n),0===(i=e.pendingLanes)&&(AC=null),function(e){if(Tg&&"function"==typeof Tg.onCommitFiberRoot)try{Tg.onCommitFiberRoot(Eg,e,void 0,128==(128&e.current.flags))}catch(e){}}(I.stateNode),vC(e,zg()),null!==g)for(t=e.onRecoverableError,I=0;I<g.length;I++)t(g[I]);if(lC)throw lC=!1,e=rC,rC=null,e;0!=(1&uC)&&0!==e.tag&&JC(),0!=(1&(i=e.pendingLanes))?e===bC?hC++:(hC=0,bC=e):hC=0,Pg()}(e,g,t)}finally{Qi.transition=I,Yg=t}return null}function JC(){if(null!==dC){var e=Kg(uC),g=Qi.transition,t=Yg;try{if(Qi.transition=null,Yg=16>e?16:e,null===dC)var I=!1;else{if(e=dC,dC=null,uC=0,0!=(6&Di))throw Error(C(331));var n=Di;for(Di|=4,si=e.current;null!==si;){var i=si,o=i.child;if(0!=(16&si.flags)){var a=i.deletions;if(null!==a){for(var s=0;s<a.length;s++){var l=a[s];for(si=l;null!==si;){var r=si;switch(r.tag){case 0:case 11:case 15:ci(8,r,i)}var A=r.child;if(null!==A)A.return=r,si=A;else for(;null!==si;){var c=(r=si).sibling,d=r.return;if(mi(r),r===l){si=null;break}if(null!==c){c.return=d,si=c;break}si=d}}}var u=i.alternate;if(null!==u){var h=u.child;if(null!==h){u.child=null;do{var b=h.sibling;h.sibling=null,h=b}while(null!==h)}}si=i}}if(0!=(2064&i.subtreeFlags)&&null!==o)o.return=i,si=o;else e:for(;null!==si;){if(0!=(2048&(i=si).flags))switch(i.tag){case 0:case 11:case 15:ci(9,i,i.return)}var m=i.sibling;if(null!==m){m.return=i.return,si=m;break e}si=i.return}}var p=e.current;for(si=p;null!==si;){var G=(o=si).child;if(0!=(2064&o.subtreeFlags)&&null!==G)G.return=o,si=G;else e:for(o=p;null!==si;){if(0!=(2048&(a=si).flags))try{switch(a.tag){case 0:case 11:case 15:di(9,a)}}catch(e){TC(a,a.return,e)}if(a===o){si=null;break e}var B=a.sibling;if(null!==B){B.return=a.return,si=B;break e}si=a.return}}if(Di=n,Pg(),Tg&&"function"==typeof Tg.onPostCommitFiberRoot)try{Tg.onPostCommitFiberRoot(Eg,e)}catch(e){}I=!0}return I}finally{Yg=t,Qi.transition=g}}return!1}function EC(e,g,t){ht(e,g=vn(0,g=bn(t,g),1)),g=GC(),null!==(e=yC(e,1))&&(Xg(e,1,g),vC(e,g))}function TC(e,g,t){if(3===e.tag)EC(e,e,t);else for(;null!==g;){if(3===g.tag){EC(g,e,t);break}if(1===g.tag){var I=g.stateNode;if("function"==typeof g.type.getDerivedStateFromError||"function"==typeof I.componentDidCatch&&(null===AC||!AC.has(I))){ht(g,e=Wn(g,e=bn(t,e),1)),e=GC(),null!==(g=yC(g,1))&&(Xg(g,1,e),vC(g,e));break}}g=g.return}}function UC(e,g,t){var I=e.pingCache;null!==I&&I.delete(g),g=GC(),e.pingedLanes|=e.suspendedLanes&t,Oi===e&&(Pi&t)===t&&(4===$i||3===$i&&(130023424&Pi)===Pi&&500>zg()-CC?YC(e,0):IC|=t),vC(e,g)}function QC(e,g){0===g&&(0==(1&e.mode)?g=1:(g=vg,0==(130023424&(vg<<=1))&&(vg=4194304)));var t=GC();null!==(e=yC(e,g))&&(Xg(e,g,t),vC(e,t))}function DC(e){var g=e.memoizedState,t=0;null!==g&&(t=g.retryLane),QC(e,t)}function OC(e,g){var t=0;switch(e.tag){case 13:var I=e.stateNode,n=e.memoizedState;null!==n&&(t=n.retryLane);break;case 19:I=e.stateNode;break;default:throw Error(C(314))}null!==I&&I.delete(g),QC(e,t)}function jC(e,g){return Hg(e,g)}function PC(e,g,t,I){this.tag=e,this.key=t,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=g,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=I,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function _C(e,g,t,I){return new PC(e,g,t,I)}function qC(e){return!(!(e=e.prototype)||!e.isReactComponent)}function $C(e,g){var t=e.alternate;return null===t?((t=_C(e.tag,g,e.key,e.mode)).elementType=e.elementType,t.type=e.type,t.stateNode=e.stateNode,t.alternate=e,e.alternate=t):(t.pendingProps=g,t.type=e.type,t.flags=0,t.subtreeFlags=0,t.deletions=null),t.flags=14680064&e.flags,t.childLanes=e.childLanes,t.lanes=e.lanes,t.child=e.child,t.memoizedProps=e.memoizedProps,t.memoizedState=e.memoizedState,t.updateQueue=e.updateQueue,g=e.dependencies,t.dependencies=null===g?null:{lanes:g.lanes,firstContext:g.firstContext},t.sibling=e.sibling,t.index=e.index,t.ref=e.ref,t}function eo(e,g,t,I,n,i){var o=2;if(I=e,"function"==typeof e)qC(e)&&(o=1);else if("string"==typeof e)o=5;else e:switch(e){case l:return go(t.children,n,i,g);case r:o=8,n|=8;break;case A:return(e=_C(12,t,g,2|n)).elementType=A,e.lanes=i,e;case h:return(e=_C(13,t,g,n)).elementType=h,e.lanes=i,e;case b:return(e=_C(19,t,g,n)).elementType=b,e.lanes=i,e;case G:return to(t,n,i,g);default:if("object"==typeof e&&null!==e)switch(e.$$typeof){case c:o=10;break e;case d:o=9;break e;case u:o=11;break e;case m:o=14;break e;case p:o=16,I=null;break e}throw Error(C(130,null==e?e:typeof e,""))}return(g=_C(o,t,g,n)).elementType=e,g.type=I,g.lanes=i,g}function go(e,g,t,I){return(e=_C(7,e,I,g)).lanes=t,e}function to(e,g,t,I){return(e=_C(22,e,I,g)).elementType=G,e.lanes=t,e.stateNode={},e}function Io(e,g,t){return(e=_C(6,e,null,g)).lanes=t,e}function no(e,g,t){return(g=_C(4,null!==e.children?e.children:[],e.key,g)).lanes=t,g.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},g}function io(e,g,t,I,n){this.tag=g,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=Q,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=Vg(0),this.expirationTimes=Vg(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Vg(0),this.identifierPrefix=I,this.onRecoverableError=n,P&&(this.mutableSourceEagerHydrationData=null)}function Co(e,g,t,I,n,i,C,o,a){return e=new io(e,g,t,o,a),1===g?(g=1,!0===i&&(g|=8)):g=0,i=_C(3,null,null,g),e.current=i,i.stateNode=e,i.memoizedState={element:I,isDehydrated:t,cache:null,transitions:null},ct(i),e}function oo(e){if(!e)return sg;e:{if(W(e=e._reactInternals)!==e||1!==e.tag)throw Error(C(170));var g=e;do{switch(g.tag){case 3:g=g.stateNode.context;break e;case 1:if(dg(g.type)){g=g.stateNode.__reactInternalMemoizedMergedChildContext;break e}}g=g.return}while(null!==g);throw Error(C(171))}if(1===e.tag){var t=e.type;if(dg(t))return bg(e,t,g)}return g}function ao(e){var g=e._reactInternals;if(void 0===g){if("function"==typeof e.render)throw Error(C(188));throw e=Object.keys(e).join(","),Error(C(268,e))}return null===(e=R(g))?null:e.stateNode}function so(e,g){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var t=e.retryLane;e.retryLane=0!==t&&t<g?t:g}}function lo(e,g){so(e,g),(e=e.alternate)&&so(e,g)}function ro(e){return null===(e=R(e))?null:e.stateNode}function Ao(){return null}return sC=function(e,g,t){if(null!==e)if(e.memoizedProps!==g.pendingProps||rg.current)Fn=!0;else{if(0==(e.lanes&t)&&0==(128&g.flags))return Fn=!1,function(e,g,t){switch(g.tag){case 3:Qn(g),qt();break;case 5:cI(g);break;case 1:dg(g.type)&&mg(g);break;case 4:rI(g,g.stateNode.containerInfo);break;case 10:Ct(0,g.type._context,g.memoizedProps.value);break;case 13:var I=g.memoizedState;if(null!==I)return null!==I.dehydrated?(ag(uI,1&uI.current),g.flags|=128,null):0!=(t&g.child.childLanes)?Pn(e,g,t):(ag(uI,1&uI.current),null!==(e=ni(e,g,t))?e.sibling:null);ag(uI,1&uI.current);break;case 19:if(I=0!=(t&g.childLanes),0!=(128&e.flags)){if(I)return Ii(e,g,t);g.flags|=128}var n=g.memoizedState;if(null!==n&&(n.rendering=null,n.tail=null,n.lastEffect=null),ag(uI,uI.current),I)break;return null;case 22:case 23:return g.lanes=0,Ln(e,g,t)}return ni(e,g,t)}(e,g,t);Fn=0!=(131072&e.flags)}else Fn=!1,Et&&0!=(1048576&g.flags)&&zt(g,St,g.index);switch(g.lanes=0,g.tag){case 2:var I=g.type;null!==e&&(e.alternate=null,g.alternate=null,g.flags|=2),e=g.pendingProps;var n=cg(g,lg.current);st(g,t),n=SI(null,g,I,e,n,t);var i=YI();return g.flags|=1,"object"==typeof n&&null!==n&&"function"==typeof n.render&&void 0===n.$$typeof?(g.tag=1,g.memoizedState=null,g.updateQueue=null,dg(I)?(i=!0,mg(g)):i=!1,g.memoizedState=null!==n.state&&void 0!==n.state?n.state:null,ct(g),n.updater=yt,g.stateNode=n,n._reactInternals=g,wt(g,I,e,t),g=Un(null,g,I,!0,i,t)):(g.tag=0,Et&&i&&kt(g),xn(null,g,n,t),g=g.child),g;case 16:I=g.elementType;e:{switch(null!==e&&(e.alternate=null,g.alternate=null,g.flags|=2),e=g.pendingProps,I=(n=I._init)(I._payload),g.type=I,n=g.tag=function(e){if("function"==typeof e)return qC(e)?1:0;if(null!=e){if((e=e.$$typeof)===u)return 11;if(e===m)return 14}return 2}(I),e=et(I,e),n){case 0:g=En(null,g,I,e,t);break e;case 1:g=Tn(null,g,I,e,t);break e;case 11:g=zn(null,g,I,e,t);break e;case 14:g=kn(null,g,I,et(I.type,e),t);break e}throw Error(C(306,I,""))}return g;case 0:return I=g.type,n=g.pendingProps,En(e,g,I,n=g.elementType===I?n:et(I,n),t);case 1:return I=g.type,n=g.pendingProps,Tn(e,g,I,n=g.elementType===I?n:et(I,n),t);case 3:e:{if(Qn(g),null===e)throw Error(C(387));I=g.pendingProps,n=(i=g.memoizedState).element,dt(e,g),pt(g,I,null,t);var o=g.memoizedState;if(I=o.element,P&&i.isDehydrated){if(i={element:I,isDehydrated:!1,cache:o.cache,transitions:o.transitions},g.updateQueue.baseState=i,g.memoizedState=i,256&g.flags){g=Dn(e,g,I,t,n=Error(C(423)));break e}if(I!==n){g=Dn(e,g,I,t,n=Error(C(424)));break e}for(P&&(Jt=Le(g.stateNode.containerInfo),Lt=g,Et=!0,Ut=null,Tt=!1),t=iI(g,null,I,t),g.child=t;t;)t.flags=-3&t.flags|4096,t=t.sibling}else{if(qt(),I===n){g=ni(e,g,t);break e}xn(e,g,I,t)}g=g.child}return g;case 5:return cI(g),null===e&&jt(g),I=g.type,n=g.pendingProps,i=null!==e?e.memoizedProps:null,o=n.children,J(I,n)?o=null:null!==i&&J(I,i)&&(g.flags|=32),Jn(e,g),xn(e,g,o,t),g.child;case 6:return null===e&&jt(g),null;case 13:return Pn(e,g,t);case 4:return rI(g,g.stateNode.containerInfo),I=g.pendingProps,null===e?g.child=nI(g,null,I,t):xn(e,g,I,t),g.child;case 11:return I=g.type,n=g.pendingProps,zn(e,g,I,n=g.elementType===I?n:et(I,n),t);case 7:return xn(e,g,g.pendingProps,t),g.child;case 8:case 12:return xn(e,g,g.pendingProps.children,t),g.child;case 10:e:{if(I=g.type._context,n=g.pendingProps,i=g.memoizedProps,Ct(0,I,o=n.value),null!==i)if(Ug(i.value,o)){if(i.children===n.children&&!rg.current){g=ni(e,g,t);break e}}else for(null!==(i=g.child)&&(i.return=g);null!==i;){var a=i.dependencies;if(null!==a){o=i.child;for(var s=a.firstContext;null!==s;){if(s.context===I){if(1===i.tag){(s=ut(-1,t&-t)).tag=2;var l=i.updateQueue;if(null!==l){var r=(l=l.shared).pending;null===r?s.next=s:(s.next=r.next,r.next=s),l.pending=s}}i.lanes|=t,null!==(s=i.alternate)&&(s.lanes|=t),at(i.return,t,g),a.lanes|=t;break}s=s.next}}else if(10===i.tag)o=i.type===g.type?null:i.child;else if(18===i.tag){if(null===(o=i.return))throw Error(C(341));o.lanes|=t,null!==(a=o.alternate)&&(a.lanes|=t),at(o,t,g),o=i.sibling}else o=i.child;if(null!==o)o.return=i;else for(o=i;null!==o;){if(o===g){o=null;break}if(null!==(i=o.sibling)){i.return=o.return,o=i;break}o=o.return}i=o}xn(e,g,n.children,t),g=g.child}return g;case 9:return n=g.type,I=g.pendingProps.children,st(g,t),I=I(n=lt(n)),g.flags|=1,xn(e,g,I,t),g.child;case 14:return n=et(I=g.type,g.pendingProps),kn(e,g,I,n=et(I.type,n),t);case 15:return Mn(e,g,g.type,g.pendingProps,t);case 17:return I=g.type,n=g.pendingProps,n=g.elementType===I?n:et(I,n),null!==e&&(e.alternate=null,g.alternate=null,g.flags|=2),g.tag=1,dg(I)?(e=!0,mg(g)):e=!1,st(g,t),Wt(g,I,n),wt(g,I,n,t),Un(null,g,I,!0,e,t);case 19:return Ii(e,g,t);case 22:return Ln(e,g,t)}throw Error(C(156,g.tag))},g.attemptContinuousHydration=function(e){13===e.tag&&(ZC(e,134217728,GC()),lo(e,134217728))},g.attemptHydrationAtCurrentPriority=function(e){if(13===e.tag){var g=GC(),t=BC(e);ZC(e,t,g),lo(e,t)}},g.attemptSynchronousHydration=function(e){switch(e.tag){case 3:var g=e.stateNode;if(g.current.memoizedState.isDehydrated){var t=Wg(g.pendingLanes);0!==t&&(Sg(g,1|t),vC(g,zg()),0==(6&Di)&&(aC(),Pg()))}break;case 13:var I=GC();XC((function(){return ZC(e,1,I)})),lo(e,1)}},g.batchedUpdates=function(e,g){var t=Di;Di|=1;try{return e(g)}finally{0===(Di=t)&&(aC(),Dg&&Pg())}},g.createComponentSelector=function(e){return{$$typeof:Yi,value:e}},g.createContainer=function(e,g,t,I,n,i,C){return Co(e,g,!1,null,0,I,0,i,C)},g.createHasPseudoClassSelector=function(e){return{$$typeof:Ki,value:e}},g.createHydrationContainer=function(e,g,t,I,n,i,C,o,a){return(e=Co(t,I,!0,e,0,i,0,o,a)).context=oo(null),t=e.current,(i=ut(I=GC(),n=BC(t))).callback=null!=g?g:null,ht(t,i),e.current.lanes=n,Xg(e,n,I),vC(e,I),e},g.createPortal=function(e,g,t){var I=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:s,key:null==I?null:""+I,children:e,containerInfo:g,implementation:t}},g.createRoleSelector=function(e){return{$$typeof:Hi,value:e}},g.createTestNameSelector=function(e){return{$$typeof:Ni,value:e}},g.createTextSelector=function(e){return{$$typeof:Fi,value:e}},g.deferredUpdates=function(e){var g=Yg,t=Qi.transition;try{return Qi.transition=null,Yg=16,e()}finally{Yg=g,Qi.transition=t}},g.discreteUpdates=function(e,g,t,I,n){var i=Yg,C=Qi.transition;try{return Qi.transition=null,Yg=1,e(g,t,I,n)}finally{Yg=i,Qi.transition=C,0===Di&&aC()}},g.findAllNodes=Ji,g.findBoundingRects=function(e,g){if(!Ie)throw Error(C(363));g=Ji(e,g),e=[];for(var t=0;t<g.length;t++)e.push(ie(g[t]));for(g=e.length-1;0<g;g--)for(var I=(t=e[g]).x,n=I+t.width,i=t.y,o=i+t.height,a=g-1;0<=a;a--)if(g!==a){var s=e[a],l=s.x,r=l+s.width,A=s.y,c=A+s.height;if(I>=l&&i>=A&&n<=r&&o<=c){e.splice(g,1);break}if(!(I!==l||t.width!==s.width||c<i||A>o)){A>i&&(s.height+=A-i,s.y=i),c<o&&(s.height=o-A),e.splice(g,1);break}if(!(i!==A||t.height!==s.height||r<I||l>n)){l>I&&(s.width+=l-I,s.x=I),r<n&&(s.width=n-l),e.splice(g,1);break}}return e},g.findHostInstance=ao,g.findHostInstanceWithNoPortals=function(e){return null===(e=null!==(e=w(e))?X(e):null)?null:e.stateNode},g.findHostInstanceWithWarning=function(e){return ao(e)},g.flushControlled=function(e){var g=Di;Di|=1;var t=Qi.transition,I=Yg;try{Qi.transition=null,Yg=1,e()}finally{Yg=I,Qi.transition=t,0===(Di=g)&&(aC(),Pg())}},g.flushPassiveEffects=JC,g.flushSync=XC,g.focusWithin=function(e,g){if(!Ie)throw Error(C(363));for(g=Li(e=zi(e),g),g=Array.from(g),e=0;e<g.length;){var t=g[e++];if(!oe(t)){if(5===t.tag&&se(t.stateNode))return!0;for(t=t.child;null!==t;)g.push(t),t=t.sibling}}return!1},g.getCurrentUpdatePriority=function(){return Yg},g.getFindAllNodesFailureDescription=function(e,g){if(!Ie)throw Error(C(363));var t=0,I=[];e=[zi(e),0];for(var n=0;n<e.length;){var i=e[n++],o=e[n++],a=g[o];if((5!==i.tag||!oe(i))&&(ki(i,a)&&(I.push(Mi(a)),++o>t&&(t=o)),o<g.length))for(i=i.child;null!==i;)e.push(i,o),i=i.sibling}if(t<g.length){for(e=[];t<g.length;t++)e.push(Mi(g[t]));return"findAllNodes was able to match part of the selector:\n  "+I.join(" > ")+"\n\nNo matching component was found for:\n  "+e.join(" > ")}return null},g.getPublicRootInstance=function(e){return(e=e.current).child?5===e.child.tag?K(e.child.stateNode):e.child.stateNode:null},g.injectIntoDevTools=function(e){if(e={bundleType:e.bundleType,version:e.version,rendererPackageName:e.rendererPackageName,rendererConfig:e.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:o.ReactCurrentDispatcher,findHostInstanceByFiber:ro,findFiberByHostInstance:e.findFiberByHostInstance||Ao,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.0.0-fc46dba67-20220329"},"undefined"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)e=!1;else{var g=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(g.isDisabled||!g.supportsFiber)e=!0;else{try{Eg=g.inject(e),Tg=g}catch(e){}e=!!g.checkDCE}}return e},g.isAlreadyRendering=function(){return!1},g.observeVisibleRects=function(e,g,t,I){if(!Ie)throw Error(C(363));e=Ji(e,g);var n=le(e,t,I).disconnect;return{disconnect:function(){n()}}},g.registerMutableSourceForHydration=function(e,g){var t=g._getVersion;t=t(g._source),null==e.mutableSourceEagerHydrationData?e.mutableSourceEagerHydrationData=[g,t]:e.mutableSourceEagerHydrationData.push(g,t)},g.runWithPriority=function(e,g){var t=Yg;try{return Yg=e,g()}finally{Yg=t}},g.shouldError=function(){return null},g.shouldSuspend=function(){return!1},g.updateContainer=function(e,g,t,I){var n=g.current,i=GC(),C=BC(n);return t=oo(t),null===g.context?g.context=t:g.pendingContext=t,(g=ut(i,C)).payload={element:e},null!==(I=void 0===I?null:I)&&(g.callback=I),ht(n,g),null!==(e=ZC(n,C,i))&&bt(e,n,C),C},g}},576:(e,g,t)=>{"use strict";e.exports=t(511)},525:(e,g,t)=>{"use strict";e.exports=t(287)},251:(e,g,t)=>{"use strict";var I=t(294),n=Symbol.for("react.element"),i=Symbol.for("react.fragment"),C=Object.prototype.hasOwnProperty,o=I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,a={key:!0,ref:!0,__self:!0,__source:!0};function s(e,g,t){var I,i={},s=null,l=null;for(I in void 0!==t&&(s=""+t),void 0!==g.key&&(s=""+g.key),void 0!==g.ref&&(l=g.ref),g)C.call(g,I)&&!a.hasOwnProperty(I)&&(i[I]=g[I]);if(e&&e.defaultProps)for(I in g=e.defaultProps)void 0===i[I]&&(i[I]=g[I]);return{$$typeof:n,type:e,key:s,ref:l,props:i,_owner:o.current}}g.Fragment=i,g.jsx=s,g.jsxs=s},408:(e,g)=>{"use strict";var t=Symbol.for("react.element"),I=Symbol.for("react.portal"),n=Symbol.for("react.fragment"),i=Symbol.for("react.strict_mode"),C=Symbol.for("react.profiler"),o=Symbol.for("react.provider"),a=Symbol.for("react.context"),s=Symbol.for("react.forward_ref"),l=Symbol.for("react.suspense"),r=Symbol.for("react.memo"),A=Symbol.for("react.lazy"),c=Symbol.iterator,d={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},u=Object.assign,h={};function b(e,g,t){this.props=e,this.context=g,this.refs=h,this.updater=t||d}function m(){}function p(e,g,t){this.props=e,this.context=g,this.refs=h,this.updater=t||d}b.prototype.isReactComponent={},b.prototype.setState=function(e,g){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,g,"setState")},b.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},m.prototype=b.prototype;var G=p.prototype=new m;G.constructor=p,u(G,b.prototype),G.isPureReactComponent=!0;var B=Array.isArray,Z=Object.prototype.hasOwnProperty,y={current:null},v={key:!0,ref:!0,__self:!0,__source:!0};function W(e,g,I){var n,i={},C=null,o=null;if(null!=g)for(n in void 0!==g.ref&&(o=g.ref),void 0!==g.key&&(C=""+g.key),g)Z.call(g,n)&&!v.hasOwnProperty(n)&&(i[n]=g[n]);var a=arguments.length-2;if(1===a)i.children=I;else if(1<a){for(var s=Array(a),l=0;l<a;l++)s[l]=arguments[l+2];i.children=s}if(e&&e.defaultProps)for(n in a=e.defaultProps)void 0===i[n]&&(i[n]=a[n]);return{$$typeof:t,type:e,key:C,ref:o,props:i,_owner:y.current}}function f(e){return"object"==typeof e&&null!==e&&e.$$typeof===t}var w=/\/+/g;function R(e,g){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var g={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return g[e]}))}(""+e.key):g.toString(36)}function V(e,g,n,i,C){var o=typeof e;"undefined"!==o&&"boolean"!==o||(e=null);var a=!1;if(null===e)a=!0;else switch(o){case"string":case"number":a=!0;break;case"object":switch(e.$$typeof){case t:case I:a=!0}}if(a)return C=C(a=e),e=""===i?"."+R(a,0):i,B(C)?(n="",null!=e&&(n=e.replace(w,"$&/")+"/"),V(C,g,n,"",(function(e){return e}))):null!=C&&(f(C)&&(C=function(e,g){return{$$typeof:t,type:e.type,key:g,ref:e.ref,props:e.props,_owner:e._owner}}(C,n+(!C.key||a&&a.key===C.key?"":(""+C.key).replace(w,"$&/")+"/")+e)),g.push(C)),1;if(a=0,i=""===i?".":i+":",B(e))for(var s=0;s<e.length;s++){var l=i+R(o=e[s],s);a+=V(o,g,n,l,C)}else if(l=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=c&&e[c]||e["@@iterator"])?e:null}(e),"function"==typeof l)for(e=l.call(e),s=0;!(o=e.next()).done;)a+=V(o=o.value,g,n,l=i+R(o,s++),C);else if("object"===o)throw g=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===g?"object with keys {"+Object.keys(e).join(", ")+"}":g)+"). If you meant to render a collection of children, use an array instead.");return a}function X(e,g,t){if(null==e)return e;var I=[],n=0;return V(e,I,"","",(function(e){return g.call(t,e,n++)})),I}function S(e){if(-1===e._status){var g=e._result;(g=g()).then((function(g){0!==e._status&&-1!==e._status||(e._status=1,e._result=g)}),(function(g){0!==e._status&&-1!==e._status||(e._status=2,e._result=g)})),-1===e._status&&(e._status=0,e._result=g)}if(1===e._status)return e._result.default;throw e._result}var Y={current:null},K={transition:null},H={ReactCurrentDispatcher:Y,ReactCurrentBatchConfig:K,ReactCurrentOwner:y};g.Children={map:X,forEach:function(e,g,t){X(e,(function(){g.apply(this,arguments)}),t)},count:function(e){var g=0;return X(e,(function(){g++})),g},toArray:function(e){return X(e,(function(e){return e}))||[]},only:function(e){if(!f(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},g.Component=b,g.Fragment=n,g.Profiler=C,g.PureComponent=p,g.StrictMode=i,g.Suspense=l,g.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=H,g.cloneElement=function(e,g,I){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var n=u({},e.props),i=e.key,C=e.ref,o=e._owner;if(null!=g){if(void 0!==g.ref&&(C=g.ref,o=y.current),void 0!==g.key&&(i=""+g.key),e.type&&e.type.defaultProps)var a=e.type.defaultProps;for(s in g)Z.call(g,s)&&!v.hasOwnProperty(s)&&(n[s]=void 0===g[s]&&void 0!==a?a[s]:g[s])}var s=arguments.length-2;if(1===s)n.children=I;else if(1<s){a=Array(s);for(var l=0;l<s;l++)a[l]=arguments[l+2];n.children=a}return{$$typeof:t,type:e.type,key:i,ref:C,props:n,_owner:o}},g.createContext=function(e){return(e={$$typeof:a,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:o,_context:e},e.Consumer=e},g.createElement=W,g.createFactory=function(e){var g=W.bind(null,e);return g.type=e,g},g.createRef=function(){return{current:null}},g.forwardRef=function(e){return{$$typeof:s,render:e}},g.isValidElement=f,g.lazy=function(e){return{$$typeof:A,_payload:{_status:-1,_result:e},_init:S}},g.memo=function(e,g){return{$$typeof:r,type:e,compare:void 0===g?null:g}},g.startTransition=function(e){var g=K.transition;K.transition={};try{e()}finally{K.transition=g}},g.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},g.useCallback=function(e,g){return Y.current.useCallback(e,g)},g.useContext=function(e){return Y.current.useContext(e)},g.useDebugValue=function(){},g.useDeferredValue=function(e){return Y.current.useDeferredValue(e)},g.useEffect=function(e,g){return Y.current.useEffect(e,g)},g.useId=function(){return Y.current.useId()},g.useImperativeHandle=function(e,g,t){return Y.current.useImperativeHandle(e,g,t)},g.useInsertionEffect=function(e,g){return Y.current.useInsertionEffect(e,g)},g.useLayoutEffect=function(e,g){return Y.current.useLayoutEffect(e,g)},g.useMemo=function(e,g){return Y.current.useMemo(e,g)},g.useReducer=function(e,g,t){return Y.current.useReducer(e,g,t)},g.useRef=function(e){return Y.current.useRef(e)},g.useState=function(e){return Y.current.useState(e)},g.useSyncExternalStore=function(e,g,t){return Y.current.useSyncExternalStore(e,g,t)},g.useTransition=function(){return Y.current.useTransition()},g.version="18.2.0"},294:(e,g,t)=>{"use strict";e.exports=t(408)},893:(e,g,t)=>{"use strict";e.exports=t(251)},53:(e,g)=>{"use strict";function t(e,g){var t=e.length;e.push(g);e:for(;0<t;){var I=t-1>>>1,n=e[I];if(!(0<i(n,g)))break e;e[I]=g,e[t]=n,t=I}}function I(e){return 0===e.length?null:e[0]}function n(e){if(0===e.length)return null;var g=e[0],t=e.pop();if(t!==g){e[0]=t;e:for(var I=0,n=e.length,C=n>>>1;I<C;){var o=2*(I+1)-1,a=e[o],s=o+1,l=e[s];if(0>i(a,t))s<n&&0>i(l,a)?(e[I]=l,e[s]=t,I=s):(e[I]=a,e[o]=t,I=o);else{if(!(s<n&&0>i(l,t)))break e;e[I]=l,e[s]=t,I=s}}}return g}function i(e,g){var t=e.sortIndex-g.sortIndex;return 0!==t?t:e.id-g.id}if("object"==typeof performance&&"function"==typeof performance.now){var C=performance;g.unstable_now=function(){return C.now()}}else{var o=Date,a=o.now();g.unstable_now=function(){return o.now()-a}}var s=[],l=[],r=1,A=null,c=3,d=!1,u=!1,h=!1,b="function"==typeof setTimeout?setTimeout:null,m="function"==typeof clearTimeout?clearTimeout:null,p="undefined"!=typeof setImmediate?setImmediate:null;function G(e){for(var g=I(l);null!==g;){if(null===g.callback)n(l);else{if(!(g.startTime<=e))break;n(l),g.sortIndex=g.expirationTime,t(s,g)}g=I(l)}}function B(e){if(h=!1,G(e),!u)if(null!==I(s))u=!0,K(Z);else{var g=I(l);null!==g&&H(B,g.startTime-e)}}function Z(e,t){u=!1,h&&(h=!1,m(f),f=-1),d=!0;var i=c;try{for(G(t),A=I(s);null!==A&&(!(A.expirationTime>t)||e&&!V());){var C=A.callback;if("function"==typeof C){A.callback=null,c=A.priorityLevel;var o=C(A.expirationTime<=t);t=g.unstable_now(),"function"==typeof o?A.callback=o:A===I(s)&&n(s),G(t)}else n(s);A=I(s)}if(null!==A)var a=!0;else{var r=I(l);null!==r&&H(B,r.startTime-t),a=!1}return a}finally{A=null,c=i,d=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var y,v=!1,W=null,f=-1,w=5,R=-1;function V(){return!(g.unstable_now()-R<w)}function X(){if(null!==W){var e=g.unstable_now();R=e;var t=!0;try{t=W(!0,e)}finally{t?y():(v=!1,W=null)}}else v=!1}if("function"==typeof p)y=function(){p(X)};else if("undefined"!=typeof MessageChannel){var S=new MessageChannel,Y=S.port2;S.port1.onmessage=X,y=function(){Y.postMessage(null)}}else y=function(){b(X,0)};function K(e){W=e,v||(v=!0,y())}function H(e,t){f=b((function(){e(g.unstable_now())}),t)}g.unstable_IdlePriority=5,g.unstable_ImmediatePriority=1,g.unstable_LowPriority=4,g.unstable_NormalPriority=3,g.unstable_Profiling=null,g.unstable_UserBlockingPriority=2,g.unstable_cancelCallback=function(e){e.callback=null},g.unstable_continueExecution=function(){u||d||(u=!0,K(Z))},g.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):w=0<e?Math.floor(1e3/e):5},g.unstable_getCurrentPriorityLevel=function(){return c},g.unstable_getFirstCallbackNode=function(){return I(s)},g.unstable_next=function(e){switch(c){case 1:case 2:case 3:var g=3;break;default:g=c}var t=c;c=g;try{return e()}finally{c=t}},g.unstable_pauseExecution=function(){},g.unstable_requestPaint=function(){},g.unstable_runWithPriority=function(e,g){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var t=c;c=e;try{return g()}finally{c=t}},g.unstable_scheduleCallback=function(e,n,i){var C=g.unstable_now();switch(i="object"==typeof i&&null!==i&&"number"==typeof(i=i.delay)&&0<i?C+i:C,e){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return e={id:r++,callback:n,priorityLevel:e,startTime:i,expirationTime:o=i+o,sortIndex:-1},i>C?(e.sortIndex=i,t(l,e),null===I(s)&&e===I(l)&&(h?(m(f),f=-1):h=!0,H(B,i-C))):(e.sortIndex=o,t(s,e),u||d||(u=!0,K(Z))),e},g.unstable_shouldYield=V,g.unstable_wrapCallback=function(e){var g=c;return function(){var t=c;c=g;try{return e.apply(this,arguments)}finally{c=t}}}},840:(e,g,t)=>{"use strict";e.exports=t(53)},86:(e,g,t)=>{"use strict";var I=t(853),n=t(919),i=t(299),C=t(642);function o(e){return"__proto__"!==e&&"constructor"!==e&&"prototype"!==e}e.exports=function(e,g,t){if(!C(e))return e;if(Array.isArray(g)&&(g=[].concat.apply([],g).join(".")),"string"!=typeof g)return e;for(var a=I(g,{sep:".",brackets:!0}).filter(o),s=a.length,l=-1,r=e;++l<s;){var A=a[l];l===s-1?i(r[A])&&i(t)?r[A]=n({},r[A],t):r[A]=t:(C(r[A])||(r[A]={}),r=r[A])}return e}},642:e=>{"use strict";e.exports=function(e){return null!=e&&("object"==typeof e||"function"==typeof e)}},853:(e,g,t)=>{"use strict";var I=t(71);function n(e,g,t,I){var i=e.indexOf(g,t);return"\\"===e.charAt(i-1)?n(e,g,i+1):i}function i(e,g){return!0===g.keepDoubleQuotes&&'"'===e||!0===g.keepSingleQuotes&&"'"===e||g.keepQuotes}function C(e,g,t){return"function"==typeof e.keepEscaping?e.keepEscaping(g,t):!0===e.keepEscaping||"\\"===g[t+1]}e.exports=function(e,g,t){if("string"!=typeof e)throw new TypeError("expected a string");"function"==typeof g&&(t=g,g=null),"string"==typeof g&&(g={sep:g});var o,a=I({sep:"."},g),s=a.quotes||['"',"'","`"];!0===a.brackets?o={"<":">","(":")","[":"]","{":"}"}:a.brackets&&(o=a.brackets);var l,r=[],A=[],c=[""],d=a.sep,u=e.length,h=-1;function b(){if(o&&A.length)return o[A[A.length-1]]}for(;++h<u;){var m=e[h],p=e[h+1],G={val:m,idx:h,arr:c,str:e};if(r.push(G),"\\"!==m){if(o&&o[m]){A.push(m);var B=b(),Z=h+1;if(-1!==e.indexOf(B,Z+1))for(;A.length&&Z<u;){var y=e[++Z];if("\\"!==y)if(-1===s.indexOf(y)){if(B=b(),A.length&&-1===e.indexOf(B,Z+1))break;o[y]?A.push(y):B===y&&A.pop()}else Z=n(e,y,Z+1);else y++}if(-1===(l=Z)){c[c.length-1]+=m;continue}m=e.slice(h,l+1),G.val=m,G.idx=h=l}if(-1!==s.indexOf(m)){if(-1===(l=n(e,m,h+1))){c[c.length-1]+=m;continue}m=!0===i(m,a)?e.slice(h,l+1):e.slice(h+1,l),G.val=m,G.idx=h=l}"function"==typeof t&&(t(G,r),m=G.val,h=G.idx),G.val!==d||!1===G.split?c[c.length-1]+=G.val:c.push("")}else G.val=!0===C(a,e,h)?m+p:p,G.escaped=!0,"function"==typeof t&&t(G),c[c.length-1]+=G.val,h++}return c}},71:(e,g,t)=>{"use strict";var I=t(833),n=t(52);function i(e,g){for(var t in g)s(g,t)&&(e[t]=g[t])}function C(e){return e&&"string"==typeof e}function o(e){var g={};for(var t in e)g[t]=e[t];return g}function a(e){return e&&"object"==typeof e||I(e)}function s(e,g){return Object.prototype.hasOwnProperty.call(e,g)}e.exports=Object.assign||function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");a(e)||(e={});for(var g=1;g<arguments.length;g++){var t=arguments[g];C(t)&&(t=o(t)),a(t)&&(i(e,t),n(e,t))}return e}},466:function(e){var g;e.exports=((g=function(){function e(e){return n.appendChild(e.dom),e}function t(e){for(var g=0;g<n.children.length;g++)n.children[g].style.display=g===e?"block":"none";I=e}var I=0,n=document.createElement("div");n.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",n.addEventListener("click",(function(e){e.preventDefault(),t(++I%n.children.length)}),!1);var i=(performance||Date).now(),C=i,o=0,a=e(new g.Panel("FPS","#0ff","#002")),s=e(new g.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var l=e(new g.Panel("MB","#f08","#201"));return t(0),{REVISION:16,dom:n,addPanel:e,showPanel:t,begin:function(){i=(performance||Date).now()},end:function(){o++;var e=(performance||Date).now();if(s.update(e-i,200),e>C+1e3&&(a.update(1e3*o/(e-C),100),C=e,o=0,l)){var g=performance.memory;l.update(g.usedJSHeapSize/1048576,g.jsHeapSizeLimit/1048576)}return e},update:function(){i=this.end()},domElement:n,setMode:t}}).Panel=function(e,g,t){var I=1/0,n=0,i=Math.round,C=i(window.devicePixelRatio||1),o=80*C,a=48*C,s=3*C,l=2*C,r=3*C,A=15*C,c=74*C,d=30*C,u=document.createElement("canvas");u.width=o,u.height=a,u.style.cssText="width:80px;height:48px";var h=u.getContext("2d");return h.font="bold "+9*C+"px Helvetica,Arial,sans-serif",h.textBaseline="top",h.fillStyle=t,h.fillRect(0,0,o,a),h.fillStyle=g,h.fillText(e,s,l),h.fillRect(r,A,c,d),h.fillStyle=t,h.globalAlpha=.9,h.fillRect(r,A,c,d),{dom:u,update:function(a,b){I=Math.min(I,a),n=Math.max(n,a),h.fillStyle=t,h.globalAlpha=1,h.fillRect(0,0,o,A),h.fillStyle=g,h.fillText(i(a)+" "+e+" ("+i(I)+"-"+i(n)+")",s,l),h.drawImage(u,r+C,A,c-C,d,r,A,c-C,d),h.fillRect(r+c-C,A,C,d),h.fillStyle=t,h.globalAlpha=.9,h.fillRect(r+c-C,A,C,i((1-a/b)*d))}}},g)},379:e=>{"use strict";var g=[];function t(e){for(var t=-1,I=0;I<g.length;I++)if(g[I].identifier===e){t=I;break}return t}function I(e,I){for(var i={},C=[],o=0;o<e.length;o++){var a=e[o],s=I.base?a[0]+I.base:a[0],l=i[s]||0,r="".concat(s," ").concat(l);i[s]=l+1;var A=t(r),c={css:a[1],media:a[2],sourceMap:a[3],supports:a[4],layer:a[5]};if(-1!==A)g[A].references++,g[A].updater(c);else{var d=n(c,I);I.byIndex=o,g.splice(o,0,{identifier:r,updater:d,references:1})}C.push(r)}return C}function n(e,g){var t=g.domAPI(g);return t.update(e),function(g){if(g){if(g.css===e.css&&g.media===e.media&&g.sourceMap===e.sourceMap&&g.supports===e.supports&&g.layer===e.layer)return;t.update(e=g)}else t.remove()}}e.exports=function(e,n){var i=I(e=e||[],n=n||{});return function(e){e=e||[];for(var C=0;C<i.length;C++){var o=t(i[C]);g[o].references--}for(var a=I(e,n),s=0;s<i.length;s++){var l=t(i[s]);0===g[l].references&&(g[l].updater(),g.splice(l,1))}i=a}}},777:e=>{"use strict";var g={};e.exports=function(e,t){var I=function(e){if(void 0===g[e]){var t=document.querySelector(e);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(e){t=null}g[e]=t}return g[e]}(e);if(!I)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");I.appendChild(t)}},216:e=>{"use strict";e.exports=function(e){var g=document.createElement("style");return e.setAttributes(g,e.attributes),e.insert(g,e.options),g}},565:(e,g,t)=>{"use strict";e.exports=function(e){var g=t.nc;g&&e.setAttribute("nonce",g)}},795:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var g=e.insertStyleElement(e);return{update:function(t){!function(e,g,t){var I="";t.supports&&(I+="@supports (".concat(t.supports,") {")),t.media&&(I+="@media ".concat(t.media," {"));var n=void 0!==t.layer;n&&(I+="@layer".concat(t.layer.length>0?" ".concat(t.layer):""," {")),I+=t.css,n&&(I+="}"),t.media&&(I+="}"),t.supports&&(I+="}");var i=t.sourceMap;i&&"undefined"!=typeof btoa&&(I+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),g.styleTagTransform(I,e,g.options)}(g,e,t)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(g)}}}},589:e=>{"use strict";e.exports=function(e,g){if(g.styleSheet)g.styleSheet.cssText=e;else{for(;g.firstChild;)g.removeChild(g.firstChild);g.appendChild(document.createTextNode(e))}}},250:(e,g,t)=>{"use strict";var I=t(294),n="function"==typeof Object.is?Object.is:function(e,g){return e===g&&(0!==e||1/e==1/g)||e!=e&&g!=g},i=I.useState,C=I.useEffect,o=I.useLayoutEffect,a=I.useDebugValue;function s(e){var g=e.getSnapshot;e=e.value;try{var t=g();return!n(e,t)}catch(e){return!0}}var l="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,g){return g()}:function(e,g){var t=g(),I=i({inst:{value:t,getSnapshot:g}}),n=I[0].inst,l=I[1];return o((function(){n.value=t,n.getSnapshot=g,s(n)&&l({inst:n})}),[e,t,g]),C((function(){return s(n)&&l({inst:n}),e((function(){s(n)&&l({inst:n})}))}),[e]),a(t),t};g.useSyncExternalStore=void 0!==I.useSyncExternalStore?I.useSyncExternalStore:l},139:(e,g,t)=>{"use strict";var I=t(294),n=t(688),i="function"==typeof Object.is?Object.is:function(e,g){return e===g&&(0!==e||1/e==1/g)||e!=e&&g!=g},C=n.useSyncExternalStore,o=I.useRef,a=I.useEffect,s=I.useMemo,l=I.useDebugValue;g.useSyncExternalStoreWithSelector=function(e,g,t,I,n){var r=o(null);if(null===r.current){var A={hasValue:!1,value:null};r.current=A}else A=r.current;r=s((function(){function e(e){if(!a){if(a=!0,C=e,e=I(e),void 0!==n&&A.hasValue){var g=A.value;if(n(g,e))return o=g}return o=e}if(g=o,i(C,e))return g;var t=I(e);return void 0!==n&&n(g,t)?g:(C=e,o=t)}var C,o,a=!1,s=void 0===t?null:t;return[function(){return e(g())},null===s?void 0:function(){return e(s())}]}),[g,t,I,n]);var c=C(e,r[0],r[1]);return a((function(){A.hasValue=!0,A.value=c}),[c]),l(c),c}},688:(e,g,t)=>{"use strict";e.exports=t(250)},798:(e,g,t)=>{"use strict";e.exports=t(139)}},I={};function n(e){var g=I[e];if(void 0!==g)return g.exports;var i=I[e]={id:e,exports:{}};return t[e].call(i.exports,i,i.exports,n),i.exports}n.n=e=>{var g=e&&e.__esModule?()=>e.default:()=>e;return n.d(g,{a:g}),g},g=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,n.t=function(t,I){if(1&I&&(t=this(t)),8&I)return t;if("object"==typeof t&&t){if(4&I&&t.__esModule)return t;if(16&I&&"function"==typeof t.then)return t}var i=Object.create(null);n.r(i);var C={};e=e||[null,g({}),g([]),g(g)];for(var o=2&I&&t;"object"==typeof o&&!~e.indexOf(o);o=g(o))Object.getOwnPropertyNames(o).forEach((e=>C[e]=()=>t[e]));return C.default=()=>t,n.d(i,C),i},n.d=(e,g)=>{for(var t in g)n.o(g,t)&&!n.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:g[t]})},n.o=(e,g)=>Object.prototype.hasOwnProperty.call(e,g),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nc=void 0,(()=>{"use strict";var e={};n.r(e),n.d(e,{ACESFilmicToneMapping:()=>be,AddEquation:()=>M,AddOperation:()=>Ae,AdditiveAnimationBlendMode:()=>Og,AdditiveBlending:()=>F,AlphaFormat:()=>je,AlwaysCompare:()=>Ft,AlwaysDepth:()=>Ie,AlwaysStencilFunc:()=>Rt,AmbientLight:()=>PA,AnimationAction:()=>kc,AnimationClip:()=>GA,AnimationLoader:()=>VA,AnimationMixer:()=>Lc,AnimationObjectGroup:()=>zc,AnimationUtils:()=>oA,ArcCurve:()=>fl,ArrayCamera:()=>ja,ArrowHelper:()=>Yd,Audio:()=>yc,AudioAnalyser:()=>Vc,AudioContext:()=>lc,AudioListener:()=>Zc,AudioLoader:()=>rc,AxesHelper:()=>Kd,BackSide:()=>S,BasicDepthPacking:()=>et,BasicShadowMap:()=>f,Bone:()=>Ms,BooleanKeyframeTrack:()=>cA,Box2:()=>$c,Box3:()=>OI,Box3Helper:()=>wd,BoxGeometry:()=>CC,BoxHelper:()=>fd,BufferAttribute:()=>Zi,BufferGeometry:()=>Mi,BufferGeometryLoader:()=>Ic,ByteType:()=>ke,Cache:()=>ZA,Camera:()=>AC,CameraHelper:()=>yd,CanvasTexture:()=>yl,CapsuleGeometry:()=>Dl,CatmullRomCurve3:()=>Yl,CineonToneMapping:()=>he,CircleGeometry:()=>Ol,ClampToEdgeWrapping:()=>fe,Clock:()=>hc,Color:()=>Ai,ColorKeyframeTrack:()=>dA,ColorManagement:()=>fI,CompressedArrayTexture:()=>Bl,CompressedCubeTexture:()=>Zl,CompressedTexture:()=>Gl,CompressedTextureLoader:()=>XA,ConeGeometry:()=>Pl,CubeCamera:()=>uC,CubeReflectionMapping:()=>Ge,CubeRefractionMapping:()=>Be,CubeTexture:()=>hC,CubeTextureLoader:()=>YA,CubeUVReflectionMapping:()=>ve,CubicBezierCurve:()=>Fl,CubicBezierCurve3:()=>xl,CubicInterpolant:()=>sA,CullFaceBack:()=>y,CullFaceFront:()=>v,CullFaceFrontBack:()=>W,CullFaceNone:()=>Z,Curve:()=>vl,CurvePath:()=>Tl,CustomBlending:()=>k,CustomToneMapping:()=>me,CylinderGeometry:()=>jl,Cylindrical:()=>_c,Data3DTexture:()=>LI,DataArrayTexture:()=>kI,DataTexture:()=>Ls,DataTextureLoader:()=>KA,DataUtils:()=>pi,DecrementStencilOp:()=>bt,DecrementWrapStencilOp:()=>pt,DefaultLoadingManager:()=>vA,DepthFormat:()=>$e,DepthStencilFormat:()=>eg,DepthTexture:()=>$a,DirectionalLight:()=>jA,DirectionalLightHelper:()=>Gd,DiscreteInterpolant:()=>rA,DisplayP3ColorSpace:()=>ot,DodecahedronGeometry:()=>ql,DoubleSide:()=>Y,DstAlphaFactor:()=>_,DstColorFactor:()=>$,DynamicCopyUsage:()=>Tt,DynamicDrawUsage:()=>zt,DynamicReadUsage:()=>Lt,EdgesGeometry:()=>Ir,EllipseCurve:()=>Wl,EqualCompare:()=>St,EqualDepth:()=>Ce,EqualStencilFunc:()=>yt,EquirectangularReflectionMapping:()=>Ze,EquirectangularRefractionMapping:()=>ye,Euler:()=>Yn,EventDispatcher:()=>_t,ExtrudeGeometry:()=>Yr,FileLoader:()=>RA,Float16BufferAttribute:()=>Xi,Float32BufferAttribute:()=>Si,Float64BufferAttribute:()=>Yi,FloatType:()=>Te,Fog:()=>Cs,FogExp2:()=>is,FramebufferTexture:()=>pl,FrontSide:()=>X,Frustum:()=>vC,GLBufferAttribute:()=>Qc,GLSL1:()=>Qt,GLSL3:()=>Dt,GreaterCompare:()=>Kt,GreaterDepth:()=>ae,GreaterEqualCompare:()=>Nt,GreaterEqualDepth:()=>oe,GreaterEqualStencilFunc:()=>wt,GreaterStencilFunc:()=>Wt,GridHelper:()=>ud,Group:()=>Pa,HalfFloatType:()=>Ue,HemisphereLight:()=>FA,HemisphereLightHelper:()=>dd,IcosahedronGeometry:()=>Hr,ImageBitmapLoader:()=>ac,ImageLoader:()=>SA,ImageUtils:()=>XI,IncrementStencilOp:()=>ht,IncrementWrapStencilOp:()=>mt,InstancedBufferAttribute:()=>Us,InstancedBufferGeometry:()=>tc,InstancedInterleavedBuffer:()=>Uc,InstancedMesh:()=>$s,Int16BufferAttribute:()=>fi,Int32BufferAttribute:()=>Ri,Int8BufferAttribute:()=>yi,IntType:()=>Je,InterleavedBuffer:()=>as,InterleavedBufferAttribute:()=>ls,Interpolant:()=>aA,InterpolateDiscrete:()=>Lg,InterpolateLinear:()=>Jg,InterpolateSmooth:()=>Eg,InvertStencilOp:()=>Gt,KeepStencilOp:()=>dt,KeyframeTrack:()=>AA,LOD:()=>Vs,LatheGeometry:()=>Ql,Layers:()=>Kn,LessCompare:()=>Xt,LessDepth:()=>ne,LessEqualCompare:()=>Yt,LessEqualDepth:()=>ie,LessEqualStencilFunc:()=>vt,LessStencilFunc:()=>Zt,Light:()=>NA,LightProbe:()=>$A,Line:()=>Cl,Line3:()=>td,LineBasicMaterial:()=>el,LineCurve:()=>zl,LineCurve3:()=>kl,LineDashedMaterial:()=>gA,LineLoop:()=>ll,LineSegments:()=>sl,LinearDisplayP3ColorSpace:()=>at,LinearEncoding:()=>qg,LinearFilter:()=>Ke,LinearInterpolant:()=>lA,LinearMipMapLinearFilter:()=>xe,LinearMipMapNearestFilter:()=>Ne,LinearMipmapLinearFilter:()=>Fe,LinearMipmapNearestFilter:()=>He,LinearSRGBColorSpace:()=>Ct,LinearToneMapping:()=>de,LinearTransfer:()=>st,Loader:()=>WA,LoaderUtils:()=>gc,LoadingManager:()=>yA,LoopOnce:()=>zg,LoopPingPong:()=>Mg,LoopRepeat:()=>kg,LuminanceAlphaFormat:()=>qe,LuminanceFormat:()=>_e,MOUSE:()=>G,Material:()=>oi,MaterialLoader:()=>ec,MathUtils:()=>rI,Matrix3:()=>cI,Matrix4:()=>Zn,MaxEquation:()=>T,Mesh:()=>nC,MeshBasicMaterial:()=>di,MeshDepthMaterial:()=>Ea,MeshDistanceMaterial:()=>Ta,MeshLambertMaterial:()=>$r,MeshMatcapMaterial:()=>eA,MeshNormalMaterial:()=>qr,MeshPhongMaterial:()=>Pr,MeshPhysicalMaterial:()=>jr,MeshStandardMaterial:()=>Or,MeshToonMaterial:()=>_r,MinEquation:()=>E,MirroredRepeatWrapping:()=>we,MixOperation:()=>re,MultiplyBlending:()=>z,MultiplyOperation:()=>le,NearestFilter:()=>Re,NearestMipMapLinearFilter:()=>Ye,NearestMipMapNearestFilter:()=>Xe,NearestMipmapLinearFilter:()=>Se,NearestMipmapNearestFilter:()=>Ve,NeverCompare:()=>Vt,NeverDepth:()=>te,NeverStencilFunc:()=>Bt,NoBlending:()=>H,NoColorSpace:()=>nt,NoToneMapping:()=>ce,NormalAnimationBlendMode:()=>Dg,NormalBlending:()=>N,NotEqualCompare:()=>Ht,NotEqualDepth:()=>se,NotEqualStencilFunc:()=>ft,NumberKeyframeTrack:()=>uA,Object3D:()=>Dn,ObjectLoader:()=>nc,ObjectSpaceNormalMap:()=>It,OctahedronGeometry:()=>Nr,OneFactor:()=>Q,OneMinusDstAlphaFactor:()=>q,OneMinusDstColorFactor:()=>ee,OneMinusSrcAlphaFactor:()=>P,OneMinusSrcColorFactor:()=>O,OrthographicCamera:()=>zC,P3Primaries:()=>At,PCFShadowMap:()=>w,PCFSoftShadowMap:()=>R,PMREMGenerator:()=>QC,Path:()=>Ul,PerspectiveCamera:()=>cC,Plane:()=>BC,PlaneGeometry:()=>wC,PlaneHelper:()=>Rd,PointLight:()=>DA,PointLightHelper:()=>ld,Points:()=>hl,PointsMaterial:()=>rl,PolarGridHelper:()=>hd,PolyhedronGeometry:()=>_l,PositionalAudio:()=>Rc,PropertyBinding:()=>xc,PropertyMixer:()=>Xc,QuadraticBezierCurve:()=>Ml,QuadraticBezierCurve3:()=>Ll,Quaternion:()=>TI,QuaternionKeyframeTrack:()=>bA,QuaternionLinearInterpolant:()=>hA,RED_GREEN_RGTC2_Format:()=>Fg,RED_RGTC1_Format:()=>Hg,REVISION:()=>p,RGBADepthPacking:()=>gt,RGBAFormat:()=>Pe,RGBAIntegerFormat:()=>ig,RGBA_ASTC_10x10_Format:()=>Rg,RGBA_ASTC_10x5_Format:()=>Wg,RGBA_ASTC_10x6_Format:()=>fg,RGBA_ASTC_10x8_Format:()=>wg,RGBA_ASTC_12x10_Format:()=>Vg,RGBA_ASTC_12x12_Format:()=>Xg,RGBA_ASTC_4x4_Format:()=>bg,RGBA_ASTC_5x4_Format:()=>mg,RGBA_ASTC_5x5_Format:()=>pg,RGBA_ASTC_6x5_Format:()=>Gg,RGBA_ASTC_6x6_Format:()=>Bg,RGBA_ASTC_8x5_Format:()=>Zg,RGBA_ASTC_8x6_Format:()=>yg,RGBA_ASTC_8x8_Format:()=>vg,RGBA_BPTC_Format:()=>Sg,RGBA_ETC2_EAC_Format:()=>hg,RGBA_PVRTC_2BPPV1_Format:()=>cg,RGBA_PVRTC_4BPPV1_Format:()=>Ag,RGBA_S3TC_DXT1_Format:()=>og,RGBA_S3TC_DXT3_Format:()=>ag,RGBA_S3TC_DXT5_Format:()=>sg,RGB_BPTC_SIGNED_Format:()=>Yg,RGB_BPTC_UNSIGNED_Format:()=>Kg,RGB_ETC1_Format:()=>dg,RGB_ETC2_Format:()=>ug,RGB_PVRTC_2BPPV1_Format:()=>rg,RGB_PVRTC_4BPPV1_Format:()=>lg,RGB_S3TC_DXT1_Format:()=>Cg,RGFormat:()=>Ig,RGIntegerFormat:()=>ng,RawShaderMaterial:()=>Dr,Ray:()=>Bn,Raycaster:()=>Dc,Rec709Primaries:()=>rt,RectAreaLight:()=>_A,RedFormat:()=>gg,RedIntegerFormat:()=>tg,ReinhardToneMapping:()=>ue,RenderTarget:()=>xI,RepeatWrapping:()=>We,ReplaceStencilOp:()=>ut,ReverseSubtractEquation:()=>J,RingGeometry:()=>Fr,SIGNED_RED_GREEN_RGTC2_Format:()=>xg,SIGNED_RED_RGTC1_Format:()=>Ng,SRGBColorSpace:()=>it,SRGBTransfer:()=>lt,Scene:()=>os,ShaderChunk:()=>RC,ShaderLib:()=>XC,ShaderMaterial:()=>rC,ShadowMaterial:()=>Qr,Shape:()=>nr,ShapeGeometry:()=>xr,ShapePath:()=>Hd,ShapeUtils:()=>Vr,ShortType:()=>Me,Skeleton:()=>Ts,SkeletonHelper:()=>ad,SkinnedMesh:()=>ks,Source:()=>YI,Sphere:()=>cn,SphereGeometry:()=>zr,Spherical:()=>Pc,SphericalHarmonics3:()=>qA,SplineCurve:()=>Jl,SpotLight:()=>JA,SpotLightHelper:()=>nd,Sprite:()=>Ws,SpriteMaterial:()=>rs,SrcAlphaFactor:()=>j,SrcAlphaSaturateFactor:()=>ge,SrcColorFactor:()=>D,StaticCopyUsage:()=>Et,StaticDrawUsage:()=>xt,StaticReadUsage:()=>Mt,StereoCamera:()=>uc,StreamCopyUsage:()=>Ut,StreamDrawUsage:()=>kt,StreamReadUsage:()=>Jt,StringKeyframeTrack:()=>mA,SubtractEquation:()=>L,SubtractiveBlending:()=>x,TOUCH:()=>B,TangentSpaceNormalMap:()=>tt,TetrahedronGeometry:()=>kr,Texture:()=>NI,TextureLoader:()=>HA,TorusGeometry:()=>Mr,TorusKnotGeometry:()=>Lr,Triangle:()=>ii,TriangleFanDrawMode:()=>_g,TriangleStripDrawMode:()=>Pg,TrianglesDrawMode:()=>jg,TubeGeometry:()=>Jr,TwoPassDoubleSide:()=>K,UVMapping:()=>pe,Uint16BufferAttribute:()=>wi,Uint32BufferAttribute:()=>Vi,Uint8BufferAttribute:()=>vi,Uint8ClampedBufferAttribute:()=>Wi,Uniform:()=>Jc,UniformsGroup:()=>Tc,UniformsLib:()=>VC,UniformsUtils:()=>lC,UnsignedByteType:()=>ze,UnsignedInt248Type:()=>Oe,UnsignedIntType:()=>Ee,UnsignedShort4444Type:()=>Qe,UnsignedShort5551Type:()=>De,UnsignedShortType:()=>Le,VSMShadowMap:()=>V,Vector2:()=>AI,Vector3:()=>UI,Vector4:()=>FI,VectorKeyframeTrack:()=>pA,VideoTexture:()=>ml,WebGL1Renderer:()=>ns,WebGL3DRenderTarget:()=>JI,WebGLArrayRenderTarget:()=>MI,WebGLCoordinateSystem:()=>jt,WebGLCubeRenderTarget:()=>bC,WebGLMultipleRenderTargets:()=>EI,WebGLRenderTarget:()=>zI,WebGLRenderer:()=>Is,WebGLUtils:()=>Oa,WebGPUCoordinateSystem:()=>Pt,WireframeGeometry:()=>Er,WrapAroundEnding:()=>Qg,ZeroCurvatureEnding:()=>Tg,ZeroFactor:()=>U,ZeroSlopeEnding:()=>Ug,ZeroStencilOp:()=>ct,_SRGBAFormat:()=>Ot,createCanvasElement:()=>pI,sRGBEncoding:()=>$g});var g=n(294),t=n.t(g,2),I=n(745),i=n(379),C=n.n(i),o=n(795),a=n.n(o),s=n(777),l=n.n(s),r=n(565),A=n.n(r),c=n(216),d=n.n(c),u=n(589),h=n.n(u),b=n(447),m={};m.styleTagTransform=h(),m.setAttributes=A(),m.insert=l().bind(null,"head"),m.domAPI=a(),m.insertStyleElement=d(),C()(b.Z,m),b.Z&&b.Z.locals&&b.Z.locals;const p="157",G={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},B={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},Z=0,y=1,v=2,W=3,f=0,w=1,R=2,V=3,X=0,S=1,Y=2,K=2,H=0,N=1,F=2,x=3,z=4,k=5,M=100,L=101,J=102,E=103,T=104,U=200,Q=201,D=202,O=203,j=204,P=205,_=206,q=207,$=208,ee=209,ge=210,te=0,Ie=1,ne=2,ie=3,Ce=4,oe=5,ae=6,se=7,le=0,re=1,Ae=2,ce=0,de=1,ue=2,he=3,be=4,me=5,pe=300,Ge=301,Be=302,Ze=303,ye=304,ve=306,We=1e3,fe=1001,we=1002,Re=1003,Ve=1004,Xe=1004,Se=1005,Ye=1005,Ke=1006,He=1007,Ne=1007,Fe=1008,xe=1008,ze=1009,ke=1010,Me=1011,Le=1012,Je=1013,Ee=1014,Te=1015,Ue=1016,Qe=1017,De=1018,Oe=1020,je=1021,Pe=1023,_e=1024,qe=1025,$e=1026,eg=1027,gg=1028,tg=1029,Ig=1030,ng=1031,ig=1033,Cg=33776,og=33777,ag=33778,sg=33779,lg=35840,rg=35841,Ag=35842,cg=35843,dg=36196,ug=37492,hg=37496,bg=37808,mg=37809,pg=37810,Gg=37811,Bg=37812,Zg=37813,yg=37814,vg=37815,Wg=37816,fg=37817,wg=37818,Rg=37819,Vg=37820,Xg=37821,Sg=36492,Yg=36494,Kg=36495,Hg=36283,Ng=36284,Fg=36285,xg=36286,zg=2200,kg=2201,Mg=2202,Lg=2300,Jg=2301,Eg=2302,Tg=2400,Ug=2401,Qg=2402,Dg=2500,Og=2501,jg=0,Pg=1,_g=2,qg=3e3,$g=3001,et=3200,gt=3201,tt=0,It=1,nt="",it="srgb",Ct="srgb-linear",ot="display-p3",at="display-p3-linear",st="linear",lt="srgb",rt="rec709",At="p3",ct=0,dt=7680,ut=7681,ht=7682,bt=7683,mt=34055,pt=34056,Gt=5386,Bt=512,Zt=513,yt=514,vt=515,Wt=516,ft=517,wt=518,Rt=519,Vt=512,Xt=513,St=514,Yt=515,Kt=516,Ht=517,Nt=518,Ft=519,xt=35044,zt=35048,kt=35040,Mt=35045,Lt=35049,Jt=35041,Et=35046,Tt=35050,Ut=35042,Qt="100",Dt="300 es",Ot=1035,jt=2e3,Pt=2001;class _t{addEventListener(e,g){void 0===this._listeners&&(this._listeners={});const t=this._listeners;void 0===t[e]&&(t[e]=[]),-1===t[e].indexOf(g)&&t[e].push(g)}hasEventListener(e,g){if(void 0===this._listeners)return!1;const t=this._listeners;return void 0!==t[e]&&-1!==t[e].indexOf(g)}removeEventListener(e,g){if(void 0===this._listeners)return;const t=this._listeners[e];if(void 0!==t){const e=t.indexOf(g);-1!==e&&t.splice(e,1)}}dispatchEvent(e){if(void 0===this._listeners)return;const g=this._listeners[e.type];if(void 0!==g){e.target=this;const t=g.slice(0);for(let g=0,I=t.length;g<I;g++)t[g].call(this,e);e.target=null}}}const qt=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let $t=1234567;const eI=Math.PI/180,gI=180/Math.PI;function tI(){const e=4294967295*Math.random()|0,g=4294967295*Math.random()|0,t=4294967295*Math.random()|0,I=4294967295*Math.random()|0;return(qt[255&e]+qt[e>>8&255]+qt[e>>16&255]+qt[e>>24&255]+"-"+qt[255&g]+qt[g>>8&255]+"-"+qt[g>>16&15|64]+qt[g>>24&255]+"-"+qt[63&t|128]+qt[t>>8&255]+"-"+qt[t>>16&255]+qt[t>>24&255]+qt[255&I]+qt[I>>8&255]+qt[I>>16&255]+qt[I>>24&255]).toLowerCase()}function II(e,g,t){return Math.max(g,Math.min(t,e))}function nI(e,g){return(e%g+g)%g}function iI(e,g,t){return(1-t)*e+t*g}function CI(e){return 0==(e&e-1)&&0!==e}function oI(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}function aI(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}function sI(e,g){switch(g.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function lI(e,g){switch(g.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}const rI={DEG2RAD:eI,RAD2DEG:gI,generateUUID:tI,clamp:II,euclideanModulo:nI,mapLinear:function(e,g,t,I,n){return I+(e-g)*(n-I)/(t-g)},inverseLerp:function(e,g,t){return e!==g?(t-e)/(g-e):0},lerp:iI,damp:function(e,g,t,I){return iI(e,g,1-Math.exp(-t*I))},pingpong:function(e,g=1){return g-Math.abs(nI(e,2*g)-g)},smoothstep:function(e,g,t){return e<=g?0:e>=t?1:(e=(e-g)/(t-g))*e*(3-2*e)},smootherstep:function(e,g,t){return e<=g?0:e>=t?1:(e=(e-g)/(t-g))*e*e*(e*(6*e-15)+10)},randInt:function(e,g){return e+Math.floor(Math.random()*(g-e+1))},randFloat:function(e,g){return e+Math.random()*(g-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){void 0!==e&&($t=e);let g=$t+=1831565813;return g=Math.imul(g^g>>>15,1|g),g^=g+Math.imul(g^g>>>7,61|g),((g^g>>>14)>>>0)/4294967296},degToRad:function(e){return e*eI},radToDeg:function(e){return e*gI},isPowerOfTwo:CI,ceilPowerOfTwo:oI,floorPowerOfTwo:aI,setQuaternionFromProperEuler:function(e,g,t,I,n){const i=Math.cos,C=Math.sin,o=i(t/2),a=C(t/2),s=i((g+I)/2),l=C((g+I)/2),r=i((g-I)/2),A=C((g-I)/2),c=i((I-g)/2),d=C((I-g)/2);switch(n){case"XYX":e.set(o*l,a*r,a*A,o*s);break;case"YZY":e.set(a*A,o*l,a*r,o*s);break;case"ZXZ":e.set(a*r,a*A,o*l,o*s);break;case"XZX":e.set(o*l,a*d,a*c,o*s);break;case"YXY":e.set(a*c,o*l,a*d,o*s);break;case"ZYZ":e.set(a*d,a*c,o*l,o*s);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+n)}},normalize:lI,denormalize:sI};class AI{constructor(e=0,g=0){AI.prototype.isVector2=!0,this.x=e,this.y=g}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,g){return this.x=e,this.y=g,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,g){switch(e){case 0:this.x=g;break;case 1:this.y=g;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,g){return this.x=e.x+g.x,this.y=e.y+g.y,this}addScaledVector(e,g){return this.x+=e.x*g,this.y+=e.y*g,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,g){return this.x=e.x-g.x,this.y=e.y-g.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const g=this.x,t=this.y,I=e.elements;return this.x=I[0]*g+I[3]*t+I[6],this.y=I[1]*g+I[4]*t+I[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,g){return this.x=Math.max(e.x,Math.min(g.x,this.x)),this.y=Math.max(e.y,Math.min(g.y,this.y)),this}clampScalar(e,g){return this.x=Math.max(e,Math.min(g,this.x)),this.y=Math.max(e,Math.min(g,this.y)),this}clampLength(e,g){const t=this.length();return this.divideScalar(t||1).multiplyScalar(Math.max(e,Math.min(g,t)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const g=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===g)return Math.PI/2;const t=this.dot(e)/g;return Math.acos(II(t,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const g=this.x-e.x,t=this.y-e.y;return g*g+t*t}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,g){return this.x+=(e.x-this.x)*g,this.y+=(e.y-this.y)*g,this}lerpVectors(e,g,t){return this.x=e.x+(g.x-e.x)*t,this.y=e.y+(g.y-e.y)*t,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,g=0){return this.x=e[g],this.y=e[g+1],this}toArray(e=[],g=0){return e[g]=this.x,e[g+1]=this.y,e}fromBufferAttribute(e,g){return this.x=e.getX(g),this.y=e.getY(g),this}rotateAround(e,g){const t=Math.cos(g),I=Math.sin(g),n=this.x-e.x,i=this.y-e.y;return this.x=n*t-i*I+e.x,this.y=n*I+i*t+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class cI{constructor(e,g,t,I,n,i,C,o,a){cI.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,g,t,I,n,i,C,o,a)}set(e,g,t,I,n,i,C,o,a){const s=this.elements;return s[0]=e,s[1]=I,s[2]=C,s[3]=g,s[4]=n,s[5]=o,s[6]=t,s[7]=i,s[8]=a,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const g=this.elements,t=e.elements;return g[0]=t[0],g[1]=t[1],g[2]=t[2],g[3]=t[3],g[4]=t[4],g[5]=t[5],g[6]=t[6],g[7]=t[7],g[8]=t[8],this}extractBasis(e,g,t){return e.setFromMatrix3Column(this,0),g.setFromMatrix3Column(this,1),t.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const g=e.elements;return this.set(g[0],g[4],g[8],g[1],g[5],g[9],g[2],g[6],g[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,g){const t=e.elements,I=g.elements,n=this.elements,i=t[0],C=t[3],o=t[6],a=t[1],s=t[4],l=t[7],r=t[2],A=t[5],c=t[8],d=I[0],u=I[3],h=I[6],b=I[1],m=I[4],p=I[7],G=I[2],B=I[5],Z=I[8];return n[0]=i*d+C*b+o*G,n[3]=i*u+C*m+o*B,n[6]=i*h+C*p+o*Z,n[1]=a*d+s*b+l*G,n[4]=a*u+s*m+l*B,n[7]=a*h+s*p+l*Z,n[2]=r*d+A*b+c*G,n[5]=r*u+A*m+c*B,n[8]=r*h+A*p+c*Z,this}multiplyScalar(e){const g=this.elements;return g[0]*=e,g[3]*=e,g[6]*=e,g[1]*=e,g[4]*=e,g[7]*=e,g[2]*=e,g[5]*=e,g[8]*=e,this}determinant(){const e=this.elements,g=e[0],t=e[1],I=e[2],n=e[3],i=e[4],C=e[5],o=e[6],a=e[7],s=e[8];return g*i*s-g*C*a-t*n*s+t*C*o+I*n*a-I*i*o}invert(){const e=this.elements,g=e[0],t=e[1],I=e[2],n=e[3],i=e[4],C=e[5],o=e[6],a=e[7],s=e[8],l=s*i-C*a,r=C*o-s*n,A=a*n-i*o,c=g*l+t*r+I*A;if(0===c)return this.set(0,0,0,0,0,0,0,0,0);const d=1/c;return e[0]=l*d,e[1]=(I*a-s*t)*d,e[2]=(C*t-I*i)*d,e[3]=r*d,e[4]=(s*g-I*o)*d,e[5]=(I*n-C*g)*d,e[6]=A*d,e[7]=(t*o-a*g)*d,e[8]=(i*g-t*n)*d,this}transpose(){let e;const g=this.elements;return e=g[1],g[1]=g[3],g[3]=e,e=g[2],g[2]=g[6],g[6]=e,e=g[5],g[5]=g[7],g[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const g=this.elements;return e[0]=g[0],e[1]=g[3],e[2]=g[6],e[3]=g[1],e[4]=g[4],e[5]=g[7],e[6]=g[2],e[7]=g[5],e[8]=g[8],this}setUvTransform(e,g,t,I,n,i,C){const o=Math.cos(n),a=Math.sin(n);return this.set(t*o,t*a,-t*(o*i+a*C)+i+e,-I*a,I*o,-I*(-a*i+o*C)+C+g,0,0,1),this}scale(e,g){return this.premultiply(dI.makeScale(e,g)),this}rotate(e){return this.premultiply(dI.makeRotation(-e)),this}translate(e,g){return this.premultiply(dI.makeTranslation(e,g)),this}makeTranslation(e,g){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,g,0,0,1),this}makeRotation(e){const g=Math.cos(e),t=Math.sin(e);return this.set(g,-t,0,t,g,0,0,0,1),this}makeScale(e,g){return this.set(e,0,0,0,g,0,0,0,1),this}equals(e){const g=this.elements,t=e.elements;for(let e=0;e<9;e++)if(g[e]!==t[e])return!1;return!0}fromArray(e,g=0){for(let t=0;t<9;t++)this.elements[t]=e[t+g];return this}toArray(e=[],g=0){const t=this.elements;return e[g]=t[0],e[g+1]=t[1],e[g+2]=t[2],e[g+3]=t[3],e[g+4]=t[4],e[g+5]=t[5],e[g+6]=t[6],e[g+7]=t[7],e[g+8]=t[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}const dI=new cI;function uI(e){for(let g=e.length-1;g>=0;--g)if(e[g]>=65535)return!0;return!1}const hI={Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array};function bI(e,g){return new hI[e](g)}function mI(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function pI(){const e=mI("canvas");return e.style.display="block",e}const GI={};function BI(e){e in GI||(GI[e]=!0,console.warn(e))}const ZI=(new cI).set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),yI=(new cI).set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),vI={[Ct]:{transfer:st,primaries:rt,toReference:e=>e,fromReference:e=>e},[it]:{transfer:lt,primaries:rt,toReference:e=>e.convertSRGBToLinear(),fromReference:e=>e.convertLinearToSRGB()},[at]:{transfer:st,primaries:At,toReference:e=>e.applyMatrix3(yI),fromReference:e=>e.applyMatrix3(ZI)},[ot]:{transfer:lt,primaries:At,toReference:e=>e.convertSRGBToLinear().applyMatrix3(yI),fromReference:e=>e.applyMatrix3(ZI).convertLinearToSRGB()}},WI=new Set([Ct,at]),fI={enabled:!0,_workingColorSpace:Ct,get legacyMode(){return console.warn("THREE.ColorManagement: .legacyMode=false renamed to .enabled=true in r150."),!this.enabled},set legacyMode(e){console.warn("THREE.ColorManagement: .legacyMode=false renamed to .enabled=true in r150."),this.enabled=!e},get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(e){if(!WI.has(e))throw new Error(`Unsupported working color space, "${e}".`);this._workingColorSpace=e},convert:function(e,g,t){if(!1===this.enabled||g===t||!g||!t)return e;const I=vI[g].toReference;return(0,vI[t].fromReference)(I(e))},fromWorkingColorSpace:function(e,g){return this.convert(e,this._workingColorSpace,g)},toWorkingColorSpace:function(e,g){return this.convert(e,g,this._workingColorSpace)},getPrimaries:function(e){return vI[e].primaries},getTransfer:function(e){return e===nt?st:vI[e].transfer}};function wI(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function RI(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let VI;class XI{static getDataURL(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let g;if(e instanceof HTMLCanvasElement)g=e;else{void 0===VI&&(VI=mI("canvas")),VI.width=e.width,VI.height=e.height;const t=VI.getContext("2d");e instanceof ImageData?t.putImageData(e,0,0):t.drawImage(e,0,0,e.width,e.height),g=VI}return g.width>2048||g.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",e),g.toDataURL("image/jpeg",.6)):g.toDataURL("image/png")}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const g=mI("canvas");g.width=e.width,g.height=e.height;const t=g.getContext("2d");t.drawImage(e,0,0,e.width,e.height);const I=t.getImageData(0,0,e.width,e.height),n=I.data;for(let e=0;e<n.length;e++)n[e]=255*wI(n[e]/255);return t.putImageData(I,0,0),g}if(e.data){const g=e.data.slice(0);for(let e=0;e<g.length;e++)g instanceof Uint8Array||g instanceof Uint8ClampedArray?g[e]=Math.floor(255*wI(g[e]/255)):g[e]=wI(g[e]);return{data:g,width:e.width,height:e.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let SI=0;class YI{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:SI++}),this.uuid=tI(),this.data=e,this.version=0}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const g=void 0===e||"string"==typeof e;if(!g&&void 0!==e.images[this.uuid])return e.images[this.uuid];const t={uuid:this.uuid,url:""},I=this.data;if(null!==I){let e;if(Array.isArray(I)){e=[];for(let g=0,t=I.length;g<t;g++)I[g].isDataTexture?e.push(KI(I[g].image)):e.push(KI(I[g]))}else e=KI(I);t.url=e}return g||(e.images[this.uuid]=t),t}}function KI(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?XI.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let HI=0;class NI extends _t{constructor(e=NI.DEFAULT_IMAGE,g=NI.DEFAULT_MAPPING,t=fe,I=fe,n=Ke,i=Fe,C=Pe,o=ze,a=NI.DEFAULT_ANISOTROPY,s=nt){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:HI++}),this.uuid=tI(),this.name="",this.source=new YI(e),this.mipmaps=[],this.mapping=g,this.channel=0,this.wrapS=t,this.wrapT=I,this.magFilter=n,this.minFilter=i,this.anisotropy=a,this.format=C,this.internalFormat=null,this.type=o,this.offset=new AI(0,0),this.repeat=new AI(1,1),this.center=new AI(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new cI,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,"string"==typeof s?this.colorSpace=s:(BI("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=s===$g?it:nt),this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.needsPMREMUpdate=!1}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}toJSON(e){const g=void 0===e||"string"==typeof e;if(!g&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const t={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(t.userData=this.userData),g||(e.textures[this.uuid]=t),t}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==pe)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case We:e.x=e.x-Math.floor(e.x);break;case fe:e.x=e.x<0?0:1;break;case we:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case We:e.y=e.y-Math.floor(e.y);break;case fe:e.y=e.y<0?0:1;break;case we:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}get encoding(){return BI("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace===it?$g:qg}set encoding(e){BI("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=e===$g?it:nt}}NI.DEFAULT_IMAGE=null,NI.DEFAULT_MAPPING=pe,NI.DEFAULT_ANISOTROPY=1;class FI{constructor(e=0,g=0,t=0,I=1){FI.prototype.isVector4=!0,this.x=e,this.y=g,this.z=t,this.w=I}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,g,t,I){return this.x=e,this.y=g,this.z=t,this.w=I,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,g){switch(e){case 0:this.x=g;break;case 1:this.y=g;break;case 2:this.z=g;break;case 3:this.w=g;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,g){return this.x=e.x+g.x,this.y=e.y+g.y,this.z=e.z+g.z,this.w=e.w+g.w,this}addScaledVector(e,g){return this.x+=e.x*g,this.y+=e.y*g,this.z+=e.z*g,this.w+=e.w*g,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,g){return this.x=e.x-g.x,this.y=e.y-g.y,this.z=e.z-g.z,this.w=e.w-g.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const g=this.x,t=this.y,I=this.z,n=this.w,i=e.elements;return this.x=i[0]*g+i[4]*t+i[8]*I+i[12]*n,this.y=i[1]*g+i[5]*t+i[9]*I+i[13]*n,this.z=i[2]*g+i[6]*t+i[10]*I+i[14]*n,this.w=i[3]*g+i[7]*t+i[11]*I+i[15]*n,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const g=Math.sqrt(1-e.w*e.w);return g<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/g,this.y=e.y/g,this.z=e.z/g),this}setAxisAngleFromRotationMatrix(e){let g,t,I,n;const i=.01,C=.1,o=e.elements,a=o[0],s=o[4],l=o[8],r=o[1],A=o[5],c=o[9],d=o[2],u=o[6],h=o[10];if(Math.abs(s-r)<i&&Math.abs(l-d)<i&&Math.abs(c-u)<i){if(Math.abs(s+r)<C&&Math.abs(l+d)<C&&Math.abs(c+u)<C&&Math.abs(a+A+h-3)<C)return this.set(1,0,0,0),this;g=Math.PI;const e=(a+1)/2,o=(A+1)/2,b=(h+1)/2,m=(s+r)/4,p=(l+d)/4,G=(c+u)/4;return e>o&&e>b?e<i?(t=0,I=.707106781,n=.707106781):(t=Math.sqrt(e),I=m/t,n=p/t):o>b?o<i?(t=.707106781,I=0,n=.707106781):(I=Math.sqrt(o),t=m/I,n=G/I):b<i?(t=.707106781,I=.707106781,n=0):(n=Math.sqrt(b),t=p/n,I=G/n),this.set(t,I,n,g),this}let b=Math.sqrt((u-c)*(u-c)+(l-d)*(l-d)+(r-s)*(r-s));return Math.abs(b)<.001&&(b=1),this.x=(u-c)/b,this.y=(l-d)/b,this.z=(r-s)/b,this.w=Math.acos((a+A+h-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,g){return this.x=Math.max(e.x,Math.min(g.x,this.x)),this.y=Math.max(e.y,Math.min(g.y,this.y)),this.z=Math.max(e.z,Math.min(g.z,this.z)),this.w=Math.max(e.w,Math.min(g.w,this.w)),this}clampScalar(e,g){return this.x=Math.max(e,Math.min(g,this.x)),this.y=Math.max(e,Math.min(g,this.y)),this.z=Math.max(e,Math.min(g,this.z)),this.w=Math.max(e,Math.min(g,this.w)),this}clampLength(e,g){const t=this.length();return this.divideScalar(t||1).multiplyScalar(Math.max(e,Math.min(g,t)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,g){return this.x+=(e.x-this.x)*g,this.y+=(e.y-this.y)*g,this.z+=(e.z-this.z)*g,this.w+=(e.w-this.w)*g,this}lerpVectors(e,g,t){return this.x=e.x+(g.x-e.x)*t,this.y=e.y+(g.y-e.y)*t,this.z=e.z+(g.z-e.z)*t,this.w=e.w+(g.w-e.w)*t,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,g=0){return this.x=e[g],this.y=e[g+1],this.z=e[g+2],this.w=e[g+3],this}toArray(e=[],g=0){return e[g]=this.x,e[g+1]=this.y,e[g+2]=this.z,e[g+3]=this.w,e}fromBufferAttribute(e,g){return this.x=e.getX(g),this.y=e.getY(g),this.z=e.getZ(g),this.w=e.getW(g),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class xI extends _t{constructor(e=1,g=1,t={}){super(),this.isRenderTarget=!0,this.width=e,this.height=g,this.depth=1,this.scissor=new FI(0,0,e,g),this.scissorTest=!1,this.viewport=new FI(0,0,e,g);const I={width:e,height:g,depth:1};void 0!==t.encoding&&(BI("THREE.WebGLRenderTarget: option.encoding has been replaced by option.colorSpace."),t.colorSpace=t.encoding===$g?it:nt),t=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:Ke,depthBuffer:!0,stencilBuffer:!1,depthTexture:null,samples:0},t),this.texture=new NI(I,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.flipY=!1,this.texture.generateMipmaps=t.generateMipmaps,this.texture.internalFormat=t.internalFormat,this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.depthTexture=t.depthTexture,this.samples=t.samples}setSize(e,g,t=1){this.width===e&&this.height===g&&this.depth===t||(this.width=e,this.height=g,this.depth=t,this.texture.image.width=e,this.texture.image.height=g,this.texture.image.depth=t,this.dispose()),this.viewport.set(0,0,e,g),this.scissor.set(0,0,e,g)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.texture.isRenderTargetTexture=!0;const g=Object.assign({},e.texture.image);return this.texture.source=new YI(g),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class zI extends xI{constructor(e=1,g=1,t={}){super(e,g,t),this.isWebGLRenderTarget=!0}}class kI extends NI{constructor(e=null,g=1,t=1,I=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:g,height:t,depth:I},this.magFilter=Re,this.minFilter=Re,this.wrapR=fe,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class MI extends zI{constructor(e=1,g=1,t=1){super(e,g),this.isWebGLArrayRenderTarget=!0,this.depth=t,this.texture=new kI(null,e,g,t),this.texture.isRenderTargetTexture=!0}}class LI extends NI{constructor(e=null,g=1,t=1,I=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:g,height:t,depth:I},this.magFilter=Re,this.minFilter=Re,this.wrapR=fe,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class JI extends zI{constructor(e=1,g=1,t=1){super(e,g),this.isWebGL3DRenderTarget=!0,this.depth=t,this.texture=new LI(null,e,g,t),this.texture.isRenderTargetTexture=!0}}class EI extends zI{constructor(e=1,g=1,t=1,I={}){super(e,g,I),this.isWebGLMultipleRenderTargets=!0;const n=this.texture;this.texture=[];for(let e=0;e<t;e++)this.texture[e]=n.clone(),this.texture[e].isRenderTargetTexture=!0}setSize(e,g,t=1){if(this.width!==e||this.height!==g||this.depth!==t){this.width=e,this.height=g,this.depth=t;for(let I=0,n=this.texture.length;I<n;I++)this.texture[I].image.width=e,this.texture[I].image.height=g,this.texture[I].image.depth=t;this.dispose()}this.viewport.set(0,0,e,g),this.scissor.set(0,0,e,g)}copy(e){this.dispose(),this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.texture.length=0;for(let g=0,t=e.texture.length;g<t;g++)this.texture[g]=e.texture[g].clone(),this.texture[g].isRenderTargetTexture=!0;return this}}class TI{constructor(e=0,g=0,t=0,I=1){this.isQuaternion=!0,this._x=e,this._y=g,this._z=t,this._w=I}static slerpFlat(e,g,t,I,n,i,C){let o=t[I+0],a=t[I+1],s=t[I+2],l=t[I+3];const r=n[i+0],A=n[i+1],c=n[i+2],d=n[i+3];if(0===C)return e[g+0]=o,e[g+1]=a,e[g+2]=s,void(e[g+3]=l);if(1===C)return e[g+0]=r,e[g+1]=A,e[g+2]=c,void(e[g+3]=d);if(l!==d||o!==r||a!==A||s!==c){let e=1-C;const g=o*r+a*A+s*c+l*d,t=g>=0?1:-1,I=1-g*g;if(I>Number.EPSILON){const n=Math.sqrt(I),i=Math.atan2(n,g*t);e=Math.sin(e*i)/n,C=Math.sin(C*i)/n}const n=C*t;if(o=o*e+r*n,a=a*e+A*n,s=s*e+c*n,l=l*e+d*n,e===1-C){const e=1/Math.sqrt(o*o+a*a+s*s+l*l);o*=e,a*=e,s*=e,l*=e}}e[g]=o,e[g+1]=a,e[g+2]=s,e[g+3]=l}static multiplyQuaternionsFlat(e,g,t,I,n,i){const C=t[I],o=t[I+1],a=t[I+2],s=t[I+3],l=n[i],r=n[i+1],A=n[i+2],c=n[i+3];return e[g]=C*c+s*l+o*A-a*r,e[g+1]=o*c+s*r+a*l-C*A,e[g+2]=a*c+s*A+C*r-o*l,e[g+3]=s*c-C*l-o*r-a*A,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,g,t,I){return this._x=e,this._y=g,this._z=t,this._w=I,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,g){const t=e._x,I=e._y,n=e._z,i=e._order,C=Math.cos,o=Math.sin,a=C(t/2),s=C(I/2),l=C(n/2),r=o(t/2),A=o(I/2),c=o(n/2);switch(i){case"XYZ":this._x=r*s*l+a*A*c,this._y=a*A*l-r*s*c,this._z=a*s*c+r*A*l,this._w=a*s*l-r*A*c;break;case"YXZ":this._x=r*s*l+a*A*c,this._y=a*A*l-r*s*c,this._z=a*s*c-r*A*l,this._w=a*s*l+r*A*c;break;case"ZXY":this._x=r*s*l-a*A*c,this._y=a*A*l+r*s*c,this._z=a*s*c+r*A*l,this._w=a*s*l-r*A*c;break;case"ZYX":this._x=r*s*l-a*A*c,this._y=a*A*l+r*s*c,this._z=a*s*c-r*A*l,this._w=a*s*l+r*A*c;break;case"YZX":this._x=r*s*l+a*A*c,this._y=a*A*l+r*s*c,this._z=a*s*c-r*A*l,this._w=a*s*l-r*A*c;break;case"XZY":this._x=r*s*l-a*A*c,this._y=a*A*l-r*s*c,this._z=a*s*c+r*A*l,this._w=a*s*l+r*A*c;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+i)}return!1!==g&&this._onChangeCallback(),this}setFromAxisAngle(e,g){const t=g/2,I=Math.sin(t);return this._x=e.x*I,this._y=e.y*I,this._z=e.z*I,this._w=Math.cos(t),this._onChangeCallback(),this}setFromRotationMatrix(e){const g=e.elements,t=g[0],I=g[4],n=g[8],i=g[1],C=g[5],o=g[9],a=g[2],s=g[6],l=g[10],r=t+C+l;if(r>0){const e=.5/Math.sqrt(r+1);this._w=.25/e,this._x=(s-o)*e,this._y=(n-a)*e,this._z=(i-I)*e}else if(t>C&&t>l){const e=2*Math.sqrt(1+t-C-l);this._w=(s-o)/e,this._x=.25*e,this._y=(I+i)/e,this._z=(n+a)/e}else if(C>l){const e=2*Math.sqrt(1+C-t-l);this._w=(n-a)/e,this._x=(I+i)/e,this._y=.25*e,this._z=(o+s)/e}else{const e=2*Math.sqrt(1+l-t-C);this._w=(i-I)/e,this._x=(n+a)/e,this._y=(o+s)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,g){let t=e.dot(g)+1;return t<Number.EPSILON?(t=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=t):(this._x=0,this._y=-e.z,this._z=e.y,this._w=t)):(this._x=e.y*g.z-e.z*g.y,this._y=e.z*g.x-e.x*g.z,this._z=e.x*g.y-e.y*g.x,this._w=t),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(II(this.dot(e),-1,1)))}rotateTowards(e,g){const t=this.angleTo(e);if(0===t)return this;const I=Math.min(1,g/t);return this.slerp(e,I),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,g){const t=e._x,I=e._y,n=e._z,i=e._w,C=g._x,o=g._y,a=g._z,s=g._w;return this._x=t*s+i*C+I*a-n*o,this._y=I*s+i*o+n*C-t*a,this._z=n*s+i*a+t*o-I*C,this._w=i*s-t*C-I*o-n*a,this._onChangeCallback(),this}slerp(e,g){if(0===g)return this;if(1===g)return this.copy(e);const t=this._x,I=this._y,n=this._z,i=this._w;let C=i*e._w+t*e._x+I*e._y+n*e._z;if(C<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,C=-C):this.copy(e),C>=1)return this._w=i,this._x=t,this._y=I,this._z=n,this;const o=1-C*C;if(o<=Number.EPSILON){const e=1-g;return this._w=e*i+g*this._w,this._x=e*t+g*this._x,this._y=e*I+g*this._y,this._z=e*n+g*this._z,this.normalize(),this._onChangeCallback(),this}const a=Math.sqrt(o),s=Math.atan2(a,C),l=Math.sin((1-g)*s)/a,r=Math.sin(g*s)/a;return this._w=i*l+this._w*r,this._x=t*l+this._x*r,this._y=I*l+this._y*r,this._z=n*l+this._z*r,this._onChangeCallback(),this}slerpQuaternions(e,g,t){return this.copy(e).slerp(g,t)}random(){const e=Math.random(),g=Math.sqrt(1-e),t=Math.sqrt(e),I=2*Math.PI*Math.random(),n=2*Math.PI*Math.random();return this.set(g*Math.cos(I),t*Math.sin(n),t*Math.cos(n),g*Math.sin(I))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,g=0){return this._x=e[g],this._y=e[g+1],this._z=e[g+2],this._w=e[g+3],this._onChangeCallback(),this}toArray(e=[],g=0){return e[g]=this._x,e[g+1]=this._y,e[g+2]=this._z,e[g+3]=this._w,e}fromBufferAttribute(e,g){return this._x=e.getX(g),this._y=e.getY(g),this._z=e.getZ(g),this._w=e.getW(g),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class UI{constructor(e=0,g=0,t=0){UI.prototype.isVector3=!0,this.x=e,this.y=g,this.z=t}set(e,g,t){return void 0===t&&(t=this.z),this.x=e,this.y=g,this.z=t,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,g){switch(e){case 0:this.x=g;break;case 1:this.y=g;break;case 2:this.z=g;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,g){return this.x=e.x+g.x,this.y=e.y+g.y,this.z=e.z+g.z,this}addScaledVector(e,g){return this.x+=e.x*g,this.y+=e.y*g,this.z+=e.z*g,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,g){return this.x=e.x-g.x,this.y=e.y-g.y,this.z=e.z-g.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,g){return this.x=e.x*g.x,this.y=e.y*g.y,this.z=e.z*g.z,this}applyEuler(e){return this.applyQuaternion(DI.setFromEuler(e))}applyAxisAngle(e,g){return this.applyQuaternion(DI.setFromAxisAngle(e,g))}applyMatrix3(e){const g=this.x,t=this.y,I=this.z,n=e.elements;return this.x=n[0]*g+n[3]*t+n[6]*I,this.y=n[1]*g+n[4]*t+n[7]*I,this.z=n[2]*g+n[5]*t+n[8]*I,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const g=this.x,t=this.y,I=this.z,n=e.elements,i=1/(n[3]*g+n[7]*t+n[11]*I+n[15]);return this.x=(n[0]*g+n[4]*t+n[8]*I+n[12])*i,this.y=(n[1]*g+n[5]*t+n[9]*I+n[13])*i,this.z=(n[2]*g+n[6]*t+n[10]*I+n[14])*i,this}applyQuaternion(e){const g=this.x,t=this.y,I=this.z,n=e.x,i=e.y,C=e.z,o=e.w,a=o*g+i*I-C*t,s=o*t+C*g-n*I,l=o*I+n*t-i*g,r=-n*g-i*t-C*I;return this.x=a*o+r*-n+s*-C-l*-i,this.y=s*o+r*-i+l*-n-a*-C,this.z=l*o+r*-C+a*-i-s*-n,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const g=this.x,t=this.y,I=this.z,n=e.elements;return this.x=n[0]*g+n[4]*t+n[8]*I,this.y=n[1]*g+n[5]*t+n[9]*I,this.z=n[2]*g+n[6]*t+n[10]*I,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,g){return this.x=Math.max(e.x,Math.min(g.x,this.x)),this.y=Math.max(e.y,Math.min(g.y,this.y)),this.z=Math.max(e.z,Math.min(g.z,this.z)),this}clampScalar(e,g){return this.x=Math.max(e,Math.min(g,this.x)),this.y=Math.max(e,Math.min(g,this.y)),this.z=Math.max(e,Math.min(g,this.z)),this}clampLength(e,g){const t=this.length();return this.divideScalar(t||1).multiplyScalar(Math.max(e,Math.min(g,t)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,g){return this.x+=(e.x-this.x)*g,this.y+=(e.y-this.y)*g,this.z+=(e.z-this.z)*g,this}lerpVectors(e,g,t){return this.x=e.x+(g.x-e.x)*t,this.y=e.y+(g.y-e.y)*t,this.z=e.z+(g.z-e.z)*t,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,g){const t=e.x,I=e.y,n=e.z,i=g.x,C=g.y,o=g.z;return this.x=I*o-n*C,this.y=n*i-t*o,this.z=t*C-I*i,this}projectOnVector(e){const g=e.lengthSq();if(0===g)return this.set(0,0,0);const t=e.dot(this)/g;return this.copy(e).multiplyScalar(t)}projectOnPlane(e){return QI.copy(this).projectOnVector(e),this.sub(QI)}reflect(e){return this.sub(QI.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const g=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===g)return Math.PI/2;const t=this.dot(e)/g;return Math.acos(II(t,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const g=this.x-e.x,t=this.y-e.y,I=this.z-e.z;return g*g+t*t+I*I}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,g,t){const I=Math.sin(g)*e;return this.x=I*Math.sin(t),this.y=Math.cos(g)*e,this.z=I*Math.cos(t),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,g,t){return this.x=e*Math.sin(g),this.y=t,this.z=e*Math.cos(g),this}setFromMatrixPosition(e){const g=e.elements;return this.x=g[12],this.y=g[13],this.z=g[14],this}setFromMatrixScale(e){const g=this.setFromMatrixColumn(e,0).length(),t=this.setFromMatrixColumn(e,1).length(),I=this.setFromMatrixColumn(e,2).length();return this.x=g,this.y=t,this.z=I,this}setFromMatrixColumn(e,g){return this.fromArray(e.elements,4*g)}setFromMatrix3Column(e,g){return this.fromArray(e.elements,3*g)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,g=0){return this.x=e[g],this.y=e[g+1],this.z=e[g+2],this}toArray(e=[],g=0){return e[g]=this.x,e[g+1]=this.y,e[g+2]=this.z,e}fromBufferAttribute(e,g){return this.x=e.getX(g),this.y=e.getY(g),this.z=e.getZ(g),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=2*(Math.random()-.5),g=Math.random()*Math.PI*2,t=Math.sqrt(1-e**2);return this.x=t*Math.cos(g),this.y=t*Math.sin(g),this.z=e,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const QI=new UI,DI=new TI;class OI{constructor(e=new UI(1/0,1/0,1/0),g=new UI(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=g}set(e,g){return this.min.copy(e),this.max.copy(g),this}setFromArray(e){this.makeEmpty();for(let g=0,t=e.length;g<t;g+=3)this.expandByPoint(PI.fromArray(e,g));return this}setFromBufferAttribute(e){this.makeEmpty();for(let g=0,t=e.count;g<t;g++)this.expandByPoint(PI.fromBufferAttribute(e,g));return this}setFromPoints(e){this.makeEmpty();for(let g=0,t=e.length;g<t;g++)this.expandByPoint(e[g]);return this}setFromCenterAndSize(e,g){const t=PI.copy(g).multiplyScalar(.5);return this.min.copy(e).sub(t),this.max.copy(e).add(t),this}setFromObject(e,g=!1){return this.makeEmpty(),this.expandByObject(e,g)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,g=!1){if(e.updateWorldMatrix(!1,!1),void 0!==e.boundingBox)null===e.boundingBox&&e.computeBoundingBox(),_I.copy(e.boundingBox),_I.applyMatrix4(e.matrixWorld),this.union(_I);else{const t=e.geometry;if(void 0!==t)if(g&&void 0!==t.attributes&&void 0!==t.attributes.position){const g=t.attributes.position;for(let t=0,I=g.count;t<I;t++)PI.fromBufferAttribute(g,t).applyMatrix4(e.matrixWorld),this.expandByPoint(PI)}else null===t.boundingBox&&t.computeBoundingBox(),_I.copy(t.boundingBox),_I.applyMatrix4(e.matrixWorld),this.union(_I)}const t=e.children;for(let e=0,I=t.length;e<I;e++)this.expandByObject(t[e],g);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,g){return g.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,PI),PI.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let g,t;return e.normal.x>0?(g=e.normal.x*this.min.x,t=e.normal.x*this.max.x):(g=e.normal.x*this.max.x,t=e.normal.x*this.min.x),e.normal.y>0?(g+=e.normal.y*this.min.y,t+=e.normal.y*this.max.y):(g+=e.normal.y*this.max.y,t+=e.normal.y*this.min.y),e.normal.z>0?(g+=e.normal.z*this.min.z,t+=e.normal.z*this.max.z):(g+=e.normal.z*this.max.z,t+=e.normal.z*this.min.z),g<=-e.constant&&t>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(nn),Cn.subVectors(this.max,nn),qI.subVectors(e.a,nn),$I.subVectors(e.b,nn),en.subVectors(e.c,nn),gn.subVectors($I,qI),tn.subVectors(en,$I),In.subVectors(qI,en);let g=[0,-gn.z,gn.y,0,-tn.z,tn.y,0,-In.z,In.y,gn.z,0,-gn.x,tn.z,0,-tn.x,In.z,0,-In.x,-gn.y,gn.x,0,-tn.y,tn.x,0,-In.y,In.x,0];return!!sn(g,qI,$I,en,Cn)&&(g=[1,0,0,0,1,0,0,0,1],!!sn(g,qI,$I,en,Cn)&&(on.crossVectors(gn,tn),g=[on.x,on.y,on.z],sn(g,qI,$I,en,Cn)))}clampPoint(e,g){return g.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,PI).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(PI).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(jI[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),jI[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),jI[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),jI[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),jI[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),jI[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),jI[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),jI[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(jI)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const jI=[new UI,new UI,new UI,new UI,new UI,new UI,new UI,new UI],PI=new UI,_I=new OI,qI=new UI,$I=new UI,en=new UI,gn=new UI,tn=new UI,In=new UI,nn=new UI,Cn=new UI,on=new UI,an=new UI;function sn(e,g,t,I,n){for(let i=0,C=e.length-3;i<=C;i+=3){an.fromArray(e,i);const C=n.x*Math.abs(an.x)+n.y*Math.abs(an.y)+n.z*Math.abs(an.z),o=g.dot(an),a=t.dot(an),s=I.dot(an);if(Math.max(-Math.max(o,a,s),Math.min(o,a,s))>C)return!1}return!0}const ln=new OI,rn=new UI,An=new UI;class cn{constructor(e=new UI,g=-1){this.center=e,this.radius=g}set(e,g){return this.center.copy(e),this.radius=g,this}setFromPoints(e,g){const t=this.center;void 0!==g?t.copy(g):ln.setFromPoints(e).getCenter(t);let I=0;for(let g=0,n=e.length;g<n;g++)I=Math.max(I,t.distanceToSquared(e[g]));return this.radius=Math.sqrt(I),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const g=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=g*g}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,g){const t=this.center.distanceToSquared(e);return g.copy(e),t>this.radius*this.radius&&(g.sub(this.center).normalize(),g.multiplyScalar(this.radius).add(this.center)),g}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;rn.subVectors(e,this.center);const g=rn.lengthSq();if(g>this.radius*this.radius){const e=Math.sqrt(g),t=.5*(e-this.radius);this.center.addScaledVector(rn,t/e),this.radius+=t}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(An.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(rn.copy(e.center).add(An)),this.expandByPoint(rn.copy(e.center).sub(An))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const dn=new UI,un=new UI,hn=new UI,bn=new UI,mn=new UI,pn=new UI,Gn=new UI;class Bn{constructor(e=new UI,g=new UI(0,0,-1)){this.origin=e,this.direction=g}set(e,g){return this.origin.copy(e),this.direction.copy(g),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,g){return g.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,dn)),this}closestPointToPoint(e,g){g.subVectors(e,this.origin);const t=g.dot(this.direction);return t<0?g.copy(this.origin):g.copy(this.origin).addScaledVector(this.direction,t)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const g=dn.subVectors(e,this.origin).dot(this.direction);return g<0?this.origin.distanceToSquared(e):(dn.copy(this.origin).addScaledVector(this.direction,g),dn.distanceToSquared(e))}distanceSqToSegment(e,g,t,I){un.copy(e).add(g).multiplyScalar(.5),hn.copy(g).sub(e).normalize(),bn.copy(this.origin).sub(un);const n=.5*e.distanceTo(g),i=-this.direction.dot(hn),C=bn.dot(this.direction),o=-bn.dot(hn),a=bn.lengthSq(),s=Math.abs(1-i*i);let l,r,A,c;if(s>0)if(l=i*o-C,r=i*C-o,c=n*s,l>=0)if(r>=-c)if(r<=c){const e=1/s;l*=e,r*=e,A=l*(l+i*r+2*C)+r*(i*l+r+2*o)+a}else r=n,l=Math.max(0,-(i*r+C)),A=-l*l+r*(r+2*o)+a;else r=-n,l=Math.max(0,-(i*r+C)),A=-l*l+r*(r+2*o)+a;else r<=-c?(l=Math.max(0,-(-i*n+C)),r=l>0?-n:Math.min(Math.max(-n,-o),n),A=-l*l+r*(r+2*o)+a):r<=c?(l=0,r=Math.min(Math.max(-n,-o),n),A=r*(r+2*o)+a):(l=Math.max(0,-(i*n+C)),r=l>0?n:Math.min(Math.max(-n,-o),n),A=-l*l+r*(r+2*o)+a);else r=i>0?-n:n,l=Math.max(0,-(i*r+C)),A=-l*l+r*(r+2*o)+a;return t&&t.copy(this.origin).addScaledVector(this.direction,l),I&&I.copy(un).addScaledVector(hn,r),A}intersectSphere(e,g){dn.subVectors(e.center,this.origin);const t=dn.dot(this.direction),I=dn.dot(dn)-t*t,n=e.radius*e.radius;if(I>n)return null;const i=Math.sqrt(n-I),C=t-i,o=t+i;return o<0?null:C<0?this.at(o,g):this.at(C,g)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const g=e.normal.dot(this.direction);if(0===g)return 0===e.distanceToPoint(this.origin)?0:null;const t=-(this.origin.dot(e.normal)+e.constant)/g;return t>=0?t:null}intersectPlane(e,g){const t=this.distanceToPlane(e);return null===t?null:this.at(t,g)}intersectsPlane(e){const g=e.distanceToPoint(this.origin);return 0===g||e.normal.dot(this.direction)*g<0}intersectBox(e,g){let t,I,n,i,C,o;const a=1/this.direction.x,s=1/this.direction.y,l=1/this.direction.z,r=this.origin;return a>=0?(t=(e.min.x-r.x)*a,I=(e.max.x-r.x)*a):(t=(e.max.x-r.x)*a,I=(e.min.x-r.x)*a),s>=0?(n=(e.min.y-r.y)*s,i=(e.max.y-r.y)*s):(n=(e.max.y-r.y)*s,i=(e.min.y-r.y)*s),t>i||n>I?null:((n>t||isNaN(t))&&(t=n),(i<I||isNaN(I))&&(I=i),l>=0?(C=(e.min.z-r.z)*l,o=(e.max.z-r.z)*l):(C=(e.max.z-r.z)*l,o=(e.min.z-r.z)*l),t>o||C>I?null:((C>t||t!=t)&&(t=C),(o<I||I!=I)&&(I=o),I<0?null:this.at(t>=0?t:I,g)))}intersectsBox(e){return null!==this.intersectBox(e,dn)}intersectTriangle(e,g,t,I,n){mn.subVectors(g,e),pn.subVectors(t,e),Gn.crossVectors(mn,pn);let i,C=this.direction.dot(Gn);if(C>0){if(I)return null;i=1}else{if(!(C<0))return null;i=-1,C=-C}bn.subVectors(this.origin,e);const o=i*this.direction.dot(pn.crossVectors(bn,pn));if(o<0)return null;const a=i*this.direction.dot(mn.cross(bn));if(a<0)return null;if(o+a>C)return null;const s=-i*bn.dot(Gn);return s<0?null:this.at(s/C,n)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class Zn{constructor(e,g,t,I,n,i,C,o,a,s,l,r,A,c,d,u){Zn.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,g,t,I,n,i,C,o,a,s,l,r,A,c,d,u)}set(e,g,t,I,n,i,C,o,a,s,l,r,A,c,d,u){const h=this.elements;return h[0]=e,h[4]=g,h[8]=t,h[12]=I,h[1]=n,h[5]=i,h[9]=C,h[13]=o,h[2]=a,h[6]=s,h[10]=l,h[14]=r,h[3]=A,h[7]=c,h[11]=d,h[15]=u,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Zn).fromArray(this.elements)}copy(e){const g=this.elements,t=e.elements;return g[0]=t[0],g[1]=t[1],g[2]=t[2],g[3]=t[3],g[4]=t[4],g[5]=t[5],g[6]=t[6],g[7]=t[7],g[8]=t[8],g[9]=t[9],g[10]=t[10],g[11]=t[11],g[12]=t[12],g[13]=t[13],g[14]=t[14],g[15]=t[15],this}copyPosition(e){const g=this.elements,t=e.elements;return g[12]=t[12],g[13]=t[13],g[14]=t[14],this}setFromMatrix3(e){const g=e.elements;return this.set(g[0],g[3],g[6],0,g[1],g[4],g[7],0,g[2],g[5],g[8],0,0,0,0,1),this}extractBasis(e,g,t){return e.setFromMatrixColumn(this,0),g.setFromMatrixColumn(this,1),t.setFromMatrixColumn(this,2),this}makeBasis(e,g,t){return this.set(e.x,g.x,t.x,0,e.y,g.y,t.y,0,e.z,g.z,t.z,0,0,0,0,1),this}extractRotation(e){const g=this.elements,t=e.elements,I=1/yn.setFromMatrixColumn(e,0).length(),n=1/yn.setFromMatrixColumn(e,1).length(),i=1/yn.setFromMatrixColumn(e,2).length();return g[0]=t[0]*I,g[1]=t[1]*I,g[2]=t[2]*I,g[3]=0,g[4]=t[4]*n,g[5]=t[5]*n,g[6]=t[6]*n,g[7]=0,g[8]=t[8]*i,g[9]=t[9]*i,g[10]=t[10]*i,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,this}makeRotationFromEuler(e){const g=this.elements,t=e.x,I=e.y,n=e.z,i=Math.cos(t),C=Math.sin(t),o=Math.cos(I),a=Math.sin(I),s=Math.cos(n),l=Math.sin(n);if("XYZ"===e.order){const e=i*s,t=i*l,I=C*s,n=C*l;g[0]=o*s,g[4]=-o*l,g[8]=a,g[1]=t+I*a,g[5]=e-n*a,g[9]=-C*o,g[2]=n-e*a,g[6]=I+t*a,g[10]=i*o}else if("YXZ"===e.order){const e=o*s,t=o*l,I=a*s,n=a*l;g[0]=e+n*C,g[4]=I*C-t,g[8]=i*a,g[1]=i*l,g[5]=i*s,g[9]=-C,g[2]=t*C-I,g[6]=n+e*C,g[10]=i*o}else if("ZXY"===e.order){const e=o*s,t=o*l,I=a*s,n=a*l;g[0]=e-n*C,g[4]=-i*l,g[8]=I+t*C,g[1]=t+I*C,g[5]=i*s,g[9]=n-e*C,g[2]=-i*a,g[6]=C,g[10]=i*o}else if("ZYX"===e.order){const e=i*s,t=i*l,I=C*s,n=C*l;g[0]=o*s,g[4]=I*a-t,g[8]=e*a+n,g[1]=o*l,g[5]=n*a+e,g[9]=t*a-I,g[2]=-a,g[6]=C*o,g[10]=i*o}else if("YZX"===e.order){const e=i*o,t=i*a,I=C*o,n=C*a;g[0]=o*s,g[4]=n-e*l,g[8]=I*l+t,g[1]=l,g[5]=i*s,g[9]=-C*s,g[2]=-a*s,g[6]=t*l+I,g[10]=e-n*l}else if("XZY"===e.order){const e=i*o,t=i*a,I=C*o,n=C*a;g[0]=o*s,g[4]=-l,g[8]=a*s,g[1]=e*l+n,g[5]=i*s,g[9]=t*l-I,g[2]=I*l-t,g[6]=C*s,g[10]=n*l+e}return g[3]=0,g[7]=0,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,this}makeRotationFromQuaternion(e){return this.compose(Wn,e,fn)}lookAt(e,g,t){const I=this.elements;return Vn.subVectors(e,g),0===Vn.lengthSq()&&(Vn.z=1),Vn.normalize(),wn.crossVectors(t,Vn),0===wn.lengthSq()&&(1===Math.abs(t.z)?Vn.x+=1e-4:Vn.z+=1e-4,Vn.normalize(),wn.crossVectors(t,Vn)),wn.normalize(),Rn.crossVectors(Vn,wn),I[0]=wn.x,I[4]=Rn.x,I[8]=Vn.x,I[1]=wn.y,I[5]=Rn.y,I[9]=Vn.y,I[2]=wn.z,I[6]=Rn.z,I[10]=Vn.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,g){const t=e.elements,I=g.elements,n=this.elements,i=t[0],C=t[4],o=t[8],a=t[12],s=t[1],l=t[5],r=t[9],A=t[13],c=t[2],d=t[6],u=t[10],h=t[14],b=t[3],m=t[7],p=t[11],G=t[15],B=I[0],Z=I[4],y=I[8],v=I[12],W=I[1],f=I[5],w=I[9],R=I[13],V=I[2],X=I[6],S=I[10],Y=I[14],K=I[3],H=I[7],N=I[11],F=I[15];return n[0]=i*B+C*W+o*V+a*K,n[4]=i*Z+C*f+o*X+a*H,n[8]=i*y+C*w+o*S+a*N,n[12]=i*v+C*R+o*Y+a*F,n[1]=s*B+l*W+r*V+A*K,n[5]=s*Z+l*f+r*X+A*H,n[9]=s*y+l*w+r*S+A*N,n[13]=s*v+l*R+r*Y+A*F,n[2]=c*B+d*W+u*V+h*K,n[6]=c*Z+d*f+u*X+h*H,n[10]=c*y+d*w+u*S+h*N,n[14]=c*v+d*R+u*Y+h*F,n[3]=b*B+m*W+p*V+G*K,n[7]=b*Z+m*f+p*X+G*H,n[11]=b*y+m*w+p*S+G*N,n[15]=b*v+m*R+p*Y+G*F,this}multiplyScalar(e){const g=this.elements;return g[0]*=e,g[4]*=e,g[8]*=e,g[12]*=e,g[1]*=e,g[5]*=e,g[9]*=e,g[13]*=e,g[2]*=e,g[6]*=e,g[10]*=e,g[14]*=e,g[3]*=e,g[7]*=e,g[11]*=e,g[15]*=e,this}determinant(){const e=this.elements,g=e[0],t=e[4],I=e[8],n=e[12],i=e[1],C=e[5],o=e[9],a=e[13],s=e[2],l=e[6],r=e[10],A=e[14];return e[3]*(+n*o*l-I*a*l-n*C*r+t*a*r+I*C*A-t*o*A)+e[7]*(+g*o*A-g*a*r+n*i*r-I*i*A+I*a*s-n*o*s)+e[11]*(+g*a*l-g*C*A-n*i*l+t*i*A+n*C*s-t*a*s)+e[15]*(-I*C*s-g*o*l+g*C*r+I*i*l-t*i*r+t*o*s)}transpose(){const e=this.elements;let g;return g=e[1],e[1]=e[4],e[4]=g,g=e[2],e[2]=e[8],e[8]=g,g=e[6],e[6]=e[9],e[9]=g,g=e[3],e[3]=e[12],e[12]=g,g=e[7],e[7]=e[13],e[13]=g,g=e[11],e[11]=e[14],e[14]=g,this}setPosition(e,g,t){const I=this.elements;return e.isVector3?(I[12]=e.x,I[13]=e.y,I[14]=e.z):(I[12]=e,I[13]=g,I[14]=t),this}invert(){const e=this.elements,g=e[0],t=e[1],I=e[2],n=e[3],i=e[4],C=e[5],o=e[6],a=e[7],s=e[8],l=e[9],r=e[10],A=e[11],c=e[12],d=e[13],u=e[14],h=e[15],b=l*u*a-d*r*a+d*o*A-C*u*A-l*o*h+C*r*h,m=c*r*a-s*u*a-c*o*A+i*u*A+s*o*h-i*r*h,p=s*d*a-c*l*a+c*C*A-i*d*A-s*C*h+i*l*h,G=c*l*o-s*d*o-c*C*r+i*d*r+s*C*u-i*l*u,B=g*b+t*m+I*p+n*G;if(0===B)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const Z=1/B;return e[0]=b*Z,e[1]=(d*r*n-l*u*n-d*I*A+t*u*A+l*I*h-t*r*h)*Z,e[2]=(C*u*n-d*o*n+d*I*a-t*u*a-C*I*h+t*o*h)*Z,e[3]=(l*o*n-C*r*n-l*I*a+t*r*a+C*I*A-t*o*A)*Z,e[4]=m*Z,e[5]=(s*u*n-c*r*n+c*I*A-g*u*A-s*I*h+g*r*h)*Z,e[6]=(c*o*n-i*u*n-c*I*a+g*u*a+i*I*h-g*o*h)*Z,e[7]=(i*r*n-s*o*n+s*I*a-g*r*a-i*I*A+g*o*A)*Z,e[8]=p*Z,e[9]=(c*l*n-s*d*n-c*t*A+g*d*A+s*t*h-g*l*h)*Z,e[10]=(i*d*n-c*C*n+c*t*a-g*d*a-i*t*h+g*C*h)*Z,e[11]=(s*C*n-i*l*n-s*t*a+g*l*a+i*t*A-g*C*A)*Z,e[12]=G*Z,e[13]=(s*d*I-c*l*I+c*t*r-g*d*r-s*t*u+g*l*u)*Z,e[14]=(c*C*I-i*d*I-c*t*o+g*d*o+i*t*u-g*C*u)*Z,e[15]=(i*l*I-s*C*I+s*t*o-g*l*o-i*t*r+g*C*r)*Z,this}scale(e){const g=this.elements,t=e.x,I=e.y,n=e.z;return g[0]*=t,g[4]*=I,g[8]*=n,g[1]*=t,g[5]*=I,g[9]*=n,g[2]*=t,g[6]*=I,g[10]*=n,g[3]*=t,g[7]*=I,g[11]*=n,this}getMaxScaleOnAxis(){const e=this.elements,g=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],t=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],I=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(g,t,I))}makeTranslation(e,g,t){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,g,0,0,1,t,0,0,0,1),this}makeRotationX(e){const g=Math.cos(e),t=Math.sin(e);return this.set(1,0,0,0,0,g,-t,0,0,t,g,0,0,0,0,1),this}makeRotationY(e){const g=Math.cos(e),t=Math.sin(e);return this.set(g,0,t,0,0,1,0,0,-t,0,g,0,0,0,0,1),this}makeRotationZ(e){const g=Math.cos(e),t=Math.sin(e);return this.set(g,-t,0,0,t,g,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,g){const t=Math.cos(g),I=Math.sin(g),n=1-t,i=e.x,C=e.y,o=e.z,a=n*i,s=n*C;return this.set(a*i+t,a*C-I*o,a*o+I*C,0,a*C+I*o,s*C+t,s*o-I*i,0,a*o-I*C,s*o+I*i,n*o*o+t,0,0,0,0,1),this}makeScale(e,g,t){return this.set(e,0,0,0,0,g,0,0,0,0,t,0,0,0,0,1),this}makeShear(e,g,t,I,n,i){return this.set(1,t,n,0,e,1,i,0,g,I,1,0,0,0,0,1),this}compose(e,g,t){const I=this.elements,n=g._x,i=g._y,C=g._z,o=g._w,a=n+n,s=i+i,l=C+C,r=n*a,A=n*s,c=n*l,d=i*s,u=i*l,h=C*l,b=o*a,m=o*s,p=o*l,G=t.x,B=t.y,Z=t.z;return I[0]=(1-(d+h))*G,I[1]=(A+p)*G,I[2]=(c-m)*G,I[3]=0,I[4]=(A-p)*B,I[5]=(1-(r+h))*B,I[6]=(u+b)*B,I[7]=0,I[8]=(c+m)*Z,I[9]=(u-b)*Z,I[10]=(1-(r+d))*Z,I[11]=0,I[12]=e.x,I[13]=e.y,I[14]=e.z,I[15]=1,this}decompose(e,g,t){const I=this.elements;let n=yn.set(I[0],I[1],I[2]).length();const i=yn.set(I[4],I[5],I[6]).length(),C=yn.set(I[8],I[9],I[10]).length();this.determinant()<0&&(n=-n),e.x=I[12],e.y=I[13],e.z=I[14],vn.copy(this);const o=1/n,a=1/i,s=1/C;return vn.elements[0]*=o,vn.elements[1]*=o,vn.elements[2]*=o,vn.elements[4]*=a,vn.elements[5]*=a,vn.elements[6]*=a,vn.elements[8]*=s,vn.elements[9]*=s,vn.elements[10]*=s,g.setFromRotationMatrix(vn),t.x=n,t.y=i,t.z=C,this}makePerspective(e,g,t,I,n,i,C=jt){const o=this.elements,a=2*n/(g-e),s=2*n/(t-I),l=(g+e)/(g-e),r=(t+I)/(t-I);let A,c;if(C===jt)A=-(i+n)/(i-n),c=-2*i*n/(i-n);else{if(C!==Pt)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+C);A=-i/(i-n),c=-i*n/(i-n)}return o[0]=a,o[4]=0,o[8]=l,o[12]=0,o[1]=0,o[5]=s,o[9]=r,o[13]=0,o[2]=0,o[6]=0,o[10]=A,o[14]=c,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(e,g,t,I,n,i,C=jt){const o=this.elements,a=1/(g-e),s=1/(t-I),l=1/(i-n),r=(g+e)*a,A=(t+I)*s;let c,d;if(C===jt)c=(i+n)*l,d=-2*l;else{if(C!==Pt)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+C);c=n*l,d=-1*l}return o[0]=2*a,o[4]=0,o[8]=0,o[12]=-r,o[1]=0,o[5]=2*s,o[9]=0,o[13]=-A,o[2]=0,o[6]=0,o[10]=d,o[14]=-c,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(e){const g=this.elements,t=e.elements;for(let e=0;e<16;e++)if(g[e]!==t[e])return!1;return!0}fromArray(e,g=0){for(let t=0;t<16;t++)this.elements[t]=e[t+g];return this}toArray(e=[],g=0){const t=this.elements;return e[g]=t[0],e[g+1]=t[1],e[g+2]=t[2],e[g+3]=t[3],e[g+4]=t[4],e[g+5]=t[5],e[g+6]=t[6],e[g+7]=t[7],e[g+8]=t[8],e[g+9]=t[9],e[g+10]=t[10],e[g+11]=t[11],e[g+12]=t[12],e[g+13]=t[13],e[g+14]=t[14],e[g+15]=t[15],e}}const yn=new UI,vn=new Zn,Wn=new UI(0,0,0),fn=new UI(1,1,1),wn=new UI,Rn=new UI,Vn=new UI,Xn=new Zn,Sn=new TI;class Yn{constructor(e=0,g=0,t=0,I=Yn.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=g,this._z=t,this._order=I}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,g,t,I=this._order){return this._x=e,this._y=g,this._z=t,this._order=I,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,g=this._order,t=!0){const I=e.elements,n=I[0],i=I[4],C=I[8],o=I[1],a=I[5],s=I[9],l=I[2],r=I[6],A=I[10];switch(g){case"XYZ":this._y=Math.asin(II(C,-1,1)),Math.abs(C)<.9999999?(this._x=Math.atan2(-s,A),this._z=Math.atan2(-i,n)):(this._x=Math.atan2(r,a),this._z=0);break;case"YXZ":this._x=Math.asin(-II(s,-1,1)),Math.abs(s)<.9999999?(this._y=Math.atan2(C,A),this._z=Math.atan2(o,a)):(this._y=Math.atan2(-l,n),this._z=0);break;case"ZXY":this._x=Math.asin(II(r,-1,1)),Math.abs(r)<.9999999?(this._y=Math.atan2(-l,A),this._z=Math.atan2(-i,a)):(this._y=0,this._z=Math.atan2(o,n));break;case"ZYX":this._y=Math.asin(-II(l,-1,1)),Math.abs(l)<.9999999?(this._x=Math.atan2(r,A),this._z=Math.atan2(o,n)):(this._x=0,this._z=Math.atan2(-i,a));break;case"YZX":this._z=Math.asin(II(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-s,a),this._y=Math.atan2(-l,n)):(this._x=0,this._y=Math.atan2(C,A));break;case"XZY":this._z=Math.asin(-II(i,-1,1)),Math.abs(i)<.9999999?(this._x=Math.atan2(r,a),this._y=Math.atan2(C,n)):(this._x=Math.atan2(-s,A),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+g)}return this._order=g,!0===t&&this._onChangeCallback(),this}setFromQuaternion(e,g,t){return Xn.makeRotationFromQuaternion(e),this.setFromRotationMatrix(Xn,g,t)}setFromVector3(e,g=this._order){return this.set(e.x,e.y,e.z,g)}reorder(e){return Sn.setFromEuler(this),this.setFromQuaternion(Sn,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],g=0){return e[g]=this._x,e[g+1]=this._y,e[g+2]=this._z,e[g+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Yn.DEFAULT_ORDER="XYZ";class Kn{constructor(){this.mask=1}set(e){this.mask=(1<<e|0)>>>0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return 0!=(this.mask&e.mask)}isEnabled(e){return 0!=(this.mask&(1<<e|0))}}let Hn=0;const Nn=new UI,Fn=new TI,xn=new Zn,zn=new UI,kn=new UI,Mn=new UI,Ln=new TI,Jn=new UI(1,0,0),En=new UI(0,1,0),Tn=new UI(0,0,1),Un={type:"added"},Qn={type:"removed"};class Dn extends _t{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Hn++}),this.uuid=tI(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Dn.DEFAULT_UP.clone();const e=new UI,g=new Yn,t=new TI,I=new UI(1,1,1);g._onChange((function(){t.setFromEuler(g,!1)})),t._onChange((function(){g.setFromQuaternion(t,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:g},quaternion:{configurable:!0,enumerable:!0,value:t},scale:{configurable:!0,enumerable:!0,value:I},modelViewMatrix:{value:new Zn},normalMatrix:{value:new cI}}),this.matrix=new Zn,this.matrixWorld=new Zn,this.matrixAutoUpdate=Dn.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.matrixWorldAutoUpdate=Dn.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.layers=new Kn,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,g){this.quaternion.setFromAxisAngle(e,g)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,g){return Fn.setFromAxisAngle(e,g),this.quaternion.multiply(Fn),this}rotateOnWorldAxis(e,g){return Fn.setFromAxisAngle(e,g),this.quaternion.premultiply(Fn),this}rotateX(e){return this.rotateOnAxis(Jn,e)}rotateY(e){return this.rotateOnAxis(En,e)}rotateZ(e){return this.rotateOnAxis(Tn,e)}translateOnAxis(e,g){return Nn.copy(e).applyQuaternion(this.quaternion),this.position.add(Nn.multiplyScalar(g)),this}translateX(e){return this.translateOnAxis(Jn,e)}translateY(e){return this.translateOnAxis(En,e)}translateZ(e){return this.translateOnAxis(Tn,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(xn.copy(this.matrixWorld).invert())}lookAt(e,g,t){e.isVector3?zn.copy(e):zn.set(e,g,t);const I=this.parent;this.updateWorldMatrix(!0,!1),kn.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?xn.lookAt(kn,zn,this.up):xn.lookAt(zn,kn,this.up),this.quaternion.setFromRotationMatrix(xn),I&&(xn.extractRotation(I.matrixWorld),Fn.setFromRotationMatrix(xn),this.quaternion.premultiply(Fn.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(Un)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const g=this.children.indexOf(e);return-1!==g&&(e.parent=null,this.children.splice(g,1),e.dispatchEvent(Qn)),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),xn.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),xn.multiply(e.parent.matrixWorld)),e.applyMatrix4(xn),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,g){if(this[e]===g)return this;for(let t=0,I=this.children.length;t<I;t++){const I=this.children[t].getObjectByProperty(e,g);if(void 0!==I)return I}}getObjectsByProperty(e,g){let t=[];this[e]===g&&t.push(this);for(let I=0,n=this.children.length;I<n;I++){const n=this.children[I].getObjectsByProperty(e,g);n.length>0&&(t=t.concat(n))}return t}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(kn,e,Mn),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(kn,Ln,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const g=this.matrixWorld.elements;return e.set(g[8],g[9],g[10]).normalize()}raycast(){}traverse(e){e(this);const g=this.children;for(let t=0,I=g.length;t<I;t++)g[t].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const g=this.children;for(let t=0,I=g.length;t<I;t++)g[t].traverseVisible(e)}traverseAncestors(e){const g=this.parent;null!==g&&(e(g),g.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const g=this.children;for(let t=0,I=g.length;t<I;t++){const I=g[t];!0!==I.matrixWorldAutoUpdate&&!0!==e||I.updateMatrixWorld(e)}}updateWorldMatrix(e,g){const t=this.parent;if(!0===e&&null!==t&&!0===t.matrixWorldAutoUpdate&&t.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===g){const e=this.children;for(let g=0,t=e.length;g<t;g++){const t=e[g];!0===t.matrixWorldAutoUpdate&&t.updateWorldMatrix(!1,!0)}}}toJSON(e){const g=void 0===e||"string"==typeof e,t={};g&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},t.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const I={};function n(g,t){return void 0===g[t.uuid]&&(g[t.uuid]=t.toJSON(e)),t.uuid}if(I.uuid=this.uuid,I.type=this.type,""!==this.name&&(I.name=this.name),!0===this.castShadow&&(I.castShadow=!0),!0===this.receiveShadow&&(I.receiveShadow=!0),!1===this.visible&&(I.visible=!1),!1===this.frustumCulled&&(I.frustumCulled=!1),0!==this.renderOrder&&(I.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(I.userData=this.userData),I.layers=this.layers.mask,I.matrix=this.matrix.toArray(),I.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(I.matrixAutoUpdate=!1),this.isInstancedMesh&&(I.type="InstancedMesh",I.count=this.count,I.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(I.instanceColor=this.instanceColor.toJSON())),this.isScene)this.background&&(this.background.isColor?I.background=this.background.toJSON():this.background.isTexture&&(I.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(I.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){I.geometry=n(e.geometries,this.geometry);const g=this.geometry.parameters;if(void 0!==g&&void 0!==g.shapes){const t=g.shapes;if(Array.isArray(t))for(let g=0,I=t.length;g<I;g++){const I=t[g];n(e.shapes,I)}else n(e.shapes,t)}}if(this.isSkinnedMesh&&(I.bindMode=this.bindMode,I.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(n(e.skeletons,this.skeleton),I.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const g=[];for(let t=0,I=this.material.length;t<I;t++)g.push(n(e.materials,this.material[t]));I.material=g}else I.material=n(e.materials,this.material);if(this.children.length>0){I.children=[];for(let g=0;g<this.children.length;g++)I.children.push(this.children[g].toJSON(e).object)}if(this.animations.length>0){I.animations=[];for(let g=0;g<this.animations.length;g++){const t=this.animations[g];I.animations.push(n(e.animations,t))}}if(g){const g=i(e.geometries),I=i(e.materials),n=i(e.textures),C=i(e.images),o=i(e.shapes),a=i(e.skeletons),s=i(e.animations),l=i(e.nodes);g.length>0&&(t.geometries=g),I.length>0&&(t.materials=I),n.length>0&&(t.textures=n),C.length>0&&(t.images=C),o.length>0&&(t.shapes=o),a.length>0&&(t.skeletons=a),s.length>0&&(t.animations=s),l.length>0&&(t.nodes=l)}return t.object=I,t;function i(e){const g=[];for(const t in e){const I=e[t];delete I.metadata,g.push(I)}return g}}clone(e){return(new this.constructor).copy(this,e)}copy(e,g=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===g)for(let g=0;g<e.children.length;g++){const t=e.children[g];this.add(t.clone())}return this}}Dn.DEFAULT_UP=new UI(0,1,0),Dn.DEFAULT_MATRIX_AUTO_UPDATE=!0,Dn.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const On=new UI,jn=new UI,Pn=new UI,_n=new UI,qn=new UI,$n=new UI,ei=new UI,gi=new UI,ti=new UI,Ii=new UI;let ni=!1;class ii{constructor(e=new UI,g=new UI,t=new UI){this.a=e,this.b=g,this.c=t}static getNormal(e,g,t,I){I.subVectors(t,g),On.subVectors(e,g),I.cross(On);const n=I.lengthSq();return n>0?I.multiplyScalar(1/Math.sqrt(n)):I.set(0,0,0)}static getBarycoord(e,g,t,I,n){On.subVectors(I,g),jn.subVectors(t,g),Pn.subVectors(e,g);const i=On.dot(On),C=On.dot(jn),o=On.dot(Pn),a=jn.dot(jn),s=jn.dot(Pn),l=i*a-C*C;if(0===l)return n.set(-2,-1,-1);const r=1/l,A=(a*o-C*s)*r,c=(i*s-C*o)*r;return n.set(1-A-c,c,A)}static containsPoint(e,g,t,I){return this.getBarycoord(e,g,t,I,_n),_n.x>=0&&_n.y>=0&&_n.x+_n.y<=1}static getUV(e,g,t,I,n,i,C,o){return!1===ni&&(console.warn("THREE.Triangle.getUV() has been renamed to THREE.Triangle.getInterpolation()."),ni=!0),this.getInterpolation(e,g,t,I,n,i,C,o)}static getInterpolation(e,g,t,I,n,i,C,o){return this.getBarycoord(e,g,t,I,_n),o.setScalar(0),o.addScaledVector(n,_n.x),o.addScaledVector(i,_n.y),o.addScaledVector(C,_n.z),o}static isFrontFacing(e,g,t,I){return On.subVectors(t,g),jn.subVectors(e,g),On.cross(jn).dot(I)<0}set(e,g,t){return this.a.copy(e),this.b.copy(g),this.c.copy(t),this}setFromPointsAndIndices(e,g,t,I){return this.a.copy(e[g]),this.b.copy(e[t]),this.c.copy(e[I]),this}setFromAttributeAndIndices(e,g,t,I){return this.a.fromBufferAttribute(e,g),this.b.fromBufferAttribute(e,t),this.c.fromBufferAttribute(e,I),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return On.subVectors(this.c,this.b),jn.subVectors(this.a,this.b),.5*On.cross(jn).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return ii.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,g){return ii.getBarycoord(e,this.a,this.b,this.c,g)}getUV(e,g,t,I,n){return!1===ni&&(console.warn("THREE.Triangle.getUV() has been renamed to THREE.Triangle.getInterpolation()."),ni=!0),ii.getInterpolation(e,this.a,this.b,this.c,g,t,I,n)}getInterpolation(e,g,t,I,n){return ii.getInterpolation(e,this.a,this.b,this.c,g,t,I,n)}containsPoint(e){return ii.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return ii.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,g){const t=this.a,I=this.b,n=this.c;let i,C;qn.subVectors(I,t),$n.subVectors(n,t),gi.subVectors(e,t);const o=qn.dot(gi),a=$n.dot(gi);if(o<=0&&a<=0)return g.copy(t);ti.subVectors(e,I);const s=qn.dot(ti),l=$n.dot(ti);if(s>=0&&l<=s)return g.copy(I);const r=o*l-s*a;if(r<=0&&o>=0&&s<=0)return i=o/(o-s),g.copy(t).addScaledVector(qn,i);Ii.subVectors(e,n);const A=qn.dot(Ii),c=$n.dot(Ii);if(c>=0&&A<=c)return g.copy(n);const d=A*a-o*c;if(d<=0&&a>=0&&c<=0)return C=a/(a-c),g.copy(t).addScaledVector($n,C);const u=s*c-A*l;if(u<=0&&l-s>=0&&A-c>=0)return ei.subVectors(n,I),C=(l-s)/(l-s+(A-c)),g.copy(I).addScaledVector(ei,C);const h=1/(u+d+r);return i=d*h,C=r*h,g.copy(t).addScaledVector(qn,i).addScaledVector($n,C)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}let Ci=0;class oi extends _t{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Ci++}),this.uuid=tI(),this.name="",this.type="Material",this.blending=N,this.side=X,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=j,this.blendDst=P,this.blendEquation=M,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=ie,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=Rt,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=dt,this.stencilZFail=dt,this.stencilZPass=dt,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const g in e){const t=e[g];if(void 0===t){console.warn(`THREE.Material: parameter '${g}' has value of undefined.`);continue}const I=this[g];void 0!==I?I&&I.isColor?I.set(t):I&&I.isVector3&&t&&t.isVector3?I.copy(t):this[g]=t:console.warn(`THREE.Material: '${g}' is not a property of THREE.${this.type}.`)}}toJSON(e){const g=void 0===e||"string"==typeof e;g&&(e={textures:{},images:{}});const t={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function I(e){const g=[];for(const t in e){const I=e[t];delete I.metadata,g.push(I)}return g}if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),this.color&&this.color.isColor&&(t.color=this.color.getHex()),void 0!==this.roughness&&(t.roughness=this.roughness),void 0!==this.metalness&&(t.metalness=this.metalness),void 0!==this.sheen&&(t.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(t.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(t.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(t.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(t.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(t.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(t.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(t.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(t.shininess=this.shininess),void 0!==this.clearcoat&&(t.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(t.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(t.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(t.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(t.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,t.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.iridescence&&(t.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(t.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(t.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(t.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(t.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(t.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(t.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(t.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(t.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(t.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(t.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(t.lightMap=this.lightMap.toJSON(e).uuid,t.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(t.aoMap=this.aoMap.toJSON(e).uuid,t.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(t.bumpMap=this.bumpMap.toJSON(e).uuid,t.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(t.normalMap=this.normalMap.toJSON(e).uuid,t.normalMapType=this.normalMapType,t.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(t.displacementMap=this.displacementMap.toJSON(e).uuid,t.displacementScale=this.displacementScale,t.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(t.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(t.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(t.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(t.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(t.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(t.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(t.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(t.combine=this.combine)),void 0!==this.envMapIntensity&&(t.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(t.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(t.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(t.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(t.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(t.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(t.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(t.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(t.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(t.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(t.size=this.size),null!==this.shadowSide&&(t.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(t.sizeAttenuation=this.sizeAttenuation),this.blending!==N&&(t.blending=this.blending),this.side!==X&&(t.side=this.side),!0===this.vertexColors&&(t.vertexColors=!0),this.opacity<1&&(t.opacity=this.opacity),!0===this.transparent&&(t.transparent=!0),t.depthFunc=this.depthFunc,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite,t.colorWrite=this.colorWrite,t.stencilWrite=this.stencilWrite,t.stencilWriteMask=this.stencilWriteMask,t.stencilFunc=this.stencilFunc,t.stencilRef=this.stencilRef,t.stencilFuncMask=this.stencilFuncMask,t.stencilFail=this.stencilFail,t.stencilZFail=this.stencilZFail,t.stencilZPass=this.stencilZPass,void 0!==this.rotation&&0!==this.rotation&&(t.rotation=this.rotation),!0===this.polygonOffset&&(t.polygonOffset=!0),0!==this.polygonOffsetFactor&&(t.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(t.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(t.linewidth=this.linewidth),void 0!==this.dashSize&&(t.dashSize=this.dashSize),void 0!==this.gapSize&&(t.gapSize=this.gapSize),void 0!==this.scale&&(t.scale=this.scale),!0===this.dithering&&(t.dithering=!0),this.alphaTest>0&&(t.alphaTest=this.alphaTest),!0===this.alphaHash&&(t.alphaHash=!0),!0===this.alphaToCoverage&&(t.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(t.premultipliedAlpha=!0),!0===this.forceSinglePass&&(t.forceSinglePass=!0),!0===this.wireframe&&(t.wireframe=!0),this.wireframeLinewidth>1&&(t.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(t.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(t.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(t.flatShading=!0),!1===this.visible&&(t.visible=!1),!1===this.toneMapped&&(t.toneMapped=!1),!1===this.fog&&(t.fog=!1),Object.keys(this.userData).length>0&&(t.userData=this.userData),g){const g=I(e.textures),n=I(e.images);g.length>0&&(t.textures=g),n.length>0&&(t.images=n)}return t}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const g=e.clippingPlanes;let t=null;if(null!==g){const e=g.length;t=new Array(e);for(let I=0;I!==e;++I)t[I]=g[I].clone()}return this.clippingPlanes=t,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}const ai={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},si={h:0,s:0,l:0},li={h:0,s:0,l:0};function ri(e,g,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?e+6*(g-e)*t:t<.5?g:t<2/3?e+6*(g-e)*(2/3-t):e}class Ai{constructor(e,g,t){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,g,t)}set(e,g,t){if(void 0===g&&void 0===t){const g=e;g&&g.isColor?this.copy(g):"number"==typeof g?this.setHex(g):"string"==typeof g&&this.setStyle(g)}else this.setRGB(e,g,t);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,g=it){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,fI.toWorkingColorSpace(this,g),this}setRGB(e,g,t,I=fI.workingColorSpace){return this.r=e,this.g=g,this.b=t,fI.toWorkingColorSpace(this,I),this}setHSL(e,g,t,I=fI.workingColorSpace){if(e=nI(e,1),g=II(g,0,1),t=II(t,0,1),0===g)this.r=this.g=this.b=t;else{const I=t<=.5?t*(1+g):t+g-t*g,n=2*t-I;this.r=ri(n,I,e+1/3),this.g=ri(n,I,e),this.b=ri(n,I,e-1/3)}return fI.toWorkingColorSpace(this,I),this}setStyle(e,g=it){function t(g){void 0!==g&&parseFloat(g)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let I;if(I=/^(\w+)\(([^\)]*)\)/.exec(e)){let n;const i=I[1],C=I[2];switch(i){case"rgb":case"rgba":if(n=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(C))return t(n[4]),this.setRGB(Math.min(255,parseInt(n[1],10))/255,Math.min(255,parseInt(n[2],10))/255,Math.min(255,parseInt(n[3],10))/255,g);if(n=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(C))return t(n[4]),this.setRGB(Math.min(100,parseInt(n[1],10))/100,Math.min(100,parseInt(n[2],10))/100,Math.min(100,parseInt(n[3],10))/100,g);break;case"hsl":case"hsla":if(n=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(C))return t(n[4]),this.setHSL(parseFloat(n[1])/360,parseFloat(n[2])/100,parseFloat(n[3])/100,g);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(I=/^\#([A-Fa-f\d]+)$/.exec(e)){const t=I[1],n=t.length;if(3===n)return this.setRGB(parseInt(t.charAt(0),16)/15,parseInt(t.charAt(1),16)/15,parseInt(t.charAt(2),16)/15,g);if(6===n)return this.setHex(parseInt(t,16),g);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,g);return this}setColorName(e,g=it){const t=ai[e.toLowerCase()];return void 0!==t?this.setHex(t,g):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=wI(e.r),this.g=wI(e.g),this.b=wI(e.b),this}copyLinearToSRGB(e){return this.r=RI(e.r),this.g=RI(e.g),this.b=RI(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=it){return fI.fromWorkingColorSpace(ci.copy(this),e),65536*Math.round(II(255*ci.r,0,255))+256*Math.round(II(255*ci.g,0,255))+Math.round(II(255*ci.b,0,255))}getHexString(e=it){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,g=fI.workingColorSpace){fI.fromWorkingColorSpace(ci.copy(this),g);const t=ci.r,I=ci.g,n=ci.b,i=Math.max(t,I,n),C=Math.min(t,I,n);let o,a;const s=(C+i)/2;if(C===i)o=0,a=0;else{const e=i-C;switch(a=s<=.5?e/(i+C):e/(2-i-C),i){case t:o=(I-n)/e+(I<n?6:0);break;case I:o=(n-t)/e+2;break;case n:o=(t-I)/e+4}o/=6}return e.h=o,e.s=a,e.l=s,e}getRGB(e,g=fI.workingColorSpace){return fI.fromWorkingColorSpace(ci.copy(this),g),e.r=ci.r,e.g=ci.g,e.b=ci.b,e}getStyle(e=it){fI.fromWorkingColorSpace(ci.copy(this),e);const g=ci.r,t=ci.g,I=ci.b;return e!==it?`color(${e} ${g.toFixed(3)} ${t.toFixed(3)} ${I.toFixed(3)})`:`rgb(${Math.round(255*g)},${Math.round(255*t)},${Math.round(255*I)})`}offsetHSL(e,g,t){return this.getHSL(si),this.setHSL(si.h+e,si.s+g,si.l+t)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,g){return this.r=e.r+g.r,this.g=e.g+g.g,this.b=e.b+g.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,g){return this.r+=(e.r-this.r)*g,this.g+=(e.g-this.g)*g,this.b+=(e.b-this.b)*g,this}lerpColors(e,g,t){return this.r=e.r+(g.r-e.r)*t,this.g=e.g+(g.g-e.g)*t,this.b=e.b+(g.b-e.b)*t,this}lerpHSL(e,g){this.getHSL(si),e.getHSL(li);const t=iI(si.h,li.h,g),I=iI(si.s,li.s,g),n=iI(si.l,li.l,g);return this.setHSL(t,I,n),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const g=this.r,t=this.g,I=this.b,n=e.elements;return this.r=n[0]*g+n[3]*t+n[6]*I,this.g=n[1]*g+n[4]*t+n[7]*I,this.b=n[2]*g+n[5]*t+n[8]*I,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,g=0){return this.r=e[g],this.g=e[g+1],this.b=e[g+2],this}toArray(e=[],g=0){return e[g]=this.r,e[g+1]=this.g,e[g+2]=this.b,e}fromBufferAttribute(e,g){return this.r=e.getX(g),this.g=e.getY(g),this.b=e.getZ(g),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const ci=new Ai;Ai.NAMES=ai;class di extends oi{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Ai(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=le,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const ui=hi();function hi(){const e=new ArrayBuffer(4),g=new Float32Array(e),t=new Uint32Array(e),I=new Uint32Array(512),n=new Uint32Array(512);for(let e=0;e<256;++e){const g=e-127;g<-27?(I[e]=0,I[256|e]=32768,n[e]=24,n[256|e]=24):g<-14?(I[e]=1024>>-g-14,I[256|e]=1024>>-g-14|32768,n[e]=-g-1,n[256|e]=-g-1):g<=15?(I[e]=g+15<<10,I[256|e]=g+15<<10|32768,n[e]=13,n[256|e]=13):g<128?(I[e]=31744,I[256|e]=64512,n[e]=24,n[256|e]=24):(I[e]=31744,I[256|e]=64512,n[e]=13,n[256|e]=13)}const i=new Uint32Array(2048),C=new Uint32Array(64),o=new Uint32Array(64);for(let e=1;e<1024;++e){let g=e<<13,t=0;for(;0==(8388608&g);)g<<=1,t-=8388608;g&=-8388609,t+=947912704,i[e]=g|t}for(let e=1024;e<2048;++e)i[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)C[e]=e<<23;C[31]=1199570944,C[32]=2147483648;for(let e=33;e<63;++e)C[e]=2147483648+(e-32<<23);C[63]=3347054592;for(let e=1;e<64;++e)32!==e&&(o[e]=1024);return{floatView:g,uint32View:t,baseTable:I,shiftTable:n,mantissaTable:i,exponentTable:C,offsetTable:o}}function bi(e){Math.abs(e)>65504&&console.warn("THREE.DataUtils.toHalfFloat(): Value out of range."),e=II(e,-65504,65504),ui.floatView[0]=e;const g=ui.uint32View[0],t=g>>23&511;return ui.baseTable[t]+((8388607&g)>>ui.shiftTable[t])}function mi(e){const g=e>>10;return ui.uint32View[0]=ui.mantissaTable[ui.offsetTable[g]+(1023&e)]+ui.exponentTable[g],ui.floatView[0]}const pi={toHalfFloat:bi,fromHalfFloat:mi},Gi=new UI,Bi=new AI;class Zi{constructor(e,g,t=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=e,this.itemSize=g,this.count=void 0!==e?e.length/g:0,this.normalized=t,this.usage=xt,this.updateRange={offset:0,count:-1},this.gpuType=Te,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,g,t){e*=this.itemSize,t*=g.itemSize;for(let I=0,n=this.itemSize;I<n;I++)this.array[e+I]=g.array[t+I];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let g=0,t=this.count;g<t;g++)Bi.fromBufferAttribute(this,g),Bi.applyMatrix3(e),this.setXY(g,Bi.x,Bi.y);else if(3===this.itemSize)for(let g=0,t=this.count;g<t;g++)Gi.fromBufferAttribute(this,g),Gi.applyMatrix3(e),this.setXYZ(g,Gi.x,Gi.y,Gi.z);return this}applyMatrix4(e){for(let g=0,t=this.count;g<t;g++)Gi.fromBufferAttribute(this,g),Gi.applyMatrix4(e),this.setXYZ(g,Gi.x,Gi.y,Gi.z);return this}applyNormalMatrix(e){for(let g=0,t=this.count;g<t;g++)Gi.fromBufferAttribute(this,g),Gi.applyNormalMatrix(e),this.setXYZ(g,Gi.x,Gi.y,Gi.z);return this}transformDirection(e){for(let g=0,t=this.count;g<t;g++)Gi.fromBufferAttribute(this,g),Gi.transformDirection(e),this.setXYZ(g,Gi.x,Gi.y,Gi.z);return this}set(e,g=0){return this.array.set(e,g),this}getComponent(e,g){let t=this.array[e*this.itemSize+g];return this.normalized&&(t=sI(t,this.array)),t}setComponent(e,g,t){return this.normalized&&(t=lI(t,this.array)),this.array[e*this.itemSize+g]=t,this}getX(e){let g=this.array[e*this.itemSize];return this.normalized&&(g=sI(g,this.array)),g}setX(e,g){return this.normalized&&(g=lI(g,this.array)),this.array[e*this.itemSize]=g,this}getY(e){let g=this.array[e*this.itemSize+1];return this.normalized&&(g=sI(g,this.array)),g}setY(e,g){return this.normalized&&(g=lI(g,this.array)),this.array[e*this.itemSize+1]=g,this}getZ(e){let g=this.array[e*this.itemSize+2];return this.normalized&&(g=sI(g,this.array)),g}setZ(e,g){return this.normalized&&(g=lI(g,this.array)),this.array[e*this.itemSize+2]=g,this}getW(e){let g=this.array[e*this.itemSize+3];return this.normalized&&(g=sI(g,this.array)),g}setW(e,g){return this.normalized&&(g=lI(g,this.array)),this.array[e*this.itemSize+3]=g,this}setXY(e,g,t){return e*=this.itemSize,this.normalized&&(g=lI(g,this.array),t=lI(t,this.array)),this.array[e+0]=g,this.array[e+1]=t,this}setXYZ(e,g,t,I){return e*=this.itemSize,this.normalized&&(g=lI(g,this.array),t=lI(t,this.array),I=lI(I,this.array)),this.array[e+0]=g,this.array[e+1]=t,this.array[e+2]=I,this}setXYZW(e,g,t,I,n){return e*=this.itemSize,this.normalized&&(g=lI(g,this.array),t=lI(t,this.array),I=lI(I,this.array),n=lI(n,this.array)),this.array[e+0]=g,this.array[e+1]=t,this.array[e+2]=I,this.array[e+3]=n,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),this.usage!==xt&&(e.usage=this.usage),0===this.updateRange.offset&&-1===this.updateRange.count||(e.updateRange=this.updateRange),e}}class yi extends Zi{constructor(e,g,t){super(new Int8Array(e),g,t)}}class vi extends Zi{constructor(e,g,t){super(new Uint8Array(e),g,t)}}class Wi extends Zi{constructor(e,g,t){super(new Uint8ClampedArray(e),g,t)}}class fi extends Zi{constructor(e,g,t){super(new Int16Array(e),g,t)}}class wi extends Zi{constructor(e,g,t){super(new Uint16Array(e),g,t)}}class Ri extends Zi{constructor(e,g,t){super(new Int32Array(e),g,t)}}class Vi extends Zi{constructor(e,g,t){super(new Uint32Array(e),g,t)}}class Xi extends Zi{constructor(e,g,t){super(new Uint16Array(e),g,t),this.isFloat16BufferAttribute=!0}getX(e){let g=mi(this.array[e*this.itemSize]);return this.normalized&&(g=sI(g,this.array)),g}setX(e,g){return this.normalized&&(g=lI(g,this.array)),this.array[e*this.itemSize]=bi(g),this}getY(e){let g=mi(this.array[e*this.itemSize+1]);return this.normalized&&(g=sI(g,this.array)),g}setY(e,g){return this.normalized&&(g=lI(g,this.array)),this.array[e*this.itemSize+1]=bi(g),this}getZ(e){let g=mi(this.array[e*this.itemSize+2]);return this.normalized&&(g=sI(g,this.array)),g}setZ(e,g){return this.normalized&&(g=lI(g,this.array)),this.array[e*this.itemSize+2]=bi(g),this}getW(e){let g=mi(this.array[e*this.itemSize+3]);return this.normalized&&(g=sI(g,this.array)),g}setW(e,g){return this.normalized&&(g=lI(g,this.array)),this.array[e*this.itemSize+3]=bi(g),this}setXY(e,g,t){return e*=this.itemSize,this.normalized&&(g=lI(g,this.array),t=lI(t,this.array)),this.array[e+0]=bi(g),this.array[e+1]=bi(t),this}setXYZ(e,g,t,I){return e*=this.itemSize,this.normalized&&(g=lI(g,this.array),t=lI(t,this.array),I=lI(I,this.array)),this.array[e+0]=bi(g),this.array[e+1]=bi(t),this.array[e+2]=bi(I),this}setXYZW(e,g,t,I,n){return e*=this.itemSize,this.normalized&&(g=lI(g,this.array),t=lI(t,this.array),I=lI(I,this.array),n=lI(n,this.array)),this.array[e+0]=bi(g),this.array[e+1]=bi(t),this.array[e+2]=bi(I),this.array[e+3]=bi(n),this}}class Si extends Zi{constructor(e,g,t){super(new Float32Array(e),g,t)}}class Yi extends Zi{constructor(e,g,t){super(new Float64Array(e),g,t)}}let Ki=0;const Hi=new Zn,Ni=new Dn,Fi=new UI,xi=new OI,zi=new OI,ki=new UI;class Mi extends _t{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:Ki++}),this.uuid=tI(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(uI(e)?Vi:wi)(e,1):this.index=e,this}getAttribute(e){return this.attributes[e]}setAttribute(e,g){return this.attributes[e]=g,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,g,t=0){this.groups.push({start:e,count:g,materialIndex:t})}clearGroups(){this.groups=[]}setDrawRange(e,g){this.drawRange.start=e,this.drawRange.count=g}applyMatrix4(e){const g=this.attributes.position;void 0!==g&&(g.applyMatrix4(e),g.needsUpdate=!0);const t=this.attributes.normal;if(void 0!==t){const g=(new cI).getNormalMatrix(e);t.applyNormalMatrix(g),t.needsUpdate=!0}const I=this.attributes.tangent;return void 0!==I&&(I.transformDirection(e),I.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return Hi.makeRotationFromQuaternion(e),this.applyMatrix4(Hi),this}rotateX(e){return Hi.makeRotationX(e),this.applyMatrix4(Hi),this}rotateY(e){return Hi.makeRotationY(e),this.applyMatrix4(Hi),this}rotateZ(e){return Hi.makeRotationZ(e),this.applyMatrix4(Hi),this}translate(e,g,t){return Hi.makeTranslation(e,g,t),this.applyMatrix4(Hi),this}scale(e,g,t){return Hi.makeScale(e,g,t),this.applyMatrix4(Hi),this}lookAt(e){return Ni.lookAt(e),Ni.updateMatrix(),this.applyMatrix4(Ni.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Fi).negate(),this.translate(Fi.x,Fi.y,Fi.z),this}setFromPoints(e){const g=[];for(let t=0,I=e.length;t<I;t++){const I=e[t];g.push(I.x,I.y,I.z||0)}return this.setAttribute("position",new Si(g,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new OI);const e=this.attributes.position,g=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingBox.set(new UI(-1/0,-1/0,-1/0),new UI(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),g)for(let e=0,t=g.length;e<t;e++){const t=g[e];xi.setFromBufferAttribute(t),this.morphTargetsRelative?(ki.addVectors(this.boundingBox.min,xi.min),this.boundingBox.expandByPoint(ki),ki.addVectors(this.boundingBox.max,xi.max),this.boundingBox.expandByPoint(ki)):(this.boundingBox.expandByPoint(xi.min),this.boundingBox.expandByPoint(xi.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new cn);const e=this.attributes.position,g=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingSphere.set(new UI,1/0);if(e){const t=this.boundingSphere.center;if(xi.setFromBufferAttribute(e),g)for(let e=0,t=g.length;e<t;e++){const t=g[e];zi.setFromBufferAttribute(t),this.morphTargetsRelative?(ki.addVectors(xi.min,zi.min),xi.expandByPoint(ki),ki.addVectors(xi.max,zi.max),xi.expandByPoint(ki)):(xi.expandByPoint(zi.min),xi.expandByPoint(zi.max))}xi.getCenter(t);let I=0;for(let g=0,n=e.count;g<n;g++)ki.fromBufferAttribute(e,g),I=Math.max(I,t.distanceToSquared(ki));if(g)for(let n=0,i=g.length;n<i;n++){const i=g[n],C=this.morphTargetsRelative;for(let g=0,n=i.count;g<n;g++)ki.fromBufferAttribute(i,g),C&&(Fi.fromBufferAttribute(e,g),ki.add(Fi)),I=Math.max(I,t.distanceToSquared(ki))}this.boundingSphere.radius=Math.sqrt(I),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,g=this.attributes;if(null===e||void 0===g.position||void 0===g.normal||void 0===g.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const t=e.array,I=g.position.array,n=g.normal.array,i=g.uv.array,C=I.length/3;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new Zi(new Float32Array(4*C),4));const o=this.getAttribute("tangent").array,a=[],s=[];for(let e=0;e<C;e++)a[e]=new UI,s[e]=new UI;const l=new UI,r=new UI,A=new UI,c=new AI,d=new AI,u=new AI,h=new UI,b=new UI;function m(e,g,t){l.fromArray(I,3*e),r.fromArray(I,3*g),A.fromArray(I,3*t),c.fromArray(i,2*e),d.fromArray(i,2*g),u.fromArray(i,2*t),r.sub(l),A.sub(l),d.sub(c),u.sub(c);const n=1/(d.x*u.y-u.x*d.y);isFinite(n)&&(h.copy(r).multiplyScalar(u.y).addScaledVector(A,-d.y).multiplyScalar(n),b.copy(A).multiplyScalar(d.x).addScaledVector(r,-u.x).multiplyScalar(n),a[e].add(h),a[g].add(h),a[t].add(h),s[e].add(b),s[g].add(b),s[t].add(b))}let p=this.groups;0===p.length&&(p=[{start:0,count:t.length}]);for(let e=0,g=p.length;e<g;++e){const g=p[e],I=g.start;for(let e=I,n=I+g.count;e<n;e+=3)m(t[e+0],t[e+1],t[e+2])}const G=new UI,B=new UI,Z=new UI,y=new UI;function v(e){Z.fromArray(n,3*e),y.copy(Z);const g=a[e];G.copy(g),G.sub(Z.multiplyScalar(Z.dot(g))).normalize(),B.crossVectors(y,g);const t=B.dot(s[e])<0?-1:1;o[4*e]=G.x,o[4*e+1]=G.y,o[4*e+2]=G.z,o[4*e+3]=t}for(let e=0,g=p.length;e<g;++e){const g=p[e],I=g.start;for(let e=I,n=I+g.count;e<n;e+=3)v(t[e+0]),v(t[e+1]),v(t[e+2])}}computeVertexNormals(){const e=this.index,g=this.getAttribute("position");if(void 0!==g){let t=this.getAttribute("normal");if(void 0===t)t=new Zi(new Float32Array(3*g.count),3),this.setAttribute("normal",t);else for(let e=0,g=t.count;e<g;e++)t.setXYZ(e,0,0,0);const I=new UI,n=new UI,i=new UI,C=new UI,o=new UI,a=new UI,s=new UI,l=new UI;if(e)for(let r=0,A=e.count;r<A;r+=3){const A=e.getX(r+0),c=e.getX(r+1),d=e.getX(r+2);I.fromBufferAttribute(g,A),n.fromBufferAttribute(g,c),i.fromBufferAttribute(g,d),s.subVectors(i,n),l.subVectors(I,n),s.cross(l),C.fromBufferAttribute(t,A),o.fromBufferAttribute(t,c),a.fromBufferAttribute(t,d),C.add(s),o.add(s),a.add(s),t.setXYZ(A,C.x,C.y,C.z),t.setXYZ(c,o.x,o.y,o.z),t.setXYZ(d,a.x,a.y,a.z)}else for(let e=0,C=g.count;e<C;e+=3)I.fromBufferAttribute(g,e+0),n.fromBufferAttribute(g,e+1),i.fromBufferAttribute(g,e+2),s.subVectors(i,n),l.subVectors(I,n),s.cross(l),t.setXYZ(e+0,s.x,s.y,s.z),t.setXYZ(e+1,s.x,s.y,s.z),t.setXYZ(e+2,s.x,s.y,s.z);this.normalizeNormals(),t.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let g=0,t=e.count;g<t;g++)ki.fromBufferAttribute(e,g),ki.normalize(),e.setXYZ(g,ki.x,ki.y,ki.z)}toNonIndexed(){function e(e,g){const t=e.array,I=e.itemSize,n=e.normalized,i=new t.constructor(g.length*I);let C=0,o=0;for(let n=0,a=g.length;n<a;n++){C=e.isInterleavedBufferAttribute?g[n]*e.data.stride+e.offset:g[n]*I;for(let e=0;e<I;e++)i[o++]=t[C++]}return new Zi(i,I,n)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const g=new Mi,t=this.index.array,I=this.attributes;for(const n in I){const i=e(I[n],t);g.setAttribute(n,i)}const n=this.morphAttributes;for(const I in n){const i=[],C=n[I];for(let g=0,I=C.length;g<I;g++){const I=e(C[g],t);i.push(I)}g.morphAttributes[I]=i}g.morphTargetsRelative=this.morphTargetsRelative;const i=this.groups;for(let e=0,t=i.length;e<t;e++){const t=i[e];g.addGroup(t.start,t.count,t.materialIndex)}return g}toJSON(){const e={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const g=this.parameters;for(const t in g)void 0!==g[t]&&(e[t]=g[t]);return e}e.data={attributes:{}};const g=this.index;null!==g&&(e.data.index={type:g.array.constructor.name,array:Array.prototype.slice.call(g.array)});const t=this.attributes;for(const g in t){const I=t[g];e.data.attributes[g]=I.toJSON(e.data)}const I={};let n=!1;for(const g in this.morphAttributes){const t=this.morphAttributes[g],i=[];for(let g=0,I=t.length;g<I;g++){const I=t[g];i.push(I.toJSON(e.data))}i.length>0&&(I[g]=i,n=!0)}n&&(e.data.morphAttributes=I,e.data.morphTargetsRelative=this.morphTargetsRelative);const i=this.groups;i.length>0&&(e.data.groups=JSON.parse(JSON.stringify(i)));const C=this.boundingSphere;return null!==C&&(e.data.boundingSphere={center:C.center.toArray(),radius:C.radius}),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const g={};this.name=e.name;const t=e.index;null!==t&&this.setIndex(t.clone(g));const I=e.attributes;for(const e in I){const t=I[e];this.setAttribute(e,t.clone(g))}const n=e.morphAttributes;for(const e in n){const t=[],I=n[e];for(let e=0,n=I.length;e<n;e++)t.push(I[e].clone(g));this.morphAttributes[e]=t}this.morphTargetsRelative=e.morphTargetsRelative;const i=e.groups;for(let e=0,g=i.length;e<g;e++){const g=i[e];this.addGroup(g.start,g.count,g.materialIndex)}const C=e.boundingBox;null!==C&&(this.boundingBox=C.clone());const o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const Li=new Zn,Ji=new Bn,Ei=new cn,Ti=new UI,Ui=new UI,Qi=new UI,Di=new UI,Oi=new UI,ji=new UI,Pi=new AI,_i=new AI,qi=new AI,$i=new UI,eC=new UI,gC=new UI,tC=new UI,IC=new UI;class nC extends Dn{constructor(e=new Mi,g=new di){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=g,this.updateMorphTargets()}copy(e,g){return super.copy(e,g),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,g=Object.keys(e);if(g.length>0){const t=e[g[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,g=t.length;e<g;e++){const g=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[g]=e}}}}getVertexPosition(e,g){const t=this.geometry,I=t.attributes.position,n=t.morphAttributes.position,i=t.morphTargetsRelative;g.fromBufferAttribute(I,e);const C=this.morphTargetInfluences;if(n&&C){ji.set(0,0,0);for(let t=0,I=n.length;t<I;t++){const I=C[t],o=n[t];0!==I&&(Oi.fromBufferAttribute(o,e),i?ji.addScaledVector(Oi,I):ji.addScaledVector(Oi.sub(g),I))}g.add(ji)}return g}raycast(e,g){const t=this.geometry,I=this.material,n=this.matrixWorld;if(void 0!==I){if(null===t.boundingSphere&&t.computeBoundingSphere(),Ei.copy(t.boundingSphere),Ei.applyMatrix4(n),Ji.copy(e.ray).recast(e.near),!1===Ei.containsPoint(Ji.origin)){if(null===Ji.intersectSphere(Ei,Ti))return;if(Ji.origin.distanceToSquared(Ti)>(e.far-e.near)**2)return}Li.copy(n).invert(),Ji.copy(e.ray).applyMatrix4(Li),null!==t.boundingBox&&!1===Ji.intersectsBox(t.boundingBox)||this._computeIntersections(e,g,Ji)}}_computeIntersections(e,g,t){let I;const n=this.geometry,i=this.material,C=n.index,o=n.attributes.position,a=n.attributes.uv,s=n.attributes.uv1,l=n.attributes.normal,r=n.groups,A=n.drawRange;if(null!==C)if(Array.isArray(i))for(let n=0,o=r.length;n<o;n++){const o=r[n],c=i[o.materialIndex];for(let n=Math.max(o.start,A.start),i=Math.min(C.count,Math.min(o.start+o.count,A.start+A.count));n<i;n+=3)I=iC(this,c,e,t,a,s,l,C.getX(n),C.getX(n+1),C.getX(n+2)),I&&(I.faceIndex=Math.floor(n/3),I.face.materialIndex=o.materialIndex,g.push(I))}else for(let n=Math.max(0,A.start),o=Math.min(C.count,A.start+A.count);n<o;n+=3)I=iC(this,i,e,t,a,s,l,C.getX(n),C.getX(n+1),C.getX(n+2)),I&&(I.faceIndex=Math.floor(n/3),g.push(I));else if(void 0!==o)if(Array.isArray(i))for(let n=0,C=r.length;n<C;n++){const C=r[n],c=i[C.materialIndex];for(let n=Math.max(C.start,A.start),i=Math.min(o.count,Math.min(C.start+C.count,A.start+A.count));n<i;n+=3)I=iC(this,c,e,t,a,s,l,n,n+1,n+2),I&&(I.faceIndex=Math.floor(n/3),I.face.materialIndex=C.materialIndex,g.push(I))}else for(let n=Math.max(0,A.start),C=Math.min(o.count,A.start+A.count);n<C;n+=3)I=iC(this,i,e,t,a,s,l,n,n+1,n+2),I&&(I.faceIndex=Math.floor(n/3),g.push(I))}}function iC(e,g,t,I,n,i,C,o,a,s){e.getVertexPosition(o,Ui),e.getVertexPosition(a,Qi),e.getVertexPosition(s,Di);const l=function(e,g,t,I,n,i,C,o){let a;if(a=g.side===S?I.intersectTriangle(C,i,n,!0,o):I.intersectTriangle(n,i,C,g.side===X,o),null===a)return null;IC.copy(o),IC.applyMatrix4(e.matrixWorld);const s=t.ray.origin.distanceTo(IC);return s<t.near||s>t.far?null:{distance:s,point:IC.clone(),object:e}}(e,g,t,I,Ui,Qi,Di,tC);if(l){n&&(Pi.fromBufferAttribute(n,o),_i.fromBufferAttribute(n,a),qi.fromBufferAttribute(n,s),l.uv=ii.getInterpolation(tC,Ui,Qi,Di,Pi,_i,qi,new AI)),i&&(Pi.fromBufferAttribute(i,o),_i.fromBufferAttribute(i,a),qi.fromBufferAttribute(i,s),l.uv1=ii.getInterpolation(tC,Ui,Qi,Di,Pi,_i,qi,new AI),l.uv2=l.uv1),C&&($i.fromBufferAttribute(C,o),eC.fromBufferAttribute(C,a),gC.fromBufferAttribute(C,s),l.normal=ii.getInterpolation(tC,Ui,Qi,Di,$i,eC,gC,new UI),l.normal.dot(I.direction)>0&&l.normal.multiplyScalar(-1));const e={a:o,b:a,c:s,normal:new UI,materialIndex:0};ii.getNormal(Ui,Qi,Di,e.normal),l.face=e}return l}class CC extends Mi{constructor(e=1,g=1,t=1,I=1,n=1,i=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:g,depth:t,widthSegments:I,heightSegments:n,depthSegments:i};const C=this;I=Math.floor(I),n=Math.floor(n),i=Math.floor(i);const o=[],a=[],s=[],l=[];let r=0,A=0;function c(e,g,t,I,n,i,c,d,u,h,b){const m=i/u,p=c/h,G=i/2,B=c/2,Z=d/2,y=u+1,v=h+1;let W=0,f=0;const w=new UI;for(let i=0;i<v;i++){const C=i*p-B;for(let o=0;o<y;o++){const r=o*m-G;w[e]=r*I,w[g]=C*n,w[t]=Z,a.push(w.x,w.y,w.z),w[e]=0,w[g]=0,w[t]=d>0?1:-1,s.push(w.x,w.y,w.z),l.push(o/u),l.push(1-i/h),W+=1}}for(let e=0;e<h;e++)for(let g=0;g<u;g++){const t=r+g+y*e,I=r+g+y*(e+1),n=r+(g+1)+y*(e+1),i=r+(g+1)+y*e;o.push(t,I,i),o.push(I,n,i),f+=6}C.addGroup(A,f,b),A+=f,r+=W}c("z","y","x",-1,-1,t,g,e,i,n,0),c("z","y","x",1,-1,t,g,-e,i,n,1),c("x","z","y",1,1,e,t,g,I,i,2),c("x","z","y",1,-1,e,t,-g,I,i,3),c("x","y","z",1,-1,e,g,t,I,n,4),c("x","y","z",-1,-1,e,g,-t,I,n,5),this.setIndex(o),this.setAttribute("position",new Si(a,3)),this.setAttribute("normal",new Si(s,3)),this.setAttribute("uv",new Si(l,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new CC(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function oC(e){const g={};for(const t in e){g[t]={};for(const I in e[t]){const n=e[t][I];n&&(n.isColor||n.isMatrix3||n.isMatrix4||n.isVector2||n.isVector3||n.isVector4||n.isTexture||n.isQuaternion)?n.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),g[t][I]=null):g[t][I]=n.clone():Array.isArray(n)?g[t][I]=n.slice():g[t][I]=n}}return g}function aC(e){const g={};for(let t=0;t<e.length;t++){const I=oC(e[t]);for(const e in I)g[e]=I[e]}return g}function sC(e){return null===e.getRenderTarget()?e.outputColorSpace:fI.workingColorSpace}const lC={clone:oC,merge:aC};class rC extends oi{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=oC(e.uniforms),this.uniformsGroups=function(e){const g=[];for(let t=0;t<e.length;t++)g.push(e[t].clone());return g}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const g=super.toJSON(e);g.glslVersion=this.glslVersion,g.uniforms={};for(const t in this.uniforms){const I=this.uniforms[t].value;I&&I.isTexture?g.uniforms[t]={type:"t",value:I.toJSON(e).uuid}:I&&I.isColor?g.uniforms[t]={type:"c",value:I.getHex()}:I&&I.isVector2?g.uniforms[t]={type:"v2",value:I.toArray()}:I&&I.isVector3?g.uniforms[t]={type:"v3",value:I.toArray()}:I&&I.isVector4?g.uniforms[t]={type:"v4",value:I.toArray()}:I&&I.isMatrix3?g.uniforms[t]={type:"m3",value:I.toArray()}:I&&I.isMatrix4?g.uniforms[t]={type:"m4",value:I.toArray()}:g.uniforms[t]={value:I}}Object.keys(this.defines).length>0&&(g.defines=this.defines),g.vertexShader=this.vertexShader,g.fragmentShader=this.fragmentShader,g.lights=this.lights,g.clipping=this.clipping;const t={};for(const e in this.extensions)!0===this.extensions[e]&&(t[e]=!0);return Object.keys(t).length>0&&(g.extensions=t),g}}class AC extends Dn{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Zn,this.projectionMatrix=new Zn,this.projectionMatrixInverse=new Zn,this.coordinateSystem=jt}copy(e,g){return super.copy(e,g),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,g){super.updateWorldMatrix(e,g),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}class cC extends AC{constructor(e=50,g=1,t=.1,I=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=t,this.far=I,this.focus=10,this.aspect=g,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,g){return super.copy(e,g),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const g=.5*this.getFilmHeight()/e;this.fov=2*gI*Math.atan(g),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*eI*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*gI*Math.atan(Math.tan(.5*eI*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(e,g,t,I,n,i){this.aspect=e/g,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=g,this.view.offsetX=t,this.view.offsetY=I,this.view.width=n,this.view.height=i,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let g=e*Math.tan(.5*eI*this.fov)/this.zoom,t=2*g,I=this.aspect*t,n=-.5*I;const i=this.view;if(null!==this.view&&this.view.enabled){const e=i.fullWidth,C=i.fullHeight;n+=i.offsetX*I/e,g-=i.offsetY*t/C,I*=i.width/e,t*=i.height/C}const C=this.filmOffset;0!==C&&(n+=e*C/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+I,g,g-t,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const g=super.toJSON(e);return g.object.fov=this.fov,g.object.zoom=this.zoom,g.object.near=this.near,g.object.far=this.far,g.object.focus=this.focus,g.object.aspect=this.aspect,null!==this.view&&(g.object.view=Object.assign({},this.view)),g.object.filmGauge=this.filmGauge,g.object.filmOffset=this.filmOffset,g}}const dC=-90;class uC extends Dn{constructor(e,g,t){super(),this.type="CubeCamera",this.renderTarget=t,this.coordinateSystem=null,this.activeMipmapLevel=0;const I=new cC(dC,1,e,g);I.layers=this.layers,this.add(I);const n=new cC(dC,1,e,g);n.layers=this.layers,this.add(n);const i=new cC(dC,1,e,g);i.layers=this.layers,this.add(i);const C=new cC(dC,1,e,g);C.layers=this.layers,this.add(C);const o=new cC(dC,1,e,g);o.layers=this.layers,this.add(o);const a=new cC(dC,1,e,g);a.layers=this.layers,this.add(a)}updateCoordinateSystem(){const e=this.coordinateSystem,g=this.children.concat(),[t,I,n,i,C,o]=g;for(const e of g)this.remove(e);if(e===jt)t.up.set(0,1,0),t.lookAt(1,0,0),I.up.set(0,1,0),I.lookAt(-1,0,0),n.up.set(0,0,-1),n.lookAt(0,1,0),i.up.set(0,0,1),i.lookAt(0,-1,0),C.up.set(0,1,0),C.lookAt(0,0,1),o.up.set(0,1,0),o.lookAt(0,0,-1);else{if(e!==Pt)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);t.up.set(0,-1,0),t.lookAt(-1,0,0),I.up.set(0,-1,0),I.lookAt(1,0,0),n.up.set(0,0,1),n.lookAt(0,1,0),i.up.set(0,0,-1),i.lookAt(0,-1,0),C.up.set(0,-1,0),C.lookAt(0,0,1),o.up.set(0,-1,0),o.lookAt(0,0,-1)}for(const e of g)this.add(e),e.updateMatrixWorld()}update(e,g){null===this.parent&&this.updateMatrixWorld();const{renderTarget:t,activeMipmapLevel:I}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[n,i,C,o,a,s]=this.children,l=e.getRenderTarget(),r=e.getActiveCubeFace(),A=e.getActiveMipmapLevel(),c=e.xr.enabled;e.xr.enabled=!1;const d=t.texture.generateMipmaps;t.texture.generateMipmaps=!1,e.setRenderTarget(t,0,I),e.render(g,n),e.setRenderTarget(t,1,I),e.render(g,i),e.setRenderTarget(t,2,I),e.render(g,C),e.setRenderTarget(t,3,I),e.render(g,o),e.setRenderTarget(t,4,I),e.render(g,a),t.texture.generateMipmaps=d,e.setRenderTarget(t,5,I),e.render(g,s),e.setRenderTarget(l,r,A),e.xr.enabled=c,t.texture.needsPMREMUpdate=!0}}class hC extends NI{constructor(e,g,t,I,n,i,C,o,a,s){super(e=void 0!==e?e:[],g=void 0!==g?g:Ge,t,I,n,i,C,o,a,s),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class bC extends zI{constructor(e=1,g={}){super(e,e,g),this.isWebGLCubeRenderTarget=!0;const t={width:e,height:e,depth:1},I=[t,t,t,t,t,t];void 0!==g.encoding&&(BI("THREE.WebGLCubeRenderTarget: option.encoding has been replaced by option.colorSpace."),g.colorSpace=g.encoding===$g?it:nt),this.texture=new hC(I,g.mapping,g.wrapS,g.wrapT,g.magFilter,g.minFilter,g.format,g.type,g.anisotropy,g.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==g.generateMipmaps&&g.generateMipmaps,this.texture.minFilter=void 0!==g.minFilter?g.minFilter:Ke}fromEquirectangularTexture(e,g){this.texture.type=g.type,this.texture.colorSpace=g.colorSpace,this.texture.generateMipmaps=g.generateMipmaps,this.texture.minFilter=g.minFilter,this.texture.magFilter=g.magFilter;const t={tEquirect:{value:null}},I="\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",n="\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t",i=new CC(5,5,5),C=new rC({name:"CubemapFromEquirect",uniforms:oC(t),vertexShader:I,fragmentShader:n,side:S,blending:H});C.uniforms.tEquirect.value=g;const o=new nC(i,C),a=g.minFilter;return g.minFilter===Fe&&(g.minFilter=Ke),new uC(1,10,this).update(e,o),g.minFilter=a,o.geometry.dispose(),o.material.dispose(),this}clear(e,g,t,I){const n=e.getRenderTarget();for(let n=0;n<6;n++)e.setRenderTarget(this,n),e.clear(g,t,I);e.setRenderTarget(n)}}const mC=new UI,pC=new UI,GC=new cI;class BC{constructor(e=new UI(1,0,0),g=0){this.isPlane=!0,this.normal=e,this.constant=g}set(e,g){return this.normal.copy(e),this.constant=g,this}setComponents(e,g,t,I){return this.normal.set(e,g,t),this.constant=I,this}setFromNormalAndCoplanarPoint(e,g){return this.normal.copy(e),this.constant=-g.dot(this.normal),this}setFromCoplanarPoints(e,g,t){const I=mC.subVectors(t,g).cross(pC.subVectors(e,g)).normalize();return this.setFromNormalAndCoplanarPoint(I,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,g){return g.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,g){const t=e.delta(mC),I=this.normal.dot(t);if(0===I)return 0===this.distanceToPoint(e.start)?g.copy(e.start):null;const n=-(e.start.dot(this.normal)+this.constant)/I;return n<0||n>1?null:g.copy(e.start).addScaledVector(t,n)}intersectsLine(e){const g=this.distanceToPoint(e.start),t=this.distanceToPoint(e.end);return g<0&&t>0||t<0&&g>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,g){const t=g||GC.getNormalMatrix(e),I=this.coplanarPoint(mC).applyMatrix4(e),n=this.normal.applyMatrix3(t).normalize();return this.constant=-I.dot(n),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const ZC=new cn,yC=new UI;class vC{constructor(e=new BC,g=new BC,t=new BC,I=new BC,n=new BC,i=new BC){this.planes=[e,g,t,I,n,i]}set(e,g,t,I,n,i){const C=this.planes;return C[0].copy(e),C[1].copy(g),C[2].copy(t),C[3].copy(I),C[4].copy(n),C[5].copy(i),this}copy(e){const g=this.planes;for(let t=0;t<6;t++)g[t].copy(e.planes[t]);return this}setFromProjectionMatrix(e,g=jt){const t=this.planes,I=e.elements,n=I[0],i=I[1],C=I[2],o=I[3],a=I[4],s=I[5],l=I[6],r=I[7],A=I[8],c=I[9],d=I[10],u=I[11],h=I[12],b=I[13],m=I[14],p=I[15];if(t[0].setComponents(o-n,r-a,u-A,p-h).normalize(),t[1].setComponents(o+n,r+a,u+A,p+h).normalize(),t[2].setComponents(o+i,r+s,u+c,p+b).normalize(),t[3].setComponents(o-i,r-s,u-c,p-b).normalize(),t[4].setComponents(o-C,r-l,u-d,p-m).normalize(),g===jt)t[5].setComponents(o+C,r+l,u+d,p+m).normalize();else{if(g!==Pt)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+g);t[5].setComponents(C,l,d,m).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),ZC.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const g=e.geometry;null===g.boundingSphere&&g.computeBoundingSphere(),ZC.copy(g.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(ZC)}intersectsSprite(e){return ZC.center.set(0,0,0),ZC.radius=.7071067811865476,ZC.applyMatrix4(e.matrixWorld),this.intersectsSphere(ZC)}intersectsSphere(e){const g=this.planes,t=e.center,I=-e.radius;for(let e=0;e<6;e++)if(g[e].distanceToPoint(t)<I)return!1;return!0}intersectsBox(e){const g=this.planes;for(let t=0;t<6;t++){const I=g[t];if(yC.x=I.normal.x>0?e.max.x:e.min.x,yC.y=I.normal.y>0?e.max.y:e.min.y,yC.z=I.normal.z>0?e.max.z:e.min.z,I.distanceToPoint(yC)<0)return!1}return!0}containsPoint(e){const g=this.planes;for(let t=0;t<6;t++)if(g[t].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function WC(){let e=null,g=!1,t=null,I=null;function n(g,i){t(g,i),I=e.requestAnimationFrame(n)}return{start:function(){!0!==g&&null!==t&&(I=e.requestAnimationFrame(n),g=!0)},stop:function(){e.cancelAnimationFrame(I),g=!1},setAnimationLoop:function(e){t=e},setContext:function(g){e=g}}}function fC(e,g){const t=g.isWebGL2,I=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),I.get(e)},remove:function(g){g.isInterleavedBufferAttribute&&(g=g.data);const t=I.get(g);t&&(e.deleteBuffer(t.buffer),I.delete(g))},update:function(g,n){if(g.isGLBufferAttribute){const e=I.get(g);return void((!e||e.version<g.version)&&I.set(g,{buffer:g.buffer,type:g.type,bytesPerElement:g.elementSize,version:g.version}))}g.isInterleavedBufferAttribute&&(g=g.data);const i=I.get(g);void 0===i?I.set(g,function(g,I){const n=g.array,i=g.usage,C=e.createBuffer();let o;if(e.bindBuffer(I,C),e.bufferData(I,n,i),g.onUploadCallback(),n instanceof Float32Array)o=e.FLOAT;else if(n instanceof Uint16Array)if(g.isFloat16BufferAttribute){if(!t)throw new Error("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2.");o=e.HALF_FLOAT}else o=e.UNSIGNED_SHORT;else if(n instanceof Int16Array)o=e.SHORT;else if(n instanceof Uint32Array)o=e.UNSIGNED_INT;else if(n instanceof Int32Array)o=e.INT;else if(n instanceof Int8Array)o=e.BYTE;else if(n instanceof Uint8Array)o=e.UNSIGNED_BYTE;else{if(!(n instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+n);o=e.UNSIGNED_BYTE}return{buffer:C,type:o,bytesPerElement:n.BYTES_PER_ELEMENT,version:g.version}}(g,n)):i.version<g.version&&(function(g,I,n){const i=I.array,C=I.updateRange;e.bindBuffer(n,g),-1===C.count?e.bufferSubData(n,0,i):(t?e.bufferSubData(n,C.offset*i.BYTES_PER_ELEMENT,i,C.offset,C.count):e.bufferSubData(n,C.offset*i.BYTES_PER_ELEMENT,i.subarray(C.offset,C.offset+C.count)),C.count=-1),I.onUploadCallback()}(i.buffer,g,n),i.version=g.version)}}}class wC extends Mi{constructor(e=1,g=1,t=1,I=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:g,widthSegments:t,heightSegments:I};const n=e/2,i=g/2,C=Math.floor(t),o=Math.floor(I),a=C+1,s=o+1,l=e/C,r=g/o,A=[],c=[],d=[],u=[];for(let e=0;e<s;e++){const g=e*r-i;for(let t=0;t<a;t++){const I=t*l-n;c.push(I,-g,0),d.push(0,0,1),u.push(t/C),u.push(1-e/o)}}for(let e=0;e<o;e++)for(let g=0;g<C;g++){const t=g+a*e,I=g+a*(e+1),n=g+1+a*(e+1),i=g+1+a*e;A.push(t,I,i),A.push(I,n,i)}this.setIndex(A),this.setAttribute("position",new Si(c,3)),this.setAttribute("normal",new Si(d,3)),this.setAttribute("uv",new Si(u,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new wC(e.width,e.height,e.widthSegments,e.heightSegments)}}const RC={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\tif ( diffuseColor.a < alphaTest ) discard;\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = dFdx( surf_pos.xyz );\n\t\tvec3 vSigmaY = dFdy( surf_pos.xyz );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#pragma unroll_loop_end\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat luminance( const in vec3 rgb ) {\n\tconst vec3 weights = vec3( 0.2126729, 0.7151522, 0.0721750 );\n\treturn dot( weights, rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_v0 0.339\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_v1 0.276\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_v4 0.046\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_v5 0.016\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_v6 0.0038\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_INSTANCING\n\tmat3 m = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n\ttransformedNormal = m * transformedNormal;\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"\nconst mat3 LINEAR_SRGB_TO_LINEAR_DISPLAY_P3 = mat3(\n\tvec3( 0.8224621, 0.177538, 0.0 ),\n\tvec3( 0.0331941, 0.9668058, 0.0 ),\n\tvec3( 0.0170827, 0.0723974, 0.9105199 )\n);\nconst mat3 LINEAR_DISPLAY_P3_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.2249401, - 0.2249404, 0.0 ),\n\tvec3( - 0.0420569, 1.0420571, 0.0 ),\n\tvec3( - 0.0196376, - 0.0786361, 1.0982735 )\n);\nvec4 LinearSRGBToLinearDisplayP3( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_SRGB_TO_LINEAR_DISPLAY_P3, value.a );\n}\nvec4 LinearDisplayP3ToLinearSRGB( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_DISPLAY_P3_TO_LINEAR_SRGB, value.a );\n}\nvec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn sRGBTransferOETF( value );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\treflectedLight.indirectDiffuse += lightMapIrradiance;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\t#if defined ( LEGACY_LIGHTS )\n\t\tif ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\t\treturn pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t\t}\n\t\treturn 1.0;\n\t#else\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tif ( cutoffDistance > 0.0 ) {\n\t\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\t}\n\t\treturn distanceFalloff;\n\t#endif\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tanisotropyV /= material.anisotropy;\n\tmaterial.anisotropy = saturate( material.anisotropy );\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x - tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x + tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecular = vec3( 0.0 );\nvec3 sheenSpecular = vec3( 0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecular += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecular += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecular += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecular += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal;\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );\n\t\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS ) && defined( MORPHTARGETS_TEXTURE )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\t\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\t\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\t\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n\t#endif\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t\tuniform sampler2DArray morphTargetsTexture;\n\t\tuniform ivec2 morphTargetsTextureSize;\n\t\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t\t}\n\t#else\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\tuniform float morphTargetInfluences[ 8 ];\n\t\t#else\n\t\t\tuniform float morphTargetInfluences[ 4 ];\n\t\t#endif\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\t\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\t\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\t\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t\t#endif\n\t#endif\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec2 packDepthToRG( in highp float v ) {\n\treturn packDepthToRGBA( v ).yx;\n}\nfloat unpackRGToDepth( const in highp vec2 v ) {\n\treturn unpackRGBAToDepth( vec4( v.xy, 0.0, 0.0 ) );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tuniform int boneTextureSize;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tfloat j = i * 4.0;\n\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\ty = dy * ( y + 0.5 );\n\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\treturn bone;\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\trefractionCoords += 1.0;\n\t\trefractionCoords /= 2.0;\n\t\tvec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\tvec3 transmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecular;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},VC={common:{diffuse:{value:new Ai(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new cI},alphaMap:{value:null},alphaMapTransform:{value:new cI},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new cI}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new cI}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new cI}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new cI},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new cI},normalScale:{value:new AI(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new cI},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new cI}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new cI}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new cI}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Ai(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Ai(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new cI},alphaTest:{value:0},uvTransform:{value:new cI}},sprite:{diffuse:{value:new Ai(16777215)},opacity:{value:1},center:{value:new AI(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new cI},alphaMap:{value:null},alphaMapTransform:{value:new cI},alphaTest:{value:0}}},XC={basic:{uniforms:aC([VC.common,VC.specularmap,VC.envmap,VC.aomap,VC.lightmap,VC.fog]),vertexShader:RC.meshbasic_vert,fragmentShader:RC.meshbasic_frag},lambert:{uniforms:aC([VC.common,VC.specularmap,VC.envmap,VC.aomap,VC.lightmap,VC.emissivemap,VC.bumpmap,VC.normalmap,VC.displacementmap,VC.fog,VC.lights,{emissive:{value:new Ai(0)}}]),vertexShader:RC.meshlambert_vert,fragmentShader:RC.meshlambert_frag},phong:{uniforms:aC([VC.common,VC.specularmap,VC.envmap,VC.aomap,VC.lightmap,VC.emissivemap,VC.bumpmap,VC.normalmap,VC.displacementmap,VC.fog,VC.lights,{emissive:{value:new Ai(0)},specular:{value:new Ai(1118481)},shininess:{value:30}}]),vertexShader:RC.meshphong_vert,fragmentShader:RC.meshphong_frag},standard:{uniforms:aC([VC.common,VC.envmap,VC.aomap,VC.lightmap,VC.emissivemap,VC.bumpmap,VC.normalmap,VC.displacementmap,VC.roughnessmap,VC.metalnessmap,VC.fog,VC.lights,{emissive:{value:new Ai(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:RC.meshphysical_vert,fragmentShader:RC.meshphysical_frag},toon:{uniforms:aC([VC.common,VC.aomap,VC.lightmap,VC.emissivemap,VC.bumpmap,VC.normalmap,VC.displacementmap,VC.gradientmap,VC.fog,VC.lights,{emissive:{value:new Ai(0)}}]),vertexShader:RC.meshtoon_vert,fragmentShader:RC.meshtoon_frag},matcap:{uniforms:aC([VC.common,VC.bumpmap,VC.normalmap,VC.displacementmap,VC.fog,{matcap:{value:null}}]),vertexShader:RC.meshmatcap_vert,fragmentShader:RC.meshmatcap_frag},points:{uniforms:aC([VC.points,VC.fog]),vertexShader:RC.points_vert,fragmentShader:RC.points_frag},dashed:{uniforms:aC([VC.common,VC.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:RC.linedashed_vert,fragmentShader:RC.linedashed_frag},depth:{uniforms:aC([VC.common,VC.displacementmap]),vertexShader:RC.depth_vert,fragmentShader:RC.depth_frag},normal:{uniforms:aC([VC.common,VC.bumpmap,VC.normalmap,VC.displacementmap,{opacity:{value:1}}]),vertexShader:RC.meshnormal_vert,fragmentShader:RC.meshnormal_frag},sprite:{uniforms:aC([VC.sprite,VC.fog]),vertexShader:RC.sprite_vert,fragmentShader:RC.sprite_frag},background:{uniforms:{uvTransform:{value:new cI},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:RC.background_vert,fragmentShader:RC.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1}},vertexShader:RC.backgroundCube_vert,fragmentShader:RC.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:RC.cube_vert,fragmentShader:RC.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:RC.equirect_vert,fragmentShader:RC.equirect_frag},distanceRGBA:{uniforms:aC([VC.common,VC.displacementmap,{referencePosition:{value:new UI},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:RC.distanceRGBA_vert,fragmentShader:RC.distanceRGBA_frag},shadow:{uniforms:aC([VC.lights,VC.fog,{color:{value:new Ai(0)},opacity:{value:1}}]),vertexShader:RC.shadow_vert,fragmentShader:RC.shadow_frag}};XC.physical={uniforms:aC([XC.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new cI},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new cI},clearcoatNormalScale:{value:new AI(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new cI},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new cI},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new cI},sheen:{value:0},sheenColor:{value:new Ai(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new cI},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new cI},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new cI},transmissionSamplerSize:{value:new AI},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new cI},attenuationDistance:{value:0},attenuationColor:{value:new Ai(0)},specularColor:{value:new Ai(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new cI},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new cI},anisotropyVector:{value:new AI},anisotropyMap:{value:null},anisotropyMapTransform:{value:new cI}}]),vertexShader:RC.meshphysical_vert,fragmentShader:RC.meshphysical_frag};const SC={r:0,b:0,g:0};function YC(e,g,t,I,n,i,C){const o=new Ai(0);let a,s,l=!0===i?0:1,r=null,A=0,c=null;function d(g,t){g.getRGB(SC,sC(e)),I.buffers.color.setClear(SC.r,SC.g,SC.b,t,C)}return{getClearColor:function(){return o},setClearColor:function(e,g=1){o.set(e),l=g,d(o,l)},getClearAlpha:function(){return l},setClearAlpha:function(e){l=e,d(o,l)},render:function(i,u){let h=!1,b=!0===u.isScene?u.background:null;b&&b.isTexture&&(b=(u.backgroundBlurriness>0?t:g).get(b)),null===b?d(o,l):b&&b.isColor&&(d(b,1),h=!0);const m=e.xr.getEnvironmentBlendMode();"additive"===m?I.buffers.color.setClear(0,0,0,1,C):"alpha-blend"===m&&I.buffers.color.setClear(0,0,0,0,C),(e.autoClear||h)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),b&&(b.isCubeTexture||b.mapping===ve)?(void 0===s&&(s=new nC(new CC(1,1,1),new rC({name:"BackgroundCubeMaterial",uniforms:oC(XC.backgroundCube.uniforms),vertexShader:XC.backgroundCube.vertexShader,fragmentShader:XC.backgroundCube.fragmentShader,side:S,depthTest:!1,depthWrite:!1,fog:!1})),s.geometry.deleteAttribute("normal"),s.geometry.deleteAttribute("uv"),s.onBeforeRender=function(e,g,t){this.matrixWorld.copyPosition(t.matrixWorld)},Object.defineProperty(s.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(s)),s.material.uniforms.envMap.value=b,s.material.uniforms.flipEnvMap.value=b.isCubeTexture&&!1===b.isRenderTargetTexture?-1:1,s.material.uniforms.backgroundBlurriness.value=u.backgroundBlurriness,s.material.uniforms.backgroundIntensity.value=u.backgroundIntensity,s.material.toneMapped=fI.getTransfer(b.colorSpace)!==lt,r===b&&A===b.version&&c===e.toneMapping||(s.material.needsUpdate=!0,r=b,A=b.version,c=e.toneMapping),s.layers.enableAll(),i.unshift(s,s.geometry,s.material,0,0,null)):b&&b.isTexture&&(void 0===a&&(a=new nC(new wC(2,2),new rC({name:"BackgroundMaterial",uniforms:oC(XC.background.uniforms),vertexShader:XC.background.vertexShader,fragmentShader:XC.background.fragmentShader,side:X,depthTest:!1,depthWrite:!1,fog:!1})),a.geometry.deleteAttribute("normal"),Object.defineProperty(a.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(a)),a.material.uniforms.t2D.value=b,a.material.uniforms.backgroundIntensity.value=u.backgroundIntensity,a.material.toneMapped=fI.getTransfer(b.colorSpace)!==lt,!0===b.matrixAutoUpdate&&b.updateMatrix(),a.material.uniforms.uvTransform.value.copy(b.matrix),r===b&&A===b.version&&c===e.toneMapping||(a.material.needsUpdate=!0,r=b,A=b.version,c=e.toneMapping),a.layers.enableAll(),i.unshift(a,a.geometry,a.material,0,0,null))}}}function KC(e,g,t,I){const n=e.getParameter(e.MAX_VERTEX_ATTRIBS),i=I.isWebGL2?null:g.get("OES_vertex_array_object"),C=I.isWebGL2||null!==i,o={},a=c(null);let s=a,l=!1;function r(g){return I.isWebGL2?e.bindVertexArray(g):i.bindVertexArrayOES(g)}function A(g){return I.isWebGL2?e.deleteVertexArray(g):i.deleteVertexArrayOES(g)}function c(e){const g=[],t=[],I=[];for(let e=0;e<n;e++)g[e]=0,t[e]=0,I[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:g,enabledAttributes:t,attributeDivisors:I,object:e,attributes:{},index:null}}function d(){const e=s.newAttributes;for(let g=0,t=e.length;g<t;g++)e[g]=0}function u(e){h(e,0)}function h(t,n){const i=s.newAttributes,C=s.enabledAttributes,o=s.attributeDivisors;i[t]=1,0===C[t]&&(e.enableVertexAttribArray(t),C[t]=1),o[t]!==n&&((I.isWebGL2?e:g.get("ANGLE_instanced_arrays"))[I.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](t,n),o[t]=n)}function b(){const g=s.newAttributes,t=s.enabledAttributes;for(let I=0,n=t.length;I<n;I++)t[I]!==g[I]&&(e.disableVertexAttribArray(I),t[I]=0)}function m(g,t,I,n,i,C,o){!0===o?e.vertexAttribIPointer(g,t,I,i,C):e.vertexAttribPointer(g,t,I,n,i,C)}function p(){G(),l=!0,s!==a&&(s=a,r(s.object))}function G(){a.geometry=null,a.program=null,a.wireframe=!1}return{setup:function(n,a,A,p,G){let B=!1;if(C){const g=function(g,t,n){const C=!0===n.wireframe;let a=o[g.id];void 0===a&&(a={},o[g.id]=a);let s=a[t.id];void 0===s&&(s={},a[t.id]=s);let l=s[C];return void 0===l&&(l=c(I.isWebGL2?e.createVertexArray():i.createVertexArrayOES()),s[C]=l),l}(p,A,a);s!==g&&(s=g,r(s.object)),B=function(e,g,t,I){const n=s.attributes,i=g.attributes;let C=0;const o=t.getAttributes();for(const g in o)if(o[g].location>=0){const t=n[g];let I=i[g];if(void 0===I&&("instanceMatrix"===g&&e.instanceMatrix&&(I=e.instanceMatrix),"instanceColor"===g&&e.instanceColor&&(I=e.instanceColor)),void 0===t)return!0;if(t.attribute!==I)return!0;if(I&&t.data!==I.data)return!0;C++}return s.attributesNum!==C||s.index!==I}(n,p,A,G),B&&function(e,g,t,I){const n={},i=g.attributes;let C=0;const o=t.getAttributes();for(const g in o)if(o[g].location>=0){let t=i[g];void 0===t&&("instanceMatrix"===g&&e.instanceMatrix&&(t=e.instanceMatrix),"instanceColor"===g&&e.instanceColor&&(t=e.instanceColor));const I={};I.attribute=t,t&&t.data&&(I.data=t.data),n[g]=I,C++}s.attributes=n,s.attributesNum=C,s.index=I}(n,p,A,G)}else{const e=!0===a.wireframe;s.geometry===p.id&&s.program===A.id&&s.wireframe===e||(s.geometry=p.id,s.program=A.id,s.wireframe=e,B=!0)}null!==G&&t.update(G,e.ELEMENT_ARRAY_BUFFER),(B||l)&&(l=!1,function(n,i,C,o){if(!1===I.isWebGL2&&(n.isInstancedMesh||o.isInstancedBufferGeometry)&&null===g.get("ANGLE_instanced_arrays"))return;d();const a=o.attributes,s=C.getAttributes(),l=i.defaultAttributeValues;for(const g in s){const i=s[g];if(i.location>=0){let C=a[g];if(void 0===C&&("instanceMatrix"===g&&n.instanceMatrix&&(C=n.instanceMatrix),"instanceColor"===g&&n.instanceColor&&(C=n.instanceColor)),void 0!==C){const g=C.normalized,a=C.itemSize,s=t.get(C);if(void 0===s)continue;const l=s.buffer,r=s.type,A=s.bytesPerElement,c=!0===I.isWebGL2&&(r===e.INT||r===e.UNSIGNED_INT||C.gpuType===Je);if(C.isInterleavedBufferAttribute){const t=C.data,I=t.stride,s=C.offset;if(t.isInstancedInterleavedBuffer){for(let e=0;e<i.locationSize;e++)h(i.location+e,t.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=t.meshPerAttribute*t.count)}else for(let e=0;e<i.locationSize;e++)u(i.location+e);e.bindBuffer(e.ARRAY_BUFFER,l);for(let e=0;e<i.locationSize;e++)m(i.location+e,a/i.locationSize,r,g,I*A,(s+a/i.locationSize*e)*A,c)}else{if(C.isInstancedBufferAttribute){for(let e=0;e<i.locationSize;e++)h(i.location+e,C.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=C.meshPerAttribute*C.count)}else for(let e=0;e<i.locationSize;e++)u(i.location+e);e.bindBuffer(e.ARRAY_BUFFER,l);for(let e=0;e<i.locationSize;e++)m(i.location+e,a/i.locationSize,r,g,a*A,a/i.locationSize*e*A,c)}}else if(void 0!==l){const t=l[g];if(void 0!==t)switch(t.length){case 2:e.vertexAttrib2fv(i.location,t);break;case 3:e.vertexAttrib3fv(i.location,t);break;case 4:e.vertexAttrib4fv(i.location,t);break;default:e.vertexAttrib1fv(i.location,t)}}}}b()}(n,a,A,p),null!==G&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.get(G).buffer))},reset:p,resetDefaultState:G,dispose:function(){p();for(const e in o){const g=o[e];for(const e in g){const t=g[e];for(const e in t)A(t[e].object),delete t[e];delete g[e]}delete o[e]}},releaseStatesOfGeometry:function(e){if(void 0===o[e.id])return;const g=o[e.id];for(const e in g){const t=g[e];for(const e in t)A(t[e].object),delete t[e];delete g[e]}delete o[e.id]},releaseStatesOfProgram:function(e){for(const g in o){const t=o[g];if(void 0===t[e.id])continue;const I=t[e.id];for(const e in I)A(I[e].object),delete I[e];delete t[e.id]}},initAttributes:d,enableAttribute:u,disableUnusedAttributes:b}}function HC(e,g,t,I){const n=I.isWebGL2;let i;this.setMode=function(e){i=e},this.render=function(g,I){e.drawArrays(i,g,I),t.update(I,i,1)},this.renderInstances=function(I,C,o){if(0===o)return;let a,s;if(n)a=e,s="drawArraysInstanced";else if(a=g.get("ANGLE_instanced_arrays"),s="drawArraysInstancedANGLE",null===a)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");a[s](i,I,C,o),t.update(C,i,o)}}function NC(e,g,t){let I;function n(g){if("highp"===g){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";g="mediump"}return"mediump"===g&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}const i="undefined"!=typeof WebGL2RenderingContext&&"WebGL2RenderingContext"===e.constructor.name;let C=void 0!==t.precision?t.precision:"highp";const o=n(C);o!==C&&(console.warn("THREE.WebGLRenderer:",C,"not supported, using",o,"instead."),C=o);const a=i||g.has("WEBGL_draw_buffers"),s=!0===t.logarithmicDepthBuffer,l=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),r=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),A=e.getParameter(e.MAX_TEXTURE_SIZE),c=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),d=e.getParameter(e.MAX_VERTEX_ATTRIBS),u=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),h=e.getParameter(e.MAX_VARYING_VECTORS),b=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),m=r>0,p=i||g.has("OES_texture_float");return{isWebGL2:i,drawBuffers:a,getMaxAnisotropy:function(){if(void 0!==I)return I;if(!0===g.has("EXT_texture_filter_anisotropic")){const t=g.get("EXT_texture_filter_anisotropic");I=e.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else I=0;return I},getMaxPrecision:n,precision:C,logarithmicDepthBuffer:s,maxTextures:l,maxVertexTextures:r,maxTextureSize:A,maxCubemapSize:c,maxAttributes:d,maxVertexUniforms:u,maxVaryings:h,maxFragmentUniforms:b,vertexTextures:m,floatFragmentTextures:p,floatVertexTextures:m&&p,maxSamples:i?e.getParameter(e.MAX_SAMPLES):0}}function FC(e){const g=this;let t=null,I=0,n=!1,i=!1;const C=new BC,o=new cI,a={value:null,needsUpdate:!1};function s(e,t,I,n){const i=null!==e?e.length:0;let s=null;if(0!==i){if(s=a.value,!0!==n||null===s){const g=I+4*i,n=t.matrixWorldInverse;o.getNormalMatrix(n),(null===s||s.length<g)&&(s=new Float32Array(g));for(let g=0,t=I;g!==i;++g,t+=4)C.copy(e[g]).applyMatrix4(n,o),C.normal.toArray(s,t),s[t+3]=C.constant}a.value=s,a.needsUpdate=!0}return g.numPlanes=i,g.numIntersection=0,s}this.uniform=a,this.numPlanes=0,this.numIntersection=0,this.init=function(e,g){const t=0!==e.length||g||0!==I||n;return n=g,I=e.length,t},this.beginShadows=function(){i=!0,s(null)},this.endShadows=function(){i=!1},this.setGlobalState=function(e,g){t=s(e,g,0)},this.setState=function(C,o,l){const r=C.clippingPlanes,A=C.clipIntersection,c=C.clipShadows,d=e.get(C);if(!n||null===r||0===r.length||i&&!c)i?s(null):(a.value!==t&&(a.value=t,a.needsUpdate=I>0),g.numPlanes=I,g.numIntersection=0);else{const e=i?0:I,g=4*e;let n=d.clippingState||null;a.value=n,n=s(r,o,g,l);for(let e=0;e!==g;++e)n[e]=t[e];d.clippingState=n,this.numIntersection=A?this.numPlanes:0,this.numPlanes+=e}}}function xC(e){let g=new WeakMap;function t(e,g){return g===Ze?e.mapping=Ge:g===ye&&(e.mapping=Be),e}function I(e){const t=e.target;t.removeEventListener("dispose",I);const n=g.get(t);void 0!==n&&(g.delete(t),n.dispose())}return{get:function(n){if(n&&n.isTexture&&!1===n.isRenderTargetTexture){const i=n.mapping;if(i===Ze||i===ye){if(g.has(n))return t(g.get(n).texture,n.mapping);{const i=n.image;if(i&&i.height>0){const C=new bC(i.height/2);return C.fromEquirectangularTexture(e,n),g.set(n,C),n.addEventListener("dispose",I),t(C.texture,n.mapping)}return null}}}return n},dispose:function(){g=new WeakMap}}}class zC extends AC{constructor(e=-1,g=1,t=1,I=-1,n=.1,i=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=g,this.top=t,this.bottom=I,this.near=n,this.far=i,this.updateProjectionMatrix()}copy(e,g){return super.copy(e,g),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,g,t,I,n,i){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=g,this.view.offsetX=t,this.view.offsetY=I,this.view.width=n,this.view.height=i,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),g=(this.top-this.bottom)/(2*this.zoom),t=(this.right+this.left)/2,I=(this.top+this.bottom)/2;let n=t-e,i=t+e,C=I+g,o=I-g;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,g=(this.top-this.bottom)/this.view.fullHeight/this.zoom;n+=e*this.view.offsetX,i=n+e*this.view.width,C-=g*this.view.offsetY,o=C-g*this.view.height}this.projectionMatrix.makeOrthographic(n,i,C,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const g=super.toJSON(e);return g.object.zoom=this.zoom,g.object.left=this.left,g.object.right=this.right,g.object.top=this.top,g.object.bottom=this.bottom,g.object.near=this.near,g.object.far=this.far,null!==this.view&&(g.object.view=Object.assign({},this.view)),g}}const kC=[.125,.215,.35,.446,.526,.582],MC=new zC,LC=new Ai;let JC=null;const EC=(1+Math.sqrt(5))/2,TC=1/EC,UC=[new UI(1,1,1),new UI(-1,1,1),new UI(1,1,-1),new UI(-1,1,-1),new UI(0,EC,TC),new UI(0,EC,-TC),new UI(TC,0,EC),new UI(-TC,0,EC),new UI(EC,TC,0),new UI(-EC,TC,0)];class QC{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,g=0,t=.1,I=100){JC=this._renderer.getRenderTarget(),this._setSize(256);const n=this._allocateTargets();return n.depthBuffer=!0,this._sceneToCubeUV(e,t,I,n),g>0&&this._blur(n,0,0,g),this._applyPMREM(n),this._cleanup(n),n}fromEquirectangular(e,g=null){return this._fromTexture(e,g)}fromCubemap(e,g=null){return this._fromTexture(e,g)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=PC(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=jC(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(JC),e.scissorTest=!1,OC(e,0,0,e.width,e.height)}_fromTexture(e,g){e.mapping===Ge||e.mapping===Be?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),JC=this._renderer.getRenderTarget();const t=g||this._allocateTargets();return this._textureToCubeUV(e,t),this._applyPMREM(t),this._cleanup(t),t}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),g=4*this._cubeSize,t={magFilter:Ke,minFilter:Ke,generateMipmaps:!1,type:Ue,format:Pe,colorSpace:Ct,depthBuffer:!1},I=DC(e,g,t);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==g){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=DC(e,g,t);const{_lodMax:I}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(e){const g=[],t=[],I=[];let n=e;const i=e-4+1+kC.length;for(let C=0;C<i;C++){const i=Math.pow(2,n);t.push(i);let o=1/i;C>e-4?o=kC[C-e+4-1]:0===C&&(o=0),I.push(o);const a=1/(i-2),s=-a,l=1+a,r=[s,s,l,s,l,l,s,s,l,l,s,l],A=6,c=6,d=3,u=2,h=1,b=new Float32Array(d*c*A),m=new Float32Array(u*c*A),p=new Float32Array(h*c*A);for(let e=0;e<A;e++){const g=e%3*2/3-1,t=e>2?0:-1,I=[g,t,0,g+2/3,t,0,g+2/3,t+1,0,g,t,0,g+2/3,t+1,0,g,t+1,0];b.set(I,d*c*e),m.set(r,u*c*e);const n=[e,e,e,e,e,e];p.set(n,h*c*e)}const G=new Mi;G.setAttribute("position",new Zi(b,d)),G.setAttribute("uv",new Zi(m,u)),G.setAttribute("faceIndex",new Zi(p,h)),g.push(G),n>4&&n--}return{lodPlanes:g,sizeLods:t,sigmas:I}}(I)),this._blurMaterial=function(e,g,t){const I=new Float32Array(20),n=new UI(0,1,0);return new rC({name:"SphericalGaussianBlur",defines:{n:20,CUBEUV_TEXEL_WIDTH:1/g,CUBEUV_TEXEL_HEIGHT:1/t,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:I},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:n}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:H,depthTest:!1,depthWrite:!1})}(I,e,g)}return I}_compileMaterial(e){const g=new nC(this._lodPlanes[0],e);this._renderer.compile(g,MC)}_sceneToCubeUV(e,g,t,I){const n=new cC(90,1,g,t),i=[1,-1,1,1,1,1],C=[1,1,1,-1,-1,-1],o=this._renderer,a=o.autoClear,s=o.toneMapping;o.getClearColor(LC),o.toneMapping=ce,o.autoClear=!1;const l=new di({name:"PMREM.Background",side:S,depthWrite:!1,depthTest:!1}),r=new nC(new CC,l);let A=!1;const c=e.background;c?c.isColor&&(l.color.copy(c),e.background=null,A=!0):(l.color.copy(LC),A=!0);for(let g=0;g<6;g++){const t=g%3;0===t?(n.up.set(0,i[g],0),n.lookAt(C[g],0,0)):1===t?(n.up.set(0,0,i[g]),n.lookAt(0,C[g],0)):(n.up.set(0,i[g],0),n.lookAt(0,0,C[g]));const a=this._cubeSize;OC(I,t*a,g>2?a:0,a,a),o.setRenderTarget(I),A&&o.render(r,n),o.render(e,n)}r.geometry.dispose(),r.material.dispose(),o.toneMapping=s,o.autoClear=a,e.background=c}_textureToCubeUV(e,g){const t=this._renderer,I=e.mapping===Ge||e.mapping===Be;I?(null===this._cubemapMaterial&&(this._cubemapMaterial=PC()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=jC());const n=I?this._cubemapMaterial:this._equirectMaterial,i=new nC(this._lodPlanes[0],n);n.uniforms.envMap.value=e;const C=this._cubeSize;OC(g,0,0,3*C,2*C),t.setRenderTarget(g),t.render(i,MC)}_applyPMREM(e){const g=this._renderer,t=g.autoClear;g.autoClear=!1;for(let g=1;g<this._lodPlanes.length;g++){const t=Math.sqrt(this._sigmas[g]*this._sigmas[g]-this._sigmas[g-1]*this._sigmas[g-1]),I=UC[(g-1)%UC.length];this._blur(e,g-1,g,t,I)}g.autoClear=t}_blur(e,g,t,I,n){const i=this._pingPongRenderTarget;this._halfBlur(e,i,g,t,I,"latitudinal",n),this._halfBlur(i,e,t,t,I,"longitudinal",n)}_halfBlur(e,g,t,I,n,i,C){const o=this._renderer,a=this._blurMaterial;"latitudinal"!==i&&"longitudinal"!==i&&console.error("blur direction must be either latitudinal or longitudinal!");const s=new nC(this._lodPlanes[I],a),l=a.uniforms,r=this._sizeLods[t]-1,A=isFinite(n)?Math.PI/(2*r):2*Math.PI/39,c=n/A,d=isFinite(n)?1+Math.floor(3*c):20;d>20&&console.warn(`sigmaRadians, ${n}, is too large and will clip, as it requested ${d} samples when the maximum is set to 20`);const u=[];let h=0;for(let e=0;e<20;++e){const g=e/c,t=Math.exp(-g*g/2);u.push(t),0===e?h+=t:e<d&&(h+=2*t)}for(let e=0;e<u.length;e++)u[e]=u[e]/h;l.envMap.value=e.texture,l.samples.value=d,l.weights.value=u,l.latitudinal.value="latitudinal"===i,C&&(l.poleAxis.value=C);const{_lodMax:b}=this;l.dTheta.value=A,l.mipInt.value=b-t;const m=this._sizeLods[I];OC(g,3*m*(I>b-4?I-b+4:0),4*(this._cubeSize-m),3*m,2*m),o.setRenderTarget(g),o.render(s,MC)}}function DC(e,g,t){const I=new zI(e,g,t);return I.texture.mapping=ve,I.texture.name="PMREM.cubeUv",I.scissorTest=!0,I}function OC(e,g,t,I,n){e.viewport.set(g,t,I,n),e.scissor.set(g,t,I,n)}function jC(){return new rC({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:H,depthTest:!1,depthWrite:!1})}function PC(){return new rC({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:H,depthTest:!1,depthWrite:!1})}function _C(e){let g=new WeakMap,t=null;function I(e){const t=e.target;t.removeEventListener("dispose",I);const n=g.get(t);void 0!==n&&(g.delete(t),n.dispose())}return{get:function(n){if(n&&n.isTexture){const i=n.mapping,C=i===Ze||i===ye,o=i===Ge||i===Be;if(C||o){if(n.isRenderTargetTexture&&!0===n.needsPMREMUpdate){n.needsPMREMUpdate=!1;let I=g.get(n);return null===t&&(t=new QC(e)),I=C?t.fromEquirectangular(n,I):t.fromCubemap(n,I),g.set(n,I),I.texture}if(g.has(n))return g.get(n).texture;{const i=n.image;if(C&&i&&i.height>0||o&&i&&function(e){let g=0;for(let t=0;t<6;t++)void 0!==e[t]&&g++;return 6===g}(i)){null===t&&(t=new QC(e));const i=C?t.fromEquirectangular(n):t.fromCubemap(n);return g.set(n,i),n.addEventListener("dispose",I),i.texture}return null}}}return n},dispose:function(){g=new WeakMap,null!==t&&(t.dispose(),t=null)}}}function qC(e){const g={};function t(t){if(void 0!==g[t])return g[t];let I;switch(t){case"WEBGL_depth_texture":I=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":I=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":I=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":I=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:I=e.getExtension(t)}return g[t]=I,I}return{has:function(e){return null!==t(e)},init:function(e){e.isWebGL2?t("EXT_color_buffer_float"):(t("WEBGL_depth_texture"),t("OES_texture_float"),t("OES_texture_half_float"),t("OES_texture_half_float_linear"),t("OES_standard_derivatives"),t("OES_element_index_uint"),t("OES_vertex_array_object"),t("ANGLE_instanced_arrays")),t("OES_texture_float_linear"),t("EXT_color_buffer_half_float"),t("WEBGL_multisampled_render_to_texture")},get:function(e){const g=t(e);return null===g&&console.warn("THREE.WebGLRenderer: "+e+" extension not supported."),g}}}function $C(e,g,t,I){const n={},i=new WeakMap;function C(e){const o=e.target;null!==o.index&&g.remove(o.index);for(const e in o.attributes)g.remove(o.attributes[e]);for(const e in o.morphAttributes){const t=o.morphAttributes[e];for(let e=0,I=t.length;e<I;e++)g.remove(t[e])}o.removeEventListener("dispose",C),delete n[o.id];const a=i.get(o);a&&(g.remove(a),i.delete(o)),I.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,t.memory.geometries--}function o(e){const t=[],I=e.index,n=e.attributes.position;let C=0;if(null!==I){const e=I.array;C=I.version;for(let g=0,I=e.length;g<I;g+=3){const I=e[g+0],n=e[g+1],i=e[g+2];t.push(I,n,n,i,i,I)}}else{if(void 0===n)return;{const e=n.array;C=n.version;for(let g=0,I=e.length/3-1;g<I;g+=3){const e=g+0,I=g+1,n=g+2;t.push(e,I,I,n,n,e)}}}const o=new(uI(t)?Vi:wi)(t,1);o.version=C;const a=i.get(e);a&&g.remove(a),i.set(e,o)}return{get:function(e,g){return!0===n[g.id]||(g.addEventListener("dispose",C),n[g.id]=!0,t.memory.geometries++),g},update:function(t){const I=t.attributes;for(const t in I)g.update(I[t],e.ARRAY_BUFFER);const n=t.morphAttributes;for(const t in n){const I=n[t];for(let t=0,n=I.length;t<n;t++)g.update(I[t],e.ARRAY_BUFFER)}},getWireframeAttribute:function(e){const g=i.get(e);if(g){const t=e.index;null!==t&&g.version<t.version&&o(e)}else o(e);return i.get(e)}}}function eo(e,g,t,I){const n=I.isWebGL2;let i,C,o;this.setMode=function(e){i=e},this.setIndex=function(e){C=e.type,o=e.bytesPerElement},this.render=function(g,I){e.drawElements(i,I,C,g*o),t.update(I,i,1)},this.renderInstances=function(I,a,s){if(0===s)return;let l,r;if(n)l=e,r="drawElementsInstanced";else if(l=g.get("ANGLE_instanced_arrays"),r="drawElementsInstancedANGLE",null===l)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");l[r](i,a,C,I*o,s),t.update(a,i,s)}}function go(e){const g={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:g,programs:null,autoReset:!0,reset:function(){g.calls=0,g.triangles=0,g.points=0,g.lines=0},update:function(t,I,n){switch(g.calls++,I){case e.TRIANGLES:g.triangles+=n*(t/3);break;case e.LINES:g.lines+=n*(t/2);break;case e.LINE_STRIP:g.lines+=n*(t-1);break;case e.LINE_LOOP:g.lines+=n*t;break;case e.POINTS:g.points+=n*t;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",I)}}}}function to(e,g){return e[0]-g[0]}function Io(e,g){return Math.abs(g[1])-Math.abs(e[1])}function no(e,g,t){const I={},n=new Float32Array(8),i=new WeakMap,C=new FI,o=[];for(let e=0;e<8;e++)o[e]=[e,0];return{update:function(a,s,l){const r=a.morphTargetInfluences;if(!0===g.isWebGL2){const A=s.morphAttributes.position||s.morphAttributes.normal||s.morphAttributes.color,c=void 0!==A?A.length:0;let d=i.get(s);if(void 0===d||d.count!==c){void 0!==d&&d.texture.dispose();const b=void 0!==s.morphAttributes.position,m=void 0!==s.morphAttributes.normal,p=void 0!==s.morphAttributes.color,G=s.morphAttributes.position||[],B=s.morphAttributes.normal||[],Z=s.morphAttributes.color||[];let y=0;!0===b&&(y=1),!0===m&&(y=2),!0===p&&(y=3);let v=s.attributes.position.count*y,W=1;v>g.maxTextureSize&&(W=Math.ceil(v/g.maxTextureSize),v=g.maxTextureSize);const f=new Float32Array(v*W*4*c),w=new kI(f,v,W,c);w.type=Te,w.needsUpdate=!0;const R=4*y;for(let X=0;X<c;X++){const S=G[X],Y=B[X],K=Z[X],H=v*W*4*X;for(let N=0;N<S.count;N++){const F=N*R;!0===b&&(C.fromBufferAttribute(S,N),f[H+F+0]=C.x,f[H+F+1]=C.y,f[H+F+2]=C.z,f[H+F+3]=0),!0===m&&(C.fromBufferAttribute(Y,N),f[H+F+4]=C.x,f[H+F+5]=C.y,f[H+F+6]=C.z,f[H+F+7]=0),!0===p&&(C.fromBufferAttribute(K,N),f[H+F+8]=C.x,f[H+F+9]=C.y,f[H+F+10]=C.z,f[H+F+11]=4===K.itemSize?C.w:1)}}function V(){w.dispose(),i.delete(s),s.removeEventListener("dispose",V)}d={count:c,texture:w,size:new AI(v,W)},i.set(s,d),s.addEventListener("dispose",V)}let u=0;for(let x=0;x<r.length;x++)u+=r[x];const h=s.morphTargetsRelative?1:1-u;l.getUniforms().setValue(e,"morphTargetBaseInfluence",h),l.getUniforms().setValue(e,"morphTargetInfluences",r),l.getUniforms().setValue(e,"morphTargetsTexture",d.texture,t),l.getUniforms().setValue(e,"morphTargetsTextureSize",d.size)}else{const z=void 0===r?0:r.length;let k=I[s.id];if(void 0===k||k.length!==z){k=[];for(let T=0;T<z;T++)k[T]=[T,0];I[s.id]=k}for(let U=0;U<z;U++){const Q=k[U];Q[0]=U,Q[1]=r[U]}k.sort(Io);for(let D=0;D<8;D++)D<z&&k[D][1]?(o[D][0]=k[D][0],o[D][1]=k[D][1]):(o[D][0]=Number.MAX_SAFE_INTEGER,o[D][1]=0);o.sort(to);const M=s.morphAttributes.position,L=s.morphAttributes.normal;let J=0;for(let O=0;O<8;O++){const j=o[O],P=j[0],_=j[1];P!==Number.MAX_SAFE_INTEGER&&_?(M&&s.getAttribute("morphTarget"+O)!==M[P]&&s.setAttribute("morphTarget"+O,M[P]),L&&s.getAttribute("morphNormal"+O)!==L[P]&&s.setAttribute("morphNormal"+O,L[P]),n[O]=_,J+=_):(M&&!0===s.hasAttribute("morphTarget"+O)&&s.deleteAttribute("morphTarget"+O),L&&!0===s.hasAttribute("morphNormal"+O)&&s.deleteAttribute("morphNormal"+O),n[O]=0)}const E=s.morphTargetsRelative?1:1-J;l.getUniforms().setValue(e,"morphTargetBaseInfluence",E),l.getUniforms().setValue(e,"morphTargetInfluences",n)}}}}function io(e,g,t,I){let n=new WeakMap;function i(e){const g=e.target;g.removeEventListener("dispose",i),t.remove(g.instanceMatrix),null!==g.instanceColor&&t.remove(g.instanceColor)}return{update:function(C){const o=I.render.frame,a=C.geometry,s=g.get(C,a);if(n.get(s)!==o&&(g.update(s),n.set(s,o)),C.isInstancedMesh&&(!1===C.hasEventListener("dispose",i)&&C.addEventListener("dispose",i),n.get(C)!==o&&(t.update(C.instanceMatrix,e.ARRAY_BUFFER),null!==C.instanceColor&&t.update(C.instanceColor,e.ARRAY_BUFFER),n.set(C,o))),C.isSkinnedMesh){const e=C.skeleton;n.get(e)!==o&&(e.update(),n.set(e,o))}return s},dispose:function(){n=new WeakMap}}}const Co=new NI,oo=new kI,ao=new LI,so=new hC,lo=[],ro=[],Ao=new Float32Array(16),co=new Float32Array(9),uo=new Float32Array(4);function ho(e,g,t){const I=e[0];if(I<=0||I>0)return e;const n=g*t;let i=lo[n];if(void 0===i&&(i=new Float32Array(n),lo[n]=i),0!==g){I.toArray(i,0);for(let I=1,n=0;I!==g;++I)n+=t,e[I].toArray(i,n)}return i}function bo(e,g){if(e.length!==g.length)return!1;for(let t=0,I=e.length;t<I;t++)if(e[t]!==g[t])return!1;return!0}function mo(e,g){for(let t=0,I=g.length;t<I;t++)e[t]=g[t]}function po(e,g){let t=ro[g];void 0===t&&(t=new Int32Array(g),ro[g]=t);for(let I=0;I!==g;++I)t[I]=e.allocateTextureUnit();return t}function Go(e,g){const t=this.cache;t[0]!==g&&(e.uniform1f(this.addr,g),t[0]=g)}function Bo(e,g){const t=this.cache;if(void 0!==g.x)t[0]===g.x&&t[1]===g.y||(e.uniform2f(this.addr,g.x,g.y),t[0]=g.x,t[1]=g.y);else{if(bo(t,g))return;e.uniform2fv(this.addr,g),mo(t,g)}}function Zo(e,g){const t=this.cache;if(void 0!==g.x)t[0]===g.x&&t[1]===g.y&&t[2]===g.z||(e.uniform3f(this.addr,g.x,g.y,g.z),t[0]=g.x,t[1]=g.y,t[2]=g.z);else if(void 0!==g.r)t[0]===g.r&&t[1]===g.g&&t[2]===g.b||(e.uniform3f(this.addr,g.r,g.g,g.b),t[0]=g.r,t[1]=g.g,t[2]=g.b);else{if(bo(t,g))return;e.uniform3fv(this.addr,g),mo(t,g)}}function yo(e,g){const t=this.cache;if(void 0!==g.x)t[0]===g.x&&t[1]===g.y&&t[2]===g.z&&t[3]===g.w||(e.uniform4f(this.addr,g.x,g.y,g.z,g.w),t[0]=g.x,t[1]=g.y,t[2]=g.z,t[3]=g.w);else{if(bo(t,g))return;e.uniform4fv(this.addr,g),mo(t,g)}}function vo(e,g){const t=this.cache,I=g.elements;if(void 0===I){if(bo(t,g))return;e.uniformMatrix2fv(this.addr,!1,g),mo(t,g)}else{if(bo(t,I))return;uo.set(I),e.uniformMatrix2fv(this.addr,!1,uo),mo(t,I)}}function Wo(e,g){const t=this.cache,I=g.elements;if(void 0===I){if(bo(t,g))return;e.uniformMatrix3fv(this.addr,!1,g),mo(t,g)}else{if(bo(t,I))return;co.set(I),e.uniformMatrix3fv(this.addr,!1,co),mo(t,I)}}function fo(e,g){const t=this.cache,I=g.elements;if(void 0===I){if(bo(t,g))return;e.uniformMatrix4fv(this.addr,!1,g),mo(t,g)}else{if(bo(t,I))return;Ao.set(I),e.uniformMatrix4fv(this.addr,!1,Ao),mo(t,I)}}function wo(e,g){const t=this.cache;t[0]!==g&&(e.uniform1i(this.addr,g),t[0]=g)}function Ro(e,g){const t=this.cache;if(void 0!==g.x)t[0]===g.x&&t[1]===g.y||(e.uniform2i(this.addr,g.x,g.y),t[0]=g.x,t[1]=g.y);else{if(bo(t,g))return;e.uniform2iv(this.addr,g),mo(t,g)}}function Vo(e,g){const t=this.cache;if(void 0!==g.x)t[0]===g.x&&t[1]===g.y&&t[2]===g.z||(e.uniform3i(this.addr,g.x,g.y,g.z),t[0]=g.x,t[1]=g.y,t[2]=g.z);else{if(bo(t,g))return;e.uniform3iv(this.addr,g),mo(t,g)}}function Xo(e,g){const t=this.cache;if(void 0!==g.x)t[0]===g.x&&t[1]===g.y&&t[2]===g.z&&t[3]===g.w||(e.uniform4i(this.addr,g.x,g.y,g.z,g.w),t[0]=g.x,t[1]=g.y,t[2]=g.z,t[3]=g.w);else{if(bo(t,g))return;e.uniform4iv(this.addr,g),mo(t,g)}}function So(e,g){const t=this.cache;t[0]!==g&&(e.uniform1ui(this.addr,g),t[0]=g)}function Yo(e,g){const t=this.cache;if(void 0!==g.x)t[0]===g.x&&t[1]===g.y||(e.uniform2ui(this.addr,g.x,g.y),t[0]=g.x,t[1]=g.y);else{if(bo(t,g))return;e.uniform2uiv(this.addr,g),mo(t,g)}}function Ko(e,g){const t=this.cache;if(void 0!==g.x)t[0]===g.x&&t[1]===g.y&&t[2]===g.z||(e.uniform3ui(this.addr,g.x,g.y,g.z),t[0]=g.x,t[1]=g.y,t[2]=g.z);else{if(bo(t,g))return;e.uniform3uiv(this.addr,g),mo(t,g)}}function Ho(e,g){const t=this.cache;if(void 0!==g.x)t[0]===g.x&&t[1]===g.y&&t[2]===g.z&&t[3]===g.w||(e.uniform4ui(this.addr,g.x,g.y,g.z,g.w),t[0]=g.x,t[1]=g.y,t[2]=g.z,t[3]=g.w);else{if(bo(t,g))return;e.uniform4uiv(this.addr,g),mo(t,g)}}function No(e,g,t){const I=this.cache,n=t.allocateTextureUnit();I[0]!==n&&(e.uniform1i(this.addr,n),I[0]=n),t.setTexture2D(g||Co,n)}function Fo(e,g,t){const I=this.cache,n=t.allocateTextureUnit();I[0]!==n&&(e.uniform1i(this.addr,n),I[0]=n),t.setTexture3D(g||ao,n)}function xo(e,g,t){const I=this.cache,n=t.allocateTextureUnit();I[0]!==n&&(e.uniform1i(this.addr,n),I[0]=n),t.setTextureCube(g||so,n)}function zo(e,g,t){const I=this.cache,n=t.allocateTextureUnit();I[0]!==n&&(e.uniform1i(this.addr,n),I[0]=n),t.setTexture2DArray(g||oo,n)}function ko(e,g){e.uniform1fv(this.addr,g)}function Mo(e,g){const t=ho(g,this.size,2);e.uniform2fv(this.addr,t)}function Lo(e,g){const t=ho(g,this.size,3);e.uniform3fv(this.addr,t)}function Jo(e,g){const t=ho(g,this.size,4);e.uniform4fv(this.addr,t)}function Eo(e,g){const t=ho(g,this.size,4);e.uniformMatrix2fv(this.addr,!1,t)}function To(e,g){const t=ho(g,this.size,9);e.uniformMatrix3fv(this.addr,!1,t)}function Uo(e,g){const t=ho(g,this.size,16);e.uniformMatrix4fv(this.addr,!1,t)}function Qo(e,g){e.uniform1iv(this.addr,g)}function Do(e,g){e.uniform2iv(this.addr,g)}function Oo(e,g){e.uniform3iv(this.addr,g)}function jo(e,g){e.uniform4iv(this.addr,g)}function Po(e,g){e.uniform1uiv(this.addr,g)}function _o(e,g){e.uniform2uiv(this.addr,g)}function qo(e,g){e.uniform3uiv(this.addr,g)}function $o(e,g){e.uniform4uiv(this.addr,g)}function ea(e,g,t){const I=this.cache,n=g.length,i=po(t,n);bo(I,i)||(e.uniform1iv(this.addr,i),mo(I,i));for(let e=0;e!==n;++e)t.setTexture2D(g[e]||Co,i[e])}function ga(e,g,t){const I=this.cache,n=g.length,i=po(t,n);bo(I,i)||(e.uniform1iv(this.addr,i),mo(I,i));for(let e=0;e!==n;++e)t.setTexture3D(g[e]||ao,i[e])}function ta(e,g,t){const I=this.cache,n=g.length,i=po(t,n);bo(I,i)||(e.uniform1iv(this.addr,i),mo(I,i));for(let e=0;e!==n;++e)t.setTextureCube(g[e]||so,i[e])}function Ia(e,g,t){const I=this.cache,n=g.length,i=po(t,n);bo(I,i)||(e.uniform1iv(this.addr,i),mo(I,i));for(let e=0;e!==n;++e)t.setTexture2DArray(g[e]||oo,i[e])}class na{constructor(e,g,t){this.id=e,this.addr=t,this.cache=[],this.setValue=function(e){switch(e){case 5126:return Go;case 35664:return Bo;case 35665:return Zo;case 35666:return yo;case 35674:return vo;case 35675:return Wo;case 35676:return fo;case 5124:case 35670:return wo;case 35667:case 35671:return Ro;case 35668:case 35672:return Vo;case 35669:case 35673:return Xo;case 5125:return So;case 36294:return Yo;case 36295:return Ko;case 36296:return Ho;case 35678:case 36198:case 36298:case 36306:case 35682:return No;case 35679:case 36299:case 36307:return Fo;case 35680:case 36300:case 36308:case 36293:return xo;case 36289:case 36303:case 36311:case 36292:return zo}}(g.type)}}class ia{constructor(e,g,t){this.id=e,this.addr=t,this.cache=[],this.size=g.size,this.setValue=function(e){switch(e){case 5126:return ko;case 35664:return Mo;case 35665:return Lo;case 35666:return Jo;case 35674:return Eo;case 35675:return To;case 35676:return Uo;case 5124:case 35670:return Qo;case 35667:case 35671:return Do;case 35668:case 35672:return Oo;case 35669:case 35673:return jo;case 5125:return Po;case 36294:return _o;case 36295:return qo;case 36296:return $o;case 35678:case 36198:case 36298:case 36306:case 35682:return ea;case 35679:case 36299:case 36307:return ga;case 35680:case 36300:case 36308:case 36293:return ta;case 36289:case 36303:case 36311:case 36292:return Ia}}(g.type)}}class Ca{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,g,t){const I=this.seq;for(let n=0,i=I.length;n!==i;++n){const i=I[n];i.setValue(e,g[i.id],t)}}}const oa=/(\w+)(\])?(\[|\.)?/g;function aa(e,g){e.seq.push(g),e.map[g.id]=g}function sa(e,g,t){const I=e.name,n=I.length;for(oa.lastIndex=0;;){const i=oa.exec(I),C=oa.lastIndex;let o=i[1];const a="]"===i[2],s=i[3];if(a&&(o|=0),void 0===s||"["===s&&C+2===n){aa(t,void 0===s?new na(o,e,g):new ia(o,e,g));break}{let e=t.map[o];void 0===e&&(e=new Ca(o),aa(t,e)),t=e}}}class la{constructor(e,g){this.seq=[],this.map={};const t=e.getProgramParameter(g,e.ACTIVE_UNIFORMS);for(let I=0;I<t;++I){const t=e.getActiveUniform(g,I);sa(t,e.getUniformLocation(g,t.name),this)}}setValue(e,g,t,I){const n=this.map[g];void 0!==n&&n.setValue(e,t,I)}setOptional(e,g,t){const I=g[t];void 0!==I&&this.setValue(e,t,I)}static upload(e,g,t,I){for(let n=0,i=g.length;n!==i;++n){const i=g[n],C=t[i.id];!1!==C.needsUpdate&&i.setValue(e,C.value,I)}}static seqWithValue(e,g){const t=[];for(let I=0,n=e.length;I!==n;++I){const n=e[I];n.id in g&&t.push(n)}return t}}function ra(e,g,t){const I=e.createShader(g);return e.shaderSource(I,t),e.compileShader(I),I}let Aa=0;function ca(e,g,t){const I=e.getShaderParameter(g,e.COMPILE_STATUS),n=e.getShaderInfoLog(g).trim();if(I&&""===n)return"";const i=/ERROR: 0:(\d+)/.exec(n);if(i){const I=parseInt(i[1]);return t.toUpperCase()+"\n\n"+n+"\n\n"+function(e,g){const t=e.split("\n"),I=[],n=Math.max(g-6,0),i=Math.min(g+6,t.length);for(let e=n;e<i;e++){const n=e+1;I.push(`${n===g?">":" "} ${n}: ${t[e]}`)}return I.join("\n")}(e.getShaderSource(g),I)}return n}function da(e,g){const t=function(e){const g=fI.getPrimaries(fI.workingColorSpace),t=fI.getPrimaries(e);let I;switch(g===t?I="":g===At&&t===rt?I="LinearDisplayP3ToLinearSRGB":g===rt&&t===At&&(I="LinearSRGBToLinearDisplayP3"),e){case Ct:case at:return[I,"LinearTransferOETF"];case it:case ot:return[I,"sRGBTransferOETF"];default:return console.warn("THREE.WebGLProgram: Unsupported color space:",e),[I,"LinearTransferOETF"]}}(g);return`vec4 ${e}( vec4 value ) { return ${t[0]}( ${t[1]}( value ) ); }`}function ua(e,g){let t;switch(g){case de:t="Linear";break;case ue:t="Reinhard";break;case he:t="OptimizedCineon";break;case be:t="ACESFilmic";break;case me:t="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",g),t="Linear"}return"vec3 "+e+"( vec3 color ) { return "+t+"ToneMapping( color ); }"}function ha(e){return""!==e}function ba(e,g){const t=g.numSpotLightShadows+g.numSpotLightMaps-g.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,g.numDirLights).replace(/NUM_SPOT_LIGHTS/g,g.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,g.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,t).replace(/NUM_RECT_AREA_LIGHTS/g,g.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,g.numPointLights).replace(/NUM_HEMI_LIGHTS/g,g.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,g.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,g.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,g.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,g.numPointLightShadows)}function ma(e,g){return e.replace(/NUM_CLIPPING_PLANES/g,g.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,g.numClippingPlanes-g.numClipIntersection)}const pa=/^[ \t]*#include +<([\w\d./]+)>/gm;function Ga(e){return e.replace(pa,Za)}const Ba=new Map([["encodings_fragment","colorspace_fragment"],["encodings_pars_fragment","colorspace_pars_fragment"],["output_fragment","opaque_fragment"]]);function Za(e,g){let t=RC[g];if(void 0===t){const e=Ba.get(g);if(void 0===e)throw new Error("Can not resolve #include <"+g+">");t=RC[e],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',g,e)}return Ga(t)}const ya=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function va(e){return e.replace(ya,Wa)}function Wa(e,g,t,I){let n="";for(let e=parseInt(g);e<parseInt(t);e++)n+=I.replace(/\[\s*i\s*\]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return n}function fa(e){let g="precision "+e.precision+" float;\nprecision "+e.precision+" int;";return"highp"===e.precision?g+="\n#define HIGH_PRECISION":"mediump"===e.precision?g+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(g+="\n#define LOW_PRECISION"),g}function wa(e,g,t,I){const n=e.getContext(),i=t.defines;let C=t.vertexShader,o=t.fragmentShader;const a=function(e){let g="SHADOWMAP_TYPE_BASIC";return e.shadowMapType===w?g="SHADOWMAP_TYPE_PCF":e.shadowMapType===R?g="SHADOWMAP_TYPE_PCF_SOFT":e.shadowMapType===V&&(g="SHADOWMAP_TYPE_VSM"),g}(t),s=function(e){let g="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case Ge:case Be:g="ENVMAP_TYPE_CUBE";break;case ve:g="ENVMAP_TYPE_CUBE_UV"}return g}(t),l=function(e){let g="ENVMAP_MODE_REFLECTION";return e.envMap&&e.envMapMode===Be&&(g="ENVMAP_MODE_REFRACTION"),g}(t),r=function(e){let g="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case le:g="ENVMAP_BLENDING_MULTIPLY";break;case re:g="ENVMAP_BLENDING_MIX";break;case Ae:g="ENVMAP_BLENDING_ADD"}return g}(t),A=function(e){const g=e.envMapCubeUVHeight;if(null===g)return null;const t=Math.log2(g)-2,I=1/g;return{texelWidth:1/(3*Math.max(Math.pow(2,t),112)),texelHeight:I,maxMip:t}}(t),c=t.isWebGL2?"":function(e){return[e.extensionDerivatives||e.envMapCubeUVHeight||e.bumpMap||e.normalMapTangentSpace||e.clearcoatNormalMap||e.flatShading||"physical"===e.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(e.extensionFragDepth||e.logarithmicDepthBuffer)&&e.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",e.extensionDrawBuffers&&e.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(e.extensionShaderTextureLOD||e.envMap||e.transmission)&&e.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(ha).join("\n")}(t),d=function(e){const g=[];for(const t in e){const I=e[t];!1!==I&&g.push("#define "+t+" "+I)}return g.join("\n")}(i),u=n.createProgram();let h,b,m=t.glslVersion?"#version "+t.glslVersion+"\n":"";t.isRawShaderMaterial?(h=["#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,d].filter(ha).join("\n"),h.length>0&&(h+="\n"),b=[c,"#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,d].filter(ha).join("\n"),b.length>0&&(b+="\n")):(h=[fa(t),"#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,d,t.instancing?"#define USE_INSTANCING":"",t.instancingColor?"#define USE_INSTANCING_COLOR":"",t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.map?"#define USE_MAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+l:"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",t.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",t.displacementMap?"#define USE_DISPLACEMENTMAP":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",t.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",t.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.alphaHash?"#define USE_ALPHAHASH":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",t.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",t.mapUv?"#define MAP_UV "+t.mapUv:"",t.alphaMapUv?"#define ALPHAMAP_UV "+t.alphaMapUv:"",t.lightMapUv?"#define LIGHTMAP_UV "+t.lightMapUv:"",t.aoMapUv?"#define AOMAP_UV "+t.aoMapUv:"",t.emissiveMapUv?"#define EMISSIVEMAP_UV "+t.emissiveMapUv:"",t.bumpMapUv?"#define BUMPMAP_UV "+t.bumpMapUv:"",t.normalMapUv?"#define NORMALMAP_UV "+t.normalMapUv:"",t.displacementMapUv?"#define DISPLACEMENTMAP_UV "+t.displacementMapUv:"",t.metalnessMapUv?"#define METALNESSMAP_UV "+t.metalnessMapUv:"",t.roughnessMapUv?"#define ROUGHNESSMAP_UV "+t.roughnessMapUv:"",t.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+t.anisotropyMapUv:"",t.clearcoatMapUv?"#define CLEARCOATMAP_UV "+t.clearcoatMapUv:"",t.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+t.clearcoatNormalMapUv:"",t.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+t.clearcoatRoughnessMapUv:"",t.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+t.iridescenceMapUv:"",t.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+t.iridescenceThicknessMapUv:"",t.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+t.sheenColorMapUv:"",t.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+t.sheenRoughnessMapUv:"",t.specularMapUv?"#define SPECULARMAP_UV "+t.specularMapUv:"",t.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+t.specularColorMapUv:"",t.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+t.specularIntensityMapUv:"",t.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+t.transmissionMapUv:"",t.thicknessMapUv?"#define THICKNESSMAP_UV "+t.thicknessMapUv:"",t.vertexTangents&&!1===t.flatShading?"#define USE_TANGENT":"",t.vertexColors?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUv1s?"#define USE_UV1":"",t.vertexUv2s?"#define USE_UV2":"",t.vertexUv3s?"#define USE_UV3":"",t.pointsUvs?"#define USE_POINTS_UV":"",t.flatShading?"#define FLAT_SHADED":"",t.skinning?"#define USE_SKINNING":"",t.morphTargets?"#define USE_MORPHTARGETS":"",t.morphNormals&&!1===t.flatShading?"#define USE_MORPHNORMALS":"",t.morphColors&&t.isWebGL2?"#define USE_MORPHCOLORS":"",t.morphTargetsCount>0&&t.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",t.morphTargetsCount>0&&t.isWebGL2?"#define MORPHTARGETS_TEXTURE_STRIDE "+t.morphTextureStride:"",t.morphTargetsCount>0&&t.isWebGL2?"#define MORPHTARGETS_COUNT "+t.morphTargetsCount:"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+a:"",t.sizeAttenuation?"#define USE_SIZEATTENUATION":"",t.numLightProbes>0?"#define USE_LIGHT_PROBES":"",t.useLegacyLights?"#define LEGACY_LIGHTS":"",t.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",t.logarithmicDepthBuffer&&t.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(ha).join("\n"),b=[c,fa(t),"#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,d,t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.map?"#define USE_MAP":"",t.matcap?"#define USE_MATCAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+s:"",t.envMap?"#define "+l:"",t.envMap?"#define "+r:"",A?"#define CUBEUV_TEXEL_WIDTH "+A.texelWidth:"",A?"#define CUBEUV_TEXEL_HEIGHT "+A.texelHeight:"",A?"#define CUBEUV_MAX_MIP "+A.maxMip+".0":"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",t.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.clearcoat?"#define USE_CLEARCOAT":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.iridescence?"#define USE_IRIDESCENCE":"",t.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",t.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",t.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.alphaTest?"#define USE_ALPHATEST":"",t.alphaHash?"#define USE_ALPHAHASH":"",t.sheen?"#define USE_SHEEN":"",t.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",t.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.vertexTangents&&!1===t.flatShading?"#define USE_TANGENT":"",t.vertexColors||t.instancingColor?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUv1s?"#define USE_UV1":"",t.vertexUv2s?"#define USE_UV2":"",t.vertexUv3s?"#define USE_UV3":"",t.pointsUvs?"#define USE_POINTS_UV":"",t.gradientMap?"#define USE_GRADIENTMAP":"",t.flatShading?"#define FLAT_SHADED":"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+a:"",t.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",t.numLightProbes>0?"#define USE_LIGHT_PROBES":"",t.useLegacyLights?"#define LEGACY_LIGHTS":"",t.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",t.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",t.logarithmicDepthBuffer&&t.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",t.toneMapping!==ce?"#define TONE_MAPPING":"",t.toneMapping!==ce?RC.tonemapping_pars_fragment:"",t.toneMapping!==ce?ua("toneMapping",t.toneMapping):"",t.dithering?"#define DITHERING":"",t.opaque?"#define OPAQUE":"",RC.colorspace_pars_fragment,da("linearToOutputTexel",t.outputColorSpace),t.useDepthPacking?"#define DEPTH_PACKING "+t.depthPacking:"","\n"].filter(ha).join("\n")),C=Ga(C),C=ba(C,t),C=ma(C,t),o=Ga(o),o=ba(o,t),o=ma(o,t),C=va(C),o=va(o),t.isWebGL2&&!0!==t.isRawShaderMaterial&&(m="#version 300 es\n",h=["precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+h,b=["#define varying in",t.glslVersion===Dt?"":"layout(location = 0) out highp vec4 pc_fragColor;",t.glslVersion===Dt?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+b);const p=m+h+C,G=m+b+o,B=ra(n,n.VERTEX_SHADER,p),Z=ra(n,n.FRAGMENT_SHADER,G);if(n.attachShader(u,B),n.attachShader(u,Z),void 0!==t.index0AttributeName?n.bindAttribLocation(u,0,t.index0AttributeName):!0===t.morphTargets&&n.bindAttribLocation(u,0,"position"),n.linkProgram(u),e.debug.checkShaderErrors){const g=n.getProgramInfoLog(u).trim(),t=n.getShaderInfoLog(B).trim(),I=n.getShaderInfoLog(Z).trim();let i=!0,C=!0;if(!1===n.getProgramParameter(u,n.LINK_STATUS))if(i=!1,"function"==typeof e.debug.onShaderError)e.debug.onShaderError(n,u,B,Z);else{const e=ca(n,B,"vertex"),t=ca(n,Z,"fragment");console.error("THREE.WebGLProgram: Shader Error "+n.getError()+" - VALIDATE_STATUS "+n.getProgramParameter(u,n.VALIDATE_STATUS)+"\n\nProgram Info Log: "+g+"\n"+e+"\n"+t)}else""!==g?console.warn("THREE.WebGLProgram: Program Info Log:",g):""!==t&&""!==I||(C=!1);C&&(this.diagnostics={runnable:i,programLog:g,vertexShader:{log:t,prefix:h},fragmentShader:{log:I,prefix:b}})}let y,v;return n.deleteShader(B),n.deleteShader(Z),this.getUniforms=function(){return void 0===y&&(y=new la(n,u)),y},this.getAttributes=function(){return void 0===v&&(v=function(e,g){const t={},I=e.getProgramParameter(g,e.ACTIVE_ATTRIBUTES);for(let n=0;n<I;n++){const I=e.getActiveAttrib(g,n),i=I.name;let C=1;I.type===e.FLOAT_MAT2&&(C=2),I.type===e.FLOAT_MAT3&&(C=3),I.type===e.FLOAT_MAT4&&(C=4),t[i]={type:I.type,location:e.getAttribLocation(g,i),locationSize:C}}return t}(n,u)),v},this.destroy=function(){I.releaseStatesOfProgram(this),n.deleteProgram(u),this.program=void 0},this.type=t.shaderType,this.name=t.shaderName,this.id=Aa++,this.cacheKey=g,this.usedTimes=1,this.program=u,this.vertexShader=B,this.fragmentShader=Z,this}let Ra=0;class Va{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const g=e.vertexShader,t=e.fragmentShader,I=this._getShaderStage(g),n=this._getShaderStage(t),i=this._getShaderCacheForMaterial(e);return!1===i.has(I)&&(i.add(I),I.usedTimes++),!1===i.has(n)&&(i.add(n),n.usedTimes++),this}remove(e){const g=this.materialCache.get(e);for(const e of g)e.usedTimes--,0===e.usedTimes&&this.shaderCache.delete(e.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const g=this.materialCache;let t=g.get(e);return void 0===t&&(t=new Set,g.set(e,t)),t}_getShaderStage(e){const g=this.shaderCache;let t=g.get(e);return void 0===t&&(t=new Xa(e),g.set(e,t)),t}}class Xa{constructor(e){this.id=Ra++,this.code=e,this.usedTimes=0}}function Sa(e,g,t,I,n,i,C){const o=new Kn,a=new Va,s=[],l=n.isWebGL2,r=n.logarithmicDepthBuffer,A=n.vertexTextures;let c=n.precision;const d={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function u(e){return 0===e?"uv":`uv${e}`}return{getParameters:function(i,o,s,h,b){const m=h.fog,p=b.geometry,G=i.isMeshStandardMaterial?h.environment:null,B=(i.isMeshStandardMaterial?t:g).get(i.envMap||G),Z=B&&B.mapping===ve?B.image.height:null,y=d[i.type];null!==i.precision&&(c=n.getMaxPrecision(i.precision),c!==i.precision&&console.warn("THREE.WebGLProgram.getParameters:",i.precision,"not supported, using",c,"instead."));const v=p.morphAttributes.position||p.morphAttributes.normal||p.morphAttributes.color,W=void 0!==v?v.length:0;let f,w,R,V,X=0;if(void 0!==p.morphAttributes.position&&(X=1),void 0!==p.morphAttributes.normal&&(X=2),void 0!==p.morphAttributes.color&&(X=3),y){const e=XC[y];f=e.vertexShader,w=e.fragmentShader}else f=i.vertexShader,w=i.fragmentShader,a.update(i),R=a.getVertexShaderID(i),V=a.getFragmentShaderID(i);const K=e.getRenderTarget(),H=!0===b.isInstancedMesh,F=!!i.map,x=!!i.matcap,z=!!B,k=!!i.aoMap,M=!!i.lightMap,L=!!i.bumpMap,J=!!i.normalMap,E=!!i.displacementMap,T=!!i.emissiveMap,U=!!i.metalnessMap,Q=!!i.roughnessMap,D=i.anisotropy>0,O=i.clearcoat>0,j=i.iridescence>0,P=i.sheen>0,_=i.transmission>0,q=D&&!!i.anisotropyMap,$=O&&!!i.clearcoatMap,ee=O&&!!i.clearcoatNormalMap,ge=O&&!!i.clearcoatRoughnessMap,te=j&&!!i.iridescenceMap,Ie=j&&!!i.iridescenceThicknessMap,ne=P&&!!i.sheenColorMap,ie=P&&!!i.sheenRoughnessMap,Ce=!!i.specularMap,oe=!!i.specularColorMap,ae=!!i.specularIntensityMap,se=_&&!!i.transmissionMap,le=_&&!!i.thicknessMap,re=!!i.gradientMap,Ae=!!i.alphaMap,de=i.alphaTest>0,ue=!!i.alphaHash,he=!!i.extensions,be=!!p.attributes.uv1,me=!!p.attributes.uv2,pe=!!p.attributes.uv3;let Ge=ce;return i.toneMapped&&(null!==K&&!0!==K.isXRRenderTarget||(Ge=e.toneMapping)),{isWebGL2:l,shaderID:y,shaderType:i.type,shaderName:i.name,vertexShader:f,fragmentShader:w,defines:i.defines,customVertexShaderID:R,customFragmentShaderID:V,isRawShaderMaterial:!0===i.isRawShaderMaterial,glslVersion:i.glslVersion,precision:c,instancing:H,instancingColor:H&&null!==b.instanceColor,supportsVertexTextures:A,outputColorSpace:null===K?e.outputColorSpace:!0===K.isXRRenderTarget?K.texture.colorSpace:Ct,map:F,matcap:x,envMap:z,envMapMode:z&&B.mapping,envMapCubeUVHeight:Z,aoMap:k,lightMap:M,bumpMap:L,normalMap:J,displacementMap:A&&E,emissiveMap:T,normalMapObjectSpace:J&&i.normalMapType===It,normalMapTangentSpace:J&&i.normalMapType===tt,metalnessMap:U,roughnessMap:Q,anisotropy:D,anisotropyMap:q,clearcoat:O,clearcoatMap:$,clearcoatNormalMap:ee,clearcoatRoughnessMap:ge,iridescence:j,iridescenceMap:te,iridescenceThicknessMap:Ie,sheen:P,sheenColorMap:ne,sheenRoughnessMap:ie,specularMap:Ce,specularColorMap:oe,specularIntensityMap:ae,transmission:_,transmissionMap:se,thicknessMap:le,gradientMap:re,opaque:!1===i.transparent&&i.blending===N,alphaMap:Ae,alphaTest:de,alphaHash:ue,combine:i.combine,mapUv:F&&u(i.map.channel),aoMapUv:k&&u(i.aoMap.channel),lightMapUv:M&&u(i.lightMap.channel),bumpMapUv:L&&u(i.bumpMap.channel),normalMapUv:J&&u(i.normalMap.channel),displacementMapUv:E&&u(i.displacementMap.channel),emissiveMapUv:T&&u(i.emissiveMap.channel),metalnessMapUv:U&&u(i.metalnessMap.channel),roughnessMapUv:Q&&u(i.roughnessMap.channel),anisotropyMapUv:q&&u(i.anisotropyMap.channel),clearcoatMapUv:$&&u(i.clearcoatMap.channel),clearcoatNormalMapUv:ee&&u(i.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:ge&&u(i.clearcoatRoughnessMap.channel),iridescenceMapUv:te&&u(i.iridescenceMap.channel),iridescenceThicknessMapUv:Ie&&u(i.iridescenceThicknessMap.channel),sheenColorMapUv:ne&&u(i.sheenColorMap.channel),sheenRoughnessMapUv:ie&&u(i.sheenRoughnessMap.channel),specularMapUv:Ce&&u(i.specularMap.channel),specularColorMapUv:oe&&u(i.specularColorMap.channel),specularIntensityMapUv:ae&&u(i.specularIntensityMap.channel),transmissionMapUv:se&&u(i.transmissionMap.channel),thicknessMapUv:le&&u(i.thicknessMap.channel),alphaMapUv:Ae&&u(i.alphaMap.channel),vertexTangents:!!p.attributes.tangent&&(J||D),vertexColors:i.vertexColors,vertexAlphas:!0===i.vertexColors&&!!p.attributes.color&&4===p.attributes.color.itemSize,vertexUv1s:be,vertexUv2s:me,vertexUv3s:pe,pointsUvs:!0===b.isPoints&&!!p.attributes.uv&&(F||Ae),fog:!!m,useFog:!0===i.fog,fogExp2:m&&m.isFogExp2,flatShading:!0===i.flatShading,sizeAttenuation:!0===i.sizeAttenuation,logarithmicDepthBuffer:r,skinning:!0===b.isSkinnedMesh,morphTargets:void 0!==p.morphAttributes.position,morphNormals:void 0!==p.morphAttributes.normal,morphColors:void 0!==p.morphAttributes.color,morphTargetsCount:W,morphTextureStride:X,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numSpotLightMaps:o.spotLightMap.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numDirLightShadows:o.directionalShadowMap.length,numPointLightShadows:o.pointShadowMap.length,numSpotLightShadows:o.spotShadowMap.length,numSpotLightShadowsWithMaps:o.numSpotLightShadowsWithMaps,numLightProbes:o.numLightProbes,numClippingPlanes:C.numPlanes,numClipIntersection:C.numIntersection,dithering:i.dithering,shadowMapEnabled:e.shadowMap.enabled&&s.length>0,shadowMapType:e.shadowMap.type,toneMapping:Ge,useLegacyLights:e._useLegacyLights,decodeVideoTexture:F&&!0===i.map.isVideoTexture&&fI.getTransfer(i.map.colorSpace)===lt,premultipliedAlpha:i.premultipliedAlpha,doubleSided:i.side===Y,flipSided:i.side===S,useDepthPacking:i.depthPacking>=0,depthPacking:i.depthPacking||0,index0AttributeName:i.index0AttributeName,extensionDerivatives:he&&!0===i.extensions.derivatives,extensionFragDepth:he&&!0===i.extensions.fragDepth,extensionDrawBuffers:he&&!0===i.extensions.drawBuffers,extensionShaderTextureLOD:he&&!0===i.extensions.shaderTextureLOD,rendererExtensionFragDepth:l||I.has("EXT_frag_depth"),rendererExtensionDrawBuffers:l||I.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:l||I.has("EXT_shader_texture_lod"),customProgramCacheKey:i.customProgramCacheKey()}},getProgramCacheKey:function(g){const t=[];if(g.shaderID?t.push(g.shaderID):(t.push(g.customVertexShaderID),t.push(g.customFragmentShaderID)),void 0!==g.defines)for(const e in g.defines)t.push(e),t.push(g.defines[e]);return!1===g.isRawShaderMaterial&&(function(e,g){e.push(g.precision),e.push(g.outputColorSpace),e.push(g.envMapMode),e.push(g.envMapCubeUVHeight),e.push(g.mapUv),e.push(g.alphaMapUv),e.push(g.lightMapUv),e.push(g.aoMapUv),e.push(g.bumpMapUv),e.push(g.normalMapUv),e.push(g.displacementMapUv),e.push(g.emissiveMapUv),e.push(g.metalnessMapUv),e.push(g.roughnessMapUv),e.push(g.anisotropyMapUv),e.push(g.clearcoatMapUv),e.push(g.clearcoatNormalMapUv),e.push(g.clearcoatRoughnessMapUv),e.push(g.iridescenceMapUv),e.push(g.iridescenceThicknessMapUv),e.push(g.sheenColorMapUv),e.push(g.sheenRoughnessMapUv),e.push(g.specularMapUv),e.push(g.specularColorMapUv),e.push(g.specularIntensityMapUv),e.push(g.transmissionMapUv),e.push(g.thicknessMapUv),e.push(g.combine),e.push(g.fogExp2),e.push(g.sizeAttenuation),e.push(g.morphTargetsCount),e.push(g.morphAttributeCount),e.push(g.numDirLights),e.push(g.numPointLights),e.push(g.numSpotLights),e.push(g.numSpotLightMaps),e.push(g.numHemiLights),e.push(g.numRectAreaLights),e.push(g.numDirLightShadows),e.push(g.numPointLightShadows),e.push(g.numSpotLightShadows),e.push(g.numSpotLightShadowsWithMaps),e.push(g.numLightProbes),e.push(g.shadowMapType),e.push(g.toneMapping),e.push(g.numClippingPlanes),e.push(g.numClipIntersection),e.push(g.depthPacking)}(t,g),function(e,g){o.disableAll(),g.isWebGL2&&o.enable(0),g.supportsVertexTextures&&o.enable(1),g.instancing&&o.enable(2),g.instancingColor&&o.enable(3),g.matcap&&o.enable(4),g.envMap&&o.enable(5),g.normalMapObjectSpace&&o.enable(6),g.normalMapTangentSpace&&o.enable(7),g.clearcoat&&o.enable(8),g.iridescence&&o.enable(9),g.alphaTest&&o.enable(10),g.vertexColors&&o.enable(11),g.vertexAlphas&&o.enable(12),g.vertexUv1s&&o.enable(13),g.vertexUv2s&&o.enable(14),g.vertexUv3s&&o.enable(15),g.vertexTangents&&o.enable(16),g.anisotropy&&o.enable(17),e.push(o.mask),o.disableAll(),g.fog&&o.enable(0),g.useFog&&o.enable(1),g.flatShading&&o.enable(2),g.logarithmicDepthBuffer&&o.enable(3),g.skinning&&o.enable(4),g.morphTargets&&o.enable(5),g.morphNormals&&o.enable(6),g.morphColors&&o.enable(7),g.premultipliedAlpha&&o.enable(8),g.shadowMapEnabled&&o.enable(9),g.useLegacyLights&&o.enable(10),g.doubleSided&&o.enable(11),g.flipSided&&o.enable(12),g.useDepthPacking&&o.enable(13),g.dithering&&o.enable(14),g.transmission&&o.enable(15),g.sheen&&o.enable(16),g.opaque&&o.enable(17),g.pointsUvs&&o.enable(18),g.decodeVideoTexture&&o.enable(19),e.push(o.mask)}(t,g),t.push(e.outputColorSpace)),t.push(g.customProgramCacheKey),t.join()},getUniforms:function(e){const g=d[e.type];let t;if(g){const e=XC[g];t=lC.clone(e.uniforms)}else t=e.uniforms;return t},acquireProgram:function(g,t){let I;for(let e=0,g=s.length;e<g;e++){const g=s[e];if(g.cacheKey===t){I=g,++I.usedTimes;break}}return void 0===I&&(I=new wa(e,t,g,i),s.push(I)),I},releaseProgram:function(e){if(0==--e.usedTimes){const g=s.indexOf(e);s[g]=s[s.length-1],s.pop(),e.destroy()}},releaseShaderCache:function(e){a.remove(e)},programs:s,dispose:function(){a.dispose()}}}function Ya(){let e=new WeakMap;return{get:function(g){let t=e.get(g);return void 0===t&&(t={},e.set(g,t)),t},remove:function(g){e.delete(g)},update:function(g,t,I){e.get(g)[t]=I},dispose:function(){e=new WeakMap}}}function Ka(e,g){return e.groupOrder!==g.groupOrder?e.groupOrder-g.groupOrder:e.renderOrder!==g.renderOrder?e.renderOrder-g.renderOrder:e.material.id!==g.material.id?e.material.id-g.material.id:e.z!==g.z?e.z-g.z:e.id-g.id}function Ha(e,g){return e.groupOrder!==g.groupOrder?e.groupOrder-g.groupOrder:e.renderOrder!==g.renderOrder?e.renderOrder-g.renderOrder:e.z!==g.z?g.z-e.z:e.id-g.id}function Na(){const e=[];let g=0;const t=[],I=[],n=[];function i(t,I,n,i,C,o){let a=e[g];return void 0===a?(a={id:t.id,object:t,geometry:I,material:n,groupOrder:i,renderOrder:t.renderOrder,z:C,group:o},e[g]=a):(a.id=t.id,a.object=t,a.geometry=I,a.material=n,a.groupOrder=i,a.renderOrder=t.renderOrder,a.z=C,a.group=o),g++,a}return{opaque:t,transmissive:I,transparent:n,init:function(){g=0,t.length=0,I.length=0,n.length=0},push:function(e,g,C,o,a,s){const l=i(e,g,C,o,a,s);C.transmission>0?I.push(l):!0===C.transparent?n.push(l):t.push(l)},unshift:function(e,g,C,o,a,s){const l=i(e,g,C,o,a,s);C.transmission>0?I.unshift(l):!0===C.transparent?n.unshift(l):t.unshift(l)},finish:function(){for(let t=g,I=e.length;t<I;t++){const g=e[t];if(null===g.id)break;g.id=null,g.object=null,g.geometry=null,g.material=null,g.group=null}},sort:function(e,g){t.length>1&&t.sort(e||Ka),I.length>1&&I.sort(g||Ha),n.length>1&&n.sort(g||Ha)}}}function Fa(){let e=new WeakMap;return{get:function(g,t){const I=e.get(g);let n;return void 0===I?(n=new Na,e.set(g,[n])):t>=I.length?(n=new Na,I.push(n)):n=I[t],n},dispose:function(){e=new WeakMap}}}function xa(){const e={};return{get:function(g){if(void 0!==e[g.id])return e[g.id];let t;switch(g.type){case"DirectionalLight":t={direction:new UI,color:new Ai};break;case"SpotLight":t={position:new UI,direction:new UI,color:new Ai,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":t={position:new UI,color:new Ai,distance:0,decay:0};break;case"HemisphereLight":t={direction:new UI,skyColor:new Ai,groundColor:new Ai};break;case"RectAreaLight":t={color:new Ai,position:new UI,halfWidth:new UI,halfHeight:new UI}}return e[g.id]=t,t}}}let za=0;function ka(e,g){return(g.castShadow?2:0)-(e.castShadow?2:0)+(g.map?1:0)-(e.map?1:0)}function Ma(e,g){const t=new xa,I=function(){const e={};return{get:function(g){if(void 0!==e[g.id])return e[g.id];let t;switch(g.type){case"DirectionalLight":case"SpotLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new AI};break;case"PointLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new AI,shadowCameraNear:1,shadowCameraFar:1e3}}return e[g.id]=t,t}}}(),n={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let e=0;e<9;e++)n.probe.push(new UI);const i=new UI,C=new Zn,o=new Zn;return{setup:function(i,C){let o=0,a=0,s=0;for(let e=0;e<9;e++)n.probe[e].set(0,0,0);let l=0,r=0,A=0,c=0,d=0,u=0,h=0,b=0,m=0,p=0,G=0;i.sort(ka);const B=!0===C?Math.PI:1;for(let e=0,g=i.length;e<g;e++){const g=i[e],C=g.color,Z=g.intensity,y=g.distance,v=g.shadow&&g.shadow.map?g.shadow.map.texture:null;if(g.isAmbientLight)o+=C.r*Z*B,a+=C.g*Z*B,s+=C.b*Z*B;else if(g.isLightProbe){for(let e=0;e<9;e++)n.probe[e].addScaledVector(g.sh.coefficients[e],Z);G++}else if(g.isDirectionalLight){const e=t.get(g);if(e.color.copy(g.color).multiplyScalar(g.intensity*B),g.castShadow){const e=g.shadow,t=I.get(g);t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,n.directionalShadow[l]=t,n.directionalShadowMap[l]=v,n.directionalShadowMatrix[l]=g.shadow.matrix,u++}n.directional[l]=e,l++}else if(g.isSpotLight){const e=t.get(g);e.position.setFromMatrixPosition(g.matrixWorld),e.color.copy(C).multiplyScalar(Z*B),e.distance=y,e.coneCos=Math.cos(g.angle),e.penumbraCos=Math.cos(g.angle*(1-g.penumbra)),e.decay=g.decay,n.spot[A]=e;const i=g.shadow;if(g.map&&(n.spotLightMap[m]=g.map,m++,i.updateMatrices(g),g.castShadow&&p++),n.spotLightMatrix[A]=i.matrix,g.castShadow){const e=I.get(g);e.shadowBias=i.bias,e.shadowNormalBias=i.normalBias,e.shadowRadius=i.radius,e.shadowMapSize=i.mapSize,n.spotShadow[A]=e,n.spotShadowMap[A]=v,b++}A++}else if(g.isRectAreaLight){const e=t.get(g);e.color.copy(C).multiplyScalar(Z),e.halfWidth.set(.5*g.width,0,0),e.halfHeight.set(0,.5*g.height,0),n.rectArea[c]=e,c++}else if(g.isPointLight){const e=t.get(g);if(e.color.copy(g.color).multiplyScalar(g.intensity*B),e.distance=g.distance,e.decay=g.decay,g.castShadow){const e=g.shadow,t=I.get(g);t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,t.shadowCameraNear=e.camera.near,t.shadowCameraFar=e.camera.far,n.pointShadow[r]=t,n.pointShadowMap[r]=v,n.pointShadowMatrix[r]=g.shadow.matrix,h++}n.point[r]=e,r++}else if(g.isHemisphereLight){const e=t.get(g);e.skyColor.copy(g.color).multiplyScalar(Z*B),e.groundColor.copy(g.groundColor).multiplyScalar(Z*B),n.hemi[d]=e,d++}}c>0&&(g.isWebGL2||!0===e.has("OES_texture_float_linear")?(n.rectAreaLTC1=VC.LTC_FLOAT_1,n.rectAreaLTC2=VC.LTC_FLOAT_2):!0===e.has("OES_texture_half_float_linear")?(n.rectAreaLTC1=VC.LTC_HALF_1,n.rectAreaLTC2=VC.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),n.ambient[0]=o,n.ambient[1]=a,n.ambient[2]=s;const Z=n.hash;Z.directionalLength===l&&Z.pointLength===r&&Z.spotLength===A&&Z.rectAreaLength===c&&Z.hemiLength===d&&Z.numDirectionalShadows===u&&Z.numPointShadows===h&&Z.numSpotShadows===b&&Z.numSpotMaps===m&&Z.numLightProbes===G||(n.directional.length=l,n.spot.length=A,n.rectArea.length=c,n.point.length=r,n.hemi.length=d,n.directionalShadow.length=u,n.directionalShadowMap.length=u,n.pointShadow.length=h,n.pointShadowMap.length=h,n.spotShadow.length=b,n.spotShadowMap.length=b,n.directionalShadowMatrix.length=u,n.pointShadowMatrix.length=h,n.spotLightMatrix.length=b+m-p,n.spotLightMap.length=m,n.numSpotLightShadowsWithMaps=p,n.numLightProbes=G,Z.directionalLength=l,Z.pointLength=r,Z.spotLength=A,Z.rectAreaLength=c,Z.hemiLength=d,Z.numDirectionalShadows=u,Z.numPointShadows=h,Z.numSpotShadows=b,Z.numSpotMaps=m,Z.numLightProbes=G,n.version=za++)},setupView:function(e,g){let t=0,I=0,a=0,s=0,l=0;const r=g.matrixWorldInverse;for(let g=0,A=e.length;g<A;g++){const A=e[g];if(A.isDirectionalLight){const e=n.directional[t];e.direction.setFromMatrixPosition(A.matrixWorld),i.setFromMatrixPosition(A.target.matrixWorld),e.direction.sub(i),e.direction.transformDirection(r),t++}else if(A.isSpotLight){const e=n.spot[a];e.position.setFromMatrixPosition(A.matrixWorld),e.position.applyMatrix4(r),e.direction.setFromMatrixPosition(A.matrixWorld),i.setFromMatrixPosition(A.target.matrixWorld),e.direction.sub(i),e.direction.transformDirection(r),a++}else if(A.isRectAreaLight){const e=n.rectArea[s];e.position.setFromMatrixPosition(A.matrixWorld),e.position.applyMatrix4(r),o.identity(),C.copy(A.matrixWorld),C.premultiply(r),o.extractRotation(C),e.halfWidth.set(.5*A.width,0,0),e.halfHeight.set(0,.5*A.height,0),e.halfWidth.applyMatrix4(o),e.halfHeight.applyMatrix4(o),s++}else if(A.isPointLight){const e=n.point[I];e.position.setFromMatrixPosition(A.matrixWorld),e.position.applyMatrix4(r),I++}else if(A.isHemisphereLight){const e=n.hemi[l];e.direction.setFromMatrixPosition(A.matrixWorld),e.direction.transformDirection(r),l++}}},state:n}}function La(e,g){const t=new Ma(e,g),I=[],n=[];return{init:function(){I.length=0,n.length=0},state:{lightsArray:I,shadowsArray:n,lights:t},setupLights:function(e){t.setup(I,e)},setupLightsView:function(e){t.setupView(I,e)},pushLight:function(e){I.push(e)},pushShadow:function(e){n.push(e)}}}function Ja(e,g){let t=new WeakMap;return{get:function(I,n=0){const i=t.get(I);let C;return void 0===i?(C=new La(e,g),t.set(I,[C])):n>=i.length?(C=new La(e,g),i.push(C)):C=i[n],C},dispose:function(){t=new WeakMap}}}class Ea extends oi{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=et,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class Ta extends oi{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}function Ua(e,g,t){let I=new vC;const n=new AI,i=new AI,C=new FI,o=new Ea({depthPacking:gt}),a=new Ta,s={},l=t.maxTextureSize,r={[X]:S,[S]:X,[Y]:Y},A=new rC({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new AI},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),c=A.clone();c.defines.HORIZONTAL_PASS=1;const d=new Mi;d.setAttribute("position",new Zi(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const u=new nC(d,A),h=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=w;let b=this.type;function m(t,I){const i=g.update(u);A.defines.VSM_SAMPLES!==t.blurSamples&&(A.defines.VSM_SAMPLES=t.blurSamples,c.defines.VSM_SAMPLES=t.blurSamples,A.needsUpdate=!0,c.needsUpdate=!0),null===t.mapPass&&(t.mapPass=new zI(n.x,n.y)),A.uniforms.shadow_pass.value=t.map.texture,A.uniforms.resolution.value=t.mapSize,A.uniforms.radius.value=t.radius,e.setRenderTarget(t.mapPass),e.clear(),e.renderBufferDirect(I,null,i,A,u,null),c.uniforms.shadow_pass.value=t.mapPass.texture,c.uniforms.resolution.value=t.mapSize,c.uniforms.radius.value=t.radius,e.setRenderTarget(t.map),e.clear(),e.renderBufferDirect(I,null,i,c,u,null)}function p(g,t,I,n){let i=null;const C=!0===I.isPointLight?g.customDistanceMaterial:g.customDepthMaterial;if(void 0!==C)i=C;else if(i=!0===I.isPointLight?a:o,e.localClippingEnabled&&!0===t.clipShadows&&Array.isArray(t.clippingPlanes)&&0!==t.clippingPlanes.length||t.displacementMap&&0!==t.displacementScale||t.alphaMap&&t.alphaTest>0||t.map&&t.alphaTest>0){const e=i.uuid,g=t.uuid;let I=s[e];void 0===I&&(I={},s[e]=I);let n=I[g];void 0===n&&(n=i.clone(),I[g]=n),i=n}return i.visible=t.visible,i.wireframe=t.wireframe,i.side=n===V?null!==t.shadowSide?t.shadowSide:t.side:null!==t.shadowSide?t.shadowSide:r[t.side],i.alphaMap=t.alphaMap,i.alphaTest=t.alphaTest,i.map=t.map,i.clipShadows=t.clipShadows,i.clippingPlanes=t.clippingPlanes,i.clipIntersection=t.clipIntersection,i.displacementMap=t.displacementMap,i.displacementScale=t.displacementScale,i.displacementBias=t.displacementBias,i.wireframeLinewidth=t.wireframeLinewidth,i.linewidth=t.linewidth,!0===I.isPointLight&&!0===i.isMeshDistanceMaterial&&(e.properties.get(i).light=I),i}function G(t,n,i,C,o){if(!1===t.visible)return;if(t.layers.test(n.layers)&&(t.isMesh||t.isLine||t.isPoints)&&(t.castShadow||t.receiveShadow&&o===V)&&(!t.frustumCulled||I.intersectsObject(t))){t.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,t.matrixWorld);const I=g.update(t),n=t.material;if(Array.isArray(n)){const g=I.groups;for(let a=0,s=g.length;a<s;a++){const s=g[a],l=n[s.materialIndex];if(l&&l.visible){const g=p(t,l,C,o);e.renderBufferDirect(i,null,I,g,t,s)}}}else if(n.visible){const g=p(t,n,C,o);e.renderBufferDirect(i,null,I,g,t,null)}}const a=t.children;for(let e=0,g=a.length;e<g;e++)G(a[e],n,i,C,o)}this.render=function(g,t,o){if(!1===h.enabled)return;if(!1===h.autoUpdate&&!1===h.needsUpdate)return;if(0===g.length)return;const a=e.getRenderTarget(),s=e.getActiveCubeFace(),r=e.getActiveMipmapLevel(),A=e.state;A.setBlending(H),A.buffers.color.setClear(1,1,1,1),A.buffers.depth.setTest(!0),A.setScissorTest(!1);const c=b!==V&&this.type===V,d=b===V&&this.type!==V;for(let a=0,s=g.length;a<s;a++){const s=g[a],r=s.shadow;if(void 0===r){console.warn("THREE.WebGLShadowMap:",s,"has no shadow.");continue}if(!1===r.autoUpdate&&!1===r.needsUpdate)continue;n.copy(r.mapSize);const u=r.getFrameExtents();if(n.multiply(u),i.copy(r.mapSize),(n.x>l||n.y>l)&&(n.x>l&&(i.x=Math.floor(l/u.x),n.x=i.x*u.x,r.mapSize.x=i.x),n.y>l&&(i.y=Math.floor(l/u.y),n.y=i.y*u.y,r.mapSize.y=i.y)),null===r.map||!0===c||!0===d){const e=this.type!==V?{minFilter:Re,magFilter:Re}:{};null!==r.map&&r.map.dispose(),r.map=new zI(n.x,n.y,e),r.map.texture.name=s.name+".shadowMap",r.camera.updateProjectionMatrix()}e.setRenderTarget(r.map),e.clear();const h=r.getViewportCount();for(let e=0;e<h;e++){const g=r.getViewport(e);C.set(i.x*g.x,i.y*g.y,i.x*g.z,i.y*g.w),A.viewport(C),r.updateMatrices(s,e),I=r.getFrustum(),G(t,o,r.camera,s,this.type)}!0!==r.isPointLightShadow&&this.type===V&&m(r,o),r.needsUpdate=!1}b=this.type,h.needsUpdate=!1,e.setRenderTarget(a,s,r)}}function Qa(e,g,t){const I=t.isWebGL2,n=new function(){let g=!1;const t=new FI;let I=null;const n=new FI(0,0,0,0);return{setMask:function(t){I===t||g||(e.colorMask(t,t,t,t),I=t)},setLocked:function(e){g=e},setClear:function(g,I,i,C,o){!0===o&&(g*=C,I*=C,i*=C),t.set(g,I,i,C),!1===n.equals(t)&&(e.clearColor(g,I,i,C),n.copy(t))},reset:function(){g=!1,I=null,n.set(-1,0,0,0)}}},i=new function(){let g=!1,t=null,I=null,n=null;return{setTest:function(g){g?Be(e.DEPTH_TEST):Ze(e.DEPTH_TEST)},setMask:function(I){t===I||g||(e.depthMask(I),t=I)},setFunc:function(g){if(I!==g){switch(g){case te:e.depthFunc(e.NEVER);break;case Ie:e.depthFunc(e.ALWAYS);break;case ne:e.depthFunc(e.LESS);break;case ie:e.depthFunc(e.LEQUAL);break;case Ce:e.depthFunc(e.EQUAL);break;case oe:e.depthFunc(e.GEQUAL);break;case ae:e.depthFunc(e.GREATER);break;case se:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}I=g}},setLocked:function(e){g=e},setClear:function(g){n!==g&&(e.clearDepth(g),n=g)},reset:function(){g=!1,t=null,I=null,n=null}}},C=new function(){let g=!1,t=null,I=null,n=null,i=null,C=null,o=null,a=null,s=null;return{setTest:function(t){g||(t?Be(e.STENCIL_TEST):Ze(e.STENCIL_TEST))},setMask:function(I){t===I||g||(e.stencilMask(I),t=I)},setFunc:function(g,t,C){I===g&&n===t&&i===C||(e.stencilFunc(g,t,C),I=g,n=t,i=C)},setOp:function(g,t,I){C===g&&o===t&&a===I||(e.stencilOp(g,t,I),C=g,o=t,a=I)},setLocked:function(e){g=e},setClear:function(g){s!==g&&(e.clearStencil(g),s=g)},reset:function(){g=!1,t=null,I=null,n=null,i=null,C=null,o=null,a=null,s=null}}},o=new WeakMap,a=new WeakMap;let s={},l={},r=new WeakMap,A=[],c=null,d=!1,u=null,h=null,b=null,m=null,p=null,G=null,B=null,W=!1,f=null,w=null,R=null,V=null,X=null;const K=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let le=!1,re=0;const Ae=e.getParameter(e.VERSION);-1!==Ae.indexOf("WebGL")?(re=parseFloat(/^WebGL (\d)/.exec(Ae)[1]),le=re>=1):-1!==Ae.indexOf("OpenGL ES")&&(re=parseFloat(/^OpenGL ES (\d)/.exec(Ae)[1]),le=re>=2);let ce=null,de={};const ue=e.getParameter(e.SCISSOR_BOX),he=e.getParameter(e.VIEWPORT),be=(new FI).fromArray(ue),me=(new FI).fromArray(he);function pe(g,t,n,i){const C=new Uint8Array(4),o=e.createTexture();e.bindTexture(g,o),e.texParameteri(g,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(g,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let o=0;o<n;o++)!I||g!==e.TEXTURE_3D&&g!==e.TEXTURE_2D_ARRAY?e.texImage2D(t+o,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,C):e.texImage3D(t,0,e.RGBA,1,1,i,0,e.RGBA,e.UNSIGNED_BYTE,C);return o}const Ge={};function Be(g){!0!==s[g]&&(e.enable(g),s[g]=!0)}function Ze(g){!1!==s[g]&&(e.disable(g),s[g]=!1)}Ge[e.TEXTURE_2D]=pe(e.TEXTURE_2D,e.TEXTURE_2D,1),Ge[e.TEXTURE_CUBE_MAP]=pe(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),I&&(Ge[e.TEXTURE_2D_ARRAY]=pe(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),Ge[e.TEXTURE_3D]=pe(e.TEXTURE_3D,e.TEXTURE_3D,1,1)),n.setClear(0,0,0,1),i.setClear(1),C.setClear(0),Be(e.DEPTH_TEST),i.setFunc(ie),fe(!1),we(y),Be(e.CULL_FACE),We(H);const ye={[M]:e.FUNC_ADD,[L]:e.FUNC_SUBTRACT,[J]:e.FUNC_REVERSE_SUBTRACT};if(I)ye[E]=e.MIN,ye[T]=e.MAX;else{const e=g.get("EXT_blend_minmax");null!==e&&(ye[E]=e.MIN_EXT,ye[T]=e.MAX_EXT)}const ve={[U]:e.ZERO,[Q]:e.ONE,[D]:e.SRC_COLOR,[j]:e.SRC_ALPHA,[ge]:e.SRC_ALPHA_SATURATE,[$]:e.DST_COLOR,[_]:e.DST_ALPHA,[O]:e.ONE_MINUS_SRC_COLOR,[P]:e.ONE_MINUS_SRC_ALPHA,[ee]:e.ONE_MINUS_DST_COLOR,[q]:e.ONE_MINUS_DST_ALPHA};function We(g,t,I,n,i,C,o,a){if(g!==H){if(!1===d&&(Be(e.BLEND),d=!0),g===k)i=i||t,C=C||I,o=o||n,t===h&&i===p||(e.blendEquationSeparate(ye[t],ye[i]),h=t,p=i),I===b&&n===m&&C===G&&o===B||(e.blendFuncSeparate(ve[I],ve[n],ve[C],ve[o]),b=I,m=n,G=C,B=o),u=g,W=!1;else if(g!==u||a!==W){if(h===M&&p===M||(e.blendEquation(e.FUNC_ADD),h=M,p=M),a)switch(g){case N:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case F:e.blendFunc(e.ONE,e.ONE);break;case x:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case z:e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",g)}else switch(g){case N:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case F:e.blendFunc(e.SRC_ALPHA,e.ONE);break;case x:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case z:e.blendFunc(e.ZERO,e.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",g)}b=null,m=null,G=null,B=null,u=g,W=a}}else!0===d&&(Ze(e.BLEND),d=!1)}function fe(g){f!==g&&(g?e.frontFace(e.CW):e.frontFace(e.CCW),f=g)}function we(g){g!==Z?(Be(e.CULL_FACE),g!==w&&(g===y?e.cullFace(e.BACK):g===v?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):Ze(e.CULL_FACE),w=g}function Re(g,t,I){g?(Be(e.POLYGON_OFFSET_FILL),V===t&&X===I||(e.polygonOffset(t,I),V=t,X=I)):Ze(e.POLYGON_OFFSET_FILL)}return{buffers:{color:n,depth:i,stencil:C},enable:Be,disable:Ze,bindFramebuffer:function(g,t){return l[g]!==t&&(e.bindFramebuffer(g,t),l[g]=t,I&&(g===e.DRAW_FRAMEBUFFER&&(l[e.FRAMEBUFFER]=t),g===e.FRAMEBUFFER&&(l[e.DRAW_FRAMEBUFFER]=t)),!0)},drawBuffers:function(I,n){let i=A,C=!1;if(I)if(i=r.get(n),void 0===i&&(i=[],r.set(n,i)),I.isWebGLMultipleRenderTargets){const g=I.texture;if(i.length!==g.length||i[0]!==e.COLOR_ATTACHMENT0){for(let t=0,I=g.length;t<I;t++)i[t]=e.COLOR_ATTACHMENT0+t;i.length=g.length,C=!0}}else i[0]!==e.COLOR_ATTACHMENT0&&(i[0]=e.COLOR_ATTACHMENT0,C=!0);else i[0]!==e.BACK&&(i[0]=e.BACK,C=!0);C&&(t.isWebGL2?e.drawBuffers(i):g.get("WEBGL_draw_buffers").drawBuffersWEBGL(i))},useProgram:function(g){return c!==g&&(e.useProgram(g),c=g,!0)},setBlending:We,setMaterial:function(g,t){g.side===Y?Ze(e.CULL_FACE):Be(e.CULL_FACE);let I=g.side===S;t&&(I=!I),fe(I),g.blending===N&&!1===g.transparent?We(H):We(g.blending,g.blendEquation,g.blendSrc,g.blendDst,g.blendEquationAlpha,g.blendSrcAlpha,g.blendDstAlpha,g.premultipliedAlpha),i.setFunc(g.depthFunc),i.setTest(g.depthTest),i.setMask(g.depthWrite),n.setMask(g.colorWrite);const o=g.stencilWrite;C.setTest(o),o&&(C.setMask(g.stencilWriteMask),C.setFunc(g.stencilFunc,g.stencilRef,g.stencilFuncMask),C.setOp(g.stencilFail,g.stencilZFail,g.stencilZPass)),Re(g.polygonOffset,g.polygonOffsetFactor,g.polygonOffsetUnits),!0===g.alphaToCoverage?Be(e.SAMPLE_ALPHA_TO_COVERAGE):Ze(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:fe,setCullFace:we,setLineWidth:function(g){g!==R&&(le&&e.lineWidth(g),R=g)},setPolygonOffset:Re,setScissorTest:function(g){g?Be(e.SCISSOR_TEST):Ze(e.SCISSOR_TEST)},activeTexture:function(g){void 0===g&&(g=e.TEXTURE0+K-1),ce!==g&&(e.activeTexture(g),ce=g)},bindTexture:function(g,t,I){void 0===I&&(I=null===ce?e.TEXTURE0+K-1:ce);let n=de[I];void 0===n&&(n={type:void 0,texture:void 0},de[I]=n),n.type===g&&n.texture===t||(ce!==I&&(e.activeTexture(I),ce=I),e.bindTexture(g,t||Ge[g]),n.type=g,n.texture=t)},unbindTexture:function(){const g=de[ce];void 0!==g&&void 0!==g.type&&(e.bindTexture(g.type,null),g.type=void 0,g.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexImage3D:function(){try{e.compressedTexImage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage3D:function(){try{e.texImage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},updateUBOMapping:function(g,t){let I=a.get(t);void 0===I&&(I=new WeakMap,a.set(t,I));let n=I.get(g);void 0===n&&(n=e.getUniformBlockIndex(t,g.name),I.set(g,n))},uniformBlockBinding:function(g,t){const I=a.get(t).get(g);o.get(t)!==I&&(e.uniformBlockBinding(t,I,g.__bindingPointIndex),o.set(t,I))},texStorage2D:function(){try{e.texStorage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texStorage3D:function(){try{e.texStorage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage2D:function(){try{e.texSubImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage3D:function(){try{e.texSubImage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function(g){!1===be.equals(g)&&(e.scissor(g.x,g.y,g.z,g.w),be.copy(g))},viewport:function(g){!1===me.equals(g)&&(e.viewport(g.x,g.y,g.z,g.w),me.copy(g))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),!0===I&&(e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null)),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),s={},ce=null,de={},l={},r=new WeakMap,A=[],c=null,d=!1,u=null,h=null,b=null,m=null,p=null,G=null,B=null,W=!1,f=null,w=null,R=null,V=null,X=null,be.set(0,0,e.canvas.width,e.canvas.height),me.set(0,0,e.canvas.width,e.canvas.height),n.reset(),i.reset(),C.reset()}}}function Da(e,g,t,I,n,i,C){const o=n.isWebGL2,a=n.maxTextures,s=n.maxCubemapSize,l=n.maxTextureSize,r=n.maxSamples,A=g.has("WEBGL_multisampled_render_to_texture")?g.get("WEBGL_multisampled_render_to_texture"):null,c="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),d=new WeakMap;let u;const h=new WeakMap;let b=!1;try{b="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function m(e,g){return b?new OffscreenCanvas(e,g):mI("canvas")}function p(e,g,t,I){let n=1;if((e.width>I||e.height>I)&&(n=I/Math.max(e.width,e.height)),n<1||!0===g){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const I=g?aI:Math.floor,i=I(n*e.width),C=I(n*e.height);void 0===u&&(u=m(i,C));const o=t?m(i,C):u;return o.width=i,o.height=C,o.getContext("2d").drawImage(e,0,0,i,C),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+e.width+"x"+e.height+") to ("+i+"x"+C+")."),o}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+e.width+"x"+e.height+")."),e}return e}function G(e){return CI(e.width)&&CI(e.height)}function B(e,g){return e.generateMipmaps&&g&&e.minFilter!==Re&&e.minFilter!==Ke}function Z(g){e.generateMipmap(g)}function y(t,I,n,i,C=!1){if(!1===o)return I;if(null!==t){if(void 0!==e[t])return e[t];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+t+"'")}let a=I;if(I===e.RED&&(n===e.FLOAT&&(a=e.R32F),n===e.HALF_FLOAT&&(a=e.R16F),n===e.UNSIGNED_BYTE&&(a=e.R8)),I===e.RED_INTEGER&&(n===e.UNSIGNED_BYTE&&(a=e.R8UI),n===e.UNSIGNED_SHORT&&(a=e.R16UI),n===e.UNSIGNED_INT&&(a=e.R32UI),n===e.BYTE&&(a=e.R8I),n===e.SHORT&&(a=e.R16I),n===e.INT&&(a=e.R32I)),I===e.RG&&(n===e.FLOAT&&(a=e.RG32F),n===e.HALF_FLOAT&&(a=e.RG16F),n===e.UNSIGNED_BYTE&&(a=e.RG8)),I===e.RGBA){const g=C?st:fI.getTransfer(i);n===e.FLOAT&&(a=e.RGBA32F),n===e.HALF_FLOAT&&(a=e.RGBA16F),n===e.UNSIGNED_BYTE&&(a=g===lt?e.SRGB8_ALPHA8:e.RGBA8),n===e.UNSIGNED_SHORT_4_4_4_4&&(a=e.RGBA4),n===e.UNSIGNED_SHORT_5_5_5_1&&(a=e.RGB5_A1)}return a!==e.R16F&&a!==e.R32F&&a!==e.RG16F&&a!==e.RG32F&&a!==e.RGBA16F&&a!==e.RGBA32F||g.get("EXT_color_buffer_float"),a}function v(e,g,t){return!0===B(e,t)||e.isFramebufferTexture&&e.minFilter!==Re&&e.minFilter!==Ke?Math.log2(Math.max(g.width,g.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?g.mipmaps.length:1}function W(g){return g===Re||g===Ve||g===Se?e.NEAREST:e.LINEAR}function f(e){const g=e.target;g.removeEventListener("dispose",f),function(e){const g=I.get(e);if(void 0===g.__webglInit)return;const t=e.source,n=h.get(t);if(n){const I=n[g.__cacheKey];I.usedTimes--,0===I.usedTimes&&R(e),0===Object.keys(n).length&&h.delete(t)}I.remove(e)}(g),g.isVideoTexture&&d.delete(g)}function w(g){const t=g.target;t.removeEventListener("dispose",w),function(g){const t=g.texture,n=I.get(g),i=I.get(t);if(void 0!==i.__webglTexture&&(e.deleteTexture(i.__webglTexture),C.memory.textures--),g.depthTexture&&g.depthTexture.dispose(),g.isWebGLCubeRenderTarget)for(let g=0;g<6;g++){if(Array.isArray(n.__webglFramebuffer[g]))for(let t=0;t<n.__webglFramebuffer[g].length;t++)e.deleteFramebuffer(n.__webglFramebuffer[g][t]);else e.deleteFramebuffer(n.__webglFramebuffer[g]);n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer[g])}else{if(Array.isArray(n.__webglFramebuffer))for(let g=0;g<n.__webglFramebuffer.length;g++)e.deleteFramebuffer(n.__webglFramebuffer[g]);else e.deleteFramebuffer(n.__webglFramebuffer);if(n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer),n.__webglMultisampledFramebuffer&&e.deleteFramebuffer(n.__webglMultisampledFramebuffer),n.__webglColorRenderbuffer)for(let g=0;g<n.__webglColorRenderbuffer.length;g++)n.__webglColorRenderbuffer[g]&&e.deleteRenderbuffer(n.__webglColorRenderbuffer[g]);n.__webglDepthRenderbuffer&&e.deleteRenderbuffer(n.__webglDepthRenderbuffer)}if(g.isWebGLMultipleRenderTargets)for(let g=0,n=t.length;g<n;g++){const n=I.get(t[g]);n.__webglTexture&&(e.deleteTexture(n.__webglTexture),C.memory.textures--),I.remove(t[g])}I.remove(t),I.remove(g)}(t)}function R(g){const t=I.get(g);e.deleteTexture(t.__webglTexture);const n=g.source;delete h.get(n)[t.__cacheKey],C.memory.textures--}let V=0;function X(g,n){const i=I.get(g);if(g.isVideoTexture&&function(e){const g=C.render.frame;d.get(e)!==g&&(d.set(e,g),e.update())}(g),!1===g.isRenderTargetTexture&&g.version>0&&i.__version!==g.version){const e=g.image;if(null===e)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==e.complete)return void F(i,g,n);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}t.bindTexture(e.TEXTURE_2D,i.__webglTexture,e.TEXTURE0+n)}const S={[We]:e.REPEAT,[fe]:e.CLAMP_TO_EDGE,[we]:e.MIRRORED_REPEAT},Y={[Re]:e.NEAREST,[Ve]:e.NEAREST_MIPMAP_NEAREST,[Se]:e.NEAREST_MIPMAP_LINEAR,[Ke]:e.LINEAR,[He]:e.LINEAR_MIPMAP_NEAREST,[Fe]:e.LINEAR_MIPMAP_LINEAR},K={[Vt]:e.NEVER,[Ft]:e.ALWAYS,[Xt]:e.LESS,[Yt]:e.LEQUAL,[St]:e.EQUAL,[Nt]:e.GEQUAL,[Kt]:e.GREATER,[Ht]:e.NOTEQUAL};function H(t,i,C){if(C?(e.texParameteri(t,e.TEXTURE_WRAP_S,S[i.wrapS]),e.texParameteri(t,e.TEXTURE_WRAP_T,S[i.wrapT]),t!==e.TEXTURE_3D&&t!==e.TEXTURE_2D_ARRAY||e.texParameteri(t,e.TEXTURE_WRAP_R,S[i.wrapR]),e.texParameteri(t,e.TEXTURE_MAG_FILTER,Y[i.magFilter]),e.texParameteri(t,e.TEXTURE_MIN_FILTER,Y[i.minFilter])):(e.texParameteri(t,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(t,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t!==e.TEXTURE_3D&&t!==e.TEXTURE_2D_ARRAY||e.texParameteri(t,e.TEXTURE_WRAP_R,e.CLAMP_TO_EDGE),i.wrapS===fe&&i.wrapT===fe||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),e.texParameteri(t,e.TEXTURE_MAG_FILTER,W(i.magFilter)),e.texParameteri(t,e.TEXTURE_MIN_FILTER,W(i.minFilter)),i.minFilter!==Re&&i.minFilter!==Ke&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),i.compareFunction&&(e.texParameteri(t,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(t,e.TEXTURE_COMPARE_FUNC,K[i.compareFunction])),!0===g.has("EXT_texture_filter_anisotropic")){const C=g.get("EXT_texture_filter_anisotropic");if(i.magFilter===Re)return;if(i.minFilter!==Se&&i.minFilter!==Fe)return;if(i.type===Te&&!1===g.has("OES_texture_float_linear"))return;if(!1===o&&i.type===Ue&&!1===g.has("OES_texture_half_float_linear"))return;(i.anisotropy>1||I.get(i).__currentAnisotropy)&&(e.texParameterf(t,C.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i.anisotropy,n.getMaxAnisotropy())),I.get(i).__currentAnisotropy=i.anisotropy)}}function N(g,t){let I=!1;void 0===g.__webglInit&&(g.__webglInit=!0,t.addEventListener("dispose",f));const n=t.source;let i=h.get(n);void 0===i&&(i={},h.set(n,i));const o=function(e){const g=[];return g.push(e.wrapS),g.push(e.wrapT),g.push(e.wrapR||0),g.push(e.magFilter),g.push(e.minFilter),g.push(e.anisotropy),g.push(e.internalFormat),g.push(e.format),g.push(e.type),g.push(e.generateMipmaps),g.push(e.premultiplyAlpha),g.push(e.flipY),g.push(e.unpackAlignment),g.push(e.colorSpace),g.join()}(t);if(o!==g.__cacheKey){void 0===i[o]&&(i[o]={texture:e.createTexture(),usedTimes:0},C.memory.textures++,I=!0),i[o].usedTimes++;const n=i[g.__cacheKey];void 0!==n&&(i[g.__cacheKey].usedTimes--,0===n.usedTimes&&R(t)),g.__cacheKey=o,g.__webglTexture=i[o].texture}return I}function F(g,n,C){let a=e.TEXTURE_2D;(n.isDataArrayTexture||n.isCompressedArrayTexture)&&(a=e.TEXTURE_2D_ARRAY),n.isData3DTexture&&(a=e.TEXTURE_3D);const s=N(g,n),r=n.source;t.bindTexture(a,g.__webglTexture,e.TEXTURE0+C);const A=I.get(r);if(r.version!==A.__version||!0===s){t.activeTexture(e.TEXTURE0+C);const g=fI.getPrimaries(fI.workingColorSpace),I=n.colorSpace===nt?null:fI.getPrimaries(n.colorSpace),c=n.colorSpace===nt||g===I?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,n.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,n.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,c);const d=function(e){return!o&&(e.wrapS!==fe||e.wrapT!==fe||e.minFilter!==Re&&e.minFilter!==Ke)}(n)&&!1===G(n.image);let u=p(n.image,d,!1,l);u=J(n,u);const h=G(u)||o,b=i.convert(n.format,n.colorSpace);let m,W=i.convert(n.type),f=y(n.internalFormat,b,W,n.colorSpace,n.isVideoTexture);H(a,n,h);const w=n.mipmaps,R=o&&!0!==n.isVideoTexture,V=void 0===A.__version||!0===s,X=v(n,u,h);if(n.isDepthTexture)f=e.DEPTH_COMPONENT,o?f=n.type===Te?e.DEPTH_COMPONENT32F:n.type===Ee?e.DEPTH_COMPONENT24:n.type===Oe?e.DEPTH24_STENCIL8:e.DEPTH_COMPONENT16:n.type===Te&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),n.format===$e&&f===e.DEPTH_COMPONENT&&n.type!==Le&&n.type!==Ee&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),n.type=Ee,W=i.convert(n.type)),n.format===eg&&f===e.DEPTH_COMPONENT&&(f=e.DEPTH_STENCIL,n.type!==Oe&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),n.type=Oe,W=i.convert(n.type))),V&&(R?t.texStorage2D(e.TEXTURE_2D,1,f,u.width,u.height):t.texImage2D(e.TEXTURE_2D,0,f,u.width,u.height,0,b,W,null));else if(n.isDataTexture)if(w.length>0&&h){R&&V&&t.texStorage2D(e.TEXTURE_2D,X,f,w[0].width,w[0].height);for(let g=0,I=w.length;g<I;g++)m=w[g],R?t.texSubImage2D(e.TEXTURE_2D,g,0,0,m.width,m.height,b,W,m.data):t.texImage2D(e.TEXTURE_2D,g,f,m.width,m.height,0,b,W,m.data);n.generateMipmaps=!1}else R?(V&&t.texStorage2D(e.TEXTURE_2D,X,f,u.width,u.height),t.texSubImage2D(e.TEXTURE_2D,0,0,0,u.width,u.height,b,W,u.data)):t.texImage2D(e.TEXTURE_2D,0,f,u.width,u.height,0,b,W,u.data);else if(n.isCompressedTexture)if(n.isCompressedArrayTexture){R&&V&&t.texStorage3D(e.TEXTURE_2D_ARRAY,X,f,w[0].width,w[0].height,u.depth);for(let g=0,I=w.length;g<I;g++)m=w[g],n.format!==Pe?null!==b?R?t.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,g,0,0,0,m.width,m.height,u.depth,b,m.data,0,0):t.compressedTexImage3D(e.TEXTURE_2D_ARRAY,g,f,m.width,m.height,u.depth,0,m.data,0,0):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):R?t.texSubImage3D(e.TEXTURE_2D_ARRAY,g,0,0,0,m.width,m.height,u.depth,b,W,m.data):t.texImage3D(e.TEXTURE_2D_ARRAY,g,f,m.width,m.height,u.depth,0,b,W,m.data)}else{R&&V&&t.texStorage2D(e.TEXTURE_2D,X,f,w[0].width,w[0].height);for(let g=0,I=w.length;g<I;g++)m=w[g],n.format!==Pe?null!==b?R?t.compressedTexSubImage2D(e.TEXTURE_2D,g,0,0,m.width,m.height,b,m.data):t.compressedTexImage2D(e.TEXTURE_2D,g,f,m.width,m.height,0,m.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):R?t.texSubImage2D(e.TEXTURE_2D,g,0,0,m.width,m.height,b,W,m.data):t.texImage2D(e.TEXTURE_2D,g,f,m.width,m.height,0,b,W,m.data)}else if(n.isDataArrayTexture)R?(V&&t.texStorage3D(e.TEXTURE_2D_ARRAY,X,f,u.width,u.height,u.depth),t.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,u.width,u.height,u.depth,b,W,u.data)):t.texImage3D(e.TEXTURE_2D_ARRAY,0,f,u.width,u.height,u.depth,0,b,W,u.data);else if(n.isData3DTexture)R?(V&&t.texStorage3D(e.TEXTURE_3D,X,f,u.width,u.height,u.depth),t.texSubImage3D(e.TEXTURE_3D,0,0,0,0,u.width,u.height,u.depth,b,W,u.data)):t.texImage3D(e.TEXTURE_3D,0,f,u.width,u.height,u.depth,0,b,W,u.data);else if(n.isFramebufferTexture){if(V)if(R)t.texStorage2D(e.TEXTURE_2D,X,f,u.width,u.height);else{let g=u.width,I=u.height;for(let n=0;n<X;n++)t.texImage2D(e.TEXTURE_2D,n,f,g,I,0,b,W,null),g>>=1,I>>=1}}else if(w.length>0&&h){R&&V&&t.texStorage2D(e.TEXTURE_2D,X,f,w[0].width,w[0].height);for(let g=0,I=w.length;g<I;g++)m=w[g],R?t.texSubImage2D(e.TEXTURE_2D,g,0,0,b,W,m):t.texImage2D(e.TEXTURE_2D,g,f,b,W,m);n.generateMipmaps=!1}else R?(V&&t.texStorage2D(e.TEXTURE_2D,X,f,u.width,u.height),t.texSubImage2D(e.TEXTURE_2D,0,0,0,b,W,u)):t.texImage2D(e.TEXTURE_2D,0,f,b,W,u);B(n,h)&&Z(a),A.__version=r.version,n.onUpdate&&n.onUpdate(n)}g.__version=n.version}function x(g,n,C,o,a,s){const l=i.convert(C.format,C.colorSpace),r=i.convert(C.type),c=y(C.internalFormat,l,r,C.colorSpace);if(!I.get(n).__hasExternalTextures){const g=Math.max(1,n.width>>s),I=Math.max(1,n.height>>s);a===e.TEXTURE_3D||a===e.TEXTURE_2D_ARRAY?t.texImage3D(a,s,c,g,I,n.depth,0,l,r,null):t.texImage2D(a,s,c,g,I,0,l,r,null)}t.bindFramebuffer(e.FRAMEBUFFER,g),L(n)?A.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,o,a,I.get(C).__webglTexture,0,M(n)):(a===e.TEXTURE_2D||a>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&a<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,o,a,I.get(C).__webglTexture,s),t.bindFramebuffer(e.FRAMEBUFFER,null)}function z(g,t,I){if(e.bindRenderbuffer(e.RENDERBUFFER,g),t.depthBuffer&&!t.stencilBuffer){let n=!0===o?e.DEPTH_COMPONENT24:e.DEPTH_COMPONENT16;if(I||L(t)){const g=t.depthTexture;g&&g.isDepthTexture&&(g.type===Te?n=e.DEPTH_COMPONENT32F:g.type===Ee&&(n=e.DEPTH_COMPONENT24));const I=M(t);L(t)?A.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,I,n,t.width,t.height):e.renderbufferStorageMultisample(e.RENDERBUFFER,I,n,t.width,t.height)}else e.renderbufferStorage(e.RENDERBUFFER,n,t.width,t.height);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,g)}else if(t.depthBuffer&&t.stencilBuffer){const n=M(t);I&&!1===L(t)?e.renderbufferStorageMultisample(e.RENDERBUFFER,n,e.DEPTH24_STENCIL8,t.width,t.height):L(t)?A.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,n,e.DEPTH24_STENCIL8,t.width,t.height):e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,g)}else{const g=!0===t.isWebGLMultipleRenderTargets?t.texture:[t.texture];for(let n=0;n<g.length;n++){const C=g[n],o=i.convert(C.format,C.colorSpace),a=i.convert(C.type),s=y(C.internalFormat,o,a,C.colorSpace),l=M(t);I&&!1===L(t)?e.renderbufferStorageMultisample(e.RENDERBUFFER,l,s,t.width,t.height):L(t)?A.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,l,s,t.width,t.height):e.renderbufferStorage(e.RENDERBUFFER,s,t.width,t.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function k(g){const n=I.get(g),i=!0===g.isWebGLCubeRenderTarget;if(g.depthTexture&&!n.__autoAllocateDepthBuffer){if(i)throw new Error("target.depthTexture not supported in Cube render targets");!function(g,n){if(n&&n.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(t.bindFramebuffer(e.FRAMEBUFFER,g),!n.depthTexture||!n.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");I.get(n.depthTexture).__webglTexture&&n.depthTexture.image.width===n.width&&n.depthTexture.image.height===n.height||(n.depthTexture.image.width=n.width,n.depthTexture.image.height=n.height,n.depthTexture.needsUpdate=!0),X(n.depthTexture,0);const i=I.get(n.depthTexture).__webglTexture,C=M(n);if(n.depthTexture.format===$e)L(n)?A.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,i,0,C):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,i,0);else{if(n.depthTexture.format!==eg)throw new Error("Unknown depthTexture format");L(n)?A.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,i,0,C):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,i,0)}}(n.__webglFramebuffer,g)}else if(i){n.__webglDepthbuffer=[];for(let I=0;I<6;I++)t.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer[I]),n.__webglDepthbuffer[I]=e.createRenderbuffer(),z(n.__webglDepthbuffer[I],g,!1)}else t.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer),n.__webglDepthbuffer=e.createRenderbuffer(),z(n.__webglDepthbuffer,g,!1);t.bindFramebuffer(e.FRAMEBUFFER,null)}function M(e){return Math.min(r,e.samples)}function L(e){const t=I.get(e);return o&&e.samples>0&&!0===g.has("WEBGL_multisampled_render_to_texture")&&!1!==t.__useRenderToTexture}function J(e,t){const I=e.colorSpace,n=e.format,i=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||e.format===Ot||I!==Ct&&I!==nt&&(fI.getTransfer(I)===lt?!1===o?!0===g.has("EXT_sRGB")&&n===Pe?(e.format=Ot,e.minFilter=Ke,e.generateMipmaps=!1):t=XI.sRGBToLinear(t):n===Pe&&i===ze||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",I)),t}this.allocateTextureUnit=function(){const e=V;return e>=a&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+a),V+=1,e},this.resetTextureUnits=function(){V=0},this.setTexture2D=X,this.setTexture2DArray=function(g,n){const i=I.get(g);g.version>0&&i.__version!==g.version?F(i,g,n):t.bindTexture(e.TEXTURE_2D_ARRAY,i.__webglTexture,e.TEXTURE0+n)},this.setTexture3D=function(g,n){const i=I.get(g);g.version>0&&i.__version!==g.version?F(i,g,n):t.bindTexture(e.TEXTURE_3D,i.__webglTexture,e.TEXTURE0+n)},this.setTextureCube=function(g,n){const C=I.get(g);g.version>0&&C.__version!==g.version?function(g,n,C){if(6!==n.image.length)return;const a=N(g,n),l=n.source;t.bindTexture(e.TEXTURE_CUBE_MAP,g.__webglTexture,e.TEXTURE0+C);const r=I.get(l);if(l.version!==r.__version||!0===a){t.activeTexture(e.TEXTURE0+C);const g=fI.getPrimaries(fI.workingColorSpace),I=n.colorSpace===nt?null:fI.getPrimaries(n.colorSpace),A=n.colorSpace===nt||g===I?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,n.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,n.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,A);const c=n.isCompressedTexture||n.image[0].isCompressedTexture,d=n.image[0]&&n.image[0].isDataTexture,u=[];for(let e=0;e<6;e++)u[e]=c||d?d?n.image[e].image:n.image[e]:p(n.image[e],!1,!0,s),u[e]=J(n,u[e]);const h=u[0],b=G(h)||o,m=i.convert(n.format,n.colorSpace),W=i.convert(n.type),f=y(n.internalFormat,m,W,n.colorSpace),w=o&&!0!==n.isVideoTexture,R=void 0===r.__version||!0===a;let V,X=v(n,h,b);if(H(e.TEXTURE_CUBE_MAP,n,b),c){w&&R&&t.texStorage2D(e.TEXTURE_CUBE_MAP,X,f,h.width,h.height);for(let g=0;g<6;g++){V=u[g].mipmaps;for(let I=0;I<V.length;I++){const i=V[I];n.format!==Pe?null!==m?w?t.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,I,0,0,i.width,i.height,m,i.data):t.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,I,f,i.width,i.height,0,i.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):w?t.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,I,0,0,i.width,i.height,m,W,i.data):t.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,I,f,i.width,i.height,0,m,W,i.data)}}}else{V=n.mipmaps,w&&R&&(V.length>0&&X++,t.texStorage2D(e.TEXTURE_CUBE_MAP,X,f,u[0].width,u[0].height));for(let g=0;g<6;g++)if(d){w?t.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,0,0,0,u[g].width,u[g].height,m,W,u[g].data):t.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,0,f,u[g].width,u[g].height,0,m,W,u[g].data);for(let I=0;I<V.length;I++){const n=V[I].image[g].image;w?t.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,I+1,0,0,n.width,n.height,m,W,n.data):t.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,I+1,f,n.width,n.height,0,m,W,n.data)}}else{w?t.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,0,0,0,m,W,u[g]):t.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,0,f,m,W,u[g]);for(let I=0;I<V.length;I++){const n=V[I];w?t.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,I+1,0,0,m,W,n.image[g]):t.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+g,I+1,f,m,W,n.image[g])}}}B(n,b)&&Z(e.TEXTURE_CUBE_MAP),r.__version=l.version,n.onUpdate&&n.onUpdate(n)}g.__version=n.version}(C,g,n):t.bindTexture(e.TEXTURE_CUBE_MAP,C.__webglTexture,e.TEXTURE0+n)},this.rebindTextures=function(g,t,n){const i=I.get(g);void 0!==t&&x(i.__webglFramebuffer,g,g.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==n&&k(g)},this.setupRenderTarget=function(g){const a=g.texture,s=I.get(g),l=I.get(a);g.addEventListener("dispose",w),!0!==g.isWebGLMultipleRenderTargets&&(void 0===l.__webglTexture&&(l.__webglTexture=e.createTexture()),l.__version=a.version,C.memory.textures++);const r=!0===g.isWebGLCubeRenderTarget,A=!0===g.isWebGLMultipleRenderTargets,c=G(g)||o;if(r){s.__webglFramebuffer=[];for(let g=0;g<6;g++)if(o&&a.mipmaps&&a.mipmaps.length>0){s.__webglFramebuffer[g]=[];for(let t=0;t<a.mipmaps.length;t++)s.__webglFramebuffer[g][t]=e.createFramebuffer()}else s.__webglFramebuffer[g]=e.createFramebuffer()}else{if(o&&a.mipmaps&&a.mipmaps.length>0){s.__webglFramebuffer=[];for(let g=0;g<a.mipmaps.length;g++)s.__webglFramebuffer[g]=e.createFramebuffer()}else s.__webglFramebuffer=e.createFramebuffer();if(A)if(n.drawBuffers){const t=g.texture;for(let g=0,n=t.length;g<n;g++){const n=I.get(t[g]);void 0===n.__webglTexture&&(n.__webglTexture=e.createTexture(),C.memory.textures++)}}else console.warn("THREE.WebGLRenderer: WebGLMultipleRenderTargets can only be used with WebGL2 or WEBGL_draw_buffers extension.");if(o&&g.samples>0&&!1===L(g)){const I=A?a:[a];s.__webglMultisampledFramebuffer=e.createFramebuffer(),s.__webglColorRenderbuffer=[],t.bindFramebuffer(e.FRAMEBUFFER,s.__webglMultisampledFramebuffer);for(let t=0;t<I.length;t++){const n=I[t];s.__webglColorRenderbuffer[t]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,s.__webglColorRenderbuffer[t]);const C=i.convert(n.format,n.colorSpace),o=i.convert(n.type),a=y(n.internalFormat,C,o,n.colorSpace,!0===g.isXRRenderTarget),l=M(g);e.renderbufferStorageMultisample(e.RENDERBUFFER,l,a,g.width,g.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,s.__webglColorRenderbuffer[t])}e.bindRenderbuffer(e.RENDERBUFFER,null),g.depthBuffer&&(s.__webglDepthRenderbuffer=e.createRenderbuffer(),z(s.__webglDepthRenderbuffer,g,!0)),t.bindFramebuffer(e.FRAMEBUFFER,null)}}if(r){t.bindTexture(e.TEXTURE_CUBE_MAP,l.__webglTexture),H(e.TEXTURE_CUBE_MAP,a,c);for(let t=0;t<6;t++)if(o&&a.mipmaps&&a.mipmaps.length>0)for(let I=0;I<a.mipmaps.length;I++)x(s.__webglFramebuffer[t][I],g,a,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+t,I);else x(s.__webglFramebuffer[t],g,a,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0);B(a,c)&&Z(e.TEXTURE_CUBE_MAP),t.unbindTexture()}else if(A){const n=g.texture;for(let i=0,C=n.length;i<C;i++){const C=n[i],o=I.get(C);t.bindTexture(e.TEXTURE_2D,o.__webglTexture),H(e.TEXTURE_2D,C,c),x(s.__webglFramebuffer,g,C,e.COLOR_ATTACHMENT0+i,e.TEXTURE_2D,0),B(C,c)&&Z(e.TEXTURE_2D)}t.unbindTexture()}else{let I=e.TEXTURE_2D;if((g.isWebGL3DRenderTarget||g.isWebGLArrayRenderTarget)&&(o?I=g.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY:console.error("THREE.WebGLTextures: THREE.Data3DTexture and THREE.DataArrayTexture only supported with WebGL2.")),t.bindTexture(I,l.__webglTexture),H(I,a,c),o&&a.mipmaps&&a.mipmaps.length>0)for(let t=0;t<a.mipmaps.length;t++)x(s.__webglFramebuffer[t],g,a,e.COLOR_ATTACHMENT0,I,t);else x(s.__webglFramebuffer,g,a,e.COLOR_ATTACHMENT0,I,0);B(a,c)&&Z(I),t.unbindTexture()}g.depthBuffer&&k(g)},this.updateRenderTargetMipmap=function(g){const n=G(g)||o,i=!0===g.isWebGLMultipleRenderTargets?g.texture:[g.texture];for(let C=0,o=i.length;C<o;C++){const o=i[C];if(B(o,n)){const n=g.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,i=I.get(o).__webglTexture;t.bindTexture(n,i),Z(n),t.unbindTexture()}}},this.updateMultisampleRenderTarget=function(g){if(o&&g.samples>0&&!1===L(g)){const n=g.isWebGLMultipleRenderTargets?g.texture:[g.texture],i=g.width,C=g.height;let o=e.COLOR_BUFFER_BIT;const a=[],s=g.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,l=I.get(g),r=!0===g.isWebGLMultipleRenderTargets;if(r)for(let g=0;g<n.length;g++)t.bindFramebuffer(e.FRAMEBUFFER,l.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+g,e.RENDERBUFFER,null),t.bindFramebuffer(e.FRAMEBUFFER,l.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+g,e.TEXTURE_2D,null,0);t.bindFramebuffer(e.READ_FRAMEBUFFER,l.__webglMultisampledFramebuffer),t.bindFramebuffer(e.DRAW_FRAMEBUFFER,l.__webglFramebuffer);for(let t=0;t<n.length;t++){a.push(e.COLOR_ATTACHMENT0+t),g.depthBuffer&&a.push(s);const A=void 0!==l.__ignoreDepthValues&&l.__ignoreDepthValues;if(!1===A&&(g.depthBuffer&&(o|=e.DEPTH_BUFFER_BIT),g.stencilBuffer&&(o|=e.STENCIL_BUFFER_BIT)),r&&e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,l.__webglColorRenderbuffer[t]),!0===A&&(e.invalidateFramebuffer(e.READ_FRAMEBUFFER,[s]),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[s])),r){const g=I.get(n[t]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,g,0)}e.blitFramebuffer(0,0,i,C,0,0,i,C,o,e.NEAREST),c&&e.invalidateFramebuffer(e.READ_FRAMEBUFFER,a)}if(t.bindFramebuffer(e.READ_FRAMEBUFFER,null),t.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),r)for(let g=0;g<n.length;g++){t.bindFramebuffer(e.FRAMEBUFFER,l.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+g,e.RENDERBUFFER,l.__webglColorRenderbuffer[g]);const i=I.get(n[g]).__webglTexture;t.bindFramebuffer(e.FRAMEBUFFER,l.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+g,e.TEXTURE_2D,i,0)}t.bindFramebuffer(e.DRAW_FRAMEBUFFER,l.__webglMultisampledFramebuffer)}},this.setupDepthRenderbuffer=k,this.setupFrameBufferTexture=x,this.useMultisampledRTT=L}function Oa(e,g,t){const I=t.isWebGL2;return{convert:function(t,n=nt){let i;const C=fI.getTransfer(n);if(t===ze)return e.UNSIGNED_BYTE;if(t===Qe)return e.UNSIGNED_SHORT_4_4_4_4;if(t===De)return e.UNSIGNED_SHORT_5_5_5_1;if(t===ke)return e.BYTE;if(t===Me)return e.SHORT;if(t===Le)return e.UNSIGNED_SHORT;if(t===Je)return e.INT;if(t===Ee)return e.UNSIGNED_INT;if(t===Te)return e.FLOAT;if(t===Ue)return I?e.HALF_FLOAT:(i=g.get("OES_texture_half_float"),null!==i?i.HALF_FLOAT_OES:null);if(t===je)return e.ALPHA;if(t===Pe)return e.RGBA;if(t===_e)return e.LUMINANCE;if(t===qe)return e.LUMINANCE_ALPHA;if(t===$e)return e.DEPTH_COMPONENT;if(t===eg)return e.DEPTH_STENCIL;if(t===Ot)return i=g.get("EXT_sRGB"),null!==i?i.SRGB_ALPHA_EXT:null;if(t===gg)return e.RED;if(t===tg)return e.RED_INTEGER;if(t===Ig)return e.RG;if(t===ng)return e.RG_INTEGER;if(t===ig)return e.RGBA_INTEGER;if(t===Cg||t===og||t===ag||t===sg)if(C===lt){if(i=g.get("WEBGL_compressed_texture_s3tc_srgb"),null===i)return null;if(t===Cg)return i.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(t===og)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(t===ag)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(t===sg)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(i=g.get("WEBGL_compressed_texture_s3tc"),null===i)return null;if(t===Cg)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===og)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===ag)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===sg)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(t===lg||t===rg||t===Ag||t===cg){if(i=g.get("WEBGL_compressed_texture_pvrtc"),null===i)return null;if(t===lg)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(t===rg)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(t===Ag)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(t===cg)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(t===dg)return i=g.get("WEBGL_compressed_texture_etc1"),null!==i?i.COMPRESSED_RGB_ETC1_WEBGL:null;if(t===ug||t===hg){if(i=g.get("WEBGL_compressed_texture_etc"),null===i)return null;if(t===ug)return C===lt?i.COMPRESSED_SRGB8_ETC2:i.COMPRESSED_RGB8_ETC2;if(t===hg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC}if(t===bg||t===mg||t===pg||t===Gg||t===Bg||t===Zg||t===yg||t===vg||t===Wg||t===fg||t===wg||t===Rg||t===Vg||t===Xg){if(i=g.get("WEBGL_compressed_texture_astc"),null===i)return null;if(t===bg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:i.COMPRESSED_RGBA_ASTC_4x4_KHR;if(t===mg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:i.COMPRESSED_RGBA_ASTC_5x4_KHR;if(t===pg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:i.COMPRESSED_RGBA_ASTC_5x5_KHR;if(t===Gg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:i.COMPRESSED_RGBA_ASTC_6x5_KHR;if(t===Bg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:i.COMPRESSED_RGBA_ASTC_6x6_KHR;if(t===Zg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:i.COMPRESSED_RGBA_ASTC_8x5_KHR;if(t===yg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:i.COMPRESSED_RGBA_ASTC_8x6_KHR;if(t===vg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:i.COMPRESSED_RGBA_ASTC_8x8_KHR;if(t===Wg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:i.COMPRESSED_RGBA_ASTC_10x5_KHR;if(t===fg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:i.COMPRESSED_RGBA_ASTC_10x6_KHR;if(t===wg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:i.COMPRESSED_RGBA_ASTC_10x8_KHR;if(t===Rg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:i.COMPRESSED_RGBA_ASTC_10x10_KHR;if(t===Vg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:i.COMPRESSED_RGBA_ASTC_12x10_KHR;if(t===Xg)return C===lt?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:i.COMPRESSED_RGBA_ASTC_12x12_KHR}if(t===Sg||t===Yg||t===Kg){if(i=g.get("EXT_texture_compression_bptc"),null===i)return null;if(t===Sg)return C===lt?i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:i.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(t===Yg)return i.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(t===Kg)return i.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(t===Hg||t===Ng||t===Fg||t===xg){if(i=g.get("EXT_texture_compression_rgtc"),null===i)return null;if(t===Sg)return i.COMPRESSED_RED_RGTC1_EXT;if(t===Ng)return i.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(t===Fg)return i.COMPRESSED_RED_GREEN_RGTC2_EXT;if(t===xg)return i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return t===Oe?I?e.UNSIGNED_INT_24_8:(i=g.get("WEBGL_depth_texture"),null!==i?i.UNSIGNED_INT_24_8_WEBGL:null):void 0!==e[t]?e[t]:null}}}class ja extends cC{constructor(e=[]){super(),this.isArrayCamera=!0,this.cameras=e}}class Pa extends Dn{constructor(){super(),this.isGroup=!0,this.type="Group"}}const _a={type:"move"};class qa{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new Pa,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new Pa,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new UI,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new UI),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new Pa,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new UI,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new UI),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const g=this._hand;if(g)for(const t of e.hand.values())this._getHandJoint(g,t)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,g,t){let I=null,n=null,i=null;const C=this._targetRay,o=this._grip,a=this._hand;if(e&&"visible-blurred"!==g.session.visibilityState){if(a&&e.hand){i=!0;for(const I of e.hand.values()){const e=g.getJointPose(I,t),n=this._getHandJoint(a,I);null!==e&&(n.matrix.fromArray(e.transform.matrix),n.matrix.decompose(n.position,n.rotation,n.scale),n.matrixWorldNeedsUpdate=!0,n.jointRadius=e.radius),n.visible=null!==e}const I=a.joints["index-finger-tip"],n=a.joints["thumb-tip"],C=I.position.distanceTo(n.position),o=.02,s=.005;a.inputState.pinching&&C>o+s?(a.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!a.inputState.pinching&&C<=o-s&&(a.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&e.gripSpace&&(n=g.getPose(e.gripSpace,t),null!==n&&(o.matrix.fromArray(n.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,n.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(n.linearVelocity)):o.hasLinearVelocity=!1,n.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(n.angularVelocity)):o.hasAngularVelocity=!1));null!==C&&(I=g.getPose(e.targetRaySpace,t),null===I&&null!==n&&(I=n),null!==I&&(C.matrix.fromArray(I.transform.matrix),C.matrix.decompose(C.position,C.rotation,C.scale),C.matrixWorldNeedsUpdate=!0,I.linearVelocity?(C.hasLinearVelocity=!0,C.linearVelocity.copy(I.linearVelocity)):C.hasLinearVelocity=!1,I.angularVelocity?(C.hasAngularVelocity=!0,C.angularVelocity.copy(I.angularVelocity)):C.hasAngularVelocity=!1,this.dispatchEvent(_a)))}return null!==C&&(C.visible=null!==I),null!==o&&(o.visible=null!==n),null!==a&&(a.visible=null!==i),this}_getHandJoint(e,g){if(void 0===e.joints[g.jointName]){const t=new Pa;t.matrixAutoUpdate=!1,t.visible=!1,e.joints[g.jointName]=t,e.add(t)}return e.joints[g.jointName]}}class $a extends NI{constructor(e,g,t,I,n,i,C,o,a,s){if((s=void 0!==s?s:$e)!==$e&&s!==eg)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===t&&s===$e&&(t=Ee),void 0===t&&s===eg&&(t=Oe),super(null,I,n,i,C,o,s,t,a),this.isDepthTexture=!0,this.image={width:e,height:g},this.magFilter=void 0!==C?C:Re,this.minFilter=void 0!==o?o:Re,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.compareFunction=e.compareFunction,this}toJSON(e){const g=super.toJSON(e);return null!==this.compareFunction&&(g.compareFunction=this.compareFunction),g}}class es extends _t{constructor(e,g){super();const t=this;let I=null,n=1,i=null,C="local-floor",o=1,a=null,s=null,l=null,r=null,A=null,c=null;const d=g.getContextAttributes();let u=null,h=null;const b=[],m=[],p=new cC;p.layers.enable(1),p.viewport=new FI;const G=new cC;G.layers.enable(2),G.viewport=new FI;const B=[p,G],Z=new ja;Z.layers.enable(1),Z.layers.enable(2);let y=null,v=null;function W(e){const g=m.indexOf(e.inputSource);if(-1===g)return;const t=b[g];void 0!==t&&(t.update(e.inputSource,e.frame,a||i),t.dispatchEvent({type:e.type,data:e.inputSource}))}function f(){I.removeEventListener("select",W),I.removeEventListener("selectstart",W),I.removeEventListener("selectend",W),I.removeEventListener("squeeze",W),I.removeEventListener("squeezestart",W),I.removeEventListener("squeezeend",W),I.removeEventListener("end",f),I.removeEventListener("inputsourceschange",w);for(let e=0;e<b.length;e++){const g=m[e];null!==g&&(m[e]=null,b[e].disconnect(g))}y=null,v=null,e.setRenderTarget(u),A=null,r=null,l=null,I=null,h=null,Y.stop(),t.isPresenting=!1,t.dispatchEvent({type:"sessionend"})}function w(e){for(let g=0;g<e.removed.length;g++){const t=e.removed[g],I=m.indexOf(t);I>=0&&(m[I]=null,b[I].disconnect(t))}for(let g=0;g<e.added.length;g++){const t=e.added[g];let I=m.indexOf(t);if(-1===I){for(let e=0;e<b.length;e++){if(e>=m.length){m.push(t),I=e;break}if(null===m[e]){m[e]=t,I=e;break}}if(-1===I)break}const n=b[I];n&&n.connect(t)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let g=b[e];return void 0===g&&(g=new qa,b[e]=g),g.getTargetRaySpace()},this.getControllerGrip=function(e){let g=b[e];return void 0===g&&(g=new qa,b[e]=g),g.getGripSpace()},this.getHand=function(e){let g=b[e];return void 0===g&&(g=new qa,b[e]=g),g.getHandSpace()},this.setFramebufferScaleFactor=function(e){n=e,!0===t.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){C=e,!0===t.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return a||i},this.setReferenceSpace=function(e){a=e},this.getBaseLayer=function(){return null!==r?r:A},this.getBinding=function(){return l},this.getFrame=function(){return c},this.getSession=function(){return I},this.setSession=async function(s){if(I=s,null!==I){if(u=e.getRenderTarget(),I.addEventListener("select",W),I.addEventListener("selectstart",W),I.addEventListener("selectend",W),I.addEventListener("squeeze",W),I.addEventListener("squeezestart",W),I.addEventListener("squeezeend",W),I.addEventListener("end",f),I.addEventListener("inputsourceschange",w),!0!==d.xrCompatible&&await g.makeXRCompatible(),void 0===I.renderState.layers||!1===e.capabilities.isWebGL2){const t={antialias:void 0!==I.renderState.layers||d.antialias,alpha:!0,depth:d.depth,stencil:d.stencil,framebufferScaleFactor:n};A=new XRWebGLLayer(I,g,t),I.updateRenderState({baseLayer:A}),h=new zI(A.framebufferWidth,A.framebufferHeight,{format:Pe,type:ze,colorSpace:e.outputColorSpace,stencilBuffer:d.stencil})}else{let t=null,i=null,C=null;d.depth&&(C=d.stencil?g.DEPTH24_STENCIL8:g.DEPTH_COMPONENT24,t=d.stencil?eg:$e,i=d.stencil?Oe:Ee);const o={colorFormat:g.RGBA8,depthFormat:C,scaleFactor:n};l=new XRWebGLBinding(I,g),r=l.createProjectionLayer(o),I.updateRenderState({layers:[r]}),h=new zI(r.textureWidth,r.textureHeight,{format:Pe,type:ze,depthTexture:new $a(r.textureWidth,r.textureHeight,i,void 0,void 0,void 0,void 0,void 0,void 0,t),stencilBuffer:d.stencil,colorSpace:e.outputColorSpace,samples:d.antialias?4:0}),e.properties.get(h).__ignoreDepthValues=r.ignoreDepthValues}h.isXRRenderTarget=!0,this.setFoveation(o),a=null,i=await I.requestReferenceSpace(C),Y.setContext(I),Y.start(),t.isPresenting=!0,t.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==I)return I.environmentBlendMode};const R=new UI,V=new UI;function X(e,g){null===g?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(g.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===I)return;Z.near=G.near=p.near=e.near,Z.far=G.far=p.far=e.far,y===Z.near&&v===Z.far||(I.updateRenderState({depthNear:Z.near,depthFar:Z.far}),y=Z.near,v=Z.far);const g=e.parent,t=Z.cameras;X(Z,g);for(let e=0;e<t.length;e++)X(t[e],g);2===t.length?function(e,g,t){R.setFromMatrixPosition(g.matrixWorld),V.setFromMatrixPosition(t.matrixWorld);const I=R.distanceTo(V),n=g.projectionMatrix.elements,i=t.projectionMatrix.elements,C=n[14]/(n[10]-1),o=n[14]/(n[10]+1),a=(n[9]+1)/n[5],s=(n[9]-1)/n[5],l=(n[8]-1)/n[0],r=(i[8]+1)/i[0],A=C*l,c=C*r,d=I/(-l+r),u=d*-l;g.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(u),e.translateZ(d),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert();const h=C+d,b=o+d,m=A-u,p=c+(I-u),G=a*o/b*h,B=s*o/b*h;e.projectionMatrix.makePerspective(m,p,G,B,h,b),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}(Z,p,G):Z.projectionMatrix.copy(p.projectionMatrix),function(e,g,t){null===t?e.matrix.copy(g.matrixWorld):(e.matrix.copy(t.matrixWorld),e.matrix.invert(),e.matrix.multiply(g.matrixWorld)),e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(g.projectionMatrix),e.projectionMatrixInverse.copy(g.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*gI*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,Z,g)},this.getCamera=function(){return Z},this.getFoveation=function(){if(null!==r||null!==A)return o},this.setFoveation=function(e){o=e,null!==r&&(r.fixedFoveation=e),null!==A&&void 0!==A.fixedFoveation&&(A.fixedFoveation=e)};let S=null;const Y=new WC;Y.setAnimationLoop((function(g,I){if(s=I.getViewerPose(a||i),c=I,null!==s){const g=s.views;null!==A&&(e.setRenderTargetFramebuffer(h,A.framebuffer),e.setRenderTarget(h));let t=!1;g.length!==Z.cameras.length&&(Z.cameras.length=0,t=!0);for(let I=0;I<g.length;I++){const n=g[I];let i=null;if(null!==A)i=A.getViewport(n);else{const g=l.getViewSubImage(r,n);i=g.viewport,0===I&&(e.setRenderTargetTextures(h,g.colorTexture,r.ignoreDepthValues?void 0:g.depthStencilTexture),e.setRenderTarget(h))}let C=B[I];void 0===C&&(C=new cC,C.layers.enable(I),C.viewport=new FI,B[I]=C),C.matrix.fromArray(n.transform.matrix),C.matrix.decompose(C.position,C.quaternion,C.scale),C.projectionMatrix.fromArray(n.projectionMatrix),C.projectionMatrixInverse.copy(C.projectionMatrix).invert(),C.viewport.set(i.x,i.y,i.width,i.height),0===I&&(Z.matrix.copy(C.matrix),Z.matrix.decompose(Z.position,Z.quaternion,Z.scale)),!0===t&&Z.cameras.push(C)}}for(let e=0;e<b.length;e++){const g=m[e],t=b[e];null!==g&&void 0!==t&&t.update(g,I,a||i)}S&&S(g,I),I.detectedPlanes&&t.dispatchEvent({type:"planesdetected",data:I}),c=null})),this.setAnimationLoop=function(e){S=e},this.dispose=function(){}}}function gs(e,g){function t(e,g){!0===e.matrixAutoUpdate&&e.updateMatrix(),g.value.copy(e.matrix)}function I(I,n){I.opacity.value=n.opacity,n.color&&I.diffuse.value.copy(n.color),n.emissive&&I.emissive.value.copy(n.emissive).multiplyScalar(n.emissiveIntensity),n.map&&(I.map.value=n.map,t(n.map,I.mapTransform)),n.alphaMap&&(I.alphaMap.value=n.alphaMap,t(n.alphaMap,I.alphaMapTransform)),n.bumpMap&&(I.bumpMap.value=n.bumpMap,t(n.bumpMap,I.bumpMapTransform),I.bumpScale.value=n.bumpScale,n.side===S&&(I.bumpScale.value*=-1)),n.normalMap&&(I.normalMap.value=n.normalMap,t(n.normalMap,I.normalMapTransform),I.normalScale.value.copy(n.normalScale),n.side===S&&I.normalScale.value.negate()),n.displacementMap&&(I.displacementMap.value=n.displacementMap,t(n.displacementMap,I.displacementMapTransform),I.displacementScale.value=n.displacementScale,I.displacementBias.value=n.displacementBias),n.emissiveMap&&(I.emissiveMap.value=n.emissiveMap,t(n.emissiveMap,I.emissiveMapTransform)),n.specularMap&&(I.specularMap.value=n.specularMap,t(n.specularMap,I.specularMapTransform)),n.alphaTest>0&&(I.alphaTest.value=n.alphaTest);const i=g.get(n).envMap;if(i&&(I.envMap.value=i,I.flipEnvMap.value=i.isCubeTexture&&!1===i.isRenderTargetTexture?-1:1,I.reflectivity.value=n.reflectivity,I.ior.value=n.ior,I.refractionRatio.value=n.refractionRatio),n.lightMap){I.lightMap.value=n.lightMap;const g=!0===e._useLegacyLights?Math.PI:1;I.lightMapIntensity.value=n.lightMapIntensity*g,t(n.lightMap,I.lightMapTransform)}n.aoMap&&(I.aoMap.value=n.aoMap,I.aoMapIntensity.value=n.aoMapIntensity,t(n.aoMap,I.aoMapTransform))}return{refreshFogUniforms:function(g,t){t.color.getRGB(g.fogColor.value,sC(e)),t.isFog?(g.fogNear.value=t.near,g.fogFar.value=t.far):t.isFogExp2&&(g.fogDensity.value=t.density)},refreshMaterialUniforms:function(e,n,i,C,o){n.isMeshBasicMaterial||n.isMeshLambertMaterial?I(e,n):n.isMeshToonMaterial?(I(e,n),function(e,g){g.gradientMap&&(e.gradientMap.value=g.gradientMap)}(e,n)):n.isMeshPhongMaterial?(I(e,n),function(e,g){e.specular.value.copy(g.specular),e.shininess.value=Math.max(g.shininess,1e-4)}(e,n)):n.isMeshStandardMaterial?(I(e,n),function(e,I){e.metalness.value=I.metalness,I.metalnessMap&&(e.metalnessMap.value=I.metalnessMap,t(I.metalnessMap,e.metalnessMapTransform)),e.roughness.value=I.roughness,I.roughnessMap&&(e.roughnessMap.value=I.roughnessMap,t(I.roughnessMap,e.roughnessMapTransform));g.get(I).envMap&&(e.envMapIntensity.value=I.envMapIntensity)}(e,n),n.isMeshPhysicalMaterial&&function(e,g,I){e.ior.value=g.ior,g.sheen>0&&(e.sheenColor.value.copy(g.sheenColor).multiplyScalar(g.sheen),e.sheenRoughness.value=g.sheenRoughness,g.sheenColorMap&&(e.sheenColorMap.value=g.sheenColorMap,t(g.sheenColorMap,e.sheenColorMapTransform)),g.sheenRoughnessMap&&(e.sheenRoughnessMap.value=g.sheenRoughnessMap,t(g.sheenRoughnessMap,e.sheenRoughnessMapTransform))),g.clearcoat>0&&(e.clearcoat.value=g.clearcoat,e.clearcoatRoughness.value=g.clearcoatRoughness,g.clearcoatMap&&(e.clearcoatMap.value=g.clearcoatMap,t(g.clearcoatMap,e.clearcoatMapTransform)),g.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=g.clearcoatRoughnessMap,t(g.clearcoatRoughnessMap,e.clearcoatRoughnessMapTransform)),g.clearcoatNormalMap&&(e.clearcoatNormalMap.value=g.clearcoatNormalMap,t(g.clearcoatNormalMap,e.clearcoatNormalMapTransform),e.clearcoatNormalScale.value.copy(g.clearcoatNormalScale),g.side===S&&e.clearcoatNormalScale.value.negate())),g.iridescence>0&&(e.iridescence.value=g.iridescence,e.iridescenceIOR.value=g.iridescenceIOR,e.iridescenceThicknessMinimum.value=g.iridescenceThicknessRange[0],e.iridescenceThicknessMaximum.value=g.iridescenceThicknessRange[1],g.iridescenceMap&&(e.iridescenceMap.value=g.iridescenceMap,t(g.iridescenceMap,e.iridescenceMapTransform)),g.iridescenceThicknessMap&&(e.iridescenceThicknessMap.value=g.iridescenceThicknessMap,t(g.iridescenceThicknessMap,e.iridescenceThicknessMapTransform))),g.transmission>0&&(e.transmission.value=g.transmission,e.transmissionSamplerMap.value=I.texture,e.transmissionSamplerSize.value.set(I.width,I.height),g.transmissionMap&&(e.transmissionMap.value=g.transmissionMap,t(g.transmissionMap,e.transmissionMapTransform)),e.thickness.value=g.thickness,g.thicknessMap&&(e.thicknessMap.value=g.thicknessMap,t(g.thicknessMap,e.thicknessMapTransform)),e.attenuationDistance.value=g.attenuationDistance,e.attenuationColor.value.copy(g.attenuationColor)),g.anisotropy>0&&(e.anisotropyVector.value.set(g.anisotropy*Math.cos(g.anisotropyRotation),g.anisotropy*Math.sin(g.anisotropyRotation)),g.anisotropyMap&&(e.anisotropyMap.value=g.anisotropyMap,t(g.anisotropyMap,e.anisotropyMapTransform))),e.specularIntensity.value=g.specularIntensity,e.specularColor.value.copy(g.specularColor),g.specularColorMap&&(e.specularColorMap.value=g.specularColorMap,t(g.specularColorMap,e.specularColorMapTransform)),g.specularIntensityMap&&(e.specularIntensityMap.value=g.specularIntensityMap,t(g.specularIntensityMap,e.specularIntensityMapTransform))}(e,n,o)):n.isMeshMatcapMaterial?(I(e,n),function(e,g){g.matcap&&(e.matcap.value=g.matcap)}(e,n)):n.isMeshDepthMaterial?I(e,n):n.isMeshDistanceMaterial?(I(e,n),function(e,t){const I=g.get(t).light;e.referencePosition.value.setFromMatrixPosition(I.matrixWorld),e.nearDistance.value=I.shadow.camera.near,e.farDistance.value=I.shadow.camera.far}(e,n)):n.isMeshNormalMaterial?I(e,n):n.isLineBasicMaterial?(function(e,g){e.diffuse.value.copy(g.color),e.opacity.value=g.opacity,g.map&&(e.map.value=g.map,t(g.map,e.mapTransform))}(e,n),n.isLineDashedMaterial&&function(e,g){e.dashSize.value=g.dashSize,e.totalSize.value=g.dashSize+g.gapSize,e.scale.value=g.scale}(e,n)):n.isPointsMaterial?function(e,g,I,n){e.diffuse.value.copy(g.color),e.opacity.value=g.opacity,e.size.value=g.size*I,e.scale.value=.5*n,g.map&&(e.map.value=g.map,t(g.map,e.uvTransform)),g.alphaMap&&(e.alphaMap.value=g.alphaMap,t(g.alphaMap,e.alphaMapTransform)),g.alphaTest>0&&(e.alphaTest.value=g.alphaTest)}(e,n,i,C):n.isSpriteMaterial?function(e,g){e.diffuse.value.copy(g.color),e.opacity.value=g.opacity,e.rotation.value=g.rotation,g.map&&(e.map.value=g.map,t(g.map,e.mapTransform)),g.alphaMap&&(e.alphaMap.value=g.alphaMap,t(g.alphaMap,e.alphaMapTransform)),g.alphaTest>0&&(e.alphaTest.value=g.alphaTest)}(e,n):n.isShadowMaterial?(e.color.value.copy(n.color),e.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function ts(e,g,t,I){let n={},i={},C=[];const o=t.isWebGL2?e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS):0;function a(e,g,t){const I=e.value;if(void 0===t[g]){if("number"==typeof I)t[g]=I;else{const e=Array.isArray(I)?I:[I],n=[];for(let g=0;g<e.length;g++)n.push(e[g].clone());t[g]=n}return!0}if("number"==typeof I){if(t[g]!==I)return t[g]=I,!0}else{const e=Array.isArray(t[g])?t[g]:[t[g]],n=Array.isArray(I)?I:[I];for(let g=0;g<e.length;g++){const t=e[g];if(!1===t.equals(n[g]))return t.copy(n[g]),!0}}return!1}function s(e){const g={boundary:0,storage:0};return"number"==typeof e?(g.boundary=4,g.storage=4):e.isVector2?(g.boundary=8,g.storage=8):e.isVector3||e.isColor?(g.boundary=16,g.storage=12):e.isVector4?(g.boundary=16,g.storage=16):e.isMatrix3?(g.boundary=48,g.storage=48):e.isMatrix4?(g.boundary=64,g.storage=64):e.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",e),g}function l(g){const t=g.target;t.removeEventListener("dispose",l);const I=C.indexOf(t.__bindingPointIndex);C.splice(I,1),e.deleteBuffer(n[t.id]),delete n[t.id],delete i[t.id]}return{bind:function(e,g){const t=g.program;I.uniformBlockBinding(e,t)},update:function(t,r){let A=n[t.id];void 0===A&&(function(e){const g=e.uniforms;let t=0;let I=0;for(let e=0,n=g.length;e<n;e++){const n=g[e],i={boundary:0,storage:0},C=Array.isArray(n.value)?n.value:[n.value];for(let e=0,g=C.length;e<g;e++){const g=s(C[e]);i.boundary+=g.boundary,i.storage+=g.storage}n.__data=new Float32Array(i.storage/Float32Array.BYTES_PER_ELEMENT),n.__offset=t,e>0&&(I=t%16,0!==I&&16-I-i.boundary<0&&(t+=16-I,n.__offset=t)),t+=i.storage}I=t%16,I>0&&(t+=16-I),e.__size=t,e.__cache={}}(t),A=function(g){const t=function(){for(let e=0;e<o;e++)if(-1===C.indexOf(e))return C.push(e),e;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}();g.__bindingPointIndex=t;const I=e.createBuffer(),n=g.__size,i=g.usage;return e.bindBuffer(e.UNIFORM_BUFFER,I),e.bufferData(e.UNIFORM_BUFFER,n,i),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,t,I),I}(t),n[t.id]=A,t.addEventListener("dispose",l));const c=r.program;I.updateUBOMapping(t,c);const d=g.render.frame;i[t.id]!==d&&(function(g){const t=n[g.id],I=g.uniforms,i=g.__cache;e.bindBuffer(e.UNIFORM_BUFFER,t);for(let g=0,t=I.length;g<t;g++){const t=I[g];if(!0===a(t,g,i)){const g=t.__offset,I=Array.isArray(t.value)?t.value:[t.value];let n=0;for(let i=0;i<I.length;i++){const C=I[i],o=s(C);"number"==typeof C?(t.__data[0]=C,e.bufferSubData(e.UNIFORM_BUFFER,g+n,t.__data)):C.isMatrix3?(t.__data[0]=C.elements[0],t.__data[1]=C.elements[1],t.__data[2]=C.elements[2],t.__data[3]=C.elements[0],t.__data[4]=C.elements[3],t.__data[5]=C.elements[4],t.__data[6]=C.elements[5],t.__data[7]=C.elements[0],t.__data[8]=C.elements[6],t.__data[9]=C.elements[7],t.__data[10]=C.elements[8],t.__data[11]=C.elements[0]):(C.toArray(t.__data,n),n+=o.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,g,t.__data)}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(t),i[t.id]=d)},dispose:function(){for(const g in n)e.deleteBuffer(n[g]);C=[],n={},i={}}}}class Is{constructor(e={}){const{canvas:g=pI(),context:t=null,depth:I=!0,stencil:n=!0,alpha:i=!1,antialias:C=!1,premultipliedAlpha:o=!0,preserveDrawingBuffer:a=!1,powerPreference:s="default",failIfMajorPerformanceCaveat:l=!1}=e;let r;this.isWebGLRenderer=!0,r=null!==t?t.getContextAttributes().alpha:i;const A=new Uint32Array(4),c=new Int32Array(4);let d=null,u=null;const h=[],b=[];this.domElement=g,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=it,this._useLegacyLights=!1,this.toneMapping=ce,this.toneMappingExposure=1;const m=this;let G=!1,B=0,Z=0,y=null,v=-1,W=null;const f=new FI,w=new FI;let R=null;const V=new Ai(0);let K=0,H=g.width,N=g.height,F=1,x=null,z=null;const k=new FI(0,0,H,N),M=new FI(0,0,H,N);let L=!1;const J=new vC;let E=!1,T=!1,U=null;const Q=new Zn,D=new AI,O=new UI,j={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function P(){return null===y?F:1}let _,q,$,ee,ge,te,Ie,ne,ie,Ce,oe,ae,se,le,re,Ae,de,ue,he,be,me,pe,Ge,Be,Ze=t;function ye(e,t){for(let I=0;I<e.length;I++){const n=e[I],i=g.getContext(n,t);if(null!==i)return i}return null}try{const e={alpha:!0,depth:I,stencil:n,antialias:C,premultipliedAlpha:o,preserveDrawingBuffer:a,powerPreference:s,failIfMajorPerformanceCaveat:l};if("setAttribute"in g&&g.setAttribute("data-engine",`three.js r${p}`),g.addEventListener("webglcontextlost",fe,!1),g.addEventListener("webglcontextrestored",we,!1),g.addEventListener("webglcontextcreationerror",Re,!1),null===Ze){const g=["webgl2","webgl","experimental-webgl"];if(!0===m.isWebGL1Renderer&&g.shift(),Ze=ye(g,e),null===Ze)throw ye(g)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}"undefined"!=typeof WebGLRenderingContext&&Ze instanceof WebGLRenderingContext&&console.warn("THREE.WebGLRenderer: WebGL 1 support was deprecated in r153 and will be removed in r163."),void 0===Ze.getShaderPrecisionFormat&&(Ze.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}function ve(){_=new qC(Ze),q=new NC(Ze,_,e),_.init(q),pe=new Oa(Ze,_,q),$=new Qa(Ze,_,q),ee=new go(Ze),ge=new Ya,te=new Da(Ze,_,$,ge,q,pe,ee),Ie=new xC(m),ne=new _C(m),ie=new fC(Ze,q),Ge=new KC(Ze,_,ie,q),Ce=new $C(Ze,ie,ee,Ge),oe=new io(Ze,Ce,ie,ee),he=new no(Ze,q,te),Ae=new FC(ge),ae=new Sa(m,Ie,ne,_,q,Ge,Ae),se=new gs(m,ge),le=new Fa,re=new Ja(_,q),ue=new YC(m,Ie,ne,$,oe,r,o),de=new Ua(m,oe,q),Be=new ts(Ze,ee,q,$),be=new HC(Ze,_,ee,q),me=new eo(Ze,_,ee,q),ee.programs=ae.programs,m.capabilities=q,m.extensions=_,m.properties=ge,m.renderLists=le,m.shadowMap=de,m.state=$,m.info=ee}ve();const We=new es(m,Ze);function fe(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),G=!0}function we(){console.log("THREE.WebGLRenderer: Context Restored."),G=!1;const e=ee.autoReset,g=de.enabled,t=de.autoUpdate,I=de.needsUpdate,n=de.type;ve(),ee.autoReset=e,de.enabled=g,de.autoUpdate=t,de.needsUpdate=I,de.type=n}function Re(e){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function Ve(e){const g=e.target;g.removeEventListener("dispose",Ve),function(e){(function(e){const g=ge.get(e).programs;void 0!==g&&(g.forEach((function(e){ae.releaseProgram(e)})),e.isShaderMaterial&&ae.releaseShaderCache(e))})(e),ge.remove(e)}(g)}this.xr=We,this.getContext=function(){return Ze},this.getContextAttributes=function(){return Ze.getContextAttributes()},this.forceContextLoss=function(){const e=_.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=_.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return F},this.setPixelRatio=function(e){void 0!==e&&(F=e,this.setSize(H,N,!1))},this.getSize=function(e){return e.set(H,N)},this.setSize=function(e,t,I=!0){We.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(H=e,N=t,g.width=Math.floor(e*F),g.height=Math.floor(t*F),!0===I&&(g.style.width=e+"px",g.style.height=t+"px"),this.setViewport(0,0,e,t))},this.getDrawingBufferSize=function(e){return e.set(H*F,N*F).floor()},this.setDrawingBufferSize=function(e,t,I){H=e,N=t,F=I,g.width=Math.floor(e*I),g.height=Math.floor(t*I),this.setViewport(0,0,e,t)},this.getCurrentViewport=function(e){return e.copy(f)},this.getViewport=function(e){return e.copy(k)},this.setViewport=function(e,g,t,I){e.isVector4?k.set(e.x,e.y,e.z,e.w):k.set(e,g,t,I),$.viewport(f.copy(k).multiplyScalar(F).floor())},this.getScissor=function(e){return e.copy(M)},this.setScissor=function(e,g,t,I){e.isVector4?M.set(e.x,e.y,e.z,e.w):M.set(e,g,t,I),$.scissor(w.copy(M).multiplyScalar(F).floor())},this.getScissorTest=function(){return L},this.setScissorTest=function(e){$.setScissorTest(L=e)},this.setOpaqueSort=function(e){x=e},this.setTransparentSort=function(e){z=e},this.getClearColor=function(e){return e.copy(ue.getClearColor())},this.setClearColor=function(){ue.setClearColor.apply(ue,arguments)},this.getClearAlpha=function(){return ue.getClearAlpha()},this.setClearAlpha=function(){ue.setClearAlpha.apply(ue,arguments)},this.clear=function(e=!0,g=!0,t=!0){let I=0;if(e){let e=!1;if(null!==y){const g=y.texture.format;e=g===ig||g===ng||g===tg}if(e){const e=y.texture.type,g=e===ze||e===Ee||e===Le||e===Oe||e===Qe||e===De,t=ue.getClearColor(),I=ue.getClearAlpha(),n=t.r,i=t.g,C=t.b;g?(A[0]=n,A[1]=i,A[2]=C,A[3]=I,Ze.clearBufferuiv(Ze.COLOR,0,A)):(c[0]=n,c[1]=i,c[2]=C,c[3]=I,Ze.clearBufferiv(Ze.COLOR,0,c))}else I|=Ze.COLOR_BUFFER_BIT}g&&(I|=Ze.DEPTH_BUFFER_BIT),t&&(I|=Ze.STENCIL_BUFFER_BIT),Ze.clear(I)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){g.removeEventListener("webglcontextlost",fe,!1),g.removeEventListener("webglcontextrestored",we,!1),g.removeEventListener("webglcontextcreationerror",Re,!1),le.dispose(),re.dispose(),ge.dispose(),Ie.dispose(),ne.dispose(),oe.dispose(),Ge.dispose(),Be.dispose(),ae.dispose(),We.dispose(),We.removeEventListener("sessionstart",Se),We.removeEventListener("sessionend",Ye),U&&(U.dispose(),U=null),Ke.stop()},this.renderBufferDirect=function(e,g,t,I,n,i){null===g&&(g=j);const C=n.isMesh&&n.matrixWorld.determinant()<0,o=function(e,g,t,I,n){!0!==g.isScene&&(g=j),te.resetTextureUnits();const i=g.fog,C=I.isMeshStandardMaterial?g.environment:null,o=null===y?m.outputColorSpace:!0===y.isXRRenderTarget?y.texture.colorSpace:Ct,a=(I.isMeshStandardMaterial?ne:Ie).get(I.envMap||C),s=!0===I.vertexColors&&!!t.attributes.color&&4===t.attributes.color.itemSize,l=!!t.attributes.tangent&&(!!I.normalMap||I.anisotropy>0),r=!!t.morphAttributes.position,A=!!t.morphAttributes.normal,c=!!t.morphAttributes.color;let d=ce;I.toneMapped&&(null!==y&&!0!==y.isXRRenderTarget||(d=m.toneMapping));const h=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,b=void 0!==h?h.length:0,p=ge.get(I),G=u.state.lights;if(!0===E&&(!0===T||e!==W)){const g=e===W&&I.id===v;Ae.setState(I,e,g)}let B=!1;I.version===p.__version?p.needsLights&&p.lightsStateVersion!==G.state.version||p.outputColorSpace!==o||n.isInstancedMesh&&!1===p.instancing?B=!0:n.isInstancedMesh||!0!==p.instancing?n.isSkinnedMesh&&!1===p.skinning?B=!0:n.isSkinnedMesh||!0!==p.skinning?n.isInstancedMesh&&!0===p.instancingColor&&null===n.instanceColor||n.isInstancedMesh&&!1===p.instancingColor&&null!==n.instanceColor||p.envMap!==a||!0===I.fog&&p.fog!==i?B=!0:void 0===p.numClippingPlanes||p.numClippingPlanes===Ae.numPlanes&&p.numIntersection===Ae.numIntersection?(p.vertexAlphas!==s||p.vertexTangents!==l||p.morphTargets!==r||p.morphNormals!==A||p.morphColors!==c||p.toneMapping!==d||!0===q.isWebGL2&&p.morphTargetsCount!==b)&&(B=!0):B=!0:B=!0:B=!0:(B=!0,p.__version=I.version);let Z=p.currentProgram;!0===B&&(Z=Me(I,g,n));let f=!1,w=!1,R=!1;const V=Z.getUniforms(),X=p.uniforms;if($.useProgram(Z.program)&&(f=!0,w=!0,R=!0),I.id!==v&&(v=I.id,w=!0),f||W!==e){V.setValue(Ze,"projectionMatrix",e.projectionMatrix),V.setValue(Ze,"viewMatrix",e.matrixWorldInverse);const g=V.map.cameraPosition;void 0!==g&&g.setValue(Ze,O.setFromMatrixPosition(e.matrixWorld)),q.logarithmicDepthBuffer&&V.setValue(Ze,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(I.isMeshPhongMaterial||I.isMeshToonMaterial||I.isMeshLambertMaterial||I.isMeshBasicMaterial||I.isMeshStandardMaterial||I.isShaderMaterial)&&V.setValue(Ze,"isOrthographic",!0===e.isOrthographicCamera),W!==e&&(W=e,w=!0,R=!0)}if(n.isSkinnedMesh){V.setOptional(Ze,n,"bindMatrix"),V.setOptional(Ze,n,"bindMatrixInverse");const e=n.skeleton;e&&(q.floatVertexTextures?(null===e.boneTexture&&e.computeBoneTexture(),V.setValue(Ze,"boneTexture",e.boneTexture,te),V.setValue(Ze,"boneTextureSize",e.boneTextureSize)):console.warn("THREE.WebGLRenderer: SkinnedMesh can only be used with WebGL 2. With WebGL 1 OES_texture_float and vertex textures support is required."))}const S=t.morphAttributes;var Y,K;if((void 0!==S.position||void 0!==S.normal||void 0!==S.color&&!0===q.isWebGL2)&&he.update(n,t,Z),(w||p.receiveShadow!==n.receiveShadow)&&(p.receiveShadow=n.receiveShadow,V.setValue(Ze,"receiveShadow",n.receiveShadow)),I.isMeshGouraudMaterial&&null!==I.envMap&&(X.envMap.value=a,X.flipEnvMap.value=a.isCubeTexture&&!1===a.isRenderTargetTexture?-1:1),w&&(V.setValue(Ze,"toneMappingExposure",m.toneMappingExposure),p.needsLights&&(K=R,(Y=X).ambientLightColor.needsUpdate=K,Y.lightProbe.needsUpdate=K,Y.directionalLights.needsUpdate=K,Y.directionalLightShadows.needsUpdate=K,Y.pointLights.needsUpdate=K,Y.pointLightShadows.needsUpdate=K,Y.spotLights.needsUpdate=K,Y.spotLightShadows.needsUpdate=K,Y.rectAreaLights.needsUpdate=K,Y.hemisphereLights.needsUpdate=K),i&&!0===I.fog&&se.refreshFogUniforms(X,i),se.refreshMaterialUniforms(X,I,F,N,U),la.upload(Ze,p.uniformsList,X,te)),I.isShaderMaterial&&!0===I.uniformsNeedUpdate&&(la.upload(Ze,p.uniformsList,X,te),I.uniformsNeedUpdate=!1),I.isSpriteMaterial&&V.setValue(Ze,"center",n.center),V.setValue(Ze,"modelViewMatrix",n.modelViewMatrix),V.setValue(Ze,"normalMatrix",n.normalMatrix),V.setValue(Ze,"modelMatrix",n.matrixWorld),I.isShaderMaterial||I.isRawShaderMaterial){const e=I.uniformsGroups;for(let g=0,t=e.length;g<t;g++)if(q.isWebGL2){const t=e[g];Be.update(t,Z),Be.bind(t,Z)}else console.warn("THREE.WebGLRenderer: Uniform Buffer Objects can only be used with WebGL 2.")}return Z}(e,g,t,I,n);$.setMaterial(I,C);let a=t.index,s=1;if(!0===I.wireframe){if(a=Ce.getWireframeAttribute(t),void 0===a)return;s=2}const l=t.drawRange,r=t.attributes.position;let A=l.start*s,c=(l.start+l.count)*s;null!==i&&(A=Math.max(A,i.start*s),c=Math.min(c,(i.start+i.count)*s)),null!==a?(A=Math.max(A,0),c=Math.min(c,a.count)):null!=r&&(A=Math.max(A,0),c=Math.min(c,r.count));const d=c-A;if(d<0||d===1/0)return;let h;Ge.setup(n,I,o,t,a);let b=be;if(null!==a&&(h=ie.get(a),b=me,b.setIndex(h)),n.isMesh)!0===I.wireframe?($.setLineWidth(I.wireframeLinewidth*P()),b.setMode(Ze.LINES)):b.setMode(Ze.TRIANGLES);else if(n.isLine){let e=I.linewidth;void 0===e&&(e=1),$.setLineWidth(e*P()),n.isLineSegments?b.setMode(Ze.LINES):n.isLineLoop?b.setMode(Ze.LINE_LOOP):b.setMode(Ze.LINE_STRIP)}else n.isPoints?b.setMode(Ze.POINTS):n.isSprite&&b.setMode(Ze.TRIANGLES);if(n.isInstancedMesh)b.renderInstances(A,d,n.count);else if(t.isInstancedBufferGeometry){const e=void 0!==t._maxInstanceCount?t._maxInstanceCount:1/0,g=Math.min(t.instanceCount,e);b.renderInstances(A,d,g)}else b.render(A,d)},this.compile=function(e,g){function t(e,g,t){!0===e.transparent&&e.side===Y&&!1===e.forceSinglePass?(e.side=S,e.needsUpdate=!0,Me(e,g,t),e.side=X,e.needsUpdate=!0,Me(e,g,t),e.side=Y):Me(e,g,t)}u=re.get(e),u.init(),b.push(u),e.traverseVisible((function(e){e.isLight&&e.layers.test(g.layers)&&(u.pushLight(e),e.castShadow&&u.pushShadow(e))})),u.setupLights(m._useLegacyLights),e.traverse((function(g){const I=g.material;if(I)if(Array.isArray(I))for(let n=0;n<I.length;n++)t(I[n],e,g);else t(I,e,g)})),b.pop(),u=null};let Xe=null;function Se(){Ke.stop()}function Ye(){Ke.start()}const Ke=new WC;function He(e,g,t,I){if(!1===e.visible)return;if(e.layers.test(g.layers))if(e.isGroup)t=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(g);else if(e.isLight)u.pushLight(e),e.castShadow&&u.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||J.intersectsSprite(e)){I&&O.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Q);const g=oe.update(e),n=e.material;n.visible&&d.push(e,g,n,t,O.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||J.intersectsObject(e))){const g=oe.update(e),n=e.material;if(I&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),O.copy(e.boundingSphere.center)):(null===g.boundingSphere&&g.computeBoundingSphere(),O.copy(g.boundingSphere.center)),O.applyMatrix4(e.matrixWorld).applyMatrix4(Q)),Array.isArray(n)){const I=g.groups;for(let i=0,C=I.length;i<C;i++){const C=I[i],o=n[C.materialIndex];o&&o.visible&&d.push(e,g,o,t,O.z,C)}}else n.visible&&d.push(e,g,n,t,O.z,null)}const n=e.children;for(let e=0,i=n.length;e<i;e++)He(n[e],g,t,I)}function Ne(e,g,t,I){const n=e.opaque,i=e.transmissive,C=e.transparent;u.setupLightsView(t),!0===E&&Ae.setGlobalState(m.clippingPlanes,t),i.length>0&&function(e,g,t,I){const n=q.isWebGL2;null===U&&(U=new zI(1,1,{generateMipmaps:!0,type:_.has("EXT_color_buffer_half_float")?Ue:ze,minFilter:Fe,samples:n?4:0})),m.getDrawingBufferSize(D),n?U.setSize(D.x,D.y):U.setSize(aI(D.x),aI(D.y));const i=m.getRenderTarget();m.setRenderTarget(U),m.getClearColor(V),K=m.getClearAlpha(),K<1&&m.setClearColor(16777215,.5),m.clear();const C=m.toneMapping;m.toneMapping=ce,xe(e,t,I),te.updateMultisampleRenderTarget(U),te.updateRenderTargetMipmap(U);let o=!1;for(let e=0,n=g.length;e<n;e++){const n=g[e],i=n.object,C=n.geometry,a=n.material,s=n.group;if(a.side===Y&&i.layers.test(I.layers)){const e=a.side;a.side=S,a.needsUpdate=!0,ke(i,t,I,C,a,s),a.side=e,a.needsUpdate=!0,o=!0}}!0===o&&(te.updateMultisampleRenderTarget(U),te.updateRenderTargetMipmap(U)),m.setRenderTarget(i),m.setClearColor(V,K),m.toneMapping=C}(n,i,g,t),I&&$.viewport(f.copy(I)),n.length>0&&xe(n,g,t),i.length>0&&xe(i,g,t),C.length>0&&xe(C,g,t),$.buffers.depth.setTest(!0),$.buffers.depth.setMask(!0),$.buffers.color.setMask(!0),$.setPolygonOffset(!1)}function xe(e,g,t){const I=!0===g.isScene?g.overrideMaterial:null;for(let n=0,i=e.length;n<i;n++){const i=e[n],C=i.object,o=i.geometry,a=null===I?i.material:I,s=i.group;C.layers.test(t.layers)&&ke(C,g,t,o,a,s)}}function ke(e,g,t,I,n,i){e.onBeforeRender(m,g,t,I,n,i),e.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),n.onBeforeRender(m,g,t,I,e,i),!0===n.transparent&&n.side===Y&&!1===n.forceSinglePass?(n.side=S,n.needsUpdate=!0,m.renderBufferDirect(t,g,I,n,e,i),n.side=X,n.needsUpdate=!0,m.renderBufferDirect(t,g,I,n,e,i),n.side=Y):m.renderBufferDirect(t,g,I,n,e,i),e.onAfterRender(m,g,t,I,n,i)}function Me(e,g,t){!0!==g.isScene&&(g=j);const I=ge.get(e),n=u.state.lights,i=u.state.shadowsArray,C=n.state.version,o=ae.getParameters(e,n.state,i,g,t),a=ae.getProgramCacheKey(o);let s=I.programs;I.environment=e.isMeshStandardMaterial?g.environment:null,I.fog=g.fog,I.envMap=(e.isMeshStandardMaterial?ne:Ie).get(e.envMap||I.environment),void 0===s&&(e.addEventListener("dispose",Ve),s=new Map,I.programs=s);let l=s.get(a);if(void 0!==l){if(I.currentProgram===l&&I.lightsStateVersion===C)return Je(e,o),l}else o.uniforms=ae.getUniforms(e),e.onBuild(t,o,m),e.onBeforeCompile(o,m),l=ae.acquireProgram(o,a),s.set(a,l),I.uniforms=o.uniforms;const r=I.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(r.clippingPlanes=Ae.uniform),Je(e,o),I.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),I.lightsStateVersion=C,I.needsLights&&(r.ambientLightColor.value=n.state.ambient,r.lightProbe.value=n.state.probe,r.directionalLights.value=n.state.directional,r.directionalLightShadows.value=n.state.directionalShadow,r.spotLights.value=n.state.spot,r.spotLightShadows.value=n.state.spotShadow,r.rectAreaLights.value=n.state.rectArea,r.ltc_1.value=n.state.rectAreaLTC1,r.ltc_2.value=n.state.rectAreaLTC2,r.pointLights.value=n.state.point,r.pointLightShadows.value=n.state.pointShadow,r.hemisphereLights.value=n.state.hemi,r.directionalShadowMap.value=n.state.directionalShadowMap,r.directionalShadowMatrix.value=n.state.directionalShadowMatrix,r.spotShadowMap.value=n.state.spotShadowMap,r.spotLightMatrix.value=n.state.spotLightMatrix,r.spotLightMap.value=n.state.spotLightMap,r.pointShadowMap.value=n.state.pointShadowMap,r.pointShadowMatrix.value=n.state.pointShadowMatrix);const A=l.getUniforms(),c=la.seqWithValue(A.seq,r);return I.currentProgram=l,I.uniformsList=c,l}function Je(e,g){const t=ge.get(e);t.outputColorSpace=g.outputColorSpace,t.instancing=g.instancing,t.instancingColor=g.instancingColor,t.skinning=g.skinning,t.morphTargets=g.morphTargets,t.morphNormals=g.morphNormals,t.morphColors=g.morphColors,t.morphTargetsCount=g.morphTargetsCount,t.numClippingPlanes=g.numClippingPlanes,t.numIntersection=g.numClipIntersection,t.vertexAlphas=g.vertexAlphas,t.vertexTangents=g.vertexTangents,t.toneMapping=g.toneMapping}Ke.setAnimationLoop((function(e){Xe&&Xe(e)})),"undefined"!=typeof self&&Ke.setContext(self),this.setAnimationLoop=function(e){Xe=e,We.setAnimationLoop(e),null===e?Ke.stop():Ke.start()},We.addEventListener("sessionstart",Se),We.addEventListener("sessionend",Ye),this.render=function(e,g){if(void 0!==g&&!0!==g.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===G)return;!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===g.parent&&!0===g.matrixWorldAutoUpdate&&g.updateMatrixWorld(),!0===We.enabled&&!0===We.isPresenting&&(!0===We.cameraAutoUpdate&&We.updateCamera(g),g=We.getCamera()),!0===e.isScene&&e.onBeforeRender(m,e,g,y),u=re.get(e,b.length),u.init(),b.push(u),Q.multiplyMatrices(g.projectionMatrix,g.matrixWorldInverse),J.setFromProjectionMatrix(Q),T=this.localClippingEnabled,E=Ae.init(this.clippingPlanes,T),d=le.get(e,h.length),d.init(),h.push(d),He(e,g,0,m.sortObjects),d.finish(),!0===m.sortObjects&&d.sort(x,z),this.info.render.frame++,!0===E&&Ae.beginShadows();const t=u.state.shadowsArray;if(de.render(t,e,g),!0===E&&Ae.endShadows(),!0===this.info.autoReset&&this.info.reset(),ue.render(d,e),u.setupLights(m._useLegacyLights),g.isArrayCamera){const t=g.cameras;for(let g=0,I=t.length;g<I;g++){const I=t[g];Ne(d,e,I,I.viewport)}}else Ne(d,e,g);null!==y&&(te.updateMultisampleRenderTarget(y),te.updateRenderTargetMipmap(y)),!0===e.isScene&&e.onAfterRender(m,e,g),Ge.resetDefaultState(),v=-1,W=null,b.pop(),u=b.length>0?b[b.length-1]:null,h.pop(),d=h.length>0?h[h.length-1]:null},this.getActiveCubeFace=function(){return B},this.getActiveMipmapLevel=function(){return Z},this.getRenderTarget=function(){return y},this.setRenderTargetTextures=function(e,g,t){ge.get(e.texture).__webglTexture=g,ge.get(e.depthTexture).__webglTexture=t;const I=ge.get(e);I.__hasExternalTextures=!0,I.__hasExternalTextures&&(I.__autoAllocateDepthBuffer=void 0===t,I.__autoAllocateDepthBuffer||!0===_.has("WEBGL_multisampled_render_to_texture")&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),I.__useRenderToTexture=!1))},this.setRenderTargetFramebuffer=function(e,g){const t=ge.get(e);t.__webglFramebuffer=g,t.__useDefaultFramebuffer=void 0===g},this.setRenderTarget=function(e,g=0,t=0){y=e,B=g,Z=t;let I=!0,n=null,i=!1,C=!1;if(e){const o=ge.get(e);void 0!==o.__useDefaultFramebuffer?($.bindFramebuffer(Ze.FRAMEBUFFER,null),I=!1):void 0===o.__webglFramebuffer?te.setupRenderTarget(e):o.__hasExternalTextures&&te.rebindTextures(e,ge.get(e.texture).__webglTexture,ge.get(e.depthTexture).__webglTexture);const a=e.texture;(a.isData3DTexture||a.isDataArrayTexture||a.isCompressedArrayTexture)&&(C=!0);const s=ge.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=Array.isArray(s[g])?s[g][t]:s[g],i=!0):n=q.isWebGL2&&e.samples>0&&!1===te.useMultisampledRTT(e)?ge.get(e).__webglMultisampledFramebuffer:Array.isArray(s)?s[t]:s,f.copy(e.viewport),w.copy(e.scissor),R=e.scissorTest}else f.copy(k).multiplyScalar(F).floor(),w.copy(M).multiplyScalar(F).floor(),R=L;if($.bindFramebuffer(Ze.FRAMEBUFFER,n)&&q.drawBuffers&&I&&$.drawBuffers(e,n),$.viewport(f),$.scissor(w),$.setScissorTest(R),i){const I=ge.get(e.texture);Ze.framebufferTexture2D(Ze.FRAMEBUFFER,Ze.COLOR_ATTACHMENT0,Ze.TEXTURE_CUBE_MAP_POSITIVE_X+g,I.__webglTexture,t)}else if(C){const I=ge.get(e.texture),n=g||0;Ze.framebufferTextureLayer(Ze.FRAMEBUFFER,Ze.COLOR_ATTACHMENT0,I.__webglTexture,t||0,n)}v=-1},this.readRenderTargetPixels=function(e,g,t,I,n,i,C){if(!e||!e.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let o=ge.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==C&&(o=o[C]),o){$.bindFramebuffer(Ze.FRAMEBUFFER,o);try{const C=e.texture,o=C.format,a=C.type;if(o!==Pe&&pe.convert(o)!==Ze.getParameter(Ze.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");const s=a===Ue&&(_.has("EXT_color_buffer_half_float")||q.isWebGL2&&_.has("EXT_color_buffer_float"));if(!(a===ze||pe.convert(a)===Ze.getParameter(Ze.IMPLEMENTATION_COLOR_READ_TYPE)||a===Te&&(q.isWebGL2||_.has("OES_texture_float")||_.has("WEBGL_color_buffer_float"))||s))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");g>=0&&g<=e.width-I&&t>=0&&t<=e.height-n&&Ze.readPixels(g,t,I,n,pe.convert(o),pe.convert(a),i)}finally{const e=null!==y?ge.get(y).__webglFramebuffer:null;$.bindFramebuffer(Ze.FRAMEBUFFER,e)}}},this.copyFramebufferToTexture=function(e,g,t=0){const I=Math.pow(2,-t),n=Math.floor(g.image.width*I),i=Math.floor(g.image.height*I);te.setTexture2D(g,0),Ze.copyTexSubImage2D(Ze.TEXTURE_2D,t,0,0,e.x,e.y,n,i),$.unbindTexture()},this.copyTextureToTexture=function(e,g,t,I=0){const n=g.image.width,i=g.image.height,C=pe.convert(t.format),o=pe.convert(t.type);te.setTexture2D(t,0),Ze.pixelStorei(Ze.UNPACK_FLIP_Y_WEBGL,t.flipY),Ze.pixelStorei(Ze.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),Ze.pixelStorei(Ze.UNPACK_ALIGNMENT,t.unpackAlignment),g.isDataTexture?Ze.texSubImage2D(Ze.TEXTURE_2D,I,e.x,e.y,n,i,C,o,g.image.data):g.isCompressedTexture?Ze.compressedTexSubImage2D(Ze.TEXTURE_2D,I,e.x,e.y,g.mipmaps[0].width,g.mipmaps[0].height,C,g.mipmaps[0].data):Ze.texSubImage2D(Ze.TEXTURE_2D,I,e.x,e.y,C,o,g.image),0===I&&t.generateMipmaps&&Ze.generateMipmap(Ze.TEXTURE_2D),$.unbindTexture()},this.copyTextureToTexture3D=function(e,g,t,I,n=0){if(m.isWebGL1Renderer)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");const i=e.max.x-e.min.x+1,C=e.max.y-e.min.y+1,o=e.max.z-e.min.z+1,a=pe.convert(I.format),s=pe.convert(I.type);let l;if(I.isData3DTexture)te.setTexture3D(I,0),l=Ze.TEXTURE_3D;else{if(!I.isDataArrayTexture)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");te.setTexture2DArray(I,0),l=Ze.TEXTURE_2D_ARRAY}Ze.pixelStorei(Ze.UNPACK_FLIP_Y_WEBGL,I.flipY),Ze.pixelStorei(Ze.UNPACK_PREMULTIPLY_ALPHA_WEBGL,I.premultiplyAlpha),Ze.pixelStorei(Ze.UNPACK_ALIGNMENT,I.unpackAlignment);const r=Ze.getParameter(Ze.UNPACK_ROW_LENGTH),A=Ze.getParameter(Ze.UNPACK_IMAGE_HEIGHT),c=Ze.getParameter(Ze.UNPACK_SKIP_PIXELS),d=Ze.getParameter(Ze.UNPACK_SKIP_ROWS),u=Ze.getParameter(Ze.UNPACK_SKIP_IMAGES),h=t.isCompressedTexture?t.mipmaps[0]:t.image;Ze.pixelStorei(Ze.UNPACK_ROW_LENGTH,h.width),Ze.pixelStorei(Ze.UNPACK_IMAGE_HEIGHT,h.height),Ze.pixelStorei(Ze.UNPACK_SKIP_PIXELS,e.min.x),Ze.pixelStorei(Ze.UNPACK_SKIP_ROWS,e.min.y),Ze.pixelStorei(Ze.UNPACK_SKIP_IMAGES,e.min.z),t.isDataTexture||t.isData3DTexture?Ze.texSubImage3D(l,n,g.x,g.y,g.z,i,C,o,a,s,h.data):t.isCompressedArrayTexture?(console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: untested support for compressed srcTexture."),Ze.compressedTexSubImage3D(l,n,g.x,g.y,g.z,i,C,o,a,h.data)):Ze.texSubImage3D(l,n,g.x,g.y,g.z,i,C,o,a,s,h),Ze.pixelStorei(Ze.UNPACK_ROW_LENGTH,r),Ze.pixelStorei(Ze.UNPACK_IMAGE_HEIGHT,A),Ze.pixelStorei(Ze.UNPACK_SKIP_PIXELS,c),Ze.pixelStorei(Ze.UNPACK_SKIP_ROWS,d),Ze.pixelStorei(Ze.UNPACK_SKIP_IMAGES,u),0===n&&I.generateMipmaps&&Ze.generateMipmap(l),$.unbindTexture()},this.initTexture=function(e){e.isCubeTexture?te.setTextureCube(e,0):e.isData3DTexture?te.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?te.setTexture2DArray(e,0):te.setTexture2D(e,0),$.unbindTexture()},this.resetState=function(){B=0,Z=0,y=null,$.reset(),Ge.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return jt}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const g=this.getContext();g.drawingBufferColorSpace=e===ot?"display-p3":"srgb",g.unpackColorSpace=fI.workingColorSpace===at?"display-p3":"srgb"}get physicallyCorrectLights(){return console.warn("THREE.WebGLRenderer: The property .physicallyCorrectLights has been removed. Set renderer.useLegacyLights instead."),!this.useLegacyLights}set physicallyCorrectLights(e){console.warn("THREE.WebGLRenderer: The property .physicallyCorrectLights has been removed. Set renderer.useLegacyLights instead."),this.useLegacyLights=!e}get outputEncoding(){return console.warn("THREE.WebGLRenderer: Property .outputEncoding has been removed. Use .outputColorSpace instead."),this.outputColorSpace===it?$g:qg}set outputEncoding(e){console.warn("THREE.WebGLRenderer: Property .outputEncoding has been removed. Use .outputColorSpace instead."),this.outputColorSpace=e===$g?it:Ct}get useLegacyLights(){return console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights}set useLegacyLights(e){console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights=e}}class ns extends Is{}ns.prototype.isWebGL1Renderer=!0;class is{constructor(e,g=25e-5){this.isFogExp2=!0,this.name="",this.color=new Ai(e),this.density=g}clone(){return new is(this.color,this.density)}toJSON(){return{type:"FogExp2",name:this.name,color:this.color.getHex(),density:this.density}}}class Cs{constructor(e,g=1,t=1e3){this.isFog=!0,this.name="",this.color=new Ai(e),this.near=g,this.far=t}clone(){return new Cs(this.color,this.near,this.far)}toJSON(){return{type:"Fog",name:this.name,color:this.color.getHex(),near:this.near,far:this.far}}}class os extends Dn{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,g){return super.copy(e,g),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const g=super.toJSON(e);return null!==this.fog&&(g.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(g.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(g.object.backgroundIntensity=this.backgroundIntensity),g}}class as{constructor(e,g){this.isInterleavedBuffer=!0,this.array=e,this.stride=g,this.count=void 0!==e?e.length/g:0,this.usage=xt,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=tI()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,g,t){e*=this.stride,t*=g.stride;for(let I=0,n=this.stride;I<n;I++)this.array[e+I]=g.array[t+I];return this}set(e,g=0){return this.array.set(e,g),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=tI()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const g=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),t=new this.constructor(g,this.stride);return t.setUsage(this.usage),t}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=tI()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const ss=new UI;class ls{constructor(e,g,t,I=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=g,this.offset=t,this.normalized=I}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let g=0,t=this.data.count;g<t;g++)ss.fromBufferAttribute(this,g),ss.applyMatrix4(e),this.setXYZ(g,ss.x,ss.y,ss.z);return this}applyNormalMatrix(e){for(let g=0,t=this.count;g<t;g++)ss.fromBufferAttribute(this,g),ss.applyNormalMatrix(e),this.setXYZ(g,ss.x,ss.y,ss.z);return this}transformDirection(e){for(let g=0,t=this.count;g<t;g++)ss.fromBufferAttribute(this,g),ss.transformDirection(e),this.setXYZ(g,ss.x,ss.y,ss.z);return this}setX(e,g){return this.normalized&&(g=lI(g,this.array)),this.data.array[e*this.data.stride+this.offset]=g,this}setY(e,g){return this.normalized&&(g=lI(g,this.array)),this.data.array[e*this.data.stride+this.offset+1]=g,this}setZ(e,g){return this.normalized&&(g=lI(g,this.array)),this.data.array[e*this.data.stride+this.offset+2]=g,this}setW(e,g){return this.normalized&&(g=lI(g,this.array)),this.data.array[e*this.data.stride+this.offset+3]=g,this}getX(e){let g=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(g=sI(g,this.array)),g}getY(e){let g=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(g=sI(g,this.array)),g}getZ(e){let g=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(g=sI(g,this.array)),g}getW(e){let g=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(g=sI(g,this.array)),g}setXY(e,g,t){return e=e*this.data.stride+this.offset,this.normalized&&(g=lI(g,this.array),t=lI(t,this.array)),this.data.array[e+0]=g,this.data.array[e+1]=t,this}setXYZ(e,g,t,I){return e=e*this.data.stride+this.offset,this.normalized&&(g=lI(g,this.array),t=lI(t,this.array),I=lI(I,this.array)),this.data.array[e+0]=g,this.data.array[e+1]=t,this.data.array[e+2]=I,this}setXYZW(e,g,t,I,n){return e=e*this.data.stride+this.offset,this.normalized&&(g=lI(g,this.array),t=lI(t,this.array),I=lI(I,this.array),n=lI(n,this.array)),this.data.array[e+0]=g,this.data.array[e+1]=t,this.data.array[e+2]=I,this.data.array[e+3]=n,this}clone(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let g=0;g<this.count;g++){const t=g*this.data.stride+this.offset;for(let g=0;g<this.itemSize;g++)e.push(this.data.array[t+g])}return new Zi(new this.array.constructor(e),this.itemSize,this.normalized)}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new ls(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let g=0;g<this.count;g++){const t=g*this.data.stride+this.offset;for(let g=0;g<this.itemSize;g++)e.push(this.data.array[t+g])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class rs extends oi{constructor(e){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new Ai(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}let As;const cs=new UI,ds=new UI,us=new UI,hs=new AI,bs=new AI,ms=new Zn,ps=new UI,Gs=new UI,Bs=new UI,Zs=new AI,ys=new AI,vs=new AI;class Ws extends Dn{constructor(e=new rs){if(super(),this.isSprite=!0,this.type="Sprite",void 0===As){As=new Mi;const e=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),g=new as(e,5);As.setIndex([0,1,2,0,2,3]),As.setAttribute("position",new ls(g,3,0,!1)),As.setAttribute("uv",new ls(g,2,3,!1))}this.geometry=As,this.material=e,this.center=new AI(.5,.5)}raycast(e,g){null===e.camera&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),ds.setFromMatrixScale(this.matrixWorld),ms.copy(e.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(e.camera.matrixWorldInverse,this.matrixWorld),us.setFromMatrixPosition(this.modelViewMatrix),e.camera.isPerspectiveCamera&&!1===this.material.sizeAttenuation&&ds.multiplyScalar(-us.z);const t=this.material.rotation;let I,n;0!==t&&(n=Math.cos(t),I=Math.sin(t));const i=this.center;fs(ps.set(-.5,-.5,0),us,i,ds,I,n),fs(Gs.set(.5,-.5,0),us,i,ds,I,n),fs(Bs.set(.5,.5,0),us,i,ds,I,n),Zs.set(0,0),ys.set(1,0),vs.set(1,1);let C=e.ray.intersectTriangle(ps,Gs,Bs,!1,cs);if(null===C&&(fs(Gs.set(-.5,.5,0),us,i,ds,I,n),ys.set(0,1),C=e.ray.intersectTriangle(ps,Bs,Gs,!1,cs),null===C))return;const o=e.ray.origin.distanceTo(cs);o<e.near||o>e.far||g.push({distance:o,point:cs.clone(),uv:ii.getInterpolation(cs,ps,Gs,Bs,Zs,ys,vs,new AI),face:null,object:this})}copy(e,g){return super.copy(e,g),void 0!==e.center&&this.center.copy(e.center),this.material=e.material,this}}function fs(e,g,t,I,n,i){hs.subVectors(e,t).addScalar(.5).multiply(I),void 0!==n?(bs.x=i*hs.x-n*hs.y,bs.y=n*hs.x+i*hs.y):bs.copy(hs),e.copy(g),e.x+=bs.x,e.y+=bs.y,e.applyMatrix4(ms)}const ws=new UI,Rs=new UI;class Vs extends Dn{constructor(){super(),this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]},isLOD:{value:!0}}),this.autoUpdate=!0}copy(e){super.copy(e,!1);const g=e.levels;for(let e=0,t=g.length;e<t;e++){const t=g[e];this.addLevel(t.object.clone(),t.distance,t.hysteresis)}return this.autoUpdate=e.autoUpdate,this}addLevel(e,g=0,t=0){g=Math.abs(g);const I=this.levels;let n;for(n=0;n<I.length&&!(g<I[n].distance);n++);return I.splice(n,0,{distance:g,hysteresis:t,object:e}),this.add(e),this}getCurrentLevel(){return this._currentLevel}getObjectForDistance(e){const g=this.levels;if(g.length>0){let t,I;for(t=1,I=g.length;t<I;t++){let I=g[t].distance;if(g[t].object.visible&&(I-=I*g[t].hysteresis),e<I)break}return g[t-1].object}return null}raycast(e,g){if(this.levels.length>0){ws.setFromMatrixPosition(this.matrixWorld);const t=e.ray.origin.distanceTo(ws);this.getObjectForDistance(t).raycast(e,g)}}update(e){const g=this.levels;if(g.length>1){ws.setFromMatrixPosition(e.matrixWorld),Rs.setFromMatrixPosition(this.matrixWorld);const t=ws.distanceTo(Rs)/e.zoom;let I,n;for(g[0].object.visible=!0,I=1,n=g.length;I<n;I++){let e=g[I].distance;if(g[I].object.visible&&(e-=e*g[I].hysteresis),!(t>=e))break;g[I-1].object.visible=!1,g[I].object.visible=!0}for(this._currentLevel=I-1;I<n;I++)g[I].object.visible=!1}}toJSON(e){const g=super.toJSON(e);!1===this.autoUpdate&&(g.object.autoUpdate=!1),g.object.levels=[];const t=this.levels;for(let e=0,I=t.length;e<I;e++){const I=t[e];g.object.levels.push({object:I.object.uuid,distance:I.distance,hysteresis:I.hysteresis})}return g}}const Xs=new UI,Ss=new FI,Ys=new FI,Ks=new UI,Hs=new Zn,Ns=new UI,Fs=new cn,xs=new Zn,zs=new Bn;class ks extends nC{constructor(e,g){super(e,g),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Zn,this.bindMatrixInverse=new Zn,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){const e=this.geometry;null===this.boundingBox&&(this.boundingBox=new OI),this.boundingBox.makeEmpty();const g=e.getAttribute("position");for(let e=0;e<g.count;e++)Ns.fromBufferAttribute(g,e),this.applyBoneTransform(e,Ns),this.boundingBox.expandByPoint(Ns)}computeBoundingSphere(){const e=this.geometry;null===this.boundingSphere&&(this.boundingSphere=new cn),this.boundingSphere.makeEmpty();const g=e.getAttribute("position");for(let e=0;e<g.count;e++)Ns.fromBufferAttribute(g,e),this.applyBoneTransform(e,Ns),this.boundingSphere.expandByPoint(Ns)}copy(e,g){return super.copy(e,g),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}raycast(e,g){const t=this.material,I=this.matrixWorld;void 0!==t&&(null===this.boundingSphere&&this.computeBoundingSphere(),Fs.copy(this.boundingSphere),Fs.applyMatrix4(I),!1!==e.ray.intersectsSphere(Fs)&&(xs.copy(I).invert(),zs.copy(e.ray).applyMatrix4(xs),null!==this.boundingBox&&!1===zs.intersectsBox(this.boundingBox)||this._computeIntersections(e,g,zs)))}getVertexPosition(e,g){return super.getVertexPosition(e,g),this.applyBoneTransform(e,g),g}bind(e,g){this.skeleton=e,void 0===g&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),g=this.matrixWorld),this.bindMatrix.copy(g),this.bindMatrixInverse.copy(g).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const e=new FI,g=this.geometry.attributes.skinWeight;for(let t=0,I=g.count;t<I;t++){e.fromBufferAttribute(g,t);const I=1/e.manhattanLength();I!==1/0?e.multiplyScalar(I):e.set(1,0,0,0),g.setXYZW(t,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),"attached"===this.bindMode?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}applyBoneTransform(e,g){const t=this.skeleton,I=this.geometry;Ss.fromBufferAttribute(I.attributes.skinIndex,e),Ys.fromBufferAttribute(I.attributes.skinWeight,e),Xs.copy(g).applyMatrix4(this.bindMatrix),g.set(0,0,0);for(let e=0;e<4;e++){const I=Ys.getComponent(e);if(0!==I){const n=Ss.getComponent(e);Hs.multiplyMatrices(t.bones[n].matrixWorld,t.boneInverses[n]),g.addScaledVector(Ks.copy(Xs).applyMatrix4(Hs),I)}}return g.applyMatrix4(this.bindMatrixInverse)}boneTransform(e,g){return console.warn("THREE.SkinnedMesh: .boneTransform() was renamed to .applyBoneTransform() in r151."),this.applyBoneTransform(e,g)}}class Ms extends Dn{constructor(){super(),this.isBone=!0,this.type="Bone"}}class Ls extends NI{constructor(e=null,g=1,t=1,I,n,i,C,o,a=Re,s=Re,l,r){super(null,i,C,o,a,s,I,n,l,r),this.isDataTexture=!0,this.image={data:e,width:g,height:t},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}const Js=new Zn,Es=new Zn;class Ts{constructor(e=[],g=[]){this.uuid=tI(),this.bones=e.slice(0),this.boneInverses=g,this.boneMatrices=null,this.boneTexture=null,this.boneTextureSize=0,this.init()}init(){const e=this.bones,g=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===g.length)this.calculateInverses();else if(e.length!==g.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let e=0,g=this.bones.length;e<g;e++)this.boneInverses.push(new Zn)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,g=this.bones.length;e<g;e++){const g=new Zn;this.bones[e]&&g.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(g)}}pose(){for(let e=0,g=this.bones.length;e<g;e++){const g=this.bones[e];g&&g.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,g=this.bones.length;e<g;e++){const g=this.bones[e];g&&(g.parent&&g.parent.isBone?(g.matrix.copy(g.parent.matrixWorld).invert(),g.matrix.multiply(g.matrixWorld)):g.matrix.copy(g.matrixWorld),g.matrix.decompose(g.position,g.quaternion,g.scale))}}update(){const e=this.bones,g=this.boneInverses,t=this.boneMatrices,I=this.boneTexture;for(let I=0,n=e.length;I<n;I++){const n=e[I]?e[I].matrixWorld:Es;Js.multiplyMatrices(n,g[I]),Js.toArray(t,16*I)}null!==I&&(I.needsUpdate=!0)}clone(){return new Ts(this.bones,this.boneInverses)}computeBoneTexture(){let e=Math.sqrt(4*this.bones.length);e=oI(e),e=Math.max(e,4);const g=new Float32Array(e*e*4);g.set(this.boneMatrices);const t=new Ls(g,e,e,Pe,Te);return t.needsUpdate=!0,this.boneMatrices=g,this.boneTexture=t,this.boneTextureSize=e,this}getBoneByName(e){for(let g=0,t=this.bones.length;g<t;g++){const t=this.bones[g];if(t.name===e)return t}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,g){this.uuid=e.uuid;for(let t=0,I=e.bones.length;t<I;t++){const I=e.bones[t];let n=g[I];void 0===n&&(console.warn("THREE.Skeleton: No bone found with UUID:",I),n=new Ms),this.bones.push(n),this.boneInverses.push((new Zn).fromArray(e.boneInverses[t]))}return this.init(),this}toJSON(){const e={metadata:{version:4.6,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;const g=this.bones,t=this.boneInverses;for(let I=0,n=g.length;I<n;I++){const n=g[I];e.bones.push(n.uuid);const i=t[I];e.boneInverses.push(i.toArray())}return e}}class Us extends Zi{constructor(e,g,t,I=1){super(e,g,t),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=I}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}const Qs=new Zn,Ds=new Zn,Os=[],js=new OI,Ps=new Zn,_s=new nC,qs=new cn;class $s extends nC{constructor(e,g,t){super(e,g),this.isInstancedMesh=!0,this.instanceMatrix=new Us(new Float32Array(16*t),16),this.instanceColor=null,this.count=t,this.boundingBox=null,this.boundingSphere=null;for(let e=0;e<t;e++)this.setMatrixAt(e,Ps)}computeBoundingBox(){const e=this.geometry,g=this.count;null===this.boundingBox&&(this.boundingBox=new OI),null===e.boundingBox&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let t=0;t<g;t++)this.getMatrixAt(t,Qs),js.copy(e.boundingBox).applyMatrix4(Qs),this.boundingBox.union(js)}computeBoundingSphere(){const e=this.geometry,g=this.count;null===this.boundingSphere&&(this.boundingSphere=new cn),null===e.boundingSphere&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let t=0;t<g;t++)this.getMatrixAt(t,Qs),qs.copy(e.boundingSphere).applyMatrix4(Qs),this.boundingSphere.union(qs)}copy(e,g){return super.copy(e,g),this.instanceMatrix.copy(e.instanceMatrix),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}getColorAt(e,g){g.fromArray(this.instanceColor.array,3*e)}getMatrixAt(e,g){g.fromArray(this.instanceMatrix.array,16*e)}raycast(e,g){const t=this.matrixWorld,I=this.count;if(_s.geometry=this.geometry,_s.material=this.material,void 0!==_s.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),qs.copy(this.boundingSphere),qs.applyMatrix4(t),!1!==e.ray.intersectsSphere(qs)))for(let n=0;n<I;n++){this.getMatrixAt(n,Qs),Ds.multiplyMatrices(t,Qs),_s.matrixWorld=Ds,_s.raycast(e,Os);for(let e=0,t=Os.length;e<t;e++){const t=Os[e];t.instanceId=n,t.object=this,g.push(t)}Os.length=0}}setColorAt(e,g){null===this.instanceColor&&(this.instanceColor=new Us(new Float32Array(3*this.instanceMatrix.count),3)),g.toArray(this.instanceColor.array,3*e)}setMatrixAt(e,g){g.toArray(this.instanceMatrix.array,16*e)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"})}}class el extends oi{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Ai(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}const gl=new UI,tl=new UI,Il=new Zn,nl=new Bn,il=new cn;class Cl extends Dn{constructor(e=new Mi,g=new el){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=g,this.updateMorphTargets()}copy(e,g){return super.copy(e,g),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(null===e.index){const g=e.attributes.position,t=[0];for(let e=1,I=g.count;e<I;e++)gl.fromBufferAttribute(g,e-1),tl.fromBufferAttribute(g,e),t[e]=t[e-1],t[e]+=gl.distanceTo(tl);e.setAttribute("lineDistance",new Si(t,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,g){const t=this.geometry,I=this.matrixWorld,n=e.params.Line.threshold,i=t.drawRange;if(null===t.boundingSphere&&t.computeBoundingSphere(),il.copy(t.boundingSphere),il.applyMatrix4(I),il.radius+=n,!1===e.ray.intersectsSphere(il))return;Il.copy(I).invert(),nl.copy(e.ray).applyMatrix4(Il);const C=n/((this.scale.x+this.scale.y+this.scale.z)/3),o=C*C,a=new UI,s=new UI,l=new UI,r=new UI,A=this.isLineSegments?2:1,c=t.index,d=t.attributes.position;if(null!==c)for(let t=Math.max(0,i.start),I=Math.min(c.count,i.start+i.count)-1;t<I;t+=A){const I=c.getX(t),n=c.getX(t+1);if(a.fromBufferAttribute(d,I),s.fromBufferAttribute(d,n),nl.distanceSqToSegment(a,s,r,l)>o)continue;r.applyMatrix4(this.matrixWorld);const i=e.ray.origin.distanceTo(r);i<e.near||i>e.far||g.push({distance:i,point:l.clone().applyMatrix4(this.matrixWorld),index:t,face:null,faceIndex:null,object:this})}else for(let t=Math.max(0,i.start),I=Math.min(d.count,i.start+i.count)-1;t<I;t+=A){if(a.fromBufferAttribute(d,t),s.fromBufferAttribute(d,t+1),nl.distanceSqToSegment(a,s,r,l)>o)continue;r.applyMatrix4(this.matrixWorld);const I=e.ray.origin.distanceTo(r);I<e.near||I>e.far||g.push({distance:I,point:l.clone().applyMatrix4(this.matrixWorld),index:t,face:null,faceIndex:null,object:this})}}updateMorphTargets(){const e=this.geometry.morphAttributes,g=Object.keys(e);if(g.length>0){const t=e[g[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,g=t.length;e<g;e++){const g=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[g]=e}}}}}const ol=new UI,al=new UI;class sl extends Cl{constructor(e,g){super(e,g),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(null===e.index){const g=e.attributes.position,t=[];for(let e=0,I=g.count;e<I;e+=2)ol.fromBufferAttribute(g,e),al.fromBufferAttribute(g,e+1),t[e]=0===e?0:t[e-1],t[e+1]=t[e]+ol.distanceTo(al);e.setAttribute("lineDistance",new Si(t,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class ll extends Cl{constructor(e,g){super(e,g),this.isLineLoop=!0,this.type="LineLoop"}}class rl extends oi{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new Ai(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}const Al=new Zn,cl=new Bn,dl=new cn,ul=new UI;class hl extends Dn{constructor(e=new Mi,g=new rl){super(),this.isPoints=!0,this.type="Points",this.geometry=e,this.material=g,this.updateMorphTargets()}copy(e,g){return super.copy(e,g),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}raycast(e,g){const t=this.geometry,I=this.matrixWorld,n=e.params.Points.threshold,i=t.drawRange;if(null===t.boundingSphere&&t.computeBoundingSphere(),dl.copy(t.boundingSphere),dl.applyMatrix4(I),dl.radius+=n,!1===e.ray.intersectsSphere(dl))return;Al.copy(I).invert(),cl.copy(e.ray).applyMatrix4(Al);const C=n/((this.scale.x+this.scale.y+this.scale.z)/3),o=C*C,a=t.index,s=t.attributes.position;if(null!==a)for(let t=Math.max(0,i.start),n=Math.min(a.count,i.start+i.count);t<n;t++){const n=a.getX(t);ul.fromBufferAttribute(s,n),bl(ul,n,o,I,e,g,this)}else for(let t=Math.max(0,i.start),n=Math.min(s.count,i.start+i.count);t<n;t++)ul.fromBufferAttribute(s,t),bl(ul,t,o,I,e,g,this)}updateMorphTargets(){const e=this.geometry.morphAttributes,g=Object.keys(e);if(g.length>0){const t=e[g[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,g=t.length;e<g;e++){const g=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[g]=e}}}}}function bl(e,g,t,I,n,i,C){const o=cl.distanceSqToPoint(e);if(o<t){const t=new UI;cl.closestPointToPoint(e,t),t.applyMatrix4(I);const a=n.ray.origin.distanceTo(t);if(a<n.near||a>n.far)return;i.push({distance:a,distanceToRay:Math.sqrt(o),point:t,index:g,face:null,object:C})}}class ml extends NI{constructor(e,g,t,I,n,i,C,o,a){super(e,g,t,I,n,i,C,o,a),this.isVideoTexture=!0,this.minFilter=void 0!==i?i:Ke,this.magFilter=void 0!==n?n:Ke,this.generateMipmaps=!1;const s=this;"requestVideoFrameCallback"in e&&e.requestVideoFrameCallback((function g(){s.needsUpdate=!0,e.requestVideoFrameCallback(g)}))}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image;!1=="requestVideoFrameCallback"in e&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}class pl extends NI{constructor(e,g){super({width:e,height:g}),this.isFramebufferTexture=!0,this.magFilter=Re,this.minFilter=Re,this.generateMipmaps=!1,this.needsUpdate=!0}}class Gl extends NI{constructor(e,g,t,I,n,i,C,o,a,s,l,r){super(null,i,C,o,a,s,I,n,l,r),this.isCompressedTexture=!0,this.image={width:g,height:t},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}}class Bl extends Gl{constructor(e,g,t,I,n,i){super(e,g,t,n,i),this.isCompressedArrayTexture=!0,this.image.depth=I,this.wrapR=fe}}class Zl extends Gl{constructor(e,g,t){super(void 0,e[0].width,e[0].height,g,t,Ge),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=e}}class yl extends NI{constructor(e,g,t,I,n,i,C,o,a){super(e,g,t,I,n,i,C,o,a),this.isCanvasTexture=!0,this.needsUpdate=!0}}class vl{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return console.warn("THREE.Curve: .getPoint() not implemented."),null}getPointAt(e,g){const t=this.getUtoTmapping(e);return this.getPoint(t,g)}getPoints(e=5){const g=[];for(let t=0;t<=e;t++)g.push(this.getPoint(t/e));return g}getSpacedPoints(e=5){const g=[];for(let t=0;t<=e;t++)g.push(this.getPointAt(t/e));return g}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const g=[];let t,I=this.getPoint(0),n=0;g.push(0);for(let i=1;i<=e;i++)t=this.getPoint(i/e),n+=t.distanceTo(I),g.push(n),I=t;return this.cacheArcLengths=g,g}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,g){const t=this.getLengths();let I=0;const n=t.length;let i;i=g||e*t[n-1];let C,o=0,a=n-1;for(;o<=a;)if(I=Math.floor(o+(a-o)/2),C=t[I]-i,C<0)o=I+1;else{if(!(C>0)){a=I;break}a=I-1}if(I=a,t[I]===i)return I/(n-1);const s=t[I];return(I+(i-s)/(t[I+1]-s))/(n-1)}getTangent(e,g){const t=1e-4;let I=e-t,n=e+t;I<0&&(I=0),n>1&&(n=1);const i=this.getPoint(I),C=this.getPoint(n),o=g||(i.isVector2?new AI:new UI);return o.copy(C).sub(i).normalize(),o}getTangentAt(e,g){const t=this.getUtoTmapping(e);return this.getTangent(t,g)}computeFrenetFrames(e,g){const t=new UI,I=[],n=[],i=[],C=new UI,o=new Zn;for(let g=0;g<=e;g++){const t=g/e;I[g]=this.getTangentAt(t,new UI)}n[0]=new UI,i[0]=new UI;let a=Number.MAX_VALUE;const s=Math.abs(I[0].x),l=Math.abs(I[0].y),r=Math.abs(I[0].z);s<=a&&(a=s,t.set(1,0,0)),l<=a&&(a=l,t.set(0,1,0)),r<=a&&t.set(0,0,1),C.crossVectors(I[0],t).normalize(),n[0].crossVectors(I[0],C),i[0].crossVectors(I[0],n[0]);for(let g=1;g<=e;g++){if(n[g]=n[g-1].clone(),i[g]=i[g-1].clone(),C.crossVectors(I[g-1],I[g]),C.length()>Number.EPSILON){C.normalize();const e=Math.acos(II(I[g-1].dot(I[g]),-1,1));n[g].applyMatrix4(o.makeRotationAxis(C,e))}i[g].crossVectors(I[g],n[g])}if(!0===g){let g=Math.acos(II(n[0].dot(n[e]),-1,1));g/=e,I[0].dot(C.crossVectors(n[0],n[e]))>0&&(g=-g);for(let t=1;t<=e;t++)n[t].applyMatrix4(o.makeRotationAxis(I[t],g*t)),i[t].crossVectors(I[t],n[t])}return{tangents:I,normals:n,binormals:i}}clone(){return(new this.constructor).copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.6,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class Wl extends vl{constructor(e=0,g=0,t=1,I=1,n=0,i=2*Math.PI,C=!1,o=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=e,this.aY=g,this.xRadius=t,this.yRadius=I,this.aStartAngle=n,this.aEndAngle=i,this.aClockwise=C,this.aRotation=o}getPoint(e,g){const t=g||new AI,I=2*Math.PI;let n=this.aEndAngle-this.aStartAngle;const i=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=I;for(;n>I;)n-=I;n<Number.EPSILON&&(n=i?0:I),!0!==this.aClockwise||i||(n===I?n=-I:n-=I);const C=this.aStartAngle+e*n;let o=this.aX+this.xRadius*Math.cos(C),a=this.aY+this.yRadius*Math.sin(C);if(0!==this.aRotation){const e=Math.cos(this.aRotation),g=Math.sin(this.aRotation),t=o-this.aX,I=a-this.aY;o=t*e-I*g+this.aX,a=t*g+I*e+this.aY}return t.set(o,a)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}class fl extends Wl{constructor(e,g,t,I,n,i){super(e,g,t,t,I,n,i),this.isArcCurve=!0,this.type="ArcCurve"}}function wl(){let e=0,g=0,t=0,I=0;function n(n,i,C,o){e=n,g=C,t=-3*n+3*i-2*C-o,I=2*n-2*i+C+o}return{initCatmullRom:function(e,g,t,I,i){n(g,t,i*(t-e),i*(I-g))},initNonuniformCatmullRom:function(e,g,t,I,i,C,o){let a=(g-e)/i-(t-e)/(i+C)+(t-g)/C,s=(t-g)/C-(I-g)/(C+o)+(I-t)/o;a*=C,s*=C,n(g,t,a,s)},calc:function(n){const i=n*n;return e+g*n+t*i+I*(i*n)}}}const Rl=new UI,Vl=new wl,Xl=new wl,Sl=new wl;class Yl extends vl{constructor(e=[],g=!1,t="centripetal",I=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=e,this.closed=g,this.curveType=t,this.tension=I}getPoint(e,g=new UI){const t=g,I=this.points,n=I.length,i=(n-(this.closed?0:1))*e;let C,o,a=Math.floor(i),s=i-a;this.closed?a+=a>0?0:(Math.floor(Math.abs(a)/n)+1)*n:0===s&&a===n-1&&(a=n-2,s=1),this.closed||a>0?C=I[(a-1)%n]:(Rl.subVectors(I[0],I[1]).add(I[0]),C=Rl);const l=I[a%n],r=I[(a+1)%n];if(this.closed||a+2<n?o=I[(a+2)%n]:(Rl.subVectors(I[n-1],I[n-2]).add(I[n-1]),o=Rl),"centripetal"===this.curveType||"chordal"===this.curveType){const e="chordal"===this.curveType?.5:.25;let g=Math.pow(C.distanceToSquared(l),e),t=Math.pow(l.distanceToSquared(r),e),I=Math.pow(r.distanceToSquared(o),e);t<1e-4&&(t=1),g<1e-4&&(g=t),I<1e-4&&(I=t),Vl.initNonuniformCatmullRom(C.x,l.x,r.x,o.x,g,t,I),Xl.initNonuniformCatmullRom(C.y,l.y,r.y,o.y,g,t,I),Sl.initNonuniformCatmullRom(C.z,l.z,r.z,o.z,g,t,I)}else"catmullrom"===this.curveType&&(Vl.initCatmullRom(C.x,l.x,r.x,o.x,this.tension),Xl.initCatmullRom(C.y,l.y,r.y,o.y,this.tension),Sl.initCatmullRom(C.z,l.z,r.z,o.z,this.tension));return t.set(Vl.calc(s),Xl.calc(s),Sl.calc(s)),t}copy(e){super.copy(e),this.points=[];for(let g=0,t=e.points.length;g<t;g++){const t=e.points[g];this.points.push(t.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let g=0,t=this.points.length;g<t;g++){const t=this.points[g];e.points.push(t.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let g=0,t=e.points.length;g<t;g++){const t=e.points[g];this.points.push((new UI).fromArray(t))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}function Kl(e,g,t,I,n){const i=.5*(I-g),C=.5*(n-t),o=e*e;return(2*t-2*I+i+C)*(e*o)+(-3*t+3*I-2*i-C)*o+i*e+t}function Hl(e,g,t,I){return function(e,g){const t=1-e;return t*t*g}(e,g)+function(e,g){return 2*(1-e)*e*g}(e,t)+function(e,g){return e*e*g}(e,I)}function Nl(e,g,t,I,n){return function(e,g){const t=1-e;return t*t*t*g}(e,g)+function(e,g){const t=1-e;return 3*t*t*e*g}(e,t)+function(e,g){return 3*(1-e)*e*e*g}(e,I)+function(e,g){return e*e*e*g}(e,n)}class Fl extends vl{constructor(e=new AI,g=new AI,t=new AI,I=new AI){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=e,this.v1=g,this.v2=t,this.v3=I}getPoint(e,g=new AI){const t=g,I=this.v0,n=this.v1,i=this.v2,C=this.v3;return t.set(Nl(e,I.x,n.x,i.x,C.x),Nl(e,I.y,n.y,i.y,C.y)),t}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class xl extends vl{constructor(e=new UI,g=new UI,t=new UI,I=new UI){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=e,this.v1=g,this.v2=t,this.v3=I}getPoint(e,g=new UI){const t=g,I=this.v0,n=this.v1,i=this.v2,C=this.v3;return t.set(Nl(e,I.x,n.x,i.x,C.x),Nl(e,I.y,n.y,i.y,C.y),Nl(e,I.z,n.z,i.z,C.z)),t}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class zl extends vl{constructor(e=new AI,g=new AI){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=e,this.v2=g}getPoint(e,g=new AI){const t=g;return 1===e?t.copy(this.v2):(t.copy(this.v2).sub(this.v1),t.multiplyScalar(e).add(this.v1)),t}getPointAt(e,g){return this.getPoint(e,g)}getTangent(e,g=new AI){return g.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,g){return this.getTangent(e,g)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class kl extends vl{constructor(e=new UI,g=new UI){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=e,this.v2=g}getPoint(e,g=new UI){const t=g;return 1===e?t.copy(this.v2):(t.copy(this.v2).sub(this.v1),t.multiplyScalar(e).add(this.v1)),t}getPointAt(e,g){return this.getPoint(e,g)}getTangent(e,g=new UI){return g.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,g){return this.getTangent(e,g)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class Ml extends vl{constructor(e=new AI,g=new AI,t=new AI){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=e,this.v1=g,this.v2=t}getPoint(e,g=new AI){const t=g,I=this.v0,n=this.v1,i=this.v2;return t.set(Hl(e,I.x,n.x,i.x),Hl(e,I.y,n.y,i.y)),t}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class Ll extends vl{constructor(e=new UI,g=new UI,t=new UI){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=e,this.v1=g,this.v2=t}getPoint(e,g=new UI){const t=g,I=this.v0,n=this.v1,i=this.v2;return t.set(Hl(e,I.x,n.x,i.x),Hl(e,I.y,n.y,i.y),Hl(e,I.z,n.z,i.z)),t}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class Jl extends vl{constructor(e=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=e}getPoint(e,g=new AI){const t=g,I=this.points,n=(I.length-1)*e,i=Math.floor(n),C=n-i,o=I[0===i?i:i-1],a=I[i],s=I[i>I.length-2?I.length-1:i+1],l=I[i>I.length-3?I.length-1:i+2];return t.set(Kl(C,o.x,a.x,s.x,l.x),Kl(C,o.y,a.y,s.y,l.y)),t}copy(e){super.copy(e),this.points=[];for(let g=0,t=e.points.length;g<t;g++){const t=e.points[g];this.points.push(t.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let g=0,t=this.points.length;g<t;g++){const t=this.points[g];e.points.push(t.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let g=0,t=e.points.length;g<t;g++){const t=e.points[g];this.points.push((new AI).fromArray(t))}return this}}var El=Object.freeze({__proto__:null,ArcCurve:fl,CatmullRomCurve3:Yl,CubicBezierCurve:Fl,CubicBezierCurve3:xl,EllipseCurve:Wl,LineCurve:zl,LineCurve3:kl,QuadraticBezierCurve:Ml,QuadraticBezierCurve3:Ll,SplineCurve:Jl});class Tl extends vl{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){const e=this.curves[0].getPoint(0),g=this.curves[this.curves.length-1].getPoint(1);if(!e.equals(g)){const t=!0===e.isVector2?"LineCurve":"LineCurve3";this.curves.push(new El[t](g,e))}return this}getPoint(e,g){const t=e*this.getLength(),I=this.getCurveLengths();let n=0;for(;n<I.length;){if(I[n]>=t){const e=I[n]-t,i=this.curves[n],C=i.getLength(),o=0===C?0:1-e/C;return i.getPointAt(o,g)}n++}return null}getLength(){const e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const e=[];let g=0;for(let t=0,I=this.curves.length;t<I;t++)g+=this.curves[t].getLength(),e.push(g);return this.cacheLengths=e,e}getSpacedPoints(e=40){const g=[];for(let t=0;t<=e;t++)g.push(this.getPoint(t/e));return this.autoClose&&g.push(g[0]),g}getPoints(e=12){const g=[];let t;for(let I=0,n=this.curves;I<n.length;I++){const i=n[I],C=i.isEllipseCurve?2*e:i.isLineCurve||i.isLineCurve3?1:i.isSplineCurve?e*i.points.length:e,o=i.getPoints(C);for(let e=0;e<o.length;e++){const I=o[e];t&&t.equals(I)||(g.push(I),t=I)}}return this.autoClose&&g.length>1&&!g[g.length-1].equals(g[0])&&g.push(g[0]),g}copy(e){super.copy(e),this.curves=[];for(let g=0,t=e.curves.length;g<t;g++){const t=e.curves[g];this.curves.push(t.clone())}return this.autoClose=e.autoClose,this}toJSON(){const e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let g=0,t=this.curves.length;g<t;g++){const t=this.curves[g];e.curves.push(t.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let g=0,t=e.curves.length;g<t;g++){const t=e.curves[g];this.curves.push((new El[t.type]).fromJSON(t))}return this}}class Ul extends Tl{constructor(e){super(),this.type="Path",this.currentPoint=new AI,e&&this.setFromPoints(e)}setFromPoints(e){this.moveTo(e[0].x,e[0].y);for(let g=1,t=e.length;g<t;g++)this.lineTo(e[g].x,e[g].y);return this}moveTo(e,g){return this.currentPoint.set(e,g),this}lineTo(e,g){const t=new zl(this.currentPoint.clone(),new AI(e,g));return this.curves.push(t),this.currentPoint.set(e,g),this}quadraticCurveTo(e,g,t,I){const n=new Ml(this.currentPoint.clone(),new AI(e,g),new AI(t,I));return this.curves.push(n),this.currentPoint.set(t,I),this}bezierCurveTo(e,g,t,I,n,i){const C=new Fl(this.currentPoint.clone(),new AI(e,g),new AI(t,I),new AI(n,i));return this.curves.push(C),this.currentPoint.set(n,i),this}splineThru(e){const g=[this.currentPoint.clone()].concat(e),t=new Jl(g);return this.curves.push(t),this.currentPoint.copy(e[e.length-1]),this}arc(e,g,t,I,n,i){const C=this.currentPoint.x,o=this.currentPoint.y;return this.absarc(e+C,g+o,t,I,n,i),this}absarc(e,g,t,I,n,i){return this.absellipse(e,g,t,t,I,n,i),this}ellipse(e,g,t,I,n,i,C,o){const a=this.currentPoint.x,s=this.currentPoint.y;return this.absellipse(e+a,g+s,t,I,n,i,C,o),this}absellipse(e,g,t,I,n,i,C,o){const a=new Wl(e,g,t,I,n,i,C,o);if(this.curves.length>0){const e=a.getPoint(0);e.equals(this.currentPoint)||this.lineTo(e.x,e.y)}this.curves.push(a);const s=a.getPoint(1);return this.currentPoint.copy(s),this}copy(e){return super.copy(e),this.currentPoint.copy(e.currentPoint),this}toJSON(){const e=super.toJSON();return e.currentPoint=this.currentPoint.toArray(),e}fromJSON(e){return super.fromJSON(e),this.currentPoint.fromArray(e.currentPoint),this}}class Ql extends Mi{constructor(e=[new AI(0,-.5),new AI(.5,0),new AI(0,.5)],g=12,t=0,I=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:e,segments:g,phiStart:t,phiLength:I},g=Math.floor(g),I=II(I,0,2*Math.PI);const n=[],i=[],C=[],o=[],a=[],s=1/g,l=new UI,r=new AI,A=new UI,c=new UI,d=new UI;let u=0,h=0;for(let g=0;g<=e.length-1;g++)switch(g){case 0:u=e[g+1].x-e[g].x,h=e[g+1].y-e[g].y,A.x=1*h,A.y=-u,A.z=0*h,d.copy(A),A.normalize(),o.push(A.x,A.y,A.z);break;case e.length-1:o.push(d.x,d.y,d.z);break;default:u=e[g+1].x-e[g].x,h=e[g+1].y-e[g].y,A.x=1*h,A.y=-u,A.z=0*h,c.copy(A),A.x+=d.x,A.y+=d.y,A.z+=d.z,A.normalize(),o.push(A.x,A.y,A.z),d.copy(c)}for(let n=0;n<=g;n++){const A=t+n*s*I,c=Math.sin(A),d=Math.cos(A);for(let t=0;t<=e.length-1;t++){l.x=e[t].x*c,l.y=e[t].y,l.z=e[t].x*d,i.push(l.x,l.y,l.z),r.x=n/g,r.y=t/(e.length-1),C.push(r.x,r.y);const I=o[3*t+0]*c,s=o[3*t+1],A=o[3*t+0]*d;a.push(I,s,A)}}for(let t=0;t<g;t++)for(let g=0;g<e.length-1;g++){const I=g+t*e.length,i=I,C=I+e.length,o=I+e.length+1,a=I+1;n.push(i,C,a),n.push(o,a,C)}this.setIndex(n),this.setAttribute("position",new Si(i,3)),this.setAttribute("uv",new Si(C,2)),this.setAttribute("normal",new Si(a,3))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Ql(e.points,e.segments,e.phiStart,e.phiLength)}}class Dl extends Ql{constructor(e=1,g=1,t=4,I=8){const n=new Ul;n.absarc(0,-g/2,e,1.5*Math.PI,0),n.absarc(0,g/2,e,0,.5*Math.PI),super(n.getPoints(t),I),this.type="CapsuleGeometry",this.parameters={radius:e,length:g,capSegments:t,radialSegments:I}}static fromJSON(e){return new Dl(e.radius,e.length,e.capSegments,e.radialSegments)}}class Ol extends Mi{constructor(e=1,g=32,t=0,I=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:e,segments:g,thetaStart:t,thetaLength:I},g=Math.max(3,g);const n=[],i=[],C=[],o=[],a=new UI,s=new AI;i.push(0,0,0),C.push(0,0,1),o.push(.5,.5);for(let n=0,l=3;n<=g;n++,l+=3){const r=t+n/g*I;a.x=e*Math.cos(r),a.y=e*Math.sin(r),i.push(a.x,a.y,a.z),C.push(0,0,1),s.x=(i[l]/e+1)/2,s.y=(i[l+1]/e+1)/2,o.push(s.x,s.y)}for(let e=1;e<=g;e++)n.push(e,e+1,0);this.setIndex(n),this.setAttribute("position",new Si(i,3)),this.setAttribute("normal",new Si(C,3)),this.setAttribute("uv",new Si(o,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Ol(e.radius,e.segments,e.thetaStart,e.thetaLength)}}class jl extends Mi{constructor(e=1,g=1,t=1,I=32,n=1,i=!1,C=0,o=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:g,height:t,radialSegments:I,heightSegments:n,openEnded:i,thetaStart:C,thetaLength:o};const a=this;I=Math.floor(I),n=Math.floor(n);const s=[],l=[],r=[],A=[];let c=0;const d=[],u=t/2;let h=0;function b(t){const n=c,i=new AI,d=new UI;let b=0;const m=!0===t?e:g,p=!0===t?1:-1;for(let e=1;e<=I;e++)l.push(0,u*p,0),r.push(0,p,0),A.push(.5,.5),c++;const G=c;for(let e=0;e<=I;e++){const g=e/I*o+C,t=Math.cos(g),n=Math.sin(g);d.x=m*n,d.y=u*p,d.z=m*t,l.push(d.x,d.y,d.z),r.push(0,p,0),i.x=.5*t+.5,i.y=.5*n*p+.5,A.push(i.x,i.y),c++}for(let e=0;e<I;e++){const g=n+e,I=G+e;!0===t?s.push(I,I+1,g):s.push(I+1,I,g),b+=3}a.addGroup(h,b,!0===t?1:2),h+=b}!function(){const i=new UI,b=new UI;let m=0;const p=(g-e)/t;for(let a=0;a<=n;a++){const s=[],h=a/n,m=h*(g-e)+e;for(let e=0;e<=I;e++){const g=e/I,n=g*o+C,a=Math.sin(n),d=Math.cos(n);b.x=m*a,b.y=-h*t+u,b.z=m*d,l.push(b.x,b.y,b.z),i.set(a,p,d).normalize(),r.push(i.x,i.y,i.z),A.push(g,1-h),s.push(c++)}d.push(s)}for(let e=0;e<I;e++)for(let g=0;g<n;g++){const t=d[g][e],I=d[g+1][e],n=d[g+1][e+1],i=d[g][e+1];s.push(t,I,i),s.push(I,n,i),m+=6}a.addGroup(h,m,0),h+=m}(),!1===i&&(e>0&&b(!0),g>0&&b(!1)),this.setIndex(s),this.setAttribute("position",new Si(l,3)),this.setAttribute("normal",new Si(r,3)),this.setAttribute("uv",new Si(A,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new jl(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class Pl extends jl{constructor(e=1,g=1,t=32,I=1,n=!1,i=0,C=2*Math.PI){super(0,e,g,t,I,n,i,C),this.type="ConeGeometry",this.parameters={radius:e,height:g,radialSegments:t,heightSegments:I,openEnded:n,thetaStart:i,thetaLength:C}}static fromJSON(e){return new Pl(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class _l extends Mi{constructor(e=[],g=[],t=1,I=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:g,radius:t,detail:I};const n=[],i=[];function C(e,g,t,I){const n=I+1,i=[];for(let I=0;I<=n;I++){i[I]=[];const C=e.clone().lerp(t,I/n),o=g.clone().lerp(t,I/n),a=n-I;for(let e=0;e<=a;e++)i[I][e]=0===e&&I===n?C:C.clone().lerp(o,e/a)}for(let e=0;e<n;e++)for(let g=0;g<2*(n-e)-1;g++){const t=Math.floor(g/2);g%2==0?(o(i[e][t+1]),o(i[e+1][t]),o(i[e][t])):(o(i[e][t+1]),o(i[e+1][t+1]),o(i[e+1][t]))}}function o(e){n.push(e.x,e.y,e.z)}function a(g,t){const I=3*g;t.x=e[I+0],t.y=e[I+1],t.z=e[I+2]}function s(e,g,t,I){I<0&&1===e.x&&(i[g]=e.x-1),0===t.x&&0===t.z&&(i[g]=I/2/Math.PI+.5)}function l(e){return Math.atan2(e.z,-e.x)}!function(e){const t=new UI,I=new UI,n=new UI;for(let i=0;i<g.length;i+=3)a(g[i+0],t),a(g[i+1],I),a(g[i+2],n),C(t,I,n,e)}(I),function(e){const g=new UI;for(let t=0;t<n.length;t+=3)g.x=n[t+0],g.y=n[t+1],g.z=n[t+2],g.normalize().multiplyScalar(e),n[t+0]=g.x,n[t+1]=g.y,n[t+2]=g.z}(t),function(){const e=new UI;for(let t=0;t<n.length;t+=3){e.x=n[t+0],e.y=n[t+1],e.z=n[t+2];const I=l(e)/2/Math.PI+.5,C=(g=e,Math.atan2(-g.y,Math.sqrt(g.x*g.x+g.z*g.z))/Math.PI+.5);i.push(I,1-C)}var g;(function(){const e=new UI,g=new UI,t=new UI,I=new UI,C=new AI,o=new AI,a=new AI;for(let r=0,A=0;r<n.length;r+=9,A+=6){e.set(n[r+0],n[r+1],n[r+2]),g.set(n[r+3],n[r+4],n[r+5]),t.set(n[r+6],n[r+7],n[r+8]),C.set(i[A+0],i[A+1]),o.set(i[A+2],i[A+3]),a.set(i[A+4],i[A+5]),I.copy(e).add(g).add(t).divideScalar(3);const c=l(I);s(C,A+0,e,c),s(o,A+2,g,c),s(a,A+4,t,c)}})(),function(){for(let e=0;e<i.length;e+=6){const g=i[e+0],t=i[e+2],I=i[e+4],n=Math.max(g,t,I),C=Math.min(g,t,I);n>.9&&C<.1&&(g<.2&&(i[e+0]+=1),t<.2&&(i[e+2]+=1),I<.2&&(i[e+4]+=1))}}()}(),this.setAttribute("position",new Si(n,3)),this.setAttribute("normal",new Si(n.slice(),3)),this.setAttribute("uv",new Si(i,2)),0===I?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new _l(e.vertices,e.indices,e.radius,e.details)}}class ql extends _l{constructor(e=1,g=0){const t=(1+Math.sqrt(5))/2,I=1/t;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-I,-t,0,-I,t,0,I,-t,0,I,t,-I,-t,0,-I,t,0,I,-t,0,I,t,0,-t,0,-I,t,0,-I,-t,0,I,t,0,I],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,g),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:g}}static fromJSON(e){return new ql(e.radius,e.detail)}}const $l=new UI,er=new UI,gr=new UI,tr=new ii;class Ir extends Mi{constructor(e=null,g=1){if(super(),this.type="EdgesGeometry",this.parameters={geometry:e,thresholdAngle:g},null!==e){const t=4,I=Math.pow(10,t),n=Math.cos(eI*g),i=e.getIndex(),C=e.getAttribute("position"),o=i?i.count:C.count,a=[0,0,0],s=["a","b","c"],l=new Array(3),r={},A=[];for(let e=0;e<o;e+=3){i?(a[0]=i.getX(e),a[1]=i.getX(e+1),a[2]=i.getX(e+2)):(a[0]=e,a[1]=e+1,a[2]=e+2);const{a:g,b:t,c:o}=tr;if(g.fromBufferAttribute(C,a[0]),t.fromBufferAttribute(C,a[1]),o.fromBufferAttribute(C,a[2]),tr.getNormal(gr),l[0]=`${Math.round(g.x*I)},${Math.round(g.y*I)},${Math.round(g.z*I)}`,l[1]=`${Math.round(t.x*I)},${Math.round(t.y*I)},${Math.round(t.z*I)}`,l[2]=`${Math.round(o.x*I)},${Math.round(o.y*I)},${Math.round(o.z*I)}`,l[0]!==l[1]&&l[1]!==l[2]&&l[2]!==l[0])for(let e=0;e<3;e++){const g=(e+1)%3,t=l[e],I=l[g],i=tr[s[e]],C=tr[s[g]],o=`${t}_${I}`,c=`${I}_${t}`;c in r&&r[c]?(gr.dot(r[c].normal)<=n&&(A.push(i.x,i.y,i.z),A.push(C.x,C.y,C.z)),r[c]=null):o in r||(r[o]={index0:a[e],index1:a[g],normal:gr.clone()})}}for(const e in r)if(r[e]){const{index0:g,index1:t}=r[e];$l.fromBufferAttribute(C,g),er.fromBufferAttribute(C,t),A.push($l.x,$l.y,$l.z),A.push(er.x,er.y,er.z)}this.setAttribute("position",new Si(A,3))}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}}class nr extends Ul{constructor(e){super(e),this.uuid=tI(),this.type="Shape",this.holes=[]}getPointsHoles(e){const g=[];for(let t=0,I=this.holes.length;t<I;t++)g[t]=this.holes[t].getPoints(e);return g}extractPoints(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}}copy(e){super.copy(e),this.holes=[];for(let g=0,t=e.holes.length;g<t;g++){const t=e.holes[g];this.holes.push(t.clone())}return this}toJSON(){const e=super.toJSON();e.uuid=this.uuid,e.holes=[];for(let g=0,t=this.holes.length;g<t;g++){const t=this.holes[g];e.holes.push(t.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.uuid=e.uuid,this.holes=[];for(let g=0,t=e.holes.length;g<t;g++){const t=e.holes[g];this.holes.push((new Ul).fromJSON(t))}return this}}function ir(e,g,t,I,n){let i,C;if(n===function(e,g,t,I){let n=0;for(let i=g,C=t-I;i<t;i+=I)n+=(e[C]-e[i])*(e[i+1]+e[C+1]),C=i;return n}(e,g,t,I)>0)for(i=g;i<t;i+=I)C=fr(i,e[i],e[i+1],C);else for(i=t-I;i>=g;i-=I)C=fr(i,e[i],e[i+1],C);return C&&Gr(C,C.next)&&(wr(C),C=C.next),C}function Cr(e,g){if(!e)return e;g||(g=e);let t,I=e;do{if(t=!1,I.steiner||!Gr(I,I.next)&&0!==pr(I.prev,I,I.next))I=I.next;else{if(wr(I),I=g=I.prev,I===I.next)break;t=!0}}while(t||I!==g);return g}function or(e,g,t,I,n,i,C){if(!e)return;!C&&i&&function(e,g,t,I){let n=e;do{0===n.z&&(n.z=ur(n.x,n.y,g,t,I)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,function(e){let g,t,I,n,i,C,o,a,s=1;do{for(t=e,e=null,i=null,C=0;t;){for(C++,I=t,o=0,g=0;g<s&&(o++,I=I.nextZ,I);g++);for(a=s;o>0||a>0&&I;)0!==o&&(0===a||!I||t.z<=I.z)?(n=t,t=t.nextZ,o--):(n=I,I=I.nextZ,a--),i?i.nextZ=n:e=n,n.prevZ=i,i=n;t=I}i.nextZ=null,s*=2}while(C>1)}(n)}(e,I,n,i);let o,a,s=e;for(;e.prev!==e.next;)if(o=e.prev,a=e.next,i?sr(e,I,n,i):ar(e))g.push(o.i/t|0),g.push(e.i/t|0),g.push(a.i/t|0),wr(e),e=a.next,s=a.next;else if((e=a)===s){C?1===C?or(e=lr(Cr(e),g,t),g,t,I,n,i,2):2===C&&rr(e,g,t,I,n,i):or(Cr(e),g,t,I,n,i,1);break}}function ar(e){const g=e.prev,t=e,I=e.next;if(pr(g,t,I)>=0)return!1;const n=g.x,i=t.x,C=I.x,o=g.y,a=t.y,s=I.y,l=n<i?n<C?n:C:i<C?i:C,r=o<a?o<s?o:s:a<s?a:s,A=n>i?n>C?n:C:i>C?i:C,c=o>a?o>s?o:s:a>s?a:s;let d=I.next;for(;d!==g;){if(d.x>=l&&d.x<=A&&d.y>=r&&d.y<=c&&br(n,o,i,a,C,s,d.x,d.y)&&pr(d.prev,d,d.next)>=0)return!1;d=d.next}return!0}function sr(e,g,t,I){const n=e.prev,i=e,C=e.next;if(pr(n,i,C)>=0)return!1;const o=n.x,a=i.x,s=C.x,l=n.y,r=i.y,A=C.y,c=o<a?o<s?o:s:a<s?a:s,d=l<r?l<A?l:A:r<A?r:A,u=o>a?o>s?o:s:a>s?a:s,h=l>r?l>A?l:A:r>A?r:A,b=ur(c,d,g,t,I),m=ur(u,h,g,t,I);let p=e.prevZ,G=e.nextZ;for(;p&&p.z>=b&&G&&G.z<=m;){if(p.x>=c&&p.x<=u&&p.y>=d&&p.y<=h&&p!==n&&p!==C&&br(o,l,a,r,s,A,p.x,p.y)&&pr(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,G.x>=c&&G.x<=u&&G.y>=d&&G.y<=h&&G!==n&&G!==C&&br(o,l,a,r,s,A,G.x,G.y)&&pr(G.prev,G,G.next)>=0)return!1;G=G.nextZ}for(;p&&p.z>=b;){if(p.x>=c&&p.x<=u&&p.y>=d&&p.y<=h&&p!==n&&p!==C&&br(o,l,a,r,s,A,p.x,p.y)&&pr(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;G&&G.z<=m;){if(G.x>=c&&G.x<=u&&G.y>=d&&G.y<=h&&G!==n&&G!==C&&br(o,l,a,r,s,A,G.x,G.y)&&pr(G.prev,G,G.next)>=0)return!1;G=G.nextZ}return!0}function lr(e,g,t){let I=e;do{const n=I.prev,i=I.next.next;!Gr(n,i)&&Br(n,I,I.next,i)&&vr(n,i)&&vr(i,n)&&(g.push(n.i/t|0),g.push(I.i/t|0),g.push(i.i/t|0),wr(I),wr(I.next),I=e=i),I=I.next}while(I!==e);return Cr(I)}function rr(e,g,t,I,n,i){let C=e;do{let e=C.next.next;for(;e!==C.prev;){if(C.i!==e.i&&mr(C,e)){let o=Wr(C,e);return C=Cr(C,C.next),o=Cr(o,o.next),or(C,g,t,I,n,i,0),void or(o,g,t,I,n,i,0)}e=e.next}C=C.next}while(C!==e)}function Ar(e,g){return e.x-g.x}function cr(e,g){const t=function(e,g){let t,I=g,n=-1/0;const i=e.x,C=e.y;do{if(C<=I.y&&C>=I.next.y&&I.next.y!==I.y){const e=I.x+(C-I.y)*(I.next.x-I.x)/(I.next.y-I.y);if(e<=i&&e>n&&(n=e,t=I.x<I.next.x?I:I.next,e===i))return t}I=I.next}while(I!==g);if(!t)return null;const o=t,a=t.x,s=t.y;let l,r=1/0;I=t;do{i>=I.x&&I.x>=a&&i!==I.x&&br(C<s?i:n,C,a,s,C<s?n:i,C,I.x,I.y)&&(l=Math.abs(C-I.y)/(i-I.x),vr(I,e)&&(l<r||l===r&&(I.x>t.x||I.x===t.x&&dr(t,I)))&&(t=I,r=l)),I=I.next}while(I!==o);return t}(e,g);if(!t)return g;const I=Wr(t,e);return Cr(I,I.next),Cr(t,t.next)}function dr(e,g){return pr(e.prev,e,g.prev)<0&&pr(g.next,e,e.next)<0}function ur(e,g,t,I,n){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-t)*n|0)|e<<8))|e<<4))|e<<2))|e<<1))|(g=1431655765&((g=858993459&((g=252645135&((g=16711935&((g=(g-I)*n|0)|g<<8))|g<<4))|g<<2))|g<<1))<<1}function hr(e){let g=e,t=e;do{(g.x<t.x||g.x===t.x&&g.y<t.y)&&(t=g),g=g.next}while(g!==e);return t}function br(e,g,t,I,n,i,C,o){return(n-C)*(g-o)>=(e-C)*(i-o)&&(e-C)*(I-o)>=(t-C)*(g-o)&&(t-C)*(i-o)>=(n-C)*(I-o)}function mr(e,g){return e.next.i!==g.i&&e.prev.i!==g.i&&!function(e,g){let t=e;do{if(t.i!==e.i&&t.next.i!==e.i&&t.i!==g.i&&t.next.i!==g.i&&Br(t,t.next,e,g))return!0;t=t.next}while(t!==e);return!1}(e,g)&&(vr(e,g)&&vr(g,e)&&function(e,g){let t=e,I=!1;const n=(e.x+g.x)/2,i=(e.y+g.y)/2;do{t.y>i!=t.next.y>i&&t.next.y!==t.y&&n<(t.next.x-t.x)*(i-t.y)/(t.next.y-t.y)+t.x&&(I=!I),t=t.next}while(t!==e);return I}(e,g)&&(pr(e.prev,e,g.prev)||pr(e,g.prev,g))||Gr(e,g)&&pr(e.prev,e,e.next)>0&&pr(g.prev,g,g.next)>0)}function pr(e,g,t){return(g.y-e.y)*(t.x-g.x)-(g.x-e.x)*(t.y-g.y)}function Gr(e,g){return e.x===g.x&&e.y===g.y}function Br(e,g,t,I){const n=yr(pr(e,g,t)),i=yr(pr(e,g,I)),C=yr(pr(t,I,e)),o=yr(pr(t,I,g));return n!==i&&C!==o||!(0!==n||!Zr(e,t,g))||!(0!==i||!Zr(e,I,g))||!(0!==C||!Zr(t,e,I))||!(0!==o||!Zr(t,g,I))}function Zr(e,g,t){return g.x<=Math.max(e.x,t.x)&&g.x>=Math.min(e.x,t.x)&&g.y<=Math.max(e.y,t.y)&&g.y>=Math.min(e.y,t.y)}function yr(e){return e>0?1:e<0?-1:0}function vr(e,g){return pr(e.prev,e,e.next)<0?pr(e,g,e.next)>=0&&pr(e,e.prev,g)>=0:pr(e,g,e.prev)<0||pr(e,e.next,g)<0}function Wr(e,g){const t=new Rr(e.i,e.x,e.y),I=new Rr(g.i,g.x,g.y),n=e.next,i=g.prev;return e.next=g,g.prev=e,t.next=n,n.prev=t,I.next=t,t.prev=I,i.next=I,I.prev=i,I}function fr(e,g,t,I){const n=new Rr(e,g,t);return I?(n.next=I.next,n.prev=I,I.next.prev=n,I.next=n):(n.prev=n,n.next=n),n}function wr(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Rr(e,g,t){this.i=e,this.x=g,this.y=t,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}class Vr{static area(e){const g=e.length;let t=0;for(let I=g-1,n=0;n<g;I=n++)t+=e[I].x*e[n].y-e[n].x*e[I].y;return.5*t}static isClockWise(e){return Vr.area(e)<0}static triangulateShape(e,g){const t=[],I=[],n=[];Xr(e),Sr(t,e);let i=e.length;g.forEach(Xr);for(let e=0;e<g.length;e++)I.push(i),i+=g[e].length,Sr(t,g[e]);const C=function(e,g,t=2){const I=g&&g.length,n=I?g[0]*t:e.length;let i=ir(e,0,n,t,!0);const C=[];if(!i||i.next===i.prev)return C;let o,a,s,l,r,A,c;if(I&&(i=function(e,g,t,I){const n=[];let i,C,o,a,s;for(i=0,C=g.length;i<C;i++)o=g[i]*I,a=i<C-1?g[i+1]*I:e.length,s=ir(e,o,a,I,!1),s===s.next&&(s.steiner=!0),n.push(hr(s));for(n.sort(Ar),i=0;i<n.length;i++)t=cr(n[i],t);return t}(e,g,i,t)),e.length>80*t){o=s=e[0],a=l=e[1];for(let g=t;g<n;g+=t)r=e[g],A=e[g+1],r<o&&(o=r),A<a&&(a=A),r>s&&(s=r),A>l&&(l=A);c=Math.max(s-o,l-a),c=0!==c?32767/c:0}return or(i,C,t,o,a,c,0),C}(t,I);for(let e=0;e<C.length;e+=3)n.push(C.slice(e,e+3));return n}}function Xr(e){const g=e.length;g>2&&e[g-1].equals(e[0])&&e.pop()}function Sr(e,g){for(let t=0;t<g.length;t++)e.push(g[t].x),e.push(g[t].y)}class Yr extends Mi{constructor(e=new nr([new AI(.5,.5),new AI(-.5,.5),new AI(-.5,-.5),new AI(.5,-.5)]),g={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:g},e=Array.isArray(e)?e:[e];const t=this,I=[],n=[];for(let g=0,t=e.length;g<t;g++)i(e[g]);function i(e){const i=[],C=void 0!==g.curveSegments?g.curveSegments:12,o=void 0!==g.steps?g.steps:1,a=void 0!==g.depth?g.depth:1;let s=void 0===g.bevelEnabled||g.bevelEnabled,l=void 0!==g.bevelThickness?g.bevelThickness:.2,r=void 0!==g.bevelSize?g.bevelSize:l-.1,A=void 0!==g.bevelOffset?g.bevelOffset:0,c=void 0!==g.bevelSegments?g.bevelSegments:3;const d=g.extrudePath,u=void 0!==g.UVGenerator?g.UVGenerator:Kr;let h,b,m,p,G,B=!1;d&&(h=d.getSpacedPoints(o),B=!0,s=!1,b=d.computeFrenetFrames(o,!1),m=new UI,p=new UI,G=new UI),s||(c=0,l=0,r=0,A=0);const Z=e.extractPoints(C);let y=Z.shape;const v=Z.holes;if(!Vr.isClockWise(y)){y=y.reverse();for(let e=0,g=v.length;e<g;e++){const g=v[e];Vr.isClockWise(g)&&(v[e]=g.reverse())}}const W=Vr.triangulateShape(y,v),f=y;for(let e=0,g=v.length;e<g;e++){const g=v[e];y=y.concat(g)}function w(e,g,t){return g||console.error("THREE.ExtrudeGeometry: vec does not exist"),e.clone().addScaledVector(g,t)}const R=y.length,V=W.length;function X(e,g,t){let I,n,i;const C=e.x-g.x,o=e.y-g.y,a=t.x-e.x,s=t.y-e.y,l=C*C+o*o,r=C*s-o*a;if(Math.abs(r)>Number.EPSILON){const r=Math.sqrt(l),A=Math.sqrt(a*a+s*s),c=g.x-o/r,d=g.y+C/r,u=((t.x-s/A-c)*s-(t.y+a/A-d)*a)/(C*s-o*a);I=c+C*u-e.x,n=d+o*u-e.y;const h=I*I+n*n;if(h<=2)return new AI(I,n);i=Math.sqrt(h/2)}else{let e=!1;C>Number.EPSILON?a>Number.EPSILON&&(e=!0):C<-Number.EPSILON?a<-Number.EPSILON&&(e=!0):Math.sign(o)===Math.sign(s)&&(e=!0),e?(I=-o,n=C,i=Math.sqrt(l)):(I=C,n=o,i=Math.sqrt(l/2))}return new AI(I/i,n/i)}const S=[];for(let e=0,g=f.length,t=g-1,I=e+1;e<g;e++,t++,I++)t===g&&(t=0),I===g&&(I=0),S[e]=X(f[e],f[t],f[I]);const Y=[];let K,H=S.concat();for(let e=0,g=v.length;e<g;e++){const g=v[e];K=[];for(let e=0,t=g.length,I=t-1,n=e+1;e<t;e++,I++,n++)I===t&&(I=0),n===t&&(n=0),K[e]=X(g[e],g[I],g[n]);Y.push(K),H=H.concat(K)}for(let e=0;e<c;e++){const g=e/c,t=l*Math.cos(g*Math.PI/2),I=r*Math.sin(g*Math.PI/2)+A;for(let e=0,g=f.length;e<g;e++){const g=w(f[e],S[e],I);x(g.x,g.y,-t)}for(let e=0,g=v.length;e<g;e++){const g=v[e];K=Y[e];for(let e=0,n=g.length;e<n;e++){const n=w(g[e],K[e],I);x(n.x,n.y,-t)}}}const N=r+A;for(let e=0;e<R;e++){const g=s?w(y[e],H[e],N):y[e];B?(p.copy(b.normals[0]).multiplyScalar(g.x),m.copy(b.binormals[0]).multiplyScalar(g.y),G.copy(h[0]).add(p).add(m),x(G.x,G.y,G.z)):x(g.x,g.y,0)}for(let e=1;e<=o;e++)for(let g=0;g<R;g++){const t=s?w(y[g],H[g],N):y[g];B?(p.copy(b.normals[e]).multiplyScalar(t.x),m.copy(b.binormals[e]).multiplyScalar(t.y),G.copy(h[e]).add(p).add(m),x(G.x,G.y,G.z)):x(t.x,t.y,a/o*e)}for(let e=c-1;e>=0;e--){const g=e/c,t=l*Math.cos(g*Math.PI/2),I=r*Math.sin(g*Math.PI/2)+A;for(let e=0,g=f.length;e<g;e++){const g=w(f[e],S[e],I);x(g.x,g.y,a+t)}for(let e=0,g=v.length;e<g;e++){const g=v[e];K=Y[e];for(let e=0,n=g.length;e<n;e++){const n=w(g[e],K[e],I);B?x(n.x,n.y+h[o-1].y,h[o-1].x+t):x(n.x,n.y,a+t)}}}function F(e,g){let t=e.length;for(;--t>=0;){const I=t;let n=t-1;n<0&&(n=e.length-1);for(let e=0,t=o+2*c;e<t;e++){const t=R*e,i=R*(e+1);k(g+I+t,g+n+t,g+n+i,g+I+i)}}}function x(e,g,t){i.push(e),i.push(g),i.push(t)}function z(e,g,n){M(e),M(g),M(n);const i=I.length/3,C=u.generateTopUV(t,I,i-3,i-2,i-1);L(C[0]),L(C[1]),L(C[2])}function k(e,g,n,i){M(e),M(g),M(i),M(g),M(n),M(i);const C=I.length/3,o=u.generateSideWallUV(t,I,C-6,C-3,C-2,C-1);L(o[0]),L(o[1]),L(o[3]),L(o[1]),L(o[2]),L(o[3])}function M(e){I.push(i[3*e+0]),I.push(i[3*e+1]),I.push(i[3*e+2])}function L(e){n.push(e.x),n.push(e.y)}!function(){const e=I.length/3;if(s){let e=0,g=R*e;for(let e=0;e<V;e++){const t=W[e];z(t[2]+g,t[1]+g,t[0]+g)}e=o+2*c,g=R*e;for(let e=0;e<V;e++){const t=W[e];z(t[0]+g,t[1]+g,t[2]+g)}}else{for(let e=0;e<V;e++){const g=W[e];z(g[2],g[1],g[0])}for(let e=0;e<V;e++){const g=W[e];z(g[0]+R*o,g[1]+R*o,g[2]+R*o)}}t.addGroup(e,I.length/3-e,0)}(),function(){const e=I.length/3;let g=0;F(f,g),g+=f.length;for(let e=0,t=v.length;e<t;e++){const t=v[e];F(t,g),g+=t.length}t.addGroup(e,I.length/3-e,1)}()}this.setAttribute("position",new Si(I,3)),this.setAttribute("uv",new Si(n,2)),this.computeVertexNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return function(e,g,t){if(t.shapes=[],Array.isArray(e))for(let g=0,I=e.length;g<I;g++){const I=e[g];t.shapes.push(I.uuid)}else t.shapes.push(e.uuid);return t.options=Object.assign({},g),void 0!==g.extrudePath&&(t.options.extrudePath=g.extrudePath.toJSON()),t}(this.parameters.shapes,this.parameters.options,e)}static fromJSON(e,g){const t=[];for(let I=0,n=e.shapes.length;I<n;I++){const n=g[e.shapes[I]];t.push(n)}const I=e.options.extrudePath;return void 0!==I&&(e.options.extrudePath=(new El[I.type]).fromJSON(I)),new Yr(t,e.options)}}const Kr={generateTopUV:function(e,g,t,I,n){const i=g[3*t],C=g[3*t+1],o=g[3*I],a=g[3*I+1],s=g[3*n],l=g[3*n+1];return[new AI(i,C),new AI(o,a),new AI(s,l)]},generateSideWallUV:function(e,g,t,I,n,i){const C=g[3*t],o=g[3*t+1],a=g[3*t+2],s=g[3*I],l=g[3*I+1],r=g[3*I+2],A=g[3*n],c=g[3*n+1],d=g[3*n+2],u=g[3*i],h=g[3*i+1],b=g[3*i+2];return Math.abs(o-l)<Math.abs(C-s)?[new AI(C,1-a),new AI(s,1-r),new AI(A,1-d),new AI(u,1-b)]:[new AI(o,1-a),new AI(l,1-r),new AI(c,1-d),new AI(h,1-b)]}};class Hr extends _l{constructor(e=1,g=0){const t=(1+Math.sqrt(5))/2;super([-1,t,0,1,t,0,-1,-t,0,1,-t,0,0,-1,t,0,1,t,0,-1,-t,0,1,-t,t,0,-1,t,0,1,-t,0,-1,-t,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,g),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:g}}static fromJSON(e){return new Hr(e.radius,e.detail)}}class Nr extends _l{constructor(e=1,g=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,g),this.type="OctahedronGeometry",this.parameters={radius:e,detail:g}}static fromJSON(e){return new Nr(e.radius,e.detail)}}class Fr extends Mi{constructor(e=.5,g=1,t=32,I=1,n=0,i=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:g,thetaSegments:t,phiSegments:I,thetaStart:n,thetaLength:i},t=Math.max(3,t);const C=[],o=[],a=[],s=[];let l=e;const r=(g-e)/(I=Math.max(1,I)),A=new UI,c=new AI;for(let e=0;e<=I;e++){for(let e=0;e<=t;e++){const I=n+e/t*i;A.x=l*Math.cos(I),A.y=l*Math.sin(I),o.push(A.x,A.y,A.z),a.push(0,0,1),c.x=(A.x/g+1)/2,c.y=(A.y/g+1)/2,s.push(c.x,c.y)}l+=r}for(let e=0;e<I;e++){const g=e*(t+1);for(let e=0;e<t;e++){const I=e+g,n=I,i=I+t+1,o=I+t+2,a=I+1;C.push(n,i,a),C.push(i,o,a)}}this.setIndex(C),this.setAttribute("position",new Si(o,3)),this.setAttribute("normal",new Si(a,3)),this.setAttribute("uv",new Si(s,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Fr(e.innerRadius,e.outerRadius,e.thetaSegments,e.phiSegments,e.thetaStart,e.thetaLength)}}class xr extends Mi{constructor(e=new nr([new AI(0,.5),new AI(-.5,-.5),new AI(.5,-.5)]),g=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:g};const t=[],I=[],n=[],i=[];let C=0,o=0;if(!1===Array.isArray(e))a(e);else for(let g=0;g<e.length;g++)a(e[g]),this.addGroup(C,o,g),C+=o,o=0;function a(e){const C=I.length/3,a=e.extractPoints(g);let s=a.shape;const l=a.holes;!1===Vr.isClockWise(s)&&(s=s.reverse());for(let e=0,g=l.length;e<g;e++){const g=l[e];!0===Vr.isClockWise(g)&&(l[e]=g.reverse())}const r=Vr.triangulateShape(s,l);for(let e=0,g=l.length;e<g;e++){const g=l[e];s=s.concat(g)}for(let e=0,g=s.length;e<g;e++){const g=s[e];I.push(g.x,g.y,0),n.push(0,0,1),i.push(g.x,g.y)}for(let e=0,g=r.length;e<g;e++){const g=r[e],I=g[0]+C,n=g[1]+C,i=g[2]+C;t.push(I,n,i),o+=3}}this.setIndex(t),this.setAttribute("position",new Si(I,3)),this.setAttribute("normal",new Si(n,3)),this.setAttribute("uv",new Si(i,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return function(e,g){if(g.shapes=[],Array.isArray(e))for(let t=0,I=e.length;t<I;t++){const I=e[t];g.shapes.push(I.uuid)}else g.shapes.push(e.uuid);return g}(this.parameters.shapes,e)}static fromJSON(e,g){const t=[];for(let I=0,n=e.shapes.length;I<n;I++){const n=g[e.shapes[I]];t.push(n)}return new xr(t,e.curveSegments)}}class zr extends Mi{constructor(e=1,g=32,t=16,I=0,n=2*Math.PI,i=0,C=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:g,heightSegments:t,phiStart:I,phiLength:n,thetaStart:i,thetaLength:C},g=Math.max(3,Math.floor(g)),t=Math.max(2,Math.floor(t));const o=Math.min(i+C,Math.PI);let a=0;const s=[],l=new UI,r=new UI,A=[],c=[],d=[],u=[];for(let A=0;A<=t;A++){const h=[],b=A/t;let m=0;0===A&&0===i?m=.5/g:A===t&&o===Math.PI&&(m=-.5/g);for(let t=0;t<=g;t++){const o=t/g;l.x=-e*Math.cos(I+o*n)*Math.sin(i+b*C),l.y=e*Math.cos(i+b*C),l.z=e*Math.sin(I+o*n)*Math.sin(i+b*C),c.push(l.x,l.y,l.z),r.copy(l).normalize(),d.push(r.x,r.y,r.z),u.push(o+m,1-b),h.push(a++)}s.push(h)}for(let e=0;e<t;e++)for(let I=0;I<g;I++){const g=s[e][I+1],n=s[e][I],C=s[e+1][I],a=s[e+1][I+1];(0!==e||i>0)&&A.push(g,n,a),(e!==t-1||o<Math.PI)&&A.push(n,C,a)}this.setIndex(A),this.setAttribute("position",new Si(c,3)),this.setAttribute("normal",new Si(d,3)),this.setAttribute("uv",new Si(u,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new zr(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class kr extends _l{constructor(e=1,g=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,g),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:g}}static fromJSON(e){return new kr(e.radius,e.detail)}}class Mr extends Mi{constructor(e=1,g=.4,t=12,I=48,n=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:e,tube:g,radialSegments:t,tubularSegments:I,arc:n},t=Math.floor(t),I=Math.floor(I);const i=[],C=[],o=[],a=[],s=new UI,l=new UI,r=new UI;for(let i=0;i<=t;i++)for(let A=0;A<=I;A++){const c=A/I*n,d=i/t*Math.PI*2;l.x=(e+g*Math.cos(d))*Math.cos(c),l.y=(e+g*Math.cos(d))*Math.sin(c),l.z=g*Math.sin(d),C.push(l.x,l.y,l.z),s.x=e*Math.cos(c),s.y=e*Math.sin(c),r.subVectors(l,s).normalize(),o.push(r.x,r.y,r.z),a.push(A/I),a.push(i/t)}for(let e=1;e<=t;e++)for(let g=1;g<=I;g++){const t=(I+1)*e+g-1,n=(I+1)*(e-1)+g-1,C=(I+1)*(e-1)+g,o=(I+1)*e+g;i.push(t,n,o),i.push(n,C,o)}this.setIndex(i),this.setAttribute("position",new Si(C,3)),this.setAttribute("normal",new Si(o,3)),this.setAttribute("uv",new Si(a,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Mr(e.radius,e.tube,e.radialSegments,e.tubularSegments,e.arc)}}class Lr extends Mi{constructor(e=1,g=.4,t=64,I=8,n=2,i=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:g,tubularSegments:t,radialSegments:I,p:n,q:i},t=Math.floor(t),I=Math.floor(I);const C=[],o=[],a=[],s=[],l=new UI,r=new UI,A=new UI,c=new UI,d=new UI,u=new UI,h=new UI;for(let C=0;C<=t;++C){const m=C/t*n*Math.PI*2;b(m,n,i,e,A),b(m+.01,n,i,e,c),u.subVectors(c,A),h.addVectors(c,A),d.crossVectors(u,h),h.crossVectors(d,u),d.normalize(),h.normalize();for(let e=0;e<=I;++e){const n=e/I*Math.PI*2,i=-g*Math.cos(n),c=g*Math.sin(n);l.x=A.x+(i*h.x+c*d.x),l.y=A.y+(i*h.y+c*d.y),l.z=A.z+(i*h.z+c*d.z),o.push(l.x,l.y,l.z),r.subVectors(l,A).normalize(),a.push(r.x,r.y,r.z),s.push(C/t),s.push(e/I)}}for(let e=1;e<=t;e++)for(let g=1;g<=I;g++){const t=(I+1)*(e-1)+(g-1),n=(I+1)*e+(g-1),i=(I+1)*e+g,o=(I+1)*(e-1)+g;C.push(t,n,o),C.push(n,i,o)}function b(e,g,t,I,n){const i=Math.cos(e),C=Math.sin(e),o=t/g*e,a=Math.cos(o);n.x=I*(2+a)*.5*i,n.y=I*(2+a)*C*.5,n.z=I*Math.sin(o)*.5}this.setIndex(C),this.setAttribute("position",new Si(o,3)),this.setAttribute("normal",new Si(a,3)),this.setAttribute("uv",new Si(s,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Lr(e.radius,e.tube,e.tubularSegments,e.radialSegments,e.p,e.q)}}class Jr extends Mi{constructor(e=new Ll(new UI(-1,-1,0),new UI(-1,1,0),new UI(1,1,0)),g=64,t=1,I=8,n=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:g,radius:t,radialSegments:I,closed:n};const i=e.computeFrenetFrames(g,n);this.tangents=i.tangents,this.normals=i.normals,this.binormals=i.binormals;const C=new UI,o=new UI,a=new AI;let s=new UI;const l=[],r=[],A=[],c=[];function d(n){s=e.getPointAt(n/g,s);const a=i.normals[n],A=i.binormals[n];for(let e=0;e<=I;e++){const g=e/I*Math.PI*2,n=Math.sin(g),i=-Math.cos(g);o.x=i*a.x+n*A.x,o.y=i*a.y+n*A.y,o.z=i*a.z+n*A.z,o.normalize(),r.push(o.x,o.y,o.z),C.x=s.x+t*o.x,C.y=s.y+t*o.y,C.z=s.z+t*o.z,l.push(C.x,C.y,C.z)}}!function(){for(let e=0;e<g;e++)d(e);d(!1===n?g:0),function(){for(let e=0;e<=g;e++)for(let t=0;t<=I;t++)a.x=e/g,a.y=t/I,A.push(a.x,a.y)}(),function(){for(let e=1;e<=g;e++)for(let g=1;g<=I;g++){const t=(I+1)*(e-1)+(g-1),n=(I+1)*e+(g-1),i=(I+1)*e+g,C=(I+1)*(e-1)+g;c.push(t,n,C),c.push(n,i,C)}}()}(),this.setIndex(c),this.setAttribute("position",new Si(l,3)),this.setAttribute("normal",new Si(r,3)),this.setAttribute("uv",new Si(A,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return e.path=this.parameters.path.toJSON(),e}static fromJSON(e){return new Jr((new El[e.path.type]).fromJSON(e.path),e.tubularSegments,e.radius,e.radialSegments,e.closed)}}class Er extends Mi{constructor(e=null){if(super(),this.type="WireframeGeometry",this.parameters={geometry:e},null!==e){const g=[],t=new Set,I=new UI,n=new UI;if(null!==e.index){const i=e.attributes.position,C=e.index;let o=e.groups;0===o.length&&(o=[{start:0,count:C.count,materialIndex:0}]);for(let e=0,a=o.length;e<a;++e){const a=o[e],s=a.start;for(let e=s,o=s+a.count;e<o;e+=3)for(let o=0;o<3;o++){const a=C.getX(e+o),s=C.getX(e+(o+1)%3);I.fromBufferAttribute(i,a),n.fromBufferAttribute(i,s),!0===Tr(I,n,t)&&(g.push(I.x,I.y,I.z),g.push(n.x,n.y,n.z))}}}else{const i=e.attributes.position;for(let e=0,C=i.count/3;e<C;e++)for(let C=0;C<3;C++){const o=3*e+C,a=3*e+(C+1)%3;I.fromBufferAttribute(i,o),n.fromBufferAttribute(i,a),!0===Tr(I,n,t)&&(g.push(I.x,I.y,I.z),g.push(n.x,n.y,n.z))}}this.setAttribute("position",new Si(g,3))}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}}function Tr(e,g,t){const I=`${e.x},${e.y},${e.z}-${g.x},${g.y},${g.z}`,n=`${g.x},${g.y},${g.z}-${e.x},${e.y},${e.z}`;return!0!==t.has(I)&&!0!==t.has(n)&&(t.add(I),t.add(n),!0)}var Ur=Object.freeze({__proto__:null,BoxGeometry:CC,CapsuleGeometry:Dl,CircleGeometry:Ol,ConeGeometry:Pl,CylinderGeometry:jl,DodecahedronGeometry:ql,EdgesGeometry:Ir,ExtrudeGeometry:Yr,IcosahedronGeometry:Hr,LatheGeometry:Ql,OctahedronGeometry:Nr,PlaneGeometry:wC,PolyhedronGeometry:_l,RingGeometry:Fr,ShapeGeometry:xr,SphereGeometry:zr,TetrahedronGeometry:kr,TorusGeometry:Mr,TorusKnotGeometry:Lr,TubeGeometry:Jr,WireframeGeometry:Er});class Qr extends oi{constructor(e){super(),this.isShadowMaterial=!0,this.type="ShadowMaterial",this.color=new Ai(0),this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.fog=e.fog,this}}class Dr extends rC{constructor(e){super(e),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class Or extends oi{constructor(e){super(),this.isMeshStandardMaterial=!0,this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Ai(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ai(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=tt,this.normalScale=new AI(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class jr extends Or{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new AI(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return II(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new Ai(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new Ai(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new Ai(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}class Pr extends oi{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new Ai(16777215),this.specular=new Ai(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ai(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=tt,this.normalScale=new AI(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=le,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class _r extends oi{constructor(e){super(),this.isMeshToonMaterial=!0,this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new Ai(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ai(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=tt,this.normalScale=new AI(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}class qr extends oi{constructor(e){super(),this.isMeshNormalMaterial=!0,this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=tt,this.normalScale=new AI(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this}}class $r extends oi{constructor(e){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new Ai(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ai(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=tt,this.normalScale=new AI(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=le,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class eA extends oi{constructor(e){super(),this.isMeshMatcapMaterial=!0,this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new Ai(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=tt,this.normalScale=new AI(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:""},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.flatShading=e.flatShading,this.fog=e.fog,this}}class gA extends el{constructor(e){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}}function tA(e,g,t){return!e||!t&&e.constructor===g?e:"number"==typeof g.BYTES_PER_ELEMENT?new g(e):Array.prototype.slice.call(e)}function IA(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}function nA(e){const g=e.length,t=new Array(g);for(let e=0;e!==g;++e)t[e]=e;return t.sort((function(g,t){return e[g]-e[t]})),t}function iA(e,g,t){const I=e.length,n=new e.constructor(I);for(let i=0,C=0;C!==I;++i){const I=t[i]*g;for(let t=0;t!==g;++t)n[C++]=e[I+t]}return n}function CA(e,g,t,I){let n=1,i=e[0];for(;void 0!==i&&void 0===i[I];)i=e[n++];if(void 0===i)return;let C=i[I];if(void 0!==C)if(Array.isArray(C))do{C=i[I],void 0!==C&&(g.push(i.time),t.push.apply(t,C)),i=e[n++]}while(void 0!==i);else if(void 0!==C.toArray)do{C=i[I],void 0!==C&&(g.push(i.time),C.toArray(t,t.length)),i=e[n++]}while(void 0!==i);else do{C=i[I],void 0!==C&&(g.push(i.time),t.push(C)),i=e[n++]}while(void 0!==i)}const oA={convertArray:tA,isTypedArray:IA,getKeyframeOrder:nA,sortedArray:iA,flattenJSON:CA,subclip:function(e,g,t,I,n=30){const i=e.clone();i.name=g;const C=[];for(let e=0;e<i.tracks.length;++e){const g=i.tracks[e],o=g.getValueSize(),a=[],s=[];for(let e=0;e<g.times.length;++e){const i=g.times[e]*n;if(!(i<t||i>=I)){a.push(g.times[e]);for(let t=0;t<o;++t)s.push(g.values[e*o+t])}}0!==a.length&&(g.times=tA(a,g.times.constructor),g.values=tA(s,g.values.constructor),C.push(g))}i.tracks=C;let o=1/0;for(let e=0;e<i.tracks.length;++e)o>i.tracks[e].times[0]&&(o=i.tracks[e].times[0]);for(let e=0;e<i.tracks.length;++e)i.tracks[e].shift(-1*o);return i.resetDuration(),i},makeClipAdditive:function(e,g=0,t=e,I=30){I<=0&&(I=30);const n=t.tracks.length,i=g/I;for(let g=0;g<n;++g){const I=t.tracks[g],n=I.ValueTypeName;if("bool"===n||"string"===n)continue;const C=e.tracks.find((function(e){return e.name===I.name&&e.ValueTypeName===n}));if(void 0===C)continue;let o=0;const a=I.getValueSize();I.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(o=a/3);let s=0;const l=C.getValueSize();C.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(s=l/3);const r=I.times.length-1;let A;if(i<=I.times[0]){const e=o,g=a-o;A=I.values.slice(e,g)}else if(i>=I.times[r]){const e=r*a+o,g=e+a-o;A=I.values.slice(e,g)}else{const e=I.createInterpolant(),g=o,t=a-o;e.evaluate(i),A=e.resultBuffer.slice(g,t)}"quaternion"===n&&(new TI).fromArray(A).normalize().conjugate().toArray(A);const c=C.times.length;for(let e=0;e<c;++e){const g=e*l+s;if("quaternion"===n)TI.multiplyQuaternionsFlat(C.values,g,A,0,C.values,g);else{const e=l-2*s;for(let t=0;t<e;++t)C.values[g+t]-=A[t]}}}return e.blendMode=Og,e}};class aA{constructor(e,g,t,I){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==I?I:new g.constructor(t),this.sampleValues=g,this.valueSize=t,this.settings=null,this.DefaultSettings_={}}evaluate(e){const g=this.parameterPositions;let t=this._cachedIndex,I=g[t],n=g[t-1];e:{g:{let i;t:{I:if(!(e<I)){for(let i=t+2;;){if(void 0===I){if(e<n)break I;return t=g.length,this._cachedIndex=t,this.copySampleValue_(t-1)}if(t===i)break;if(n=I,I=g[++t],e<I)break g}i=g.length;break t}if(e>=n)break e;{const C=g[1];e<C&&(t=2,n=C);for(let i=t-2;;){if(void 0===n)return this._cachedIndex=0,this.copySampleValue_(0);if(t===i)break;if(I=n,n=g[--t-1],e>=n)break g}i=t,t=0}}for(;t<i;){const I=t+i>>>1;e<g[I]?i=I:t=I+1}if(I=g[t],n=g[t-1],void 0===n)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===I)return t=g.length,this._cachedIndex=t,this.copySampleValue_(t-1)}this._cachedIndex=t,this.intervalChanged_(t,n,I)}return this.interpolate_(t,n,e,I)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const g=this.resultBuffer,t=this.sampleValues,I=this.valueSize,n=e*I;for(let e=0;e!==I;++e)g[e]=t[n+e];return g}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class sA extends aA{constructor(e,g,t,I){super(e,g,t,I),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:Tg,endingEnd:Tg}}intervalChanged_(e,g,t){const I=this.parameterPositions;let n=e-2,i=e+1,C=I[n],o=I[i];if(void 0===C)switch(this.getSettings_().endingStart){case Ug:n=e,C=2*g-t;break;case Qg:n=I.length-2,C=g+I[n]-I[n+1];break;default:n=e,C=t}if(void 0===o)switch(this.getSettings_().endingEnd){case Ug:i=e,o=2*t-g;break;case Qg:i=1,o=t+I[1]-I[0];break;default:i=e-1,o=g}const a=.5*(t-g),s=this.valueSize;this._weightPrev=a/(g-C),this._weightNext=a/(o-t),this._offsetPrev=n*s,this._offsetNext=i*s}interpolate_(e,g,t,I){const n=this.resultBuffer,i=this.sampleValues,C=this.valueSize,o=e*C,a=o-C,s=this._offsetPrev,l=this._offsetNext,r=this._weightPrev,A=this._weightNext,c=(t-g)/(I-g),d=c*c,u=d*c,h=-r*u+2*r*d-r*c,b=(1+r)*u+(-1.5-2*r)*d+(-.5+r)*c+1,m=(-1-A)*u+(1.5+A)*d+.5*c,p=A*u-A*d;for(let e=0;e!==C;++e)n[e]=h*i[s+e]+b*i[a+e]+m*i[o+e]+p*i[l+e];return n}}class lA extends aA{constructor(e,g,t,I){super(e,g,t,I)}interpolate_(e,g,t,I){const n=this.resultBuffer,i=this.sampleValues,C=this.valueSize,o=e*C,a=o-C,s=(t-g)/(I-g),l=1-s;for(let e=0;e!==C;++e)n[e]=i[a+e]*l+i[o+e]*s;return n}}class rA extends aA{constructor(e,g,t,I){super(e,g,t,I)}interpolate_(e){return this.copySampleValue_(e-1)}}class AA{constructor(e,g,t,I){if(void 0===e)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===g||0===g.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=tA(g,this.TimeBufferType),this.values=tA(t,this.ValueBufferType),this.setInterpolation(I||this.DefaultInterpolation)}static toJSON(e){const g=e.constructor;let t;if(g.toJSON!==this.toJSON)t=g.toJSON(e);else{t={name:e.name,times:tA(e.times,Array),values:tA(e.values,Array)};const g=e.getInterpolation();g!==e.DefaultInterpolation&&(t.interpolation=g)}return t.type=e.ValueTypeName,t}InterpolantFactoryMethodDiscrete(e){return new rA(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new lA(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new sA(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let g;switch(e){case Lg:g=this.InterpolantFactoryMethodDiscrete;break;case Jg:g=this.InterpolantFactoryMethodLinear;break;case Eg:g=this.InterpolantFactoryMethodSmooth}if(void 0===g){const g="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(g);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",g),this}return this.createInterpolant=g,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return Lg;case this.InterpolantFactoryMethodLinear:return Jg;case this.InterpolantFactoryMethodSmooth:return Eg}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){const g=this.times;for(let t=0,I=g.length;t!==I;++t)g[t]+=e}return this}scale(e){if(1!==e){const g=this.times;for(let t=0,I=g.length;t!==I;++t)g[t]*=e}return this}trim(e,g){const t=this.times,I=t.length;let n=0,i=I-1;for(;n!==I&&t[n]<e;)++n;for(;-1!==i&&t[i]>g;)--i;if(++i,0!==n||i!==I){n>=i&&(i=Math.max(i,1),n=i-1);const e=this.getValueSize();this.times=t.slice(n,i),this.values=this.values.slice(n*e,i*e)}return this}validate(){let e=!0;const g=this.getValueSize();g-Math.floor(g)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),e=!1);const t=this.times,I=this.values,n=t.length;0===n&&(console.error("THREE.KeyframeTrack: Track is empty.",this),e=!1);let i=null;for(let g=0;g!==n;g++){const I=t[g];if("number"==typeof I&&isNaN(I)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,g,I),e=!1;break}if(null!==i&&i>I){console.error("THREE.KeyframeTrack: Out of order keys.",this,g,I,i),e=!1;break}i=I}if(void 0!==I&&IA(I))for(let g=0,t=I.length;g!==t;++g){const t=I[g];if(isNaN(t)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,g,t),e=!1;break}}return e}optimize(){const e=this.times.slice(),g=this.values.slice(),t=this.getValueSize(),I=this.getInterpolation()===Eg,n=e.length-1;let i=1;for(let C=1;C<n;++C){let n=!1;const o=e[C];if(o!==e[C+1]&&(1!==C||o!==e[0]))if(I)n=!0;else{const e=C*t,I=e-t,i=e+t;for(let C=0;C!==t;++C){const t=g[e+C];if(t!==g[I+C]||t!==g[i+C]){n=!0;break}}}if(n){if(C!==i){e[i]=e[C];const I=C*t,n=i*t;for(let e=0;e!==t;++e)g[n+e]=g[I+e]}++i}}if(n>0){e[i]=e[n];for(let e=n*t,I=i*t,C=0;C!==t;++C)g[I+C]=g[e+C];++i}return i!==e.length?(this.times=e.slice(0,i),this.values=g.slice(0,i*t)):(this.times=e,this.values=g),this}clone(){const e=this.times.slice(),g=this.values.slice(),t=new(0,this.constructor)(this.name,e,g);return t.createInterpolant=this.createInterpolant,t}}AA.prototype.TimeBufferType=Float32Array,AA.prototype.ValueBufferType=Float32Array,AA.prototype.DefaultInterpolation=Jg;class cA extends AA{}cA.prototype.ValueTypeName="bool",cA.prototype.ValueBufferType=Array,cA.prototype.DefaultInterpolation=Lg,cA.prototype.InterpolantFactoryMethodLinear=void 0,cA.prototype.InterpolantFactoryMethodSmooth=void 0;class dA extends AA{}dA.prototype.ValueTypeName="color";class uA extends AA{}uA.prototype.ValueTypeName="number";class hA extends aA{constructor(e,g,t,I){super(e,g,t,I)}interpolate_(e,g,t,I){const n=this.resultBuffer,i=this.sampleValues,C=this.valueSize,o=(t-g)/(I-g);let a=e*C;for(let e=a+C;a!==e;a+=4)TI.slerpFlat(n,0,i,a-C,i,a,o);return n}}class bA extends AA{InterpolantFactoryMethodLinear(e){return new hA(this.times,this.values,this.getValueSize(),e)}}bA.prototype.ValueTypeName="quaternion",bA.prototype.DefaultInterpolation=Jg,bA.prototype.InterpolantFactoryMethodSmooth=void 0;class mA extends AA{}mA.prototype.ValueTypeName="string",mA.prototype.ValueBufferType=Array,mA.prototype.DefaultInterpolation=Lg,mA.prototype.InterpolantFactoryMethodLinear=void 0,mA.prototype.InterpolantFactoryMethodSmooth=void 0;class pA extends AA{}pA.prototype.ValueTypeName="vector";class GA{constructor(e,g=-1,t,I=Dg){this.name=e,this.tracks=t,this.duration=g,this.blendMode=I,this.uuid=tI(),this.duration<0&&this.resetDuration()}static parse(e){const g=[],t=e.tracks,I=1/(e.fps||1);for(let e=0,n=t.length;e!==n;++e)g.push(BA(t[e]).scale(I));const n=new this(e.name,e.duration,g,e.blendMode);return n.uuid=e.uuid,n}static toJSON(e){const g=[],t=e.tracks,I={name:e.name,duration:e.duration,tracks:g,uuid:e.uuid,blendMode:e.blendMode};for(let e=0,I=t.length;e!==I;++e)g.push(AA.toJSON(t[e]));return I}static CreateFromMorphTargetSequence(e,g,t,I){const n=g.length,i=[];for(let e=0;e<n;e++){let C=[],o=[];C.push((e+n-1)%n,e,(e+1)%n),o.push(0,1,0);const a=nA(C);C=iA(C,1,a),o=iA(o,1,a),I||0!==C[0]||(C.push(n),o.push(o[0])),i.push(new uA(".morphTargetInfluences["+g[e].name+"]",C,o).scale(1/t))}return new this(e,-1,i)}static findByName(e,g){let t=e;if(!Array.isArray(e)){const g=e;t=g.geometry&&g.geometry.animations||g.animations}for(let e=0;e<t.length;e++)if(t[e].name===g)return t[e];return null}static CreateClipsFromMorphTargetSequences(e,g,t){const I={},n=/^([\w-]*?)([\d]+)$/;for(let g=0,t=e.length;g<t;g++){const t=e[g],i=t.name.match(n);if(i&&i.length>1){const e=i[1];let g=I[e];g||(I[e]=g=[]),g.push(t)}}const i=[];for(const e in I)i.push(this.CreateFromMorphTargetSequence(e,I[e],g,t));return i}static parseAnimation(e,g){if(!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const t=function(e,g,t,I,n){if(0!==t.length){const i=[],C=[];CA(t,i,C,I),0!==i.length&&n.push(new e(g,i,C))}},I=[],n=e.name||"default",i=e.fps||30,C=e.blendMode;let o=e.length||-1;const a=e.hierarchy||[];for(let e=0;e<a.length;e++){const n=a[e].keys;if(n&&0!==n.length)if(n[0].morphTargets){const e={};let g;for(g=0;g<n.length;g++)if(n[g].morphTargets)for(let t=0;t<n[g].morphTargets.length;t++)e[n[g].morphTargets[t]]=-1;for(const t in e){const e=[],i=[];for(let I=0;I!==n[g].morphTargets.length;++I){const I=n[g];e.push(I.time),i.push(I.morphTarget===t?1:0)}I.push(new uA(".morphTargetInfluence["+t+"]",e,i))}o=e.length*i}else{const i=".bones["+g[e].name+"]";t(pA,i+".position",n,"pos",I),t(bA,i+".quaternion",n,"rot",I),t(pA,i+".scale",n,"scl",I)}}return 0===I.length?null:new this(n,o,I,C)}resetDuration(){let e=0;for(let g=0,t=this.tracks.length;g!==t;++g){const t=this.tracks[g];e=Math.max(e,t.times[t.times.length-1])}return this.duration=e,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let g=0;g<this.tracks.length;g++)e=e&&this.tracks[g].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let g=0;g<this.tracks.length;g++)e.push(this.tracks[g].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function BA(e){if(void 0===e.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const g=function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return uA;case"vector":case"vector2":case"vector3":case"vector4":return pA;case"color":return dA;case"quaternion":return bA;case"bool":case"boolean":return cA;case"string":return mA}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}(e.type);if(void 0===e.times){const g=[],t=[];CA(e.keys,g,t,"value"),e.times=g,e.values=t}return void 0!==g.parse?g.parse(e):new g(e.name,e.times,e.values,e.interpolation)}const ZA={enabled:!1,files:{},add:function(e,g){!1!==this.enabled&&(this.files[e]=g)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};class yA{constructor(e,g,t){const I=this;let n,i=!1,C=0,o=0;const a=[];this.onStart=void 0,this.onLoad=e,this.onProgress=g,this.onError=t,this.itemStart=function(e){o++,!1===i&&void 0!==I.onStart&&I.onStart(e,C,o),i=!0},this.itemEnd=function(e){C++,void 0!==I.onProgress&&I.onProgress(e,C,o),C===o&&(i=!1,void 0!==I.onLoad&&I.onLoad())},this.itemError=function(e){void 0!==I.onError&&I.onError(e)},this.resolveURL=function(e){return n?n(e):e},this.setURLModifier=function(e){return n=e,this},this.addHandler=function(e,g){return a.push(e,g),this},this.removeHandler=function(e){const g=a.indexOf(e);return-1!==g&&a.splice(g,2),this},this.getHandler=function(e){for(let g=0,t=a.length;g<t;g+=2){const t=a[g],I=a[g+1];if(t.global&&(t.lastIndex=0),t.test(e))return I}return null}}}const vA=new yA;class WA{constructor(e){this.manager=void 0!==e?e:vA,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,g){const t=this;return new Promise((function(I,n){t.load(e,I,g,n)}))}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}WA.DEFAULT_MATERIAL_NAME="__DEFAULT";const fA={};class wA extends Error{constructor(e,g){super(e),this.response=g}}class RA extends WA{constructor(e){super(e)}load(e,g,t,I){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const n=ZA.get(e);if(void 0!==n)return this.manager.itemStart(e),setTimeout((()=>{g&&g(n),this.manager.itemEnd(e)}),0),n;if(void 0!==fA[e])return void fA[e].push({onLoad:g,onProgress:t,onError:I});fA[e]=[],fA[e].push({onLoad:g,onProgress:t,onError:I});const i=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),C=this.mimeType,o=this.responseType;fetch(i).then((g=>{if(200===g.status||0===g.status){if(0===g.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===g.body||void 0===g.body.getReader)return g;const t=fA[e],I=g.body.getReader(),n=g.headers.get("Content-Length")||g.headers.get("X-File-Size"),i=n?parseInt(n):0,C=0!==i;let o=0;const a=new ReadableStream({start(e){!function g(){I.read().then((({done:I,value:n})=>{if(I)e.close();else{o+=n.byteLength;const I=new ProgressEvent("progress",{lengthComputable:C,loaded:o,total:i});for(let e=0,g=t.length;e<g;e++){const g=t[e];g.onProgress&&g.onProgress(I)}e.enqueue(n),g()}}))}()}});return new Response(a)}throw new wA(`fetch for "${g.url}" responded with ${g.status}: ${g.statusText}`,g)})).then((e=>{switch(o){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((e=>(new DOMParser).parseFromString(e,C)));case"json":return e.json();default:if(void 0===C)return e.text();{const g=/charset="?([^;"\s]*)"?/i.exec(C),t=g&&g[1]?g[1].toLowerCase():void 0,I=new TextDecoder(t);return e.arrayBuffer().then((e=>I.decode(e)))}}})).then((g=>{ZA.add(e,g);const t=fA[e];delete fA[e];for(let e=0,I=t.length;e<I;e++){const I=t[e];I.onLoad&&I.onLoad(g)}})).catch((g=>{const t=fA[e];if(void 0===t)throw this.manager.itemError(e),g;delete fA[e];for(let e=0,I=t.length;e<I;e++){const I=t[e];I.onError&&I.onError(g)}this.manager.itemError(e)})).finally((()=>{this.manager.itemEnd(e)})),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class VA extends WA{constructor(e){super(e)}load(e,g,t,I){const n=this,i=new RA(this.manager);i.setPath(this.path),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,(function(t){try{g(n.parse(JSON.parse(t)))}catch(g){I?I(g):console.error(g),n.manager.itemError(e)}}),t,I)}parse(e){const g=[];for(let t=0;t<e.length;t++){const I=GA.parse(e[t]);g.push(I)}return g}}class XA extends WA{constructor(e){super(e)}load(e,g,t,I){const n=this,i=[],C=new Gl,o=new RA(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(n.withCredentials);let a=0;function s(s){o.load(e[s],(function(e){const t=n.parse(e,!0);i[s]={width:t.width,height:t.height,format:t.format,mipmaps:t.mipmaps},a+=1,6===a&&(1===t.mipmapCount&&(C.minFilter=Ke),C.image=i,C.format=t.format,C.needsUpdate=!0,g&&g(C))}),t,I)}if(Array.isArray(e))for(let g=0,t=e.length;g<t;++g)s(g);else o.load(e,(function(e){const t=n.parse(e,!0);if(t.isCubemap){const e=t.mipmaps.length/t.mipmapCount;for(let g=0;g<e;g++){i[g]={mipmaps:[]};for(let e=0;e<t.mipmapCount;e++)i[g].mipmaps.push(t.mipmaps[g*t.mipmapCount+e]),i[g].format=t.format,i[g].width=t.width,i[g].height=t.height}C.image=i}else C.image.width=t.width,C.image.height=t.height,C.mipmaps=t.mipmaps;1===t.mipmapCount&&(C.minFilter=Ke),C.format=t.format,C.needsUpdate=!0,g&&g(C)}),t,I);return C}}class SA extends WA{constructor(e){super(e)}load(e,g,t,I){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const n=this,i=ZA.get(e);if(void 0!==i)return n.manager.itemStart(e),setTimeout((function(){g&&g(i),n.manager.itemEnd(e)}),0),i;const C=mI("img");function o(){s(),ZA.add(e,this),g&&g(this),n.manager.itemEnd(e)}function a(g){s(),I&&I(g),n.manager.itemError(e),n.manager.itemEnd(e)}function s(){C.removeEventListener("load",o,!1),C.removeEventListener("error",a,!1)}return C.addEventListener("load",o,!1),C.addEventListener("error",a,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(C.crossOrigin=this.crossOrigin),n.manager.itemStart(e),C.src=e,C}}class YA extends WA{constructor(e){super(e)}load(e,g,t,I){const n=new hC;n.colorSpace=it;const i=new SA(this.manager);i.setCrossOrigin(this.crossOrigin),i.setPath(this.path);let C=0;function o(t){i.load(e[t],(function(e){n.images[t]=e,C++,6===C&&(n.needsUpdate=!0,g&&g(n))}),void 0,I)}for(let g=0;g<e.length;++g)o(g);return n}}class KA extends WA{constructor(e){super(e)}load(e,g,t,I){const n=this,i=new Ls,C=new RA(this.manager);return C.setResponseType("arraybuffer"),C.setRequestHeader(this.requestHeader),C.setPath(this.path),C.setWithCredentials(n.withCredentials),C.load(e,(function(e){let t;try{t=n.parse(e)}catch(e){if(void 0===I)return void console.error(e);I(e)}void 0!==t.image?i.image=t.image:void 0!==t.data&&(i.image.width=t.width,i.image.height=t.height,i.image.data=t.data),i.wrapS=void 0!==t.wrapS?t.wrapS:fe,i.wrapT=void 0!==t.wrapT?t.wrapT:fe,i.magFilter=void 0!==t.magFilter?t.magFilter:Ke,i.minFilter=void 0!==t.minFilter?t.minFilter:Ke,i.anisotropy=void 0!==t.anisotropy?t.anisotropy:1,void 0!==t.colorSpace?i.colorSpace=t.colorSpace:void 0!==t.encoding&&(i.encoding=t.encoding),void 0!==t.flipY&&(i.flipY=t.flipY),void 0!==t.format&&(i.format=t.format),void 0!==t.type&&(i.type=t.type),void 0!==t.mipmaps&&(i.mipmaps=t.mipmaps,i.minFilter=Fe),1===t.mipmapCount&&(i.minFilter=Ke),void 0!==t.generateMipmaps&&(i.generateMipmaps=t.generateMipmaps),i.needsUpdate=!0,g&&g(i,t)}),t,I),i}}class HA extends WA{constructor(e){super(e)}load(e,g,t,I){const n=new NI,i=new SA(this.manager);return i.setCrossOrigin(this.crossOrigin),i.setPath(this.path),i.load(e,(function(e){n.image=e,n.needsUpdate=!0,void 0!==g&&g(n)}),t,I),n}}class NA extends Dn{constructor(e,g=1){super(),this.isLight=!0,this.type="Light",this.color=new Ai(e),this.intensity=g}dispose(){}copy(e,g){return super.copy(e,g),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const g=super.toJSON(e);return g.object.color=this.color.getHex(),g.object.intensity=this.intensity,void 0!==this.groundColor&&(g.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(g.object.distance=this.distance),void 0!==this.angle&&(g.object.angle=this.angle),void 0!==this.decay&&(g.object.decay=this.decay),void 0!==this.penumbra&&(g.object.penumbra=this.penumbra),void 0!==this.shadow&&(g.object.shadow=this.shadow.toJSON()),g}}class FA extends NA{constructor(e,g,t){super(e,t),this.isHemisphereLight=!0,this.type="HemisphereLight",this.position.copy(Dn.DEFAULT_UP),this.updateMatrix(),this.groundColor=new Ai(g)}copy(e,g){return super.copy(e,g),this.groundColor.copy(e.groundColor),this}}const xA=new Zn,zA=new UI,kA=new UI;class MA{constructor(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new AI(512,512),this.map=null,this.mapPass=null,this.matrix=new Zn,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new vC,this._frameExtents=new AI(1,1),this._viewportCount=1,this._viewports=[new FI(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const g=this.camera,t=this.matrix;zA.setFromMatrixPosition(e.matrixWorld),g.position.copy(zA),kA.setFromMatrixPosition(e.target.matrixWorld),g.lookAt(kA),g.updateMatrixWorld(),xA.multiplyMatrices(g.projectionMatrix,g.matrixWorldInverse),this._frustum.setFromProjectionMatrix(xA),t.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),t.multiply(xA)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class LA extends MA{constructor(){super(new cC(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(e){const g=this.camera,t=2*gI*e.angle*this.focus,I=this.mapSize.width/this.mapSize.height,n=e.distance||g.far;t===g.fov&&I===g.aspect&&n===g.far||(g.fov=t,g.aspect=I,g.far=n,g.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class JA extends NA{constructor(e,g,t=0,I=Math.PI/3,n=0,i=2){super(e,g),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(Dn.DEFAULT_UP),this.updateMatrix(),this.target=new Dn,this.distance=t,this.angle=I,this.penumbra=n,this.decay=i,this.map=null,this.shadow=new LA}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e,g){return super.copy(e,g),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}const EA=new Zn,TA=new UI,UA=new UI;class QA extends MA{constructor(){super(new cC(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new AI(4,2),this._viewportCount=6,this._viewports=[new FI(2,1,1,1),new FI(0,1,1,1),new FI(3,1,1,1),new FI(1,1,1,1),new FI(3,0,1,1),new FI(1,0,1,1)],this._cubeDirections=[new UI(1,0,0),new UI(-1,0,0),new UI(0,0,1),new UI(0,0,-1),new UI(0,1,0),new UI(0,-1,0)],this._cubeUps=[new UI(0,1,0),new UI(0,1,0),new UI(0,1,0),new UI(0,1,0),new UI(0,0,1),new UI(0,0,-1)]}updateMatrices(e,g=0){const t=this.camera,I=this.matrix,n=e.distance||t.far;n!==t.far&&(t.far=n,t.updateProjectionMatrix()),TA.setFromMatrixPosition(e.matrixWorld),t.position.copy(TA),UA.copy(t.position),UA.add(this._cubeDirections[g]),t.up.copy(this._cubeUps[g]),t.lookAt(UA),t.updateMatrixWorld(),I.makeTranslation(-TA.x,-TA.y,-TA.z),EA.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(EA)}}class DA extends NA{constructor(e,g,t=0,I=2){super(e,g),this.isPointLight=!0,this.type="PointLight",this.distance=t,this.decay=I,this.shadow=new QA}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e,g){return super.copy(e,g),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}class OA extends MA{constructor(){super(new zC(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class jA extends NA{constructor(e,g){super(e,g),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Dn.DEFAULT_UP),this.updateMatrix(),this.target=new Dn,this.shadow=new OA}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class PA extends NA{constructor(e,g){super(e,g),this.isAmbientLight=!0,this.type="AmbientLight"}}class _A extends NA{constructor(e,g,t=10,I=10){super(e,g),this.isRectAreaLight=!0,this.type="RectAreaLight",this.width=t,this.height=I}get power(){return this.intensity*this.width*this.height*Math.PI}set power(e){this.intensity=e/(this.width*this.height*Math.PI)}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){const g=super.toJSON(e);return g.object.width=this.width,g.object.height=this.height,g}}class qA{constructor(){this.isSphericalHarmonics3=!0,this.coefficients=[];for(let e=0;e<9;e++)this.coefficients.push(new UI)}set(e){for(let g=0;g<9;g++)this.coefficients[g].copy(e[g]);return this}zero(){for(let e=0;e<9;e++)this.coefficients[e].set(0,0,0);return this}getAt(e,g){const t=e.x,I=e.y,n=e.z,i=this.coefficients;return g.copy(i[0]).multiplyScalar(.282095),g.addScaledVector(i[1],.488603*I),g.addScaledVector(i[2],.488603*n),g.addScaledVector(i[3],.488603*t),g.addScaledVector(i[4],t*I*1.092548),g.addScaledVector(i[5],I*n*1.092548),g.addScaledVector(i[6],.315392*(3*n*n-1)),g.addScaledVector(i[7],t*n*1.092548),g.addScaledVector(i[8],.546274*(t*t-I*I)),g}getIrradianceAt(e,g){const t=e.x,I=e.y,n=e.z,i=this.coefficients;return g.copy(i[0]).multiplyScalar(.886227),g.addScaledVector(i[1],1.023328*I),g.addScaledVector(i[2],1.023328*n),g.addScaledVector(i[3],1.023328*t),g.addScaledVector(i[4],.858086*t*I),g.addScaledVector(i[5],.858086*I*n),g.addScaledVector(i[6],.743125*n*n-.247708),g.addScaledVector(i[7],.858086*t*n),g.addScaledVector(i[8],.429043*(t*t-I*I)),g}add(e){for(let g=0;g<9;g++)this.coefficients[g].add(e.coefficients[g]);return this}addScaledSH(e,g){for(let t=0;t<9;t++)this.coefficients[t].addScaledVector(e.coefficients[t],g);return this}scale(e){for(let g=0;g<9;g++)this.coefficients[g].multiplyScalar(e);return this}lerp(e,g){for(let t=0;t<9;t++)this.coefficients[t].lerp(e.coefficients[t],g);return this}equals(e){for(let g=0;g<9;g++)if(!this.coefficients[g].equals(e.coefficients[g]))return!1;return!0}copy(e){return this.set(e.coefficients)}clone(){return(new this.constructor).copy(this)}fromArray(e,g=0){const t=this.coefficients;for(let I=0;I<9;I++)t[I].fromArray(e,g+3*I);return this}toArray(e=[],g=0){const t=this.coefficients;for(let I=0;I<9;I++)t[I].toArray(e,g+3*I);return e}static getBasisAt(e,g){const t=e.x,I=e.y,n=e.z;g[0]=.282095,g[1]=.488603*I,g[2]=.488603*n,g[3]=.488603*t,g[4]=1.092548*t*I,g[5]=1.092548*I*n,g[6]=.315392*(3*n*n-1),g[7]=1.092548*t*n,g[8]=.546274*(t*t-I*I)}}class $A extends NA{constructor(e=new qA,g=1){super(void 0,g),this.isLightProbe=!0,this.sh=e}copy(e){return super.copy(e),this.sh.copy(e.sh),this}fromJSON(e){return this.intensity=e.intensity,this.sh.fromArray(e.sh),this}toJSON(e){const g=super.toJSON(e);return g.object.sh=this.sh.toArray(),g}}class ec extends WA{constructor(e){super(e),this.textures={}}load(e,g,t,I){const n=this,i=new RA(n.manager);i.setPath(n.path),i.setRequestHeader(n.requestHeader),i.setWithCredentials(n.withCredentials),i.load(e,(function(t){try{g(n.parse(JSON.parse(t)))}catch(g){I?I(g):console.error(g),n.manager.itemError(e)}}),t,I)}parse(e){const g=this.textures;function t(e){return void 0===g[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),g[e]}const I=ec.createMaterialFromType(e.type);if(void 0!==e.uuid&&(I.uuid=e.uuid),void 0!==e.name&&(I.name=e.name),void 0!==e.color&&void 0!==I.color&&I.color.setHex(e.color),void 0!==e.roughness&&(I.roughness=e.roughness),void 0!==e.metalness&&(I.metalness=e.metalness),void 0!==e.sheen&&(I.sheen=e.sheen),void 0!==e.sheenColor&&(I.sheenColor=(new Ai).setHex(e.sheenColor)),void 0!==e.sheenRoughness&&(I.sheenRoughness=e.sheenRoughness),void 0!==e.emissive&&void 0!==I.emissive&&I.emissive.setHex(e.emissive),void 0!==e.specular&&void 0!==I.specular&&I.specular.setHex(e.specular),void 0!==e.specularIntensity&&(I.specularIntensity=e.specularIntensity),void 0!==e.specularColor&&void 0!==I.specularColor&&I.specularColor.setHex(e.specularColor),void 0!==e.shininess&&(I.shininess=e.shininess),void 0!==e.clearcoat&&(I.clearcoat=e.clearcoat),void 0!==e.clearcoatRoughness&&(I.clearcoatRoughness=e.clearcoatRoughness),void 0!==e.iridescence&&(I.iridescence=e.iridescence),void 0!==e.iridescenceIOR&&(I.iridescenceIOR=e.iridescenceIOR),void 0!==e.iridescenceThicknessRange&&(I.iridescenceThicknessRange=e.iridescenceThicknessRange),void 0!==e.transmission&&(I.transmission=e.transmission),void 0!==e.thickness&&(I.thickness=e.thickness),void 0!==e.attenuationDistance&&(I.attenuationDistance=e.attenuationDistance),void 0!==e.attenuationColor&&void 0!==I.attenuationColor&&I.attenuationColor.setHex(e.attenuationColor),void 0!==e.anisotropy&&(I.anisotropy=e.anisotropy),void 0!==e.anisotropyRotation&&(I.anisotropyRotation=e.anisotropyRotation),void 0!==e.fog&&(I.fog=e.fog),void 0!==e.flatShading&&(I.flatShading=e.flatShading),void 0!==e.blending&&(I.blending=e.blending),void 0!==e.combine&&(I.combine=e.combine),void 0!==e.side&&(I.side=e.side),void 0!==e.shadowSide&&(I.shadowSide=e.shadowSide),void 0!==e.opacity&&(I.opacity=e.opacity),void 0!==e.transparent&&(I.transparent=e.transparent),void 0!==e.alphaTest&&(I.alphaTest=e.alphaTest),void 0!==e.alphaHash&&(I.alphaHash=e.alphaHash),void 0!==e.depthTest&&(I.depthTest=e.depthTest),void 0!==e.depthWrite&&(I.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(I.colorWrite=e.colorWrite),void 0!==e.stencilWrite&&(I.stencilWrite=e.stencilWrite),void 0!==e.stencilWriteMask&&(I.stencilWriteMask=e.stencilWriteMask),void 0!==e.stencilFunc&&(I.stencilFunc=e.stencilFunc),void 0!==e.stencilRef&&(I.stencilRef=e.stencilRef),void 0!==e.stencilFuncMask&&(I.stencilFuncMask=e.stencilFuncMask),void 0!==e.stencilFail&&(I.stencilFail=e.stencilFail),void 0!==e.stencilZFail&&(I.stencilZFail=e.stencilZFail),void 0!==e.stencilZPass&&(I.stencilZPass=e.stencilZPass),void 0!==e.wireframe&&(I.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(I.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(I.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(I.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.rotation&&(I.rotation=e.rotation),void 0!==e.linewidth&&(I.linewidth=e.linewidth),void 0!==e.dashSize&&(I.dashSize=e.dashSize),void 0!==e.gapSize&&(I.gapSize=e.gapSize),void 0!==e.scale&&(I.scale=e.scale),void 0!==e.polygonOffset&&(I.polygonOffset=e.polygonOffset),void 0!==e.polygonOffsetFactor&&(I.polygonOffsetFactor=e.polygonOffsetFactor),void 0!==e.polygonOffsetUnits&&(I.polygonOffsetUnits=e.polygonOffsetUnits),void 0!==e.dithering&&(I.dithering=e.dithering),void 0!==e.alphaToCoverage&&(I.alphaToCoverage=e.alphaToCoverage),void 0!==e.premultipliedAlpha&&(I.premultipliedAlpha=e.premultipliedAlpha),void 0!==e.forceSinglePass&&(I.forceSinglePass=e.forceSinglePass),void 0!==e.visible&&(I.visible=e.visible),void 0!==e.toneMapped&&(I.toneMapped=e.toneMapped),void 0!==e.userData&&(I.userData=e.userData),void 0!==e.vertexColors&&("number"==typeof e.vertexColors?I.vertexColors=e.vertexColors>0:I.vertexColors=e.vertexColors),void 0!==e.uniforms)for(const g in e.uniforms){const n=e.uniforms[g];switch(I.uniforms[g]={},n.type){case"t":I.uniforms[g].value=t(n.value);break;case"c":I.uniforms[g].value=(new Ai).setHex(n.value);break;case"v2":I.uniforms[g].value=(new AI).fromArray(n.value);break;case"v3":I.uniforms[g].value=(new UI).fromArray(n.value);break;case"v4":I.uniforms[g].value=(new FI).fromArray(n.value);break;case"m3":I.uniforms[g].value=(new cI).fromArray(n.value);break;case"m4":I.uniforms[g].value=(new Zn).fromArray(n.value);break;default:I.uniforms[g].value=n.value}}if(void 0!==e.defines&&(I.defines=e.defines),void 0!==e.vertexShader&&(I.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(I.fragmentShader=e.fragmentShader),void 0!==e.glslVersion&&(I.glslVersion=e.glslVersion),void 0!==e.extensions)for(const g in e.extensions)I.extensions[g]=e.extensions[g];if(void 0!==e.lights&&(I.lights=e.lights),void 0!==e.clipping&&(I.clipping=e.clipping),void 0!==e.size&&(I.size=e.size),void 0!==e.sizeAttenuation&&(I.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(I.map=t(e.map)),void 0!==e.matcap&&(I.matcap=t(e.matcap)),void 0!==e.alphaMap&&(I.alphaMap=t(e.alphaMap)),void 0!==e.bumpMap&&(I.bumpMap=t(e.bumpMap)),void 0!==e.bumpScale&&(I.bumpScale=e.bumpScale),void 0!==e.normalMap&&(I.normalMap=t(e.normalMap)),void 0!==e.normalMapType&&(I.normalMapType=e.normalMapType),void 0!==e.normalScale){let g=e.normalScale;!1===Array.isArray(g)&&(g=[g,g]),I.normalScale=(new AI).fromArray(g)}return void 0!==e.displacementMap&&(I.displacementMap=t(e.displacementMap)),void 0!==e.displacementScale&&(I.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(I.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(I.roughnessMap=t(e.roughnessMap)),void 0!==e.metalnessMap&&(I.metalnessMap=t(e.metalnessMap)),void 0!==e.emissiveMap&&(I.emissiveMap=t(e.emissiveMap)),void 0!==e.emissiveIntensity&&(I.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(I.specularMap=t(e.specularMap)),void 0!==e.specularIntensityMap&&(I.specularIntensityMap=t(e.specularIntensityMap)),void 0!==e.specularColorMap&&(I.specularColorMap=t(e.specularColorMap)),void 0!==e.envMap&&(I.envMap=t(e.envMap)),void 0!==e.envMapIntensity&&(I.envMapIntensity=e.envMapIntensity),void 0!==e.reflectivity&&(I.reflectivity=e.reflectivity),void 0!==e.refractionRatio&&(I.refractionRatio=e.refractionRatio),void 0!==e.lightMap&&(I.lightMap=t(e.lightMap)),void 0!==e.lightMapIntensity&&(I.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(I.aoMap=t(e.aoMap)),void 0!==e.aoMapIntensity&&(I.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(I.gradientMap=t(e.gradientMap)),void 0!==e.clearcoatMap&&(I.clearcoatMap=t(e.clearcoatMap)),void 0!==e.clearcoatRoughnessMap&&(I.clearcoatRoughnessMap=t(e.clearcoatRoughnessMap)),void 0!==e.clearcoatNormalMap&&(I.clearcoatNormalMap=t(e.clearcoatNormalMap)),void 0!==e.clearcoatNormalScale&&(I.clearcoatNormalScale=(new AI).fromArray(e.clearcoatNormalScale)),void 0!==e.iridescenceMap&&(I.iridescenceMap=t(e.iridescenceMap)),void 0!==e.iridescenceThicknessMap&&(I.iridescenceThicknessMap=t(e.iridescenceThicknessMap)),void 0!==e.transmissionMap&&(I.transmissionMap=t(e.transmissionMap)),void 0!==e.thicknessMap&&(I.thicknessMap=t(e.thicknessMap)),void 0!==e.anisotropyMap&&(I.anisotropyMap=t(e.anisotropyMap)),void 0!==e.sheenColorMap&&(I.sheenColorMap=t(e.sheenColorMap)),void 0!==e.sheenRoughnessMap&&(I.sheenRoughnessMap=t(e.sheenRoughnessMap)),I}setTextures(e){return this.textures=e,this}static createMaterialFromType(e){return new{ShadowMaterial:Qr,SpriteMaterial:rs,RawShaderMaterial:Dr,ShaderMaterial:rC,PointsMaterial:rl,MeshPhysicalMaterial:jr,MeshStandardMaterial:Or,MeshPhongMaterial:Pr,MeshToonMaterial:_r,MeshNormalMaterial:qr,MeshLambertMaterial:$r,MeshDepthMaterial:Ea,MeshDistanceMaterial:Ta,MeshBasicMaterial:di,MeshMatcapMaterial:eA,LineDashedMaterial:gA,LineBasicMaterial:el,Material:oi}[e]}}class gc{static decodeText(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let g="";for(let t=0,I=e.length;t<I;t++)g+=String.fromCharCode(e[t]);try{return decodeURIComponent(escape(g))}catch(e){return g}}static extractUrlBase(e){const g=e.lastIndexOf("/");return-1===g?"./":e.slice(0,g+1)}static resolveURL(e,g){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(g)&&/^\//.test(e)&&(g=g.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:g+e)}}class tc extends Mi{constructor(){super(),this.isInstancedBufferGeometry=!0,this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(e){return super.copy(e),this.instanceCount=e.instanceCount,this}toJSON(){const e=super.toJSON();return e.instanceCount=this.instanceCount,e.isInstancedBufferGeometry=!0,e}}class Ic extends WA{constructor(e){super(e)}load(e,g,t,I){const n=this,i=new RA(n.manager);i.setPath(n.path),i.setRequestHeader(n.requestHeader),i.setWithCredentials(n.withCredentials),i.load(e,(function(t){try{g(n.parse(JSON.parse(t)))}catch(g){I?I(g):console.error(g),n.manager.itemError(e)}}),t,I)}parse(e){const g={},t={};function I(e,I){if(void 0!==g[I])return g[I];const n=e.interleavedBuffers[I],i=function(e,g){if(void 0!==t[g])return t[g];const I=e.arrayBuffers[g],n=new Uint32Array(I).buffer;return t[g]=n,n}(e,n.buffer),C=bI(n.type,i),o=new as(C,n.stride);return o.uuid=n.uuid,g[I]=o,o}const n=e.isInstancedBufferGeometry?new tc:new Mi,i=e.data.index;if(void 0!==i){const e=bI(i.type,i.array);n.setIndex(new Zi(e,1))}const C=e.data.attributes;for(const g in C){const t=C[g];let i;if(t.isInterleavedBufferAttribute){const g=I(e.data,t.data);i=new ls(g,t.itemSize,t.offset,t.normalized)}else{const e=bI(t.type,t.array);i=new(t.isInstancedBufferAttribute?Us:Zi)(e,t.itemSize,t.normalized)}void 0!==t.name&&(i.name=t.name),void 0!==t.usage&&i.setUsage(t.usage),void 0!==t.updateRange&&(i.updateRange.offset=t.updateRange.offset,i.updateRange.count=t.updateRange.count),n.setAttribute(g,i)}const o=e.data.morphAttributes;if(o)for(const g in o){const t=o[g],i=[];for(let g=0,n=t.length;g<n;g++){const n=t[g];let C;if(n.isInterleavedBufferAttribute){const g=I(e.data,n.data);C=new ls(g,n.itemSize,n.offset,n.normalized)}else{const e=bI(n.type,n.array);C=new Zi(e,n.itemSize,n.normalized)}void 0!==n.name&&(C.name=n.name),i.push(C)}n.morphAttributes[g]=i}e.data.morphTargetsRelative&&(n.morphTargetsRelative=!0);const a=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==a)for(let e=0,g=a.length;e!==g;++e){const g=a[e];n.addGroup(g.start,g.count,g.materialIndex)}const s=e.data.boundingSphere;if(void 0!==s){const e=new UI;void 0!==s.center&&e.fromArray(s.center),n.boundingSphere=new cn(e,s.radius)}return e.name&&(n.name=e.name),e.userData&&(n.userData=e.userData),n}}class nc extends WA{constructor(e){super(e)}load(e,g,t,I){const n=this,i=""===this.path?gc.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||i;const C=new RA(this.manager);C.setPath(this.path),C.setRequestHeader(this.requestHeader),C.setWithCredentials(this.withCredentials),C.load(e,(function(t){let i=null;try{i=JSON.parse(t)}catch(g){return void 0!==I&&I(g),void console.error("THREE:ObjectLoader: Can't parse "+e+".",g.message)}const C=i.metadata;if(void 0===C||void 0===C.type||"geometry"===C.type.toLowerCase())return void 0!==I&&I(new Error("THREE.ObjectLoader: Can't load "+e)),void console.error("THREE.ObjectLoader: Can't load "+e);n.parse(i,g)}),t,I)}async loadAsync(e,g){const t=""===this.path?gc.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||t;const I=new RA(this.manager);I.setPath(this.path),I.setRequestHeader(this.requestHeader),I.setWithCredentials(this.withCredentials);const n=await I.loadAsync(e,g),i=JSON.parse(n),C=i.metadata;if(void 0===C||void 0===C.type||"geometry"===C.type.toLowerCase())throw new Error("THREE.ObjectLoader: Can't load "+e);return await this.parseAsync(i)}parse(e,g){const t=this.parseAnimations(e.animations),I=this.parseShapes(e.shapes),n=this.parseGeometries(e.geometries,I),i=this.parseImages(e.images,(function(){void 0!==g&&g(a)})),C=this.parseTextures(e.textures,i),o=this.parseMaterials(e.materials,C),a=this.parseObject(e.object,n,o,C,t),s=this.parseSkeletons(e.skeletons,a);if(this.bindSkeletons(a,s),void 0!==g){let e=!1;for(const g in i)if(i[g].data instanceof HTMLImageElement){e=!0;break}!1===e&&g(a)}return a}async parseAsync(e){const g=this.parseAnimations(e.animations),t=this.parseShapes(e.shapes),I=this.parseGeometries(e.geometries,t),n=await this.parseImagesAsync(e.images),i=this.parseTextures(e.textures,n),C=this.parseMaterials(e.materials,i),o=this.parseObject(e.object,I,C,i,g),a=this.parseSkeletons(e.skeletons,o);return this.bindSkeletons(o,a),o}parseShapes(e){const g={};if(void 0!==e)for(let t=0,I=e.length;t<I;t++){const I=(new nr).fromJSON(e[t]);g[I.uuid]=I}return g}parseSkeletons(e,g){const t={},I={};if(g.traverse((function(e){e.isBone&&(I[e.uuid]=e)})),void 0!==e)for(let g=0,n=e.length;g<n;g++){const n=(new Ts).fromJSON(e[g],I);t[n.uuid]=n}return t}parseGeometries(e,g){const t={};if(void 0!==e){const I=new Ic;for(let n=0,i=e.length;n<i;n++){let i;const C=e[n];switch(C.type){case"BufferGeometry":case"InstancedBufferGeometry":i=I.parse(C);break;default:C.type in Ur?i=Ur[C.type].fromJSON(C,g):console.warn(`THREE.ObjectLoader: Unsupported geometry type "${C.type}"`)}i.uuid=C.uuid,void 0!==C.name&&(i.name=C.name),void 0!==C.userData&&(i.userData=C.userData),t[C.uuid]=i}}return t}parseMaterials(e,g){const t={},I={};if(void 0!==e){const n=new ec;n.setTextures(g);for(let g=0,i=e.length;g<i;g++){const i=e[g];void 0===t[i.uuid]&&(t[i.uuid]=n.parse(i)),I[i.uuid]=t[i.uuid]}}return I}parseAnimations(e){const g={};if(void 0!==e)for(let t=0;t<e.length;t++){const I=e[t],n=GA.parse(I);g[n.uuid]=n}return g}parseImages(e,g){const t=this,I={};let n;function i(e){if("string"==typeof e){const g=e;return function(e){return t.manager.itemStart(e),n.load(e,(function(){t.manager.itemEnd(e)}),void 0,(function(){t.manager.itemError(e),t.manager.itemEnd(e)}))}(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(g)?g:t.resourcePath+g)}return e.data?{data:bI(e.type,e.data),width:e.width,height:e.height}:null}if(void 0!==e&&e.length>0){const t=new yA(g);n=new SA(t),n.setCrossOrigin(this.crossOrigin);for(let g=0,t=e.length;g<t;g++){const t=e[g],n=t.url;if(Array.isArray(n)){const e=[];for(let g=0,t=n.length;g<t;g++){const t=i(n[g]);null!==t&&(t instanceof HTMLImageElement?e.push(t):e.push(new Ls(t.data,t.width,t.height)))}I[t.uuid]=new YI(e)}else{const e=i(t.url);I[t.uuid]=new YI(e)}}}return I}async parseImagesAsync(e){const g=this,t={};let I;async function n(e){if("string"==typeof e){const t=e,n=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(t)?t:g.resourcePath+t;return await I.loadAsync(n)}return e.data?{data:bI(e.type,e.data),width:e.width,height:e.height}:null}if(void 0!==e&&e.length>0){I=new SA(this.manager),I.setCrossOrigin(this.crossOrigin);for(let g=0,I=e.length;g<I;g++){const I=e[g],i=I.url;if(Array.isArray(i)){const e=[];for(let g=0,t=i.length;g<t;g++){const t=i[g],I=await n(t);null!==I&&(I instanceof HTMLImageElement?e.push(I):e.push(new Ls(I.data,I.width,I.height)))}t[I.uuid]=new YI(e)}else{const e=await n(I.url);t[I.uuid]=new YI(e)}}}return t}parseTextures(e,g){function t(e,g){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),g[e])}const I={};if(void 0!==e)for(let n=0,i=e.length;n<i;n++){const i=e[n];void 0===i.image&&console.warn('THREE.ObjectLoader: No "image" specified for',i.uuid),void 0===g[i.image]&&console.warn("THREE.ObjectLoader: Undefined image",i.image);const C=g[i.image],o=C.data;let a;Array.isArray(o)?(a=new hC,6===o.length&&(a.needsUpdate=!0)):(a=o&&o.data?new Ls:new NI,o&&(a.needsUpdate=!0)),a.source=C,a.uuid=i.uuid,void 0!==i.name&&(a.name=i.name),void 0!==i.mapping&&(a.mapping=t(i.mapping,ic)),void 0!==i.channel&&(a.channel=i.channel),void 0!==i.offset&&a.offset.fromArray(i.offset),void 0!==i.repeat&&a.repeat.fromArray(i.repeat),void 0!==i.center&&a.center.fromArray(i.center),void 0!==i.rotation&&(a.rotation=i.rotation),void 0!==i.wrap&&(a.wrapS=t(i.wrap[0],Cc),a.wrapT=t(i.wrap[1],Cc)),void 0!==i.format&&(a.format=i.format),void 0!==i.internalFormat&&(a.internalFormat=i.internalFormat),void 0!==i.type&&(a.type=i.type),void 0!==i.colorSpace&&(a.colorSpace=i.colorSpace),void 0!==i.encoding&&(a.encoding=i.encoding),void 0!==i.minFilter&&(a.minFilter=t(i.minFilter,oc)),void 0!==i.magFilter&&(a.magFilter=t(i.magFilter,oc)),void 0!==i.anisotropy&&(a.anisotropy=i.anisotropy),void 0!==i.flipY&&(a.flipY=i.flipY),void 0!==i.generateMipmaps&&(a.generateMipmaps=i.generateMipmaps),void 0!==i.premultiplyAlpha&&(a.premultiplyAlpha=i.premultiplyAlpha),void 0!==i.unpackAlignment&&(a.unpackAlignment=i.unpackAlignment),void 0!==i.compareFunction&&(a.compareFunction=i.compareFunction),void 0!==i.userData&&(a.userData=i.userData),I[i.uuid]=a}return I}parseObject(e,g,t,I,n){let i,C,o;function a(e){return void 0===g[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),g[e]}function s(e){if(void 0!==e){if(Array.isArray(e)){const g=[];for(let I=0,n=e.length;I<n;I++){const n=e[I];void 0===t[n]&&console.warn("THREE.ObjectLoader: Undefined material",n),g.push(t[n])}return g}return void 0===t[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),t[e]}}function l(e){return void 0===I[e]&&console.warn("THREE.ObjectLoader: Undefined texture",e),I[e]}switch(e.type){case"Scene":i=new os,void 0!==e.background&&(Number.isInteger(e.background)?i.background=new Ai(e.background):i.background=l(e.background)),void 0!==e.environment&&(i.environment=l(e.environment)),void 0!==e.fog&&("Fog"===e.fog.type?i.fog=new Cs(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(i.fog=new is(e.fog.color,e.fog.density)),""!==e.fog.name&&(i.fog.name=e.fog.name)),void 0!==e.backgroundBlurriness&&(i.backgroundBlurriness=e.backgroundBlurriness),void 0!==e.backgroundIntensity&&(i.backgroundIntensity=e.backgroundIntensity);break;case"PerspectiveCamera":i=new cC(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(i.focus=e.focus),void 0!==e.zoom&&(i.zoom=e.zoom),void 0!==e.filmGauge&&(i.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(i.filmOffset=e.filmOffset),void 0!==e.view&&(i.view=Object.assign({},e.view));break;case"OrthographicCamera":i=new zC(e.left,e.right,e.top,e.bottom,e.near,e.far),void 0!==e.zoom&&(i.zoom=e.zoom),void 0!==e.view&&(i.view=Object.assign({},e.view));break;case"AmbientLight":i=new PA(e.color,e.intensity);break;case"DirectionalLight":i=new jA(e.color,e.intensity);break;case"PointLight":i=new DA(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":i=new _A(e.color,e.intensity,e.width,e.height);break;case"SpotLight":i=new JA(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay);break;case"HemisphereLight":i=new FA(e.color,e.groundColor,e.intensity);break;case"LightProbe":i=(new $A).fromJSON(e);break;case"SkinnedMesh":C=a(e.geometry),o=s(e.material),i=new ks(C,o),void 0!==e.bindMode&&(i.bindMode=e.bindMode),void 0!==e.bindMatrix&&i.bindMatrix.fromArray(e.bindMatrix),void 0!==e.skeleton&&(i.skeleton=e.skeleton);break;case"Mesh":C=a(e.geometry),o=s(e.material),i=new nC(C,o);break;case"InstancedMesh":C=a(e.geometry),o=s(e.material);const g=e.count,t=e.instanceMatrix,I=e.instanceColor;i=new $s(C,o,g),i.instanceMatrix=new Us(new Float32Array(t.array),16),void 0!==I&&(i.instanceColor=new Us(new Float32Array(I.array),I.itemSize));break;case"LOD":i=new Vs;break;case"Line":i=new Cl(a(e.geometry),s(e.material));break;case"LineLoop":i=new ll(a(e.geometry),s(e.material));break;case"LineSegments":i=new sl(a(e.geometry),s(e.material));break;case"PointCloud":case"Points":i=new hl(a(e.geometry),s(e.material));break;case"Sprite":i=new Ws(s(e.material));break;case"Group":i=new Pa;break;case"Bone":i=new Ms;break;default:i=new Dn}if(i.uuid=e.uuid,void 0!==e.name&&(i.name=e.name),void 0!==e.matrix?(i.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(i.matrixAutoUpdate=e.matrixAutoUpdate),i.matrixAutoUpdate&&i.matrix.decompose(i.position,i.quaternion,i.scale)):(void 0!==e.position&&i.position.fromArray(e.position),void 0!==e.rotation&&i.rotation.fromArray(e.rotation),void 0!==e.quaternion&&i.quaternion.fromArray(e.quaternion),void 0!==e.scale&&i.scale.fromArray(e.scale)),void 0!==e.up&&i.up.fromArray(e.up),void 0!==e.castShadow&&(i.castShadow=e.castShadow),void 0!==e.receiveShadow&&(i.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(i.shadow.bias=e.shadow.bias),void 0!==e.shadow.normalBias&&(i.shadow.normalBias=e.shadow.normalBias),void 0!==e.shadow.radius&&(i.shadow.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&i.shadow.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(i.shadow.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(i.visible=e.visible),void 0!==e.frustumCulled&&(i.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(i.renderOrder=e.renderOrder),void 0!==e.userData&&(i.userData=e.userData),void 0!==e.layers&&(i.layers.mask=e.layers),void 0!==e.children){const C=e.children;for(let e=0;e<C.length;e++)i.add(this.parseObject(C[e],g,t,I,n))}if(void 0!==e.animations){const g=e.animations;for(let e=0;e<g.length;e++){const t=g[e];i.animations.push(n[t])}}if("LOD"===e.type){void 0!==e.autoUpdate&&(i.autoUpdate=e.autoUpdate);const g=e.levels;for(let e=0;e<g.length;e++){const t=g[e],I=i.getObjectByProperty("uuid",t.object);void 0!==I&&i.addLevel(I,t.distance,t.hysteresis)}}return i}bindSkeletons(e,g){0!==Object.keys(g).length&&e.traverse((function(e){if(!0===e.isSkinnedMesh&&void 0!==e.skeleton){const t=g[e.skeleton];void 0===t?console.warn("THREE.ObjectLoader: No skeleton found with UUID:",e.skeleton):e.bind(t,e.bindMatrix)}}))}}const ic={UVMapping:pe,CubeReflectionMapping:Ge,CubeRefractionMapping:Be,EquirectangularReflectionMapping:Ze,EquirectangularRefractionMapping:ye,CubeUVReflectionMapping:ve},Cc={RepeatWrapping:We,ClampToEdgeWrapping:fe,MirroredRepeatWrapping:we},oc={NearestFilter:Re,NearestMipmapNearestFilter:Ve,NearestMipmapLinearFilter:Se,LinearFilter:Ke,LinearMipmapNearestFilter:He,LinearMipmapLinearFilter:Fe};class ac extends WA{constructor(e){super(e),this.isImageBitmapLoader=!0,"undefined"==typeof createImageBitmap&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"}}setOptions(e){return this.options=e,this}load(e,g,t,I){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const n=this,i=ZA.get(e);if(void 0!==i)return n.manager.itemStart(e),setTimeout((function(){g&&g(i),n.manager.itemEnd(e)}),0),i;const C={};C.credentials="anonymous"===this.crossOrigin?"same-origin":"include",C.headers=this.requestHeader,fetch(e,C).then((function(e){return e.blob()})).then((function(e){return createImageBitmap(e,Object.assign(n.options,{colorSpaceConversion:"none"}))})).then((function(t){ZA.add(e,t),g&&g(t),n.manager.itemEnd(e)})).catch((function(g){I&&I(g),n.manager.itemError(e),n.manager.itemEnd(e)})),n.manager.itemStart(e)}}let sc;class lc{static getContext(){return void 0===sc&&(sc=new(window.AudioContext||window.webkitAudioContext)),sc}static setContext(e){sc=e}}class rc extends WA{constructor(e){super(e)}load(e,g,t,I){const n=this,i=new RA(this.manager);function C(g){I?I(g):console.error(g),n.manager.itemError(e)}i.setResponseType("arraybuffer"),i.setPath(this.path),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,(function(e){try{const t=e.slice(0);lc.getContext().decodeAudioData(t,(function(e){g(e)}),C)}catch(e){C(e)}}),t,I)}}const Ac=new Zn,cc=new Zn,dc=new Zn;class uc{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new cC,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new cC,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(e){const g=this._cache;if(g.focus!==e.focus||g.fov!==e.fov||g.aspect!==e.aspect*this.aspect||g.near!==e.near||g.far!==e.far||g.zoom!==e.zoom||g.eyeSep!==this.eyeSep){g.focus=e.focus,g.fov=e.fov,g.aspect=e.aspect*this.aspect,g.near=e.near,g.far=e.far,g.zoom=e.zoom,g.eyeSep=this.eyeSep,dc.copy(e.projectionMatrix);const t=g.eyeSep/2,I=t*g.near/g.focus,n=g.near*Math.tan(eI*g.fov*.5)/g.zoom;let i,C;cc.elements[12]=-t,Ac.elements[12]=t,i=-n*g.aspect+I,C=n*g.aspect+I,dc.elements[0]=2*g.near/(C-i),dc.elements[8]=(C+i)/(C-i),this.cameraL.projectionMatrix.copy(dc),i=-n*g.aspect-I,C=n*g.aspect-I,dc.elements[0]=2*g.near/(C-i),dc.elements[8]=(C+i)/(C-i),this.cameraR.projectionMatrix.copy(dc)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(cc),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(Ac)}}class hc{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=bc(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const g=bc();e=(g-this.oldTime)/1e3,this.oldTime=g,this.elapsedTime+=e}return e}}function bc(){return("undefined"==typeof performance?Date:performance).now()}const mc=new UI,pc=new TI,Gc=new UI,Bc=new UI;class Zc extends Dn{constructor(){super(),this.type="AudioListener",this.context=lc.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new hc}getInput(){return this.gain}removeFilter(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(e){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}updateMatrixWorld(e){super.updateMatrixWorld(e);const g=this.context.listener,t=this.up;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(mc,pc,Gc),Bc.set(0,0,-1).applyQuaternion(pc),g.positionX){const e=this.context.currentTime+this.timeDelta;g.positionX.linearRampToValueAtTime(mc.x,e),g.positionY.linearRampToValueAtTime(mc.y,e),g.positionZ.linearRampToValueAtTime(mc.z,e),g.forwardX.linearRampToValueAtTime(Bc.x,e),g.forwardY.linearRampToValueAtTime(Bc.y,e),g.forwardZ.linearRampToValueAtTime(Bc.z,e),g.upX.linearRampToValueAtTime(t.x,e),g.upY.linearRampToValueAtTime(t.y,e),g.upZ.linearRampToValueAtTime(t.z,e)}else g.setPosition(mc.x,mc.y,mc.z),g.setOrientation(Bc.x,Bc.y,Bc.z,t.x,t.y,t.z)}}class yc extends Dn{constructor(e){super(),this.type="Audio",this.listener=e,this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this}setMediaElementSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(e),this.connect(),this}setMediaStreamSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(e),this.connect(),this}setBuffer(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this}play(e=0){if(!0===this.isPlaying)return void console.warn("THREE.Audio: Audio is already playing.");if(!1===this.hasPlaybackControl)return void console.warn("THREE.Audio: this Audio has no playback control.");this._startedAt=this.context.currentTime+e;const g=this.context.createBufferSource();return g.buffer=this.buffer,g.loop=this.loop,g.loopStart=this.loopStart,g.loopEnd=this.loopEnd,g.onended=this.onEnded.bind(this),g.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=g,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,!0===this.loop&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this;console.warn("THREE.Audio: this Audio has no playback control.")}stop(){if(!1!==this.hasPlaybackControl)return this._progress=0,null!==this.source&&(this.source.stop(),this.source.onended=null),this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let e=1,g=this.filters.length;e<g;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(!1!==this._connected){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let e=1,g=this.filters.length;e<g;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}}getFilters(){return this.filters}setFilters(e){return e||(e=[]),!0===this._connected?(this.disconnect(),this.filters=e.slice(),this.connect()):this.filters=e.slice(),this}setDetune(e){if(this.detune=e,void 0!==this.source.detune)return!0===this.isPlaying&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(e){return this.setFilters(e?[e]:[])}setPlaybackRate(e){if(!1!==this.hasPlaybackControl)return this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this;console.warn("THREE.Audio: this Audio has no playback control.")}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1}getLoop(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop}setLoop(e){if(!1!==this.hasPlaybackControl)return this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this;console.warn("THREE.Audio: this Audio has no playback control.")}setLoopStart(e){return this.loopStart=e,this}setLoopEnd(e){return this.loopEnd=e,this}getVolume(){return this.gain.gain.value}setVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}}const vc=new UI,Wc=new TI,fc=new UI,wc=new UI;class Rc extends yc{constructor(e){super(e),this.panner=this.context.createPanner(),this.panner.panningModel="HRTF",this.panner.connect(this.gain)}connect(){super.connect(),this.panner.connect(this.gain)}disconnect(){super.disconnect(),this.panner.disconnect(this.gain)}getOutput(){return this.panner}getRefDistance(){return this.panner.refDistance}setRefDistance(e){return this.panner.refDistance=e,this}getRolloffFactor(){return this.panner.rolloffFactor}setRolloffFactor(e){return this.panner.rolloffFactor=e,this}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(e){return this.panner.distanceModel=e,this}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(e){return this.panner.maxDistance=e,this}setDirectionalCone(e,g,t){return this.panner.coneInnerAngle=e,this.panner.coneOuterAngle=g,this.panner.coneOuterGain=t,this}updateMatrixWorld(e){if(super.updateMatrixWorld(e),!0===this.hasPlaybackControl&&!1===this.isPlaying)return;this.matrixWorld.decompose(vc,Wc,fc),wc.set(0,0,1).applyQuaternion(Wc);const g=this.panner;if(g.positionX){const e=this.context.currentTime+this.listener.timeDelta;g.positionX.linearRampToValueAtTime(vc.x,e),g.positionY.linearRampToValueAtTime(vc.y,e),g.positionZ.linearRampToValueAtTime(vc.z,e),g.orientationX.linearRampToValueAtTime(wc.x,e),g.orientationY.linearRampToValueAtTime(wc.y,e),g.orientationZ.linearRampToValueAtTime(wc.z,e)}else g.setPosition(vc.x,vc.y,vc.z),g.setOrientation(wc.x,wc.y,wc.z)}}class Vc{constructor(e,g=2048){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=g,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}getFrequencyData(){return this.analyser.getByteFrequencyData(this.data),this.data}getAverageFrequency(){let e=0;const g=this.getFrequencyData();for(let t=0;t<g.length;t++)e+=g[t];return e/g.length}}class Xc{constructor(e,g,t){let I,n,i;switch(this.binding=e,this.valueSize=t,g){case"quaternion":I=this._slerp,n=this._slerpAdditive,i=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*t),this._workIndex=5;break;case"string":case"bool":I=this._select,n=this._select,i=this._setAdditiveIdentityOther,this.buffer=new Array(5*t);break;default:I=this._lerp,n=this._lerpAdditive,i=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*t)}this._mixBufferRegion=I,this._mixBufferRegionAdditive=n,this._setIdentity=i,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(e,g){const t=this.buffer,I=this.valueSize,n=e*I+I;let i=this.cumulativeWeight;if(0===i){for(let e=0;e!==I;++e)t[n+e]=t[e];i=g}else{i+=g;const e=g/i;this._mixBufferRegion(t,n,0,e,I)}this.cumulativeWeight=i}accumulateAdditive(e){const g=this.buffer,t=this.valueSize,I=t*this._addIndex;0===this.cumulativeWeightAdditive&&this._setIdentity(),this._mixBufferRegionAdditive(g,I,0,e,t),this.cumulativeWeightAdditive+=e}apply(e){const g=this.valueSize,t=this.buffer,I=e*g+g,n=this.cumulativeWeight,i=this.cumulativeWeightAdditive,C=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,n<1){const e=g*this._origIndex;this._mixBufferRegion(t,I,e,1-n,g)}i>0&&this._mixBufferRegionAdditive(t,I,this._addIndex*g,1,g);for(let e=g,n=g+g;e!==n;++e)if(t[e]!==t[e+g]){C.setValue(t,I);break}}saveOriginalState(){const e=this.binding,g=this.buffer,t=this.valueSize,I=t*this._origIndex;e.getValue(g,I);for(let e=t,n=I;e!==n;++e)g[e]=g[I+e%t];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){const e=3*this.valueSize;this.binding.setValue(this.buffer,e)}_setAdditiveIdentityNumeric(){const e=this._addIndex*this.valueSize,g=e+this.valueSize;for(let t=e;t<g;t++)this.buffer[t]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const e=this._origIndex*this.valueSize,g=this._addIndex*this.valueSize;for(let t=0;t<this.valueSize;t++)this.buffer[g+t]=this.buffer[e+t]}_select(e,g,t,I,n){if(I>=.5)for(let I=0;I!==n;++I)e[g+I]=e[t+I]}_slerp(e,g,t,I){TI.slerpFlat(e,g,e,g,e,t,I)}_slerpAdditive(e,g,t,I,n){const i=this._workIndex*n;TI.multiplyQuaternionsFlat(e,i,e,g,e,t),TI.slerpFlat(e,g,e,g,e,i,I)}_lerp(e,g,t,I,n){const i=1-I;for(let C=0;C!==n;++C){const n=g+C;e[n]=e[n]*i+e[t+C]*I}}_lerpAdditive(e,g,t,I,n){for(let i=0;i!==n;++i){const n=g+i;e[n]=e[n]+e[t+i]*I}}}const Sc="\\[\\]\\.:\\/",Yc=new RegExp("["+Sc+"]","g"),Kc="[^"+Sc+"]",Hc="[^"+Sc.replace("\\.","")+"]",Nc=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",Kc)+/(WCOD+)?/.source.replace("WCOD",Hc)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",Kc)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",Kc)+"$"),Fc=["material","materials","bones","map"];class xc{constructor(e,g,t){this.path=g,this.parsedPath=t||xc.parseTrackName(g),this.node=xc.findNode(e,this.parsedPath.nodeName),this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,g,t){return e&&e.isAnimationObjectGroup?new xc.Composite(e,g,t):new xc(e,g,t)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(Yc,"")}static parseTrackName(e){const g=Nc.exec(e);if(null===g)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const t={nodeName:g[2],objectName:g[3],objectIndex:g[4],propertyName:g[5],propertyIndex:g[6]},I=t.nodeName&&t.nodeName.lastIndexOf(".");if(void 0!==I&&-1!==I){const e=t.nodeName.substring(I+1);-1!==Fc.indexOf(e)&&(t.nodeName=t.nodeName.substring(0,I),t.objectName=e)}if(null===t.propertyName||0===t.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return t}static findNode(e,g){if(void 0===g||""===g||"."===g||-1===g||g===e.name||g===e.uuid)return e;if(e.skeleton){const t=e.skeleton.getBoneByName(g);if(void 0!==t)return t}if(e.children){const t=function(e){for(let I=0;I<e.length;I++){const n=e[I];if(n.name===g||n.uuid===g)return n;const i=t(n.children);if(i)return i}return null},I=t(e.children);if(I)return I}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,g){e[g]=this.targetObject[this.propertyName]}_getValue_array(e,g){const t=this.resolvedProperty;for(let I=0,n=t.length;I!==n;++I)e[g++]=t[I]}_getValue_arrayElement(e,g){e[g]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,g){this.resolvedProperty.toArray(e,g)}_setValue_direct(e,g){this.targetObject[this.propertyName]=e[g]}_setValue_direct_setNeedsUpdate(e,g){this.targetObject[this.propertyName]=e[g],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,g){this.targetObject[this.propertyName]=e[g],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,g){const t=this.resolvedProperty;for(let I=0,n=t.length;I!==n;++I)t[I]=e[g++]}_setValue_array_setNeedsUpdate(e,g){const t=this.resolvedProperty;for(let I=0,n=t.length;I!==n;++I)t[I]=e[g++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,g){const t=this.resolvedProperty;for(let I=0,n=t.length;I!==n;++I)t[I]=e[g++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,g){this.resolvedProperty[this.propertyIndex]=e[g]}_setValue_arrayElement_setNeedsUpdate(e,g){this.resolvedProperty[this.propertyIndex]=e[g],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,g){this.resolvedProperty[this.propertyIndex]=e[g],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,g){this.resolvedProperty.fromArray(e,g)}_setValue_fromArray_setNeedsUpdate(e,g){this.resolvedProperty.fromArray(e,g),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,g){this.resolvedProperty.fromArray(e,g),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,g){this.bind(),this.getValue(e,g)}_setValue_unbound(e,g){this.bind(),this.setValue(e,g)}bind(){let e=this.node;const g=this.parsedPath,t=g.objectName,I=g.propertyName;let n=g.propertyIndex;if(e||(e=xc.findNode(this.rootNode,g.nodeName),this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void console.warn("THREE.PropertyBinding: No target node found for track: "+this.path+".");if(t){let I=g.objectIndex;switch(t){case"materials":if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(let g=0;g<e.length;g++)if(e[g].name===I){I=g;break}break;case"map":if("map"in e){e=e.map;break}if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.map)return void console.error("THREE.PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);e=e.material.map;break;default:if(void 0===e[t])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[t]}if(void 0!==I){if(void 0===e[I])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[I]}}const i=e[I];if(void 0===i){const t=g.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+t+"."+I+" but it wasn't found.",e)}let C=this.Versioning.None;this.targetObject=e,void 0!==e.needsUpdate?C=this.Versioning.NeedsUpdate:void 0!==e.matrixWorldNeedsUpdate&&(C=this.Versioning.MatrixWorldNeedsUpdate);let o=this.BindingType.Direct;if(void 0!==n){if("morphTargetInfluences"===I){if(!e.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!e.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==e.morphTargetDictionary[n]&&(n=e.morphTargetDictionary[n])}o=this.BindingType.ArrayElement,this.resolvedProperty=i,this.propertyIndex=n}else void 0!==i.fromArray&&void 0!==i.toArray?(o=this.BindingType.HasFromToArray,this.resolvedProperty=i):Array.isArray(i)?(o=this.BindingType.EntireArray,this.resolvedProperty=i):this.propertyName=I;this.getValue=this.GetterByBindingType[o],this.setValue=this.SetterByBindingTypeAndVersioning[o][C]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}xc.Composite=class{constructor(e,g,t){const I=t||xc.parseTrackName(g);this._targetGroup=e,this._bindings=e.subscribe_(g,I)}getValue(e,g){this.bind();const t=this._targetGroup.nCachedObjects_,I=this._bindings[t];void 0!==I&&I.getValue(e,g)}setValue(e,g){const t=this._bindings;for(let I=this._targetGroup.nCachedObjects_,n=t.length;I!==n;++I)t[I].setValue(e,g)}bind(){const e=this._bindings;for(let g=this._targetGroup.nCachedObjects_,t=e.length;g!==t;++g)e[g].bind()}unbind(){const e=this._bindings;for(let g=this._targetGroup.nCachedObjects_,t=e.length;g!==t;++g)e[g].unbind()}},xc.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},xc.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},xc.prototype.GetterByBindingType=[xc.prototype._getValue_direct,xc.prototype._getValue_array,xc.prototype._getValue_arrayElement,xc.prototype._getValue_toArray],xc.prototype.SetterByBindingTypeAndVersioning=[[xc.prototype._setValue_direct,xc.prototype._setValue_direct_setNeedsUpdate,xc.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[xc.prototype._setValue_array,xc.prototype._setValue_array_setNeedsUpdate,xc.prototype._setValue_array_setMatrixWorldNeedsUpdate],[xc.prototype._setValue_arrayElement,xc.prototype._setValue_arrayElement_setNeedsUpdate,xc.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[xc.prototype._setValue_fromArray,xc.prototype._setValue_fromArray_setNeedsUpdate,xc.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class zc{constructor(){this.isAnimationObjectGroup=!0,this.uuid=tI(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;const e={};this._indicesByUUID=e;for(let g=0,t=arguments.length;g!==t;++g)e[arguments[g].uuid]=g;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};const g=this;this.stats={objects:{get total(){return g._objects.length},get inUse(){return this.total-g.nCachedObjects_}},get bindingsPerObject(){return g._bindings.length}}}add(){const e=this._objects,g=this._indicesByUUID,t=this._paths,I=this._parsedPaths,n=this._bindings,i=n.length;let C,o=e.length,a=this.nCachedObjects_;for(let s=0,l=arguments.length;s!==l;++s){const l=arguments[s],r=l.uuid;let A=g[r];if(void 0===A){A=o++,g[r]=A,e.push(l);for(let e=0,g=i;e!==g;++e)n[e].push(new xc(l,t[e],I[e]))}else if(A<a){C=e[A];const o=--a,s=e[o];g[s.uuid]=A,e[A]=s,g[r]=o,e[o]=l;for(let e=0,g=i;e!==g;++e){const g=n[e],i=g[o];let C=g[A];g[A]=i,void 0===C&&(C=new xc(l,t[e],I[e])),g[o]=C}}else e[A]!==C&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=a}remove(){const e=this._objects,g=this._indicesByUUID,t=this._bindings,I=t.length;let n=this.nCachedObjects_;for(let i=0,C=arguments.length;i!==C;++i){const C=arguments[i],o=C.uuid,a=g[o];if(void 0!==a&&a>=n){const i=n++,s=e[i];g[s.uuid]=a,e[a]=s,g[o]=i,e[i]=C;for(let e=0,g=I;e!==g;++e){const g=t[e],I=g[i],n=g[a];g[a]=I,g[i]=n}}}this.nCachedObjects_=n}uncache(){const e=this._objects,g=this._indicesByUUID,t=this._bindings,I=t.length;let n=this.nCachedObjects_,i=e.length;for(let C=0,o=arguments.length;C!==o;++C){const o=arguments[C].uuid,a=g[o];if(void 0!==a)if(delete g[o],a<n){const C=--n,o=e[C],s=--i,l=e[s];g[o.uuid]=a,e[a]=o,g[l.uuid]=C,e[C]=l,e.pop();for(let e=0,g=I;e!==g;++e){const g=t[e],I=g[C],n=g[s];g[a]=I,g[C]=n,g.pop()}}else{const n=--i,C=e[n];n>0&&(g[C.uuid]=a),e[a]=C,e.pop();for(let e=0,g=I;e!==g;++e){const g=t[e];g[a]=g[n],g.pop()}}}this.nCachedObjects_=n}subscribe_(e,g){const t=this._bindingsIndicesByPath;let I=t[e];const n=this._bindings;if(void 0!==I)return n[I];const i=this._paths,C=this._parsedPaths,o=this._objects,a=o.length,s=this.nCachedObjects_,l=new Array(a);I=n.length,t[e]=I,i.push(e),C.push(g),n.push(l);for(let t=s,I=o.length;t!==I;++t){const I=o[t];l[t]=new xc(I,e,g)}return l}unsubscribe_(e){const g=this._bindingsIndicesByPath,t=g[e];if(void 0!==t){const I=this._paths,n=this._parsedPaths,i=this._bindings,C=i.length-1,o=i[C];g[e[C]]=t,i[t]=o,i.pop(),n[t]=n[C],n.pop(),I[t]=I[C],I.pop()}}}class kc{constructor(e,g,t=null,I=g.blendMode){this._mixer=e,this._clip=g,this._localRoot=t,this.blendMode=I;const n=g.tracks,i=n.length,C=new Array(i),o={endingStart:Tg,endingEnd:Tg};for(let e=0;e!==i;++e){const g=n[e].createInterpolant(null);C[e]=g,g.settings=o}this._interpolantSettings=o,this._interpolants=C,this._propertyBindings=new Array(i),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=kg,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(e){return this._startTime=e,this}setLoop(e,g){return this.loop=e,this.repetitions=g,this}setEffectiveWeight(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(e){return this._scheduleFading(e,0,1)}fadeOut(e){return this._scheduleFading(e,1,0)}crossFadeFrom(e,g,t){if(e.fadeOut(g),this.fadeIn(g),t){const t=this._clip.duration,I=e._clip.duration,n=I/t,i=t/I;e.warp(1,n,g),this.warp(i,1,g)}return this}crossFadeTo(e,g,t){return e.crossFadeFrom(this,g,t)}stopFading(){const e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}setEffectiveTimeScale(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(e){return this.timeScale=this._clip.duration/e,this.stopWarping()}syncWith(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()}halt(e){return this.warp(this._effectiveTimeScale,0,e)}warp(e,g,t){const I=this._mixer,n=I.time,i=this.timeScale;let C=this._timeScaleInterpolant;null===C&&(C=I._lendControlInterpolant(),this._timeScaleInterpolant=C);const o=C.parameterPositions,a=C.sampleValues;return o[0]=n,o[1]=n+t,a[0]=e/i,a[1]=g/i,this}stopWarping(){const e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(e,g,t,I){if(!this.enabled)return void this._updateWeight(e);const n=this._startTime;if(null!==n){const I=(e-n)*t;I<0||0===t?g=0:(this._startTime=null,g=t*I)}g*=this._updateTimeScale(e);const i=this._updateTime(g),C=this._updateWeight(e);if(C>0){const e=this._interpolants,g=this._propertyBindings;if(this.blendMode===Og)for(let t=0,I=e.length;t!==I;++t)e[t].evaluate(i),g[t].accumulateAdditive(C);else for(let t=0,n=e.length;t!==n;++t)e[t].evaluate(i),g[t].accumulate(I,C)}}_updateWeight(e){let g=0;if(this.enabled){g=this.weight;const t=this._weightInterpolant;if(null!==t){const I=t.evaluate(e)[0];g*=I,e>t.parameterPositions[1]&&(this.stopFading(),0===I&&(this.enabled=!1))}}return this._effectiveWeight=g,g}_updateTimeScale(e){let g=0;if(!this.paused){g=this.timeScale;const t=this._timeScaleInterpolant;null!==t&&(g*=t.evaluate(e)[0],e>t.parameterPositions[1]&&(this.stopWarping(),0===g?this.paused=!0:this.timeScale=g))}return this._effectiveTimeScale=g,g}_updateTime(e){const g=this._clip.duration,t=this.loop;let I=this.time+e,n=this._loopCount;const i=t===Mg;if(0===e)return-1===n?I:i&&1==(1&n)?g-I:I;if(t===zg){-1===n&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(I>=g)I=g;else{if(!(I<0)){this.time=I;break e}I=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=I,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{if(-1===n&&(e>=0?(n=0,this._setEndings(!0,0===this.repetitions,i)):this._setEndings(0===this.repetitions,!0,i)),I>=g||I<0){const t=Math.floor(I/g);I-=g*t,n+=Math.abs(t);const C=this.repetitions-n;if(C<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,I=e>0?g:0,this.time=I,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(1===C){const g=e<0;this._setEndings(g,!g,i)}else this._setEndings(!1,!1,i);this._loopCount=n,this.time=I,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:t})}}else this.time=I;if(i&&1==(1&n))return g-I}return I}_setEndings(e,g,t){const I=this._interpolantSettings;t?(I.endingStart=Ug,I.endingEnd=Ug):(I.endingStart=e?this.zeroSlopeAtStart?Ug:Tg:Qg,I.endingEnd=g?this.zeroSlopeAtEnd?Ug:Tg:Qg)}_scheduleFading(e,g,t){const I=this._mixer,n=I.time;let i=this._weightInterpolant;null===i&&(i=I._lendControlInterpolant(),this._weightInterpolant=i);const C=i.parameterPositions,o=i.sampleValues;return C[0]=n,o[0]=g,C[1]=n+e,o[1]=t,this}}const Mc=new Float32Array(1);class Lc extends _t{constructor(e){super(),this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(e,g){const t=e._localRoot||this._root,I=e._clip.tracks,n=I.length,i=e._propertyBindings,C=e._interpolants,o=t.uuid,a=this._bindingsByRootAndName;let s=a[o];void 0===s&&(s={},a[o]=s);for(let e=0;e!==n;++e){const n=I[e],a=n.name;let l=s[a];if(void 0!==l)++l.referenceCount,i[e]=l;else{if(l=i[e],void 0!==l){null===l._cacheIndex&&(++l.referenceCount,this._addInactiveBinding(l,o,a));continue}const I=g&&g._propertyBindings[e].binding.parsedPath;l=new Xc(xc.create(t,a,I),n.ValueTypeName,n.getValueSize()),++l.referenceCount,this._addInactiveBinding(l,o,a),i[e]=l}C[e].resultBuffer=l.buffer}}_activateAction(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){const g=(e._localRoot||this._root).uuid,t=e._clip.uuid,I=this._actionsByClip[t];this._bindAction(e,I&&I.knownActions[0]),this._addInactiveAction(e,t,g)}const g=e._propertyBindings;for(let e=0,t=g.length;e!==t;++e){const t=g[e];0==t.useCount++&&(this._lendBinding(t),t.saveOriginalState())}this._lendAction(e)}}_deactivateAction(e){if(this._isActiveAction(e)){const g=e._propertyBindings;for(let e=0,t=g.length;e!==t;++e){const t=g[e];0==--t.useCount&&(t.restoreOriginalState(),this._takeBackBinding(t))}this._takeBackAction(e)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}}_isActiveAction(e){const g=e._cacheIndex;return null!==g&&g<this._nActiveActions}_addInactiveAction(e,g,t){const I=this._actions,n=this._actionsByClip;let i=n[g];if(void 0===i)i={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,n[g]=i;else{const g=i.knownActions;e._byClipCacheIndex=g.length,g.push(e)}e._cacheIndex=I.length,I.push(e),i.actionByRoot[t]=e}_removeInactiveAction(e){const g=this._actions,t=g[g.length-1],I=e._cacheIndex;t._cacheIndex=I,g[I]=t,g.pop(),e._cacheIndex=null;const n=e._clip.uuid,i=this._actionsByClip,C=i[n],o=C.knownActions,a=o[o.length-1],s=e._byClipCacheIndex;a._byClipCacheIndex=s,o[s]=a,o.pop(),e._byClipCacheIndex=null,delete C.actionByRoot[(e._localRoot||this._root).uuid],0===o.length&&delete i[n],this._removeInactiveBindingsForAction(e)}_removeInactiveBindingsForAction(e){const g=e._propertyBindings;for(let e=0,t=g.length;e!==t;++e){const t=g[e];0==--t.referenceCount&&this._removeInactiveBinding(t)}}_lendAction(e){const g=this._actions,t=e._cacheIndex,I=this._nActiveActions++,n=g[I];e._cacheIndex=I,g[I]=e,n._cacheIndex=t,g[t]=n}_takeBackAction(e){const g=this._actions,t=e._cacheIndex,I=--this._nActiveActions,n=g[I];e._cacheIndex=I,g[I]=e,n._cacheIndex=t,g[t]=n}_addInactiveBinding(e,g,t){const I=this._bindingsByRootAndName,n=this._bindings;let i=I[g];void 0===i&&(i={},I[g]=i),i[t]=e,e._cacheIndex=n.length,n.push(e)}_removeInactiveBinding(e){const g=this._bindings,t=e.binding,I=t.rootNode.uuid,n=t.path,i=this._bindingsByRootAndName,C=i[I],o=g[g.length-1],a=e._cacheIndex;o._cacheIndex=a,g[a]=o,g.pop(),delete C[n],0===Object.keys(C).length&&delete i[I]}_lendBinding(e){const g=this._bindings,t=e._cacheIndex,I=this._nActiveBindings++,n=g[I];e._cacheIndex=I,g[I]=e,n._cacheIndex=t,g[t]=n}_takeBackBinding(e){const g=this._bindings,t=e._cacheIndex,I=--this._nActiveBindings,n=g[I];e._cacheIndex=I,g[I]=e,n._cacheIndex=t,g[t]=n}_lendControlInterpolant(){const e=this._controlInterpolants,g=this._nActiveControlInterpolants++;let t=e[g];return void 0===t&&(t=new lA(new Float32Array(2),new Float32Array(2),1,Mc),t.__cacheIndex=g,e[g]=t),t}_takeBackControlInterpolant(e){const g=this._controlInterpolants,t=e.__cacheIndex,I=--this._nActiveControlInterpolants,n=g[I];e.__cacheIndex=I,g[I]=e,n.__cacheIndex=t,g[t]=n}clipAction(e,g,t){const I=g||this._root,n=I.uuid;let i="string"==typeof e?GA.findByName(I,e):e;const C=null!==i?i.uuid:e,o=this._actionsByClip[C];let a=null;if(void 0===t&&(t=null!==i?i.blendMode:Dg),void 0!==o){const e=o.actionByRoot[n];if(void 0!==e&&e.blendMode===t)return e;a=o.knownActions[0],null===i&&(i=a._clip)}if(null===i)return null;const s=new kc(this,i,g,t);return this._bindAction(s,a),this._addInactiveAction(s,C,n),s}existingAction(e,g){const t=g||this._root,I=t.uuid,n="string"==typeof e?GA.findByName(t,e):e,i=n?n.uuid:e,C=this._actionsByClip[i];return void 0!==C&&C.actionByRoot[I]||null}stopAllAction(){const e=this._actions;for(let g=this._nActiveActions-1;g>=0;--g)e[g].stop();return this}update(e){e*=this.timeScale;const g=this._actions,t=this._nActiveActions,I=this.time+=e,n=Math.sign(e),i=this._accuIndex^=1;for(let C=0;C!==t;++C)g[C]._update(I,e,n,i);const C=this._bindings,o=this._nActiveBindings;for(let e=0;e!==o;++e)C[e].apply(i);return this}setTime(e){this.time=0;for(let e=0;e<this._actions.length;e++)this._actions[e].time=0;return this.update(e)}getRoot(){return this._root}uncacheClip(e){const g=this._actions,t=e.uuid,I=this._actionsByClip,n=I[t];if(void 0!==n){const e=n.knownActions;for(let t=0,I=e.length;t!==I;++t){const I=e[t];this._deactivateAction(I);const n=I._cacheIndex,i=g[g.length-1];I._cacheIndex=null,I._byClipCacheIndex=null,i._cacheIndex=n,g[n]=i,g.pop(),this._removeInactiveBindingsForAction(I)}delete I[t]}}uncacheRoot(e){const g=e.uuid,t=this._actionsByClip;for(const e in t){const I=t[e].actionByRoot[g];void 0!==I&&(this._deactivateAction(I),this._removeInactiveAction(I))}const I=this._bindingsByRootAndName[g];if(void 0!==I)for(const e in I){const g=I[e];g.restoreOriginalState(),this._removeInactiveBinding(g)}}uncacheAction(e,g){const t=this.existingAction(e,g);null!==t&&(this._deactivateAction(t),this._removeInactiveAction(t))}}class Jc{constructor(e){this.value=e}clone(){return new Jc(void 0===this.value.clone?this.value:this.value.clone())}}let Ec=0;class Tc extends _t{constructor(){super(),this.isUniformsGroup=!0,Object.defineProperty(this,"id",{value:Ec++}),this.name="",this.usage=xt,this.uniforms=[]}add(e){return this.uniforms.push(e),this}remove(e){const g=this.uniforms.indexOf(e);return-1!==g&&this.uniforms.splice(g,1),this}setName(e){return this.name=e,this}setUsage(e){return this.usage=e,this}dispose(){return this.dispatchEvent({type:"dispose"}),this}copy(e){this.name=e.name,this.usage=e.usage;const g=e.uniforms;this.uniforms.length=0;for(let e=0,t=g.length;e<t;e++)this.uniforms.push(g[e].clone());return this}clone(){return(new this.constructor).copy(this)}}class Uc extends as{constructor(e,g,t=1){super(e,g),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=t}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}clone(e){const g=super.clone(e);return g.meshPerAttribute=this.meshPerAttribute,g}toJSON(e){const g=super.toJSON(e);return g.isInstancedInterleavedBuffer=!0,g.meshPerAttribute=this.meshPerAttribute,g}}class Qc{constructor(e,g,t,I,n){this.isGLBufferAttribute=!0,this.name="",this.buffer=e,this.type=g,this.itemSize=t,this.elementSize=I,this.count=n,this.version=0}set needsUpdate(e){!0===e&&this.version++}setBuffer(e){return this.buffer=e,this}setType(e,g){return this.type=e,this.elementSize=g,this}setItemSize(e){return this.itemSize=e,this}setCount(e){return this.count=e,this}}class Dc{constructor(e,g,t=0,I=1/0){this.ray=new Bn(e,g),this.near=t,this.far=I,this.camera=null,this.layers=new Kn,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,g){this.ray.set(e,g)}setFromCamera(e,g){g.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(g.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(g).sub(this.ray.origin).normalize(),this.camera=g):g.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(g.near+g.far)/(g.near-g.far)).unproject(g),this.ray.direction.set(0,0,-1).transformDirection(g.matrixWorld),this.camera=g):console.error("THREE.Raycaster: Unsupported camera type: "+g.type)}intersectObject(e,g=!0,t=[]){return jc(e,this,t,g),t.sort(Oc),t}intersectObjects(e,g=!0,t=[]){for(let I=0,n=e.length;I<n;I++)jc(e[I],this,t,g);return t.sort(Oc),t}}function Oc(e,g){return e.distance-g.distance}function jc(e,g,t,I){if(e.layers.test(g.layers)&&e.raycast(g,t),!0===I){const I=e.children;for(let e=0,n=I.length;e<n;e++)jc(I[e],g,t,!0)}}class Pc{constructor(e=1,g=0,t=0){return this.radius=e,this.phi=g,this.theta=t,this}set(e,g,t){return this.radius=e,this.phi=g,this.theta=t,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){const e=1e-6;return this.phi=Math.max(e,Math.min(Math.PI-e,this.phi)),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,g,t){return this.radius=Math.sqrt(e*e+g*g+t*t),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,t),this.phi=Math.acos(II(g/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}class _c{constructor(e=1,g=0,t=0){return this.radius=e,this.theta=g,this.y=t,this}set(e,g,t){return this.radius=e,this.theta=g,this.y=t,this}copy(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,g,t){return this.radius=Math.sqrt(e*e+t*t),this.theta=Math.atan2(e,t),this.y=g,this}clone(){return(new this.constructor).copy(this)}}const qc=new AI;class $c{constructor(e=new AI(1/0,1/0),g=new AI(-1/0,-1/0)){this.isBox2=!0,this.min=e,this.max=g}set(e,g){return this.min.copy(e),this.max.copy(g),this}setFromPoints(e){this.makeEmpty();for(let g=0,t=e.length;g<t;g++)this.expandByPoint(e[g]);return this}setFromCenterAndSize(e,g){const t=qc.copy(g).multiplyScalar(.5);return this.min.copy(e).sub(t),this.max.copy(e).add(t),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(e){return this.isEmpty()?e.set(0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y}getParameter(e,g){return g.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)}clampPoint(e,g){return g.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,qc).distanceTo(e)}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const ed=new UI,gd=new UI;class td{constructor(e=new UI,g=new UI){this.start=e,this.end=g}set(e,g){return this.start.copy(e),this.end.copy(g),this}copy(e){return this.start.copy(e.start),this.end.copy(e.end),this}getCenter(e){return e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e){return e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,g){return this.delta(g).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,g){ed.subVectors(e,this.start),gd.subVectors(this.end,this.start);const t=gd.dot(gd);let I=gd.dot(ed)/t;return g&&(I=II(I,0,1)),I}closestPointToPoint(e,g,t){const I=this.closestPointToPointParameter(e,g);return this.delta(t).multiplyScalar(I).add(this.start)}applyMatrix4(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}}const Id=new UI;class nd extends Dn{constructor(e,g){super(),this.light=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=g,this.type="SpotLightHelper";const t=new Mi,I=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let e=0,g=1,t=32;e<t;e++,g++){const n=e/t*Math.PI*2,i=g/t*Math.PI*2;I.push(Math.cos(n),Math.sin(n),1,Math.cos(i),Math.sin(i),1)}t.setAttribute("position",new Si(I,3));const n=new el({fog:!1,toneMapped:!1});this.cone=new sl(t,n),this.add(this.cone),this.update()}dispose(){this.cone.geometry.dispose(),this.cone.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1);const e=this.light.distance?this.light.distance:1e3,g=e*Math.tan(this.light.angle);this.cone.scale.set(g,g,e),Id.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(Id),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}}const id=new UI,Cd=new Zn,od=new Zn;class ad extends sl{constructor(e){const g=sd(e),t=new Mi,I=[],n=[],i=new Ai(0,0,1),C=new Ai(0,1,0);for(let e=0;e<g.length;e++){const t=g[e];t.parent&&t.parent.isBone&&(I.push(0,0,0),I.push(0,0,0),n.push(i.r,i.g,i.b),n.push(C.r,C.g,C.b))}t.setAttribute("position",new Si(I,3)),t.setAttribute("color",new Si(n,3)),super(t,new el({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.isSkeletonHelper=!0,this.type="SkeletonHelper",this.root=e,this.bones=g,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(e){const g=this.bones,t=this.geometry,I=t.getAttribute("position");od.copy(this.root.matrixWorld).invert();for(let e=0,t=0;e<g.length;e++){const n=g[e];n.parent&&n.parent.isBone&&(Cd.multiplyMatrices(od,n.matrixWorld),id.setFromMatrixPosition(Cd),I.setXYZ(t,id.x,id.y,id.z),Cd.multiplyMatrices(od,n.parent.matrixWorld),id.setFromMatrixPosition(Cd),I.setXYZ(t+1,id.x,id.y,id.z),t+=2)}t.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(e)}dispose(){this.geometry.dispose(),this.material.dispose()}}function sd(e){const g=[];!0===e.isBone&&g.push(e);for(let t=0;t<e.children.length;t++)g.push.apply(g,sd(e.children[t]));return g}class ld extends nC{constructor(e,g,t){super(new zr(g,4,2),new di({wireframe:!0,fog:!1,toneMapped:!1})),this.light=e,this.color=t,this.type="PointLightHelper",this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}dispose(){this.geometry.dispose(),this.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)}}const rd=new UI,Ad=new Ai,cd=new Ai;class dd extends Dn{constructor(e,g,t){super(),this.light=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=t,this.type="HemisphereLightHelper";const I=new Nr(g);I.rotateY(.5*Math.PI),this.material=new di({wireframe:!0,fog:!1,toneMapped:!1}),void 0===this.color&&(this.material.vertexColors=!0);const n=I.getAttribute("position"),i=new Float32Array(3*n.count);I.setAttribute("color",new Zi(i,3)),this.add(new nC(I,this.material)),this.update()}dispose(){this.children[0].geometry.dispose(),this.children[0].material.dispose()}update(){const e=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{const g=e.geometry.getAttribute("color");Ad.copy(this.light.color),cd.copy(this.light.groundColor);for(let e=0,t=g.count;e<t;e++){const I=e<t/2?Ad:cd;g.setXYZ(e,I.r,I.g,I.b)}g.needsUpdate=!0}this.light.updateWorldMatrix(!0,!1),e.lookAt(rd.setFromMatrixPosition(this.light.matrixWorld).negate())}}class ud extends sl{constructor(e=10,g=10,t=4473924,I=8947848){t=new Ai(t),I=new Ai(I);const n=g/2,i=e/g,C=e/2,o=[],a=[];for(let e=0,s=0,l=-C;e<=g;e++,l+=i){o.push(-C,0,l,C,0,l),o.push(l,0,-C,l,0,C);const g=e===n?t:I;g.toArray(a,s),s+=3,g.toArray(a,s),s+=3,g.toArray(a,s),s+=3,g.toArray(a,s),s+=3}const s=new Mi;s.setAttribute("position",new Si(o,3)),s.setAttribute("color",new Si(a,3)),super(s,new el({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}}class hd extends sl{constructor(e=10,g=16,t=8,I=64,n=4473924,i=8947848){n=new Ai(n),i=new Ai(i);const C=[],o=[];if(g>1)for(let t=0;t<g;t++){const I=t/g*(2*Math.PI),a=Math.sin(I)*e,s=Math.cos(I)*e;C.push(0,0,0),C.push(a,0,s);const l=1&t?n:i;o.push(l.r,l.g,l.b),o.push(l.r,l.g,l.b)}for(let g=0;g<t;g++){const a=1&g?n:i,s=e-e/t*g;for(let e=0;e<I;e++){let g=e/I*(2*Math.PI),t=Math.sin(g)*s,n=Math.cos(g)*s;C.push(t,0,n),o.push(a.r,a.g,a.b),g=(e+1)/I*(2*Math.PI),t=Math.sin(g)*s,n=Math.cos(g)*s,C.push(t,0,n),o.push(a.r,a.g,a.b)}}const a=new Mi;a.setAttribute("position",new Si(C,3)),a.setAttribute("color",new Si(o,3)),super(a,new el({vertexColors:!0,toneMapped:!1})),this.type="PolarGridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}}const bd=new UI,md=new UI,pd=new UI;class Gd extends Dn{constructor(e,g,t){super(),this.light=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=t,this.type="DirectionalLightHelper",void 0===g&&(g=1);let I=new Mi;I.setAttribute("position",new Si([-g,g,0,g,g,0,g,-g,0,-g,-g,0,-g,g,0],3));const n=new el({fog:!1,toneMapped:!1});this.lightPlane=new Cl(I,n),this.add(this.lightPlane),I=new Mi,I.setAttribute("position",new Si([0,0,0,0,0,1],3)),this.targetLine=new Cl(I,n),this.add(this.targetLine),this.update()}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1),bd.setFromMatrixPosition(this.light.matrixWorld),md.setFromMatrixPosition(this.light.target.matrixWorld),pd.subVectors(md,bd),this.lightPlane.lookAt(md),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(md),this.targetLine.scale.z=pd.length()}}const Bd=new UI,Zd=new AC;class yd extends sl{constructor(e){const g=new Mi,t=new el({color:16777215,vertexColors:!0,toneMapped:!1}),I=[],n=[],i={};function C(e,g){o(e),o(g)}function o(e){I.push(0,0,0),n.push(0,0,0),void 0===i[e]&&(i[e]=[]),i[e].push(I.length/3-1)}C("n1","n2"),C("n2","n4"),C("n4","n3"),C("n3","n1"),C("f1","f2"),C("f2","f4"),C("f4","f3"),C("f3","f1"),C("n1","f1"),C("n2","f2"),C("n3","f3"),C("n4","f4"),C("p","n1"),C("p","n2"),C("p","n3"),C("p","n4"),C("u1","u2"),C("u2","u3"),C("u3","u1"),C("c","t"),C("p","c"),C("cn1","cn2"),C("cn3","cn4"),C("cf1","cf2"),C("cf3","cf4"),g.setAttribute("position",new Si(I,3)),g.setAttribute("color",new Si(n,3)),super(g,t),this.type="CameraHelper",this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=i,this.update();const a=new Ai(16755200),s=new Ai(16711680),l=new Ai(43775),r=new Ai(16777215),A=new Ai(3355443);this.setColors(a,s,l,r,A)}setColors(e,g,t,I,n){const i=this.geometry.getAttribute("color");i.setXYZ(0,e.r,e.g,e.b),i.setXYZ(1,e.r,e.g,e.b),i.setXYZ(2,e.r,e.g,e.b),i.setXYZ(3,e.r,e.g,e.b),i.setXYZ(4,e.r,e.g,e.b),i.setXYZ(5,e.r,e.g,e.b),i.setXYZ(6,e.r,e.g,e.b),i.setXYZ(7,e.r,e.g,e.b),i.setXYZ(8,e.r,e.g,e.b),i.setXYZ(9,e.r,e.g,e.b),i.setXYZ(10,e.r,e.g,e.b),i.setXYZ(11,e.r,e.g,e.b),i.setXYZ(12,e.r,e.g,e.b),i.setXYZ(13,e.r,e.g,e.b),i.setXYZ(14,e.r,e.g,e.b),i.setXYZ(15,e.r,e.g,e.b),i.setXYZ(16,e.r,e.g,e.b),i.setXYZ(17,e.r,e.g,e.b),i.setXYZ(18,e.r,e.g,e.b),i.setXYZ(19,e.r,e.g,e.b),i.setXYZ(20,e.r,e.g,e.b),i.setXYZ(21,e.r,e.g,e.b),i.setXYZ(22,e.r,e.g,e.b),i.setXYZ(23,e.r,e.g,e.b),i.setXYZ(24,g.r,g.g,g.b),i.setXYZ(25,g.r,g.g,g.b),i.setXYZ(26,g.r,g.g,g.b),i.setXYZ(27,g.r,g.g,g.b),i.setXYZ(28,g.r,g.g,g.b),i.setXYZ(29,g.r,g.g,g.b),i.setXYZ(30,g.r,g.g,g.b),i.setXYZ(31,g.r,g.g,g.b),i.setXYZ(32,t.r,t.g,t.b),i.setXYZ(33,t.r,t.g,t.b),i.setXYZ(34,t.r,t.g,t.b),i.setXYZ(35,t.r,t.g,t.b),i.setXYZ(36,t.r,t.g,t.b),i.setXYZ(37,t.r,t.g,t.b),i.setXYZ(38,I.r,I.g,I.b),i.setXYZ(39,I.r,I.g,I.b),i.setXYZ(40,n.r,n.g,n.b),i.setXYZ(41,n.r,n.g,n.b),i.setXYZ(42,n.r,n.g,n.b),i.setXYZ(43,n.r,n.g,n.b),i.setXYZ(44,n.r,n.g,n.b),i.setXYZ(45,n.r,n.g,n.b),i.setXYZ(46,n.r,n.g,n.b),i.setXYZ(47,n.r,n.g,n.b),i.setXYZ(48,n.r,n.g,n.b),i.setXYZ(49,n.r,n.g,n.b),i.needsUpdate=!0}update(){const e=this.geometry,g=this.pointMap;Zd.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),vd("c",g,e,Zd,0,0,-1),vd("t",g,e,Zd,0,0,1),vd("n1",g,e,Zd,-1,-1,-1),vd("n2",g,e,Zd,1,-1,-1),vd("n3",g,e,Zd,-1,1,-1),vd("n4",g,e,Zd,1,1,-1),vd("f1",g,e,Zd,-1,-1,1),vd("f2",g,e,Zd,1,-1,1),vd("f3",g,e,Zd,-1,1,1),vd("f4",g,e,Zd,1,1,1),vd("u1",g,e,Zd,.7,1.1,-1),vd("u2",g,e,Zd,-.7,1.1,-1),vd("u3",g,e,Zd,0,2,-1),vd("cf1",g,e,Zd,-1,0,1),vd("cf2",g,e,Zd,1,0,1),vd("cf3",g,e,Zd,0,-1,1),vd("cf4",g,e,Zd,0,1,1),vd("cn1",g,e,Zd,-1,0,-1),vd("cn2",g,e,Zd,1,0,-1),vd("cn3",g,e,Zd,0,-1,-1),vd("cn4",g,e,Zd,0,1,-1),e.getAttribute("position").needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}}function vd(e,g,t,I,n,i,C){Bd.set(n,i,C).unproject(I);const o=g[e];if(void 0!==o){const e=t.getAttribute("position");for(let g=0,t=o.length;g<t;g++)e.setXYZ(o[g],Bd.x,Bd.y,Bd.z)}}const Wd=new OI;class fd extends sl{constructor(e,g=16776960){const t=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),I=new Float32Array(24),n=new Mi;n.setIndex(new Zi(t,1)),n.setAttribute("position",new Zi(I,3)),super(n,new el({color:g,toneMapped:!1})),this.object=e,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(e){if(void 0!==e&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&Wd.setFromObject(this.object),Wd.isEmpty())return;const g=Wd.min,t=Wd.max,I=this.geometry.attributes.position,n=I.array;n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=g.x,n[4]=t.y,n[5]=t.z,n[6]=g.x,n[7]=g.y,n[8]=t.z,n[9]=t.x,n[10]=g.y,n[11]=t.z,n[12]=t.x,n[13]=t.y,n[14]=g.z,n[15]=g.x,n[16]=t.y,n[17]=g.z,n[18]=g.x,n[19]=g.y,n[20]=g.z,n[21]=t.x,n[22]=g.y,n[23]=g.z,I.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(e){return this.object=e,this.update(),this}copy(e,g){return super.copy(e,g),this.object=e.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class wd extends sl{constructor(e,g=16776960){const t=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),I=new Mi;I.setIndex(new Zi(t,1)),I.setAttribute("position",new Si([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),super(I,new el({color:g,toneMapped:!1})),this.box=e,this.type="Box3Helper",this.geometry.computeBoundingSphere()}updateMatrixWorld(e){const g=this.box;g.isEmpty()||(g.getCenter(this.position),g.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(e))}dispose(){this.geometry.dispose(),this.material.dispose()}}class Rd extends Cl{constructor(e,g=1,t=16776960){const I=t,n=new Mi;n.setAttribute("position",new Si([1,-1,0,-1,1,0,-1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,-1,0,1,1,0],3)),n.computeBoundingSphere(),super(n,new el({color:I,toneMapped:!1})),this.type="PlaneHelper",this.plane=e,this.size=g;const i=new Mi;i.setAttribute("position",new Si([1,1,0,-1,1,0,-1,-1,0,1,1,0,-1,-1,0,1,-1,0],3)),i.computeBoundingSphere(),this.add(new nC(i,new di({color:I,opacity:.2,transparent:!0,depthWrite:!1,toneMapped:!1})))}updateMatrixWorld(e){this.position.set(0,0,0),this.scale.set(.5*this.size,.5*this.size,1),this.lookAt(this.plane.normal),this.translateZ(-this.plane.constant),super.updateMatrixWorld(e)}dispose(){this.geometry.dispose(),this.material.dispose(),this.children[0].geometry.dispose(),this.children[0].material.dispose()}}const Vd=new UI;let Xd,Sd;class Yd extends Dn{constructor(e=new UI(0,0,1),g=new UI(0,0,0),t=1,I=16776960,n=.2*t,i=.2*n){super(),this.type="ArrowHelper",void 0===Xd&&(Xd=new Mi,Xd.setAttribute("position",new Si([0,0,0,0,1,0],3)),Sd=new jl(0,.5,1,5,1),Sd.translate(0,-.5,0)),this.position.copy(g),this.line=new Cl(Xd,new el({color:I,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new nC(Sd,new di({color:I,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(t,n,i)}setDirection(e){if(e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{Vd.set(e.z,0,-e.x).normalize();const g=Math.acos(e.y);this.quaternion.setFromAxisAngle(Vd,g)}}setLength(e,g=.2*e,t=.2*g){this.line.scale.set(1,Math.max(1e-4,e-g),1),this.line.updateMatrix(),this.cone.scale.set(t,g,t),this.cone.position.y=e,this.cone.updateMatrix()}setColor(e){this.line.material.color.set(e),this.cone.material.color.set(e)}copy(e){return super.copy(e,!1),this.line.copy(e.line),this.cone.copy(e.cone),this}dispose(){this.line.geometry.dispose(),this.line.material.dispose(),this.cone.geometry.dispose(),this.cone.material.dispose()}}class Kd extends sl{constructor(e=1){const g=[0,0,0,e,0,0,0,0,0,0,e,0,0,0,0,0,0,e],t=new Mi;t.setAttribute("position",new Si(g,3)),t.setAttribute("color",new Si([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3)),super(t,new el({vertexColors:!0,toneMapped:!1})),this.type="AxesHelper"}setColors(e,g,t){const I=new Ai,n=this.geometry.attributes.color.array;return I.set(e),I.toArray(n,0),I.toArray(n,3),I.set(g),I.toArray(n,6),I.toArray(n,9),I.set(t),I.toArray(n,12),I.toArray(n,15),this.geometry.attributes.color.needsUpdate=!0,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class Hd{constructor(){this.type="ShapePath",this.color=new Ai,this.subPaths=[],this.currentPath=null}moveTo(e,g){return this.currentPath=new Ul,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,g),this}lineTo(e,g){return this.currentPath.lineTo(e,g),this}quadraticCurveTo(e,g,t,I){return this.currentPath.quadraticCurveTo(e,g,t,I),this}bezierCurveTo(e,g,t,I,n,i){return this.currentPath.bezierCurveTo(e,g,t,I,n,i),this}splineThru(e){return this.currentPath.splineThru(e),this}toShapes(e){function g(e,g){const t=g.length;let I=!1;for(let n=t-1,i=0;i<t;n=i++){let t=g[n],C=g[i],o=C.x-t.x,a=C.y-t.y;if(Math.abs(a)>Number.EPSILON){if(a<0&&(t=g[i],o=-o,C=g[n],a=-a),e.y<t.y||e.y>C.y)continue;if(e.y===t.y){if(e.x===t.x)return!0}else{const g=a*(e.x-t.x)-o*(e.y-t.y);if(0===g)return!0;if(g<0)continue;I=!I}}else{if(e.y!==t.y)continue;if(C.x<=e.x&&e.x<=t.x||t.x<=e.x&&e.x<=C.x)return!0}}return I}const t=Vr.isClockWise,I=this.subPaths;if(0===I.length)return[];let n,i,C;const o=[];if(1===I.length)return i=I[0],C=new nr,C.curves=i.curves,o.push(C),o;let a=!t(I[0].getPoints());a=e?!a:a;const s=[],l=[];let r,A,c=[],d=0;l[d]=void 0,c[d]=[];for(let g=0,C=I.length;g<C;g++)i=I[g],r=i.getPoints(),n=t(r),n=e?!n:n,n?(!a&&l[d]&&d++,l[d]={s:new nr,p:r},l[d].s.curves=i.curves,a&&d++,c[d]=[]):c[d].push({h:i,p:r[0]});if(!l[0])return function(e){const g=[];for(let t=0,I=e.length;t<I;t++){const I=e[t],n=new nr;n.curves=I.curves,g.push(n)}return g}(I);if(l.length>1){let e=!1,t=0;for(let e=0,g=l.length;e<g;e++)s[e]=[];for(let I=0,n=l.length;I<n;I++){const n=c[I];for(let i=0;i<n.length;i++){const C=n[i];let o=!0;for(let n=0;n<l.length;n++)g(C.p,l[n].p)&&(I!==n&&t++,o?(o=!1,s[n].push(C)):e=!0);o&&s[I].push(C)}}t>0&&!1===e&&(c=s)}for(let e=0,g=l.length;e<g;e++){C=l[e].s,o.push(C),A=c[e];for(let e=0,g=A.length;e<g;e++)C.holes.push(A[e].h)}return o}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:p}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=p);var Nd=n(576);const Fd="undefined"==typeof window||!window.navigator||/ServerSideRendering|^Deno\//.test(window.navigator.userAgent)?g.useEffect:g.useLayoutEffect;function xd(e){const t="function"==typeof e?function(e){let g;const t=new Set,I=(e,I)=>{const n="function"==typeof e?e(g):e;if(n!==g){const e=g;g=I?n:Object.assign({},g,n),t.forEach((t=>t(g,e)))}},n=()=>g,i={setState:I,getState:n,subscribe:(e,I,i)=>I||i?((e,I=n,i=Object.is)=>{console.warn("[DEPRECATED] Please use `subscribeWithSelector` middleware");let C=I(g);function o(){const t=I(g);if(!i(C,t)){const g=C;e(C=t,g)}}return t.add(o),()=>t.delete(o)})(e,I,i):(t.add(e),()=>t.delete(e)),destroy:()=>t.clear()};return g=e(I,n,i),i}(e):e,I=(e=t.getState,I=Object.is)=>{const[,n]=(0,g.useReducer)((e=>e+1),0),i=t.getState(),C=(0,g.useRef)(i),o=(0,g.useRef)(e),a=(0,g.useRef)(I),s=(0,g.useRef)(!1),l=(0,g.useRef)();let r;void 0===l.current&&(l.current=e(i));let A=!1;(C.current!==i||o.current!==e||a.current!==I||s.current)&&(r=e(i),A=!I(l.current,r)),Fd((()=>{A&&(l.current=r),C.current=i,o.current=e,a.current=I,s.current=!1}));const c=(0,g.useRef)(i);Fd((()=>{const e=()=>{try{const e=t.getState(),g=o.current(e);a.current(l.current,g)||(C.current=e,l.current=g,n())}catch(e){s.current=!0,n()}},g=t.subscribe(e);return t.getState()!==c.current&&e(),g}),[]);const d=A?r:l.current;return(0,g.useDebugValue)(d),d};return Object.assign(I,t),I[Symbol.iterator]=function(){console.warn("[useStore, api] = create() is deprecated and will be removed in v4");const e=[I,t];return{next(){const g=e.length<=0;return{value:e.shift(),done:g}}}},I}var zd=n(525),kd=n.n(zd),Md=n(840);const Ld=[];function Jd(e,g,t=((e,g)=>e===g)){if(e===g)return!0;if(!e||!g)return!1;const I=e.length;if(g.length!==I)return!1;for(let n=0;n<I;n++)if(!t(e[n],g[n]))return!1;return!0}function Ed(e,g=null,t=!1,I={}){null===g&&(g=[e]);for(const e of Ld)if(Jd(g,e.keys,e.equal)){if(t)return;if(Object.prototype.hasOwnProperty.call(e,"error"))throw e.error;if(Object.prototype.hasOwnProperty.call(e,"response"))return I.lifespan&&I.lifespan>0&&(e.timeout&&clearTimeout(e.timeout),e.timeout=setTimeout(e.remove,I.lifespan)),e.response;if(!t)throw e.promise}const n={keys:g,equal:I.equal,remove:()=>{const e=Ld.indexOf(n);-1!==e&&Ld.splice(e,1)},promise:(i=e,"object"==typeof i&&"function"==typeof i.then?e:e(...g)).then((e=>{n.response=e,I.lifespan&&I.lifespan>0&&(n.timeout=setTimeout(n.remove,I.lifespan))})).catch((e=>n.error=e))};var i;if(Ld.push(n),!t)throw n.promise}const Td=(e,g,t)=>Ed(e,g,!1,t),Ud={},Qd=e=>{Object.assign(Ud,e)};var Dd,Od;const jd=e=>"colorSpace"in e||"outputColorSpace"in e,Pd=()=>{var e;return null!=(e=Ud.ColorManagement)?e:null},_d=e=>e&&e.isOrthographicCamera,qd="undefined"!=typeof window&&(null!=(Dd=window.document)&&Dd.createElement||"ReactNative"===(null==(Od=window.navigator)?void 0:Od.product))?g.useLayoutEffect:g.useEffect;function $d(e){const t=g.useRef(e);return qd((()=>{t.current=e}),[e]),t}function eu({set:e}){return qd((()=>(e(new Promise((()=>null))),()=>e(!1))),[e]),null}class gu extends g.Component{constructor(...e){super(...e),this.state={error:!1}}componentDidCatch(e){this.props.set(e)}render(){return this.state.error?null:this.props.children}}gu.getDerivedStateFromError=()=>({error:!0});const tu="__default",Iu=new Map;function nu(e){var g;const t="undefined"!=typeof window?null!=(g=window.devicePixelRatio)?g:2:1;return Array.isArray(e)?Math.min(Math.max(e[0],t),e[1]):e}const iu=e=>{var g;return null==(g=e.__r3f)?void 0:g.root.getState()},Cu={obj:e=>e===Object(e)&&!Cu.arr(e)&&"function"!=typeof e,fun:e=>"function"==typeof e,str:e=>"string"==typeof e,num:e=>"number"==typeof e,boo:e=>"boolean"==typeof e,und:e=>void 0===e,arr:e=>Array.isArray(e),equ(e,g,{arrays:t="shallow",objects:I="reference",strict:n=!0}={}){if(typeof e!=typeof g||!!e!=!!g)return!1;if(Cu.str(e)||Cu.num(e))return e===g;const i=Cu.obj(e);if(i&&"reference"===I)return e===g;const C=Cu.arr(e);if(C&&"reference"===t)return e===g;if((C||i)&&e===g)return!0;let o;for(o in e)if(!(o in g))return!1;if(i&&"shallow"===t&&"shallow"===I){for(o in n?g:e)if(!Cu.equ(e[o],g[o],{strict:n,objects:"reference"}))return!1}else for(o in n?g:e)if(e[o]!==g[o])return!1;if(Cu.und(o)){if(C&&0===e.length&&0===g.length)return!0;if(i&&0===Object.keys(e).length&&0===Object.keys(g).length)return!0;if(e!==g)return!1}return!0}};function ou(e,g){return e.__r3f={type:"",root:null,previousAttach:null,memoizedProps:{},eventCount:0,handlers:{},objects:[],parent:null,...g},e}function au(e,g){let t=e;if(g.includes("-")){const I=g.split("-"),n=I.pop();return t=I.reduce(((e,g)=>e[g]),e),{target:t,key:n}}return{target:t,key:g}}const su=/-\d+$/;function lu(e,g,t){if(Cu.str(t)){if(su.test(t)){const g=t.replace(su,""),{target:I,key:n}=au(e,g);Array.isArray(I[n])||(I[n]=[])}const{target:I,key:n}=au(e,t);g.__r3f.previousAttach=I[n],I[n]=g}else g.__r3f.previousAttach=t(e,g)}function ru(e,g,t){var I,n;if(Cu.str(t)){const{target:I,key:n}=au(e,t),i=g.__r3f.previousAttach;void 0===i?delete I[n]:I[n]=i}else null==(I=g.__r3f)||null==I.previousAttach||I.previousAttach(e,g);null==(n=g.__r3f)||delete n.previousAttach}function Au(e,{children:g,key:t,ref:I,...n},{children:i,key:C,ref:o,...a}={},s=!1){var l;const r=null!=(l=null==e?void 0:e.__r3f)?l:{},A=Object.entries(n),c=[];if(s){const e=Object.keys(a);for(let g=0;g<e.length;g++)n.hasOwnProperty(e[g])||A.unshift([e[g],tu+"remove"])}A.forEach((([g,t])=>{var I;if(null!=(I=e.__r3f)&&I.primitive&&"object"===g)return;if(Cu.equ(t,a[g]))return;if(/^on(Pointer|Click|DoubleClick|ContextMenu|Wheel)/.test(g))return c.push([g,t,!0,[]]);let i=[];g.includes("-")&&(i=g.split("-")),c.push([g,t,!1,i]);for(const e in n){const t=n[e];e.startsWith(`${g}-`)&&c.push([e,t,!1,e.split("-")])}}));const d={...n};return r.memoizedProps&&r.memoizedProps.args&&(d.args=r.memoizedProps.args),r.memoizedProps&&r.memoizedProps.attach&&(d.attach=r.memoizedProps.attach),{memoized:d,changes:c}}const cu="undefined"!=typeof process&&!1;function du(e,g){var t,I,n;const i=null!=(t=e.__r3f)?t:{},C=i.root,o=null!=(I=null==C||null==C.getState?void 0:C.getState())?I:{},{memoized:a,changes:s}=(r=g)&&r.memoized&&r.changes?g:Au(e,g),l=i.eventCount;var r;e.__r3f&&(e.__r3f.memoizedProps=a);for(let g=0;g<s.length;g++){let[t,I,n,C]=s[g];if(jd(e)){const e=3001,g="srgb",n="srgb-linear";"encoding"===t?(t="colorSpace",I=I===e?g:n):"outputEncoding"===t&&(t="outputColorSpace",I=I===e?g:n)}let a=e,l=a[t];if(C.length&&(l=C.reduce(((e,g)=>e[g]),e),!l||!l.set)){const[g,...I]=C.reverse();a=I.reverse().reduce(((e,g)=>e[g]),e),t=g}if(I===tu+"remove")if(a.constructor){let e=Iu.get(a.constructor);e||(e=new a.constructor,Iu.set(a.constructor,e)),I=e[t]}else I=0;if(n)I?i.handlers[t]=I:delete i.handlers[t],i.eventCount=Object.keys(i.handlers).length;else if(l&&l.set&&(l.copy||l instanceof Kn)){if(Array.isArray(I))l.fromArray?l.fromArray(I):l.set(...I);else if(l.copy&&I&&I.constructor&&(cu?l.constructor.name===I.constructor.name:l.constructor===I.constructor))l.copy(I);else if(void 0!==I){const e=l instanceof Ai;!e&&l.setScalar?l.setScalar(I):l instanceof Kn&&I instanceof Kn?l.mask=I.mask:l.set(I),Pd()||o.linear||!e||l.convertSRGBToLinear()}}else if(a[t]=I,a[t]instanceof NI&&a[t].format===Pe&&a[t].type===ze){const e=a[t];jd(e)&&jd(o.gl)?e.colorSpace=o.gl.outputColorSpace:e.encoding=o.gl.outputEncoding}uu(e)}if(i.parent&&o.internal&&e.raycast&&l!==i.eventCount){const g=o.internal.interaction.indexOf(e);g>-1&&o.internal.interaction.splice(g,1),i.eventCount&&o.internal.interaction.push(e)}return!(1===s.length&&"onUpdate"===s[0][0])&&s.length&&null!=(n=e.__r3f)&&n.parent&&hu(e),e}function uu(e){var g,t;const I=null==(g=e.__r3f)||null==(t=g.root)||null==t.getState?void 0:t.getState();I&&0===I.internal.frames&&I.invalidate()}function hu(e){null==e.onUpdate||e.onUpdate(e)}function bu(e,g){e.manual||(_d(e)?(e.left=g.width/-2,e.right=g.width/2,e.top=g.height/2,e.bottom=g.height/-2):e.aspect=g.width/g.height,e.updateProjectionMatrix(),e.updateMatrixWorld())}function mu(e){return(e.eventObject||e.object).uuid+"/"+e.index+e.instanceId}function pu(e,g,t,I){const n=t.get(g);n&&(t.delete(g),0===t.size&&(e.delete(I),n.target.releasePointerCapture(I)))}const Gu=["set","get","setSize","setFrameloop","setDpr","events","invalidate","advance","size","viewport"],Bu=e=>!(null==e||!e.render),Zu=g.createContext(null);function yu(e,g){const t={callback:e};return g.add(t),()=>{g.delete(t)}}let vu,Wu=new Set,fu=new Set,wu=new Set;const Ru=e=>yu(e,Wu),Vu=e=>yu(e,fu);function Xu(e,g){if(e.size)for(const{callback:t}of e.values())t(g)}function Su(e,g){switch(e){case"before":return Xu(Wu,g);case"after":return Xu(fu,g);case"tail":return Xu(wu,g)}}let Yu,Ku;function Hu(e,g,t){let I=g.clock.getDelta();for("never"===g.frameloop&&"number"==typeof e&&(I=e-g.clock.elapsedTime,g.clock.oldTime=g.clock.elapsedTime,g.clock.elapsedTime=e),Yu=g.internal.subscribers,vu=0;vu<Yu.length;vu++)Ku=Yu[vu],Ku.ref.current(Ku.store.getState(),I,t);return!g.internal.priority&&g.gl.render&&g.gl.render(g.scene,g.camera),g.internal.frames=Math.max(0,g.internal.frames-1),"always"===g.frameloop?1:g.internal.frames}function Nu(){const e=g.useContext(Zu);if(!e)throw new Error("R3F: Hooks can only be used within the Canvas component!");return e}function Fu(e=(e=>e),g){return Nu()(e,g)}function xu(e,g=0){const t=Nu(),I=t.getState().internal.subscribe,n=$d(e);return qd((()=>I(n,g,t)),[g,I,t]),null}const zu=new WeakMap;function ku(e,g){return function(t,...I){let n=zu.get(t);return n||(n=new t,zu.set(t,n)),e&&e(n),Promise.all(I.map((e=>new Promise(((t,I)=>n.load(e,(e=>{e.scene&&Object.assign(e,function(e){const g={nodes:{},materials:{}};return e&&e.traverse((e=>{e.name&&(g.nodes[e.name]=e),e.material&&!g.materials[e.material.name]&&(g.materials[e.material.name]=e.material)})),g}(e.scene)),t(e)}),g,(g=>I(new Error(`Could not load ${e}: ${null==g?void 0:g.message}`))))))))).finally((()=>null==n.dispose?void 0:n.dispose()))}}function Mu(e,g,t,I){const n=Array.isArray(g)?g:[g],i=Td(ku(t,I),[e,...n],{equal:Cu.equ});return Array.isArray(g)?i:i[0]}Mu.preload=function(e,g,t){const I=Array.isArray(g)?g:[g];return((e,g,t)=>{Ed(e,g,!0,void 0)})(ku(t),[e,...I])},Mu.clear=function(e,g){return(e=>{if(void 0===e||0===e.length)Ld.splice(0,Ld.length);else{const g=Ld.find((g=>Jd(e,g.keys,g.equal)));g&&g.remove()}})([e,...Array.isArray(g)?g:[g]])};const Lu=new Map,{invalidate:Ju,advance:Eu}=function(e){let g,t,I,n=!1;function i(C){t=requestAnimationFrame(i),n=!0,g=0,Su("before",C);for(const t of e.values()){var o;I=t.store.getState(),!I.internal.active||!("always"===I.frameloop||I.internal.frames>0)||null!=(o=I.gl.xr)&&o.isPresenting||(g+=Hu(C,I))}if(Su("after",C),0===g)return Su("tail",C),n=!1,cancelAnimationFrame(t)}return{loop:i,invalidate:function g(t,I=1){var C;if(!t)return e.forEach((e=>g(e.store.getState())),I);null!=(C=t.gl.xr)&&C.isPresenting||!t.internal.active||"never"===t.frameloop||(t.internal.frames=Math.min(60,t.internal.frames+I),n||(n=!0,requestAnimationFrame(i)))},advance:function(g,t=!0,I,n){if(t&&Su("before",g),I)Hu(g,I,n);else for(const t of e.values())Hu(g,t.store.getState());t&&Su("after",g)}}}(Lu),{reconciler:Tu,applyProps:Uu}=function(e,g){function t(e,{args:g=[],attach:t,...I},n){let i,C=`${e[0].toUpperCase()}${e.slice(1)}`;if("primitive"===e){if(void 0===I.object)throw new Error("R3F: Primitives without 'object' are invalid!");i=ou(I.object,{type:e,root:n,attach:t,primitive:!0})}else{const I=Ud[C];if(!I)throw new Error(`R3F: ${C} is not part of the THREE namespace! Did you forget to extend? See: https://docs.pmnd.rs/react-three-fiber/api/objects#using-3rd-party-objects-declaratively`);if(!Array.isArray(g))throw new Error("R3F: The args prop must be an array!");i=ou(new I(...g),{type:e,root:n,attach:t,memoizedProps:{args:g}})}return void 0===i.__r3f.attach&&(i instanceof Mi?i.__r3f.attach="geometry":i instanceof oi&&(i.__r3f.attach="material")),"inject"!==C&&du(i,I),i}function I(e,g){let t=!1;var I,n;g&&(null!=(I=g.__r3f)&&I.attach?lu(e,g,g.__r3f.attach):g.isObject3D&&e.isObject3D&&(e.add(g),t=!0),t||null==(n=e.__r3f)||n.objects.push(g),g.__r3f||ou(g,{}),g.__r3f.parent=e,hu(g),uu(g))}function n(e,g,t){let I=!1;if(g){var n,i;if(null!=(n=g.__r3f)&&n.attach)lu(e,g,g.__r3f.attach);else if(g.isObject3D&&e.isObject3D){g.parent=e,g.dispatchEvent({type:"added"});const n=e.children.filter((e=>e!==g)),i=n.indexOf(t);e.children=[...n.slice(0,i),g,...n.slice(i)],I=!0}I||null==(i=e.__r3f)||i.objects.push(g),g.__r3f||ou(g,{}),g.__r3f.parent=e,hu(g),uu(g)}}function i(e,g,t=!1){e&&[...e].forEach((e=>C(g,e,t)))}function C(e,g,t){if(g){var I,n,C;if(g.__r3f&&(g.__r3f.parent=null),null!=(I=e.__r3f)&&I.objects&&(e.__r3f.objects=e.__r3f.objects.filter((e=>e!==g))),null!=(n=g.__r3f)&&n.attach)ru(e,g,g.__r3f.attach);else if(g.isObject3D&&e.isObject3D){var o;e.remove(g),null!=(o=g.__r3f)&&o.root&&function(e,g){const{internal:t}=e.getState();t.interaction=t.interaction.filter((e=>e!==g)),t.initialHits=t.initialHits.filter((e=>e!==g)),t.hovered.forEach(((e,I)=>{e.eventObject!==g&&e.object!==g||t.hovered.delete(I)})),t.capturedMap.forEach(((e,I)=>{pu(t.capturedMap,g,e,I)}))}(g.__r3f.root,g)}const s=null==(C=g.__r3f)?void 0:C.primitive,l=void 0===t?null!==g.dispose&&!s:t;var a;s||(i(null==(a=g.__r3f)?void 0:a.objects,g,l),i(g.children,g,l)),delete g.__r3f,l&&g.dispose&&"Scene"!==g.type&&(0,Md.unstable_scheduleCallback)(Md.unstable_IdlePriority,(()=>{try{g.dispose()}catch(e){}})),uu(e)}}const o=()=>console.warn("Text is not allowed in the R3F tree! This could be stray whitespace or characters."),a=kd()({createInstance:t,removeChild:C,appendChild:I,appendInitialChild:I,insertBefore:n,supportsMutation:!0,isPrimaryRenderer:!1,supportsPersistence:!1,supportsHydration:!1,noTimeout:-1,appendChildToContainer:(e,g)=>{if(!g)return;const t=e.getState().scene;t.__r3f&&(t.__r3f.root=e,I(t,g))},removeChildFromContainer:(e,g)=>{g&&C(e.getState().scene,g)},insertInContainerBefore:(e,g,t)=>{if(!g||!t)return;const I=e.getState().scene;I.__r3f&&n(I,g,t)},getRootHostContext:()=>null,getChildHostContext:e=>e,finalizeInitialChildren(e){var g;const t=null!=(g=null==e?void 0:e.__r3f)?g:{};return Boolean(t.handlers)},prepareUpdate(e,g,t,I){var n;if((null!=(n=null==e?void 0:e.__r3f)?n:{}).primitive&&I.object&&I.object!==e)return[!0];{const{args:g=[],children:n,...i}=I,{args:C=[],children:o,...a}=t;if(!Array.isArray(g))throw new Error("R3F: the args prop must be an array!");if(g.some(((e,g)=>e!==C[g])))return[!0];const s=Au(e,i,a,!0);return s.changes.length?[!1,s]:null}},commitUpdate(e,[g,n],i,o,a,s){g?function(e,g,n,i){var o;const a=null==(o=e.__r3f)?void 0:o.parent;if(!a)return;const s=t(g,n,e.__r3f.root);if(e.children){for(const g of e.children)g.__r3f&&I(s,g);e.children=e.children.filter((e=>!e.__r3f))}e.__r3f.objects.forEach((e=>I(s,e))),e.__r3f.objects=[],e.__r3f.autoRemovedBeforeAppend||C(a,e),s.parent&&(s.__r3f.autoRemovedBeforeAppend=!0),I(a,s),s.raycast&&s.__r3f.eventCount&&s.__r3f.root.getState().internal.interaction.push(s),[i,i.alternate].forEach((e=>{null!==e&&(e.stateNode=s,e.ref&&("function"==typeof e.ref?e.ref(s):e.ref.current=s))}))}(e,i,a,s):du(e,n)},commitMount(e,g,t,I){var n;const i=null!=(n=e.__r3f)?n:{};e.raycast&&i.handlers&&i.eventCount&&e.__r3f.root.getState().internal.interaction.push(e)},getPublicInstance:e=>e,prepareForCommit:()=>null,preparePortalMount:e=>ou(e.getState().scene),resetAfterCommit:()=>{},shouldSetTextContent:()=>!1,clearContainer:()=>!1,hideInstance(e){var g;const{attach:t,parent:I}=null!=(g=e.__r3f)?g:{};t&&I&&ru(I,e,t),e.isObject3D&&(e.visible=!1),uu(e)},unhideInstance(e,g){var t;const{attach:I,parent:n}=null!=(t=e.__r3f)?t:{};I&&n&&lu(n,e,I),(e.isObject3D&&null==g.visible||g.visible)&&(e.visible=!0),uu(e)},createTextInstance:o,hideTextInstance:o,unhideTextInstance:o,getCurrentEventPriority:()=>g?g():Nd.DefaultEventPriority,beforeActiveInstanceBlur:()=>{},afterActiveInstanceBlur:()=>{},detachDeletedInstance:()=>{},now:"undefined"!=typeof performance&&Cu.fun(performance.now)?performance.now:Cu.fun(Date.now)?Date.now:()=>0,scheduleTimeout:Cu.fun(setTimeout)?setTimeout:void 0,cancelTimeout:Cu.fun(clearTimeout)?clearTimeout:void 0});return{reconciler:a,applyProps:du}}(0,(function(){var e;const g="undefined"!=typeof self&&self||"undefined"!=typeof window&&window;if(!g)return Nd.DefaultEventPriority;switch(null==(e=g.event)?void 0:e.type){case"click":case"contextmenu":case"dblclick":case"pointercancel":case"pointerdown":case"pointerup":return Nd.DiscreteEventPriority;case"pointermove":case"pointerout":case"pointerover":case"pointerenter":case"pointerleave":case"wheel":return Nd.ContinuousEventPriority;default:return Nd.DefaultEventPriority}})),Qu={objects:"shallow",strict:!1},Du=(e,g)=>{const t="function"==typeof e?e(g):e;return Bu(t)?t:new Is({powerPreference:"high-performance",canvas:g,antialias:!0,alpha:!0,...e})};function Ou(e){const t=Lu.get(e),I=null==t?void 0:t.fiber,n=null==t?void 0:t.store;t&&console.warn("R3F.createRoot should only be called once!");const i="function"==typeof reportError?reportError:console.error,C=n||((e,t)=>{const I=xd(((I,n)=>{const i=new UI,C=new UI,o=new UI;function a(e=n().camera,g=C,t=n().size){const{width:I,height:a,top:s,left:l}=t,r=I/a;g instanceof UI?o.copy(g):o.set(...g);const A=e.getWorldPosition(i).distanceTo(o);if(_d(e))return{width:I/e.zoom,height:a/e.zoom,top:s,left:l,factor:1,distance:A,aspect:r};{const g=e.fov*Math.PI/180,t=2*Math.tan(g/2)*A,n=t*(I/a);return{width:n,height:t,top:s,left:l,factor:I/n,distance:A,aspect:r}}}let s;const l=e=>I((g=>({performance:{...g.performance,current:e}}))),r=new AI,A={set:I,get:n,gl:null,camera:null,raycaster:null,events:{priority:1,enabled:!0,connected:!1},xr:null,scene:null,invalidate:(g=1)=>e(n(),g),advance:(e,g)=>t(e,g,n()),legacy:!1,linear:!1,flat:!1,controls:null,clock:new hc,pointer:r,mouse:r,frameloop:"always",onPointerMissed:void 0,performance:{current:1,min:.5,max:1,debounce:200,regress:()=>{const e=n();s&&clearTimeout(s),e.performance.current!==e.performance.min&&l(e.performance.min),s=setTimeout((()=>l(n().performance.max)),e.performance.debounce)}},size:{width:0,height:0,top:0,left:0,updateStyle:!1},viewport:{initialDpr:0,dpr:0,width:0,height:0,top:0,left:0,aspect:0,distance:0,factor:0,getCurrentViewport:a},setEvents:e=>I((g=>({...g,events:{...g.events,...e}}))),setSize:(e,g,t,i,o)=>{const s=n().camera,l={width:e,height:g,top:i||0,left:o||0,updateStyle:t};I((e=>({size:l,viewport:{...e.viewport,...a(s,C,l)}})))},setDpr:e=>I((g=>{const t=nu(e);return{viewport:{...g.viewport,dpr:t,initialDpr:g.viewport.initialDpr||t}}})),setFrameloop:(e="always")=>{const g=n().clock;g.stop(),g.elapsedTime=0,"never"!==e&&(g.start(),g.elapsedTime=0),I((()=>({frameloop:e})))},previousRoot:void 0,internal:{active:!1,priority:0,frames:0,lastEvent:g.createRef(),interaction:[],hovered:new Map,subscribers:[],initialClick:[0,0],initialHits:[],capturedMap:new Map,subscribe:(e,g,t)=>{const I=n().internal;return I.priority=I.priority+(g>0?1:0),I.subscribers.push({ref:e,priority:g,store:t}),I.subscribers=I.subscribers.sort(((e,g)=>e.priority-g.priority)),()=>{const t=n().internal;null!=t&&t.subscribers&&(t.priority=t.priority-(g>0?1:0),t.subscribers=t.subscribers.filter((g=>g.ref!==e)))}}}};return A})),n=I.getState();let i=n.size,C=n.viewport.dpr,o=n.camera;return I.subscribe((()=>{const{camera:e,size:g,viewport:t,gl:n,set:a}=I.getState();if(g!==i||t.dpr!==C){var s;i=g,C=t.dpr,bu(e,g),n.setPixelRatio(t.dpr);const I=null!=(s=g.updateStyle)?s:"undefined"!=typeof HTMLCanvasElement&&n.domElement instanceof HTMLCanvasElement;n.setSize(g.width,g.height,I)}e!==o&&(o=e,a((g=>({viewport:{...g.viewport,...g.viewport.getCurrentViewport(e)}}))))})),I.subscribe((g=>e(g))),I})(Ju,Eu),o=I||Tu.createContainer(C,Nd.ConcurrentRoot,null,!1,null,"",i,null);let a;t||Lu.set(e,{fiber:o,store:C});let s,l=!1;return{configure(g={}){let{gl:t,size:I,scene:n,events:i,onCreated:o,shadows:r=!1,linear:A=!1,flat:c=!1,legacy:d=!1,orthographic:u=!1,frameloop:h="always",dpr:b=[1,2],performance:m,raycaster:p,camera:G,onPointerMissed:B}=g,Z=C.getState(),y=Z.gl;Z.gl||Z.set({gl:y=Du(t,e)});let v=Z.raycaster;v||Z.set({raycaster:v=new Dc});const{params:W,...X}=p||{};if(Cu.equ(X,v,Qu)||Uu(v,{...X}),Cu.equ(W,v.params,Qu)||Uu(v,{params:{...v.params,...W}}),!Z.camera||Z.camera===s&&!Cu.equ(s,G,Qu)){s=G;const e=G instanceof AC,g=e?G:u?new zC(0,0,0,0,.1,1e3):new cC(75,0,.1,1e3);e||(g.position.z=5,G&&Uu(g,G),Z.camera||null!=G&&G.rotation||g.lookAt(0,0,0)),Z.set({camera:g})}if(!Z.scene){let e;n instanceof os?e=n:(e=new os,n&&Uu(e,n)),Z.set({scene:ou(e)})}if(!Z.xr){var S;const e=(e,g)=>{const t=C.getState();"never"!==t.frameloop&&Eu(e,!0,t,g)},g=()=>{const g=C.getState();g.gl.xr.enabled=g.gl.xr.isPresenting,g.gl.xr.setAnimationLoop(g.gl.xr.isPresenting?e:null),g.gl.xr.isPresenting||Ju(g)},t={connect(){const e=C.getState().gl;e.xr.addEventListener("sessionstart",g),e.xr.addEventListener("sessionend",g)},disconnect(){const e=C.getState().gl;e.xr.removeEventListener("sessionstart",g),e.xr.removeEventListener("sessionend",g)}};"function"==typeof(null==(S=y.xr)?void 0:S.addEventListener)&&t.connect(),Z.set({xr:t})}if(y.shadowMap){const e=y.shadowMap.enabled,g=y.shadowMap.type;if(y.shadowMap.enabled=!!r,Cu.boo(r))y.shadowMap.type=R;else if(Cu.str(r)){var Y;const e={basic:f,percentage:w,soft:R,variance:V};y.shadowMap.type=null!=(Y=e[r])?Y:R}else Cu.obj(r)&&Object.assign(y.shadowMap,r);e===y.shadowMap.enabled&&g===y.shadowMap.type||(y.shadowMap.needsUpdate=!0)}const K=Pd();K&&("enabled"in K?K.enabled=!d:"legacyMode"in K&&(K.legacyMode=d)),Uu(y,{outputEncoding:A?3e3:3001,toneMapping:c?ce:be}),Z.legacy!==d&&Z.set((()=>({legacy:d}))),Z.linear!==A&&Z.set((()=>({linear:A}))),Z.flat!==c&&Z.set((()=>({flat:c}))),!t||Cu.fun(t)||Bu(t)||Cu.equ(t,y,Qu)||Uu(y,t),i&&!Z.events.handlers&&Z.set({events:i(C)});const H=function(e,g){if(g)return g;if("undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement&&e.parentElement){const{width:g,height:t,top:I,left:n}=e.parentElement.getBoundingClientRect();return{width:g,height:t,top:I,left:n}}return"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas?{width:e.width,height:e.height,top:0,left:0}:{width:0,height:0,top:0,left:0}}(e,I);return Cu.equ(H,Z.size,Qu)||Z.setSize(H.width,H.height,H.updateStyle,H.top,H.left),b&&Z.viewport.dpr!==nu(b)&&Z.setDpr(b),Z.frameloop!==h&&Z.setFrameloop(h),Z.onPointerMissed||Z.set({onPointerMissed:B}),m&&!Cu.equ(m,Z.performance,Qu)&&Z.set((e=>({performance:{...e.performance,...m}}))),a=o,l=!0,this},render(t){return l||this.configure(),Tu.updateContainer(g.createElement(ju,{store:C,children:t,onCreated:a,rootElement:e}),o,null,(()=>{})),C},unmount(){Pu(e)}}}function ju({store:e,children:t,onCreated:I,rootElement:n}){return qd((()=>{const g=e.getState();g.set((e=>({internal:{...e.internal,active:!0}}))),I&&I(g),e.getState().events.connected||null==g.events.connect||g.events.connect(n)}),[]),g.createElement(Zu.Provider,{value:e},t)}function Pu(e,g){const t=Lu.get(e),I=null==t?void 0:t.fiber;if(I){const n=null==t?void 0:t.store.getState();n&&(n.internal.active=!1),Tu.updateContainer(null,I,null,(()=>{n&&setTimeout((()=>{try{var t,I,i,C;null==n.events.disconnect||n.events.disconnect(),null==(t=n.gl)||null==(I=t.renderLists)||null==I.dispose||I.dispose(),null==(i=n.gl)||null==i.forceContextLoss||i.forceContextLoss(),null!=(C=n.gl)&&C.xr&&n.xr.disconnect(),function(e){e.dispose&&"Scene"!==e.type&&e.dispose();for(const g in e)null==g.dispose||g.dispose(),delete e[g]}(n),Lu.delete(e),g&&g(e)}catch(e){}}),500)}))}}function _u({state:e={},children:t,container:I}){const{events:n,size:i,...C}=e,o=Nu(),[a]=g.useState((()=>new Dc)),[s]=g.useState((()=>new AI)),l=g.useCallback(((e,g)=>{const t={...e};let l;if(Object.keys(e).forEach((I=>{(Gu.includes(I)||e[I]!==g[I]&&g[I])&&delete t[I]})),g&&i){const t=g.camera;l=e.viewport.getCurrentViewport(t,new UI,i),t!==e.camera&&bu(t,i)}return{...t,scene:I,raycaster:a,pointer:s,mouse:s,previousRoot:o,events:{...e.events,...null==g?void 0:g.events,...n},size:{...e.size,...i},viewport:{...e.viewport,...l},...C}}),[e]),[r]=g.useState((()=>{const e=o.getState(),g=xd(((g,t)=>({...e,scene:I,raycaster:a,pointer:s,mouse:s,previousRoot:o,events:{...e.events,...n},size:{...e.size,...i},...C,set:g,get:t,setEvents:e=>g((g=>({...g,events:{...g.events,...e}})))})));return g}));return g.useEffect((()=>{const e=o.subscribe((e=>r.setState((g=>l(e,g)))));return()=>{e(),r.destroy()}}),[]),g.useEffect((()=>{r.setState((e=>l(o.getState(),e)))}),[l]),g.createElement(g.Fragment,null,Tu.createPortal(g.createElement(Zu.Provider,{value:r},t),r,null))}function qu(){return qu=Object.assign?Object.assign.bind():function(e){for(var g=1;g<arguments.length;g++){var t=arguments[g];for(var I in t)Object.prototype.hasOwnProperty.call(t,I)&&(e[I]=t[I])}return e},qu.apply(this,arguments)}Tu.injectIntoDevTools({bundleType:0,rendererPackageName:"@react-three/fiber",version:g.version}),g.unstable_act;var $u=n(296),eh=n.n($u);function gh(e){let{debounce:t,scroll:I,polyfill:n,offsetSize:i}=void 0===e?{debounce:0,scroll:!1,offsetSize:!1}:e;const C=n||("undefined"==typeof window?class{}:window.ResizeObserver);if(!C)throw new Error("This browser does not support ResizeObserver out of the box. See: https://github.com/react-spring/react-use-measure/#resize-observer-polyfills");const[o,a]=(0,g.useState)({left:0,top:0,width:0,height:0,bottom:0,right:0,x:0,y:0}),s=(0,g.useRef)({element:null,scrollContainers:null,resizeObserver:null,lastBounds:o}),l=t?"number"==typeof t?t:t.scroll:null,r=t?"number"==typeof t?t:t.resize:null,A=(0,g.useRef)(!1);(0,g.useEffect)((()=>(A.current=!0,()=>{A.current=!1})));const[c,d,u]=(0,g.useMemo)((()=>{const e=()=>{if(!s.current.element)return;const{left:e,top:g,width:t,height:I,bottom:n,right:C,x:o,y:l}=s.current.element.getBoundingClientRect(),r={left:e,top:g,width:t,height:I,bottom:n,right:C,x:o,y:l};s.current.element instanceof HTMLElement&&i&&(r.height=s.current.element.offsetHeight,r.width=s.current.element.offsetWidth),Object.freeze(r),A.current&&!nh(s.current.lastBounds,r)&&a(s.current.lastBounds=r)};return[e,r?eh()(e,r):e,l?eh()(e,l):e]}),[a,i,l,r]);function h(){s.current.scrollContainers&&(s.current.scrollContainers.forEach((e=>e.removeEventListener("scroll",u,!0))),s.current.scrollContainers=null),s.current.resizeObserver&&(s.current.resizeObserver.disconnect(),s.current.resizeObserver=null)}function b(){s.current.element&&(s.current.resizeObserver=new C(u),s.current.resizeObserver.observe(s.current.element),I&&s.current.scrollContainers&&s.current.scrollContainers.forEach((e=>e.addEventListener("scroll",u,{capture:!0,passive:!0}))))}var m,p,G;return m=u,p=Boolean(I),(0,g.useEffect)((()=>{if(p){const e=m;return window.addEventListener("scroll",e,{capture:!0,passive:!0}),()=>{window.removeEventListener("scroll",e,!0)}}}),[m,p]),G=d,(0,g.useEffect)((()=>{const e=G;return window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}),[G]),(0,g.useEffect)((()=>{h(),b()}),[I,u,d]),(0,g.useEffect)((()=>h),[]),[e=>{e&&e!==s.current.element&&(h(),s.current.element=e,s.current.scrollContainers=th(e),b())},o,c]}function th(e){const g=[];if(!e||e===document.body)return g;const{overflow:t,overflowX:I,overflowY:n}=window.getComputedStyle(e);return[t,I,n].some((e=>"auto"===e||"scroll"===e))&&g.push(e),[...g,...th(e.parentElement)]}const Ih=["x","y","top","bottom","left","right","width","height"],nh=(e,g)=>Ih.every((t=>e[t]===g[t]));var ih=Object.defineProperty,Ch=Object.defineProperties,oh=Object.getOwnPropertyDescriptors,ah=Object.getOwnPropertySymbols,sh=Object.prototype.hasOwnProperty,lh=Object.prototype.propertyIsEnumerable,rh=(e,g,t)=>g in e?ih(e,g,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[g]=t,Ah=(e,g)=>{for(var t in g||(g={}))sh.call(g,t)&&rh(e,t,g[t]);if(ah)for(var t of ah(g))lh.call(g,t)&&rh(e,t,g[t]);return e};function ch(e,g,t){if(!e)return;if(!0===t(e))return e;let I=g?e.return:e.child;for(;I;){const e=ch(I,g,t);if(e)return e;I=g?null:I.sibling}}function dh(e){try{return Object.defineProperties(e,{_currentRenderer:{get:()=>null,set(){}},_currentRenderer2:{get:()=>null,set(){}}})}catch(g){return e}}const uh=dh(g.createContext(null));class hh extends g.Component{render(){return g.createElement(uh.Provider,{value:this._reactInternals},this.props.children)}}const{ReactCurrentOwner:bh,ReactCurrentDispatcher:mh}=g.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function ph(){const e=function(){var e,t;const I=function(){const e=g.useContext(uh);if(null===e)throw new Error("its-fine: useFiber must be called within a <FiberProvider />!");const t=g.useId();return g.useMemo((()=>{for(const g of[null==bh?void 0:bh.current,e,null==e?void 0:e.alternate]){if(!g)continue;const e=ch(g,!1,(e=>{let g=e.memoizedState;for(;g;){if(g.memoizedState===t)return!0;g=g.next}}));if(e)return e}}),[e,t])}(),[n]=g.useState((()=>new Map));n.clear();let i=I;for(;i;){const g=null==(e=i.type)?void 0:e._context;g&&g!==uh&&!n.has(g)&&n.set(g,null==(t=null==mh?void 0:mh.current)?void 0:t.readContext(dh(g))),i=i.return}return n}();return g.useMemo((()=>Array.from(e.keys()).reduce(((t,I)=>n=>g.createElement(t,null,g.createElement(I.Provider,((e,g)=>Ch(e,oh(g)))(Ah({},n),{value:e.get(I)})))),(e=>g.createElement(hh,Ah({},e))))),[e])}const Gh={onClick:["click",!1],onContextMenu:["contextmenu",!1],onDoubleClick:["dblclick",!1],onWheel:["wheel",!0],onPointerDown:["pointerdown",!0],onPointerUp:["pointerup",!0],onPointerLeave:["pointerleave",!0],onPointerMove:["pointermove",!0],onPointerCancel:["pointercancel",!0],onLostPointerCapture:["lostpointercapture",!0]};function Bh(e){const{handlePointer:g}=function(e){function g(e){return e.filter((e=>["Move","Over","Enter","Out","Leave"].some((g=>{var t;return null==(t=e.__r3f)?void 0:t.handlers["onPointer"+g]}))))}function t(g){const{internal:t}=e.getState();for(const e of t.hovered.values())if(!g.length||!g.find((g=>g.object===e.object&&g.index===e.index&&g.instanceId===e.instanceId))){const I=e.eventObject.__r3f,n=null==I?void 0:I.handlers;if(t.hovered.delete(mu(e)),null!=I&&I.eventCount){const t={...e,intersections:g};null==n.onPointerOut||n.onPointerOut(t),null==n.onPointerLeave||n.onPointerLeave(t)}}}function I(e,g){for(let t=0;t<g.length;t++){const I=g[t].__r3f;null==I||null==I.handlers.onPointerMissed||I.handlers.onPointerMissed(e)}}return{handlePointer:function(n){switch(n){case"onPointerLeave":case"onPointerCancel":return()=>t([]);case"onLostPointerCapture":return g=>{const{internal:I}=e.getState();"pointerId"in g&&I.capturedMap.has(g.pointerId)&&requestAnimationFrame((()=>{I.capturedMap.has(g.pointerId)&&(I.capturedMap.delete(g.pointerId),t([]))}))}}return function(i){const{onPointerMissed:C,internal:o}=e.getState();o.lastEvent.current=i;const a="onPointerMove"===n,s="onClick"===n||"onContextMenu"===n||"onDoubleClick"===n,l=function(g,t){const I=e.getState(),n=new Set,i=[],C=t?t(I.internal.interaction):I.internal.interaction;for(let e=0;e<C.length;e++){const g=iu(C[e]);g&&(g.raycaster.camera=void 0)}I.previousRoot||null==I.events.compute||I.events.compute(g,I);let o=C.flatMap((function(e){const t=iu(e);return t&&t.events.enabled&&null!==t.raycaster.camera?(void 0===t.raycaster.camera&&(null==t.events.compute||t.events.compute(g,t,null==(I=t.previousRoot)?void 0:I.getState()),void 0===t.raycaster.camera&&(t.raycaster.camera=null)),t.raycaster.camera?t.raycaster.intersectObject(e,!0):[]):[];var I})).sort(((e,g)=>{const t=iu(e.object),I=iu(g.object);return t&&I&&I.events.priority-t.events.priority||e.distance-g.distance})).filter((e=>{const g=mu(e);return!n.has(g)&&(n.add(g),!0)}));I.events.filter&&(o=I.events.filter(o,I));for(const e of o){let g=e.object;for(;g;){var a;null!=(a=g.__r3f)&&a.eventCount&&i.push({...e,eventObject:g}),g=g.parent}}if("pointerId"in g&&I.internal.capturedMap.has(g.pointerId))for(let e of I.internal.capturedMap.get(g.pointerId).values())n.has(mu(e.intersection))||i.push(e.intersection);return i}(i,a?g:void 0),r=s?function(g){const{internal:t}=e.getState(),I=g.offsetX-t.initialClick[0],n=g.offsetY-t.initialClick[1];return Math.round(Math.sqrt(I*I+n*n))}(i):0;"onPointerDown"===n&&(o.initialClick=[i.offsetX,i.offsetY],o.initialHits=l.map((e=>e.eventObject))),s&&!l.length&&r<=2&&(I(i,o.interaction),C&&C(i)),a&&t(l),function(g,I,n,i){const C=e.getState();if(g.length){const e={stopped:!1};for(const o of g){const a=iu(o.object)||C,{raycaster:s,pointer:l,camera:r,internal:A}=a,c=new UI(l.x,l.y,0).unproject(r),d=e=>{var g,t;return null!=(g=null==(t=A.capturedMap.get(e))?void 0:t.has(o.eventObject))&&g},u=e=>{const g={intersection:o,target:I.target};A.capturedMap.has(e)?A.capturedMap.get(e).set(o.eventObject,g):A.capturedMap.set(e,new Map([[o.eventObject,g]])),I.target.setPointerCapture(e)},h=e=>{const g=A.capturedMap.get(e);g&&pu(A.capturedMap,o.eventObject,g,e)};let b={};for(let e in I){let g=I[e];"function"!=typeof g&&(b[e]=g)}let m={...o,...b,pointer:l,intersections:g,stopped:e.stopped,delta:n,unprojectedPoint:c,ray:s.ray,camera:r,stopPropagation(){const n="pointerId"in I&&A.capturedMap.get(I.pointerId);(!n||n.has(o.eventObject))&&(m.stopped=e.stopped=!0,A.hovered.size&&Array.from(A.hovered.values()).find((e=>e.eventObject===o.eventObject)))&&t([...g.slice(0,g.indexOf(o)),o])},target:{hasPointerCapture:d,setPointerCapture:u,releasePointerCapture:h},currentTarget:{hasPointerCapture:d,setPointerCapture:u,releasePointerCapture:h},nativeEvent:I};if(i(m),!0===e.stopped)break}}}(l,i,r,(function(e){const g=e.eventObject,t=g.__r3f,C=null==t?void 0:t.handlers;if(null!=t&&t.eventCount)if(a){if(C.onPointerOver||C.onPointerEnter||C.onPointerOut||C.onPointerLeave){const g=mu(e),t=o.hovered.get(g);t?t.stopped&&e.stopPropagation():(o.hovered.set(g,e),null==C.onPointerOver||C.onPointerOver(e),null==C.onPointerEnter||C.onPointerEnter(e))}null==C.onPointerMove||C.onPointerMove(e)}else{const t=C[n];t?s&&!o.initialHits.includes(g)||(I(i,o.interaction.filter((e=>!o.initialHits.includes(e)))),t(e)):s&&o.initialHits.includes(g)&&I(i,o.interaction.filter((e=>!o.initialHits.includes(e))))}}))}}}}(e);return{priority:1,enabled:!0,compute(e,g,t){g.pointer.set(e.offsetX/g.size.width*2-1,-e.offsetY/g.size.height*2+1),g.raycaster.setFromCamera(g.pointer,g.camera)},connected:void 0,handlers:Object.keys(Gh).reduce(((e,t)=>({...e,[t]:g(t)})),{}),update:()=>{var g;const{events:t,internal:I}=e.getState();null!=(g=I.lastEvent)&&g.current&&t.handlers&&t.handlers.onPointerMove(I.lastEvent.current)},connect:g=>{var t;const{set:I,events:n}=e.getState();null==n.disconnect||n.disconnect(),I((e=>({events:{...e.events,connected:g}}))),Object.entries(null!=(t=n.handlers)?t:[]).forEach((([e,t])=>{const[I,n]=Gh[e];g.addEventListener(I,t,{passive:n})}))},disconnect:()=>{const{set:g,events:t}=e.getState();var I;t.connected&&(Object.entries(null!=(I=t.handlers)?I:[]).forEach((([e,g])=>{if(t&&t.connected instanceof HTMLElement){const[I]=Gh[e];t.connected.removeEventListener(I,g)}})),g((e=>({events:{...e.events,connected:void 0}}))))}}}const Zh=g.forwardRef((function({children:t,fallback:I,resize:n,style:i,gl:C,events:o=Bh,eventSource:a,eventPrefix:s,shadows:l,linear:r,flat:A,legacy:c,orthographic:d,frameloop:u,dpr:h,performance:b,raycaster:m,camera:p,scene:G,onPointerMissed:B,onCreated:Z,...y},v){g.useMemo((()=>Qd(e)),[]);const W=ph(),[f,w]=gh({scroll:!0,debounce:{scroll:50,resize:0},...n}),R=g.useRef(null),V=g.useRef(null);g.useImperativeHandle(v,(()=>R.current));const X=$d(B),[S,Y]=g.useState(!1),[K,H]=g.useState(!1);if(S)throw S;if(K)throw K;const N=g.useRef(null);qd((()=>{const e=R.current;w.width>0&&w.height>0&&e&&(N.current||(N.current=Ou(e)),N.current.configure({gl:C,events:o,shadows:l,linear:r,flat:A,legacy:c,orthographic:d,frameloop:u,dpr:h,performance:b,raycaster:m,camera:p,scene:G,size:w,onPointerMissed:(...e)=>null==X.current?void 0:X.current(...e),onCreated:e=>{var g;null==e.events.connect||e.events.connect(a?(g=a)&&g.hasOwnProperty("current")?a.current:a:V.current),s&&e.setEvents({compute:(e,g)=>{const t=e[s+"X"],I=e[s+"Y"];g.pointer.set(t/g.size.width*2-1,-I/g.size.height*2+1),g.raycaster.setFromCamera(g.pointer,g.camera)}}),null==Z||Z(e)}}),N.current.render(g.createElement(W,null,g.createElement(gu,{set:H},g.createElement(g.Suspense,{fallback:g.createElement(eu,{set:Y})},t)))))})),g.useEffect((()=>{const e=R.current;if(e)return()=>Pu(e)}),[]);const F=a?"none":"auto";return g.createElement("div",qu({ref:V,style:{position:"relative",width:"100%",height:"100%",overflow:"hidden",pointerEvents:F,...i}},y),g.createElement("div",{ref:f,style:{width:"100%",height:"100%"}},g.createElement("canvas",{ref:R,style:{display:"block"}},I)))})),yh=g.forwardRef((function(e,t){return g.createElement(hh,null,g.createElement(Zh,qu({},e,{ref:t})))}));const vh="undefined"==typeof window||!window.navigator||/ServerSideRendering|^Deno\//.test(window.navigator.userAgent)?g.useEffect:g.useLayoutEffect;let Wh=0;const fh=function(e){const t=function(e){let g;const t=new Set,I=(e,I)=>{const n="function"==typeof e?e(g):e;if(n!==g){const e=g;g=I?n:Object.assign({},g,n),t.forEach((t=>t(g,e)))}},n=()=>g,i={setState:I,getState:n,subscribe:(e,I,i)=>I||i?((e,I=n,i=Object.is)=>{console.warn("[DEPRECATED] Please use `subscribeWithSelector` middleware");let C=I(g);function o(){const t=I(g);if(!i(C,t)){const g=C;e(C=t,g)}}return t.add(o),()=>t.delete(o)})(e,I,i):(t.add(e),()=>t.delete(e)),destroy:()=>t.clear()};return g=e(I,n,i),i}(e),I=(e=t.getState,I=Object.is)=>{const[,n]=(0,g.useReducer)((e=>e+1),0),i=t.getState(),C=(0,g.useRef)(i),o=(0,g.useRef)(e),a=(0,g.useRef)(I),s=(0,g.useRef)(!1),l=(0,g.useRef)();let r;void 0===l.current&&(l.current=e(i));let A=!1;(C.current!==i||o.current!==e||a.current!==I||s.current)&&(r=e(i),A=!I(l.current,r)),vh((()=>{A&&(l.current=r),C.current=i,o.current=e,a.current=I,s.current=!1}));const c=(0,g.useRef)(i);vh((()=>{const e=()=>{try{const e=t.getState(),g=o.current(e);a.current(l.current,g)||(C.current=e,l.current=g,n())}catch(e){s.current=!0,n()}},g=t.subscribe(e);return t.getState()!==c.current&&e(),g}),[]);const d=A?r:l.current;return(0,g.useDebugValue)(d),d};return Object.assign(I,t),I[Symbol.iterator]=function(){console.warn("[useStore, api] = create() is deprecated and will be removed in v4");const e=[I,t];return{next(){const g=e.length<=0;return{value:e.shift(),done:g}}}},I}((e=>(vA.onStart=(g,t,I)=>{e({active:!0,item:g,loaded:t,total:I,progress:(t-Wh)/(I-Wh)*100})},vA.onLoad=()=>{e({active:!1})},vA.onError=g=>e((e=>({errors:[...e.errors,g]}))),vA.onProgress=(g,t,I)=>{t===I&&(Wh=I),e({active:!0,item:g,loaded:t,total:I,progress:(t-Wh)/(I-Wh)*100||100})},{errors:[],active:!1,progress:0,item:"",loaded:0,total:0}))),wh=new UI,Rh=new UI,Vh=new UI;function Xh(e,g,t){const I=wh.setFromMatrixPosition(e.matrixWorld);I.project(g);const n=t.width/2,i=t.height/2;return[I.x*n+n,-I.y*i+i]}const Sh=e=>Math.abs(e)<1e-10?0:e;function Yh(e,g,t=""){let I="matrix3d(";for(let t=0;16!==t;t++)I+=Sh(g[t]*e.elements[t])+(15!==t?",":")");return t+I}const Kh=(Hh=[1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1],e=>Yh(e,Hh));var Hh;const Nh=g.forwardRef((({children:e,eps:t=.001,style:n,className:i,prepend:C,center:o,fullscreen:a,portal:s,distanceFactor:l,sprite:r=!1,transform:A=!1,occlude:c,onOcclude:d,castShadow:u,receiveShadow:h,material:b,geometry:m,zIndexRange:p=[16777271,0],calculatePosition:G=Xh,as:B="div",wrapperClass:Z,pointerEvents:y="auto",...v},W)=>{const{gl:f,camera:w,scene:R,size:V,raycaster:X,events:S,viewport:K}=Fu(),[H]=g.useState((()=>document.createElement(B))),N=g.useRef(),F=g.useRef(null),x=g.useRef(0),z=g.useRef([0,0]),k=g.useRef(null),M=g.useRef(null),L=(null==s?void 0:s.current)||S.connected||f.domElement.parentNode,J=g.useRef(null),E=g.useRef(!1),T=g.useMemo((()=>c&&"blending"!==c||Array.isArray(c)&&c.length&&function(e){return e&&"object"==typeof e&&"current"in e}(c[0])),[c]);g.useLayoutEffect((()=>{const e=f.domElement;c&&"blending"===c?(e.style.zIndex=`${Math.floor(p[0]/2)}`,e.style.position="absolute",e.style.pointerEvents="none"):(e.style.zIndex=null,e.style.position=null,e.style.pointerEvents=null)}),[c]),g.useLayoutEffect((()=>{if(F.current){const e=N.current=I.s(H);if(R.updateMatrixWorld(),A)H.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const e=G(F.current,w,V);H.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${e[0]}px,${e[1]}px,0);transform-origin:0 0;`}return L&&(C?L.prepend(H):L.appendChild(H)),()=>{L&&L.removeChild(H),e.unmount()}}}),[L,A]),g.useLayoutEffect((()=>{Z&&(H.className=Z)}),[Z]);const U=g.useMemo((()=>A?{position:"absolute",top:0,left:0,width:V.width,height:V.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:o?"translate3d(-50%,-50%,0)":"none",...a&&{top:-V.height/2,left:-V.width/2,width:V.width,height:V.height},...n}),[n,o,a,V,A]),Q=g.useMemo((()=>({position:"absolute",pointerEvents:y})),[y]);g.useLayoutEffect((()=>{var t,I;E.current=!1,A?null==(t=N.current)||t.render(g.createElement("div",{ref:k,style:U},g.createElement("div",{ref:M,style:Q},g.createElement("div",{ref:W,className:i,style:n,children:e})))):null==(I=N.current)||I.render(g.createElement("div",{ref:W,style:U,className:i,children:e}))}));const D=g.useRef(!0);xu((e=>{if(F.current){w.updateMatrixWorld(),F.current.updateWorldMatrix(!0,!1);const e=A?z.current:G(F.current,w,V);if(A||Math.abs(x.current-w.zoom)>t||Math.abs(z.current[0]-e[0])>t||Math.abs(z.current[1]-e[1])>t){const g=function(e,g){const t=wh.setFromMatrixPosition(e.matrixWorld),I=Rh.setFromMatrixPosition(g.matrixWorld),n=t.sub(I),i=g.getWorldDirection(Vh);return n.angleTo(i)>Math.PI/2}(F.current,w);let t=!1;T&&(Array.isArray(c)?t=c.map((e=>e.current)):"blending"!==c&&(t=[R]));const I=D.current;if(t){const e=function(e,g,t,I){const n=wh.setFromMatrixPosition(e.matrixWorld),i=n.clone();i.project(g),t.setFromCamera(i,g);const C=t.intersectObjects(I,!0);if(C.length){const e=C[0].distance;return n.distanceTo(t.ray.origin)<e}return!0}(F.current,w,X,t);D.current=e&&!g}else D.current=!g;I!==D.current&&(d?d(!D.current):H.style.display=D.current?"block":"none");const n=Math.floor(p[0]/2),i=c?T?[p[0],n]:[n-1,0]:p;if(H.style.zIndex=`${function(e,g,t){if(g instanceof cC||g instanceof zC){const I=wh.setFromMatrixPosition(e.matrixWorld),n=Rh.setFromMatrixPosition(g.matrixWorld),i=I.distanceTo(n),C=(t[1]-t[0])/(g.far-g.near),o=t[1]-C*g.far;return Math.round(C*i+o)}}(F.current,w,i)}`,A){const[e,g]=[V.width/2,V.height/2],t=w.projectionMatrix.elements[5]*g,{isOrthographicCamera:I,top:n,left:i,bottom:C,right:o}=w,a=Kh(w.matrixWorldInverse),s=I?`scale(${t})translate(${Sh(-(o+i)/2)}px,${Sh((n+C)/2)}px)`:`translateZ(${t}px)`;let A=F.current.matrixWorld;r&&(A=w.matrixWorldInverse.clone().transpose().copyPosition(A).scale(F.current.scale),A.elements[3]=A.elements[7]=A.elements[11]=0,A.elements[15]=1),H.style.width=V.width+"px",H.style.height=V.height+"px",H.style.perspective=I?"":`${t}px`,k.current&&M.current&&(k.current.style.transform=`${s}${a}translate(${e}px,${g}px)`,M.current.style.transform=((e,g)=>Yh(e,(e=>[1/e,1/e,1/e,1,-1/e,-1/e,-1/e,-1,1/e,1/e,1/e,1,1,1,1,1])(g),"translate(-50%,-50%)"))(A,1/((l||10)/400)))}else{const g=void 0===l?1:function(e,g){if(g instanceof zC)return g.zoom;if(g instanceof cC){const t=wh.setFromMatrixPosition(e.matrixWorld),I=Rh.setFromMatrixPosition(g.matrixWorld),n=g.fov*Math.PI/180,i=t.distanceTo(I);return 1/(2*Math.tan(n/2)*i)}return 1}(F.current,w)*l;H.style.transform=`translate3d(${e[0]}px,${e[1]}px,0) scale(${g})`}z.current=e,x.current=w.zoom}}if(!T&&J.current&&!E.current)if(A){if(k.current){const e=k.current.children[0];if(null!=e&&e.clientWidth&&null!=e&&e.clientHeight){const{isOrthographicCamera:g}=w;if(g||m)v.scale&&(Array.isArray(v.scale)?v.scale instanceof UI?J.current.scale.copy(v.scale.clone().divideScalar(1)):J.current.scale.set(1/v.scale[0],1/v.scale[1],1/v.scale[2]):J.current.scale.setScalar(1/v.scale));else{const g=(l||10)/400,t=e.clientWidth*g,I=e.clientHeight*g;J.current.scale.set(t,I,1)}E.current=!0}}}else{const g=H.children[0];if(null!=g&&g.clientWidth&&null!=g&&g.clientHeight){const e=1/K.factor,t=g.clientWidth*e,I=g.clientHeight*e;J.current.scale.set(t,I,1),E.current=!0}J.current.lookAt(e.camera.position)}}));const O=g.useMemo((()=>({vertexShader:A?void 0:'\n          /*\n            This shader is from the THREE\'s SpriteMaterial.\n            We need to turn the backing plane into a Sprite\n            (make it always face the camera) if "transfrom" \n            is false. \n          */\n          #include <common>\n\n          void main() {\n            vec2 center = vec2(0., 1.);\n            float rotation = 0.0;\n            \n            // This is somewhat arbitrary, but it seems to work well\n            // Need to figure out how to derive this dynamically if it even matters\n            float size = 0.03;\n\n            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n            vec2 scale;\n            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\n            bool isPerspective = isPerspectiveMatrix( projectionMatrix );\n            if ( isPerspective ) scale *= - mvPosition.z;\n\n            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;\n            vec2 rotatedPosition;\n            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n            mvPosition.xy += rotatedPosition;\n\n            gl_Position = projectionMatrix * mvPosition;\n          }\n      ',fragmentShader:"\n        void main() {\n          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\n        }\n      "})),[A]);return g.createElement("group",qu({},v,{ref:F}),c&&!T&&g.createElement("mesh",{castShadow:u,receiveShadow:h,ref:J},m||g.createElement("planeGeometry",null),b||g.createElement("shaderMaterial",{side:Y,vertexShader:O.vertexShader,fragmentShader:O.fragmentShader})))}));var Fh=n(466),xh=n.n(Fh);function zh(e,g){"function"==typeof e?e(g):null!=e&&(e.current=g)}function kh({showPanel:e=0,className:t,parent:I}){const n=function(e,t=[],I){const[n,i]=g.useState();return g.useLayoutEffect((()=>{const g=e();return i(g),zh(I,g),()=>zh(I,null)}),t),n}((()=>new(xh())),[]);return g.useEffect((()=>{if(n){const g=I&&I.current||document.body;n.showPanel(e),null==g||g.appendChild(n.dom),t&&n.dom.classList.add(...t.split(" ").filter((e=>e)));const i=Ru((()=>n.begin())),C=Vu((()=>n.end()));return()=>{null==g||g.removeChild(n.dom),i(),C()}}}),[I,n,t,e]),null}var Mh,Lh=n(893),Jh={exports:{}},Eh="object"==typeof Reflect?Reflect:null,Th=Eh&&"function"==typeof Eh.apply?Eh.apply:function(e,g,t){return Function.prototype.apply.call(e,g,t)};Mh=Eh&&"function"==typeof Eh.ownKeys?Eh.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var Uh=Number.isNaN||function(e){return e!=e};function Qh(){Qh.init.call(this)}Jh.exports=Qh,Jh.exports.once=function(e,g){return new Promise((function(t,I){function n(t){e.removeListener(g,i),I(t)}function i(){"function"==typeof e.removeListener&&e.removeListener("error",n),t([].slice.call(arguments))}tb(e,g,i,{once:!0}),"error"!==g&&function(e,g,t){"function"==typeof e.on&&tb(e,"error",g,{once:!0})}(e,n)}))},Qh.EventEmitter=Qh,Qh.prototype._events=void 0,Qh.prototype._eventsCount=0,Qh.prototype._maxListeners=void 0;var Dh=10;function Oh(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function jh(e){return void 0===e._maxListeners?Qh.defaultMaxListeners:e._maxListeners}function Ph(e,g,t,I){var n,i,C,o;if(Oh(t),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",g,t.listener?t.listener:t),i=e._events),C=i[g]),void 0===C)C=i[g]=t,++e._eventsCount;else if("function"==typeof C?C=i[g]=I?[t,C]:[C,t]:I?C.unshift(t):C.push(t),(n=jh(e))>0&&C.length>n&&!C.warned){C.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+C.length+" "+String(g)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=g,a.count=C.length,o=a,console&&console.warn&&console.warn(o)}return e}function _h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function qh(e,g,t){var I={fired:!1,wrapFn:void 0,target:e,type:g,listener:t},n=_h.bind(I);return n.listener=t,I.wrapFn=n,n}function $h(e,g,t){var I=e._events;if(void 0===I)return[];var n=I[g];return void 0===n?[]:"function"==typeof n?t?[n.listener||n]:[n]:t?function(e){for(var g=new Array(e.length),t=0;t<g.length;++t)g[t]=e[t].listener||e[t];return g}(n):gb(n,n.length)}function eb(e){var g=this._events;if(void 0!==g){var t=g[e];if("function"==typeof t)return 1;if(void 0!==t)return t.length}return 0}function gb(e,g){for(var t=new Array(g),I=0;I<g;++I)t[I]=e[I];return t}function tb(e,g,t,I){if("function"==typeof e.on)I.once?e.once(g,t):e.on(g,t);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(g,(function n(i){I.once&&e.removeEventListener(g,n),t(i)}))}}Object.defineProperty(Qh,"defaultMaxListeners",{enumerable:!0,get:function(){return Dh},set:function(e){if("number"!=typeof e||e<0||Uh(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");Dh=e}}),Qh.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},Qh.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||Uh(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},Qh.prototype.getMaxListeners=function(){return jh(this)},Qh.prototype.emit=function(e){for(var g=[],t=1;t<arguments.length;t++)g.push(arguments[t]);var I="error"===e,n=this._events;if(void 0!==n)I=I&&void 0===n.error;else if(!I)return!1;if(I){var i;if(g.length>0&&(i=g[0]),i instanceof Error)throw i;var C=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw C.context=i,C}var o=n[e];if(void 0===o)return!1;if("function"==typeof o)Th(o,this,g);else{var a=o.length,s=gb(o,a);for(t=0;t<a;++t)Th(s[t],this,g)}return!0},Qh.prototype.addListener=function(e,g){return Ph(this,e,g,!1)},Qh.prototype.on=Qh.prototype.addListener,Qh.prototype.prependListener=function(e,g){return Ph(this,e,g,!0)},Qh.prototype.once=function(e,g){return Oh(g),this.on(e,qh(this,e,g)),this},Qh.prototype.prependOnceListener=function(e,g){return Oh(g),this.prependListener(e,qh(this,e,g)),this},Qh.prototype.removeListener=function(e,g){var t,I,n,i,C;if(Oh(g),void 0===(I=this._events))return this;if(void 0===(t=I[e]))return this;if(t===g||t.listener===g)0==--this._eventsCount?this._events=Object.create(null):(delete I[e],I.removeListener&&this.emit("removeListener",e,t.listener||g));else if("function"!=typeof t){for(n=-1,i=t.length-1;i>=0;i--)if(t[i]===g||t[i].listener===g){C=t[i].listener,n=i;break}if(n<0)return this;0===n?t.shift():function(e,g){for(;g+1<e.length;g++)e[g]=e[g+1];e.pop()}(t,n),1===t.length&&(I[e]=t[0]),void 0!==I.removeListener&&this.emit("removeListener",e,C||g)}return this},Qh.prototype.off=Qh.prototype.removeListener,Qh.prototype.removeAllListeners=function(e){var g,t,I;if(void 0===(t=this._events))return this;if(void 0===t.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==t[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete t[e]),this;if(0===arguments.length){var n,i=Object.keys(t);for(I=0;I<i.length;++I)"removeListener"!==(n=i[I])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(g=t[e]))this.removeListener(e,g);else if(void 0!==g)for(I=g.length-1;I>=0;I--)this.removeListener(e,g[I]);return this},Qh.prototype.listeners=function(e){return $h(this,e,!0)},Qh.prototype.rawListeners=function(e){return $h(this,e,!1)},Qh.listenerCount=function(e,g){return"function"==typeof e.listenerCount?e.listenerCount(g):eb.call(e,g)},Qh.prototype.listenerCount=eb,Qh.prototype.eventNames=function(){return this._eventsCount>0?Mh(this._events):[]};var Ib=Jh.exports;var nb,ib=("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICogUmVjb3JkcyB3aGF0IG9iamVjdHMgYXJlIGNvbGxpZGluZyB3aXRoIGVhY2ggb3RoZXIKICAgKi8KCiAgLyoqCiAgICogQSAzeDMgbWF0cml4LgogICAqIEF1dGhvcmVkIGJ5IHtAbGluayBodHRwOi8vZ2l0aHViLmNvbS9zY2h0ZXBwZS8gc2NodGVwcGV9CiAgICovCiAgY2xhc3MgTWF0MyB7CiAgICAvKioKICAgICAqIEEgdmVjdG9yIG9mIGxlbmd0aCA5LCBjb250YWluaW5nIGFsbCBtYXRyaXggZWxlbWVudHMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBwYXJhbSBlbGVtZW50cyBBIHZlY3RvciBvZiBsZW5ndGggOSwgY29udGFpbmluZyBhbGwgbWF0cml4IGVsZW1lbnRzLgogICAgICovCiAgICBjb25zdHJ1Y3RvcihlbGVtZW50cykgewogICAgICBpZiAoZWxlbWVudHMgPT09IHZvaWQgMCkgewogICAgICAgIGVsZW1lbnRzID0gWzAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDBdOwogICAgICB9CgogICAgICB0aGlzLmVsZW1lbnRzID0gZWxlbWVudHM7CiAgICB9CiAgICAvKioKICAgICAqIFNldHMgdGhlIG1hdHJpeCB0byBpZGVudGl0eQogICAgICogQHRvZG8gU2hvdWxkIHBlcmhhcHMgYmUgcmVuYW1lZCB0byBgc2V0SWRlbnRpdHkoKWAgdG8gYmUgbW9yZSBjbGVhci4KICAgICAqIEB0b2RvIENyZWF0ZSBhbm90aGVyIGZ1bmN0aW9uIHRoYXQgaW1tZWRpYXRlbHkgY3JlYXRlcyBhbiBpZGVudGl0eSBtYXRyaXggZWcuIGBleWUoKWAKICAgICAqLwoKCiAgICBpZGVudGl0eSgpIHsKICAgICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHM7CiAgICAgIGVbMF0gPSAxOwogICAgICBlWzFdID0gMDsKICAgICAgZVsyXSA9IDA7CiAgICAgIGVbM10gPSAwOwogICAgICBlWzRdID0gMTsKICAgICAgZVs1XSA9IDA7CiAgICAgIGVbNl0gPSAwOwogICAgICBlWzddID0gMDsKICAgICAgZVs4XSA9IDE7CiAgICB9CiAgICAvKioKICAgICAqIFNldCBhbGwgZWxlbWVudHMgdG8gemVybwogICAgICovCgoKICAgIHNldFplcm8oKSB7CiAgICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgICBlWzBdID0gMDsKICAgICAgZVsxXSA9IDA7CiAgICAgIGVbMl0gPSAwOwogICAgICBlWzNdID0gMDsKICAgICAgZVs0XSA9IDA7CiAgICAgIGVbNV0gPSAwOwogICAgICBlWzZdID0gMDsKICAgICAgZVs3XSA9IDA7CiAgICAgIGVbOF0gPSAwOwogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBtYXRyaXggZGlhZ29uYWwgZWxlbWVudHMgZnJvbSBhIFZlYzMKICAgICAqLwoKCiAgICBzZXRUcmFjZSh2ZWN0b3IpIHsKICAgICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHM7CiAgICAgIGVbMF0gPSB2ZWN0b3IueDsKICAgICAgZVs0XSA9IHZlY3Rvci55OwogICAgICBlWzhdID0gdmVjdG9yLno7CiAgICB9CiAgICAvKioKICAgICAqIEdldHMgdGhlIG1hdHJpeCBkaWFnb25hbCBlbGVtZW50cwogICAgICovCgoKICAgIGdldFRyYWNlKHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50czsKICAgICAgdGFyZ2V0LnggPSBlWzBdOwogICAgICB0YXJnZXQueSA9IGVbNF07CiAgICAgIHRhcmdldC56ID0gZVs4XTsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogTWF0cml4LVZlY3RvciBtdWx0aXBsaWNhdGlvbgogICAgICogQHBhcmFtIHYgVGhlIHZlY3RvciB0byBtdWx0aXBseSB3aXRoCiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsLCB0YXJnZXQgdG8gc2F2ZSB0aGUgcmVzdWx0IGluLgogICAgICovCgoKICAgIHZtdWx0KHYsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50czsKICAgICAgY29uc3QgeCA9IHYueDsKICAgICAgY29uc3QgeSA9IHYueTsKICAgICAgY29uc3QgeiA9IHYuejsKICAgICAgdGFyZ2V0LnggPSBlWzBdICogeCArIGVbMV0gKiB5ICsgZVsyXSAqIHo7CiAgICAgIHRhcmdldC55ID0gZVszXSAqIHggKyBlWzRdICogeSArIGVbNV0gKiB6OwogICAgICB0YXJnZXQueiA9IGVbNl0gKiB4ICsgZVs3XSAqIHkgKyBlWzhdICogejsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogTWF0cml4LXNjYWxhciBtdWx0aXBsaWNhdGlvbgogICAgICovCgoKICAgIHNtdWx0KHMpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5lbGVtZW50c1tpXSAqPSBzOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIE1hdHJpeCBtdWx0aXBsaWNhdGlvbgogICAgICogQHBhcmFtIG1hdHJpeCBNYXRyaXggdG8gbXVsdGlwbHkgd2l0aCBmcm9tIGxlZnQgc2lkZS4KICAgICAqLwoKCiAgICBtbXVsdChtYXRyaXgsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgTWF0MygpOwogICAgICB9CgogICAgICBjb25zdCBBID0gdGhpcy5lbGVtZW50czsKICAgICAgY29uc3QgQiA9IG1hdHJpeC5lbGVtZW50czsKICAgICAgY29uc3QgVCA9IHRhcmdldC5lbGVtZW50czsKICAgICAgY29uc3QgYTExID0gQVswXSwKICAgICAgICAgICAgYTEyID0gQVsxXSwKICAgICAgICAgICAgYTEzID0gQVsyXSwKICAgICAgICAgICAgYTIxID0gQVszXSwKICAgICAgICAgICAgYTIyID0gQVs0XSwKICAgICAgICAgICAgYTIzID0gQVs1XSwKICAgICAgICAgICAgYTMxID0gQVs2XSwKICAgICAgICAgICAgYTMyID0gQVs3XSwKICAgICAgICAgICAgYTMzID0gQVs4XTsKICAgICAgY29uc3QgYjExID0gQlswXSwKICAgICAgICAgICAgYjEyID0gQlsxXSwKICAgICAgICAgICAgYjEzID0gQlsyXSwKICAgICAgICAgICAgYjIxID0gQlszXSwKICAgICAgICAgICAgYjIyID0gQls0XSwKICAgICAgICAgICAgYjIzID0gQls1XSwKICAgICAgICAgICAgYjMxID0gQls2XSwKICAgICAgICAgICAgYjMyID0gQls3XSwKICAgICAgICAgICAgYjMzID0gQls4XTsKICAgICAgVFswXSA9IGExMSAqIGIxMSArIGExMiAqIGIyMSArIGExMyAqIGIzMTsKICAgICAgVFsxXSA9IGExMSAqIGIxMiArIGExMiAqIGIyMiArIGExMyAqIGIzMjsKICAgICAgVFsyXSA9IGExMSAqIGIxMyArIGExMiAqIGIyMyArIGExMyAqIGIzMzsKICAgICAgVFszXSA9IGEyMSAqIGIxMSArIGEyMiAqIGIyMSArIGEyMyAqIGIzMTsKICAgICAgVFs0XSA9IGEyMSAqIGIxMiArIGEyMiAqIGIyMiArIGEyMyAqIGIzMjsKICAgICAgVFs1XSA9IGEyMSAqIGIxMyArIGEyMiAqIGIyMyArIGEyMyAqIGIzMzsKICAgICAgVFs2XSA9IGEzMSAqIGIxMSArIGEzMiAqIGIyMSArIGEzMyAqIGIzMTsKICAgICAgVFs3XSA9IGEzMSAqIGIxMiArIGEzMiAqIGIyMiArIGEzMyAqIGIzMjsKICAgICAgVFs4XSA9IGEzMSAqIGIxMyArIGEzMiAqIGIyMyArIGEzMyAqIGIzMzsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogU2NhbGUgZWFjaCBjb2x1bW4gb2YgdGhlIG1hdHJpeAogICAgICovCgoKICAgIHNjYWxlKHZlY3RvciwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBNYXQzKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgICBjb25zdCB0ID0gdGFyZ2V0LmVsZW1lbnRzOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IDM7IGkrKykgewogICAgICAgIHRbMyAqIGkgKyAwXSA9IHZlY3Rvci54ICogZVszICogaSArIDBdOwogICAgICAgIHRbMyAqIGkgKyAxXSA9IHZlY3Rvci55ICogZVszICogaSArIDFdOwogICAgICAgIHRbMyAqIGkgKyAyXSA9IHZlY3Rvci56ICogZVszICogaSArIDJdOwogICAgICB9CgogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBTb2x2ZSBBeD1iCiAgICAgKiBAcGFyYW0gYiBUaGUgcmlnaHQgaGFuZCBzaWRlCiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsLiBUYXJnZXQgdmVjdG9yIHRvIHNhdmUgaW4uCiAgICAgKiBAcmV0dXJuIFRoZSBzb2x1dGlvbiB4CiAgICAgKiBAdG9kbyBzaG91bGQgcmV1c2UgYXJyYXlzCiAgICAgKi8KCgogICAgc29sdmUoYiwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIC8vIENvbnN0cnVjdCBlcXVhdGlvbnMKICAgICAgY29uc3QgbnIgPSAzOyAvLyBudW0gcm93cwoKICAgICAgY29uc3QgbmMgPSA0OyAvLyBudW0gY29scwoKICAgICAgY29uc3QgZXFucyA9IFtdOwogICAgICBsZXQgaTsKICAgICAgbGV0IGo7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgbnIgKiBuYzsgaSsrKSB7CiAgICAgICAgZXFucy5wdXNoKDApOwogICAgICB9CgogICAgICBmb3IgKGkgPSAwOyBpIDwgMzsgaSsrKSB7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IDM7IGorKykgewogICAgICAgICAgZXFuc1tpICsgbmMgKiBqXSA9IHRoaXMuZWxlbWVudHNbaSArIDMgKiBqXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGVxbnNbMyArIDQgKiAwXSA9IGIueDsKICAgICAgZXFuc1szICsgNCAqIDFdID0gYi55OwogICAgICBlcW5zWzMgKyA0ICogMl0gPSBiLno7IC8vIENvbXB1dGUgcmlnaHQgdXBwZXIgdHJpYW5ndWxhciB2ZXJzaW9uIG9mIHRoZSBtYXRyaXggLSBHYXVzcyBlbGltaW5hdGlvbgoKICAgICAgbGV0IG4gPSAzOwogICAgICBjb25zdCBrID0gbjsKICAgICAgbGV0IG5wOwogICAgICBjb25zdCBrcCA9IDQ7IC8vIG51bSByb3dzCgogICAgICBsZXQgcDsKCiAgICAgIGRvIHsKICAgICAgICBpID0gayAtIG47CgogICAgICAgIGlmIChlcW5zW2kgKyBuYyAqIGldID09PSAwKSB7CiAgICAgICAgICAvLyB0aGUgcGl2b3QgaXMgbnVsbCwgc3dhcCBsaW5lcwogICAgICAgICAgZm9yIChqID0gaSArIDE7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgaWYgKGVxbnNbaSArIG5jICogal0gIT09IDApIHsKICAgICAgICAgICAgICBucCA9IGtwOwoKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAvLyBkbyBsaWduZSggaSApID0gbGlnbmUoIGkgKSArIGxpZ25lKCBrICkKICAgICAgICAgICAgICAgIHAgPSBrcCAtIG5wOwogICAgICAgICAgICAgICAgZXFuc1twICsgbmMgKiBpXSArPSBlcW5zW3AgKyBuYyAqIGpdOwogICAgICAgICAgICAgIH0gd2hpbGUgKC0tbnApOwoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGVxbnNbaSArIG5jICogaV0gIT09IDApIHsKICAgICAgICAgIGZvciAoaiA9IGkgKyAxOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgIGNvbnN0IG11bHRpcGxpZXIgPSBlcW5zW2kgKyBuYyAqIGpdIC8gZXFuc1tpICsgbmMgKiBpXTsKICAgICAgICAgICAgbnAgPSBrcDsKCiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAvLyBkbyBsaWduZSggayApID0gbGlnbmUoIGsgKSAtIG11bHRpcGxpZXIgKiBsaWduZSggaSApCiAgICAgICAgICAgICAgcCA9IGtwIC0gbnA7CiAgICAgICAgICAgICAgZXFuc1twICsgbmMgKiBqXSA9IHAgPD0gaSA/IDAgOiBlcW5zW3AgKyBuYyAqIGpdIC0gZXFuc1twICsgbmMgKiBpXSAqIG11bHRpcGxpZXI7CiAgICAgICAgICAgIH0gd2hpbGUgKC0tbnApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSB3aGlsZSAoLS1uKTsgLy8gR2V0IHRoZSBzb2x1dGlvbgoKCiAgICAgIHRhcmdldC56ID0gZXFuc1syICogbmMgKyAzXSAvIGVxbnNbMiAqIG5jICsgMl07CiAgICAgIHRhcmdldC55ID0gKGVxbnNbMSAqIG5jICsgM10gLSBlcW5zWzEgKiBuYyArIDJdICogdGFyZ2V0LnopIC8gZXFuc1sxICogbmMgKyAxXTsKICAgICAgdGFyZ2V0LnggPSAoZXFuc1swICogbmMgKyAzXSAtIGVxbnNbMCAqIG5jICsgMl0gKiB0YXJnZXQueiAtIGVxbnNbMCAqIG5jICsgMV0gKiB0YXJnZXQueSkgLyBlcW5zWzAgKiBuYyArIDBdOwoKICAgICAgaWYgKGlzTmFOKHRhcmdldC54KSB8fCBpc05hTih0YXJnZXQueSkgfHwgaXNOYU4odGFyZ2V0LnopIHx8IHRhcmdldC54ID09PSBJbmZpbml0eSB8fCB0YXJnZXQueSA9PT0gSW5maW5pdHkgfHwgdGFyZ2V0LnogPT09IEluZmluaXR5KSB7CiAgICAgICAgdGhyb3cgYENvdWxkIG5vdCBzb2x2ZSBlcXVhdGlvbiEgR290IHg9WyR7dGFyZ2V0LnRvU3RyaW5nKCl9XSwgYj1bJHtiLnRvU3RyaW5nKCl9XSwgQT1bJHt0aGlzLnRvU3RyaW5nKCl9XWA7CiAgICAgIH0KCiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbiBlbGVtZW50IGluIHRoZSBtYXRyaXggYnkgaW5kZXguIEluZGV4IHN0YXJ0cyBhdCAwLCBub3QgMSEhIQogICAgICogQHBhcmFtIHZhbHVlIElmIHByb3ZpZGVkLCB0aGUgbWF0cml4IGVsZW1lbnQgd2lsbCBiZSBzZXQgdG8gdGhpcyB2YWx1ZS4KICAgICAqLwoKCiAgICBlKHJvdywgY29sdW1uLCB2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB0aGlzLmVsZW1lbnRzW2NvbHVtbiArIDMgKiByb3ddOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNldCB2YWx1ZQogICAgICAgIHRoaXMuZWxlbWVudHNbY29sdW1uICsgMyAqIHJvd10gPSB2YWx1ZTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDb3B5IGFub3RoZXIgbWF0cml4IGludG8gdGhpcyBtYXRyaXggb2JqZWN0LgogICAgICovCgoKICAgIGNvcHkobWF0cml4KSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWF0cml4LmVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5lbGVtZW50c1tpXSA9IG1hdHJpeC5lbGVtZW50c1tpXTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIG1hdHJpeC4KICAgICAqLwoKCiAgICB0b1N0cmluZygpIHsKICAgICAgbGV0IHIgPSAnJzsKICAgICAgY29uc3Qgc2VwID0gJywnOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA5OyBpKyspIHsKICAgICAgICByICs9IHRoaXMuZWxlbWVudHNbaV0gKyBzZXA7CiAgICAgIH0KCiAgICAgIHJldHVybiByOwogICAgfQogICAgLyoqCiAgICAgKiByZXZlcnNlIHRoZSBtYXRyaXgKICAgICAqIEBwYXJhbSB0YXJnZXQgVGFyZ2V0IG1hdHJpeCB0byBzYXZlIGluLgogICAgICogQHJldHVybiBUaGUgc29sdXRpb24geAogICAgICovCgoKICAgIHJldmVyc2UodGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBNYXQzKCk7CiAgICAgIH0KCiAgICAgIC8vIENvbnN0cnVjdCBlcXVhdGlvbnMKICAgICAgY29uc3QgbnIgPSAzOyAvLyBudW0gcm93cwoKICAgICAgY29uc3QgbmMgPSA2OyAvLyBudW0gY29scwoKICAgICAgY29uc3QgZXFucyA9IHJldmVyc2VfZXFuczsKICAgICAgbGV0IGk7CiAgICAgIGxldCBqOwoKICAgICAgZm9yIChpID0gMDsgaSA8IDM7IGkrKykgewogICAgICAgIGZvciAoaiA9IDA7IGogPCAzOyBqKyspIHsKICAgICAgICAgIGVxbnNbaSArIG5jICogal0gPSB0aGlzLmVsZW1lbnRzW2kgKyAzICogal07CiAgICAgICAgfQogICAgICB9CgogICAgICBlcW5zWzMgKyA2ICogMF0gPSAxOwogICAgICBlcW5zWzMgKyA2ICogMV0gPSAwOwogICAgICBlcW5zWzMgKyA2ICogMl0gPSAwOwogICAgICBlcW5zWzQgKyA2ICogMF0gPSAwOwogICAgICBlcW5zWzQgKyA2ICogMV0gPSAxOwogICAgICBlcW5zWzQgKyA2ICogMl0gPSAwOwogICAgICBlcW5zWzUgKyA2ICogMF0gPSAwOwogICAgICBlcW5zWzUgKyA2ICogMV0gPSAwOwogICAgICBlcW5zWzUgKyA2ICogMl0gPSAxOyAvLyBDb21wdXRlIHJpZ2h0IHVwcGVyIHRyaWFuZ3VsYXIgdmVyc2lvbiBvZiB0aGUgbWF0cml4IC0gR2F1c3MgZWxpbWluYXRpb24KCiAgICAgIGxldCBuID0gMzsKICAgICAgY29uc3QgayA9IG47CiAgICAgIGxldCBucDsKICAgICAgY29uc3Qga3AgPSBuYzsgLy8gbnVtIHJvd3MKCiAgICAgIGxldCBwOwoKICAgICAgZG8gewogICAgICAgIGkgPSBrIC0gbjsKCiAgICAgICAgaWYgKGVxbnNbaSArIG5jICogaV0gPT09IDApIHsKICAgICAgICAgIC8vIHRoZSBwaXZvdCBpcyBudWxsLCBzd2FwIGxpbmVzCiAgICAgICAgICBmb3IgKGogPSBpICsgMTsgaiA8IGs7IGorKykgewogICAgICAgICAgICBpZiAoZXFuc1tpICsgbmMgKiBqXSAhPT0gMCkgewogICAgICAgICAgICAgIG5wID0ga3A7CgogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIC8vIGRvIGxpbmUoIGkgKSA9IGxpbmUoIGkgKSArIGxpbmUoIGsgKQogICAgICAgICAgICAgICAgcCA9IGtwIC0gbnA7CiAgICAgICAgICAgICAgICBlcW5zW3AgKyBuYyAqIGldICs9IGVxbnNbcCArIG5jICogal07CiAgICAgICAgICAgICAgfSB3aGlsZSAoLS1ucCk7CgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZXFuc1tpICsgbmMgKiBpXSAhPT0gMCkgewogICAgICAgICAgZm9yIChqID0gaSArIDE7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IGVxbnNbaSArIG5jICogal0gLyBlcW5zW2kgKyBuYyAqIGldOwogICAgICAgICAgICBucCA9IGtwOwoKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIC8vIGRvIGxpbmUoIGsgKSA9IGxpbmUoIGsgKSAtIG11bHRpcGxpZXIgKiBsaW5lKCBpICkKICAgICAgICAgICAgICBwID0ga3AgLSBucDsKICAgICAgICAgICAgICBlcW5zW3AgKyBuYyAqIGpdID0gcCA8PSBpID8gMCA6IGVxbnNbcCArIG5jICogal0gLSBlcW5zW3AgKyBuYyAqIGldICogbXVsdGlwbGllcjsKICAgICAgICAgICAgfSB3aGlsZSAoLS1ucCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IHdoaWxlICgtLW4pOyAvLyBlbGltaW5hdGUgdGhlIHVwcGVyIGxlZnQgdHJpYW5nbGUgb2YgdGhlIG1hdHJpeAoKCiAgICAgIGkgPSAyOwoKICAgICAgZG8gewogICAgICAgIGogPSBpIC0gMTsKCiAgICAgICAgZG8gewogICAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IGVxbnNbaSArIG5jICogal0gLyBlcW5zW2kgKyBuYyAqIGldOwogICAgICAgICAgbnAgPSBuYzsKCiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHAgPSBuYyAtIG5wOwogICAgICAgICAgICBlcW5zW3AgKyBuYyAqIGpdID0gZXFuc1twICsgbmMgKiBqXSAtIGVxbnNbcCArIG5jICogaV0gKiBtdWx0aXBsaWVyOwogICAgICAgICAgfSB3aGlsZSAoLS1ucCk7CiAgICAgICAgfSB3aGlsZSAoai0tKTsKICAgICAgfSB3aGlsZSAoLS1pKTsgLy8gb3BlcmF0aW9ucyBvbiB0aGUgZGlhZ29uYWwKCgogICAgICBpID0gMjsKCiAgICAgIGRvIHsKICAgICAgICBjb25zdCBtdWx0aXBsaWVyID0gMSAvIGVxbnNbaSArIG5jICogaV07CiAgICAgICAgbnAgPSBuYzsKCiAgICAgICAgZG8gewogICAgICAgICAgcCA9IG5jIC0gbnA7CiAgICAgICAgICBlcW5zW3AgKyBuYyAqIGldID0gZXFuc1twICsgbmMgKiBpXSAqIG11bHRpcGxpZXI7CiAgICAgICAgfSB3aGlsZSAoLS1ucCk7CiAgICAgIH0gd2hpbGUgKGktLSk7CgogICAgICBpID0gMjsKCiAgICAgIGRvIHsKICAgICAgICBqID0gMjsKCiAgICAgICAgZG8gewogICAgICAgICAgcCA9IGVxbnNbbnIgKyBqICsgbmMgKiBpXTsKCiAgICAgICAgICBpZiAoaXNOYU4ocCkgfHwgcCA9PT0gSW5maW5pdHkpIHsKICAgICAgICAgICAgdGhyb3cgYENvdWxkIG5vdCByZXZlcnNlISBBPVske3RoaXMudG9TdHJpbmcoKX1dYDsKICAgICAgICAgIH0KCiAgICAgICAgICB0YXJnZXQuZShpLCBqLCBwKTsKICAgICAgICB9IHdoaWxlIChqLS0pOwogICAgICB9IHdoaWxlIChpLS0pOwoKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBtYXRyaXggZnJvbSBhIHF1YXRlcmlvbgogICAgICovCgoKICAgIHNldFJvdGF0aW9uRnJvbVF1YXRlcm5pb24ocSkgewogICAgICBjb25zdCB4ID0gcS54OwogICAgICBjb25zdCB5ID0gcS55OwogICAgICBjb25zdCB6ID0gcS56OwogICAgICBjb25zdCB3ID0gcS53OwogICAgICBjb25zdCB4MiA9IHggKyB4OwogICAgICBjb25zdCB5MiA9IHkgKyB5OwogICAgICBjb25zdCB6MiA9IHogKyB6OwogICAgICBjb25zdCB4eCA9IHggKiB4MjsKICAgICAgY29uc3QgeHkgPSB4ICogeTI7CiAgICAgIGNvbnN0IHh6ID0geCAqIHoyOwogICAgICBjb25zdCB5eSA9IHkgKiB5MjsKICAgICAgY29uc3QgeXogPSB5ICogejI7CiAgICAgIGNvbnN0IHp6ID0geiAqIHoyOwogICAgICBjb25zdCB3eCA9IHcgKiB4MjsKICAgICAgY29uc3Qgd3kgPSB3ICogeTI7CiAgICAgIGNvbnN0IHd6ID0gdyAqIHoyOwogICAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50czsKICAgICAgZVszICogMCArIDBdID0gMSAtICh5eSArIHp6KTsKICAgICAgZVszICogMCArIDFdID0geHkgLSB3ejsKICAgICAgZVszICogMCArIDJdID0geHogKyB3eTsKICAgICAgZVszICogMSArIDBdID0geHkgKyB3ejsKICAgICAgZVszICogMSArIDFdID0gMSAtICh4eCArIHp6KTsKICAgICAgZVszICogMSArIDJdID0geXogLSB3eDsKICAgICAgZVszICogMiArIDBdID0geHogLSB3eTsKICAgICAgZVszICogMiArIDFdID0geXogKyB3eDsKICAgICAgZVszICogMiArIDJdID0gMSAtICh4eCArIHl5KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIFRyYW5zcG9zZSB0aGUgbWF0cml4CiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsLiBXaGVyZSB0byBzdG9yZSB0aGUgcmVzdWx0LgogICAgICogQHJldHVybiBUaGUgdGFyZ2V0IE1hdDMsIG9yIGEgbmV3IE1hdDMgaWYgdGFyZ2V0IHdhcyBvbWl0dGVkLgogICAgICovCgoKICAgIHRyYW5zcG9zZSh0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IE1hdDMoKTsKICAgICAgfQoKICAgICAgY29uc3QgTSA9IHRoaXMuZWxlbWVudHM7CiAgICAgIGNvbnN0IFQgPSB0YXJnZXQuZWxlbWVudHM7CiAgICAgIGxldCB0bXA7IC8vU2V0IGRpYWdvbmFscwoKICAgICAgVFswXSA9IE1bMF07CiAgICAgIFRbNF0gPSBNWzRdOwogICAgICBUWzhdID0gTVs4XTsKICAgICAgdG1wID0gTVsxXTsKICAgICAgVFsxXSA9IE1bM107CiAgICAgIFRbM10gPSB0bXA7CiAgICAgIHRtcCA9IE1bMl07CiAgICAgIFRbMl0gPSBNWzZdOwogICAgICBUWzZdID0gdG1wOwogICAgICB0bXAgPSBNWzVdOwogICAgICBUWzVdID0gTVs3XTsKICAgICAgVFs3XSA9IHRtcDsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KCiAgfQogIGNvbnN0IHJldmVyc2VfZXFucyA9IFswLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwXTsKCiAgLyoqCiAgICogMy1kaW1lbnNpb25hbCB2ZWN0b3IKICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCB2ID0gbmV3IFZlYzMoMSwgMiwgMykKICAgKiAgICAgY29uc29sZS5sb2coJ3g9JyArIHYueCkgLy8geD0xCiAgICovCgogIGNsYXNzIFZlYzMgewogICAgY29uc3RydWN0b3IoeCwgeSwgeikgewogICAgICBpZiAoeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgeCA9IDAuMDsKICAgICAgfQoKICAgICAgaWYgKHkgPT09IHZvaWQgMCkgewogICAgICAgIHkgPSAwLjA7CiAgICAgIH0KCiAgICAgIGlmICh6ID09PSB2b2lkIDApIHsKICAgICAgICB6ID0gMC4wOwogICAgICB9CgogICAgICB0aGlzLnggPSB4OwogICAgICB0aGlzLnkgPSB5OwogICAgICB0aGlzLnogPSB6OwogICAgfQogICAgLyoqCiAgICAgKiBWZWN0b3IgY3Jvc3MgcHJvZHVjdAogICAgICogQHBhcmFtIHRhcmdldCBPcHRpb25hbCB0YXJnZXQgdG8gc2F2ZSBpbi4KICAgICAqLwoKCiAgICBjcm9zcyh2ZWN0b3IsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCB2eCA9IHZlY3Rvci54OwogICAgICBjb25zdCB2eSA9IHZlY3Rvci55OwogICAgICBjb25zdCB2eiA9IHZlY3Rvci56OwogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICB0YXJnZXQueCA9IHkgKiB2eiAtIHogKiB2eTsKICAgICAgdGFyZ2V0LnkgPSB6ICogdnggLSB4ICogdno7CiAgICAgIHRhcmdldC56ID0geCAqIHZ5IC0geSAqIHZ4OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHZlY3RvcnMnIDMgZWxlbWVudHMKICAgICAqLwoKCiAgICBzZXQoeCwgeSwgeikgewogICAgICB0aGlzLnggPSB4OwogICAgICB0aGlzLnkgPSB5OwogICAgICB0aGlzLnogPSB6OwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogU2V0IGFsbCBjb21wb25lbnRzIG9mIHRoZSB2ZWN0b3IgdG8gemVyby4KICAgICAqLwoKCiAgICBzZXRaZXJvKCkgewogICAgICB0aGlzLnggPSB0aGlzLnkgPSB0aGlzLnogPSAwOwogICAgfQogICAgLyoqCiAgICAgKiBWZWN0b3IgYWRkaXRpb24KICAgICAqLwoKCiAgICB2YWRkKHZlY3RvciwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICB0YXJnZXQueCA9IHZlY3Rvci54ICsgdGhpcy54OwogICAgICAgIHRhcmdldC55ID0gdmVjdG9yLnkgKyB0aGlzLnk7CiAgICAgICAgdGFyZ2V0LnogPSB2ZWN0b3IueiArIHRoaXMuejsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IFZlYzModGhpcy54ICsgdmVjdG9yLngsIHRoaXMueSArIHZlY3Rvci55LCB0aGlzLnogKyB2ZWN0b3Iueik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogVmVjdG9yIHN1YnRyYWN0aW9uCiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsIHRhcmdldCB0byBzYXZlIGluLgogICAgICovCgoKICAgIHZzdWIodmVjdG9yLCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCkgewogICAgICAgIHRhcmdldC54ID0gdGhpcy54IC0gdmVjdG9yLng7CiAgICAgICAgdGFyZ2V0LnkgPSB0aGlzLnkgLSB2ZWN0b3IueTsKICAgICAgICB0YXJnZXQueiA9IHRoaXMueiAtIHZlY3Rvci56OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgVmVjMyh0aGlzLnggLSB2ZWN0b3IueCwgdGhpcy55IC0gdmVjdG9yLnksIHRoaXMueiAtIHZlY3Rvci56KTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIGNyb3NzIHByb2R1Y3QgbWF0cml4IGFfY3Jvc3MgZnJvbSBhIHZlY3Rvciwgc3VjaCB0aGF0IGEgeCBiID0gYV9jcm9zcyAqIGIgPSBjCiAgICAgKgogICAgICogU2VlIHtAbGluayBodHRwczovL3d3dzguY3MudW11LnNlL2t1cnNlci9UREJEMjQvVlQwNi9sZWN0dXJlcy9MZWN0dXJlNi5wZGYgVW1lw6UgVW5pdmVyc2l0eSBMZWN0dXJlfQogICAgICovCgoKICAgIGNyb3NzbWF0KCkgewogICAgICByZXR1cm4gbmV3IE1hdDMoWzAsIC10aGlzLnosIHRoaXMueSwgdGhpcy56LCAwLCAtdGhpcy54LCAtdGhpcy55LCB0aGlzLngsIDBdKTsKICAgIH0KICAgIC8qKgogICAgICogTm9ybWFsaXplIHRoZSB2ZWN0b3IuIE5vdGUgdGhhdCB0aGlzIGNoYW5nZXMgdGhlIHZhbHVlcyBpbiB0aGUgdmVjdG9yLgogICAgICAqIEByZXR1cm4gUmV0dXJucyB0aGUgbm9ybSBvZiB0aGUgdmVjdG9yCiAgICAgKi8KCgogICAgbm9ybWFsaXplKCkgewogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICBjb25zdCBuID0gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CgogICAgICBpZiAobiA+IDAuMCkgewogICAgICAgIGNvbnN0IGludk4gPSAxIC8gbjsKICAgICAgICB0aGlzLnggKj0gaW52TjsKICAgICAgICB0aGlzLnkgKj0gaW52TjsKICAgICAgICB0aGlzLnogKj0gaW52TjsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBNYWtlIHNvbWV0aGluZyB1cAogICAgICAgIHRoaXMueCA9IDA7CiAgICAgICAgdGhpcy55ID0gMDsKICAgICAgICB0aGlzLnogPSAwOwogICAgICB9CgogICAgICByZXR1cm4gbjsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSB2ZXJzaW9uIG9mIHRoaXMgdmVjdG9yIHRoYXQgaXMgb2YgbGVuZ3RoIDEuCiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsIHRhcmdldCB0byBzYXZlIGluCiAgICAgKiBAcmV0dXJuIFJldHVybnMgdGhlIHVuaXQgdmVjdG9yCiAgICAgKi8KCgogICAgdW5pdCh0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgY29uc3QgeCA9IHRoaXMueDsKICAgICAgY29uc3QgeSA9IHRoaXMueTsKICAgICAgY29uc3QgeiA9IHRoaXMuejsKICAgICAgbGV0IG5pbnYgPSBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSArIHogKiB6KTsKCiAgICAgIGlmIChuaW52ID4gMC4wKSB7CiAgICAgICAgbmludiA9IDEuMCAvIG5pbnY7CiAgICAgICAgdGFyZ2V0LnggPSB4ICogbmludjsKICAgICAgICB0YXJnZXQueSA9IHkgKiBuaW52OwogICAgICAgIHRhcmdldC56ID0geiAqIG5pbnY7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0LnggPSAxOwogICAgICAgIHRhcmdldC55ID0gMDsKICAgICAgICB0YXJnZXQueiA9IDA7CiAgICAgIH0KCiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgbGVuZ3RoIG9mIHRoZSB2ZWN0b3IKICAgICAqLwoKCiAgICBsZW5ndGgoKSB7CiAgICAgIGNvbnN0IHggPSB0aGlzLng7CiAgICAgIGNvbnN0IHkgPSB0aGlzLnk7CiAgICAgIGNvbnN0IHogPSB0aGlzLno7CiAgICAgIHJldHVybiBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSArIHogKiB6KTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBzcXVhcmVkIGxlbmd0aCBvZiB0aGUgdmVjdG9yLgogICAgICovCgoKICAgIGxlbmd0aFNxdWFyZWQoKSB7CiAgICAgIHJldHVybiB0aGlzLmRvdCh0aGlzKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGRpc3RhbmNlIGZyb20gdGhpcyBwb2ludCB0byBhbm90aGVyIHBvaW50CiAgICAgKi8KCgogICAgZGlzdGFuY2VUbyhwKSB7CiAgICAgIGNvbnN0IHggPSB0aGlzLng7CiAgICAgIGNvbnN0IHkgPSB0aGlzLnk7CiAgICAgIGNvbnN0IHogPSB0aGlzLno7CiAgICAgIGNvbnN0IHB4ID0gcC54OwogICAgICBjb25zdCBweSA9IHAueTsKICAgICAgY29uc3QgcHogPSBwLno7CiAgICAgIHJldHVybiBNYXRoLnNxcnQoKHB4IC0geCkgKiAocHggLSB4KSArIChweSAtIHkpICogKHB5IC0geSkgKyAocHogLSB6KSAqIChweiAtIHopKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHNxdWFyZWQgZGlzdGFuY2UgZnJvbSB0aGlzIHBvaW50IHRvIGFub3RoZXIgcG9pbnQKICAgICAqLwoKCiAgICBkaXN0YW5jZVNxdWFyZWQocCkgewogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICBjb25zdCBweCA9IHAueDsKICAgICAgY29uc3QgcHkgPSBwLnk7CiAgICAgIGNvbnN0IHB6ID0gcC56OwogICAgICByZXR1cm4gKHB4IC0geCkgKiAocHggLSB4KSArIChweSAtIHkpICogKHB5IC0geSkgKyAocHogLSB6KSAqIChweiAtIHopOwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSBhbGwgdGhlIGNvbXBvbmVudHMgb2YgdGhlIHZlY3RvciB3aXRoIGEgc2NhbGFyLgogICAgICogQHBhcmFtIHRhcmdldCBUaGUgdmVjdG9yIHRvIHNhdmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBzY2FsZShzY2FsYXIsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICB0YXJnZXQueCA9IHNjYWxhciAqIHg7CiAgICAgIHRhcmdldC55ID0gc2NhbGFyICogeTsKICAgICAgdGFyZ2V0LnogPSBzY2FsYXIgKiB6OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSB0aGUgdmVjdG9yIHdpdGggYW4gb3RoZXIgdmVjdG9yLCBjb21wb25lbnQtd2lzZS4KICAgICAqIEBwYXJhbSB0YXJnZXQgVGhlIHZlY3RvciB0byBzYXZlIHRoZSByZXN1bHQgaW4uCiAgICAgKi8KCgogICAgdm11bCh2ZWN0b3IsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0YXJnZXQueCA9IHZlY3Rvci54ICogdGhpcy54OwogICAgICB0YXJnZXQueSA9IHZlY3Rvci55ICogdGhpcy55OwogICAgICB0YXJnZXQueiA9IHZlY3Rvci56ICogdGhpcy56OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBTY2FsZSBhIHZlY3RvciBhbmQgYWRkIGl0IHRvIHRoaXMgdmVjdG9yLiBTYXZlIHRoZSByZXN1bHQgaW4gInRhcmdldCIuICh0YXJnZXQgPSB0aGlzICsgdmVjdG9yICogc2NhbGFyKQogICAgICogQHBhcmFtIHRhcmdldCBUaGUgdmVjdG9yIHRvIHNhdmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBhZGRTY2FsZWRWZWN0b3Ioc2NhbGFyLCB2ZWN0b3IsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0YXJnZXQueCA9IHRoaXMueCArIHNjYWxhciAqIHZlY3Rvci54OwogICAgICB0YXJnZXQueSA9IHRoaXMueSArIHNjYWxhciAqIHZlY3Rvci55OwogICAgICB0YXJnZXQueiA9IHRoaXMueiArIHNjYWxhciAqIHZlY3Rvci56OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBDYWxjdWxhdGUgZG90IHByb2R1Y3QKICAgICAqIEBwYXJhbSB2ZWN0b3IKICAgICAqLwoKCiAgICBkb3QodmVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLnggKiB2ZWN0b3IueCArIHRoaXMueSAqIHZlY3Rvci55ICsgdGhpcy56ICogdmVjdG9yLno7CiAgICB9CgogICAgaXNaZXJvKCkgewogICAgICByZXR1cm4gdGhpcy54ID09PSAwICYmIHRoaXMueSA9PT0gMCAmJiB0aGlzLnogPT09IDA7CiAgICB9CiAgICAvKioKICAgICAqIE1ha2UgdGhlIHZlY3RvciBwb2ludCBpbiB0aGUgb3Bwb3NpdGUgZGlyZWN0aW9uLgogICAgICogQHBhcmFtIHRhcmdldCBPcHRpb25hbCB0YXJnZXQgdG8gc2F2ZSBpbgogICAgICovCgoKICAgIG5lZ2F0ZSh0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgdGFyZ2V0LnggPSAtdGhpcy54OwogICAgICB0YXJnZXQueSA9IC10aGlzLnk7CiAgICAgIHRhcmdldC56ID0gLXRoaXMuejsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZSB0d28gYXJ0aWZpY2lhbCB0YW5nZW50cyB0byB0aGUgdmVjdG9yCiAgICAgKiBAcGFyYW0gdDEgVmVjdG9yIG9iamVjdCB0byBzYXZlIHRoZSBmaXJzdCB0YW5nZW50IGluCiAgICAgKiBAcGFyYW0gdDIgVmVjdG9yIG9iamVjdCB0byBzYXZlIHRoZSBzZWNvbmQgdGFuZ2VudCBpbgogICAgICovCgoKICAgIHRhbmdlbnRzKHQxLCB0MikgewogICAgICBjb25zdCBub3JtID0gdGhpcy5sZW5ndGgoKTsKCiAgICAgIGlmIChub3JtID4gMC4wKSB7CiAgICAgICAgY29uc3QgbiA9IFZlYzNfdGFuZ2VudHNfbjsKICAgICAgICBjb25zdCBpbm9ybSA9IDEgLyBub3JtOwogICAgICAgIG4uc2V0KHRoaXMueCAqIGlub3JtLCB0aGlzLnkgKiBpbm9ybSwgdGhpcy56ICogaW5vcm0pOwogICAgICAgIGNvbnN0IHJhbmRWZWMgPSBWZWMzX3RhbmdlbnRzX3JhbmRWZWM7CgogICAgICAgIGlmIChNYXRoLmFicyhuLngpIDwgMC45KSB7CiAgICAgICAgICByYW5kVmVjLnNldCgxLCAwLCAwKTsKICAgICAgICAgIG4uY3Jvc3MocmFuZFZlYywgdDEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByYW5kVmVjLnNldCgwLCAxLCAwKTsKICAgICAgICAgIG4uY3Jvc3MocmFuZFZlYywgdDEpOwogICAgICAgIH0KCiAgICAgICAgbi5jcm9zcyh0MSwgdDIpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFRoZSBub3JtYWwgbGVuZ3RoIGlzIHplcm8sIG1ha2Ugc29tZXRoaW5nIHVwCiAgICAgICAgdDEuc2V0KDEsIDAsIDApOwogICAgICAgIHQyLnNldCgwLCAxLCAwKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0byBhIG1vcmUgcmVhZGFibGUgZm9ybWF0CiAgICAgKi8KCgogICAgdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiBgJHt0aGlzLnh9LCR7dGhpcy55fSwke3RoaXMuen1gOwogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0byBhbiBhcnJheQogICAgICovCgoKICAgIHRvQXJyYXkoKSB7CiAgICAgIHJldHVybiBbdGhpcy54LCB0aGlzLnksIHRoaXMuel07CiAgICB9CiAgICAvKioKICAgICAqIENvcGllcyB2YWx1ZSBvZiBzb3VyY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICAgKi8KCgogICAgY29weSh2ZWN0b3IpIHsKICAgICAgdGhpcy54ID0gdmVjdG9yLng7CiAgICAgIHRoaXMueSA9IHZlY3Rvci55OwogICAgICB0aGlzLnogPSB2ZWN0b3IuejsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIERvIGEgbGluZWFyIGludGVycG9sYXRpb24gYmV0d2VlbiB0d28gdmVjdG9ycwogICAgICogQHBhcmFtIHQgQSBudW1iZXIgYmV0d2VlbiAwIGFuZCAxLiAwIHdpbGwgbWFrZSB0aGlzIGZ1bmN0aW9uIHJldHVybiB1LCBhbmQgMSB3aWxsIG1ha2UgaXQgcmV0dXJuIHYuIE51bWJlcnMgaW4gYmV0d2VlbiB3aWxsIGdlbmVyYXRlIGEgdmVjdG9yIGluIGJldHdlZW4gdGhlbS4KICAgICAqLwoKCiAgICBsZXJwKHZlY3RvciwgdCwgdGFyZ2V0KSB7CiAgICAgIGNvbnN0IHggPSB0aGlzLng7CiAgICAgIGNvbnN0IHkgPSB0aGlzLnk7CiAgICAgIGNvbnN0IHogPSB0aGlzLno7CiAgICAgIHRhcmdldC54ID0geCArICh2ZWN0b3IueCAtIHgpICogdDsKICAgICAgdGFyZ2V0LnkgPSB5ICsgKHZlY3Rvci55IC0geSkgKiB0OwogICAgICB0YXJnZXQueiA9IHogKyAodmVjdG9yLnogLSB6KSAqIHQ7CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrIGlmIGEgdmVjdG9yIGVxdWFscyBpcyBhbG1vc3QgZXF1YWwgdG8gYW5vdGhlciBvbmUuCiAgICAgKi8KCgogICAgYWxtb3N0RXF1YWxzKHZlY3RvciwgcHJlY2lzaW9uKSB7CiAgICAgIGlmIChwcmVjaXNpb24gPT09IHZvaWQgMCkgewogICAgICAgIHByZWNpc2lvbiA9IDFlLTY7CiAgICAgIH0KCiAgICAgIGlmIChNYXRoLmFicyh0aGlzLnggLSB2ZWN0b3IueCkgPiBwcmVjaXNpb24gfHwgTWF0aC5hYnModGhpcy55IC0gdmVjdG9yLnkpID4gcHJlY2lzaW9uIHx8IE1hdGguYWJzKHRoaXMueiAtIHZlY3Rvci56KSA+IHByZWNpc2lvbikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrIGlmIGEgdmVjdG9yIGlzIGFsbW9zdCB6ZXJvCiAgICAgKi8KCgogICAgYWxtb3N0WmVybyhwcmVjaXNpb24pIHsKICAgICAgaWYgKHByZWNpc2lvbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgcHJlY2lzaW9uID0gMWUtNjsKICAgICAgfQoKICAgICAgaWYgKE1hdGguYWJzKHRoaXMueCkgPiBwcmVjaXNpb24gfHwgTWF0aC5hYnModGhpcy55KSA+IHByZWNpc2lvbiB8fCBNYXRoLmFicyh0aGlzLnopID4gcHJlY2lzaW9uKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIHZlY3RvciBpcyBhbnRpLXBhcmFsbGVsIHRvIGFub3RoZXIgdmVjdG9yLgogICAgICogQHBhcmFtIHByZWNpc2lvbiBTZXQgdG8gemVybyBmb3IgZXhhY3QgY29tcGFyaXNvbnMKICAgICAqLwoKCiAgICBpc0FudGlwYXJhbGxlbFRvKHZlY3RvciwgcHJlY2lzaW9uKSB7CiAgICAgIHRoaXMubmVnYXRlKGFudGlwX25lZyk7CiAgICAgIHJldHVybiBhbnRpcF9uZWcuYWxtb3N0RXF1YWxzKHZlY3RvciwgcHJlY2lzaW9uKTsKICAgIH0KICAgIC8qKgogICAgICogQ2xvbmUgdGhlIHZlY3RvcgogICAgICovCgoKICAgIGNsb25lKCkgewogICAgICByZXR1cm4gbmV3IFZlYzModGhpcy54LCB0aGlzLnksIHRoaXMueik7CiAgICB9CgogIH0KICBWZWMzLlpFUk8gPSBuZXcgVmVjMygwLCAwLCAwKTsKICBWZWMzLlVOSVRfWCA9IG5ldyBWZWMzKDEsIDAsIDApOwogIFZlYzMuVU5JVF9ZID0gbmV3IFZlYzMoMCwgMSwgMCk7CiAgVmVjMy5VTklUX1ogPSBuZXcgVmVjMygwLCAwLCAxKTsKICBjb25zdCBWZWMzX3RhbmdlbnRzX24gPSBuZXcgVmVjMygpOwogIGNvbnN0IFZlYzNfdGFuZ2VudHNfcmFuZFZlYyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYW50aXBfbmVnID0gbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogQXhpcyBhbGlnbmVkIGJvdW5kaW5nIGJveCBjbGFzcy4KICAgKi8KICBjbGFzcyBBQUJCIHsKICAgIC8qKgogICAgICogVGhlIGxvd2VyIGJvdW5kIG9mIHRoZSBib3VuZGluZyBib3gKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIHVwcGVyIGJvdW5kIG9mIHRoZSBib3VuZGluZyBib3gKICAgICAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLmxvd2VyQm91bmQgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnVwcGVyQm91bmQgPSBuZXcgVmVjMygpOwoKICAgICAgaWYgKG9wdGlvbnMubG93ZXJCb3VuZCkgewogICAgICAgIHRoaXMubG93ZXJCb3VuZC5jb3B5KG9wdGlvbnMubG93ZXJCb3VuZCk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnVwcGVyQm91bmQpIHsKICAgICAgICB0aGlzLnVwcGVyQm91bmQuY29weShvcHRpb25zLnVwcGVyQm91bmQpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgQUFCQiBib3VuZHMgZnJvbSBhIHNldCBvZiBwb2ludHMuCiAgICAgKiBAcGFyYW0gcG9pbnRzIEFuIGFycmF5IG9mIFZlYzMncy4KICAgICAqIEByZXR1cm4gVGhlIHNlbGYgb2JqZWN0CiAgICAgKi8KCgogICAgc2V0RnJvbVBvaW50cyhwb2ludHMsIHBvc2l0aW9uLCBxdWF0ZXJuaW9uLCBza2luU2l6ZSkgewogICAgICBjb25zdCBsID0gdGhpcy5sb3dlckJvdW5kOwogICAgICBjb25zdCB1ID0gdGhpcy51cHBlckJvdW5kOwogICAgICBjb25zdCBxID0gcXVhdGVybmlvbjsgLy8gU2V0IHRvIHRoZSBmaXJzdCBwb2ludAoKICAgICAgbC5jb3B5KHBvaW50c1swXSk7CgogICAgICBpZiAocSkgewogICAgICAgIHEudm11bHQobCwgbCk7CiAgICAgIH0KCiAgICAgIHUuY29weShsKTsKCiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgcG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGV0IHAgPSBwb2ludHNbaV07CgogICAgICAgIGlmIChxKSB7CiAgICAgICAgICBxLnZtdWx0KHAsIHRtcCQxKTsKICAgICAgICAgIHAgPSB0bXAkMTsKICAgICAgICB9CgogICAgICAgIGlmIChwLnggPiB1LngpIHsKICAgICAgICAgIHUueCA9IHAueDsKICAgICAgICB9CgogICAgICAgIGlmIChwLnggPCBsLngpIHsKICAgICAgICAgIGwueCA9IHAueDsKICAgICAgICB9CgogICAgICAgIGlmIChwLnkgPiB1LnkpIHsKICAgICAgICAgIHUueSA9IHAueTsKICAgICAgICB9CgogICAgICAgIGlmIChwLnkgPCBsLnkpIHsKICAgICAgICAgIGwueSA9IHAueTsKICAgICAgICB9CgogICAgICAgIGlmIChwLnogPiB1LnopIHsKICAgICAgICAgIHUueiA9IHAuejsKICAgICAgICB9CgogICAgICAgIGlmIChwLnogPCBsLnopIHsKICAgICAgICAgIGwueiA9IHAuejsKICAgICAgICB9CiAgICAgIH0gLy8gQWRkIG9mZnNldAoKCiAgICAgIGlmIChwb3NpdGlvbikgewogICAgICAgIHBvc2l0aW9uLnZhZGQobCwgbCk7CiAgICAgICAgcG9zaXRpb24udmFkZCh1LCB1KTsKICAgICAgfQoKICAgICAgaWYgKHNraW5TaXplKSB7CiAgICAgICAgbC54IC09IHNraW5TaXplOwogICAgICAgIGwueSAtPSBza2luU2l6ZTsKICAgICAgICBsLnogLT0gc2tpblNpemU7CiAgICAgICAgdS54ICs9IHNraW5TaXplOwogICAgICAgIHUueSArPSBza2luU2l6ZTsKICAgICAgICB1LnogKz0gc2tpblNpemU7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBDb3B5IGJvdW5kcyBmcm9tIGFuIEFBQkIgdG8gdGhpcyBBQUJCCiAgICAgKiBAcGFyYW0gYWFiYiBTb3VyY2UgdG8gY29weSBmcm9tCiAgICAgKiBAcmV0dXJuIFRoZSB0aGlzIG9iamVjdCwgZm9yIGNoYWluYWJpbGl0eQogICAgICovCgoKICAgIGNvcHkoYWFiYikgewogICAgICB0aGlzLmxvd2VyQm91bmQuY29weShhYWJiLmxvd2VyQm91bmQpOwogICAgICB0aGlzLnVwcGVyQm91bmQuY29weShhYWJiLnVwcGVyQm91bmQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogQ2xvbmUgYW4gQUFCQgogICAgICovCgoKICAgIGNsb25lKCkgewogICAgICByZXR1cm4gbmV3IEFBQkIoKS5jb3B5KHRoaXMpOwogICAgfQogICAgLyoqCiAgICAgKiBFeHRlbmQgdGhpcyBBQUJCIHNvIHRoYXQgaXQgY292ZXJzIHRoZSBnaXZlbiBBQUJCIHRvby4KICAgICAqLwoKCiAgICBleHRlbmQoYWFiYikgewogICAgICB0aGlzLmxvd2VyQm91bmQueCA9IE1hdGgubWluKHRoaXMubG93ZXJCb3VuZC54LCBhYWJiLmxvd2VyQm91bmQueCk7CiAgICAgIHRoaXMudXBwZXJCb3VuZC54ID0gTWF0aC5tYXgodGhpcy51cHBlckJvdW5kLngsIGFhYmIudXBwZXJCb3VuZC54KTsKICAgICAgdGhpcy5sb3dlckJvdW5kLnkgPSBNYXRoLm1pbih0aGlzLmxvd2VyQm91bmQueSwgYWFiYi5sb3dlckJvdW5kLnkpOwogICAgICB0aGlzLnVwcGVyQm91bmQueSA9IE1hdGgubWF4KHRoaXMudXBwZXJCb3VuZC55LCBhYWJiLnVwcGVyQm91bmQueSk7CiAgICAgIHRoaXMubG93ZXJCb3VuZC56ID0gTWF0aC5taW4odGhpcy5sb3dlckJvdW5kLnosIGFhYmIubG93ZXJCb3VuZC56KTsKICAgICAgdGhpcy51cHBlckJvdW5kLnogPSBNYXRoLm1heCh0aGlzLnVwcGVyQm91bmQueiwgYWFiYi51cHBlckJvdW5kLnopOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGdpdmVuIEFBQkIgb3ZlcmxhcHMgdGhpcyBBQUJCLgogICAgICovCgoKICAgIG92ZXJsYXBzKGFhYmIpIHsKICAgICAgY29uc3QgbDEgPSB0aGlzLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUxID0gdGhpcy51cHBlckJvdW5kOwogICAgICBjb25zdCBsMiA9IGFhYmIubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdTIgPSBhYWJiLnVwcGVyQm91bmQ7IC8vICAgICAgbDIgICAgICAgIHUyCiAgICAgIC8vICAgICAgfC0tLS0tLS0tLXwKICAgICAgLy8gfC0tLS0tLS0tfAogICAgICAvLyBsMSAgICAgICB1MQoKICAgICAgY29uc3Qgb3ZlcmxhcHNYID0gbDIueCA8PSB1MS54ICYmIHUxLnggPD0gdTIueCB8fCBsMS54IDw9IHUyLnggJiYgdTIueCA8PSB1MS54OwogICAgICBjb25zdCBvdmVybGFwc1kgPSBsMi55IDw9IHUxLnkgJiYgdTEueSA8PSB1Mi55IHx8IGwxLnkgPD0gdTIueSAmJiB1Mi55IDw9IHUxLnk7CiAgICAgIGNvbnN0IG92ZXJsYXBzWiA9IGwyLnogPD0gdTEueiAmJiB1MS56IDw9IHUyLnogfHwgbDEueiA8PSB1Mi56ICYmIHUyLnogPD0gdTEuejsKICAgICAgcmV0dXJuIG92ZXJsYXBzWCAmJiBvdmVybGFwc1kgJiYgb3ZlcmxhcHNaOwogICAgfSAvLyBNb3N0bHkgZm9yIGRlYnVnZ2luZwoKCiAgICB2b2x1bWUoKSB7CiAgICAgIGNvbnN0IGwgPSB0aGlzLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUgPSB0aGlzLnVwcGVyQm91bmQ7CiAgICAgIHJldHVybiAodS54IC0gbC54KSAqICh1LnkgLSBsLnkpICogKHUueiAtIGwueik7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgZ2l2ZW4gQUFCQiBpcyBmdWxseSBjb250YWluZWQgaW4gdGhpcyBBQUJCLgogICAgICovCgoKICAgIGNvbnRhaW5zKGFhYmIpIHsKICAgICAgY29uc3QgbDEgPSB0aGlzLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUxID0gdGhpcy51cHBlckJvdW5kOwogICAgICBjb25zdCBsMiA9IGFhYmIubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdTIgPSBhYWJiLnVwcGVyQm91bmQ7IC8vICAgICAgbDIgICAgICAgIHUyCiAgICAgIC8vICAgICAgfC0tLS0tLS0tLXwKICAgICAgLy8gfC0tLS0tLS0tLS0tLS0tLXwKICAgICAgLy8gbDEgICAgICAgICAgICAgIHUxCgogICAgICByZXR1cm4gbDEueCA8PSBsMi54ICYmIHUxLnggPj0gdTIueCAmJiBsMS55IDw9IGwyLnkgJiYgdTEueSA+PSB1Mi55ICYmIGwxLnogPD0gbDIueiAmJiB1MS56ID49IHUyLno7CiAgICB9CgogICAgZ2V0Q29ybmVycyhhLCBiLCBjLCBkLCBlLCBmLCBnLCBoKSB7CiAgICAgIGNvbnN0IGwgPSB0aGlzLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUgPSB0aGlzLnVwcGVyQm91bmQ7CiAgICAgIGEuY29weShsKTsKICAgICAgYi5zZXQodS54LCBsLnksIGwueik7CiAgICAgIGMuc2V0KHUueCwgdS55LCBsLnopOwogICAgICBkLnNldChsLngsIHUueSwgdS56KTsKICAgICAgZS5zZXQodS54LCBsLnksIHUueik7CiAgICAgIGYuc2V0KGwueCwgdS55LCBsLnopOwogICAgICBnLnNldChsLngsIGwueSwgdS56KTsKICAgICAgaC5jb3B5KHUpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHJlcHJlc2VudGF0aW9uIG9mIGFuIEFBQkIgaW4gYW5vdGhlciBmcmFtZS4KICAgICAqIEByZXR1cm4gVGhlICJ0YXJnZXQiIEFBQkIgb2JqZWN0LgogICAgICovCgoKICAgIHRvTG9jYWxGcmFtZShmcmFtZSwgdGFyZ2V0KSB7CiAgICAgIGNvbnN0IGNvcm5lcnMgPSB0cmFuc2Zvcm1JbnRvRnJhbWVfY29ybmVyczsKICAgICAgY29uc3QgYSA9IGNvcm5lcnNbMF07CiAgICAgIGNvbnN0IGIgPSBjb3JuZXJzWzFdOwogICAgICBjb25zdCBjID0gY29ybmVyc1syXTsKICAgICAgY29uc3QgZCA9IGNvcm5lcnNbM107CiAgICAgIGNvbnN0IGUgPSBjb3JuZXJzWzRdOwogICAgICBjb25zdCBmID0gY29ybmVyc1s1XTsKICAgICAgY29uc3QgZyA9IGNvcm5lcnNbNl07CiAgICAgIGNvbnN0IGggPSBjb3JuZXJzWzddOyAvLyBHZXQgY29ybmVycyBpbiBjdXJyZW50IGZyYW1lCgogICAgICB0aGlzLmdldENvcm5lcnMoYSwgYiwgYywgZCwgZSwgZiwgZywgaCk7IC8vIFRyYW5zZm9ybSB0aGVtIHRvIG5ldyBsb2NhbCBmcmFtZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IDg7IGkrKykgewogICAgICAgIGNvbnN0IGNvcm5lciA9IGNvcm5lcnNbaV07CiAgICAgICAgZnJhbWUucG9pbnRUb0xvY2FsKGNvcm5lciwgY29ybmVyKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRhcmdldC5zZXRGcm9tUG9pbnRzKGNvcm5lcnMpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHJlcHJlc2VudGF0aW9uIG9mIGFuIEFBQkIgaW4gdGhlIGdsb2JhbCBmcmFtZS4KICAgICAqIEByZXR1cm4gVGhlICJ0YXJnZXQiIEFBQkIgb2JqZWN0LgogICAgICovCgoKICAgIHRvV29ybGRGcmFtZShmcmFtZSwgdGFyZ2V0KSB7CiAgICAgIGNvbnN0IGNvcm5lcnMgPSB0cmFuc2Zvcm1JbnRvRnJhbWVfY29ybmVyczsKICAgICAgY29uc3QgYSA9IGNvcm5lcnNbMF07CiAgICAgIGNvbnN0IGIgPSBjb3JuZXJzWzFdOwogICAgICBjb25zdCBjID0gY29ybmVyc1syXTsKICAgICAgY29uc3QgZCA9IGNvcm5lcnNbM107CiAgICAgIGNvbnN0IGUgPSBjb3JuZXJzWzRdOwogICAgICBjb25zdCBmID0gY29ybmVyc1s1XTsKICAgICAgY29uc3QgZyA9IGNvcm5lcnNbNl07CiAgICAgIGNvbnN0IGggPSBjb3JuZXJzWzddOyAvLyBHZXQgY29ybmVycyBpbiBjdXJyZW50IGZyYW1lCgogICAgICB0aGlzLmdldENvcm5lcnMoYSwgYiwgYywgZCwgZSwgZiwgZywgaCk7IC8vIFRyYW5zZm9ybSB0aGVtIHRvIG5ldyBsb2NhbCBmcmFtZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IDg7IGkrKykgewogICAgICAgIGNvbnN0IGNvcm5lciA9IGNvcm5lcnNbaV07CiAgICAgICAgZnJhbWUucG9pbnRUb1dvcmxkKGNvcm5lciwgY29ybmVyKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRhcmdldC5zZXRGcm9tUG9pbnRzKGNvcm5lcnMpOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgQUFCQiBpcyBoaXQgYnkgYSByYXkuCiAgICAgKi8KCgogICAgb3ZlcmxhcHNSYXkocmF5KSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBkaXJlY3Rpb24sCiAgICAgICAgZnJvbQogICAgICB9ID0gcmF5OyAvLyBjb25zdCB0ID0gMAogICAgICAvLyByYXkuZGlyZWN0aW9uIGlzIHVuaXQgZGlyZWN0aW9uIHZlY3RvciBvZiByYXkKCiAgICAgIGNvbnN0IGRpckZyYWNYID0gMSAvIGRpcmVjdGlvbi54OwogICAgICBjb25zdCBkaXJGcmFjWSA9IDEgLyBkaXJlY3Rpb24ueTsKICAgICAgY29uc3QgZGlyRnJhY1ogPSAxIC8gZGlyZWN0aW9uLno7IC8vIHRoaXMubG93ZXJCb3VuZCBpcyB0aGUgY29ybmVyIG9mIEFBQkIgd2l0aCBtaW5pbWFsIGNvb3JkaW5hdGVzIC0gbGVmdCBib3R0b20sIHJ0IGlzIG1heGltYWwgY29ybmVyCgogICAgICBjb25zdCB0MSA9ICh0aGlzLmxvd2VyQm91bmQueCAtIGZyb20ueCkgKiBkaXJGcmFjWDsKICAgICAgY29uc3QgdDIgPSAodGhpcy51cHBlckJvdW5kLnggLSBmcm9tLngpICogZGlyRnJhY1g7CiAgICAgIGNvbnN0IHQzID0gKHRoaXMubG93ZXJCb3VuZC55IC0gZnJvbS55KSAqIGRpckZyYWNZOwogICAgICBjb25zdCB0NCA9ICh0aGlzLnVwcGVyQm91bmQueSAtIGZyb20ueSkgKiBkaXJGcmFjWTsKICAgICAgY29uc3QgdDUgPSAodGhpcy5sb3dlckJvdW5kLnogLSBmcm9tLnopICogZGlyRnJhY1o7CiAgICAgIGNvbnN0IHQ2ID0gKHRoaXMudXBwZXJCb3VuZC56IC0gZnJvbS56KSAqIGRpckZyYWNaOyAvLyBjb25zdCB0bWluID0gTWF0aC5tYXgoTWF0aC5tYXgoTWF0aC5taW4odDEsIHQyKSwgTWF0aC5taW4odDMsIHQ0KSkpOwogICAgICAvLyBjb25zdCB0bWF4ID0gTWF0aC5taW4oTWF0aC5taW4oTWF0aC5tYXgodDEsIHQyKSwgTWF0aC5tYXgodDMsIHQ0KSkpOwoKICAgICAgY29uc3QgdG1pbiA9IE1hdGgubWF4KE1hdGgubWF4KE1hdGgubWluKHQxLCB0MiksIE1hdGgubWluKHQzLCB0NCkpLCBNYXRoLm1pbih0NSwgdDYpKTsKICAgICAgY29uc3QgdG1heCA9IE1hdGgubWluKE1hdGgubWluKE1hdGgubWF4KHQxLCB0MiksIE1hdGgubWF4KHQzLCB0NCkpLCBNYXRoLm1heCh0NSwgdDYpKTsgLy8gaWYgdG1heCA8IDAsIHJheSAobGluZSkgaXMgaW50ZXJzZWN0aW5nIEFBQkIsIGJ1dCB3aG9sZSBBQUJCIGlzIGJlaGluZyB1cwoKICAgICAgaWYgKHRtYXggPCAwKSB7CiAgICAgICAgLy90ID0gdG1heDsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy8gaWYgdG1pbiA+IHRtYXgsIHJheSBkb2Vzbid0IGludGVyc2VjdCBBQUJCCgoKICAgICAgaWYgKHRtaW4gPiB0bWF4KSB7CiAgICAgICAgLy90ID0gdG1heDsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICB9CiAgY29uc3QgdG1wJDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRyYW5zZm9ybUludG9GcmFtZV9jb3JuZXJzID0gW25ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCldOwoKICAvKioKICAgKiBDb2xsaXNpb24gIm1hdHJpeCIuCiAgICogSXQncyBhY3R1YWxseSBhIHRyaWFuZ3VsYXItc2hhcGVkIGFycmF5IG9mIHdoZXRoZXIgdHdvIGJvZGllcyBhcmUgdG91Y2hpbmcgdGhpcyBzdGVwLCBmb3IgcmVmZXJlbmNlIG5leHQgc3RlcAogICAqLwogIGNsYXNzIEFycmF5Q29sbGlzaW9uTWF0cml4IHsKICAgIC8qKgogICAgICogVGhlIG1hdHJpeCBzdG9yYWdlLgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5tYXRyaXggPSBbXTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGFuIGVsZW1lbnQKICAgICAqLwoKCiAgICBnZXQoYmksIGJqKSB7CiAgICAgIGxldCB7CiAgICAgICAgaW5kZXg6IGkKICAgICAgfSA9IGJpOwogICAgICBsZXQgewogICAgICAgIGluZGV4OiBqCiAgICAgIH0gPSBiajsKCiAgICAgIGlmIChqID4gaSkgewogICAgICAgIGNvbnN0IHRlbXAgPSBqOwogICAgICAgIGogPSBpOwogICAgICAgIGkgPSB0ZW1wOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5tYXRyaXhbKGkgKiAoaSArIDEpID4+IDEpICsgaiAtIDFdOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgYW4gZWxlbWVudAogICAgICovCgoKICAgIHNldChiaSwgYmosIHZhbHVlKSB7CiAgICAgIGxldCB7CiAgICAgICAgaW5kZXg6IGkKICAgICAgfSA9IGJpOwogICAgICBsZXQgewogICAgICAgIGluZGV4OiBqCiAgICAgIH0gPSBiajsKCiAgICAgIGlmIChqID4gaSkgewogICAgICAgIGNvbnN0IHRlbXAgPSBqOwogICAgICAgIGogPSBpOwogICAgICAgIGkgPSB0ZW1wOwogICAgICB9CgogICAgICB0aGlzLm1hdHJpeFsoaSAqIChpICsgMSkgPj4gMSkgKyBqIC0gMV0gPSB2YWx1ZSA/IDEgOiAwOwogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIGFsbCBlbGVtZW50cyB0byB6ZXJvCiAgICAgKi8KCgogICAgcmVzZXQoKSB7CiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gdGhpcy5tYXRyaXgubGVuZ3RoOyBpICE9PSBsOyBpKyspIHsKICAgICAgICB0aGlzLm1hdHJpeFtpXSA9IDA7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogU2V0cyB0aGUgbWF4IG51bWJlciBvZiBvYmplY3RzCiAgICAgKi8KCgogICAgc2V0TnVtT2JqZWN0cyhuKSB7CiAgICAgIHRoaXMubWF0cml4Lmxlbmd0aCA9IG4gKiAobiAtIDEpID4+IDE7CiAgICB9CgogIH0KCiAgLyoqCiAgICogQmFzZSBjbGFzcyBmb3Igb2JqZWN0cyB0aGF0IGRpc3BhdGNoZXMgZXZlbnRzLgogICAqLwogIGNsYXNzIEV2ZW50VGFyZ2V0IHsKICAgIC8qKgogICAgICogQWRkIGFuIGV2ZW50IGxpc3RlbmVyCiAgICAgKiBAcmV0dXJuIFRoZSBzZWxmIG9iamVjdCwgZm9yIGNoYWluYWJpbGl0eS4KICAgICAqLwogICAgYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcikgewogICAgICBpZiAodGhpcy5fbGlzdGVuZXJzID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLl9saXN0ZW5lcnMgPSB7fTsKICAgICAgfQoKICAgICAgY29uc3QgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwoKICAgICAgaWYgKGxpc3RlbmVyc1t0eXBlXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgbGlzdGVuZXJzW3R5cGVdID0gW107CiAgICAgIH0KCiAgICAgIGlmICghbGlzdGVuZXJzW3R5cGVdLmluY2x1ZGVzKGxpc3RlbmVyKSkgewogICAgICAgIGxpc3RlbmVyc1t0eXBlXS5wdXNoKGxpc3RlbmVyKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrIGlmIGFuIGV2ZW50IGxpc3RlbmVyIGlzIGFkZGVkCiAgICAgKi8KCgogICAgaGFzRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcikgewogICAgICBpZiAodGhpcy5fbGlzdGVuZXJzID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGNvbnN0IGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKCiAgICAgIGlmIChsaXN0ZW5lcnNbdHlwZV0gIT09IHVuZGVmaW5lZCAmJiBsaXN0ZW5lcnNbdHlwZV0uaW5jbHVkZXMobGlzdGVuZXIpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgYW55IGV2ZW50IGxpc3RlbmVyIG9mIHRoZSBnaXZlbiB0eXBlIGlzIGFkZGVkCiAgICAgKi8KCgogICAgaGFzQW55RXZlbnRMaXN0ZW5lcih0eXBlKSB7CiAgICAgIGlmICh0aGlzLl9saXN0ZW5lcnMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgY29uc3QgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwogICAgICByZXR1cm4gbGlzdGVuZXJzW3R5cGVdICE9PSB1bmRlZmluZWQ7CiAgICB9CiAgICAvKioKICAgICAqIFJlbW92ZSBhbiBldmVudCBsaXN0ZW5lcgogICAgICogQHJldHVybiBUaGUgc2VsZiBvYmplY3QsIGZvciBjaGFpbmFiaWxpdHkuCiAgICAgKi8KCgogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcikgewogICAgICBpZiAodGhpcy5fbGlzdGVuZXJzID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgY29uc3QgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwoKICAgICAgaWYgKGxpc3RlbmVyc1t0eXBlXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIGNvbnN0IGluZGV4ID0gbGlzdGVuZXJzW3R5cGVdLmluZGV4T2YobGlzdGVuZXIpOwoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIGxpc3RlbmVyc1t0eXBlXS5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogRW1pdCBhbiBldmVudC4KICAgICAqIEByZXR1cm4gVGhlIHNlbGYgb2JqZWN0LCBmb3IgY2hhaW5hYmlsaXR5LgogICAgICovCgoKICAgIGRpc3BhdGNoRXZlbnQoZXZlbnQpIHsKICAgICAgaWYgKHRoaXMuX2xpc3RlbmVycyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIGNvbnN0IGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKICAgICAgY29uc3QgbGlzdGVuZXJBcnJheSA9IGxpc3RlbmVyc1tldmVudC50eXBlXTsKCiAgICAgIGlmIChsaXN0ZW5lckFycmF5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBldmVudC50YXJnZXQgPSB0aGlzOwoKICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGxpc3RlbmVyQXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBsaXN0ZW5lckFycmF5W2ldLmNhbGwodGhpcywgZXZlbnQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogIH0KCiAgLyoqCiAgICogQSBRdWF0ZXJuaW9uIGRlc2NyaWJlcyBhIHJvdGF0aW9uIGluIDNEIHNwYWNlLiBUaGUgUXVhdGVybmlvbiBpcyBtYXRoZW1hdGljYWxseSBkZWZpbmVkIGFzIFEgPSB4KmkgKyB5KmogKyB6KmsgKyB3LCB3aGVyZSAoaSxqLGspIGFyZSBpbWFnaW5hcnkgYmFzaXMgdmVjdG9ycy4gKHgseSx6KSBjYW4gYmUgc2VlbiBhcyBhIHZlY3RvciByZWxhdGVkIHRvIHRoZSBheGlzIG9mIHJvdGF0aW9uLCB3aGlsZSB0aGUgcmVhbCBtdWx0aXBsaWVyLCB3LCBpcyByZWxhdGVkIHRvIHRoZSBhbW91bnQgb2Ygcm90YXRpb24uCiAgICogQHBhcmFtIHggTXVsdGlwbGllciBvZiB0aGUgaW1hZ2luYXJ5IGJhc2lzIHZlY3RvciBpLgogICAqIEBwYXJhbSB5IE11bHRpcGxpZXIgb2YgdGhlIGltYWdpbmFyeSBiYXNpcyB2ZWN0b3Igai4KICAgKiBAcGFyYW0geiBNdWx0aXBsaWVyIG9mIHRoZSBpbWFnaW5hcnkgYmFzaXMgdmVjdG9yIGsuCiAgICogQHBhcmFtIHcgTXVsdGlwbGllciBvZiB0aGUgcmVhbCBwYXJ0LgogICAqIEBzZWUgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9RdWF0ZXJuaW9uCiAgICovCgogIGNsYXNzIFF1YXRlcm5pb24gewogICAgY29uc3RydWN0b3IoeCwgeSwgeiwgdykgewogICAgICBpZiAoeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgeCA9IDA7CiAgICAgIH0KCiAgICAgIGlmICh5ID09PSB2b2lkIDApIHsKICAgICAgICB5ID0gMDsKICAgICAgfQoKICAgICAgaWYgKHogPT09IHZvaWQgMCkgewogICAgICAgIHogPSAwOwogICAgICB9CgogICAgICBpZiAodyA9PT0gdm9pZCAwKSB7CiAgICAgICAgdyA9IDE7CiAgICAgIH0KCiAgICAgIHRoaXMueCA9IHg7CiAgICAgIHRoaXMueSA9IHk7CiAgICAgIHRoaXMueiA9IHo7CiAgICAgIHRoaXMudyA9IHc7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgdmFsdWUgb2YgdGhlIHF1YXRlcm5pb24uCiAgICAgKi8KCgogICAgc2V0KHgsIHksIHosIHcpIHsKICAgICAgdGhpcy54ID0geDsKICAgICAgdGhpcy55ID0geTsKICAgICAgdGhpcy56ID0gejsKICAgICAgdGhpcy53ID0gdzsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnQgdG8gYSByZWFkYWJsZSBmb3JtYXQKICAgICAqIEByZXR1cm4gIngseSx6LHciCiAgICAgKi8KCgogICAgdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiBgJHt0aGlzLnh9LCR7dGhpcy55fSwke3RoaXMuen0sJHt0aGlzLnd9YDsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydCB0byBhbiBBcnJheQogICAgICogQHJldHVybiBbeCwgeSwgeiwgd10KICAgICAqLwoKCiAgICB0b0FycmF5KCkgewogICAgICByZXR1cm4gW3RoaXMueCwgdGhpcy55LCB0aGlzLnosIHRoaXMud107CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgcXVhdGVybmlvbiBjb21wb25lbnRzIGdpdmVuIGFuIGF4aXMgYW5kIGFuIGFuZ2xlIGluIHJhZGlhbnMuCiAgICAgKi8KCgogICAgc2V0RnJvbUF4aXNBbmdsZSh2ZWN0b3IsIGFuZ2xlKSB7CiAgICAgIGNvbnN0IHMgPSBNYXRoLnNpbihhbmdsZSAqIDAuNSk7CiAgICAgIHRoaXMueCA9IHZlY3Rvci54ICogczsKICAgICAgdGhpcy55ID0gdmVjdG9yLnkgKiBzOwogICAgICB0aGlzLnogPSB2ZWN0b3IueiAqIHM7CiAgICAgIHRoaXMudyA9IE1hdGguY29zKGFuZ2xlICogMC41KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnRzIHRoZSBxdWF0ZXJuaW9uIHRvIFsgYXhpcywgYW5nbGUgXSByZXByZXNlbnRhdGlvbi4KICAgICAqIEBwYXJhbSB0YXJnZXRBeGlzIEEgdmVjdG9yIG9iamVjdCB0byByZXVzZSBmb3Igc3RvcmluZyB0aGUgYXhpcy4KICAgICAqIEByZXR1cm4gQW4gYXJyYXksIGZpcnN0IGVsZW1lbnQgaXMgdGhlIGF4aXMgYW5kIHRoZSBzZWNvbmQgaXMgdGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICAgKi8KCgogICAgdG9BeGlzQW5nbGUodGFyZ2V0QXhpcykgewogICAgICBpZiAodGFyZ2V0QXhpcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0QXhpcyA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHRoaXMubm9ybWFsaXplKCk7IC8vIGlmIHc+MSBhY29zIGFuZCBzcXJ0IHdpbGwgcHJvZHVjZSBlcnJvcnMsIHRoaXMgY2FudCBoYXBwZW4gaWYgcXVhdGVybmlvbiBpcyBub3JtYWxpc2VkCgogICAgICBjb25zdCBhbmdsZSA9IDIgKiBNYXRoLmFjb3ModGhpcy53KTsKICAgICAgY29uc3QgcyA9IE1hdGguc3FydCgxIC0gdGhpcy53ICogdGhpcy53KTsgLy8gYXNzdW1pbmcgcXVhdGVybmlvbiBub3JtYWxpc2VkIHRoZW4gdyBpcyBsZXNzIHRoYW4gMSwgc28gdGVybSBhbHdheXMgcG9zaXRpdmUuCgogICAgICBpZiAocyA8IDAuMDAxKSB7CiAgICAgICAgLy8gdGVzdCB0byBhdm9pZCBkaXZpZGUgYnkgemVybywgcyBpcyBhbHdheXMgcG9zaXRpdmUgZHVlIHRvIHNxcnQKICAgICAgICAvLyBpZiBzIGNsb3NlIHRvIHplcm8gdGhlbiBkaXJlY3Rpb24gb2YgYXhpcyBub3QgaW1wb3J0YW50CiAgICAgICAgdGFyZ2V0QXhpcy54ID0gdGhpcy54OyAvLyBpZiBpdCBpcyBpbXBvcnRhbnQgdGhhdCBheGlzIGlzIG5vcm1hbGlzZWQgdGhlbiByZXBsYWNlIHdpdGggeD0xOyB5PXo9MDsKCiAgICAgICAgdGFyZ2V0QXhpcy55ID0gdGhpcy55OwogICAgICAgIHRhcmdldEF4aXMueiA9IHRoaXMuejsKICAgICAgfSBlbHNlIHsKICAgICAgICB0YXJnZXRBeGlzLnggPSB0aGlzLnggLyBzOyAvLyBub3JtYWxpc2UgYXhpcwoKICAgICAgICB0YXJnZXRBeGlzLnkgPSB0aGlzLnkgLyBzOwogICAgICAgIHRhcmdldEF4aXMueiA9IHRoaXMueiAvIHM7CiAgICAgIH0KCiAgICAgIHJldHVybiBbdGFyZ2V0QXhpcywgYW5nbGVdOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHF1YXRlcm5pb24gdmFsdWUgZ2l2ZW4gdHdvIHZlY3RvcnMuIFRoZSByZXN1bHRpbmcgcm90YXRpb24gd2lsbCBiZSB0aGUgbmVlZGVkIHJvdGF0aW9uIHRvIHJvdGF0ZSB1IHRvIHYuCiAgICAgKi8KCgogICAgc2V0RnJvbVZlY3RvcnModSwgdikgewogICAgICBpZiAodS5pc0FudGlwYXJhbGxlbFRvKHYpKSB7CiAgICAgICAgY29uc3QgdDEgPSBzZnZfdDE7CiAgICAgICAgY29uc3QgdDIgPSBzZnZfdDI7CiAgICAgICAgdS50YW5nZW50cyh0MSwgdDIpOwogICAgICAgIHRoaXMuc2V0RnJvbUF4aXNBbmdsZSh0MSwgTWF0aC5QSSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYSA9IHUuY3Jvc3Modik7CiAgICAgICAgdGhpcy54ID0gYS54OwogICAgICAgIHRoaXMueSA9IGEueTsKICAgICAgICB0aGlzLnogPSBhLno7CiAgICAgICAgdGhpcy53ID0gTWF0aC5zcXJ0KHUubGVuZ3RoKCkgKiogMiAqIHYubGVuZ3RoKCkgKiogMikgKyB1LmRvdCh2KTsKICAgICAgICB0aGlzLm5vcm1hbGl6ZSgpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogTXVsdGlwbHkgdGhlIHF1YXRlcm5pb24gd2l0aCBhbiBvdGhlciBxdWF0ZXJuaW9uLgogICAgICovCgoKICAgIG11bHQocXVhdCwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IGF4ID0gdGhpcy54OwogICAgICBjb25zdCBheSA9IHRoaXMueTsKICAgICAgY29uc3QgYXogPSB0aGlzLno7CiAgICAgIGNvbnN0IGF3ID0gdGhpcy53OwogICAgICBjb25zdCBieCA9IHF1YXQueDsKICAgICAgY29uc3QgYnkgPSBxdWF0Lnk7CiAgICAgIGNvbnN0IGJ6ID0gcXVhdC56OwogICAgICBjb25zdCBidyA9IHF1YXQudzsKICAgICAgdGFyZ2V0LnggPSBheCAqIGJ3ICsgYXcgKiBieCArIGF5ICogYnogLSBheiAqIGJ5OwogICAgICB0YXJnZXQueSA9IGF5ICogYncgKyBhdyAqIGJ5ICsgYXogKiBieCAtIGF4ICogYno7CiAgICAgIHRhcmdldC56ID0gYXogKiBidyArIGF3ICogYnogKyBheCAqIGJ5IC0gYXkgKiBieDsKICAgICAgdGFyZ2V0LncgPSBhdyAqIGJ3IC0gYXggKiBieCAtIGF5ICogYnkgLSBheiAqIGJ6OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIGludmVyc2UgcXVhdGVybmlvbiByb3RhdGlvbi4KICAgICAqLwoKCiAgICBpbnZlcnNlKHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICB9CgogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICBjb25zdCB3ID0gdGhpcy53OwogICAgICB0aGlzLmNvbmp1Z2F0ZSh0YXJnZXQpOwogICAgICBjb25zdCBpbm9ybTIgPSAxIC8gKHggKiB4ICsgeSAqIHkgKyB6ICogeiArIHcgKiB3KTsKICAgICAgdGFyZ2V0LnggKj0gaW5vcm0yOwogICAgICB0YXJnZXQueSAqPSBpbm9ybTI7CiAgICAgIHRhcmdldC56ICo9IGlub3JtMjsKICAgICAgdGFyZ2V0LncgKj0gaW5vcm0yOwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHF1YXRlcm5pb24gY29uanVnYXRlCiAgICAgKi8KCgogICAgY29uanVnYXRlKHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICB9CgogICAgICB0YXJnZXQueCA9IC10aGlzLng7CiAgICAgIHRhcmdldC55ID0gLXRoaXMueTsKICAgICAgdGFyZ2V0LnogPSAtdGhpcy56OwogICAgICB0YXJnZXQudyA9IHRoaXMudzsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogTm9ybWFsaXplIHRoZSBxdWF0ZXJuaW9uLiBOb3RlIHRoYXQgdGhpcyBjaGFuZ2VzIHRoZSB2YWx1ZXMgb2YgdGhlIHF1YXRlcm5pb24uCiAgICAgKi8KCgogICAgbm9ybWFsaXplKCkgewogICAgICBsZXQgbCA9IE1hdGguc3FydCh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkgKyB0aGlzLnogKiB0aGlzLnogKyB0aGlzLncgKiB0aGlzLncpOwoKICAgICAgaWYgKGwgPT09IDApIHsKICAgICAgICB0aGlzLnggPSAwOwogICAgICAgIHRoaXMueSA9IDA7CiAgICAgICAgdGhpcy56ID0gMDsKICAgICAgICB0aGlzLncgPSAwOwogICAgICB9IGVsc2UgewogICAgICAgIGwgPSAxIC8gbDsKICAgICAgICB0aGlzLnggKj0gbDsKICAgICAgICB0aGlzLnkgKj0gbDsKICAgICAgICB0aGlzLnogKj0gbDsKICAgICAgICB0aGlzLncgKj0gbDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIEFwcHJveGltYXRpb24gb2YgcXVhdGVybmlvbiBub3JtYWxpemF0aW9uLiBXb3JrcyBiZXN0IHdoZW4gcXVhdCBpcyBhbHJlYWR5IGFsbW9zdC1ub3JtYWxpemVkLgogICAgICogQGF1dGhvciB1bnBoYXNlZCwgaHR0cHM6Ly9naXRodWIuY29tL3VucGhhc2VkCiAgICAgKi8KCgogICAgbm9ybWFsaXplRmFzdCgpIHsKICAgICAgY29uc3QgZiA9ICgzLjAgLSAodGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55ICsgdGhpcy56ICogdGhpcy56ICsgdGhpcy53ICogdGhpcy53KSkgLyAyLjA7CgogICAgICBpZiAoZiA9PT0gMCkgewogICAgICAgIHRoaXMueCA9IDA7CiAgICAgICAgdGhpcy55ID0gMDsKICAgICAgICB0aGlzLnogPSAwOwogICAgICAgIHRoaXMudyA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy54ICo9IGY7CiAgICAgICAgdGhpcy55ICo9IGY7CiAgICAgICAgdGhpcy56ICo9IGY7CiAgICAgICAgdGhpcy53ICo9IGY7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSB0aGUgcXVhdGVybmlvbiBieSBhIHZlY3RvcgogICAgICovCgoKICAgIHZtdWx0KHYsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCB4ID0gdi54OwogICAgICBjb25zdCB5ID0gdi55OwogICAgICBjb25zdCB6ID0gdi56OwogICAgICBjb25zdCBxeCA9IHRoaXMueDsKICAgICAgY29uc3QgcXkgPSB0aGlzLnk7CiAgICAgIGNvbnN0IHF6ID0gdGhpcy56OwogICAgICBjb25zdCBxdyA9IHRoaXMudzsgLy8gcSp2CgogICAgICBjb25zdCBpeCA9IHF3ICogeCArIHF5ICogeiAtIHF6ICogeTsKICAgICAgY29uc3QgaXkgPSBxdyAqIHkgKyBxeiAqIHggLSBxeCAqIHo7CiAgICAgIGNvbnN0IGl6ID0gcXcgKiB6ICsgcXggKiB5IC0gcXkgKiB4OwogICAgICBjb25zdCBpdyA9IC1xeCAqIHggLSBxeSAqIHkgLSBxeiAqIHo7CiAgICAgIHRhcmdldC54ID0gaXggKiBxdyArIGl3ICogLXF4ICsgaXkgKiAtcXogLSBpeiAqIC1xeTsKICAgICAgdGFyZ2V0LnkgPSBpeSAqIHF3ICsgaXcgKiAtcXkgKyBpeiAqIC1xeCAtIGl4ICogLXF6OwogICAgICB0YXJnZXQueiA9IGl6ICogcXcgKyBpdyAqIC1xeiArIGl4ICogLXF5IC0gaXkgKiAtcXg7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIENvcGllcyB2YWx1ZSBvZiBzb3VyY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KCgogICAgY29weShxdWF0KSB7CiAgICAgIHRoaXMueCA9IHF1YXQueDsKICAgICAgdGhpcy55ID0gcXVhdC55OwogICAgICB0aGlzLnogPSBxdWF0Lno7CiAgICAgIHRoaXMudyA9IHF1YXQudzsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnQgdGhlIHF1YXRlcm5pb24gdG8gZXVsZXIgYW5nbGUgcmVwcmVzZW50YXRpb24uIE9yZGVyOiBZWlgsIGFzIHRoaXMgcGFnZSBkZXNjcmliZXM6IGh0dHBzOi8vd3d3LmV1Y2xpZGVhbnNwYWNlLmNvbS9tYXRocy9zdGFuZGFyZHMvaW5kZXguaHRtCiAgICAgKiBAcGFyYW0gb3JkZXIgVGhyZWUtY2hhcmFjdGVyIHN0cmluZywgZGVmYXVsdHMgdG8gIllaWCIKICAgICAqLwoKCiAgICB0b0V1bGVyKHRhcmdldCwgb3JkZXIpIHsKICAgICAgaWYgKG9yZGVyID09PSB2b2lkIDApIHsKICAgICAgICBvcmRlciA9ICdZWlgnOwogICAgICB9CgogICAgICBsZXQgaGVhZGluZzsKICAgICAgbGV0IGF0dGl0dWRlOwogICAgICBsZXQgYmFuazsKICAgICAgY29uc3QgeCA9IHRoaXMueDsKICAgICAgY29uc3QgeSA9IHRoaXMueTsKICAgICAgY29uc3QgeiA9IHRoaXMuejsKICAgICAgY29uc3QgdyA9IHRoaXMudzsKCiAgICAgIHN3aXRjaCAob3JkZXIpIHsKICAgICAgICBjYXNlICdZWlgnOgogICAgICAgICAgY29uc3QgdGVzdCA9IHggKiB5ICsgeiAqIHc7CgogICAgICAgICAgaWYgKHRlc3QgPiAwLjQ5OSkgewogICAgICAgICAgICAvLyBzaW5ndWxhcml0eSBhdCBub3J0aCBwb2xlCiAgICAgICAgICAgIGhlYWRpbmcgPSAyICogTWF0aC5hdGFuMih4LCB3KTsKICAgICAgICAgICAgYXR0aXR1ZGUgPSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgYmFuayA9IDA7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHRlc3QgPCAtMC40OTkpIHsKICAgICAgICAgICAgLy8gc2luZ3VsYXJpdHkgYXQgc291dGggcG9sZQogICAgICAgICAgICBoZWFkaW5nID0gLTIgKiBNYXRoLmF0YW4yKHgsIHcpOwogICAgICAgICAgICBhdHRpdHVkZSA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgYmFuayA9IDA7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGhlYWRpbmcgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjb25zdCBzcXggPSB4ICogeDsKICAgICAgICAgICAgY29uc3Qgc3F5ID0geSAqIHk7CiAgICAgICAgICAgIGNvbnN0IHNxeiA9IHogKiB6OwogICAgICAgICAgICBoZWFkaW5nID0gTWF0aC5hdGFuMigyICogeSAqIHcgLSAyICogeCAqIHosIDEgLSAyICogc3F5IC0gMiAqIHNxeik7IC8vIEhlYWRpbmcKCiAgICAgICAgICAgIGF0dGl0dWRlID0gTWF0aC5hc2luKDIgKiB0ZXN0KTsgLy8gYXR0aXR1ZGUKCiAgICAgICAgICAgIGJhbmsgPSBNYXRoLmF0YW4yKDIgKiB4ICogdyAtIDIgKiB5ICogeiwgMSAtIDIgKiBzcXggLSAyICogc3F6KTsgLy8gYmFuawogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFdWxlciBvcmRlciAke29yZGVyfSBub3Qgc3VwcG9ydGVkIHlldC5gKTsKICAgICAgfQoKICAgICAgdGFyZ2V0LnkgPSBoZWFkaW5nOwogICAgICB0YXJnZXQueiA9IGF0dGl0dWRlOwogICAgICB0YXJnZXQueCA9IGJhbms7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgcXVhdGVybmlvbiBjb21wb25lbnRzIGdpdmVuIEV1bGVyIGFuZ2xlIHJlcHJlc2VudGF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSBvcmRlciBUaGUgb3JkZXIgdG8gYXBwbHkgYW5nbGVzOiAnWFlaJyBvciAnWVhaJyBvciBhbnkgb3RoZXIgY29tYmluYXRpb24uCiAgICAgKgogICAgICogU2VlIHtAbGluayBodHRwczovL3d3dy5tYXRod29ya3MuY29tL21hdGxhYmNlbnRyYWwvZmlsZWV4Y2hhbmdlLzIwNjk2LWZ1bmN0aW9uLXRvLWNvbnZlcnQtYmV0d2Vlbi1kY20tZXVsZXItYW5nbGVzLXF1YXRlcm5pb25zLWFuZC1ldWxlci12ZWN0b3JzIE1hdGhXb3Jrc30gcmVmZXJlbmNlCiAgICAgKi8KCgogICAgc2V0RnJvbUV1bGVyKHgsIHksIHosIG9yZGVyKSB7CiAgICAgIGlmIChvcmRlciA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3JkZXIgPSAnWFlaJzsKICAgICAgfQoKICAgICAgY29uc3QgYzEgPSBNYXRoLmNvcyh4IC8gMik7CiAgICAgIGNvbnN0IGMyID0gTWF0aC5jb3MoeSAvIDIpOwogICAgICBjb25zdCBjMyA9IE1hdGguY29zKHogLyAyKTsKICAgICAgY29uc3QgczEgPSBNYXRoLnNpbih4IC8gMik7CiAgICAgIGNvbnN0IHMyID0gTWF0aC5zaW4oeSAvIDIpOwogICAgICBjb25zdCBzMyA9IE1hdGguc2luKHogLyAyKTsKCiAgICAgIGlmIChvcmRlciA9PT0gJ1hZWicpIHsKICAgICAgICB0aGlzLnggPSBzMSAqIGMyICogYzMgKyBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy55ID0gYzEgKiBzMiAqIGMzIC0gczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMueiA9IGMxICogYzIgKiBzMyArIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLncgPSBjMSAqIGMyICogYzMgLSBzMSAqIHMyICogczM7CiAgICAgIH0gZWxzZSBpZiAob3JkZXIgPT09ICdZWFonKSB7CiAgICAgICAgdGhpcy54ID0gczEgKiBjMiAqIGMzICsgYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMueSA9IGMxICogczIgKiBjMyAtIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLnogPSBjMSAqIGMyICogczMgLSBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy53ID0gYzEgKiBjMiAqIGMzICsgczEgKiBzMiAqIHMzOwogICAgICB9IGVsc2UgaWYgKG9yZGVyID09PSAnWlhZJykgewogICAgICAgIHRoaXMueCA9IHMxICogYzIgKiBjMyAtIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLnkgPSBjMSAqIHMyICogYzMgKyBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy56ID0gYzEgKiBjMiAqIHMzICsgczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMudyA9IGMxICogYzIgKiBjMyAtIHMxICogczIgKiBzMzsKICAgICAgfSBlbHNlIGlmIChvcmRlciA9PT0gJ1pZWCcpIHsKICAgICAgICB0aGlzLnggPSBzMSAqIGMyICogYzMgLSBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy55ID0gYzEgKiBzMiAqIGMzICsgczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMueiA9IGMxICogYzIgKiBzMyAtIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLncgPSBjMSAqIGMyICogYzMgKyBzMSAqIHMyICogczM7CiAgICAgIH0gZWxzZSBpZiAob3JkZXIgPT09ICdZWlgnKSB7CiAgICAgICAgdGhpcy54ID0gczEgKiBjMiAqIGMzICsgYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMueSA9IGMxICogczIgKiBjMyArIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLnogPSBjMSAqIGMyICogczMgLSBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy53ID0gYzEgKiBjMiAqIGMzIC0gczEgKiBzMiAqIHMzOwogICAgICB9IGVsc2UgaWYgKG9yZGVyID09PSAnWFpZJykgewogICAgICAgIHRoaXMueCA9IHMxICogYzIgKiBjMyAtIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLnkgPSBjMSAqIHMyICogYzMgLSBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy56ID0gYzEgKiBjMiAqIHMzICsgczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMudyA9IGMxICogYzIgKiBjMyArIHMxICogczIgKiBzMzsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgY2xvbmUoKSB7CiAgICAgIHJldHVybiBuZXcgUXVhdGVybmlvbih0aGlzLngsIHRoaXMueSwgdGhpcy56LCB0aGlzLncpOwogICAgfQogICAgLyoqCiAgICAgKiBQZXJmb3JtcyBhIHNwaGVyaWNhbCBsaW5lYXIgaW50ZXJwb2xhdGlvbiBiZXR3ZWVuIHR3byBxdWF0CiAgICAgKgogICAgICogQHBhcmFtIHRvUXVhdCBzZWNvbmQgb3BlcmFuZAogICAgICogQHBhcmFtIHQgaW50ZXJwb2xhdGlvbiBhbW91bnQgYmV0d2VlbiB0aGUgc2VsZiBxdWF0ZXJuaW9uIGFuZCB0b1F1YXQKICAgICAqIEBwYXJhbSB0YXJnZXQgQSBxdWF0ZXJuaW9uIHRvIHN0b3JlIHRoZSByZXN1bHQgaW4uIElmIG5vdCBwcm92aWRlZCwgYSBuZXcgb25lIHdpbGwgYmUgY3JlYXRlZC4KICAgICAqIEByZXR1cm5zIHtRdWF0ZXJuaW9ufSBUaGUgInRhcmdldCIgb2JqZWN0CiAgICAgKi8KCgogICAgc2xlcnAodG9RdWF0LCB0LCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgfQoKICAgICAgY29uc3QgYXggPSB0aGlzLng7CiAgICAgIGNvbnN0IGF5ID0gdGhpcy55OwogICAgICBjb25zdCBheiA9IHRoaXMuejsKICAgICAgY29uc3QgYXcgPSB0aGlzLnc7CiAgICAgIGxldCBieCA9IHRvUXVhdC54OwogICAgICBsZXQgYnkgPSB0b1F1YXQueTsKICAgICAgbGV0IGJ6ID0gdG9RdWF0Lno7CiAgICAgIGxldCBidyA9IHRvUXVhdC53OwogICAgICBsZXQgb21lZ2E7CiAgICAgIGxldCBjb3NvbTsKICAgICAgbGV0IHNpbm9tOwogICAgICBsZXQgc2NhbGUwOwogICAgICBsZXQgc2NhbGUxOyAvLyBjYWxjIGNvc2luZQoKICAgICAgY29zb20gPSBheCAqIGJ4ICsgYXkgKiBieSArIGF6ICogYnogKyBhdyAqIGJ3OyAvLyBhZGp1c3Qgc2lnbnMgKGlmIG5lY2Vzc2FyeSkKCiAgICAgIGlmIChjb3NvbSA8IDAuMCkgewogICAgICAgIGNvc29tID0gLWNvc29tOwogICAgICAgIGJ4ID0gLWJ4OwogICAgICAgIGJ5ID0gLWJ5OwogICAgICAgIGJ6ID0gLWJ6OwogICAgICAgIGJ3ID0gLWJ3OwogICAgICB9IC8vIGNhbGN1bGF0ZSBjb2VmZmljaWVudHMKCgogICAgICBpZiAoMS4wIC0gY29zb20gPiAwLjAwMDAwMSkgewogICAgICAgIC8vIHN0YW5kYXJkIGNhc2UgKHNsZXJwKQogICAgICAgIG9tZWdhID0gTWF0aC5hY29zKGNvc29tKTsKICAgICAgICBzaW5vbSA9IE1hdGguc2luKG9tZWdhKTsKICAgICAgICBzY2FsZTAgPSBNYXRoLnNpbigoMS4wIC0gdCkgKiBvbWVnYSkgLyBzaW5vbTsKICAgICAgICBzY2FsZTEgPSBNYXRoLnNpbih0ICogb21lZ2EpIC8gc2lub207CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gImZyb20iIGFuZCAidG8iIHF1YXRlcm5pb25zIGFyZSB2ZXJ5IGNsb3NlCiAgICAgICAgLy8gIC4uLiBzbyB3ZSBjYW4gZG8gYSBsaW5lYXIgaW50ZXJwb2xhdGlvbgogICAgICAgIHNjYWxlMCA9IDEuMCAtIHQ7CiAgICAgICAgc2NhbGUxID0gdDsKICAgICAgfSAvLyBjYWxjdWxhdGUgZmluYWwgdmFsdWVzCgoKICAgICAgdGFyZ2V0LnggPSBzY2FsZTAgKiBheCArIHNjYWxlMSAqIGJ4OwogICAgICB0YXJnZXQueSA9IHNjYWxlMCAqIGF5ICsgc2NhbGUxICogYnk7CiAgICAgIHRhcmdldC56ID0gc2NhbGUwICogYXogKyBzY2FsZTEgKiBiejsKICAgICAgdGFyZ2V0LncgPSBzY2FsZTAgKiBhdyArIHNjYWxlMSAqIGJ3OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBSb3RhdGUgYW4gYWJzb2x1dGUgb3JpZW50YXRpb24gcXVhdGVybmlvbiBnaXZlbiBhbiBhbmd1bGFyIHZlbG9jaXR5IGFuZCBhIHRpbWUgc3RlcC4KICAgICAqLwoKCiAgICBpbnRlZ3JhdGUoYW5ndWxhclZlbG9jaXR5LCBkdCwgYW5ndWxhckZhY3RvciwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IGF4ID0gYW5ndWxhclZlbG9jaXR5LnggKiBhbmd1bGFyRmFjdG9yLngsCiAgICAgICAgICAgIGF5ID0gYW5ndWxhclZlbG9jaXR5LnkgKiBhbmd1bGFyRmFjdG9yLnksCiAgICAgICAgICAgIGF6ID0gYW5ndWxhclZlbG9jaXR5LnogKiBhbmd1bGFyRmFjdG9yLnosCiAgICAgICAgICAgIGJ4ID0gdGhpcy54LAogICAgICAgICAgICBieSA9IHRoaXMueSwKICAgICAgICAgICAgYnogPSB0aGlzLnosCiAgICAgICAgICAgIGJ3ID0gdGhpcy53OwogICAgICBjb25zdCBoYWxmX2R0ID0gZHQgKiAwLjU7CiAgICAgIHRhcmdldC54ICs9IGhhbGZfZHQgKiAoYXggKiBidyArIGF5ICogYnogLSBheiAqIGJ5KTsKICAgICAgdGFyZ2V0LnkgKz0gaGFsZl9kdCAqIChheSAqIGJ3ICsgYXogKiBieCAtIGF4ICogYnopOwogICAgICB0YXJnZXQueiArPSBoYWxmX2R0ICogKGF6ICogYncgKyBheCAqIGJ5IC0gYXkgKiBieCk7CiAgICAgIHRhcmdldC53ICs9IGhhbGZfZHQgKiAoLWF4ICogYnggLSBheSAqIGJ5IC0gYXogKiBieik7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CgogIH0KICBjb25zdCBzZnZfdDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNmdl90MiA9IG5ldyBWZWMzKCk7CgogIC8qKgogICAqIFRoZSBhdmFpbGFibGUgc2hhcGUgdHlwZXMuCiAgICovCiAgY29uc3QgU0hBUEVfVFlQRVMgPSB7CiAgICAvKiogU1BIRVJFICovCiAgICBTUEhFUkU6IDEsCgogICAgLyoqIFBMQU5FICovCiAgICBQTEFORTogMiwKCiAgICAvKiogQk9YICovCiAgICBCT1g6IDQsCgogICAgLyoqIENPTVBPVU5EICovCiAgICBDT01QT1VORDogOCwKCiAgICAvKiogQ09OVkVYUE9MWUhFRFJPTiAqLwogICAgQ09OVkVYUE9MWUhFRFJPTjogMTYsCgogICAgLyoqIEhFSUdIVEZJRUxEICovCiAgICBIRUlHSFRGSUVMRDogMzIsCgogICAgLyoqIFBBUlRJQ0xFICovCiAgICBQQVJUSUNMRTogNjQsCgogICAgLyoqIENZTElOREVSICovCiAgICBDWUxJTkRFUjogMTI4LAoKICAgIC8qKiBUUklNRVNIICovCiAgICBUUklNRVNIOiAyNTYKICB9OwogIC8qKgogICAqIFNoYXBlVHlwZQogICAqLwoKICAvKioKICAgKiBCYXNlIGNsYXNzIGZvciBzaGFwZXMKICAgKi8KICBjbGFzcyBTaGFwZSB7CiAgICAvKioKICAgICAqIElkZW50aWZpZXIgb2YgdGhlIFNoYXBlLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgdHlwZSBvZiB0aGlzIHNoYXBlLiBNdXN0IGJlIHNldCB0byBhbiBpbnQgPiAwIGJ5IHN1YmNsYXNzZXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBsb2NhbCBib3VuZGluZyBzcGhlcmUgcmFkaXVzIG9mIHRoaXMgc2hhcGUuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFdoZXRoZXIgdG8gcHJvZHVjZSBjb250YWN0IGZvcmNlcyB3aGVuIGluIGNvbnRhY3Qgd2l0aCBvdGhlciBib2RpZXMuIE5vdGUgdGhhdCBjb250YWN0cyB3aWxsIGJlIGdlbmVyYXRlZCwgYnV0IHRoZXkgd2lsbCBiZSBkaXNhYmxlZC4KICAgICAqIEBkZWZhdWx0IHRydWUKICAgICAqLwoKICAgIC8qKgogICAgICogQGRlZmF1bHQgMQogICAgICovCgogICAgLyoqCiAgICAgKiBAZGVmYXVsdCAtMQogICAgICovCgogICAgLyoqCiAgICAgKiBPcHRpb25hbCBtYXRlcmlhbCBvZiB0aGUgc2hhcGUgdGhhdCByZWd1bGF0ZXMgY29udGFjdCBwcm9wZXJ0aWVzLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgYm9keSB0byB3aGljaCB0aGUgc2hhcGUgaXMgYWRkZWQgdG8uCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFsbCB0aGUgU2hhcGUgdHlwZXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgdGhpcy5pZCA9IFNoYXBlLmlkQ291bnRlcisrOwogICAgICB0aGlzLnR5cGUgPSBvcHRpb25zLnR5cGUgfHwgMDsKICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyA9IDA7CiAgICAgIHRoaXMuY29sbGlzaW9uUmVzcG9uc2UgPSBvcHRpb25zLmNvbGxpc2lvblJlc3BvbnNlID8gb3B0aW9ucy5jb2xsaXNpb25SZXNwb25zZSA6IHRydWU7CiAgICAgIHRoaXMuY29sbGlzaW9uRmlsdGVyR3JvdXAgPSBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwIDogMTsKICAgICAgdGhpcy5jb2xsaXNpb25GaWx0ZXJNYXNrID0gb3B0aW9ucy5jb2xsaXNpb25GaWx0ZXJNYXNrICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlck1hc2sgOiAtMTsKICAgICAgdGhpcy5tYXRlcmlhbCA9IG9wdGlvbnMubWF0ZXJpYWwgPyBvcHRpb25zLm1hdGVyaWFsIDogbnVsbDsKICAgICAgdGhpcy5ib2R5ID0gbnVsbDsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZXMgdGhlIGJvdW5kaW5nIHNwaGVyZSByYWRpdXMuCiAgICAgKiBUaGUgcmVzdWx0IGlzIHN0b3JlZCBpbiB0aGUgcHJvcGVydHkgYC5ib3VuZGluZ1NwaGVyZVJhZGl1c2AKICAgICAqLwoKCiAgICB1cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpIHsKICAgICAgdGhyb3cgYGNvbXB1dGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpIG5vdCBpbXBsZW1lbnRlZCBmb3Igc2hhcGUgdHlwZSAke3RoaXMudHlwZX1gOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHZvbHVtZSBvZiB0aGlzIHNoYXBlCiAgICAgKi8KCgogICAgdm9sdW1lKCkgewogICAgICB0aHJvdyBgdm9sdW1lKCkgbm90IGltcGxlbWVudGVkIGZvciBzaGFwZSB0eXBlICR7dGhpcy50eXBlfWA7CiAgICB9CiAgICAvKioKICAgICAqIENhbGN1bGF0ZXMgdGhlIGluZXJ0aWEgaW4gdGhlIGxvY2FsIGZyYW1lIGZvciB0aGlzIHNoYXBlLgogICAgICogQHNlZSBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0xpc3Rfb2ZfbW9tZW50c19vZl9pbmVydGlhCiAgICAgKi8KCgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICB0aHJvdyBgY2FsY3VsYXRlTG9jYWxJbmVydGlhKCkgbm90IGltcGxlbWVudGVkIGZvciBzaGFwZSB0eXBlICR7dGhpcy50eXBlfWA7CiAgICB9CiAgICAvKioKICAgICAqIEB0b2RvIHVzZSBhYnN0cmFjdCBmb3IgdGhlc2Uga2luZCBvZiBtZXRob2RzCiAgICAgKi8KCgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgdGhyb3cgYGNhbGN1bGF0ZVdvcmxkQUFCQigpIG5vdCBpbXBsZW1lbnRlZCBmb3Igc2hhcGUgdHlwZSAke3RoaXMudHlwZX1gOwogICAgfQoKICB9CiAgU2hhcGUuaWRDb3VudGVyID0gMDsKICBTaGFwZS50eXBlcyA9IFNIQVBFX1RZUEVTOwoKICAvKioKICAgKiBUcmFuc2Zvcm1hdGlvbiB1dGlsaXRpZXMuCiAgICovCiAgY2xhc3MgVHJhbnNmb3JtIHsKICAgIC8qKgogICAgICogcG9zaXRpb24KICAgICAqLwoKICAgIC8qKgogICAgICogcXVhdGVybmlvbgogICAgICovCiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIHRoaXMucG9zaXRpb24gPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwoKICAgICAgaWYgKG9wdGlvbnMucG9zaXRpb24pIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLmNvcHkob3B0aW9ucy5wb3NpdGlvbik7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnF1YXRlcm5pb24pIHsKICAgICAgICB0aGlzLnF1YXRlcm5pb24uY29weShvcHRpb25zLnF1YXRlcm5pb24pOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhIGdsb2JhbCBwb2ludCBpbiBsb2NhbCB0cmFuc2Zvcm0gY29vcmRpbmF0ZXMuCiAgICAgKi8KCgogICAgcG9pbnRUb0xvY2FsKHdvcmxkUG9pbnQsIHJlc3VsdCkgewogICAgICByZXR1cm4gVHJhbnNmb3JtLnBvaW50VG9Mb2NhbEZyYW1lKHRoaXMucG9zaXRpb24sIHRoaXMucXVhdGVybmlvbiwgd29ybGRQb2ludCwgcmVzdWx0KTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGEgbG9jYWwgcG9pbnQgaW4gZ2xvYmFsIHRyYW5zZm9ybSBjb29yZGluYXRlcy4KICAgICAqLwoKCiAgICBwb2ludFRvV29ybGQobG9jYWxQb2ludCwgcmVzdWx0KSB7CiAgICAgIHJldHVybiBUcmFuc2Zvcm0ucG9pbnRUb1dvcmxkRnJhbWUodGhpcy5wb3NpdGlvbiwgdGhpcy5xdWF0ZXJuaW9uLCBsb2NhbFBvaW50LCByZXN1bHQpOwogICAgfQogICAgLyoqCiAgICAgKiB2ZWN0b3JUb1dvcmxkRnJhbWUKICAgICAqLwoKCiAgICB2ZWN0b3JUb1dvcmxkRnJhbWUobG9jYWxWZWN0b3IsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0aGlzLnF1YXRlcm5pb24udm11bHQobG9jYWxWZWN0b3IsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIHBvaW50VG9Mb2NhbEZyYW1lCiAgICAgKi8KCgogICAgc3RhdGljIHBvaW50VG9Mb2NhbEZyYW1lKHBvc2l0aW9uLCBxdWF0ZXJuaW9uLCB3b3JsZFBvaW50LCByZXN1bHQpIHsKICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVzdWx0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgd29ybGRQb2ludC52c3ViKHBvc2l0aW9uLCByZXN1bHQpOwogICAgICBxdWF0ZXJuaW9uLmNvbmp1Z2F0ZSh0bXBRdWF0JDEpOwogICAgICB0bXBRdWF0JDEudm11bHQocmVzdWx0LCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiBwb2ludFRvV29ybGRGcmFtZQogICAgICovCgoKICAgIHN0YXRpYyBwb2ludFRvV29ybGRGcmFtZShwb3NpdGlvbiwgcXVhdGVybmlvbiwgbG9jYWxQb2ludCwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHF1YXRlcm5pb24udm11bHQobG9jYWxQb2ludCwgcmVzdWx0KTsKICAgICAgcmVzdWx0LnZhZGQocG9zaXRpb24sIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIHZlY3RvclRvV29ybGRGcmFtZQogICAgICovCgoKICAgIHN0YXRpYyB2ZWN0b3JUb1dvcmxkRnJhbWUocXVhdGVybmlvbiwgbG9jYWxWZWN0b3IsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBxdWF0ZXJuaW9uLnZtdWx0KGxvY2FsVmVjdG9yLCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiB2ZWN0b3JUb0xvY2FsRnJhbWUKICAgICAqLwoKCiAgICBzdGF0aWMgdmVjdG9yVG9Mb2NhbEZyYW1lKHBvc2l0aW9uLCBxdWF0ZXJuaW9uLCB3b3JsZFZlY3RvciwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHF1YXRlcm5pb24udyAqPSAtMTsKICAgICAgcXVhdGVybmlvbi52bXVsdCh3b3JsZFZlY3RvciwgcmVzdWx0KTsKICAgICAgcXVhdGVybmlvbi53ICo9IC0xOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICB9CiAgY29uc3QgdG1wUXVhdCQxID0gbmV3IFF1YXRlcm5pb24oKTsKCiAgLyoqCiAgICogQSBzZXQgb2YgcG9seWdvbnMgZGVzY3JpYmluZyBhIGNvbnZleCBzaGFwZS4KICAgKgogICAqIFRoZSBzaGFwZSBNVVNUIGJlIGNvbnZleCBmb3IgdGhlIGNvZGUgdG8gd29yayBwcm9wZXJseS4gTm8gcG9seWdvbnMgbWF5IGJlIGNvcGxhbmFyIChjb250YWluZWQKICAgKiBpbiB0aGUgc2FtZSAzRCBwbGFuZSksIGluc3RlYWQgdGhlc2Ugc2hvdWxkIGJlIG1lcmdlZCBpbnRvIG9uZSBwb2x5Z29uLgogICAqCiAgICogQGF1dGhvciBxaWFvIC8gaHR0cHM6Ly9naXRodWIuY29tL3FpYW8gKG9yaWdpbmFsIGF1dGhvciwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9xaWFvL3RocmVlLmpzL2NvbW1pdC84NTAyNmYwYzc2OWU0MDAwMTQ4YTY3ZDQ1YTllOWI5YzUxMDg4MzZmKQogICAqIEBhdXRob3Igc2NodGVwcGUgLyBodHRwczovL2dpdGh1Yi5jb20vc2NodGVwcGUKICAgKiBAc2VlIGh0dHBzOi8vd3d3LmFsdGRldmJsb2dhZGF5LmNvbS8yMDExLzA1LzEzL2NvbnRhY3QtZ2VuZXJhdGlvbi1iZXR3ZWVuLTNkLWNvbnZleC1tZXNoZXMvCiAgICoKICAgKiBAdG9kbyBNb3ZlIHRoZSBjbGlwcGluZyBmdW5jdGlvbnMgdG8gQ29udGFjdEdlbmVyYXRvcj8KICAgKiBAdG9kbyBBdXRvbWF0aWNhbGx5IG1lcmdlIGNvcGxhbmFyIHBvbHlnb25zIGluIGNvbnN0cnVjdG9yLgogICAqIEBleGFtcGxlCiAgICogICAgIGNvbnN0IGNvbnZleFNoYXBlID0gbmV3IENBTk5PTi5Db252ZXhQb2x5aGVkcm9uKHsgdmVydGljZXMsIGZhY2VzIH0pCiAgICogICAgIGNvbnN0IGNvbnZleEJvZHkgPSBuZXcgQ0FOTk9OLkJvZHkoeyBtYXNzOiAxLCBzaGFwZTogY29udmV4U2hhcGUgfSkKICAgKiAgICAgd29ybGQuYWRkQm9keShjb252ZXhCb2R5KQogICAqLwogIGNsYXNzIENvbnZleFBvbHloZWRyb24gZXh0ZW5kcyBTaGFwZSB7CiAgICAvKiogdmVydGljZXMgKi8KCiAgICAvKioKICAgICAqIEFycmF5IG9mIGludGVnZXIgYXJyYXlzLCBpbmRpY2F0aW5nIHdoaWNoIHZlcnRpY2VzIGVhY2ggZmFjZSBjb25zaXN0cyBvZgogICAgICovCgogICAgLyoqIGZhY2VOb3JtYWxzICovCgogICAgLyoqIHdvcmxkVmVydGljZXMgKi8KCiAgICAvKiogd29ybGRWZXJ0aWNlc05lZWRzVXBkYXRlICovCgogICAgLyoqIHdvcmxkRmFjZU5vcm1hbHMgKi8KCiAgICAvKiogd29ybGRGYWNlTm9ybWFsc05lZWRzVXBkYXRlICovCgogICAgLyoqCiAgICAgKiBJZiBnaXZlbiwgdGhlc2UgbG9jYWxseSBkZWZpbmVkLCBub3JtYWxpemVkIGF4ZXMgYXJlIHRoZSBvbmx5IG9uZXMgYmVpbmcgY2hlY2tlZCB3aGVuIGRvaW5nIHNlcGFyYXRpbmcgYXhpcyBjaGVjay4KICAgICAqLwoKICAgIC8qKiB1bmlxdWVFZGdlcyAqLwoKICAgIC8qKgogICAgICogQHBhcmFtIHZlcnRpY2VzIEFuIGFycmF5IG9mIFZlYzMncwogICAgICogQHBhcmFtIGZhY2VzIEFycmF5IG9mIGludGVnZXIgYXJyYXlzLCBkZXNjcmliaW5nIHdoaWNoIHZlcnRpY2VzIHRoYXQgaXMgaW5jbHVkZWQgaW4gZWFjaCBmYWNlLgogICAgICovCiAgICBjb25zdHJ1Y3Rvcihwcm9wcykgewogICAgICBpZiAocHJvcHMgPT09IHZvaWQgMCkgewogICAgICAgIHByb3BzID0ge307CiAgICAgIH0KCiAgICAgIGNvbnN0IHsKICAgICAgICB2ZXJ0aWNlcyA9IFtdLAogICAgICAgIGZhY2VzID0gW10sCiAgICAgICAgbm9ybWFscyA9IFtdLAogICAgICAgIGF4ZXMsCiAgICAgICAgYm91bmRpbmdTcGhlcmVSYWRpdXMKICAgICAgfSA9IHByb3BzOwogICAgICBzdXBlcih7CiAgICAgICAgdHlwZTogU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTgogICAgICB9KTsKICAgICAgdGhpcy52ZXJ0aWNlcyA9IHZlcnRpY2VzOwogICAgICB0aGlzLmZhY2VzID0gZmFjZXM7CiAgICAgIHRoaXMuZmFjZU5vcm1hbHMgPSBub3JtYWxzOwoKICAgICAgaWYgKHRoaXMuZmFjZU5vcm1hbHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy5jb21wdXRlTm9ybWFscygpOwogICAgICB9CgogICAgICBpZiAoIWJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgdGhpcy51cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgPSBib3VuZGluZ1NwaGVyZVJhZGl1czsKICAgICAgfQoKICAgICAgdGhpcy53b3JsZFZlcnRpY2VzID0gW107IC8vIFdvcmxkIHRyYW5zZm9ybWVkIHZlcnNpb24gb2YgLnZlcnRpY2VzCgogICAgICB0aGlzLndvcmxkVmVydGljZXNOZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgIHRoaXMud29ybGRGYWNlTm9ybWFscyA9IFtdOyAvLyBXb3JsZCB0cmFuc2Zvcm1lZCB2ZXJzaW9uIG9mIC5mYWNlTm9ybWFscwoKICAgICAgdGhpcy53b3JsZEZhY2VOb3JtYWxzTmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICB0aGlzLnVuaXF1ZUF4ZXMgPSBheGVzID8gYXhlcy5zbGljZSgpIDogbnVsbDsKICAgICAgdGhpcy51bmlxdWVFZGdlcyA9IFtdOwogICAgICB0aGlzLmNvbXB1dGVFZGdlcygpOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyB1bmlxdWVFZGdlcwogICAgICovCgoKICAgIGNvbXB1dGVFZGdlcygpIHsKICAgICAgY29uc3QgZmFjZXMgPSB0aGlzLmZhY2VzOwogICAgICBjb25zdCB2ZXJ0aWNlcyA9IHRoaXMudmVydGljZXM7CiAgICAgIGNvbnN0IGVkZ2VzID0gdGhpcy51bmlxdWVFZGdlczsKICAgICAgZWRnZXMubGVuZ3RoID0gMDsKICAgICAgY29uc3QgZWRnZSA9IG5ldyBWZWMzKCk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gZmFjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBmYWNlID0gZmFjZXNbaV07CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBmYWNlLmxlbmd0aDsKCiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogIT09IG51bVZlcnRpY2VzOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGsgPSAoaiArIDEpICUgbnVtVmVydGljZXM7CiAgICAgICAgICB2ZXJ0aWNlc1tmYWNlW2pdXS52c3ViKHZlcnRpY2VzW2ZhY2Vba11dLCBlZGdlKTsKICAgICAgICAgIGVkZ2Uubm9ybWFsaXplKCk7CiAgICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTsKCiAgICAgICAgICBmb3IgKGxldCBwID0gMDsgcCAhPT0gZWRnZXMubGVuZ3RoOyBwKyspIHsKICAgICAgICAgICAgaWYgKGVkZ2VzW3BdLmFsbW9zdEVxdWFscyhlZGdlKSB8fCBlZGdlc1twXS5hbG1vc3RFcXVhbHMoZWRnZSkpIHsKICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWZvdW5kKSB7CiAgICAgICAgICAgIGVkZ2VzLnB1c2goZWRnZS5jbG9uZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZSB0aGUgbm9ybWFscyBvZiB0aGUgZmFjZXMuCiAgICAgKiBXaWxsIHJldXNlIGV4aXN0aW5nIFZlYzMgb2JqZWN0cyBpbiB0aGUgYGZhY2VOb3JtYWxzYCBhcnJheSBpZiB0aGV5IGV4aXN0LgogICAgICovCgoKICAgIGNvbXB1dGVOb3JtYWxzKCkgewogICAgICB0aGlzLmZhY2VOb3JtYWxzLmxlbmd0aCA9IHRoaXMuZmFjZXMubGVuZ3RoOyAvLyBHZW5lcmF0ZSBub3JtYWxzCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZmFjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAvLyBDaGVjayBzbyBhbGwgdmVydGljZXMgZXhpc3RzIGZvciB0aGlzIGZhY2UKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRoaXMuZmFjZXNbaV0ubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmICghdGhpcy52ZXJ0aWNlc1t0aGlzLmZhY2VzW2ldW2pdXSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFZlcnRleCAke3RoaXMuZmFjZXNbaV1bal19IG5vdCBmb3VuZCFgKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNvbnN0IG4gPSB0aGlzLmZhY2VOb3JtYWxzW2ldIHx8IG5ldyBWZWMzKCk7CiAgICAgICAgdGhpcy5nZXRGYWNlTm9ybWFsKGksIG4pOwogICAgICAgIG4ubmVnYXRlKG4pOwogICAgICAgIHRoaXMuZmFjZU5vcm1hbHNbaV0gPSBuOwogICAgICAgIGNvbnN0IHZlcnRleCA9IHRoaXMudmVydGljZXNbdGhpcy5mYWNlc1tpXVswXV07CgogICAgICAgIGlmIChuLmRvdCh2ZXJ0ZXgpIDwgMCkgewogICAgICAgICAgY29uc29sZS5lcnJvcihgLmZhY2VOb3JtYWxzWyR7aX1dID0gVmVjMygke24udG9TdHJpbmcoKX0pIGxvb2tzIGxpa2UgaXQgcG9pbnRzIGludG8gdGhlIHNoYXBlPyBUaGUgdmVydGljZXMgZm9sbG93LiBNYWtlIHN1cmUgdGhleSBhcmUgb3JkZXJlZCBDQ1cgYXJvdW5kIHRoZSBub3JtYWwsIHVzaW5nIHRoZSByaWdodCBoYW5kIHJ1bGUuYCk7CgogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0aGlzLmZhY2VzW2ldLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgLnZlcnRpY2VzWyR7dGhpcy5mYWNlc1tpXVtqXX1dID0gVmVjMygke3RoaXMudmVydGljZXNbdGhpcy5mYWNlc1tpXVtqXV0udG9TdHJpbmcoKX0pYCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGUgdGhlIG5vcm1hbCBvZiBhIGZhY2UgZnJvbSBpdHMgdmVydGljZXMKICAgICAqLwoKCiAgICBnZXRGYWNlTm9ybWFsKGksIHRhcmdldCkgewogICAgICBjb25zdCBmID0gdGhpcy5mYWNlc1tpXTsKICAgICAgY29uc3QgdmEgPSB0aGlzLnZlcnRpY2VzW2ZbMF1dOwogICAgICBjb25zdCB2YiA9IHRoaXMudmVydGljZXNbZlsxXV07CiAgICAgIGNvbnN0IHZjID0gdGhpcy52ZXJ0aWNlc1tmWzJdXTsKICAgICAgQ29udmV4UG9seWhlZHJvbi5jb21wdXRlTm9ybWFsKHZhLCB2YiwgdmMsIHRhcmdldCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBmYWNlIG5vcm1hbCBnaXZlbiAzIHZlcnRpY2VzCiAgICAgKi8KCgogICAgc3RhdGljIGNvbXB1dGVOb3JtYWwodmEsIHZiLCB2YywgdGFyZ2V0KSB7CiAgICAgIGNvbnN0IGNiID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgYWIgPSBuZXcgVmVjMygpOwogICAgICB2Yi52c3ViKHZhLCBhYik7CiAgICAgIHZjLnZzdWIodmIsIGNiKTsKICAgICAgY2IuY3Jvc3MoYWIsIHRhcmdldCk7CgogICAgICBpZiAoIXRhcmdldC5pc1plcm8oKSkgewogICAgICAgIHRhcmdldC5ub3JtYWxpemUoKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBAcGFyYW0gbWluRGlzdCBDbGFtcCBkaXN0YW5jZQogICAgICogQHBhcmFtIHJlc3VsdCBUaGUgYW4gYXJyYXkgb2YgY29udGFjdCBwb2ludCBvYmplY3RzLCBzZWUgY2xpcEZhY2VBZ2FpbnN0SHVsbAogICAgICovCgoKICAgIGNsaXBBZ2FpbnN0SHVsbChwb3NBLCBxdWF0QSwgaHVsbEIsIHBvc0IsIHF1YXRCLCBzZXBhcmF0aW5nTm9ybWFsLCBtaW5EaXN0LCBtYXhEaXN0LCByZXN1bHQpIHsKICAgICAgY29uc3QgV29ybGROb3JtYWwgPSBuZXcgVmVjMygpOwogICAgICBsZXQgY2xvc2VzdEZhY2VCID0gLTE7CiAgICAgIGxldCBkbWF4ID0gLU51bWJlci5NQVhfVkFMVUU7CgogICAgICBmb3IgKGxldCBmYWNlID0gMDsgZmFjZSA8IGh1bGxCLmZhY2VzLmxlbmd0aDsgZmFjZSsrKSB7CiAgICAgICAgV29ybGROb3JtYWwuY29weShodWxsQi5mYWNlTm9ybWFsc1tmYWNlXSk7CiAgICAgICAgcXVhdEIudm11bHQoV29ybGROb3JtYWwsIFdvcmxkTm9ybWFsKTsKICAgICAgICBjb25zdCBkID0gV29ybGROb3JtYWwuZG90KHNlcGFyYXRpbmdOb3JtYWwpOwoKICAgICAgICBpZiAoZCA+IGRtYXgpIHsKICAgICAgICAgIGRtYXggPSBkOwogICAgICAgICAgY2xvc2VzdEZhY2VCID0gZmFjZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHdvcmxkVmVydHNCMSA9IFtdOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBodWxsQi5mYWNlc1tjbG9zZXN0RmFjZUJdLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgYiA9IGh1bGxCLnZlcnRpY2VzW2h1bGxCLmZhY2VzW2Nsb3Nlc3RGYWNlQl1baV1dOwogICAgICAgIGNvbnN0IHdvcmxkYiA9IG5ldyBWZWMzKCk7CiAgICAgICAgd29ybGRiLmNvcHkoYik7CiAgICAgICAgcXVhdEIudm11bHQod29ybGRiLCB3b3JsZGIpOwogICAgICAgIHBvc0IudmFkZCh3b3JsZGIsIHdvcmxkYik7CiAgICAgICAgd29ybGRWZXJ0c0IxLnB1c2god29ybGRiKTsKICAgICAgfQoKICAgICAgaWYgKGNsb3Nlc3RGYWNlQiA+PSAwKSB7CiAgICAgICAgdGhpcy5jbGlwRmFjZUFnYWluc3RIdWxsKHNlcGFyYXRpbmdOb3JtYWwsIHBvc0EsIHF1YXRBLCB3b3JsZFZlcnRzQjEsIG1pbkRpc3QsIG1heERpc3QsIHJlc3VsdCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogRmluZCB0aGUgc2VwYXJhdGluZyBheGlzIGJldHdlZW4gdGhpcyBodWxsIGFuZCBhbm90aGVyCiAgICAgKiBAcGFyYW0gdGFyZ2V0IFRoZSB0YXJnZXQgdmVjdG9yIHRvIHNhdmUgdGhlIGF4aXMgaW4KICAgICAqIEByZXR1cm4gUmV0dXJucyBmYWxzZSBpZiBhIHNlcGFyYXRpb24gaXMgZm91bmQsIGVsc2UgdHJ1ZQogICAgICovCgoKICAgIGZpbmRTZXBhcmF0aW5nQXhpcyhodWxsQiwgcG9zQSwgcXVhdEEsIHBvc0IsIHF1YXRCLCB0YXJnZXQsIGZhY2VMaXN0QSwgZmFjZUxpc3RCKSB7CiAgICAgIGNvbnN0IGZhY2VBTm9ybWFsV1MzID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgV29ybGRub3JtYWwxID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgZGVsdGFDID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3Qgd29ybGRFZGdlMCA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHdvcmxkRWRnZTEgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBDcm9zcyA9IG5ldyBWZWMzKCk7CiAgICAgIGxldCBkbWluID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgY29uc3QgaHVsbEEgPSB0aGlzOwoKICAgICAgaWYgKCFodWxsQS51bmlxdWVBeGVzKSB7CiAgICAgICAgY29uc3QgbnVtRmFjZXNBID0gZmFjZUxpc3RBID8gZmFjZUxpc3RBLmxlbmd0aCA6IGh1bGxBLmZhY2VzLmxlbmd0aDsgLy8gVGVzdCBmYWNlIG5vcm1hbHMgZnJvbSBodWxsQQoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUZhY2VzQTsgaSsrKSB7CiAgICAgICAgICBjb25zdCBmaSA9IGZhY2VMaXN0QSA/IGZhY2VMaXN0QVtpXSA6IGk7IC8vIEdldCB3b3JsZCBmYWNlIG5vcm1hbAoKICAgICAgICAgIGZhY2VBTm9ybWFsV1MzLmNvcHkoaHVsbEEuZmFjZU5vcm1hbHNbZmldKTsKICAgICAgICAgIHF1YXRBLnZtdWx0KGZhY2VBTm9ybWFsV1MzLCBmYWNlQU5vcm1hbFdTMyk7CiAgICAgICAgICBjb25zdCBkID0gaHVsbEEudGVzdFNlcEF4aXMoZmFjZUFOb3JtYWxXUzMsIGh1bGxCLCBwb3NBLCBxdWF0QSwgcG9zQiwgcXVhdEIpOwoKICAgICAgICAgIGlmIChkID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGQgPCBkbWluKSB7CiAgICAgICAgICAgIGRtaW4gPSBkOwogICAgICAgICAgICB0YXJnZXQuY29weShmYWNlQU5vcm1hbFdTMyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIFRlc3QgdW5pcXVlIGF4ZXMKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gaHVsbEEudW5pcXVlQXhlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgLy8gR2V0IHdvcmxkIGF4aXMKICAgICAgICAgIHF1YXRBLnZtdWx0KGh1bGxBLnVuaXF1ZUF4ZXNbaV0sIGZhY2VBTm9ybWFsV1MzKTsKICAgICAgICAgIGNvbnN0IGQgPSBodWxsQS50ZXN0U2VwQXhpcyhmYWNlQU5vcm1hbFdTMywgaHVsbEIsIHBvc0EsIHF1YXRBLCBwb3NCLCBxdWF0Qik7CgogICAgICAgICAgaWYgKGQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZCA8IGRtaW4pIHsKICAgICAgICAgICAgZG1pbiA9IGQ7CiAgICAgICAgICAgIHRhcmdldC5jb3B5KGZhY2VBTm9ybWFsV1MzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghaHVsbEIudW5pcXVlQXhlcykgewogICAgICAgIC8vIFRlc3QgZmFjZSBub3JtYWxzIGZyb20gaHVsbEIKICAgICAgICBjb25zdCBudW1GYWNlc0IgPSBmYWNlTGlzdEIgPyBmYWNlTGlzdEIubGVuZ3RoIDogaHVsbEIuZmFjZXMubGVuZ3RoOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUZhY2VzQjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBmaSA9IGZhY2VMaXN0QiA/IGZhY2VMaXN0QltpXSA6IGk7CiAgICAgICAgICBXb3JsZG5vcm1hbDEuY29weShodWxsQi5mYWNlTm9ybWFsc1tmaV0pOwogICAgICAgICAgcXVhdEIudm11bHQoV29ybGRub3JtYWwxLCBXb3JsZG5vcm1hbDEpOwogICAgICAgICAgY29uc3QgZCA9IGh1bGxBLnRlc3RTZXBBeGlzKFdvcmxkbm9ybWFsMSwgaHVsbEIsIHBvc0EsIHF1YXRBLCBwb3NCLCBxdWF0Qik7CgogICAgICAgICAgaWYgKGQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZCA8IGRtaW4pIHsKICAgICAgICAgICAgZG1pbiA9IGQ7CiAgICAgICAgICAgIHRhcmdldC5jb3B5KFdvcmxkbm9ybWFsMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIFRlc3QgdW5pcXVlIGF4ZXMgaW4gQgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBodWxsQi51bmlxdWVBeGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBxdWF0Qi52bXVsdChodWxsQi51bmlxdWVBeGVzW2ldLCBXb3JsZG5vcm1hbDEpOwogICAgICAgICAgY29uc3QgZCA9IGh1bGxBLnRlc3RTZXBBeGlzKFdvcmxkbm9ybWFsMSwgaHVsbEIsIHBvc0EsIHF1YXRBLCBwb3NCLCBxdWF0Qik7CgogICAgICAgICAgaWYgKGQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZCA8IGRtaW4pIHsKICAgICAgICAgICAgZG1pbiA9IGQ7CiAgICAgICAgICAgIHRhcmdldC5jb3B5KFdvcmxkbm9ybWFsMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIFRlc3QgZWRnZXMKCgogICAgICBmb3IgKGxldCBlMCA9IDA7IGUwICE9PSBodWxsQS51bmlxdWVFZGdlcy5sZW5ndGg7IGUwKyspIHsKICAgICAgICAvLyBHZXQgd29ybGQgZWRnZQogICAgICAgIHF1YXRBLnZtdWx0KGh1bGxBLnVuaXF1ZUVkZ2VzW2UwXSwgd29ybGRFZGdlMCk7CgogICAgICAgIGZvciAobGV0IGUxID0gMDsgZTEgIT09IGh1bGxCLnVuaXF1ZUVkZ2VzLmxlbmd0aDsgZTErKykgewogICAgICAgICAgLy8gR2V0IHdvcmxkIGVkZ2UgMgogICAgICAgICAgcXVhdEIudm11bHQoaHVsbEIudW5pcXVlRWRnZXNbZTFdLCB3b3JsZEVkZ2UxKTsKICAgICAgICAgIHdvcmxkRWRnZTAuY3Jvc3Mod29ybGRFZGdlMSwgQ3Jvc3MpOwoKICAgICAgICAgIGlmICghQ3Jvc3MuYWxtb3N0WmVybygpKSB7CiAgICAgICAgICAgIENyb3NzLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gaHVsbEEudGVzdFNlcEF4aXMoQ3Jvc3MsIGh1bGxCLCBwb3NBLCBxdWF0QSwgcG9zQiwgcXVhdEIpOwoKICAgICAgICAgICAgaWYgKGRpc3QgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlzdCA8IGRtaW4pIHsKICAgICAgICAgICAgICBkbWluID0gZGlzdDsKICAgICAgICAgICAgICB0YXJnZXQuY29weShDcm9zcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHBvc0IudnN1Yihwb3NBLCBkZWx0YUMpOwoKICAgICAgaWYgKGRlbHRhQy5kb3QodGFyZ2V0KSA+IDAuMCkgewogICAgICAgIHRhcmdldC5uZWdhdGUodGFyZ2V0KTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIFRlc3Qgc2VwYXJhdGluZyBheGlzIGFnYWluc3QgdHdvIGh1bGxzLiBCb3RoIGh1bGxzIGFyZSBwcm9qZWN0ZWQgb250byB0aGUgYXhpcyBhbmQgdGhlIG92ZXJsYXAgc2l6ZSBpcyByZXR1cm5lZCBpZiB0aGVyZSBpcyBvbmUuCiAgICAgKiBAcmV0dXJuIFRoZSBvdmVybGFwIGRlcHRoLCBvciBGQUxTRSBpZiBubyBwZW5ldHJhdGlvbi4KICAgICAqLwoKCiAgICB0ZXN0U2VwQXhpcyhheGlzLCBodWxsQiwgcG9zQSwgcXVhdEEsIHBvc0IsIHF1YXRCKSB7CiAgICAgIGNvbnN0IGh1bGxBID0gdGhpczsKICAgICAgQ29udmV4UG9seWhlZHJvbi5wcm9qZWN0KGh1bGxBLCBheGlzLCBwb3NBLCBxdWF0QSwgbWF4bWluQSk7CiAgICAgIENvbnZleFBvbHloZWRyb24ucHJvamVjdChodWxsQiwgYXhpcywgcG9zQiwgcXVhdEIsIG1heG1pbkIpOwogICAgICBjb25zdCBtYXhBID0gbWF4bWluQVswXTsKICAgICAgY29uc3QgbWluQSA9IG1heG1pbkFbMV07CiAgICAgIGNvbnN0IG1heEIgPSBtYXhtaW5CWzBdOwogICAgICBjb25zdCBtaW5CID0gbWF4bWluQlsxXTsKCiAgICAgIGlmIChtYXhBIDwgbWluQiB8fCBtYXhCIDwgbWluQSkgewogICAgICAgIHJldHVybiBmYWxzZTsgLy8gU2VwYXJhdGVkCiAgICAgIH0KCiAgICAgIGNvbnN0IGQwID0gbWF4QSAtIG1pbkI7CiAgICAgIGNvbnN0IGQxID0gbWF4QiAtIG1pbkE7CiAgICAgIGNvbnN0IGRlcHRoID0gZDAgPCBkMSA/IGQwIDogZDE7CiAgICAgIHJldHVybiBkZXB0aDsKICAgIH0KICAgIC8qKgogICAgICogY2FsY3VsYXRlTG9jYWxJbmVydGlhCiAgICAgKi8KCgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICAvLyBBcHByb3hpbWF0ZSB3aXRoIGJveCBpbmVydGlhCiAgICAgIC8vIEV4YWN0IGluZXJ0aWEgY2FsY3VsYXRpb24gaXMgb3ZlcmtpbGwsIGJ1dCBzZWUgaHR0cDovL2dlb21ldHJpY3Rvb2xzLmNvbS9Eb2N1bWVudGF0aW9uL1BvbHloZWRyYWxNYXNzUHJvcGVydGllcy5wZGYgZm9yIHRoZSBjb3JyZWN0IHdheSB0byBkbyBpdAogICAgICBjb25zdCBhYWJibWF4ID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgYWFiYm1pbiA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuY29tcHV0ZUxvY2FsQUFCQihhYWJibWluLCBhYWJibWF4KTsKICAgICAgY29uc3QgeCA9IGFhYmJtYXgueCAtIGFhYmJtaW4ueDsKICAgICAgY29uc3QgeSA9IGFhYmJtYXgueSAtIGFhYmJtaW4ueTsKICAgICAgY29uc3QgeiA9IGFhYmJtYXgueiAtIGFhYmJtaW4uejsKICAgICAgdGFyZ2V0LnggPSAxLjAgLyAxMi4wICogbWFzcyAqICgyICogeSAqIDIgKiB5ICsgMiAqIHogKiAyICogeik7CiAgICAgIHRhcmdldC55ID0gMS4wIC8gMTIuMCAqIG1hc3MgKiAoMiAqIHggKiAyICogeCArIDIgKiB6ICogMiAqIHopOwogICAgICB0YXJnZXQueiA9IDEuMCAvIDEyLjAgKiBtYXNzICogKDIgKiB5ICogMiAqIHkgKyAyICogeCAqIDIgKiB4KTsKICAgIH0KICAgIC8qKgogICAgICogQHBhcmFtIGZhY2VfaSBJbmRleCBvZiB0aGUgZmFjZQogICAgICovCgoKICAgIGdldFBsYW5lQ29uc3RhbnRPZkZhY2UoZmFjZV9pKSB7CiAgICAgIGNvbnN0IGYgPSB0aGlzLmZhY2VzW2ZhY2VfaV07CiAgICAgIGNvbnN0IG4gPSB0aGlzLmZhY2VOb3JtYWxzW2ZhY2VfaV07CiAgICAgIGNvbnN0IHYgPSB0aGlzLnZlcnRpY2VzW2ZbMF1dOwogICAgICBjb25zdCBjID0gLW4uZG90KHYpOwogICAgICByZXR1cm4gYzsKICAgIH0KICAgIC8qKgogICAgICogQ2xpcCBhIGZhY2UgYWdhaW5zdCBhIGh1bGwuCiAgICAgKiBAcGFyYW0gd29ybGRWZXJ0c0IxIEFuIGFycmF5IG9mIFZlYzMgd2l0aCB2ZXJ0aWNlcyBpbiB0aGUgd29ybGQgZnJhbWUuCiAgICAgKiBAcGFyYW0gbWluRGlzdCBEaXN0YW5jZSBjbGFtcGluZwogICAgICogQHBhcmFtIEFycmF5IHJlc3VsdCBBcnJheSB0byBzdG9yZSByZXN1bHRpbmcgY29udGFjdCBwb2ludHMgaW4uIFdpbGwgYmUgb2JqZWN0cyB3aXRoIHByb3BlcnRpZXM6IHBvaW50LCBkZXB0aCwgbm9ybWFsLiBUaGVzZSBhcmUgcmVwcmVzZW50ZWQgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiAgICAgKi8KCgogICAgY2xpcEZhY2VBZ2FpbnN0SHVsbChzZXBhcmF0aW5nTm9ybWFsLCBwb3NBLCBxdWF0QSwgd29ybGRWZXJ0c0IxLCBtaW5EaXN0LCBtYXhEaXN0LCByZXN1bHQpIHsKICAgICAgY29uc3QgZmFjZUFOb3JtYWxXUyA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGVkZ2UwID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgV29ybGRFZGdlMCA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHdvcmxkUGxhbmVBbm9ybWFsMSA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHBsYW5lTm9ybWFsV1MxID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3Qgd29ybGRBMSA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGxvY2FsUGxhbmVOb3JtYWwgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBwbGFuZU5vcm1hbFdTID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgaHVsbEEgPSB0aGlzOwogICAgICBjb25zdCB3b3JsZFZlcnRzQjIgPSBbXTsKICAgICAgY29uc3QgcFZ0eEluID0gd29ybGRWZXJ0c0IxOwogICAgICBjb25zdCBwVnR4T3V0ID0gd29ybGRWZXJ0c0IyOwogICAgICBsZXQgY2xvc2VzdEZhY2VBID0gLTE7CiAgICAgIGxldCBkbWluID0gTnVtYmVyLk1BWF9WQUxVRTsgLy8gRmluZCB0aGUgZmFjZSB3aXRoIG5vcm1hbCBjbG9zZXN0IHRvIHRoZSBzZXBhcmF0aW5nIGF4aXMKCiAgICAgIGZvciAobGV0IGZhY2UgPSAwOyBmYWNlIDwgaHVsbEEuZmFjZXMubGVuZ3RoOyBmYWNlKyspIHsKICAgICAgICBmYWNlQU5vcm1hbFdTLmNvcHkoaHVsbEEuZmFjZU5vcm1hbHNbZmFjZV0pOwogICAgICAgIHF1YXRBLnZtdWx0KGZhY2VBTm9ybWFsV1MsIGZhY2VBTm9ybWFsV1MpOwogICAgICAgIGNvbnN0IGQgPSBmYWNlQU5vcm1hbFdTLmRvdChzZXBhcmF0aW5nTm9ybWFsKTsKCiAgICAgICAgaWYgKGQgPCBkbWluKSB7CiAgICAgICAgICBkbWluID0gZDsKICAgICAgICAgIGNsb3Nlc3RGYWNlQSA9IGZhY2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoY2xvc2VzdEZhY2VBIDwgMCkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBHZXQgdGhlIGZhY2UgYW5kIGNvbnN0cnVjdCBjb25uZWN0ZWQgZmFjZXMKCgogICAgICBjb25zdCBwb2x5QSA9IGh1bGxBLmZhY2VzW2Nsb3Nlc3RGYWNlQV07CiAgICAgIHBvbHlBLmNvbm5lY3RlZEZhY2VzID0gW107CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGh1bGxBLmZhY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBodWxsQS5mYWNlc1tpXS5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKAogICAgICAgICAgLyogU2hhcmluZyBhIHZlcnRleCovCiAgICAgICAgICBwb2x5QS5pbmRleE9mKGh1bGxBLmZhY2VzW2ldW2pdKSAhPT0gLTEgJiYKICAgICAgICAgIC8qIE5vdCB0aGUgb25lIHdlIGFyZSBsb29raW5nIGZvciBjb25uZWN0aW9ucyBmcm9tICovCiAgICAgICAgICBpICE9PSBjbG9zZXN0RmFjZUEgJiYKICAgICAgICAgIC8qIE5vdCBhbHJlYWR5IGFkZGVkICovCiAgICAgICAgICBwb2x5QS5jb25uZWN0ZWRGYWNlcy5pbmRleE9mKGkpID09PSAtMSkgewogICAgICAgICAgICBwb2x5QS5jb25uZWN0ZWRGYWNlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvLyBDbGlwIHRoZSBwb2x5Z29uIHRvIHRoZSBiYWNrIG9mIHRoZSBwbGFuZXMgb2YgYWxsIGZhY2VzIG9mIGh1bGwgQSwKICAgICAgLy8gdGhhdCBhcmUgYWRqYWNlbnQgdG8gdGhlIHdpdG5lc3MgZmFjZQoKCiAgICAgIGNvbnN0IG51bVZlcnRpY2VzQSA9IHBvbHlBLmxlbmd0aDsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtVmVydGljZXNBOyBpKyspIHsKICAgICAgICBjb25zdCBhID0gaHVsbEEudmVydGljZXNbcG9seUFbaV1dOwogICAgICAgIGNvbnN0IGIgPSBodWxsQS52ZXJ0aWNlc1twb2x5QVsoaSArIDEpICUgbnVtVmVydGljZXNBXV07CiAgICAgICAgYS52c3ViKGIsIGVkZ2UwKTsKICAgICAgICBXb3JsZEVkZ2UwLmNvcHkoZWRnZTApOwogICAgICAgIHF1YXRBLnZtdWx0KFdvcmxkRWRnZTAsIFdvcmxkRWRnZTApOwogICAgICAgIHBvc0EudmFkZChXb3JsZEVkZ2UwLCBXb3JsZEVkZ2UwKTsKICAgICAgICB3b3JsZFBsYW5lQW5vcm1hbDEuY29weSh0aGlzLmZhY2VOb3JtYWxzW2Nsb3Nlc3RGYWNlQV0pOwogICAgICAgIHF1YXRBLnZtdWx0KHdvcmxkUGxhbmVBbm9ybWFsMSwgd29ybGRQbGFuZUFub3JtYWwxKTsKICAgICAgICBwb3NBLnZhZGQod29ybGRQbGFuZUFub3JtYWwxLCB3b3JsZFBsYW5lQW5vcm1hbDEpOwogICAgICAgIFdvcmxkRWRnZTAuY3Jvc3Mod29ybGRQbGFuZUFub3JtYWwxLCBwbGFuZU5vcm1hbFdTMSk7CiAgICAgICAgcGxhbmVOb3JtYWxXUzEubmVnYXRlKHBsYW5lTm9ybWFsV1MxKTsKICAgICAgICB3b3JsZEExLmNvcHkoYSk7CiAgICAgICAgcXVhdEEudm11bHQod29ybGRBMSwgd29ybGRBMSk7CiAgICAgICAgcG9zQS52YWRkKHdvcmxkQTEsIHdvcmxkQTEpOwogICAgICAgIGNvbnN0IG90aGVyRmFjZSA9IHBvbHlBLmNvbm5lY3RlZEZhY2VzW2ldOwogICAgICAgIGxvY2FsUGxhbmVOb3JtYWwuY29weSh0aGlzLmZhY2VOb3JtYWxzW290aGVyRmFjZV0pOwogICAgICAgIGNvbnN0IGxvY2FsUGxhbmVFcSA9IHRoaXMuZ2V0UGxhbmVDb25zdGFudE9mRmFjZShvdGhlckZhY2UpOwogICAgICAgIHBsYW5lTm9ybWFsV1MuY29weShsb2NhbFBsYW5lTm9ybWFsKTsKICAgICAgICBxdWF0QS52bXVsdChwbGFuZU5vcm1hbFdTLCBwbGFuZU5vcm1hbFdTKTsKICAgICAgICBjb25zdCBwbGFuZUVxV1MgPSBsb2NhbFBsYW5lRXEgLSBwbGFuZU5vcm1hbFdTLmRvdChwb3NBKTsgLy8gQ2xpcCBmYWNlIGFnYWluc3Qgb3VyIGNvbnN0cnVjdGVkIHBsYW5lCgogICAgICAgIHRoaXMuY2xpcEZhY2VBZ2FpbnN0UGxhbmUocFZ0eEluLCBwVnR4T3V0LCBwbGFuZU5vcm1hbFdTLCBwbGFuZUVxV1MpOyAvLyBUaHJvdyBhd2F5IGFsbCBjbGlwcGVkIHBvaW50cywgYnV0IHNhdmUgdGhlIHJlbWFpbmluZyB1bnRpbCBuZXh0IGNsaXAKCiAgICAgICAgd2hpbGUgKHBWdHhJbi5sZW5ndGgpIHsKICAgICAgICAgIHBWdHhJbi5zaGlmdCgpOwogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKHBWdHhPdXQubGVuZ3RoKSB7CiAgICAgICAgICBwVnR4SW4ucHVzaChwVnR4T3V0LnNoaWZ0KCkpOwogICAgICAgIH0KICAgICAgfSAvLyBvbmx5IGtlZXAgY29udGFjdCBwb2ludHMgdGhhdCBhcmUgYmVoaW5kIHRoZSB3aXRuZXNzIGZhY2UKCgogICAgICBsb2NhbFBsYW5lTm9ybWFsLmNvcHkodGhpcy5mYWNlTm9ybWFsc1tjbG9zZXN0RmFjZUFdKTsKICAgICAgY29uc3QgbG9jYWxQbGFuZUVxID0gdGhpcy5nZXRQbGFuZUNvbnN0YW50T2ZGYWNlKGNsb3Nlc3RGYWNlQSk7CiAgICAgIHBsYW5lTm9ybWFsV1MuY29weShsb2NhbFBsYW5lTm9ybWFsKTsKICAgICAgcXVhdEEudm11bHQocGxhbmVOb3JtYWxXUywgcGxhbmVOb3JtYWxXUyk7CiAgICAgIGNvbnN0IHBsYW5lRXFXUyA9IGxvY2FsUGxhbmVFcSAtIHBsYW5lTm9ybWFsV1MuZG90KHBvc0EpOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwVnR4SW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICBsZXQgZGVwdGggPSBwbGFuZU5vcm1hbFdTLmRvdChwVnR4SW5baV0pICsgcGxhbmVFcVdTOyAvLyA/Pz8KCiAgICAgICAgaWYgKGRlcHRoIDw9IG1pbkRpc3QpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKGBjbGFtcGVkOiBkZXB0aD0ke2RlcHRofSB0byBtaW5EaXN0PSR7bWluRGlzdH1gKTsKICAgICAgICAgIGRlcHRoID0gbWluRGlzdDsKICAgICAgICB9CgogICAgICAgIGlmIChkZXB0aCA8PSBtYXhEaXN0KSB7CiAgICAgICAgICBjb25zdCBwb2ludCA9IHBWdHhJbltpXTsKCiAgICAgICAgICBpZiAoZGVwdGggPD0gMWUtNikgewogICAgICAgICAgICBjb25zdCBwID0gewogICAgICAgICAgICAgIHBvaW50LAogICAgICAgICAgICAgIG5vcm1hbDogcGxhbmVOb3JtYWxXUywKICAgICAgICAgICAgICBkZXB0aAogICAgICAgICAgICB9OwogICAgICAgICAgICByZXN1bHQucHVzaChwKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2xpcCBhIGZhY2UgaW4gYSBodWxsIGFnYWluc3QgdGhlIGJhY2sgb2YgYSBwbGFuZS4KICAgICAqIEBwYXJhbSBwbGFuZUNvbnN0YW50IFRoZSBjb25zdGFudCBpbiB0aGUgbWF0aGVtYXRpY2FsIHBsYW5lIGVxdWF0aW9uCiAgICAgKi8KCgogICAgY2xpcEZhY2VBZ2FpbnN0UGxhbmUoaW5WZXJ0aWNlcywgb3V0VmVydGljZXMsIHBsYW5lTm9ybWFsLCBwbGFuZUNvbnN0YW50KSB7CiAgICAgIGxldCBuX2RvdF9maXJzdDsKICAgICAgbGV0IG5fZG90X2xhc3Q7CiAgICAgIGNvbnN0IG51bVZlcnRzID0gaW5WZXJ0aWNlcy5sZW5ndGg7CgogICAgICBpZiAobnVtVmVydHMgPCAyKSB7CiAgICAgICAgcmV0dXJuIG91dFZlcnRpY2VzOwogICAgICB9CgogICAgICBsZXQgZmlyc3RWZXJ0ZXggPSBpblZlcnRpY2VzW2luVmVydGljZXMubGVuZ3RoIC0gMV07CiAgICAgIGxldCBsYXN0VmVydGV4ID0gaW5WZXJ0aWNlc1swXTsKICAgICAgbl9kb3RfZmlyc3QgPSBwbGFuZU5vcm1hbC5kb3QoZmlyc3RWZXJ0ZXgpICsgcGxhbmVDb25zdGFudDsKCiAgICAgIGZvciAobGV0IHZpID0gMDsgdmkgPCBudW1WZXJ0czsgdmkrKykgewogICAgICAgIGxhc3RWZXJ0ZXggPSBpblZlcnRpY2VzW3ZpXTsKICAgICAgICBuX2RvdF9sYXN0ID0gcGxhbmVOb3JtYWwuZG90KGxhc3RWZXJ0ZXgpICsgcGxhbmVDb25zdGFudDsKCiAgICAgICAgaWYgKG5fZG90X2ZpcnN0IDwgMCkgewogICAgICAgICAgaWYgKG5fZG90X2xhc3QgPCAwKSB7CiAgICAgICAgICAgIC8vIFN0YXJ0IDwgMCwgZW5kIDwgMCwgc28gb3V0cHV0IGxhc3RWZXJ0ZXgKICAgICAgICAgICAgY29uc3QgbmV3diA9IG5ldyBWZWMzKCk7CiAgICAgICAgICAgIG5ld3YuY29weShsYXN0VmVydGV4KTsKICAgICAgICAgICAgb3V0VmVydGljZXMucHVzaChuZXd2KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFN0YXJ0IDwgMCwgZW5kID49IDAsIHNvIG91dHB1dCBpbnRlcnNlY3Rpb24KICAgICAgICAgICAgY29uc3QgbmV3diA9IG5ldyBWZWMzKCk7CiAgICAgICAgICAgIGZpcnN0VmVydGV4LmxlcnAobGFzdFZlcnRleCwgbl9kb3RfZmlyc3QgLyAobl9kb3RfZmlyc3QgLSBuX2RvdF9sYXN0KSwgbmV3dik7CiAgICAgICAgICAgIG91dFZlcnRpY2VzLnB1c2gobmV3dik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChuX2RvdF9sYXN0IDwgMCkgewogICAgICAgICAgICAvLyBTdGFydCA+PSAwLCBlbmQgPCAwIHNvIG91dHB1dCBpbnRlcnNlY3Rpb24gYW5kIGVuZAogICAgICAgICAgICBjb25zdCBuZXd2ID0gbmV3IFZlYzMoKTsKICAgICAgICAgICAgZmlyc3RWZXJ0ZXgubGVycChsYXN0VmVydGV4LCBuX2RvdF9maXJzdCAvIChuX2RvdF9maXJzdCAtIG5fZG90X2xhc3QpLCBuZXd2KTsKICAgICAgICAgICAgb3V0VmVydGljZXMucHVzaChuZXd2KTsKICAgICAgICAgICAgb3V0VmVydGljZXMucHVzaChsYXN0VmVydGV4KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZpcnN0VmVydGV4ID0gbGFzdFZlcnRleDsKICAgICAgICBuX2RvdF9maXJzdCA9IG5fZG90X2xhc3Q7CiAgICAgIH0KCiAgICAgIHJldHVybiBvdXRWZXJ0aWNlczsKICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlcyBgLndvcmxkVmVydGljZXNgIGFuZCBzZXRzIGAud29ybGRWZXJ0aWNlc05lZWRzVXBkYXRlYCB0byBmYWxzZS4KICAgICAqLwoKCiAgICBjb21wdXRlV29ybGRWZXJ0aWNlcyhwb3NpdGlvbiwgcXVhdCkgewogICAgICB3aGlsZSAodGhpcy53b3JsZFZlcnRpY2VzLmxlbmd0aCA8IHRoaXMudmVydGljZXMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy53b3JsZFZlcnRpY2VzLnB1c2gobmV3IFZlYzMoKSk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHZlcnRzID0gdGhpcy52ZXJ0aWNlczsKICAgICAgY29uc3Qgd29ybGRWZXJ0cyA9IHRoaXMud29ybGRWZXJ0aWNlczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSB0aGlzLnZlcnRpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcXVhdC52bXVsdCh2ZXJ0c1tpXSwgd29ybGRWZXJ0c1tpXSk7CiAgICAgICAgcG9zaXRpb24udmFkZCh3b3JsZFZlcnRzW2ldLCB3b3JsZFZlcnRzW2ldKTsKICAgICAgfQoKICAgICAgdGhpcy53b3JsZFZlcnRpY2VzTmVlZHNVcGRhdGUgPSBmYWxzZTsKICAgIH0KCiAgICBjb21wdXRlTG9jYWxBQUJCKGFhYmJtaW4sIGFhYmJtYXgpIHsKICAgICAgY29uc3QgdmVydGljZXMgPSB0aGlzLnZlcnRpY2VzOwogICAgICBhYWJibWluLnNldChOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFKTsKICAgICAgYWFiYm1heC5zZXQoLU51bWJlci5NQVhfVkFMVUUsIC1OdW1iZXIuTUFYX1ZBTFVFLCAtTnVtYmVyLk1BWF9WQUxVRSk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudmVydGljZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB2ID0gdmVydGljZXNbaV07CgogICAgICAgIGlmICh2LnggPCBhYWJibWluLngpIHsKICAgICAgICAgIGFhYmJtaW4ueCA9IHYueDsKICAgICAgICB9IGVsc2UgaWYgKHYueCA+IGFhYmJtYXgueCkgewogICAgICAgICAgYWFiYm1heC54ID0gdi54OwogICAgICAgIH0KCiAgICAgICAgaWYgKHYueSA8IGFhYmJtaW4ueSkgewogICAgICAgICAgYWFiYm1pbi55ID0gdi55OwogICAgICAgIH0gZWxzZSBpZiAodi55ID4gYWFiYm1heC55KSB7CiAgICAgICAgICBhYWJibWF4LnkgPSB2Lnk7CiAgICAgICAgfQoKICAgICAgICBpZiAodi56IDwgYWFiYm1pbi56KSB7CiAgICAgICAgICBhYWJibWluLnogPSB2Lno7CiAgICAgICAgfSBlbHNlIGlmICh2LnogPiBhYWJibWF4LnopIHsKICAgICAgICAgIGFhYmJtYXgueiA9IHYuejsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlcyBgd29ybGRWZXJ0aWNlc2AgYW5kIHNldHMgYHdvcmxkVmVydGljZXNOZWVkc1VwZGF0ZWAgdG8gZmFsc2UuCiAgICAgKi8KCgogICAgY29tcHV0ZVdvcmxkRmFjZU5vcm1hbHMocXVhdCkgewogICAgICBjb25zdCBOID0gdGhpcy5mYWNlTm9ybWFscy5sZW5ndGg7CgogICAgICB3aGlsZSAodGhpcy53b3JsZEZhY2VOb3JtYWxzLmxlbmd0aCA8IE4pIHsKICAgICAgICB0aGlzLndvcmxkRmFjZU5vcm1hbHMucHVzaChuZXcgVmVjMygpKTsKICAgICAgfQoKICAgICAgY29uc3Qgbm9ybWFscyA9IHRoaXMuZmFjZU5vcm1hbHM7CiAgICAgIGNvbnN0IHdvcmxkTm9ybWFscyA9IHRoaXMud29ybGRGYWNlTm9ybWFsczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBxdWF0LnZtdWx0KG5vcm1hbHNbaV0sIHdvcmxkTm9ybWFsc1tpXSk7CiAgICAgIH0KCiAgICAgIHRoaXMud29ybGRGYWNlTm9ybWFsc05lZWRzVXBkYXRlID0gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzCiAgICAgKi8KCgogICAgdXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKSB7CiAgICAgIC8vIEFzc3VtZSBwb2ludHMgYXJlIGRpc3RyaWJ1dGVkIHdpdGggbG9jYWwgKDAsMCwwKSBhcyBjZW50ZXIKICAgICAgbGV0IG1heDIgPSAwOwogICAgICBjb25zdCB2ZXJ0cyA9IHRoaXMudmVydGljZXM7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gdmVydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBub3JtMiA9IHZlcnRzW2ldLmxlbmd0aFNxdWFyZWQoKTsKCiAgICAgICAgaWYgKG5vcm0yID4gbWF4MikgewogICAgICAgICAgbWF4MiA9IG5vcm0yOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyA9IE1hdGguc3FydChtYXgyKTsKICAgIH0KICAgIC8qKgogICAgICogY2FsY3VsYXRlV29ybGRBQUJCCiAgICAgKi8KCgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgY29uc3QgdmVydHMgPSB0aGlzLnZlcnRpY2VzOwogICAgICBsZXQgbWlueDsKICAgICAgbGV0IG1pbnk7CiAgICAgIGxldCBtaW56OwogICAgICBsZXQgbWF4eDsKICAgICAgbGV0IG1heHk7CiAgICAgIGxldCBtYXh6OwogICAgICBsZXQgdGVtcFdvcmxkVmVydGV4ID0gbmV3IFZlYzMoKTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0ZW1wV29ybGRWZXJ0ZXguY29weSh2ZXJ0c1tpXSk7CiAgICAgICAgcXVhdC52bXVsdCh0ZW1wV29ybGRWZXJ0ZXgsIHRlbXBXb3JsZFZlcnRleCk7CiAgICAgICAgcG9zLnZhZGQodGVtcFdvcmxkVmVydGV4LCB0ZW1wV29ybGRWZXJ0ZXgpOwogICAgICAgIGNvbnN0IHYgPSB0ZW1wV29ybGRWZXJ0ZXg7CgogICAgICAgIGlmIChtaW54ID09PSB1bmRlZmluZWQgfHwgdi54IDwgbWlueCkgewogICAgICAgICAgbWlueCA9IHYueDsKICAgICAgICB9CgogICAgICAgIGlmIChtYXh4ID09PSB1bmRlZmluZWQgfHwgdi54ID4gbWF4eCkgewogICAgICAgICAgbWF4eCA9IHYueDsKICAgICAgICB9CgogICAgICAgIGlmIChtaW55ID09PSB1bmRlZmluZWQgfHwgdi55IDwgbWlueSkgewogICAgICAgICAgbWlueSA9IHYueTsKICAgICAgICB9CgogICAgICAgIGlmIChtYXh5ID09PSB1bmRlZmluZWQgfHwgdi55ID4gbWF4eSkgewogICAgICAgICAgbWF4eSA9IHYueTsKICAgICAgICB9CgogICAgICAgIGlmIChtaW56ID09PSB1bmRlZmluZWQgfHwgdi56IDwgbWlueikgewogICAgICAgICAgbWlueiA9IHYuejsKICAgICAgICB9CgogICAgICAgIGlmIChtYXh6ID09PSB1bmRlZmluZWQgfHwgdi56ID4gbWF4eikgewogICAgICAgICAgbWF4eiA9IHYuejsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG1pbi5zZXQobWlueCwgbWlueSwgbWlueik7CiAgICAgIG1heC5zZXQobWF4eCwgbWF4eSwgbWF4eik7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhcHByb3hpbWF0ZSBjb252ZXggdm9sdW1lCiAgICAgKi8KCgogICAgdm9sdW1lKCkgewogICAgICByZXR1cm4gNC4wICogTWF0aC5QSSAqIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgLyAzLjA7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbiBhdmVyYWdlIG9mIGFsbCB0aGUgdmVydGljZXMgcG9zaXRpb25zCiAgICAgKi8KCgogICAgZ2V0QXZlcmFnZVBvaW50TG9jYWwodGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHZlcnRzID0gdGhpcy52ZXJ0aWNlczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0YXJnZXQudmFkZCh2ZXJ0c1tpXSwgdGFyZ2V0KTsKICAgICAgfQoKICAgICAgdGFyZ2V0LnNjYWxlKDEgLyB2ZXJ0cy5sZW5ndGgsIHRhcmdldCk7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIFRyYW5zZm9ybSBhbGwgbG9jYWwgcG9pbnRzLiBXaWxsIGNoYW5nZSB0aGUgLnZlcnRpY2VzCiAgICAgKi8KCgogICAgdHJhbnNmb3JtQWxsUG9pbnRzKG9mZnNldCwgcXVhdCkgewogICAgICBjb25zdCBuID0gdGhpcy52ZXJ0aWNlcy5sZW5ndGg7CiAgICAgIGNvbnN0IHZlcnRzID0gdGhpcy52ZXJ0aWNlczsgLy8gQXBwbHkgcm90YXRpb24KCiAgICAgIGlmIChxdWF0KSB7CiAgICAgICAgLy8gUm90YXRlIHZlcnRpY2VzCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHYgPSB2ZXJ0c1tpXTsKICAgICAgICAgIHF1YXQudm11bHQodiwgdik7CiAgICAgICAgfSAvLyBSb3RhdGUgZmFjZSBub3JtYWxzCgoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZmFjZU5vcm1hbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHYgPSB0aGlzLmZhY2VOb3JtYWxzW2ldOwogICAgICAgICAgcXVhdC52bXVsdCh2LCB2KTsKICAgICAgICB9CiAgICAgICAgLyoKICAgICAgICAgICAgICAvLyBSb3RhdGUgZWRnZXMKICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLnVuaXF1ZUVkZ2VzLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgY29uc3QgdiA9IHRoaXMudW5pcXVlRWRnZXNbaV07CiAgICAgICAgICAgICAgICAgIHF1YXQudm11bHQodix2KTsKICAgICAgICAgICAgICB9Ki8KCiAgICAgIH0gLy8gQXBwbHkgb2Zmc2V0CgoKICAgICAgaWYgKG9mZnNldCkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICBjb25zdCB2ID0gdmVydHNbaV07CiAgICAgICAgICB2LnZhZGQob2Zmc2V0LCB2KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2hlY2tzIHdoZXRoZXIgcCBpcyBpbnNpZGUgdGhlIHBvbHloZWRyYS4gTXVzdCBiZSBpbiBsb2NhbCBjb29yZHMuCiAgICAgKiBUaGUgcG9pbnQgbGllcyBvdXRzaWRlIG9mIHRoZSBjb252ZXggaHVsbCBvZiB0aGUgb3RoZXIgcG9pbnRzIGlmIGFuZCBvbmx5IGlmIHRoZSBkaXJlY3Rpb24KICAgICAqIG9mIGFsbCB0aGUgdmVjdG9ycyBmcm9tIGl0IHRvIHRob3NlIG90aGVyIHBvaW50cyBhcmUgb24gbGVzcyB0aGFuIG9uZSBoYWxmIG9mIGEgc3BoZXJlIGFyb3VuZCBpdC4KICAgICAqIEBwYXJhbSBwIEEgcG9pbnQgZ2l2ZW4gaW4gbG9jYWwgY29vcmRpbmF0ZXMKICAgICAqLwoKCiAgICBwb2ludElzSW5zaWRlKHApIHsKICAgICAgY29uc3QgdmVydHMgPSB0aGlzLnZlcnRpY2VzOwogICAgICBjb25zdCBmYWNlcyA9IHRoaXMuZmFjZXM7CiAgICAgIGNvbnN0IG5vcm1hbHMgPSB0aGlzLmZhY2VOb3JtYWxzOwogICAgICBjb25zdCBwb3NpdGl2ZVJlc3VsdCA9IG51bGw7CiAgICAgIGNvbnN0IHBvaW50SW5zaWRlID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5nZXRBdmVyYWdlUG9pbnRMb2NhbChwb2ludEluc2lkZSk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZmFjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBsZXQgbiA9IG5vcm1hbHNbaV07CiAgICAgICAgY29uc3QgdiA9IHZlcnRzW2ZhY2VzW2ldWzBdXTsgLy8gV2Ugb25seSBuZWVkIG9uZSBwb2ludCBpbiB0aGUgZmFjZQogICAgICAgIC8vIFRoaXMgZG90IHByb2R1Y3QgZGV0ZXJtaW5lcyB3aGljaCBzaWRlIG9mIHRoZSBlZGdlIHRoZSBwb2ludCBpcwoKICAgICAgICBjb25zdCB2VG9QID0gbmV3IFZlYzMoKTsKICAgICAgICBwLnZzdWIodiwgdlRvUCk7CiAgICAgICAgY29uc3QgcjEgPSBuLmRvdCh2VG9QKTsKICAgICAgICBjb25zdCB2VG9Qb2ludEluc2lkZSA9IG5ldyBWZWMzKCk7CiAgICAgICAgcG9pbnRJbnNpZGUudnN1Yih2LCB2VG9Qb2ludEluc2lkZSk7CiAgICAgICAgY29uc3QgcjIgPSBuLmRvdCh2VG9Qb2ludEluc2lkZSk7CgogICAgICAgIGlmIChyMSA8IDAgJiYgcjIgPiAwIHx8IHIxID4gMCAmJiByMiA8IDApIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gRW5jb3VudGVyZWQgc29tZSBvdGhlciBzaWduLiBFeGl0LgogICAgICAgIH0KICAgICAgfSAvLyBJZiB3ZSBnb3QgaGVyZSwgYWxsIGRvdCBwcm9kdWN0cyB3ZXJlIG9mIHRoZSBzYW1lIHNpZ24uCgoKICAgICAgcmV0dXJuIHBvc2l0aXZlUmVzdWx0ID8gMSA6IC0xOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgbWF4IGFuZCBtaW4gZG90IHByb2R1Y3Qgb2YgYSBjb252ZXggaHVsbCBhdCBwb3NpdGlvbiAocG9zLHF1YXQpIHByb2plY3RlZCBvbnRvIGFuIGF4aXMuCiAgICAgKiBSZXN1bHRzIGFyZSBzYXZlZCBpbiB0aGUgYXJyYXkgbWF4bWluLgogICAgICogQHBhcmFtIHJlc3VsdCByZXN1bHRbMF0gYW5kIHJlc3VsdFsxXSB3aWxsIGJlIHNldCB0byBtYXhpbXVtIGFuZCBtaW5pbXVtLCByZXNwZWN0aXZlbHkuCiAgICAgKi8KCgogICAgc3RhdGljIHByb2plY3Qoc2hhcGUsIGF4aXMsIHBvcywgcXVhdCwgcmVzdWx0KSB7CiAgICAgIGNvbnN0IG4gPSBzaGFwZS52ZXJ0aWNlcy5sZW5ndGg7CiAgICAgIGNvbnN0IGxvY2FsQXhpcyA9IHByb2plY3RfbG9jYWxBeGlzOwogICAgICBsZXQgbWF4ID0gMDsKICAgICAgbGV0IG1pbiA9IDA7CiAgICAgIGNvbnN0IGxvY2FsT3JpZ2luID0gcHJvamVjdF9sb2NhbE9yaWdpbjsKICAgICAgY29uc3QgdnMgPSBzaGFwZS52ZXJ0aWNlczsKICAgICAgbG9jYWxPcmlnaW4uc2V0WmVybygpOyAvLyBUcmFuc2Zvcm0gdGhlIGF4aXMgdG8gbG9jYWwKCiAgICAgIFRyYW5zZm9ybS52ZWN0b3JUb0xvY2FsRnJhbWUocG9zLCBxdWF0LCBheGlzLCBsb2NhbEF4aXMpOwogICAgICBUcmFuc2Zvcm0ucG9pbnRUb0xvY2FsRnJhbWUocG9zLCBxdWF0LCBsb2NhbE9yaWdpbiwgbG9jYWxPcmlnaW4pOwogICAgICBjb25zdCBhZGQgPSBsb2NhbE9yaWdpbi5kb3QobG9jYWxBeGlzKTsKICAgICAgbWluID0gbWF4ID0gdnNbMF0uZG90KGxvY2FsQXhpcyk7CgogICAgICBmb3IgKGxldCBpID0gMTsgaSA8IG47IGkrKykgewogICAgICAgIGNvbnN0IHZhbCA9IHZzW2ldLmRvdChsb2NhbEF4aXMpOwoKICAgICAgICBpZiAodmFsID4gbWF4KSB7CiAgICAgICAgICBtYXggPSB2YWw7CiAgICAgICAgfQoKICAgICAgICBpZiAodmFsIDwgbWluKSB7CiAgICAgICAgICBtaW4gPSB2YWw7CiAgICAgICAgfQogICAgICB9CgogICAgICBtaW4gLT0gYWRkOwogICAgICBtYXggLT0gYWRkOwoKICAgICAgaWYgKG1pbiA+IG1heCkgewogICAgICAgIC8vIEluY29uc2lzdGVudCAtIHN3YXAKICAgICAgICBjb25zdCB0ZW1wID0gbWluOwogICAgICAgIG1pbiA9IG1heDsKICAgICAgICBtYXggPSB0ZW1wOwogICAgICB9IC8vIE91dHB1dAoKCiAgICAgIHJlc3VsdFswXSA9IG1heDsKICAgICAgcmVzdWx0WzFdID0gbWluOwogICAgfQoKICB9CiAgY29uc3QgbWF4bWluQSA9IFtdOwogIGNvbnN0IG1heG1pbkIgPSBbXTsKICBuZXcgVmVjMygpOwogIGNvbnN0IHByb2plY3RfbG9jYWxBeGlzID0gbmV3IFZlYzMoKTsKICBjb25zdCBwcm9qZWN0X2xvY2FsT3JpZ2luID0gbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogQSAzZCBib3ggc2hhcGUuCiAgICogQGV4YW1wbGUKICAgKiAgICAgY29uc3Qgc2l6ZSA9IDEKICAgKiAgICAgY29uc3QgaGFsZkV4dGVudHMgPSBuZXcgQ0FOTk9OLlZlYzMoc2l6ZSwgc2l6ZSwgc2l6ZSkKICAgKiAgICAgY29uc3QgYm94U2hhcGUgPSBuZXcgQ0FOTk9OLkJveChoYWxmRXh0ZW50cykKICAgKiAgICAgY29uc3QgYm94Qm9keSA9IG5ldyBDQU5OT04uQm9keSh7IG1hc3M6IDEsIHNoYXBlOiBib3hTaGFwZSB9KQogICAqICAgICB3b3JsZC5hZGRCb2R5KGJveEJvZHkpCiAgICovCiAgY2xhc3MgQm94IGV4dGVuZHMgU2hhcGUgewogICAgLyoqCiAgICAgKiBUaGUgaGFsZiBleHRlbnRzIG9mIHRoZSBib3guCiAgICAgKi8KCiAgICAvKioKICAgICAqIFVzZWQgYnkgdGhlIGNvbnRhY3QgZ2VuZXJhdG9yIHRvIG1ha2UgY29udGFjdHMgd2l0aCBvdGhlciBjb252ZXggcG9seWhlZHJhIGZvciBleGFtcGxlLgogICAgICovCiAgICBjb25zdHJ1Y3RvcihoYWxmRXh0ZW50cykgewogICAgICBzdXBlcih7CiAgICAgICAgdHlwZTogU2hhcGUudHlwZXMuQk9YCiAgICAgIH0pOwogICAgICB0aGlzLmhhbGZFeHRlbnRzID0gaGFsZkV4dGVudHM7CiAgICAgIHRoaXMuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uID0gbnVsbDsKICAgICAgdGhpcy51cGRhdGVDb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24oKTsKICAgICAgdGhpcy51cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpOwogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGVzIHRoZSBsb2NhbCBjb252ZXggcG9seWhlZHJvbiByZXByZXNlbnRhdGlvbiB1c2VkIGZvciBzb21lIGNvbGxpc2lvbnMuCiAgICAgKi8KCgogICAgdXBkYXRlQ29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uKCkgewogICAgICBjb25zdCBzeCA9IHRoaXMuaGFsZkV4dGVudHMueDsKICAgICAgY29uc3Qgc3kgPSB0aGlzLmhhbGZFeHRlbnRzLnk7CiAgICAgIGNvbnN0IHN6ID0gdGhpcy5oYWxmRXh0ZW50cy56OwogICAgICBjb25zdCBWID0gVmVjMzsKICAgICAgY29uc3QgdmVydGljZXMgPSBbbmV3IFYoLXN4LCAtc3ksIC1zeiksIG5ldyBWKHN4LCAtc3ksIC1zeiksIG5ldyBWKHN4LCBzeSwgLXN6KSwgbmV3IFYoLXN4LCBzeSwgLXN6KSwgbmV3IFYoLXN4LCAtc3ksIHN6KSwgbmV3IFYoc3gsIC1zeSwgc3opLCBuZXcgVihzeCwgc3ksIHN6KSwgbmV3IFYoLXN4LCBzeSwgc3opXTsKICAgICAgY29uc3QgZmFjZXMgPSBbWzMsIDIsIDEsIDBdLCAvLyAtegogICAgICBbNCwgNSwgNiwgN10sIC8vICt6CiAgICAgIFs1LCA0LCAwLCAxXSwgLy8gLXkKICAgICAgWzIsIDMsIDcsIDZdLCAvLyAreQogICAgICBbMCwgNCwgNywgM10sIC8vIC14CiAgICAgIFsxLCAyLCA2LCA1XSAvLyAreAogICAgICBdOwogICAgICBjb25zdCBheGVzID0gW25ldyBWKDAsIDAsIDEpLCBuZXcgVigwLCAxLCAwKSwgbmV3IFYoMSwgMCwgMCldOwogICAgICBjb25zdCBoID0gbmV3IENvbnZleFBvbHloZWRyb24oewogICAgICAgIHZlcnRpY2VzLAogICAgICAgIGZhY2VzLAogICAgICAgIGF4ZXMKICAgICAgfSk7CiAgICAgIHRoaXMuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uID0gaDsKICAgICAgaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWw7CiAgICB9CiAgICAvKioKICAgICAqIENhbGN1bGF0ZSB0aGUgaW5lcnRpYSBvZiB0aGUgYm94LgogICAgICovCgoKICAgIGNhbGN1bGF0ZUxvY2FsSW5lcnRpYShtYXNzLCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgQm94LmNhbGN1bGF0ZUluZXJ0aWEodGhpcy5oYWxmRXh0ZW50cywgbWFzcywgdGFyZ2V0KTsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KCiAgICBzdGF0aWMgY2FsY3VsYXRlSW5lcnRpYShoYWxmRXh0ZW50cywgbWFzcywgdGFyZ2V0KSB7CiAgICAgIGNvbnN0IGUgPSBoYWxmRXh0ZW50czsKICAgICAgdGFyZ2V0LnggPSAxLjAgLyAxMi4wICogbWFzcyAqICgyICogZS55ICogMiAqIGUueSArIDIgKiBlLnogKiAyICogZS56KTsKICAgICAgdGFyZ2V0LnkgPSAxLjAgLyAxMi4wICogbWFzcyAqICgyICogZS54ICogMiAqIGUueCArIDIgKiBlLnogKiAyICogZS56KTsKICAgICAgdGFyZ2V0LnogPSAxLjAgLyAxMi4wICogbWFzcyAqICgyICogZS55ICogMiAqIGUueSArIDIgKiBlLnggKiAyICogZS54KTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBib3ggNiBzaWRlIG5vcm1hbHMKICAgICAqIEBwYXJhbSBzaXhUYXJnZXRWZWN0b3JzIEFuIGFycmF5IG9mIDYgdmVjdG9ycywgdG8gc3RvcmUgdGhlIHJlc3VsdGluZyBzaWRlIG5vcm1hbHMgaW4uCiAgICAgKiBAcGFyYW0gcXVhdCBPcmllbnRhdGlvbiB0byBhcHBseSB0byB0aGUgbm9ybWFsIHZlY3RvcnMuIElmIG5vdCBwcm92aWRlZCwgdGhlIHZlY3RvcnMgd2lsbCBiZSBpbiByZXNwZWN0IHRvIHRoZSBsb2NhbCBmcmFtZS4KICAgICAqLwoKCiAgICBnZXRTaWRlTm9ybWFscyhzaXhUYXJnZXRWZWN0b3JzLCBxdWF0KSB7CiAgICAgIGNvbnN0IHNpZGVzID0gc2l4VGFyZ2V0VmVjdG9yczsKICAgICAgY29uc3QgZXggPSB0aGlzLmhhbGZFeHRlbnRzOwogICAgICBzaWRlc1swXS5zZXQoZXgueCwgMCwgMCk7CiAgICAgIHNpZGVzWzFdLnNldCgwLCBleC55LCAwKTsKICAgICAgc2lkZXNbMl0uc2V0KDAsIDAsIGV4LnopOwogICAgICBzaWRlc1szXS5zZXQoLWV4LngsIDAsIDApOwogICAgICBzaWRlc1s0XS5zZXQoMCwgLWV4LnksIDApOwogICAgICBzaWRlc1s1XS5zZXQoMCwgMCwgLWV4LnopOwoKICAgICAgaWYgKHF1YXQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBzaWRlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgcXVhdC52bXVsdChzaWRlc1tpXSwgc2lkZXNbaV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHNpZGVzOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSB2b2x1bWUgb2YgdGhlIGJveC4KICAgICAqLwoKCiAgICB2b2x1bWUoKSB7CiAgICAgIHJldHVybiA4LjAgKiB0aGlzLmhhbGZFeHRlbnRzLnggKiB0aGlzLmhhbGZFeHRlbnRzLnkgKiB0aGlzLmhhbGZFeHRlbnRzLno7CiAgICB9CiAgICAvKioKICAgICAqIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzCiAgICAgKi8KCgogICAgdXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKSB7CiAgICAgIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgPSB0aGlzLmhhbGZFeHRlbnRzLmxlbmd0aCgpOwogICAgfQogICAgLyoqCiAgICAgKiBmb3JFYWNoV29ybGRDb3JuZXIKICAgICAqLwoKCiAgICBmb3JFYWNoV29ybGRDb3JuZXIocG9zLCBxdWF0LCBjYWxsYmFjaykgewogICAgICBjb25zdCBlID0gdGhpcy5oYWxmRXh0ZW50czsKICAgICAgY29uc3QgY29ybmVycyA9IFtbZS54LCBlLnksIGUuel0sIFstZS54LCBlLnksIGUuel0sIFstZS54LCAtZS55LCBlLnpdLCBbLWUueCwgLWUueSwgLWUuel0sIFtlLngsIC1lLnksIC1lLnpdLCBbZS54LCBlLnksIC1lLnpdLCBbLWUueCwgZS55LCAtZS56XSwgW2UueCwgLWUueSwgZS56XV07CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvcm5lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICB3b3JsZENvcm5lclRlbXBQb3Muc2V0KGNvcm5lcnNbaV1bMF0sIGNvcm5lcnNbaV1bMV0sIGNvcm5lcnNbaV1bMl0pOwogICAgICAgIHF1YXQudm11bHQod29ybGRDb3JuZXJUZW1wUG9zLCB3b3JsZENvcm5lclRlbXBQb3MpOwogICAgICAgIHBvcy52YWRkKHdvcmxkQ29ybmVyVGVtcFBvcywgd29ybGRDb3JuZXJUZW1wUG9zKTsKICAgICAgICBjYWxsYmFjayh3b3JsZENvcm5lclRlbXBQb3MueCwgd29ybGRDb3JuZXJUZW1wUG9zLnksIHdvcmxkQ29ybmVyVGVtcFBvcy56KTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBjYWxjdWxhdGVXb3JsZEFBQkIKICAgICAqLwoKCiAgICBjYWxjdWxhdGVXb3JsZEFBQkIocG9zLCBxdWF0LCBtaW4sIG1heCkgewogICAgICBjb25zdCBlID0gdGhpcy5oYWxmRXh0ZW50czsKICAgICAgd29ybGRDb3JuZXJzVGVtcFswXS5zZXQoZS54LCBlLnksIGUueik7CiAgICAgIHdvcmxkQ29ybmVyc1RlbXBbMV0uc2V0KC1lLngsIGUueSwgZS56KTsKICAgICAgd29ybGRDb3JuZXJzVGVtcFsyXS5zZXQoLWUueCwgLWUueSwgZS56KTsKICAgICAgd29ybGRDb3JuZXJzVGVtcFszXS5zZXQoLWUueCwgLWUueSwgLWUueik7CiAgICAgIHdvcmxkQ29ybmVyc1RlbXBbNF0uc2V0KGUueCwgLWUueSwgLWUueik7CiAgICAgIHdvcmxkQ29ybmVyc1RlbXBbNV0uc2V0KGUueCwgZS55LCAtZS56KTsKICAgICAgd29ybGRDb3JuZXJzVGVtcFs2XS5zZXQoLWUueCwgZS55LCAtZS56KTsKICAgICAgd29ybGRDb3JuZXJzVGVtcFs3XS5zZXQoZS54LCAtZS55LCBlLnopOwogICAgICBjb25zdCB3YyA9IHdvcmxkQ29ybmVyc1RlbXBbMF07CiAgICAgIHF1YXQudm11bHQod2MsIHdjKTsKICAgICAgcG9zLnZhZGQod2MsIHdjKTsKICAgICAgbWF4LmNvcHkod2MpOwogICAgICBtaW4uY29weSh3Yyk7CgogICAgICBmb3IgKGxldCBpID0gMTsgaSA8IDg7IGkrKykgewogICAgICAgIGNvbnN0IHdjID0gd29ybGRDb3JuZXJzVGVtcFtpXTsKICAgICAgICBxdWF0LnZtdWx0KHdjLCB3Yyk7CiAgICAgICAgcG9zLnZhZGQod2MsIHdjKTsKICAgICAgICBjb25zdCB4ID0gd2MueDsKICAgICAgICBjb25zdCB5ID0gd2MueTsKICAgICAgICBjb25zdCB6ID0gd2MuejsKCiAgICAgICAgaWYgKHggPiBtYXgueCkgewogICAgICAgICAgbWF4LnggPSB4OwogICAgICAgIH0KCiAgICAgICAgaWYgKHkgPiBtYXgueSkgewogICAgICAgICAgbWF4LnkgPSB5OwogICAgICAgIH0KCiAgICAgICAgaWYgKHogPiBtYXgueikgewogICAgICAgICAgbWF4LnogPSB6OwogICAgICAgIH0KCiAgICAgICAgaWYgKHggPCBtaW4ueCkgewogICAgICAgICAgbWluLnggPSB4OwogICAgICAgIH0KCiAgICAgICAgaWYgKHkgPCBtaW4ueSkgewogICAgICAgICAgbWluLnkgPSB5OwogICAgICAgIH0KCiAgICAgICAgaWYgKHogPCBtaW4ueikgewogICAgICAgICAgbWluLnogPSB6OwogICAgICAgIH0KICAgICAgfSAvLyBHZXQgZWFjaCBheGlzIG1heAogICAgICAvLyBtaW4uc2V0KEluZmluaXR5LEluZmluaXR5LEluZmluaXR5KTsKICAgICAgLy8gbWF4LnNldCgtSW5maW5pdHksLUluZmluaXR5LC1JbmZpbml0eSk7CiAgICAgIC8vIHRoaXMuZm9yRWFjaFdvcmxkQ29ybmVyKHBvcyxxdWF0LGZ1bmN0aW9uKHgseSx6KXsKICAgICAgLy8gICAgIGlmKHggPiBtYXgueCl7CiAgICAgIC8vICAgICAgICAgbWF4LnggPSB4OwogICAgICAvLyAgICAgfQogICAgICAvLyAgICAgaWYoeSA+IG1heC55KXsKICAgICAgLy8gICAgICAgICBtYXgueSA9IHk7CiAgICAgIC8vICAgICB9CiAgICAgIC8vICAgICBpZih6ID4gbWF4LnopewogICAgICAvLyAgICAgICAgIG1heC56ID0gejsKICAgICAgLy8gICAgIH0KICAgICAgLy8gICAgIGlmKHggPCBtaW4ueCl7CiAgICAgIC8vICAgICAgICAgbWluLnggPSB4OwogICAgICAvLyAgICAgfQogICAgICAvLyAgICAgaWYoeSA8IG1pbi55KXsKICAgICAgLy8gICAgICAgICBtaW4ueSA9IHk7CiAgICAgIC8vICAgICB9CiAgICAgIC8vICAgICBpZih6IDwgbWluLnopewogICAgICAvLyAgICAgICAgIG1pbi56ID0gejsKICAgICAgLy8gICAgIH0KICAgICAgLy8gfSk7CgogICAgfQoKICB9CiAgY29uc3Qgd29ybGRDb3JuZXJUZW1wUG9zID0gbmV3IFZlYzMoKTsKICBjb25zdCB3b3JsZENvcm5lcnNUZW1wID0gW25ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCldOwoKICAvKioKICAgKiBCT0RZX1RZUEVTCiAgICovCiAgY29uc3QgQk9EWV9UWVBFUyA9IHsKICAgIC8qKiBEWU5BTUlDICovCiAgICBEWU5BTUlDOiAxLAoKICAgIC8qKiBTVEFUSUMgKi8KICAgIFNUQVRJQzogMiwKCiAgICAvKiogS0lORU1BVElDICovCiAgICBLSU5FTUFUSUM6IDQKICB9OwogIC8qKgogICAqIEJvZHlUeXBlCiAgICovCgogIC8qKgogICAqIEJPRFlfU0xFRVBfU1RBVEVTCiAgICovCiAgY29uc3QgQk9EWV9TTEVFUF9TVEFURVMgPSB7CiAgICAvKiogQVdBS0UgKi8KICAgIEFXQUtFOiAwLAoKICAgIC8qKiBTTEVFUFkgKi8KICAgIFNMRUVQWTogMSwKCiAgICAvKiogU0xFRVBJTkcgKi8KICAgIFNMRUVQSU5HOiAyCiAgfTsKICAvKioKICAgKiBCb2R5U2xlZXBTdGF0ZQogICAqLwoKICAvKioKICAgKiBCYXNlIGNsYXNzIGZvciBhbGwgYm9keSB0eXBlcy4KICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCBzaGFwZSA9IG5ldyBDQU5OT04uU3BoZXJlKDEpCiAgICogICAgIGNvbnN0IGJvZHkgPSBuZXcgQ0FOTk9OLkJvZHkoewogICAqICAgICAgIG1hc3M6IDEsCiAgICogICAgICAgc2hhcGUsCiAgICogICAgIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkoYm9keSkKICAgKi8KICBjbGFzcyBCb2R5IGV4dGVuZHMgRXZlbnRUYXJnZXQgewogICAgLyoqCiAgICAgKiBEaXNwYXRjaGVkIGFmdGVyIHR3byBib2RpZXMgY29sbGlkZS4gVGhpcyBldmVudCBpcyBkaXNwYXRjaGVkIG9uIGVhY2gKICAgICAqIG9mIHRoZSB0d28gYm9kaWVzIGludm9sdmVkIGluIHRoZSBjb2xsaXNpb24uCiAgICAgKiBAZXZlbnQgY29sbGlkZQogICAgICogQHBhcmFtIGJvZHkgVGhlIGJvZHkgdGhhdCB3YXMgaW52b2x2ZWQgaW4gdGhlIGNvbGxpc2lvbi4KICAgICAqIEBwYXJhbSBjb250YWN0IFRoZSBkZXRhaWxzIG9mIHRoZSBjb2xsaXNpb24uCiAgICAgKi8KCiAgICAvKioKICAgICAqIEEgZHluYW1pYyBib2R5IGlzIGZ1bGx5IHNpbXVsYXRlZC4gQ2FuIGJlIG1vdmVkIG1hbnVhbGx5IGJ5IHRoZSB1c2VyLCBidXQgbm9ybWFsbHkgdGhleSBtb3ZlIGFjY29yZGluZyB0byBmb3JjZXMuIEEgZHluYW1pYyBib2R5IGNhbiBjb2xsaWRlIHdpdGggYWxsIGJvZHkgdHlwZXMuIEEgZHluYW1pYyBib2R5IGFsd2F5cyBoYXMgZmluaXRlLCBub24temVybyBtYXNzLgogICAgICovCgogICAgLyoqCiAgICAgKiBBIHN0YXRpYyBib2R5IGRvZXMgbm90IG1vdmUgZHVyaW5nIHNpbXVsYXRpb24gYW5kIGJlaGF2ZXMgYXMgaWYgaXQgaGFzIGluZmluaXRlIG1hc3MuIFN0YXRpYyBib2RpZXMgY2FuIGJlIG1vdmVkIG1hbnVhbGx5IGJ5IHNldHRpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSBib2R5LiBUaGUgdmVsb2NpdHkgb2YgYSBzdGF0aWMgYm9keSBpcyBhbHdheXMgemVyby4gU3RhdGljIGJvZGllcyBkbyBub3QgY29sbGlkZSB3aXRoIG90aGVyIHN0YXRpYyBvciBraW5lbWF0aWMgYm9kaWVzLgogICAgICovCgogICAgLyoqCiAgICAgKiBBIGtpbmVtYXRpYyBib2R5IG1vdmVzIHVuZGVyIHNpbXVsYXRpb24gYWNjb3JkaW5nIHRvIGl0cyB2ZWxvY2l0eS4gVGhleSBkbyBub3QgcmVzcG9uZCB0byBmb3JjZXMuIFRoZXkgY2FuIGJlIG1vdmVkIG1hbnVhbGx5LCBidXQgbm9ybWFsbHkgYSBraW5lbWF0aWMgYm9keSBpcyBtb3ZlZCBieSBzZXR0aW5nIGl0cyB2ZWxvY2l0eS4gQSBraW5lbWF0aWMgYm9keSBiZWhhdmVzIGFzIGlmIGl0IGhhcyBpbmZpbml0ZSBtYXNzLiBLaW5lbWF0aWMgYm9kaWVzIGRvIG5vdCBjb2xsaWRlIHdpdGggb3RoZXIgc3RhdGljIG9yIGtpbmVtYXRpYyBib2RpZXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFXQUtFCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNMRUVQWQogICAgICovCgogICAgLyoqCiAgICAgKiBTTEVFUElORwogICAgICovCgogICAgLyoqCiAgICAgKiBEaXNwYXRjaGVkIGFmdGVyIGEgc2xlZXBpbmcgYm9keSBoYXMgd29rZW4gdXAuCiAgICAgKiBAZXZlbnQgd2FrZXVwCiAgICAgKi8KCiAgICAvKioKICAgICAqIERpc3BhdGNoZWQgYWZ0ZXIgYSBib2R5IGhhcyBnb25lIGluIHRvIHRoZSBzbGVlcHkgc3RhdGUuCiAgICAgKiBAZXZlbnQgc2xlZXB5CiAgICAgKi8KCiAgICAvKioKICAgICAqIERpc3BhdGNoZWQgYWZ0ZXIgYSBib2R5IGhhcyBmYWxsZW4gYXNsZWVwLgogICAgICogQGV2ZW50IHNsZWVwCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5pZCA9IEJvZHkuaWRDb3VudGVyKys7CiAgICAgIHRoaXMuaW5kZXggPSAtMTsKICAgICAgdGhpcy53b3JsZCA9IG51bGw7CiAgICAgIHRoaXMudmxhbWJkYSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuY29sbGlzaW9uRmlsdGVyR3JvdXAgPSB0eXBlb2Ygb3B0aW9ucy5jb2xsaXNpb25GaWx0ZXJHcm91cCA9PT0gJ251bWJlcicgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwIDogMTsKICAgICAgdGhpcy5jb2xsaXNpb25GaWx0ZXJNYXNrID0gdHlwZW9mIG9wdGlvbnMuY29sbGlzaW9uRmlsdGVyTWFzayA9PT0gJ251bWJlcicgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlck1hc2sgOiAtMTsKICAgICAgdGhpcy5jb2xsaXNpb25SZXNwb25zZSA9IHR5cGVvZiBvcHRpb25zLmNvbGxpc2lvblJlc3BvbnNlID09PSAnYm9vbGVhbicgPyBvcHRpb25zLmNvbGxpc2lvblJlc3BvbnNlIDogdHJ1ZTsKICAgICAgdGhpcy5wb3NpdGlvbiA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMucHJldmlvdXNQb3NpdGlvbiA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaW50ZXJwb2xhdGVkUG9zaXRpb24gPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmluaXRQb3NpdGlvbiA9IG5ldyBWZWMzKCk7CgogICAgICBpZiAob3B0aW9ucy5wb3NpdGlvbikgewogICAgICAgIHRoaXMucG9zaXRpb24uY29weShvcHRpb25zLnBvc2l0aW9uKTsKICAgICAgICB0aGlzLnByZXZpb3VzUG9zaXRpb24uY29weShvcHRpb25zLnBvc2l0aW9uKTsKICAgICAgICB0aGlzLmludGVycG9sYXRlZFBvc2l0aW9uLmNvcHkob3B0aW9ucy5wb3NpdGlvbik7CiAgICAgICAgdGhpcy5pbml0UG9zaXRpb24uY29weShvcHRpb25zLnBvc2l0aW9uKTsKICAgICAgfQoKICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBWZWMzKCk7CgogICAgICBpZiAob3B0aW9ucy52ZWxvY2l0eSkgewogICAgICAgIHRoaXMudmVsb2NpdHkuY29weShvcHRpb25zLnZlbG9jaXR5KTsKICAgICAgfQoKICAgICAgdGhpcy5pbml0VmVsb2NpdHkgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmZvcmNlID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgbWFzcyA9IHR5cGVvZiBvcHRpb25zLm1hc3MgPT09ICdudW1iZXInID8gb3B0aW9ucy5tYXNzIDogMDsKICAgICAgdGhpcy5tYXNzID0gbWFzczsKICAgICAgdGhpcy5pbnZNYXNzID0gbWFzcyA+IDAgPyAxLjAgLyBtYXNzIDogMDsKICAgICAgdGhpcy5tYXRlcmlhbCA9IG9wdGlvbnMubWF0ZXJpYWwgfHwgbnVsbDsKICAgICAgdGhpcy5saW5lYXJEYW1waW5nID0gdHlwZW9mIG9wdGlvbnMubGluZWFyRGFtcGluZyA9PT0gJ251bWJlcicgPyBvcHRpb25zLmxpbmVhckRhbXBpbmcgOiAwLjAxOwogICAgICB0aGlzLnR5cGUgPSBtYXNzIDw9IDAuMCA/IEJvZHkuU1RBVElDIDogQm9keS5EWU5BTUlDOwoKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLnR5cGUgPT09IHR5cGVvZiBCb2R5LlNUQVRJQykgewogICAgICAgIHRoaXMudHlwZSA9IG9wdGlvbnMudHlwZTsKICAgICAgfQoKICAgICAgdGhpcy5hbGxvd1NsZWVwID0gdHlwZW9mIG9wdGlvbnMuYWxsb3dTbGVlcCAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmFsbG93U2xlZXAgOiB0cnVlOwogICAgICB0aGlzLnNsZWVwU3RhdGUgPSBCb2R5LkFXQUtFOwogICAgICB0aGlzLnNsZWVwU3BlZWRMaW1pdCA9IHR5cGVvZiBvcHRpb25zLnNsZWVwU3BlZWRMaW1pdCAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLnNsZWVwU3BlZWRMaW1pdCA6IDAuMTsKICAgICAgdGhpcy5zbGVlcFRpbWVMaW1pdCA9IHR5cGVvZiBvcHRpb25zLnNsZWVwVGltZUxpbWl0ICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuc2xlZXBUaW1lTGltaXQgOiAxOwogICAgICB0aGlzLnRpbWVMYXN0U2xlZXB5ID0gMDsKICAgICAgdGhpcy53YWtlVXBBZnRlck5hcnJvd3BoYXNlID0gZmFsc2U7CiAgICAgIHRoaXMudG9ycXVlID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5xdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgdGhpcy5pbml0UXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHRoaXMucHJldmlvdXNRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgdGhpcy5pbnRlcnBvbGF0ZWRRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKCiAgICAgIGlmIChvcHRpb25zLnF1YXRlcm5pb24pIHsKICAgICAgICB0aGlzLnF1YXRlcm5pb24uY29weShvcHRpb25zLnF1YXRlcm5pb24pOwogICAgICAgIHRoaXMuaW5pdFF1YXRlcm5pb24uY29weShvcHRpb25zLnF1YXRlcm5pb24pOwogICAgICAgIHRoaXMucHJldmlvdXNRdWF0ZXJuaW9uLmNvcHkob3B0aW9ucy5xdWF0ZXJuaW9uKTsKICAgICAgICB0aGlzLmludGVycG9sYXRlZFF1YXRlcm5pb24uY29weShvcHRpb25zLnF1YXRlcm5pb24pOwogICAgICB9CgogICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBWZWMzKCk7CgogICAgICBpZiAob3B0aW9ucy5hbmd1bGFyVmVsb2NpdHkpIHsKICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5jb3B5KG9wdGlvbnMuYW5ndWxhclZlbG9jaXR5KTsKICAgICAgfQoKICAgICAgdGhpcy5pbml0QW5ndWxhclZlbG9jaXR5ID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5zaGFwZXMgPSBbXTsKICAgICAgdGhpcy5zaGFwZU9mZnNldHMgPSBbXTsKICAgICAgdGhpcy5zaGFwZU9yaWVudGF0aW9ucyA9IFtdOwogICAgICB0aGlzLmluZXJ0aWEgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmludkluZXJ0aWEgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmludkluZXJ0aWFXb3JsZCA9IG5ldyBNYXQzKCk7CiAgICAgIHRoaXMuaW52TWFzc1NvbHZlID0gMDsKICAgICAgdGhpcy5pbnZJbmVydGlhU29sdmUgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmludkluZXJ0aWFXb3JsZFNvbHZlID0gbmV3IE1hdDMoKTsKICAgICAgdGhpcy5maXhlZFJvdGF0aW9uID0gdHlwZW9mIG9wdGlvbnMuZml4ZWRSb3RhdGlvbiAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmZpeGVkUm90YXRpb24gOiBmYWxzZTsKICAgICAgdGhpcy5hbmd1bGFyRGFtcGluZyA9IHR5cGVvZiBvcHRpb25zLmFuZ3VsYXJEYW1waW5nICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuYW5ndWxhckRhbXBpbmcgOiAwLjAxOwogICAgICB0aGlzLmxpbmVhckZhY3RvciA9IG5ldyBWZWMzKDEsIDEsIDEpOwoKICAgICAgaWYgKG9wdGlvbnMubGluZWFyRmFjdG9yKSB7CiAgICAgICAgdGhpcy5saW5lYXJGYWN0b3IuY29weShvcHRpb25zLmxpbmVhckZhY3Rvcik7CiAgICAgIH0KCiAgICAgIHRoaXMuYW5ndWxhckZhY3RvciA9IG5ldyBWZWMzKDEsIDEsIDEpOwoKICAgICAgaWYgKG9wdGlvbnMuYW5ndWxhckZhY3RvcikgewogICAgICAgIHRoaXMuYW5ndWxhckZhY3Rvci5jb3B5KG9wdGlvbnMuYW5ndWxhckZhY3Rvcik7CiAgICAgIH0KCiAgICAgIHRoaXMuYWFiYiA9IG5ldyBBQUJCKCk7CiAgICAgIHRoaXMuYWFiYk5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgdGhpcy5ib3VuZGluZ1JhZGl1cyA9IDA7CiAgICAgIHRoaXMud2xhbWJkYSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaXNUcmlnZ2VyID0gQm9vbGVhbihvcHRpb25zLmlzVHJpZ2dlcik7CgogICAgICBpZiAob3B0aW9ucy5zaGFwZSkgewogICAgICAgIHRoaXMuYWRkU2hhcGUob3B0aW9ucy5zaGFwZSk7CiAgICAgIH0KCiAgICAgIHRoaXMudXBkYXRlTWFzc1Byb3BlcnRpZXMoKTsKICAgIH0KICAgIC8qKgogICAgICogV2FrZSB0aGUgYm9keSB1cC4KICAgICAqLwoKCiAgICB3YWtlVXAoKSB7CiAgICAgIGNvbnN0IHByZXZTdGF0ZSA9IHRoaXMuc2xlZXBTdGF0ZTsKICAgICAgdGhpcy5zbGVlcFN0YXRlID0gQm9keS5BV0FLRTsKICAgICAgdGhpcy53YWtlVXBBZnRlck5hcnJvd3BoYXNlID0gZmFsc2U7CgogICAgICBpZiAocHJldlN0YXRlID09PSBCb2R5LlNMRUVQSU5HKSB7CiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KEJvZHkud2FrZXVwRXZlbnQpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEZvcmNlIGJvZHkgc2xlZXAKICAgICAqLwoKCiAgICBzbGVlcCgpIHsKICAgICAgdGhpcy5zbGVlcFN0YXRlID0gQm9keS5TTEVFUElORzsKICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgdGhpcy53YWtlVXBBZnRlck5hcnJvd3BoYXNlID0gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIENhbGxlZCBldmVyeSB0aW1lc3RlcCB0byB1cGRhdGUgaW50ZXJuYWwgc2xlZXAgdGltZXIgYW5kIGNoYW5nZSBzbGVlcCBzdGF0ZSBpZiBuZWVkZWQuCiAgICAgKiBAcGFyYW0gdGltZSBUaGUgd29ybGQgdGltZSBpbiBzZWNvbmRzCiAgICAgKi8KCgogICAgc2xlZXBUaWNrKHRpbWUpIHsKICAgICAgaWYgKHRoaXMuYWxsb3dTbGVlcCkgewogICAgICAgIGNvbnN0IHNsZWVwU3RhdGUgPSB0aGlzLnNsZWVwU3RhdGU7CiAgICAgICAgY29uc3Qgc3BlZWRTcXVhcmVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcXVhcmVkKCkgKyB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcXVhcmVkKCk7CiAgICAgICAgY29uc3Qgc3BlZWRMaW1pdFNxdWFyZWQgPSB0aGlzLnNsZWVwU3BlZWRMaW1pdCAqKiAyOwoKICAgICAgICBpZiAoc2xlZXBTdGF0ZSA9PT0gQm9keS5BV0FLRSAmJiBzcGVlZFNxdWFyZWQgPCBzcGVlZExpbWl0U3F1YXJlZCkgewogICAgICAgICAgdGhpcy5zbGVlcFN0YXRlID0gQm9keS5TTEVFUFk7IC8vIFNsZWVweQoKICAgICAgICAgIHRoaXMudGltZUxhc3RTbGVlcHkgPSB0aW1lOwogICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KEJvZHkuc2xlZXB5RXZlbnQpOwogICAgICAgIH0gZWxzZSBpZiAoc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUFkgJiYgc3BlZWRTcXVhcmVkID4gc3BlZWRMaW1pdFNxdWFyZWQpIHsKICAgICAgICAgIHRoaXMud2FrZVVwKCk7IC8vIFdha2UgdXAKICAgICAgICB9IGVsc2UgaWYgKHNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBZICYmIHRpbWUgLSB0aGlzLnRpbWVMYXN0U2xlZXB5ID4gdGhpcy5zbGVlcFRpbWVMaW1pdCkgewogICAgICAgICAgdGhpcy5zbGVlcCgpOyAvLyBTbGVlcGluZwoKICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChCb2R5LnNsZWVwRXZlbnQpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBJZiB0aGUgYm9keSBpcyBzbGVlcGluZywgaXQgc2hvdWxkIGJlIGltbW92YWJsZSAvIGhhdmUgaW5maW5pdGUgbWFzcyBkdXJpbmcgc29sdmUuIFdlIHNvbHZlIGl0IGJ5IGhhdmluZyBhIHNlcGFyYXRlICJzb2x2ZSBtYXNzIi4KICAgICAqLwoKCiAgICB1cGRhdGVTb2x2ZU1hc3NQcm9wZXJ0aWVzKCkgewogICAgICBpZiAodGhpcy5zbGVlcFN0YXRlID09PSBCb2R5LlNMRUVQSU5HIHx8IHRoaXMudHlwZSA9PT0gQm9keS5LSU5FTUFUSUMpIHsKICAgICAgICB0aGlzLmludk1hc3NTb2x2ZSA9IDA7CiAgICAgICAgdGhpcy5pbnZJbmVydGlhU29sdmUuc2V0WmVybygpOwogICAgICAgIHRoaXMuaW52SW5lcnRpYVdvcmxkU29sdmUuc2V0WmVybygpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuaW52TWFzc1NvbHZlID0gdGhpcy5pbnZNYXNzOwogICAgICAgIHRoaXMuaW52SW5lcnRpYVNvbHZlLmNvcHkodGhpcy5pbnZJbmVydGlhKTsKICAgICAgICB0aGlzLmludkluZXJ0aWFXb3JsZFNvbHZlLmNvcHkodGhpcy5pbnZJbmVydGlhV29ybGQpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnQgYSB3b3JsZCBwb2ludCB0byBsb2NhbCBib2R5IGZyYW1lLgogICAgICovCgoKICAgIHBvaW50VG9Mb2NhbEZyYW1lKHdvcmxkUG9pbnQsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB3b3JsZFBvaW50LnZzdWIodGhpcy5wb3NpdGlvbiwgcmVzdWx0KTsKICAgICAgdGhpcy5xdWF0ZXJuaW9uLmNvbmp1Z2F0ZSgpLnZtdWx0KHJlc3VsdCwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydCBhIHdvcmxkIHZlY3RvciB0byBsb2NhbCBib2R5IGZyYW1lLgogICAgICovCgoKICAgIHZlY3RvclRvTG9jYWxGcmFtZSh3b3JsZFZlY3RvciwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHRoaXMucXVhdGVybmlvbi5jb25qdWdhdGUoKS52bXVsdCh3b3JsZFZlY3RvciwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydCBhIGxvY2FsIGJvZHkgcG9pbnQgdG8gd29ybGQgZnJhbWUuCiAgICAgKi8KCgogICAgcG9pbnRUb1dvcmxkRnJhbWUobG9jYWxQb2ludCwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHRoaXMucXVhdGVybmlvbi52bXVsdChsb2NhbFBvaW50LCByZXN1bHQpOwogICAgICByZXN1bHQudmFkZCh0aGlzLnBvc2l0aW9uLCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0IGEgbG9jYWwgYm9keSBwb2ludCB0byB3b3JsZCBmcmFtZS4KICAgICAqLwoKCiAgICB2ZWN0b3JUb1dvcmxkRnJhbWUobG9jYWxWZWN0b3IsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0aGlzLnF1YXRlcm5pb24udm11bHQobG9jYWxWZWN0b3IsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIEFkZCBhIHNoYXBlIHRvIHRoZSBib2R5IHdpdGggYSBsb2NhbCBvZmZzZXQgYW5kIG9yaWVudGF0aW9uLgogICAgICogQHJldHVybiBUaGUgYm9keSBvYmplY3QsIGZvciBjaGFpbmFiaWxpdHkuCiAgICAgKi8KCgogICAgYWRkU2hhcGUoc2hhcGUsIF9vZmZzZXQsIF9vcmllbnRhdGlvbikgewogICAgICBjb25zdCBvZmZzZXQgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBvcmllbnRhdGlvbiA9IG5ldyBRdWF0ZXJuaW9uKCk7CgogICAgICBpZiAoX29mZnNldCkgewogICAgICAgIG9mZnNldC5jb3B5KF9vZmZzZXQpOwogICAgICB9CgogICAgICBpZiAoX29yaWVudGF0aW9uKSB7CiAgICAgICAgb3JpZW50YXRpb24uY29weShfb3JpZW50YXRpb24pOwogICAgICB9CgogICAgICB0aGlzLnNoYXBlcy5wdXNoKHNoYXBlKTsKICAgICAgdGhpcy5zaGFwZU9mZnNldHMucHVzaChvZmZzZXQpOwogICAgICB0aGlzLnNoYXBlT3JpZW50YXRpb25zLnB1c2gob3JpZW50YXRpb24pOwogICAgICB0aGlzLnVwZGF0ZU1hc3NQcm9wZXJ0aWVzKCk7CiAgICAgIHRoaXMudXBkYXRlQm91bmRpbmdSYWRpdXMoKTsKICAgICAgdGhpcy5hYWJiTmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICBzaGFwZS5ib2R5ID0gdGhpczsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIFJlbW92ZSBhIHNoYXBlIGZyb20gdGhlIGJvZHkuCiAgICAgKiBAcmV0dXJuIFRoZSBib2R5IG9iamVjdCwgZm9yIGNoYWluYWJpbGl0eS4KICAgICAqLwoKCiAgICByZW1vdmVTaGFwZShzaGFwZSkgewogICAgICBjb25zdCBpbmRleCA9IHRoaXMuc2hhcGVzLmluZGV4T2Yoc2hhcGUpOwoKICAgICAgaWYgKGluZGV4ID09PSAtMSkgewogICAgICAgIGNvbnNvbGUud2FybignU2hhcGUgZG9lcyBub3QgYmVsb25nIHRvIHRoZSBib2R5Jyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIHRoaXMuc2hhcGVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIHRoaXMuc2hhcGVPZmZzZXRzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIHRoaXMuc2hhcGVPcmllbnRhdGlvbnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgdGhpcy51cGRhdGVNYXNzUHJvcGVydGllcygpOwogICAgICB0aGlzLnVwZGF0ZUJvdW5kaW5nUmFkaXVzKCk7CiAgICAgIHRoaXMuYWFiYk5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgc2hhcGUuYm9keSA9IG51bGw7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGUgdGhlIGJvdW5kaW5nIHJhZGl1cyBvZiB0aGUgYm9keS4gU2hvdWxkIGJlIGRvbmUgaWYgYW55IG9mIHRoZSBzaGFwZXMgYXJlIGNoYW5nZWQuCiAgICAgKi8KCgogICAgdXBkYXRlQm91bmRpbmdSYWRpdXMoKSB7CiAgICAgIGNvbnN0IHNoYXBlcyA9IHRoaXMuc2hhcGVzOwogICAgICBjb25zdCBzaGFwZU9mZnNldHMgPSB0aGlzLnNoYXBlT2Zmc2V0czsKICAgICAgY29uc3QgTiA9IHNoYXBlcy5sZW5ndGg7CiAgICAgIGxldCByYWRpdXMgPSAwOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IHNoYXBlID0gc2hhcGVzW2ldOwogICAgICAgIHNoYXBlLnVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCk7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gc2hhcGVPZmZzZXRzW2ldLmxlbmd0aCgpOwogICAgICAgIGNvbnN0IHIgPSBzaGFwZS5ib3VuZGluZ1NwaGVyZVJhZGl1czsKCiAgICAgICAgaWYgKG9mZnNldCArIHIgPiByYWRpdXMpIHsKICAgICAgICAgIHJhZGl1cyA9IG9mZnNldCArIHI7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmJvdW5kaW5nUmFkaXVzID0gcmFkaXVzOwogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGVzIHRoZSAuYWFiYgogICAgICovCgoKICAgIHVwZGF0ZUFBQkIoKSB7CiAgICAgIGNvbnN0IHNoYXBlcyA9IHRoaXMuc2hhcGVzOwogICAgICBjb25zdCBzaGFwZU9mZnNldHMgPSB0aGlzLnNoYXBlT2Zmc2V0czsKICAgICAgY29uc3Qgc2hhcGVPcmllbnRhdGlvbnMgPSB0aGlzLnNoYXBlT3JpZW50YXRpb25zOwogICAgICBjb25zdCBOID0gc2hhcGVzLmxlbmd0aDsKICAgICAgY29uc3Qgb2Zmc2V0ID0gdG1wVmVjOwogICAgICBjb25zdCBvcmllbnRhdGlvbiA9IHRtcFF1YXQ7CiAgICAgIGNvbnN0IGJvZHlRdWF0ID0gdGhpcy5xdWF0ZXJuaW9uOwogICAgICBjb25zdCBhYWJiID0gdGhpcy5hYWJiOwogICAgICBjb25zdCBzaGFwZUFBQkIgPSB1cGRhdGVBQUJCX3NoYXBlQUFCQjsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBjb25zdCBzaGFwZSA9IHNoYXBlc1tpXTsgLy8gR2V0IHNoYXBlIHdvcmxkIHBvc2l0aW9uCgogICAgICAgIGJvZHlRdWF0LnZtdWx0KHNoYXBlT2Zmc2V0c1tpXSwgb2Zmc2V0KTsKICAgICAgICBvZmZzZXQudmFkZCh0aGlzLnBvc2l0aW9uLCBvZmZzZXQpOyAvLyBHZXQgc2hhcGUgd29ybGQgcXVhdGVybmlvbgoKICAgICAgICBib2R5UXVhdC5tdWx0KHNoYXBlT3JpZW50YXRpb25zW2ldLCBvcmllbnRhdGlvbik7IC8vIEdldCBzaGFwZSBBQUJCCgogICAgICAgIHNoYXBlLmNhbGN1bGF0ZVdvcmxkQUFCQihvZmZzZXQsIG9yaWVudGF0aW9uLCBzaGFwZUFBQkIubG93ZXJCb3VuZCwgc2hhcGVBQUJCLnVwcGVyQm91bmQpOwoKICAgICAgICBpZiAoaSA9PT0gMCkgewogICAgICAgICAgYWFiYi5jb3B5KHNoYXBlQUFCQik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFhYmIuZXh0ZW5kKHNoYXBlQUFCQik7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmFhYmJOZWVkc1VwZGF0ZSA9IGZhbHNlOwogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGUgYC5pbmVydGlhV29ybGRgIGFuZCBgLmludkluZXJ0aWFXb3JsZGAKICAgICAqLwoKCiAgICB1cGRhdGVJbmVydGlhV29ybGQoZm9yY2UpIHsKICAgICAgY29uc3QgSSA9IHRoaXMuaW52SW5lcnRpYTsKCiAgICAgIGlmIChJLnggPT09IEkueSAmJiBJLnkgPT09IEkueiAmJiAhZm9yY2UpIDsgZWxzZSB7CiAgICAgICAgY29uc3QgbTEgPSB1aXdfbTE7CiAgICAgICAgY29uc3QgbTIgPSB1aXdfbTI7CiAgICAgICAgbTEuc2V0Um90YXRpb25Gcm9tUXVhdGVybmlvbih0aGlzLnF1YXRlcm5pb24pOwogICAgICAgIG0xLnRyYW5zcG9zZShtMik7CiAgICAgICAgbTEuc2NhbGUoSSwgbTEpOwogICAgICAgIG0xLm1tdWx0KG0yLCB0aGlzLmludkluZXJ0aWFXb3JsZCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQXBwbHkgZm9yY2UgdG8gYSBwb2ludCBvZiB0aGUgYm9keS4gVGhpcyBjb3VsZCBmb3IgZXhhbXBsZSBiZSBhIHBvaW50IG9uIHRoZSBCb2R5IHN1cmZhY2UuCiAgICAgKiBBcHBseWluZyBmb3JjZSB0aGlzIHdheSB3aWxsIGFkZCB0byBCb2R5LmZvcmNlIGFuZCBCb2R5LnRvcnF1ZS4KICAgICAqIEBwYXJhbSBmb3JjZSBUaGUgYW1vdW50IG9mIGZvcmNlIHRvIGFkZC4KICAgICAqIEBwYXJhbSByZWxhdGl2ZVBvaW50IEEgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIGNlbnRlciBvZiBtYXNzIHRvIGFwcGx5IHRoZSBmb3JjZSBvbi4KICAgICAqLwoKCiAgICBhcHBseUZvcmNlKGZvcmNlLCByZWxhdGl2ZVBvaW50KSB7CiAgICAgIGlmIChyZWxhdGl2ZVBvaW50ID09PSB2b2lkIDApIHsKICAgICAgICByZWxhdGl2ZVBvaW50ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgLy8gTmVlZGVkPwogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpIHsKICAgICAgICB0aGlzLndha2VVcCgpOwogICAgICB9IC8vIENvbXB1dGUgcHJvZHVjZWQgcm90YXRpb25hbCBmb3JjZQoKCiAgICAgIGNvbnN0IHJvdEZvcmNlID0gQm9keV9hcHBseUZvcmNlX3JvdEZvcmNlOwogICAgICByZWxhdGl2ZVBvaW50LmNyb3NzKGZvcmNlLCByb3RGb3JjZSk7IC8vIEFkZCBsaW5lYXIgZm9yY2UKCiAgICAgIHRoaXMuZm9yY2UudmFkZChmb3JjZSwgdGhpcy5mb3JjZSk7IC8vIEFkZCByb3RhdGlvbmFsIGZvcmNlCgogICAgICB0aGlzLnRvcnF1ZS52YWRkKHJvdEZvcmNlLCB0aGlzLnRvcnF1ZSk7CiAgICB9CiAgICAvKioKICAgICAqIEFwcGx5IGZvcmNlIHRvIGEgbG9jYWwgcG9pbnQgaW4gdGhlIGJvZHkuCiAgICAgKiBAcGFyYW0gZm9yY2UgVGhlIGZvcmNlIHZlY3RvciB0byBhcHBseSwgZGVmaW5lZCBsb2NhbGx5IGluIHRoZSBib2R5IGZyYW1lLgogICAgICogQHBhcmFtIGxvY2FsUG9pbnQgQSBsb2NhbCBwb2ludCBpbiB0aGUgYm9keSB0byBhcHBseSB0aGUgZm9yY2Ugb24uCiAgICAgKi8KCgogICAgYXBwbHlMb2NhbEZvcmNlKGxvY2FsRm9yY2UsIGxvY2FsUG9pbnQpIHsKICAgICAgaWYgKGxvY2FsUG9pbnQgPT09IHZvaWQgMCkgewogICAgICAgIGxvY2FsUG9pbnQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IHdvcmxkRm9yY2UgPSBCb2R5X2FwcGx5TG9jYWxGb3JjZV93b3JsZEZvcmNlOwogICAgICBjb25zdCByZWxhdGl2ZVBvaW50V29ybGQgPSBCb2R5X2FwcGx5TG9jYWxGb3JjZV9yZWxhdGl2ZVBvaW50V29ybGQ7IC8vIFRyYW5zZm9ybSB0aGUgZm9yY2UgdmVjdG9yIHRvIHdvcmxkIHNwYWNlCgogICAgICB0aGlzLnZlY3RvclRvV29ybGRGcmFtZShsb2NhbEZvcmNlLCB3b3JsZEZvcmNlKTsKICAgICAgdGhpcy52ZWN0b3JUb1dvcmxkRnJhbWUobG9jYWxQb2ludCwgcmVsYXRpdmVQb2ludFdvcmxkKTsKICAgICAgdGhpcy5hcHBseUZvcmNlKHdvcmxkRm9yY2UsIHJlbGF0aXZlUG9pbnRXb3JsZCk7CiAgICB9CiAgICAvKioKICAgICAqIEFwcGx5IHRvcnF1ZSB0byB0aGUgYm9keS4KICAgICAqIEBwYXJhbSB0b3JxdWUgVGhlIGFtb3VudCBvZiB0b3JxdWUgdG8gYWRkLgogICAgICovCgoKICAgIGFwcGx5VG9ycXVlKHRvcnF1ZSkgewogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpIHsKICAgICAgICB0aGlzLndha2VVcCgpOwogICAgICB9IC8vIEFkZCByb3RhdGlvbmFsIGZvcmNlCgoKICAgICAgdGhpcy50b3JxdWUudmFkZCh0b3JxdWUsIHRoaXMudG9ycXVlKTsKICAgIH0KICAgIC8qKgogICAgICogQXBwbHkgaW1wdWxzZSB0byBhIHBvaW50IG9mIHRoZSBib2R5LiBUaGlzIGNvdWxkIGZvciBleGFtcGxlIGJlIGEgcG9pbnQgb24gdGhlIEJvZHkgc3VyZmFjZS4KICAgICAqIEFuIGltcHVsc2UgaXMgYSBmb3JjZSBhZGRlZCB0byBhIGJvZHkgZHVyaW5nIGEgc2hvcnQgcGVyaW9kIG9mIHRpbWUgKGltcHVsc2UgPSBmb3JjZSAqIHRpbWUpLgogICAgICogSW1wdWxzZXMgd2lsbCBiZSBhZGRlZCB0byBCb2R5LnZlbG9jaXR5IGFuZCBCb2R5LmFuZ3VsYXJWZWxvY2l0eS4KICAgICAqIEBwYXJhbSBpbXB1bHNlIFRoZSBhbW91bnQgb2YgaW1wdWxzZSB0byBhZGQuCiAgICAgKiBAcGFyYW0gcmVsYXRpdmVQb2ludCBBIHBvaW50IHJlbGF0aXZlIHRvIHRoZSBjZW50ZXIgb2YgbWFzcyB0byBhcHBseSB0aGUgZm9yY2Ugb24uCiAgICAgKi8KCgogICAgYXBwbHlJbXB1bHNlKGltcHVsc2UsIHJlbGF0aXZlUG9pbnQpIHsKICAgICAgaWYgKHJlbGF0aXZlUG9pbnQgPT09IHZvaWQgMCkgewogICAgICAgIHJlbGF0aXZlUG9pbnQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpIHsKICAgICAgICB0aGlzLndha2VVcCgpOwogICAgICB9IC8vIENvbXB1dGUgcG9pbnQgcG9zaXRpb24gcmVsYXRpdmUgdG8gdGhlIGJvZHkgY2VudGVyCgoKICAgICAgY29uc3QgciA9IHJlbGF0aXZlUG9pbnQ7IC8vIENvbXB1dGUgcHJvZHVjZWQgY2VudHJhbCBpbXB1bHNlIHZlbG9jaXR5CgogICAgICBjb25zdCB2ZWxvID0gQm9keV9hcHBseUltcHVsc2VfdmVsbzsKICAgICAgdmVsby5jb3B5KGltcHVsc2UpOwogICAgICB2ZWxvLnNjYWxlKHRoaXMuaW52TWFzcywgdmVsbyk7IC8vIEFkZCBsaW5lYXIgaW1wdWxzZQoKICAgICAgdGhpcy52ZWxvY2l0eS52YWRkKHZlbG8sIHRoaXMudmVsb2NpdHkpOyAvLyBDb21wdXRlIHByb2R1Y2VkIHJvdGF0aW9uYWwgaW1wdWxzZSB2ZWxvY2l0eQoKICAgICAgY29uc3Qgcm90VmVsbyA9IEJvZHlfYXBwbHlJbXB1bHNlX3JvdFZlbG87CiAgICAgIHIuY3Jvc3MoaW1wdWxzZSwgcm90VmVsbyk7CiAgICAgIC8qCiAgICAgICByb3RWZWxvLnggKj0gdGhpcy5pbnZJbmVydGlhLng7CiAgICAgICByb3RWZWxvLnkgKj0gdGhpcy5pbnZJbmVydGlhLnk7CiAgICAgICByb3RWZWxvLnogKj0gdGhpcy5pbnZJbmVydGlhLno7CiAgICAgICAqLwoKICAgICAgdGhpcy5pbnZJbmVydGlhV29ybGQudm11bHQocm90VmVsbywgcm90VmVsbyk7IC8vIEFkZCByb3RhdGlvbmFsIEltcHVsc2UKCiAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnZhZGQocm90VmVsbywgdGhpcy5hbmd1bGFyVmVsb2NpdHkpOwogICAgfQogICAgLyoqCiAgICAgKiBBcHBseSBsb2NhbGx5LWRlZmluZWQgaW1wdWxzZSB0byBhIGxvY2FsIHBvaW50IGluIHRoZSBib2R5LgogICAgICogQHBhcmFtIGZvcmNlIFRoZSBmb3JjZSB2ZWN0b3IgdG8gYXBwbHksIGRlZmluZWQgbG9jYWxseSBpbiB0aGUgYm9keSBmcmFtZS4KICAgICAqIEBwYXJhbSBsb2NhbFBvaW50IEEgbG9jYWwgcG9pbnQgaW4gdGhlIGJvZHkgdG8gYXBwbHkgdGhlIGZvcmNlIG9uLgogICAgICovCgoKICAgIGFwcGx5TG9jYWxJbXB1bHNlKGxvY2FsSW1wdWxzZSwgbG9jYWxQb2ludCkgewogICAgICBpZiAobG9jYWxQb2ludCA9PT0gdm9pZCAwKSB7CiAgICAgICAgbG9jYWxQb2ludCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnR5cGUgIT09IEJvZHkuRFlOQU1JQykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3Qgd29ybGRJbXB1bHNlID0gQm9keV9hcHBseUxvY2FsSW1wdWxzZV93b3JsZEltcHVsc2U7CiAgICAgIGNvbnN0IHJlbGF0aXZlUG9pbnRXb3JsZCA9IEJvZHlfYXBwbHlMb2NhbEltcHVsc2VfcmVsYXRpdmVQb2ludDsgLy8gVHJhbnNmb3JtIHRoZSBmb3JjZSB2ZWN0b3IgdG8gd29ybGQgc3BhY2UKCiAgICAgIHRoaXMudmVjdG9yVG9Xb3JsZEZyYW1lKGxvY2FsSW1wdWxzZSwgd29ybGRJbXB1bHNlKTsKICAgICAgdGhpcy52ZWN0b3JUb1dvcmxkRnJhbWUobG9jYWxQb2ludCwgcmVsYXRpdmVQb2ludFdvcmxkKTsKICAgICAgdGhpcy5hcHBseUltcHVsc2Uod29ybGRJbXB1bHNlLCByZWxhdGl2ZVBvaW50V29ybGQpOwogICAgfQogICAgLyoqCiAgICAgKiBTaG91bGQgYmUgY2FsbGVkIHdoZW5ldmVyIHlvdSBjaGFuZ2UgdGhlIGJvZHkgc2hhcGUgb3IgbWFzcy4KICAgICAqLwoKCiAgICB1cGRhdGVNYXNzUHJvcGVydGllcygpIHsKICAgICAgY29uc3QgaGFsZkV4dGVudHMgPSBCb2R5X3VwZGF0ZU1hc3NQcm9wZXJ0aWVzX2hhbGZFeHRlbnRzOwogICAgICB0aGlzLmludk1hc3MgPSB0aGlzLm1hc3MgPiAwID8gMS4wIC8gdGhpcy5tYXNzIDogMDsKICAgICAgY29uc3QgSSA9IHRoaXMuaW5lcnRpYTsKICAgICAgY29uc3QgZml4ZWQgPSB0aGlzLmZpeGVkUm90YXRpb247IC8vIEFwcHJveGltYXRlIHdpdGggQUFCQiBib3gKCiAgICAgIHRoaXMudXBkYXRlQUFCQigpOwogICAgICBoYWxmRXh0ZW50cy5zZXQoKHRoaXMuYWFiYi51cHBlckJvdW5kLnggLSB0aGlzLmFhYmIubG93ZXJCb3VuZC54KSAvIDIsICh0aGlzLmFhYmIudXBwZXJCb3VuZC55IC0gdGhpcy5hYWJiLmxvd2VyQm91bmQueSkgLyAyLCAodGhpcy5hYWJiLnVwcGVyQm91bmQueiAtIHRoaXMuYWFiYi5sb3dlckJvdW5kLnopIC8gMik7CiAgICAgIEJveC5jYWxjdWxhdGVJbmVydGlhKGhhbGZFeHRlbnRzLCB0aGlzLm1hc3MsIEkpOwogICAgICB0aGlzLmludkluZXJ0aWEuc2V0KEkueCA+IDAgJiYgIWZpeGVkID8gMS4wIC8gSS54IDogMCwgSS55ID4gMCAmJiAhZml4ZWQgPyAxLjAgLyBJLnkgOiAwLCBJLnogPiAwICYmICFmaXhlZCA/IDEuMCAvIEkueiA6IDApOwogICAgICB0aGlzLnVwZGF0ZUluZXJ0aWFXb3JsZCh0cnVlKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHdvcmxkIHZlbG9jaXR5IG9mIGEgcG9pbnQgaW4gdGhlIGJvZHkuCiAgICAgKiBAcGFyYW0gd29ybGRQb2ludAogICAgICogQHBhcmFtIHJlc3VsdAogICAgICogQHJldHVybiBUaGUgcmVzdWx0IHZlY3Rvci4KICAgICAqLwoKCiAgICBnZXRWZWxvY2l0eUF0V29ybGRQb2ludCh3b3JsZFBvaW50LCByZXN1bHQpIHsKICAgICAgY29uc3QgciA9IG5ldyBWZWMzKCk7CiAgICAgIHdvcmxkUG9pbnQudnN1Yih0aGlzLnBvc2l0aW9uLCByKTsKICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY3Jvc3MociwgcmVzdWx0KTsKICAgICAgdGhpcy52ZWxvY2l0eS52YWRkKHJlc3VsdCwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogTW92ZSB0aGUgYm9keSBmb3J3YXJkIGluIHRpbWUuCiAgICAgKiBAcGFyYW0gZHQgVGltZSBzdGVwCiAgICAgKiBAcGFyYW0gcXVhdE5vcm1hbGl6ZSBTZXQgdG8gdHJ1ZSB0byBub3JtYWxpemUgdGhlIGJvZHkgcXVhdGVybmlvbgogICAgICogQHBhcmFtIHF1YXROb3JtYWxpemVGYXN0IElmIHRoZSBxdWF0ZXJuaW9uIHNob3VsZCBiZSBub3JtYWxpemVkIHVzaW5nICJmYXN0IiBxdWF0ZXJuaW9uIG5vcm1hbGl6YXRpb24KICAgICAqLwoKCiAgICBpbnRlZ3JhdGUoZHQsIHF1YXROb3JtYWxpemUsIHF1YXROb3JtYWxpemVGYXN0KSB7CiAgICAgIC8vIFNhdmUgcHJldmlvdXMgcG9zaXRpb24KICAgICAgdGhpcy5wcmV2aW91c1Bvc2l0aW9uLmNvcHkodGhpcy5wb3NpdGlvbik7CiAgICAgIHRoaXMucHJldmlvdXNRdWF0ZXJuaW9uLmNvcHkodGhpcy5xdWF0ZXJuaW9uKTsKCiAgICAgIGlmICghKHRoaXMudHlwZSA9PT0gQm9keS5EWU5BTUlDIHx8IHRoaXMudHlwZSA9PT0gQm9keS5LSU5FTUFUSUMpIHx8IHRoaXMuc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUElORykgewogICAgICAgIC8vIE9ubHkgZm9yIGR5bmFtaWMKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IHZlbG8gPSB0aGlzLnZlbG9jaXR5OwogICAgICBjb25zdCBhbmd1bGFyVmVsbyA9IHRoaXMuYW5ndWxhclZlbG9jaXR5OwogICAgICBjb25zdCBwb3MgPSB0aGlzLnBvc2l0aW9uOwogICAgICBjb25zdCBmb3JjZSA9IHRoaXMuZm9yY2U7CiAgICAgIGNvbnN0IHRvcnF1ZSA9IHRoaXMudG9ycXVlOwogICAgICBjb25zdCBxdWF0ID0gdGhpcy5xdWF0ZXJuaW9uOwogICAgICBjb25zdCBpbnZNYXNzID0gdGhpcy5pbnZNYXNzOwogICAgICBjb25zdCBpbnZJbmVydGlhID0gdGhpcy5pbnZJbmVydGlhV29ybGQ7CiAgICAgIGNvbnN0IGxpbmVhckZhY3RvciA9IHRoaXMubGluZWFyRmFjdG9yOwogICAgICBjb25zdCBpTWR0ID0gaW52TWFzcyAqIGR0OwogICAgICB2ZWxvLnggKz0gZm9yY2UueCAqIGlNZHQgKiBsaW5lYXJGYWN0b3IueDsKICAgICAgdmVsby55ICs9IGZvcmNlLnkgKiBpTWR0ICogbGluZWFyRmFjdG9yLnk7CiAgICAgIHZlbG8ueiArPSBmb3JjZS56ICogaU1kdCAqIGxpbmVhckZhY3Rvci56OwogICAgICBjb25zdCBlID0gaW52SW5lcnRpYS5lbGVtZW50czsKICAgICAgY29uc3QgYW5ndWxhckZhY3RvciA9IHRoaXMuYW5ndWxhckZhY3RvcjsKICAgICAgY29uc3QgdHggPSB0b3JxdWUueCAqIGFuZ3VsYXJGYWN0b3IueDsKICAgICAgY29uc3QgdHkgPSB0b3JxdWUueSAqIGFuZ3VsYXJGYWN0b3IueTsKICAgICAgY29uc3QgdHogPSB0b3JxdWUueiAqIGFuZ3VsYXJGYWN0b3IuejsKICAgICAgYW5ndWxhclZlbG8ueCArPSBkdCAqIChlWzBdICogdHggKyBlWzFdICogdHkgKyBlWzJdICogdHopOwogICAgICBhbmd1bGFyVmVsby55ICs9IGR0ICogKGVbM10gKiB0eCArIGVbNF0gKiB0eSArIGVbNV0gKiB0eik7CiAgICAgIGFuZ3VsYXJWZWxvLnogKz0gZHQgKiAoZVs2XSAqIHR4ICsgZVs3XSAqIHR5ICsgZVs4XSAqIHR6KTsgLy8gVXNlIG5ldyB2ZWxvY2l0eSAgLSBsZWFwIGZyb2cKCiAgICAgIHBvcy54ICs9IHZlbG8ueCAqIGR0OwogICAgICBwb3MueSArPSB2ZWxvLnkgKiBkdDsKICAgICAgcG9zLnogKz0gdmVsby56ICogZHQ7CiAgICAgIHF1YXQuaW50ZWdyYXRlKHRoaXMuYW5ndWxhclZlbG9jaXR5LCBkdCwgdGhpcy5hbmd1bGFyRmFjdG9yLCBxdWF0KTsKCiAgICAgIGlmIChxdWF0Tm9ybWFsaXplKSB7CiAgICAgICAgaWYgKHF1YXROb3JtYWxpemVGYXN0KSB7CiAgICAgICAgICBxdWF0Lm5vcm1hbGl6ZUZhc3QoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcXVhdC5ub3JtYWxpemUoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuYWFiYk5lZWRzVXBkYXRlID0gdHJ1ZTsgLy8gVXBkYXRlIHdvcmxkIGluZXJ0aWEKCiAgICAgIHRoaXMudXBkYXRlSW5lcnRpYVdvcmxkKCk7CiAgICB9CgogIH0KICBCb2R5LmlkQ291bnRlciA9IDA7CiAgQm9keS5DT0xMSURFX0VWRU5UX05BTUUgPSAnY29sbGlkZSc7CiAgQm9keS5EWU5BTUlDID0gQk9EWV9UWVBFUy5EWU5BTUlDOwogIEJvZHkuU1RBVElDID0gQk9EWV9UWVBFUy5TVEFUSUM7CiAgQm9keS5LSU5FTUFUSUMgPSBCT0RZX1RZUEVTLktJTkVNQVRJQzsKICBCb2R5LkFXQUtFID0gQk9EWV9TTEVFUF9TVEFURVMuQVdBS0U7CiAgQm9keS5TTEVFUFkgPSBCT0RZX1NMRUVQX1NUQVRFUy5TTEVFUFk7CiAgQm9keS5TTEVFUElORyA9IEJPRFlfU0xFRVBfU1RBVEVTLlNMRUVQSU5HOwogIEJvZHkud2FrZXVwRXZlbnQgPSB7CiAgICB0eXBlOiAnd2FrZXVwJwogIH07CiAgQm9keS5zbGVlcHlFdmVudCA9IHsKICAgIHR5cGU6ICdzbGVlcHknCiAgfTsKICBCb2R5LnNsZWVwRXZlbnQgPSB7CiAgICB0eXBlOiAnc2xlZXAnCiAgfTsKICBjb25zdCB0bXBWZWMgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFF1YXQgPSBuZXcgUXVhdGVybmlvbigpOwogIGNvbnN0IHVwZGF0ZUFBQkJfc2hhcGVBQUJCID0gbmV3IEFBQkIoKTsKICBjb25zdCB1aXdfbTEgPSBuZXcgTWF0MygpOwogIGNvbnN0IHVpd19tMiA9IG5ldyBNYXQzKCk7CiAgbmV3IE1hdDMoKTsKICBjb25zdCBCb2R5X2FwcGx5Rm9yY2Vfcm90Rm9yY2UgPSBuZXcgVmVjMygpOwogIGNvbnN0IEJvZHlfYXBwbHlMb2NhbEZvcmNlX3dvcmxkRm9yY2UgPSBuZXcgVmVjMygpOwogIGNvbnN0IEJvZHlfYXBwbHlMb2NhbEZvcmNlX3JlbGF0aXZlUG9pbnRXb3JsZCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQm9keV9hcHBseUltcHVsc2VfdmVsbyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQm9keV9hcHBseUltcHVsc2Vfcm90VmVsbyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQm9keV9hcHBseUxvY2FsSW1wdWxzZV93b3JsZEltcHVsc2UgPSBuZXcgVmVjMygpOwogIGNvbnN0IEJvZHlfYXBwbHlMb2NhbEltcHVsc2VfcmVsYXRpdmVQb2ludCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQm9keV91cGRhdGVNYXNzUHJvcGVydGllc19oYWxmRXh0ZW50cyA9IG5ldyBWZWMzKCk7CgogIC8qKgogICAqIEJhc2UgY2xhc3MgZm9yIGJyb2FkcGhhc2UgaW1wbGVtZW50YXRpb25zCiAgICogQGF1dGhvciBzY2h0ZXBwZQogICAqLwogIGNsYXNzIEJyb2FkcGhhc2UgewogICAgLyoqCiAgICAgKiBUaGUgd29ybGQgdG8gc2VhcmNoIGZvciBjb2xsaXNpb25zIGluLgogICAgICovCgogICAgLyoqCiAgICAgKiBJZiBzZXQgdG8gdHJ1ZSwgdGhlIGJyb2FkcGhhc2UgdXNlcyBib3VuZGluZyBib3hlcyBmb3IgaW50ZXJzZWN0aW9uIHRlc3RzLCBlbHNlIGl0IHVzZXMgYm91bmRpbmcgc3BoZXJlcy4KICAgICAqLwoKICAgIC8qKgogICAgICogU2V0IHRvIHRydWUgaWYgdGhlIG9iamVjdHMgaW4gdGhlIHdvcmxkIG1vdmVkLgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy53b3JsZCA9IG51bGw7CiAgICAgIHRoaXMudXNlQm91bmRpbmdCb3hlcyA9IGZhbHNlOwogICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBjb2xsaXNpb24gcGFpcnMgZnJvbSB0aGUgd29ybGQKICAgICAqIEBwYXJhbSB3b3JsZCBUaGUgd29ybGQgdG8gc2VhcmNoIGluCiAgICAgKiBAcGFyYW0gcDEgRW1wdHkgYXJyYXkgdG8gYmUgZmlsbGVkIHdpdGggYm9keSBvYmplY3RzCiAgICAgKiBAcGFyYW0gcDIgRW1wdHkgYXJyYXkgdG8gYmUgZmlsbGVkIHdpdGggYm9keSBvYmplY3RzCiAgICAgKi8KCgogICAgY29sbGlzaW9uUGFpcnMod29ybGQsIHAxLCBwMikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvbGxpc2lvblBhaXJzIG5vdCBpbXBsZW1lbnRlZCBmb3IgdGhpcyBCcm9hZFBoYXNlIGNsYXNzIScpOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVjayBpZiBhIGJvZHkgcGFpciBuZWVkcyB0byBiZSBpbnRlcnNlY3Rpb24gdGVzdGVkIGF0IGFsbC4KICAgICAqLwoKCiAgICBuZWVkQnJvYWRwaGFzZUNvbGxpc2lvbihib2R5QSwgYm9keUIpIHsKICAgICAgLy8gQ2hlY2sgY29sbGlzaW9uIGZpbHRlciBtYXNrcwogICAgICBpZiAoKGJvZHlBLmNvbGxpc2lvbkZpbHRlckdyb3VwICYgYm9keUIuY29sbGlzaW9uRmlsdGVyTWFzaykgPT09IDAgfHwgKGJvZHlCLmNvbGxpc2lvbkZpbHRlckdyb3VwICYgYm9keUEuY29sbGlzaW9uRmlsdGVyTWFzaykgPT09IDApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy8gQ2hlY2sgdHlwZXMKCgogICAgICBpZiAoKChib2R5QS50eXBlICYgQm9keS5TVEFUSUMpICE9PSAwIHx8IGJvZHlBLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpICYmICgoYm9keUIudHlwZSAmIEJvZHkuU1RBVElDKSAhPT0gMCB8fCBib2R5Qi5zbGVlcFN0YXRlID09PSBCb2R5LlNMRUVQSU5HKSkgewogICAgICAgIC8vIEJvdGggYm9kaWVzIGFyZSBzdGF0aWMgb3Igc2xlZXBpbmcuIFNraXAuCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIGJvdW5kaW5nIHZvbHVtZXMgb2YgdHdvIGJvZGllcyBpbnRlcnNlY3QuCiAgICAgKi8KCgogICAgaW50ZXJzZWN0aW9uVGVzdChib2R5QSwgYm9keUIsIHBhaXJzMSwgcGFpcnMyKSB7CiAgICAgIGlmICh0aGlzLnVzZUJvdW5kaW5nQm94ZXMpIHsKICAgICAgICB0aGlzLmRvQm91bmRpbmdCb3hCcm9hZHBoYXNlKGJvZHlBLCBib2R5QiwgcGFpcnMxLCBwYWlyczIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZG9Cb3VuZGluZ1NwaGVyZUJyb2FkcGhhc2UoYm9keUEsIGJvZHlCLCBwYWlyczEsIHBhaXJzMik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIGJvdW5kaW5nIHNwaGVyZXMgb2YgdHdvIGJvZGllcyBhcmUgaW50ZXJzZWN0aW5nLgogICAgICogQHBhcmFtIHBhaXJzMSBib2R5QSBpcyBhcHBlbmRlZCB0byB0aGlzIGFycmF5IGlmIGludGVyc2VjdGlvbgogICAgICogQHBhcmFtIHBhaXJzMiBib2R5QiBpcyBhcHBlbmRlZCB0byB0aGlzIGFycmF5IGlmIGludGVyc2VjdGlvbgogICAgICovCgoKICAgIGRvQm91bmRpbmdTcGhlcmVCcm9hZHBoYXNlKGJvZHlBLCBib2R5QiwgcGFpcnMxLCBwYWlyczIpIHsKICAgICAgY29uc3QgciA9IEJyb2FkcGhhc2VfY29sbGlzaW9uUGFpcnNfcjsKICAgICAgYm9keUIucG9zaXRpb24udnN1Yihib2R5QS5wb3NpdGlvbiwgcik7CiAgICAgIGNvbnN0IGJvdW5kaW5nUmFkaXVzU3VtMiA9IChib2R5QS5ib3VuZGluZ1JhZGl1cyArIGJvZHlCLmJvdW5kaW5nUmFkaXVzKSAqKiAyOwogICAgICBjb25zdCBub3JtMiA9IHIubGVuZ3RoU3F1YXJlZCgpOwoKICAgICAgaWYgKG5vcm0yIDwgYm91bmRpbmdSYWRpdXNTdW0yKSB7CiAgICAgICAgcGFpcnMxLnB1c2goYm9keUEpOwogICAgICAgIHBhaXJzMi5wdXNoKGJvZHlCKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgYm91bmRpbmcgYm94ZXMgb2YgdHdvIGJvZGllcyBhcmUgaW50ZXJzZWN0aW5nLgogICAgICovCgoKICAgIGRvQm91bmRpbmdCb3hCcm9hZHBoYXNlKGJvZHlBLCBib2R5QiwgcGFpcnMxLCBwYWlyczIpIHsKICAgICAgaWYgKGJvZHlBLmFhYmJOZWVkc1VwZGF0ZSkgewogICAgICAgIGJvZHlBLnVwZGF0ZUFBQkIoKTsKICAgICAgfQoKICAgICAgaWYgKGJvZHlCLmFhYmJOZWVkc1VwZGF0ZSkgewogICAgICAgIGJvZHlCLnVwZGF0ZUFBQkIoKTsKICAgICAgfSAvLyBDaGVjayBBQUJCIC8gQUFCQgoKCiAgICAgIGlmIChib2R5QS5hYWJiLm92ZXJsYXBzKGJvZHlCLmFhYmIpKSB7CiAgICAgICAgcGFpcnMxLnB1c2goYm9keUEpOwogICAgICAgIHBhaXJzMi5wdXNoKGJvZHlCKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmVzIGR1cGxpY2F0ZSBwYWlycyBmcm9tIHRoZSBwYWlyIGFycmF5cy4KICAgICAqLwoKCiAgICBtYWtlUGFpcnNVbmlxdWUocGFpcnMxLCBwYWlyczIpIHsKICAgICAgY29uc3QgdCA9IEJyb2FkcGhhc2VfbWFrZVBhaXJzVW5pcXVlX3RlbXA7CiAgICAgIGNvbnN0IHAxID0gQnJvYWRwaGFzZV9tYWtlUGFpcnNVbmlxdWVfcDE7CiAgICAgIGNvbnN0IHAyID0gQnJvYWRwaGFzZV9tYWtlUGFpcnNVbmlxdWVfcDI7CiAgICAgIGNvbnN0IE4gPSBwYWlyczEubGVuZ3RoOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIHAxW2ldID0gcGFpcnMxW2ldOwogICAgICAgIHAyW2ldID0gcGFpcnMyW2ldOwogICAgICB9CgogICAgICBwYWlyczEubGVuZ3RoID0gMDsKICAgICAgcGFpcnMyLmxlbmd0aCA9IDA7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgY29uc3QgaWQxID0gcDFbaV0uaWQ7CiAgICAgICAgY29uc3QgaWQyID0gcDJbaV0uaWQ7CiAgICAgICAgY29uc3Qga2V5ID0gaWQxIDwgaWQyID8gYCR7aWQxfSwke2lkMn1gIDogYCR7aWQyfSwke2lkMX1gOwogICAgICAgIHRba2V5XSA9IGk7CiAgICAgICAgdC5rZXlzLnB1c2goa2V5KTsKICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IHQua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGtleSA9IHQua2V5cy5wb3AoKTsKICAgICAgICBjb25zdCBwYWlySW5kZXggPSB0W2tleV07CiAgICAgICAgcGFpcnMxLnB1c2gocDFbcGFpckluZGV4XSk7CiAgICAgICAgcGFpcnMyLnB1c2gocDJbcGFpckluZGV4XSk7CiAgICAgICAgZGVsZXRlIHRba2V5XTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBUbyBiZSBpbXBsZW1lbnRlZCBieSBzdWJjYXNzZXMKICAgICAqLwoKCiAgICBzZXRXb3JsZCh3b3JsZCkge30KICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIGJvdW5kaW5nIHNwaGVyZXMgb2YgdHdvIGJvZGllcyBvdmVybGFwLgogICAgICovCgoKICAgIHN0YXRpYyBib3VuZGluZ1NwaGVyZUNoZWNrKGJvZHlBLCBib2R5QikgewogICAgICBjb25zdCBkaXN0ID0gbmV3IFZlYzMoKTsgLy8gYnNjX2Rpc3Q7CgogICAgICBib2R5QS5wb3NpdGlvbi52c3ViKGJvZHlCLnBvc2l0aW9uLCBkaXN0KTsKICAgICAgY29uc3Qgc2EgPSBib2R5QS5zaGFwZXNbMF07CiAgICAgIGNvbnN0IHNiID0gYm9keUIuc2hhcGVzWzBdOwogICAgICByZXR1cm4gTWF0aC5wb3coc2EuYm91bmRpbmdTcGhlcmVSYWRpdXMgKyBzYi5ib3VuZGluZ1NwaGVyZVJhZGl1cywgMikgPiBkaXN0Lmxlbmd0aFNxdWFyZWQoKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhbGwgdGhlIGJvZGllcyB3aXRoaW4gdGhlIEFBQkIuCiAgICAgKi8KCgogICAgYWFiYlF1ZXJ5KHdvcmxkLCBhYWJiLCByZXN1bHQpIHsKICAgICAgY29uc29sZS53YXJuKCcuYWFiYlF1ZXJ5IGlzIG5vdCBpbXBsZW1lbnRlZCBpbiB0aGlzIEJyb2FkcGhhc2Ugc3ViY2xhc3MuJyk7CiAgICAgIHJldHVybiBbXTsKICAgIH0KCiAgfSAvLyBUZW1wIG9iamVjdHMKCiAgY29uc3QgQnJvYWRwaGFzZV9jb2xsaXNpb25QYWlyc19yID0gbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIG5ldyBRdWF0ZXJuaW9uKCk7CiAgbmV3IFZlYzMoKTsKICBjb25zdCBCcm9hZHBoYXNlX21ha2VQYWlyc1VuaXF1ZV90ZW1wID0gewogICAga2V5czogW10KICB9OwogIGNvbnN0IEJyb2FkcGhhc2VfbWFrZVBhaXJzVW5pcXVlX3AxID0gW107CiAgY29uc3QgQnJvYWRwaGFzZV9tYWtlUGFpcnNVbmlxdWVfcDIgPSBbXTsKICBuZXcgVmVjMygpOwogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogTmFpdmUgYnJvYWRwaGFzZSBpbXBsZW1lbnRhdGlvbiwgdXNlZCBpbiBsYWNrIG9mIGJldHRlciBvbmVzLgogICAqCiAgICogVGhlIG5haXZlIGJyb2FkcGhhc2UgbG9va3MgYXQgYWxsIHBvc3NpYmxlIHBhaXJzIHdpdGhvdXQgcmVzdHJpY3Rpb24sIHRoZXJlZm9yZSBpdCBoYXMgY29tcGxleGl0eSBOXjIgXyh3aGljaCBpcyBiYWQpXwogICAqLwogIGNsYXNzIE5haXZlQnJvYWRwaGFzZSBleHRlbmRzIEJyb2FkcGhhc2UgewogICAgLyoqCiAgICAgKiBAdG9kbyBSZW1vdmUgdXNlbGVzcyBjb25zdHJ1Y3RvcgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgc3VwZXIoKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGFsbCB0aGUgY29sbGlzaW9uIHBhaXJzIGluIHRoZSBwaHlzaWNzIHdvcmxkCiAgICAgKi8KCgogICAgY29sbGlzaW9uUGFpcnMod29ybGQsIHBhaXJzMSwgcGFpcnMyKSB7CiAgICAgIGNvbnN0IGJvZGllcyA9IHdvcmxkLmJvZGllczsKICAgICAgY29uc3QgbiA9IGJvZGllcy5sZW5ndGg7CiAgICAgIGxldCBiaTsKICAgICAgbGV0IGJqOyAvLyBOYWl2ZSBOXjIgZnR3IQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IG47IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSBpOyBqKyspIHsKICAgICAgICAgIGJpID0gYm9kaWVzW2ldOwogICAgICAgICAgYmogPSBib2RpZXNbal07CgogICAgICAgICAgaWYgKCF0aGlzLm5lZWRCcm9hZHBoYXNlQ29sbGlzaW9uKGJpLCBiaikpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5pbnRlcnNlY3Rpb25UZXN0KGJpLCBiaiwgcGFpcnMxLCBwYWlyczIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGFsbCB0aGUgYm9kaWVzIHdpdGhpbiBhbiBBQUJCLgogICAgICogQHBhcmFtIHJlc3VsdCBBbiBhcnJheSB0byBzdG9yZSByZXN1bHRpbmcgYm9kaWVzIGluLgogICAgICovCgoKICAgIGFhYmJRdWVyeSh3b3JsZCwgYWFiYiwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IFtdOwogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdvcmxkLmJvZGllcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGIgPSB3b3JsZC5ib2RpZXNbaV07CgogICAgICAgIGlmIChiLmFhYmJOZWVkc1VwZGF0ZSkgewogICAgICAgICAgYi51cGRhdGVBQUJCKCk7CiAgICAgICAgfSAvLyBVZ2x5IGhhY2sgdW50aWwgQm9keSBnZXRzIGFhYmIKCgogICAgICAgIGlmIChiLmFhYmIub3ZlcmxhcHMoYWFiYikpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKGIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgfQoKICAvKioKICAgKiBTdG9yYWdlIGZvciBSYXkgY2FzdGluZyBkYXRhCiAgICovCiAgY2xhc3MgUmF5Y2FzdFJlc3VsdCB7CiAgICAvKioKICAgICAqIHJheUZyb21Xb3JsZAogICAgICovCgogICAgLyoqCiAgICAgKiByYXlUb1dvcmxkCiAgICAgKi8KCiAgICAvKioKICAgICAqIGhpdE5vcm1hbFdvcmxkCiAgICAgKi8KCiAgICAvKioKICAgICAqIGhpdFBvaW50V29ybGQKICAgICAqLwoKICAgIC8qKgogICAgICogaGFzSGl0CiAgICAgKi8KCiAgICAvKioKICAgICAqIHNoYXBlCiAgICAgKi8KCiAgICAvKioKICAgICAqIGJvZHkKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGluZGV4IG9mIHRoZSBoaXQgdHJpYW5nbGUsIGlmIHRoZSBoaXQgc2hhcGUgd2FzIGEgdHJpbWVzaAogICAgICovCgogICAgLyoqCiAgICAgKiBEaXN0YW5jZSB0byB0aGUgaGl0LiBXaWxsIGJlIHNldCB0byAtMSBpZiB0aGVyZSB3YXMgbm8gaGl0CiAgICAgKi8KCiAgICAvKioKICAgICAqIElmIHRoZSByYXkgc2hvdWxkIHN0b3AgdHJhdmVyc2luZyB0aGUgYm9kaWVzCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKCkgewogICAgICB0aGlzLnJheUZyb21Xb3JsZCA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMucmF5VG9Xb3JsZCA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaGl0Tm9ybWFsV29ybGQgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmhpdFBvaW50V29ybGQgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmhhc0hpdCA9IGZhbHNlOwogICAgICB0aGlzLnNoYXBlID0gbnVsbDsKICAgICAgdGhpcy5ib2R5ID0gbnVsbDsKICAgICAgdGhpcy5oaXRGYWNlSW5kZXggPSAtMTsKICAgICAgdGhpcy5kaXN0YW5jZSA9IC0xOwogICAgICB0aGlzLnNob3VsZFN0b3AgPSBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogUmVzZXQgYWxsIHJlc3VsdCBkYXRhLgogICAgICovCgoKICAgIHJlc2V0KCkgewogICAgICB0aGlzLnJheUZyb21Xb3JsZC5zZXRaZXJvKCk7CiAgICAgIHRoaXMucmF5VG9Xb3JsZC5zZXRaZXJvKCk7CiAgICAgIHRoaXMuaGl0Tm9ybWFsV29ybGQuc2V0WmVybygpOwogICAgICB0aGlzLmhpdFBvaW50V29ybGQuc2V0WmVybygpOwogICAgICB0aGlzLmhhc0hpdCA9IGZhbHNlOwogICAgICB0aGlzLnNoYXBlID0gbnVsbDsKICAgICAgdGhpcy5ib2R5ID0gbnVsbDsKICAgICAgdGhpcy5oaXRGYWNlSW5kZXggPSAtMTsKICAgICAgdGhpcy5kaXN0YW5jZSA9IC0xOwogICAgICB0aGlzLnNob3VsZFN0b3AgPSBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogYWJvcnQKICAgICAqLwoKCiAgICBhYm9ydCgpIHsKICAgICAgdGhpcy5zaG91bGRTdG9wID0gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHJlc3VsdCBkYXRhLgogICAgICovCgoKICAgIHNldChyYXlGcm9tV29ybGQsIHJheVRvV29ybGQsIGhpdE5vcm1hbFdvcmxkLCBoaXRQb2ludFdvcmxkLCBzaGFwZSwgYm9keSwgZGlzdGFuY2UpIHsKICAgICAgdGhpcy5yYXlGcm9tV29ybGQuY29weShyYXlGcm9tV29ybGQpOwogICAgICB0aGlzLnJheVRvV29ybGQuY29weShyYXlUb1dvcmxkKTsKICAgICAgdGhpcy5oaXROb3JtYWxXb3JsZC5jb3B5KGhpdE5vcm1hbFdvcmxkKTsKICAgICAgdGhpcy5oaXRQb2ludFdvcmxkLmNvcHkoaGl0UG9pbnRXb3JsZCk7CiAgICAgIHRoaXMuc2hhcGUgPSBzaGFwZTsKICAgICAgdGhpcy5ib2R5ID0gYm9keTsKICAgICAgdGhpcy5kaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgfQoKICB9CgogIGxldCBfU2hhcGUkdHlwZXMkU1BIRVJFLCBfU2hhcGUkdHlwZXMkUExBTkUsIF9TaGFwZSR0eXBlcyRCT1gsIF9TaGFwZSR0eXBlcyRDWUxJTkRFUiwgX1NoYXBlJHR5cGVzJENPTlZFWFBPLCBfU2hhcGUkdHlwZXMkSEVJR0hURkksIF9TaGFwZSR0eXBlcyRUUklNRVNIOwoKICAvKioKICAgKiBSQVlfTU9ERVMKICAgKi8KICBjb25zdCBSQVlfTU9ERVMgPSB7CiAgICAvKiogQ0xPU0VTVCAqLwogICAgQ0xPU0VTVDogMSwKCiAgICAvKiogQU5ZICovCiAgICBBTlk6IDIsCgogICAgLyoqIEFMTCAqLwogICAgQUxMOiA0CiAgfTsKICAvKioKICAgKiBSYXlNb2RlCiAgICovCgogIF9TaGFwZSR0eXBlcyRTUEhFUkUgPSBTaGFwZS50eXBlcy5TUEhFUkU7CiAgX1NoYXBlJHR5cGVzJFBMQU5FID0gU2hhcGUudHlwZXMuUExBTkU7CiAgX1NoYXBlJHR5cGVzJEJPWCA9IFNoYXBlLnR5cGVzLkJPWDsKICBfU2hhcGUkdHlwZXMkQ1lMSU5ERVIgPSBTaGFwZS50eXBlcy5DWUxJTkRFUjsKICBfU2hhcGUkdHlwZXMkQ09OVkVYUE8gPSBTaGFwZS50eXBlcy5DT05WRVhQT0xZSEVEUk9OOwogIF9TaGFwZSR0eXBlcyRIRUlHSFRGSSA9IFNoYXBlLnR5cGVzLkhFSUdIVEZJRUxEOwogIF9TaGFwZSR0eXBlcyRUUklNRVNIID0gU2hhcGUudHlwZXMuVFJJTUVTSDsKCiAgLyoqCiAgICogQSBsaW5lIGluIDNEIHNwYWNlIHRoYXQgaW50ZXJzZWN0cyBib2RpZXMgYW5kIHJldHVybiBwb2ludHMuCiAgICovCiAgY2xhc3MgUmF5IHsKICAgIC8qKgogICAgICogZnJvbQogICAgICovCgogICAgLyoqCiAgICAgKiB0bwogICAgICovCgogICAgLyoqCiAgICAgKiBkaXJlY3Rpb24KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIHByZWNpc2lvbiBvZiB0aGUgcmF5LiBVc2VkIHdoZW4gY2hlY2tpbmcgcGFyYWxsZWxpdHkgZXRjLgogICAgICogQGRlZmF1bHQgMC4wMDAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNldCB0byBgZmFsc2VgIGlmIHlvdSBkb24ndCB3YW50IHRoZSBSYXkgdG8gdGFrZSBgY29sbGlzaW9uUmVzcG9uc2VgIGZsYWdzIGludG8gYWNjb3VudCBvbiBib2RpZXMgYW5kIHNoYXBlcy4KICAgICAqIEBkZWZhdWx0IHRydWUKICAgICAqLwoKICAgIC8qKgogICAgICogSWYgc2V0IHRvIGB0cnVlYCwgdGhlIHJheSBza2lwcyBhbnkgaGl0cyB3aXRoIG5vcm1hbC5kb3QocmF5RGlyZWN0aW9uKSA8IDAuCiAgICAgKiBAZGVmYXVsdCBmYWxzZQogICAgICovCgogICAgLyoqCiAgICAgKiBjb2xsaXNpb25GaWx0ZXJNYXNrCiAgICAgKiBAZGVmYXVsdCAtMQogICAgICovCgogICAgLyoqCiAgICAgKiBjb2xsaXNpb25GaWx0ZXJHcm91cAogICAgICogQGRlZmF1bHQgLTEKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGludGVyc2VjdGlvbiBtb2RlLiBTaG91bGQgYmUgUmF5LkFOWSwgUmF5LkFMTCBvciBSYXkuQ0xPU0VTVC4KICAgICAqIEBkZWZhdWx0IFJBWS5BTlkKICAgICAqLwoKICAgIC8qKgogICAgICogQ3VycmVudCByZXN1bHQgb2JqZWN0LgogICAgICovCgogICAgLyoqCiAgICAgKiBXaWxsIGJlIHNldCB0byBgdHJ1ZWAgZHVyaW5nIGludGVyc2VjdFdvcmxkKCkgaWYgdGhlIHJheSBoaXQgYW55dGhpbmcuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFVzZXItcHJvdmlkZWQgcmVzdWx0IGNhbGxiYWNrLiBXaWxsIGJlIHVzZWQgaWYgbW9kZSBpcyBSYXkuQUxMLgogICAgICovCgogICAgLyoqCiAgICAgKiBDTE9TRVNUCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFOWQogICAgICovCgogICAgLyoqCiAgICAgKiBBTEwKICAgICAqLwogICAgZ2V0IFtfU2hhcGUkdHlwZXMkU1BIRVJFXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVyc2VjdFNwaGVyZTsKICAgIH0KCiAgICBnZXQgW19TaGFwZSR0eXBlcyRQTEFORV0oKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3RQbGFuZTsKICAgIH0KCiAgICBnZXQgW19TaGFwZSR0eXBlcyRCT1hdKCkgewogICAgICByZXR1cm4gdGhpcy5faW50ZXJzZWN0Qm94OwogICAgfQoKICAgIGdldCBbX1NoYXBlJHR5cGVzJENZTElOREVSXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVyc2VjdENvbnZleDsKICAgIH0KCiAgICBnZXQgW19TaGFwZSR0eXBlcyRDT05WRVhQT10oKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3RDb252ZXg7CiAgICB9CgogICAgZ2V0IFtfU2hhcGUkdHlwZXMkSEVJR0hURkldKCkgewogICAgICByZXR1cm4gdGhpcy5faW50ZXJzZWN0SGVpZ2h0ZmllbGQ7CiAgICB9CgogICAgZ2V0IFtfU2hhcGUkdHlwZXMkVFJJTUVTSF0oKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3RUcmltZXNoOwogICAgfQoKICAgIGNvbnN0cnVjdG9yKGZyb20sIHRvKSB7CiAgICAgIGlmIChmcm9tID09PSB2b2lkIDApIHsKICAgICAgICBmcm9tID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgaWYgKHRvID09PSB2b2lkIDApIHsKICAgICAgICB0byA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHRoaXMuZnJvbSA9IGZyb20uY2xvbmUoKTsKICAgICAgdGhpcy50byA9IHRvLmNsb25lKCk7CiAgICAgIHRoaXMuZGlyZWN0aW9uID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5wcmVjaXNpb24gPSAwLjAwMDE7CiAgICAgIHRoaXMuY2hlY2tDb2xsaXNpb25SZXNwb25zZSA9IHRydWU7CiAgICAgIHRoaXMuc2tpcEJhY2tmYWNlcyA9IGZhbHNlOwogICAgICB0aGlzLmNvbGxpc2lvbkZpbHRlck1hc2sgPSAtMTsKICAgICAgdGhpcy5jb2xsaXNpb25GaWx0ZXJHcm91cCA9IC0xOwogICAgICB0aGlzLm1vZGUgPSBSYXkuQU5ZOwogICAgICB0aGlzLnJlc3VsdCA9IG5ldyBSYXljYXN0UmVzdWx0KCk7CiAgICAgIHRoaXMuaGFzSGl0ID0gZmFsc2U7CgogICAgICB0aGlzLmNhbGxiYWNrID0gcmVzdWx0ID0+IHt9OwogICAgfQogICAgLyoqCiAgICAgKiBEbyBpdGVyc2VjdGlvbiBhZ2FpbnN0IGFsbCBib2RpZXMgaW4gdGhlIGdpdmVuIFdvcmxkLgogICAgICogQHJldHVybiBUcnVlIGlmIHRoZSByYXkgaGl0IGFueXRoaW5nLCBvdGhlcndpc2UgZmFsc2UuCiAgICAgKi8KCgogICAgaW50ZXJzZWN0V29ybGQod29ybGQsIG9wdGlvbnMpIHsKICAgICAgdGhpcy5tb2RlID0gb3B0aW9ucy5tb2RlIHx8IFJheS5BTlk7CiAgICAgIHRoaXMucmVzdWx0ID0gb3B0aW9ucy5yZXN1bHQgfHwgbmV3IFJheWNhc3RSZXN1bHQoKTsKICAgICAgdGhpcy5za2lwQmFja2ZhY2VzID0gISFvcHRpb25zLnNraXBCYWNrZmFjZXM7CiAgICAgIHRoaXMuY29sbGlzaW9uRmlsdGVyTWFzayA9IHR5cGVvZiBvcHRpb25zLmNvbGxpc2lvbkZpbHRlck1hc2sgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5jb2xsaXNpb25GaWx0ZXJNYXNrIDogLTE7CiAgICAgIHRoaXMuY29sbGlzaW9uRmlsdGVyR3JvdXAgPSB0eXBlb2Ygb3B0aW9ucy5jb2xsaXNpb25GaWx0ZXJHcm91cCAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwIDogLTE7CiAgICAgIHRoaXMuY2hlY2tDb2xsaXNpb25SZXNwb25zZSA9IHR5cGVvZiBvcHRpb25zLmNoZWNrQ29sbGlzaW9uUmVzcG9uc2UgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5jaGVja0NvbGxpc2lvblJlc3BvbnNlIDogdHJ1ZTsKCiAgICAgIGlmIChvcHRpb25zLmZyb20pIHsKICAgICAgICB0aGlzLmZyb20uY29weShvcHRpb25zLmZyb20pOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy50bykgewogICAgICAgIHRoaXMudG8uY29weShvcHRpb25zLnRvKTsKICAgICAgfQoKICAgICAgdGhpcy5jYWxsYmFjayA9IG9wdGlvbnMuY2FsbGJhY2sgfHwgKCgpID0+IHt9KTsKCiAgICAgIHRoaXMuaGFzSGl0ID0gZmFsc2U7CiAgICAgIHRoaXMucmVzdWx0LnJlc2V0KCk7CiAgICAgIHRoaXMudXBkYXRlRGlyZWN0aW9uKCk7CiAgICAgIHRoaXMuZ2V0QUFCQih0bXBBQUJCJDEpOwogICAgICB0bXBBcnJheS5sZW5ndGggPSAwOwogICAgICB3b3JsZC5icm9hZHBoYXNlLmFhYmJRdWVyeSh3b3JsZCwgdG1wQUFCQiQxLCB0bXBBcnJheSk7CiAgICAgIHRoaXMuaW50ZXJzZWN0Qm9kaWVzKHRtcEFycmF5KTsKICAgICAgcmV0dXJuIHRoaXMuaGFzSGl0OwogICAgfQogICAgLyoqCiAgICAgKiBTaG9vdCBhIHJheSBhdCBhIGJvZHksIGdldCBiYWNrIGluZm9ybWF0aW9uIGFib3V0IHRoZSBoaXQuCiAgICAgKiBAZGVwcmVjYXRlZCBAcGFyYW0gcmVzdWx0IHNldCB0aGUgcmVzdWx0IHByb3BlcnR5IG9mIHRoZSBSYXkgaW5zdGVhZC4KICAgICAqLwoKCiAgICBpbnRlcnNlY3RCb2R5KGJvZHksIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgdGhpcy5yZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgdGhpcy51cGRhdGVEaXJlY3Rpb24oKTsKICAgICAgfQoKICAgICAgY29uc3QgY2hlY2tDb2xsaXNpb25SZXNwb25zZSA9IHRoaXMuY2hlY2tDb2xsaXNpb25SZXNwb25zZTsKCiAgICAgIGlmIChjaGVja0NvbGxpc2lvblJlc3BvbnNlICYmICFib2R5LmNvbGxpc2lvblJlc3BvbnNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoKHRoaXMuY29sbGlzaW9uRmlsdGVyR3JvdXAgJiBib2R5LmNvbGxpc2lvbkZpbHRlck1hc2spID09PSAwIHx8IChib2R5LmNvbGxpc2lvbkZpbHRlckdyb3VwICYgdGhpcy5jb2xsaXNpb25GaWx0ZXJNYXNrKSA9PT0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgeGkgPSBpbnRlcnNlY3RCb2R5X3hpOwogICAgICBjb25zdCBxaSA9IGludGVyc2VjdEJvZHlfcWk7CgogICAgICBmb3IgKGxldCBpID0gMCwgTiA9IGJvZHkuc2hhcGVzLmxlbmd0aDsgaSA8IE47IGkrKykgewogICAgICAgIGNvbnN0IHNoYXBlID0gYm9keS5zaGFwZXNbaV07CgogICAgICAgIGlmIChjaGVja0NvbGxpc2lvblJlc3BvbnNlICYmICFzaGFwZS5jb2xsaXNpb25SZXNwb25zZSkgewogICAgICAgICAgY29udGludWU7IC8vIFNraXAKICAgICAgICB9CgogICAgICAgIGJvZHkucXVhdGVybmlvbi5tdWx0KGJvZHkuc2hhcGVPcmllbnRhdGlvbnNbaV0sIHFpKTsKICAgICAgICBib2R5LnF1YXRlcm5pb24udm11bHQoYm9keS5zaGFwZU9mZnNldHNbaV0sIHhpKTsKICAgICAgICB4aS52YWRkKGJvZHkucG9zaXRpb24sIHhpKTsKICAgICAgICB0aGlzLmludGVyc2VjdFNoYXBlKHNoYXBlLCBxaSwgeGksIGJvZHkpOwoKICAgICAgICBpZiAodGhpcy5yZXN1bHQuc2hvdWxkU3RvcCkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFNob290IGEgcmF5IGF0IGFuIGFycmF5IGJvZGllcywgZ2V0IGJhY2sgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGhpdC4KICAgICAqIEBwYXJhbSBib2RpZXMgQW4gYXJyYXkgb2YgQm9keSBvYmplY3RzLgogICAgICogQGRlcHJlY2F0ZWQgQHBhcmFtIHJlc3VsdCBzZXQgdGhlIHJlc3VsdCBwcm9wZXJ0eSBvZiB0aGUgUmF5IGluc3RlYWQuCiAgICAgKgogICAgICovCgoKICAgIGludGVyc2VjdEJvZGllcyhib2RpZXMsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgdGhpcy5yZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgdGhpcy51cGRhdGVEaXJlY3Rpb24oKTsKICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBib2RpZXMubGVuZ3RoOyAhdGhpcy5yZXN1bHQuc2hvdWxkU3RvcCAmJiBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5pbnRlcnNlY3RCb2R5KGJvZGllc1tpXSk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlcyB0aGUgZGlyZWN0aW9uIHZlY3Rvci4KICAgICAqLwoKCiAgICB1cGRhdGVEaXJlY3Rpb24oKSB7CiAgICAgIHRoaXMudG8udnN1Yih0aGlzLmZyb20sIHRoaXMuZGlyZWN0aW9uKTsKICAgICAgdGhpcy5kaXJlY3Rpb24ubm9ybWFsaXplKCk7CiAgICB9CgogICAgaW50ZXJzZWN0U2hhcGUoc2hhcGUsIHF1YXQsIHBvc2l0aW9uLCBib2R5KSB7CiAgICAgIGNvbnN0IGZyb20gPSB0aGlzLmZyb207IC8vIENoZWNraW5nIGJvdW5kaW5nU3BoZXJlCgogICAgICBjb25zdCBkaXN0YW5jZSA9IGRpc3RhbmNlRnJvbUludGVyc2VjdGlvbihmcm9tLCB0aGlzLmRpcmVjdGlvbiwgcG9zaXRpb24pOwoKICAgICAgaWYgKGRpc3RhbmNlID4gc2hhcGUuYm91bmRpbmdTcGhlcmVSYWRpdXMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IGludGVyc2VjdE1ldGhvZCA9IHRoaXNbc2hhcGUudHlwZV07CgogICAgICBpZiAoaW50ZXJzZWN0TWV0aG9kKSB7CiAgICAgICAgaW50ZXJzZWN0TWV0aG9kLmNhbGwodGhpcywgc2hhcGUsIHF1YXQsIHBvc2l0aW9uLCBib2R5LCBzaGFwZSk7CiAgICAgIH0KICAgIH0KCiAgICBfaW50ZXJzZWN0Qm94KGJveCwgcXVhdCwgcG9zaXRpb24sIGJvZHksIHJlcG9ydGVkU2hhcGUpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVyc2VjdENvbnZleChib3guY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLCBxdWF0LCBwb3NpdGlvbiwgYm9keSwgcmVwb3J0ZWRTaGFwZSk7CiAgICB9CgogICAgX2ludGVyc2VjdFBsYW5lKHNoYXBlLCBxdWF0LCBwb3NpdGlvbiwgYm9keSwgcmVwb3J0ZWRTaGFwZSkgewogICAgICBjb25zdCBmcm9tID0gdGhpcy5mcm9tOwogICAgICBjb25zdCB0byA9IHRoaXMudG87CiAgICAgIGNvbnN0IGRpcmVjdGlvbiA9IHRoaXMuZGlyZWN0aW9uOyAvLyBHZXQgcGxhbmUgbm9ybWFsCgogICAgICBjb25zdCB3b3JsZE5vcm1hbCA9IG5ldyBWZWMzKDAsIDAsIDEpOwogICAgICBxdWF0LnZtdWx0KHdvcmxkTm9ybWFsLCB3b3JsZE5vcm1hbCk7CiAgICAgIGNvbnN0IGxlbiA9IG5ldyBWZWMzKCk7CiAgICAgIGZyb20udnN1Yihwb3NpdGlvbiwgbGVuKTsKICAgICAgY29uc3QgcGxhbmVUb0Zyb20gPSBsZW4uZG90KHdvcmxkTm9ybWFsKTsKICAgICAgdG8udnN1Yihwb3NpdGlvbiwgbGVuKTsKICAgICAgY29uc3QgcGxhbmVUb1RvID0gbGVuLmRvdCh3b3JsZE5vcm1hbCk7CgogICAgICBpZiAocGxhbmVUb0Zyb20gKiBwbGFuZVRvVG8gPiAwKSB7CiAgICAgICAgLy8gImZyb20iIGFuZCAidG8iIGFyZSBvbiB0aGUgc2FtZSBzaWRlIG9mIHRoZSBwbGFuZS4uLiBiYWlsIG91dAogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGZyb20uZGlzdGFuY2VUbyh0bykgPCBwbGFuZVRvRnJvbSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3Qgbl9kb3RfZGlyID0gd29ybGROb3JtYWwuZG90KGRpcmVjdGlvbik7CgogICAgICBpZiAoTWF0aC5hYnMobl9kb3RfZGlyKSA8IHRoaXMucHJlY2lzaW9uKSB7CiAgICAgICAgLy8gTm8gaW50ZXJzZWN0aW9uCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBwbGFuZVBvaW50VG9Gcm9tID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgZGlyX3NjYWxlZF93aXRoX3QgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBoaXRQb2ludFdvcmxkID0gbmV3IFZlYzMoKTsKICAgICAgZnJvbS52c3ViKHBvc2l0aW9uLCBwbGFuZVBvaW50VG9Gcm9tKTsKICAgICAgY29uc3QgdCA9IC13b3JsZE5vcm1hbC5kb3QocGxhbmVQb2ludFRvRnJvbSkgLyBuX2RvdF9kaXI7CiAgICAgIGRpcmVjdGlvbi5zY2FsZSh0LCBkaXJfc2NhbGVkX3dpdGhfdCk7CiAgICAgIGZyb20udmFkZChkaXJfc2NhbGVkX3dpdGhfdCwgaGl0UG9pbnRXb3JsZCk7CiAgICAgIHRoaXMucmVwb3J0SW50ZXJzZWN0aW9uKHdvcmxkTm9ybWFsLCBoaXRQb2ludFdvcmxkLCByZXBvcnRlZFNoYXBlLCBib2R5LCAtMSk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgd29ybGQgQUFCQiBvZiB0aGUgcmF5LgogICAgICovCgoKICAgIGdldEFBQkIoYWFiYikgewogICAgICBjb25zdCB7CiAgICAgICAgbG93ZXJCb3VuZCwKICAgICAgICB1cHBlckJvdW5kCiAgICAgIH0gPSBhYWJiOwogICAgICBjb25zdCB0byA9IHRoaXMudG87CiAgICAgIGNvbnN0IGZyb20gPSB0aGlzLmZyb207CiAgICAgIGxvd2VyQm91bmQueCA9IE1hdGgubWluKHRvLngsIGZyb20ueCk7CiAgICAgIGxvd2VyQm91bmQueSA9IE1hdGgubWluKHRvLnksIGZyb20ueSk7CiAgICAgIGxvd2VyQm91bmQueiA9IE1hdGgubWluKHRvLnosIGZyb20ueik7CiAgICAgIHVwcGVyQm91bmQueCA9IE1hdGgubWF4KHRvLngsIGZyb20ueCk7CiAgICAgIHVwcGVyQm91bmQueSA9IE1hdGgubWF4KHRvLnksIGZyb20ueSk7CiAgICAgIHVwcGVyQm91bmQueiA9IE1hdGgubWF4KHRvLnosIGZyb20ueik7CiAgICB9CgogICAgX2ludGVyc2VjdEhlaWdodGZpZWxkKHNoYXBlLCBxdWF0LCBwb3NpdGlvbiwgYm9keSwgcmVwb3J0ZWRTaGFwZSkgewogICAgICBzaGFwZS5kYXRhOwogICAgICBzaGFwZS5lbGVtZW50U2l6ZTsgLy8gQ29udmVydCB0aGUgcmF5IHRvIGxvY2FsIGhlaWdodGZpZWxkIGNvb3JkaW5hdGVzCgogICAgICBjb25zdCBsb2NhbFJheSA9IGludGVyc2VjdEhlaWdodGZpZWxkX2xvY2FsUmF5OyAvL25ldyBSYXkodGhpcy5mcm9tLCB0aGlzLnRvKTsKCiAgICAgIGxvY2FsUmF5LmZyb20uY29weSh0aGlzLmZyb20pOwogICAgICBsb2NhbFJheS50by5jb3B5KHRoaXMudG8pOwogICAgICBUcmFuc2Zvcm0ucG9pbnRUb0xvY2FsRnJhbWUocG9zaXRpb24sIHF1YXQsIGxvY2FsUmF5LmZyb20sIGxvY2FsUmF5LmZyb20pOwogICAgICBUcmFuc2Zvcm0ucG9pbnRUb0xvY2FsRnJhbWUocG9zaXRpb24sIHF1YXQsIGxvY2FsUmF5LnRvLCBsb2NhbFJheS50byk7CiAgICAgIGxvY2FsUmF5LnVwZGF0ZURpcmVjdGlvbigpOyAvLyBHZXQgdGhlIGluZGV4IG9mIHRoZSBkYXRhIHBvaW50cyB0byB0ZXN0IGFnYWluc3QKCiAgICAgIGNvbnN0IGluZGV4ID0gaW50ZXJzZWN0SGVpZ2h0ZmllbGRfaW5kZXg7CiAgICAgIGxldCBpTWluWDsKICAgICAgbGV0IGlNaW5ZOwogICAgICBsZXQgaU1heFg7CiAgICAgIGxldCBpTWF4WTsgLy8gU2V0IHRvIG1heAoKICAgICAgaU1pblggPSBpTWluWSA9IDA7CiAgICAgIGlNYXhYID0gaU1heFkgPSBzaGFwZS5kYXRhLmxlbmd0aCAtIDE7CiAgICAgIGNvbnN0IGFhYmIgPSBuZXcgQUFCQigpOwogICAgICBsb2NhbFJheS5nZXRBQUJCKGFhYmIpOwogICAgICBzaGFwZS5nZXRJbmRleE9mUG9zaXRpb24oYWFiYi5sb3dlckJvdW5kLngsIGFhYmIubG93ZXJCb3VuZC55LCBpbmRleCwgdHJ1ZSk7CiAgICAgIGlNaW5YID0gTWF0aC5tYXgoaU1pblgsIGluZGV4WzBdKTsKICAgICAgaU1pblkgPSBNYXRoLm1heChpTWluWSwgaW5kZXhbMV0pOwogICAgICBzaGFwZS5nZXRJbmRleE9mUG9zaXRpb24oYWFiYi51cHBlckJvdW5kLngsIGFhYmIudXBwZXJCb3VuZC55LCBpbmRleCwgdHJ1ZSk7CiAgICAgIGlNYXhYID0gTWF0aC5taW4oaU1heFgsIGluZGV4WzBdICsgMSk7CiAgICAgIGlNYXhZID0gTWF0aC5taW4oaU1heFksIGluZGV4WzFdICsgMSk7CgogICAgICBmb3IgKGxldCBpID0gaU1pblg7IGkgPCBpTWF4WDsgaSsrKSB7CiAgICAgICAgZm9yIChsZXQgaiA9IGlNaW5ZOyBqIDwgaU1heFk7IGorKykgewogICAgICAgICAgaWYgKHRoaXMucmVzdWx0LnNob3VsZFN0b3ApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHNoYXBlLmdldEFhYmJBdEluZGV4KGksIGosIGFhYmIpOwoKICAgICAgICAgIGlmICghYWFiYi5vdmVybGFwc1JheShsb2NhbFJheSkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IC8vIExvd2VyIHRyaWFuZ2xlCgoKICAgICAgICAgIHNoYXBlLmdldENvbnZleFRyaWFuZ2xlUGlsbGFyKGksIGosIGZhbHNlKTsKICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZShwb3NpdGlvbiwgcXVhdCwgc2hhcGUucGlsbGFyT2Zmc2V0LCB3b3JsZFBpbGxhck9mZnNldCk7CgogICAgICAgICAgdGhpcy5faW50ZXJzZWN0Q29udmV4KHNoYXBlLnBpbGxhckNvbnZleCwgcXVhdCwgd29ybGRQaWxsYXJPZmZzZXQsIGJvZHksIHJlcG9ydGVkU2hhcGUsIGludGVyc2VjdENvbnZleE9wdGlvbnMpOwoKICAgICAgICAgIGlmICh0aGlzLnJlc3VsdC5zaG91bGRTdG9wKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gLy8gVXBwZXIgdHJpYW5nbGUKCgogICAgICAgICAgc2hhcGUuZ2V0Q29udmV4VHJpYW5nbGVQaWxsYXIoaSwgaiwgdHJ1ZSk7CiAgICAgICAgICBUcmFuc2Zvcm0ucG9pbnRUb1dvcmxkRnJhbWUocG9zaXRpb24sIHF1YXQsIHNoYXBlLnBpbGxhck9mZnNldCwgd29ybGRQaWxsYXJPZmZzZXQpOwoKICAgICAgICAgIHRoaXMuX2ludGVyc2VjdENvbnZleChzaGFwZS5waWxsYXJDb252ZXgsIHF1YXQsIHdvcmxkUGlsbGFyT2Zmc2V0LCBib2R5LCByZXBvcnRlZFNoYXBlLCBpbnRlcnNlY3RDb252ZXhPcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBfaW50ZXJzZWN0U3BoZXJlKHNwaGVyZSwgcXVhdCwgcG9zaXRpb24sIGJvZHksIHJlcG9ydGVkU2hhcGUpIHsKICAgICAgY29uc3QgZnJvbSA9IHRoaXMuZnJvbTsKICAgICAgY29uc3QgdG8gPSB0aGlzLnRvOwogICAgICBjb25zdCByID0gc3BoZXJlLnJhZGl1czsKICAgICAgY29uc3QgYSA9ICh0by54IC0gZnJvbS54KSAqKiAyICsgKHRvLnkgLSBmcm9tLnkpICoqIDIgKyAodG8ueiAtIGZyb20ueikgKiogMjsKICAgICAgY29uc3QgYiA9IDIgKiAoKHRvLnggLSBmcm9tLngpICogKGZyb20ueCAtIHBvc2l0aW9uLngpICsgKHRvLnkgLSBmcm9tLnkpICogKGZyb20ueSAtIHBvc2l0aW9uLnkpICsgKHRvLnogLSBmcm9tLnopICogKGZyb20ueiAtIHBvc2l0aW9uLnopKTsKICAgICAgY29uc3QgYyA9IChmcm9tLnggLSBwb3NpdGlvbi54KSAqKiAyICsgKGZyb20ueSAtIHBvc2l0aW9uLnkpICoqIDIgKyAoZnJvbS56IC0gcG9zaXRpb24ueikgKiogMiAtIHIgKiogMjsKICAgICAgY29uc3QgZGVsdGEgPSBiICoqIDIgLSA0ICogYSAqIGM7CiAgICAgIGNvbnN0IGludGVyc2VjdGlvblBvaW50ID0gUmF5X2ludGVyc2VjdFNwaGVyZV9pbnRlcnNlY3Rpb25Qb2ludDsKICAgICAgY29uc3Qgbm9ybWFsID0gUmF5X2ludGVyc2VjdFNwaGVyZV9ub3JtYWw7CgogICAgICBpZiAoZGVsdGEgPCAwKSB7CiAgICAgICAgLy8gTm8gaW50ZXJzZWN0aW9uCiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKGRlbHRhID09PSAwKSB7CiAgICAgICAgLy8gc2luZ2xlIGludGVyc2VjdGlvbiBwb2ludAogICAgICAgIGZyb20ubGVycCh0bywgZGVsdGEsIGludGVyc2VjdGlvblBvaW50KTsKICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludC52c3ViKHBvc2l0aW9uLCBub3JtYWwpOwogICAgICAgIG5vcm1hbC5ub3JtYWxpemUoKTsKICAgICAgICB0aGlzLnJlcG9ydEludGVyc2VjdGlvbihub3JtYWwsIGludGVyc2VjdGlvblBvaW50LCByZXBvcnRlZFNoYXBlLCBib2R5LCAtMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgZDEgPSAoLWIgLSBNYXRoLnNxcnQoZGVsdGEpKSAvICgyICogYSk7CiAgICAgICAgY29uc3QgZDIgPSAoLWIgKyBNYXRoLnNxcnQoZGVsdGEpKSAvICgyICogYSk7CgogICAgICAgIGlmIChkMSA+PSAwICYmIGQxIDw9IDEpIHsKICAgICAgICAgIGZyb20ubGVycCh0bywgZDEsIGludGVyc2VjdGlvblBvaW50KTsKICAgICAgICAgIGludGVyc2VjdGlvblBvaW50LnZzdWIocG9zaXRpb24sIG5vcm1hbCk7CiAgICAgICAgICBub3JtYWwubm9ybWFsaXplKCk7CiAgICAgICAgICB0aGlzLnJlcG9ydEludGVyc2VjdGlvbihub3JtYWwsIGludGVyc2VjdGlvblBvaW50LCByZXBvcnRlZFNoYXBlLCBib2R5LCAtMSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5yZXN1bHQuc2hvdWxkU3RvcCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGQyID49IDAgJiYgZDIgPD0gMSkgewogICAgICAgICAgZnJvbS5sZXJwKHRvLCBkMiwgaW50ZXJzZWN0aW9uUG9pbnQpOwogICAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQudnN1Yihwb3NpdGlvbiwgbm9ybWFsKTsKICAgICAgICAgIG5vcm1hbC5ub3JtYWxpemUoKTsKICAgICAgICAgIHRoaXMucmVwb3J0SW50ZXJzZWN0aW9uKG5vcm1hbCwgaW50ZXJzZWN0aW9uUG9pbnQsIHJlcG9ydGVkU2hhcGUsIGJvZHksIC0xKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBfaW50ZXJzZWN0Q29udmV4KHNoYXBlLCBxdWF0LCBwb3NpdGlvbiwgYm9keSwgcmVwb3J0ZWRTaGFwZSwgb3B0aW9ucykgewogICAgICBjb25zdCBub3JtYWwgPSBpbnRlcnNlY3RDb252ZXhfbm9ybWFsOwogICAgICBjb25zdCB2ZWN0b3IgPSBpbnRlcnNlY3RDb252ZXhfdmVjdG9yOwogICAgICBjb25zdCBmYWNlTGlzdCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5mYWNlTGlzdCB8fCBudWxsOyAvLyBDaGVja2luZyBmYWNlcwoKICAgICAgY29uc3QgZmFjZXMgPSBzaGFwZS5mYWNlczsKICAgICAgY29uc3QgdmVydGljZXMgPSBzaGFwZS52ZXJ0aWNlczsKICAgICAgY29uc3Qgbm9ybWFscyA9IHNoYXBlLmZhY2VOb3JtYWxzOwogICAgICBjb25zdCBkaXJlY3Rpb24gPSB0aGlzLmRpcmVjdGlvbjsKICAgICAgY29uc3QgZnJvbSA9IHRoaXMuZnJvbTsKICAgICAgY29uc3QgdG8gPSB0aGlzLnRvOwogICAgICBjb25zdCBmcm9tVG9EaXN0YW5jZSA9IGZyb20uZGlzdGFuY2VUbyh0byk7CiAgICAgIGNvbnN0IE5mYWNlcyA9IGZhY2VMaXN0ID8gZmFjZUxpc3QubGVuZ3RoIDogZmFjZXMubGVuZ3RoOwogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnJlc3VsdDsKCiAgICAgIGZvciAobGV0IGogPSAwOyAhcmVzdWx0LnNob3VsZFN0b3AgJiYgaiA8IE5mYWNlczsgaisrKSB7CiAgICAgICAgY29uc3QgZmkgPSBmYWNlTGlzdCA/IGZhY2VMaXN0W2pdIDogajsKICAgICAgICBjb25zdCBmYWNlID0gZmFjZXNbZmldOwogICAgICAgIGNvbnN0IGZhY2VOb3JtYWwgPSBub3JtYWxzW2ZpXTsKICAgICAgICBjb25zdCBxID0gcXVhdDsKICAgICAgICBjb25zdCB4ID0gcG9zaXRpb247IC8vIGRldGVybWluZSBpZiByYXkgaW50ZXJzZWN0cyB0aGUgcGxhbmUgb2YgdGhlIGZhY2UKICAgICAgICAvLyBub3RlOiB0aGlzIHdvcmtzIHJlZ2FyZGxlc3Mgb2YgdGhlIGRpcmVjdGlvbiBvZiB0aGUgZmFjZSBub3JtYWwKICAgICAgICAvLyBHZXQgcGxhbmUgcG9pbnQgaW4gd29ybGQgY29vcmRpbmF0ZXMuLi4KCiAgICAgICAgdmVjdG9yLmNvcHkodmVydGljZXNbZmFjZVswXV0pOwogICAgICAgIHEudm11bHQodmVjdG9yLCB2ZWN0b3IpOwogICAgICAgIHZlY3Rvci52YWRkKHgsIHZlY3Rvcik7IC8vIC4uLmJ1dCBtYWtlIGl0IHJlbGF0aXZlIHRvIHRoZSByYXkgZnJvbS4gV2UnbGwgZml4IHRoaXMgbGF0ZXIuCgogICAgICAgIHZlY3Rvci52c3ViKGZyb20sIHZlY3Rvcik7IC8vIEdldCBwbGFuZSBub3JtYWwKCiAgICAgICAgcS52bXVsdChmYWNlTm9ybWFsLCBub3JtYWwpOyAvLyBJZiB0aGlzIGRvdCBwcm9kdWN0IGlzIG5lZ2F0aXZlLCB3ZSBoYXZlIHNvbWV0aGluZyBpbnRlcmVzdGluZwoKICAgICAgICBjb25zdCBkb3QgPSBkaXJlY3Rpb24uZG90KG5vcm1hbCk7IC8vIEJhaWwgb3V0IGlmIHJheSBhbmQgcGxhbmUgYXJlIHBhcmFsbGVsCgogICAgICAgIGlmIChNYXRoLmFicyhkb3QpIDwgdGhpcy5wcmVjaXNpb24pIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0gLy8gY2FsYyBkaXN0YW5jZSB0byBwbGFuZQoKCiAgICAgICAgY29uc3Qgc2NhbGFyID0gbm9ybWFsLmRvdCh2ZWN0b3IpIC8gZG90OyAvLyBpZiBuZWdhdGl2ZSBkaXN0YW5jZSwgdGhlbiBwbGFuZSBpcyBiZWhpbmQgcmF5CgogICAgICAgIGlmIChzY2FsYXIgPCAwKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9IC8vIGlmIChkb3QgPCAwKSB7CiAgICAgICAgLy8gSW50ZXJzZWN0aW9uIHBvaW50IGlzIGZyb20gKyBkaXJlY3Rpb24gKiBzY2FsYXIKCgogICAgICAgIGRpcmVjdGlvbi5zY2FsZShzY2FsYXIsIGludGVyc2VjdFBvaW50KTsKICAgICAgICBpbnRlcnNlY3RQb2ludC52YWRkKGZyb20sIGludGVyc2VjdFBvaW50KTsgLy8gYSBpcyB0aGUgcG9pbnQgd2UgY29tcGFyZSBwb2ludHMgYiBhbmQgYyB3aXRoLgoKICAgICAgICBhLmNvcHkodmVydGljZXNbZmFjZVswXV0pOwogICAgICAgIHEudm11bHQoYSwgYSk7CiAgICAgICAgeC52YWRkKGEsIGEpOwoKICAgICAgICBmb3IgKGxldCBpID0gMTsgIXJlc3VsdC5zaG91bGRTdG9wICYmIGkgPCBmYWNlLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgLy8gVHJhbnNmb3JtIDMgdmVydGljZXMgdG8gd29ybGQgY29vcmRzCiAgICAgICAgICBiLmNvcHkodmVydGljZXNbZmFjZVtpXV0pOwogICAgICAgICAgYy5jb3B5KHZlcnRpY2VzW2ZhY2VbaSArIDFdXSk7CiAgICAgICAgICBxLnZtdWx0KGIsIGIpOwogICAgICAgICAgcS52bXVsdChjLCBjKTsKICAgICAgICAgIHgudmFkZChiLCBiKTsKICAgICAgICAgIHgudmFkZChjLCBjKTsKICAgICAgICAgIGNvbnN0IGRpc3RhbmNlID0gaW50ZXJzZWN0UG9pbnQuZGlzdGFuY2VUbyhmcm9tKTsKCiAgICAgICAgICBpZiAoIShSYXkucG9pbnRJblRyaWFuZ2xlKGludGVyc2VjdFBvaW50LCBhLCBiLCBjKSB8fCBSYXkucG9pbnRJblRyaWFuZ2xlKGludGVyc2VjdFBvaW50LCBiLCBhLCBjKSkgfHwgZGlzdGFuY2UgPiBmcm9tVG9EaXN0YW5jZSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLnJlcG9ydEludGVyc2VjdGlvbihub3JtYWwsIGludGVyc2VjdFBvaW50LCByZXBvcnRlZFNoYXBlLCBib2R5LCBmaSk7CiAgICAgICAgfSAvLyB9CgogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEB0b2RvIE9wdGltaXplIGJ5IHRyYW5zZm9ybWluZyB0aGUgd29ybGQgdG8gbG9jYWwgc3BhY2UgZmlyc3QuCiAgICAgKiBAdG9kbyBVc2UgT2N0cmVlIGxvb2t1cAogICAgICovCgoKICAgIF9pbnRlcnNlY3RUcmltZXNoKG1lc2gsIHF1YXQsIHBvc2l0aW9uLCBib2R5LCByZXBvcnRlZFNoYXBlLCBvcHRpb25zKSB7CiAgICAgIGNvbnN0IG5vcm1hbCA9IGludGVyc2VjdFRyaW1lc2hfbm9ybWFsOwogICAgICBjb25zdCB0cmlhbmdsZXMgPSBpbnRlcnNlY3RUcmltZXNoX3RyaWFuZ2xlczsKICAgICAgY29uc3QgdHJlZVRyYW5zZm9ybSA9IGludGVyc2VjdFRyaW1lc2hfdHJlZVRyYW5zZm9ybTsKICAgICAgY29uc3QgdmVjdG9yID0gaW50ZXJzZWN0Q29udmV4X3ZlY3RvcjsKICAgICAgY29uc3QgbG9jYWxEaXJlY3Rpb24gPSBpbnRlcnNlY3RUcmltZXNoX2xvY2FsRGlyZWN0aW9uOwogICAgICBjb25zdCBsb2NhbEZyb20gPSBpbnRlcnNlY3RUcmltZXNoX2xvY2FsRnJvbTsKICAgICAgY29uc3QgbG9jYWxUbyA9IGludGVyc2VjdFRyaW1lc2hfbG9jYWxUbzsKICAgICAgY29uc3Qgd29ybGRJbnRlcnNlY3RQb2ludCA9IGludGVyc2VjdFRyaW1lc2hfd29ybGRJbnRlcnNlY3RQb2ludDsKICAgICAgY29uc3Qgd29ybGROb3JtYWwgPSBpbnRlcnNlY3RUcmltZXNoX3dvcmxkTm9ybWFsOyAvLyBDaGVja2luZyBmYWNlcwoKICAgICAgY29uc3QgaW5kaWNlcyA9IG1lc2guaW5kaWNlczsKICAgICAgbWVzaC52ZXJ0aWNlczsgLy8gY29uc3Qgbm9ybWFscyA9IG1lc2guZmFjZU5vcm1hbHMKCiAgICAgIGNvbnN0IGZyb20gPSB0aGlzLmZyb207CiAgICAgIGNvbnN0IHRvID0gdGhpcy50bzsKICAgICAgY29uc3QgZGlyZWN0aW9uID0gdGhpcy5kaXJlY3Rpb247CiAgICAgIHRyZWVUcmFuc2Zvcm0ucG9zaXRpb24uY29weShwb3NpdGlvbik7CiAgICAgIHRyZWVUcmFuc2Zvcm0ucXVhdGVybmlvbi5jb3B5KHF1YXQpOyAvLyBUcmFuc2Zvcm0gcmF5IHRvIGxvY2FsIHNwYWNlIQoKICAgICAgVHJhbnNmb3JtLnZlY3RvclRvTG9jYWxGcmFtZShwb3NpdGlvbiwgcXVhdCwgZGlyZWN0aW9uLCBsb2NhbERpcmVjdGlvbik7CiAgICAgIFRyYW5zZm9ybS5wb2ludFRvTG9jYWxGcmFtZShwb3NpdGlvbiwgcXVhdCwgZnJvbSwgbG9jYWxGcm9tKTsKICAgICAgVHJhbnNmb3JtLnBvaW50VG9Mb2NhbEZyYW1lKHBvc2l0aW9uLCBxdWF0LCB0bywgbG9jYWxUbyk7CiAgICAgIGxvY2FsVG8ueCAqPSBtZXNoLnNjYWxlLng7CiAgICAgIGxvY2FsVG8ueSAqPSBtZXNoLnNjYWxlLnk7CiAgICAgIGxvY2FsVG8ueiAqPSBtZXNoLnNjYWxlLno7CiAgICAgIGxvY2FsRnJvbS54ICo9IG1lc2guc2NhbGUueDsKICAgICAgbG9jYWxGcm9tLnkgKj0gbWVzaC5zY2FsZS55OwogICAgICBsb2NhbEZyb20ueiAqPSBtZXNoLnNjYWxlLno7CiAgICAgIGxvY2FsVG8udnN1Yihsb2NhbEZyb20sIGxvY2FsRGlyZWN0aW9uKTsKICAgICAgbG9jYWxEaXJlY3Rpb24ubm9ybWFsaXplKCk7CiAgICAgIGNvbnN0IGZyb21Ub0Rpc3RhbmNlU3F1YXJlZCA9IGxvY2FsRnJvbS5kaXN0YW5jZVNxdWFyZWQobG9jYWxUbyk7CiAgICAgIG1lc2gudHJlZS5yYXlRdWVyeSh0aGlzLCB0cmVlVHJhbnNmb3JtLCB0cmlhbmdsZXMpOwoKICAgICAgZm9yIChsZXQgaSA9IDAsIE4gPSB0cmlhbmdsZXMubGVuZ3RoOyAhdGhpcy5yZXN1bHQuc2hvdWxkU3RvcCAmJiBpICE9PSBOOyBpKyspIHsKICAgICAgICBjb25zdCB0cmlhbmdsZXNJbmRleCA9IHRyaWFuZ2xlc1tpXTsKICAgICAgICBtZXNoLmdldE5vcm1hbCh0cmlhbmdsZXNJbmRleCwgbm9ybWFsKTsgLy8gZGV0ZXJtaW5lIGlmIHJheSBpbnRlcnNlY3RzIHRoZSBwbGFuZSBvZiB0aGUgZmFjZQogICAgICAgIC8vIG5vdGU6IHRoaXMgd29ya3MgcmVnYXJkbGVzcyBvZiB0aGUgZGlyZWN0aW9uIG9mIHRoZSBmYWNlIG5vcm1hbAogICAgICAgIC8vIEdldCBwbGFuZSBwb2ludCBpbiB3b3JsZCBjb29yZGluYXRlcy4uLgoKICAgICAgICBtZXNoLmdldFZlcnRleChpbmRpY2VzW3RyaWFuZ2xlc0luZGV4ICogM10sIGEpOyAvLyAuLi5idXQgbWFrZSBpdCByZWxhdGl2ZSB0byB0aGUgcmF5IGZyb20uIFdlJ2xsIGZpeCB0aGlzIGxhdGVyLgoKICAgICAgICBhLnZzdWIobG9jYWxGcm9tLCB2ZWN0b3IpOyAvLyBJZiB0aGlzIGRvdCBwcm9kdWN0IGlzIG5lZ2F0aXZlLCB3ZSBoYXZlIHNvbWV0aGluZyBpbnRlcmVzdGluZwoKICAgICAgICBjb25zdCBkb3QgPSBsb2NhbERpcmVjdGlvbi5kb3Qobm9ybWFsKTsgLy8gQmFpbCBvdXQgaWYgcmF5IGFuZCBwbGFuZSBhcmUgcGFyYWxsZWwKICAgICAgICAvLyBpZiAoTWF0aC5hYnMoIGRvdCApIDwgdGhpcy5wcmVjaXNpb24pewogICAgICAgIC8vICAgICBjb250aW51ZTsKICAgICAgICAvLyB9CiAgICAgICAgLy8gY2FsYyBkaXN0YW5jZSB0byBwbGFuZQoKICAgICAgICBjb25zdCBzY2FsYXIgPSBub3JtYWwuZG90KHZlY3RvcikgLyBkb3Q7IC8vIGlmIG5lZ2F0aXZlIGRpc3RhbmNlLCB0aGVuIHBsYW5lIGlzIGJlaGluZCByYXkKCiAgICAgICAgaWYgKHNjYWxhciA8IDApIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0gLy8gSW50ZXJzZWN0aW9uIHBvaW50IGlzIGZyb20gKyBkaXJlY3Rpb24gKiBzY2FsYXIKCgogICAgICAgIGxvY2FsRGlyZWN0aW9uLnNjYWxlKHNjYWxhciwgaW50ZXJzZWN0UG9pbnQpOwogICAgICAgIGludGVyc2VjdFBvaW50LnZhZGQobG9jYWxGcm9tLCBpbnRlcnNlY3RQb2ludCk7IC8vIEdldCB0cmlhbmdsZSB2ZXJ0aWNlcwoKICAgICAgICBtZXNoLmdldFZlcnRleChpbmRpY2VzW3RyaWFuZ2xlc0luZGV4ICogMyArIDFdLCBiKTsKICAgICAgICBtZXNoLmdldFZlcnRleChpbmRpY2VzW3RyaWFuZ2xlc0luZGV4ICogMyArIDJdLCBjKTsKICAgICAgICBjb25zdCBzcXVhcmVkRGlzdGFuY2UgPSBpbnRlcnNlY3RQb2ludC5kaXN0YW5jZVNxdWFyZWQobG9jYWxGcm9tKTsKCiAgICAgICAgaWYgKCEoUmF5LnBvaW50SW5UcmlhbmdsZShpbnRlcnNlY3RQb2ludCwgYiwgYSwgYykgfHwgUmF5LnBvaW50SW5UcmlhbmdsZShpbnRlcnNlY3RQb2ludCwgYSwgYiwgYykpIHx8IHNxdWFyZWREaXN0YW5jZSA+IGZyb21Ub0Rpc3RhbmNlU3F1YXJlZCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfSAvLyB0cmFuc2Zvcm0gaW50ZXJzZWN0cG9pbnQgYW5kIG5vcm1hbCB0byB3b3JsZAoKCiAgICAgICAgVHJhbnNmb3JtLnZlY3RvclRvV29ybGRGcmFtZShxdWF0LCBub3JtYWwsIHdvcmxkTm9ybWFsKTsKICAgICAgICBUcmFuc2Zvcm0ucG9pbnRUb1dvcmxkRnJhbWUocG9zaXRpb24sIHF1YXQsIGludGVyc2VjdFBvaW50LCB3b3JsZEludGVyc2VjdFBvaW50KTsKICAgICAgICB0aGlzLnJlcG9ydEludGVyc2VjdGlvbih3b3JsZE5vcm1hbCwgd29ybGRJbnRlcnNlY3RQb2ludCwgcmVwb3J0ZWRTaGFwZSwgYm9keSwgdHJpYW5nbGVzSW5kZXgpOwogICAgICB9CgogICAgICB0cmlhbmdsZXMubGVuZ3RoID0gMDsKICAgIH0KICAgIC8qKgogICAgICogQHJldHVybiBUcnVlIGlmIHRoZSBpbnRlcnNlY3Rpb25zIHNob3VsZCBjb250aW51ZQogICAgICovCgoKICAgIHJlcG9ydEludGVyc2VjdGlvbihub3JtYWwsIGhpdFBvaW50V29ybGQsIHNoYXBlLCBib2R5LCBoaXRGYWNlSW5kZXgpIHsKICAgICAgY29uc3QgZnJvbSA9IHRoaXMuZnJvbTsKICAgICAgY29uc3QgdG8gPSB0aGlzLnRvOwogICAgICBjb25zdCBkaXN0YW5jZSA9IGZyb20uZGlzdGFuY2VUbyhoaXRQb2ludFdvcmxkKTsKICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5yZXN1bHQ7IC8vIFNraXAgYmFjayBmYWNlcz8KCiAgICAgIGlmICh0aGlzLnNraXBCYWNrZmFjZXMgJiYgbm9ybWFsLmRvdCh0aGlzLmRpcmVjdGlvbikgPiAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICByZXN1bHQuaGl0RmFjZUluZGV4ID0gdHlwZW9mIGhpdEZhY2VJbmRleCAhPT0gJ3VuZGVmaW5lZCcgPyBoaXRGYWNlSW5kZXggOiAtMTsKCiAgICAgIHN3aXRjaCAodGhpcy5tb2RlKSB7CiAgICAgICAgY2FzZSBSYXkuQUxMOgogICAgICAgICAgdGhpcy5oYXNIaXQgPSB0cnVlOwogICAgICAgICAgcmVzdWx0LnNldChmcm9tLCB0bywgbm9ybWFsLCBoaXRQb2ludFdvcmxkLCBzaGFwZSwgYm9keSwgZGlzdGFuY2UpOwogICAgICAgICAgcmVzdWx0Lmhhc0hpdCA9IHRydWU7CiAgICAgICAgICB0aGlzLmNhbGxiYWNrKHJlc3VsdCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBSYXkuQ0xPU0VTVDoKICAgICAgICAgIC8vIFN0b3JlIGlmIGNsb3NlciB0aGFuIGN1cnJlbnQgY2xvc2VzdAogICAgICAgICAgaWYgKGRpc3RhbmNlIDwgcmVzdWx0LmRpc3RhbmNlIHx8ICFyZXN1bHQuaGFzSGl0KSB7CiAgICAgICAgICAgIHRoaXMuaGFzSGl0ID0gdHJ1ZTsKICAgICAgICAgICAgcmVzdWx0Lmhhc0hpdCA9IHRydWU7CiAgICAgICAgICAgIHJlc3VsdC5zZXQoZnJvbSwgdG8sIG5vcm1hbCwgaGl0UG9pbnRXb3JsZCwgc2hhcGUsIGJvZHksIGRpc3RhbmNlKTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBSYXkuQU5ZOgogICAgICAgICAgLy8gUmVwb3J0IGFuZCBzdG9wLgogICAgICAgICAgdGhpcy5oYXNIaXQgPSB0cnVlOwogICAgICAgICAgcmVzdWx0Lmhhc0hpdCA9IHRydWU7CiAgICAgICAgICByZXN1bHQuc2V0KGZyb20sIHRvLCBub3JtYWwsIGhpdFBvaW50V29ybGQsIHNoYXBlLCBib2R5LCBkaXN0YW5jZSk7CiAgICAgICAgICByZXN1bHQuc2hvdWxkU3RvcCA9IHRydWU7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBBcyBwZXIgIkJhcnljZW50cmljIFRlY2huaXF1ZSIgYXMgbmFtZWQKICAgICAqIHtAbGluayBodHRwczovL3d3dy5ibGFja3Bhd24uY29tL3RleHRzL3BvaW50aW5wb2x5L2RlZmF1bHQuaHRtbCBoZXJlfSBidXQgd2l0aG91dCB0aGUgZGl2aXNpb24KICAgICAqLwoKCiAgICBzdGF0aWMgcG9pbnRJblRyaWFuZ2xlKHAsIGEsIGIsIGMpIHsKICAgICAgYy52c3ViKGEsIHYwKTsKICAgICAgYi52c3ViKGEsIHYxKTsKICAgICAgcC52c3ViKGEsIHYyKTsKICAgICAgY29uc3QgZG90MDAgPSB2MC5kb3QodjApOwogICAgICBjb25zdCBkb3QwMSA9IHYwLmRvdCh2MSk7CiAgICAgIGNvbnN0IGRvdDAyID0gdjAuZG90KHYyKTsKICAgICAgY29uc3QgZG90MTEgPSB2MS5kb3QodjEpOwogICAgICBjb25zdCBkb3QxMiA9IHYxLmRvdCh2Mik7CiAgICAgIGxldCB1OwogICAgICBsZXQgdjsKICAgICAgcmV0dXJuICh1ID0gZG90MTEgKiBkb3QwMiAtIGRvdDAxICogZG90MTIpID49IDAgJiYgKHYgPSBkb3QwMCAqIGRvdDEyIC0gZG90MDEgKiBkb3QwMikgPj0gMCAmJiB1ICsgdiA8IGRvdDAwICogZG90MTEgLSBkb3QwMSAqIGRvdDAxOwogICAgfQoKICB9CiAgUmF5LkNMT1NFU1QgPSBSQVlfTU9ERVMuQ0xPU0VTVDsKICBSYXkuQU5ZID0gUkFZX01PREVTLkFOWTsKICBSYXkuQUxMID0gUkFZX01PREVTLkFMTDsKICBjb25zdCB0bXBBQUJCJDEgPSBuZXcgQUFCQigpOwogIGNvbnN0IHRtcEFycmF5ID0gW107CiAgY29uc3QgdjEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHYyID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RCb2R5X3hpID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RCb2R5X3FpID0gbmV3IFF1YXRlcm5pb24oKTsKICBjb25zdCBpbnRlcnNlY3RQb2ludCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYyA9IG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgUmF5Y2FzdFJlc3VsdCgpOwogIGNvbnN0IGludGVyc2VjdENvbnZleE9wdGlvbnMgPSB7CiAgICBmYWNlTGlzdDogWzBdCiAgfTsKICBjb25zdCB3b3JsZFBpbGxhck9mZnNldCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW50ZXJzZWN0SGVpZ2h0ZmllbGRfbG9jYWxSYXkgPSBuZXcgUmF5KCk7CiAgY29uc3QgaW50ZXJzZWN0SGVpZ2h0ZmllbGRfaW5kZXggPSBbXTsKICBjb25zdCBSYXlfaW50ZXJzZWN0U3BoZXJlX2ludGVyc2VjdGlvblBvaW50ID0gbmV3IFZlYzMoKTsKICBjb25zdCBSYXlfaW50ZXJzZWN0U3BoZXJlX25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW50ZXJzZWN0Q29udmV4X25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIGNvbnN0IGludGVyc2VjdENvbnZleF92ZWN0b3IgPSBuZXcgVmVjMygpOwogIGNvbnN0IGludGVyc2VjdFRyaW1lc2hfbm9ybWFsID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RUcmltZXNoX2xvY2FsRGlyZWN0aW9uID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RUcmltZXNoX2xvY2FsRnJvbSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW50ZXJzZWN0VHJpbWVzaF9sb2NhbFRvID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RUcmltZXNoX3dvcmxkTm9ybWFsID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RUcmltZXNoX3dvcmxkSW50ZXJzZWN0UG9pbnQgPSBuZXcgVmVjMygpOwogIG5ldyBBQUJCKCk7CiAgY29uc3QgaW50ZXJzZWN0VHJpbWVzaF90cmlhbmdsZXMgPSBbXTsKICBjb25zdCBpbnRlcnNlY3RUcmltZXNoX3RyZWVUcmFuc2Zvcm0gPSBuZXcgVHJhbnNmb3JtKCk7CiAgY29uc3QgdjAgPSBuZXcgVmVjMygpOwogIGNvbnN0IGludGVyc2VjdCA9IG5ldyBWZWMzKCk7CgogIGZ1bmN0aW9uIGRpc3RhbmNlRnJvbUludGVyc2VjdGlvbihmcm9tLCBkaXJlY3Rpb24sIHBvc2l0aW9uKSB7CiAgICAvLyB2MCBpcyB2ZWN0b3IgZnJvbSBmcm9tIHRvIHBvc2l0aW9uCiAgICBwb3NpdGlvbi52c3ViKGZyb20sIHYwKTsKICAgIGNvbnN0IGRvdCA9IHYwLmRvdChkaXJlY3Rpb24pOyAvLyBpbnRlcnNlY3QgPSBkaXJlY3Rpb24qZG90ICsgZnJvbQoKICAgIGRpcmVjdGlvbi5zY2FsZShkb3QsIGludGVyc2VjdCk7CiAgICBpbnRlcnNlY3QudmFkZChmcm9tLCBpbnRlcnNlY3QpOwogICAgY29uc3QgZGlzdGFuY2UgPSBwb3NpdGlvbi5kaXN0YW5jZVRvKGludGVyc2VjdCk7CiAgICByZXR1cm4gZGlzdGFuY2U7CiAgfQoKICAvKioKICAgKiBTd2VlcCBhbmQgcHJ1bmUgYnJvYWRwaGFzZSBhbG9uZyBvbmUgYXhpcy4KICAgKi8KICBjbGFzcyBTQVBCcm9hZHBoYXNlIGV4dGVuZHMgQnJvYWRwaGFzZSB7CiAgICAvKioKICAgICAqIExpc3Qgb2YgYm9kaWVzIGN1cnJlbnRseSBpbiB0aGUgYnJvYWRwaGFzZS4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIHdvcmxkIHRvIHNlYXJjaCBpbi4KICAgICAqLwoKICAgIC8qKgogICAgICogQXhpcyB0byBzb3J0IHRoZSBib2RpZXMgYWxvbmcuCiAgICAgKiBTZXQgdG8gMCBmb3IgeCBheGlzLCBhbmQgMSBmb3IgeSBheGlzLgogICAgICogRm9yIGJlc3QgcGVyZm9ybWFuY2UsIHBpY2sgdGhlIGF4aXMgd2hlcmUgYm9kaWVzIGFyZSBtb3N0IGRpc3RyaWJ1dGVkLgogICAgICovCgogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgYm91bmRzIG9mIHR3byBib2RpZXMgb3ZlcmxhcCwgYWxvbmcgdGhlIGdpdmVuIFNBUCBheGlzLgogICAgICovCiAgICBzdGF0aWMgY2hlY2tCb3VuZHMoYmksIGJqLCBheGlzSW5kZXgpIHsKICAgICAgbGV0IGJpUG9zOwogICAgICBsZXQgYmpQb3M7CgogICAgICBpZiAoYXhpc0luZGV4ID09PSAwKSB7CiAgICAgICAgYmlQb3MgPSBiaS5wb3NpdGlvbi54OwogICAgICAgIGJqUG9zID0gYmoucG9zaXRpb24ueDsKICAgICAgfSBlbHNlIGlmIChheGlzSW5kZXggPT09IDEpIHsKICAgICAgICBiaVBvcyA9IGJpLnBvc2l0aW9uLnk7CiAgICAgICAgYmpQb3MgPSBiai5wb3NpdGlvbi55OwogICAgICB9IGVsc2UgaWYgKGF4aXNJbmRleCA9PT0gMikgewogICAgICAgIGJpUG9zID0gYmkucG9zaXRpb24uejsKICAgICAgICBialBvcyA9IGJqLnBvc2l0aW9uLno7CiAgICAgIH0KCiAgICAgIGNvbnN0IHJpID0gYmkuYm91bmRpbmdSYWRpdXMsCiAgICAgICAgICAgIHJqID0gYmouYm91bmRpbmdSYWRpdXMsCiAgICAgICAgICAgIGJvdW5kQTIgPSBiaVBvcyArIHJpLAogICAgICAgICAgICBib3VuZEIxID0gYmpQb3MgLSByajsKICAgICAgcmV0dXJuIGJvdW5kQjEgPCBib3VuZEEyOwogICAgfSAvLyBOb3RlOiB0aGVzZSBhcmUgaWRlbnRpY2FsLCBzYXZlIGZvciB4L3kveiBsb3dlcmJvdW5kCgogICAgLyoqCiAgICAgKiBpbnNlcnRpb25Tb3J0WAogICAgICovCgoKICAgIHN0YXRpYyBpbnNlcnRpb25Tb3J0WChhKSB7CiAgICAgIGZvciAobGV0IGkgPSAxLCBsID0gYS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBjb25zdCB2ID0gYVtpXTsKICAgICAgICBsZXQgajsKCiAgICAgICAgZm9yIChqID0gaSAtIDE7IGogPj0gMDsgai0tKSB7CiAgICAgICAgICBpZiAoYVtqXS5hYWJiLmxvd2VyQm91bmQueCA8PSB2LmFhYmIubG93ZXJCb3VuZC54KSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICAgIGFbaiArIDFdID0gYVtqXTsKICAgICAgICB9CgogICAgICAgIGFbaiArIDFdID0gdjsKICAgICAgfQoKICAgICAgcmV0dXJuIGE7CiAgICB9CiAgICAvKioKICAgICAqIGluc2VydGlvblNvcnRZCiAgICAgKi8KCgogICAgc3RhdGljIGluc2VydGlvblNvcnRZKGEpIHsKICAgICAgZm9yIChsZXQgaSA9IDEsIGwgPSBhLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGNvbnN0IHYgPSBhW2ldOwogICAgICAgIGxldCBqOwoKICAgICAgICBmb3IgKGogPSBpIC0gMTsgaiA+PSAwOyBqLS0pIHsKICAgICAgICAgIGlmIChhW2pdLmFhYmIubG93ZXJCb3VuZC55IDw9IHYuYWFiYi5sb3dlckJvdW5kLnkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgYVtqICsgMV0gPSBhW2pdOwogICAgICAgIH0KCiAgICAgICAgYVtqICsgMV0gPSB2OwogICAgICB9CgogICAgICByZXR1cm4gYTsKICAgIH0KICAgIC8qKgogICAgICogaW5zZXJ0aW9uU29ydFoKICAgICAqLwoKCiAgICBzdGF0aWMgaW5zZXJ0aW9uU29ydFooYSkgewogICAgICBmb3IgKGxldCBpID0gMSwgbCA9IGEubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgY29uc3QgdiA9IGFbaV07CiAgICAgICAgbGV0IGo7CgogICAgICAgIGZvciAoaiA9IGkgLSAxOyBqID49IDA7IGotLSkgewogICAgICAgICAgaWYgKGFbal0uYWFiYi5sb3dlckJvdW5kLnogPD0gdi5hYWJiLmxvd2VyQm91bmQueikgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICBhW2ogKyAxXSA9IGFbal07CiAgICAgICAgfQoKICAgICAgICBhW2ogKyAxXSA9IHY7CiAgICAgIH0KCiAgICAgIHJldHVybiBhOwogICAgfQoKICAgIGNvbnN0cnVjdG9yKHdvcmxkKSB7CiAgICAgIHN1cGVyKCk7CiAgICAgIHRoaXMuYXhpc0xpc3QgPSBbXTsKICAgICAgdGhpcy53b3JsZCA9IG51bGw7CiAgICAgIHRoaXMuYXhpc0luZGV4ID0gMDsKICAgICAgY29uc3QgYXhpc0xpc3QgPSB0aGlzLmF4aXNMaXN0OwoKICAgICAgdGhpcy5fYWRkQm9keUhhbmRsZXIgPSBldmVudCA9PiB7CiAgICAgICAgYXhpc0xpc3QucHVzaChldmVudC5ib2R5KTsKICAgICAgfTsKCiAgICAgIHRoaXMuX3JlbW92ZUJvZHlIYW5kbGVyID0gZXZlbnQgPT4gewogICAgICAgIGNvbnN0IGlkeCA9IGF4aXNMaXN0LmluZGV4T2YoZXZlbnQuYm9keSk7CgogICAgICAgIGlmIChpZHggIT09IC0xKSB7CiAgICAgICAgICBheGlzTGlzdC5zcGxpY2UoaWR4LCAxKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAod29ybGQpIHsKICAgICAgICB0aGlzLnNldFdvcmxkKHdvcmxkKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDaGFuZ2UgdGhlIHdvcmxkCiAgICAgKi8KCgogICAgc2V0V29ybGQod29ybGQpIHsKICAgICAgLy8gQ2xlYXIgdGhlIG9sZCBheGlzIGFycmF5CiAgICAgIHRoaXMuYXhpc0xpc3QubGVuZ3RoID0gMDsgLy8gQWRkIGFsbCBib2RpZXMgZnJvbSB0aGUgbmV3IHdvcmxkCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdvcmxkLmJvZGllcy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuYXhpc0xpc3QucHVzaCh3b3JsZC5ib2RpZXNbaV0pOwogICAgICB9IC8vIFJlbW92ZSBvbGQgaGFuZGxlcnMsIGlmIGFueQoKCiAgICAgIHdvcmxkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2FkZEJvZHknLCB0aGlzLl9hZGRCb2R5SGFuZGxlcik7CiAgICAgIHdvcmxkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3JlbW92ZUJvZHknLCB0aGlzLl9yZW1vdmVCb2R5SGFuZGxlcik7IC8vIEFkZCBoYW5kbGVycyB0byB1cGRhdGUgdGhlIGxpc3Qgb2YgYm9kaWVzLgoKICAgICAgd29ybGQuYWRkRXZlbnRMaXN0ZW5lcignYWRkQm9keScsIHRoaXMuX2FkZEJvZHlIYW5kbGVyKTsKICAgICAgd29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncmVtb3ZlQm9keScsIHRoaXMuX3JlbW92ZUJvZHlIYW5kbGVyKTsKICAgICAgdGhpcy53b3JsZCA9IHdvcmxkOwogICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogQ29sbGVjdCBhbGwgY29sbGlzaW9uIHBhaXJzCiAgICAgKi8KCgogICAgY29sbGlzaW9uUGFpcnMod29ybGQsIHAxLCBwMikgewogICAgICBjb25zdCBib2RpZXMgPSB0aGlzLmF4aXNMaXN0OwogICAgICBjb25zdCBOID0gYm9kaWVzLmxlbmd0aDsKICAgICAgY29uc3QgYXhpc0luZGV4ID0gdGhpcy5heGlzSW5kZXg7CiAgICAgIGxldCBpOwogICAgICBsZXQgajsKCiAgICAgIGlmICh0aGlzLmRpcnR5KSB7CiAgICAgICAgdGhpcy5zb3J0TGlzdCgpOwogICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgfSAvLyBMb29rIHRocm91Z2ggdGhlIGxpc3QKCgogICAgICBmb3IgKGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBjb25zdCBiaSA9IGJvZGllc1tpXTsKCiAgICAgICAgZm9yIChqID0gaSArIDE7IGogPCBOOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGJqID0gYm9kaWVzW2pdOwoKICAgICAgICAgIGlmICghdGhpcy5uZWVkQnJvYWRwaGFzZUNvbGxpc2lvbihiaSwgYmopKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghU0FQQnJvYWRwaGFzZS5jaGVja0JvdW5kcyhiaSwgYmosIGF4aXNJbmRleCkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5pbnRlcnNlY3Rpb25UZXN0KGJpLCBiaiwgcDEsIHAyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBzb3J0TGlzdCgpIHsKICAgICAgY29uc3QgYXhpc0xpc3QgPSB0aGlzLmF4aXNMaXN0OwogICAgICBjb25zdCBheGlzSW5kZXggPSB0aGlzLmF4aXNJbmRleDsKICAgICAgY29uc3QgTiA9IGF4aXNMaXN0Lmxlbmd0aDsgLy8gVXBkYXRlIEFBQkJzCgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgY29uc3QgYmkgPSBheGlzTGlzdFtpXTsKCiAgICAgICAgaWYgKGJpLmFhYmJOZWVkc1VwZGF0ZSkgewogICAgICAgICAgYmkudXBkYXRlQUFCQigpOwogICAgICAgIH0KICAgICAgfSAvLyBTb3J0IHRoZSBsaXN0CgoKICAgICAgaWYgKGF4aXNJbmRleCA9PT0gMCkgewogICAgICAgIFNBUEJyb2FkcGhhc2UuaW5zZXJ0aW9uU29ydFgoYXhpc0xpc3QpOwogICAgICB9IGVsc2UgaWYgKGF4aXNJbmRleCA9PT0gMSkgewogICAgICAgIFNBUEJyb2FkcGhhc2UuaW5zZXJ0aW9uU29ydFkoYXhpc0xpc3QpOwogICAgICB9IGVsc2UgaWYgKGF4aXNJbmRleCA9PT0gMikgewogICAgICAgIFNBUEJyb2FkcGhhc2UuaW5zZXJ0aW9uU29ydFooYXhpc0xpc3QpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGVzIHRoZSB2YXJpYW5jZSBvZiB0aGUgYm9keSBwb3NpdGlvbnMgYW5kIGVzdGltYXRlcyB0aGUgYmVzdCBheGlzIHRvIHVzZS4KICAgICAqIFdpbGwgYXV0b21hdGljYWxseSBzZXQgcHJvcGVydHkgYGF4aXNJbmRleGAuCiAgICAgKi8KCgogICAgYXV0b0RldGVjdEF4aXMoKSB7CiAgICAgIGxldCBzdW1YID0gMDsKICAgICAgbGV0IHN1bVgyID0gMDsKICAgICAgbGV0IHN1bVkgPSAwOwogICAgICBsZXQgc3VtWTIgPSAwOwogICAgICBsZXQgc3VtWiA9IDA7CiAgICAgIGxldCBzdW1aMiA9IDA7CiAgICAgIGNvbnN0IGJvZGllcyA9IHRoaXMuYXhpc0xpc3Q7CiAgICAgIGNvbnN0IE4gPSBib2RpZXMubGVuZ3RoOwogICAgICBjb25zdCBpbnZOID0gMSAvIE47CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgY29uc3QgYiA9IGJvZGllc1tpXTsKICAgICAgICBjb25zdCBjZW50ZXJYID0gYi5wb3NpdGlvbi54OwogICAgICAgIHN1bVggKz0gY2VudGVyWDsKICAgICAgICBzdW1YMiArPSBjZW50ZXJYICogY2VudGVyWDsKICAgICAgICBjb25zdCBjZW50ZXJZID0gYi5wb3NpdGlvbi55OwogICAgICAgIHN1bVkgKz0gY2VudGVyWTsKICAgICAgICBzdW1ZMiArPSBjZW50ZXJZICogY2VudGVyWTsKICAgICAgICBjb25zdCBjZW50ZXJaID0gYi5wb3NpdGlvbi56OwogICAgICAgIHN1bVogKz0gY2VudGVyWjsKICAgICAgICBzdW1aMiArPSBjZW50ZXJaICogY2VudGVyWjsKICAgICAgfQoKICAgICAgY29uc3QgdmFyaWFuY2VYID0gc3VtWDIgLSBzdW1YICogc3VtWCAqIGludk47CiAgICAgIGNvbnN0IHZhcmlhbmNlWSA9IHN1bVkyIC0gc3VtWSAqIHN1bVkgKiBpbnZOOwogICAgICBjb25zdCB2YXJpYW5jZVogPSBzdW1aMiAtIHN1bVogKiBzdW1aICogaW52TjsKCiAgICAgIGlmICh2YXJpYW5jZVggPiB2YXJpYW5jZVkpIHsKICAgICAgICBpZiAodmFyaWFuY2VYID4gdmFyaWFuY2VaKSB7CiAgICAgICAgICB0aGlzLmF4aXNJbmRleCA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuYXhpc0luZGV4ID0gMjsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAodmFyaWFuY2VZID4gdmFyaWFuY2VaKSB7CiAgICAgICAgdGhpcy5heGlzSW5kZXggPSAxOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYXhpc0luZGV4ID0gMjsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGFsbCB0aGUgYm9kaWVzIHdpdGhpbiBhbiBBQUJCLgogICAgICogQHBhcmFtIHJlc3VsdCBBbiBhcnJheSB0byBzdG9yZSByZXN1bHRpbmcgYm9kaWVzIGluLgogICAgICovCgoKICAgIGFhYmJRdWVyeSh3b3JsZCwgYWFiYiwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IFtdOwogICAgICB9CgogICAgICBpZiAodGhpcy5kaXJ0eSkgewogICAgICAgIHRoaXMuc29ydExpc3QoKTsKICAgICAgICB0aGlzLmRpcnR5ID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIGNvbnN0IGF4aXNJbmRleCA9IHRoaXMuYXhpc0luZGV4OwogICAgICBsZXQgYXhpcyA9ICd4JzsKCiAgICAgIGlmIChheGlzSW5kZXggPT09IDEpIHsKICAgICAgICBheGlzID0gJ3knOwogICAgICB9CgogICAgICBpZiAoYXhpc0luZGV4ID09PSAyKSB7CiAgICAgICAgYXhpcyA9ICd6JzsKICAgICAgfQoKICAgICAgY29uc3QgYXhpc0xpc3QgPSB0aGlzLmF4aXNMaXN0OwogICAgICBhYWJiLmxvd2VyQm91bmRbYXhpc107CiAgICAgIGFhYmIudXBwZXJCb3VuZFtheGlzXTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXhpc0xpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBiID0gYXhpc0xpc3RbaV07CgogICAgICAgIGlmIChiLmFhYmJOZWVkc1VwZGF0ZSkgewogICAgICAgICAgYi51cGRhdGVBQUJCKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoYi5hYWJiLm92ZXJsYXBzKGFhYmIpKSB7CiAgICAgICAgICByZXN1bHQucHVzaChiKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogIH0KCiAgY2xhc3MgVXRpbHMgewogICAgLyoqCiAgICAgKiBFeHRlbmQgYW4gb3B0aW9ucyBvYmplY3Qgd2l0aCBkZWZhdWx0IHZhbHVlcy4KICAgICAqIEBwYXJhbSBvcHRpb25zIFRoZSBvcHRpb25zIG9iamVjdC4gTWF5IGJlIGZhbHN5OiBpbiB0aGlzIGNhc2UsIGEgbmV3IG9iamVjdCBpcyBjcmVhdGVkIGFuZCByZXR1cm5lZC4KICAgICAqIEBwYXJhbSBkZWZhdWx0cyBBbiBvYmplY3QgY29udGFpbmluZyBkZWZhdWx0IHZhbHVlcy4KICAgICAqIEByZXR1cm4gVGhlIG1vZGlmaWVkIG9wdGlvbnMgb2JqZWN0LgogICAgICovCiAgICBzdGF0aWMgZGVmYXVsdHMob3B0aW9ucywgZGVmYXVsdHMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgZm9yIChsZXQga2V5IGluIGRlZmF1bHRzKSB7CiAgICAgICAgaWYgKCEoa2V5IGluIG9wdGlvbnMpKSB7CiAgICAgICAgICBvcHRpb25zW2tleV0gPSBkZWZhdWx0c1trZXldOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG9wdGlvbnM7CiAgICB9CgogIH0KCiAgLyoqCiAgICogQ29uc3RyYWludCBiYXNlIGNsYXNzCiAgICovCiAgY2xhc3MgQ29uc3RyYWludCB7CiAgICAvKioKICAgICAqIEVxdWF0aW9ucyB0byBiZSBzb2x2ZWQgaW4gdGhpcyBjb25zdHJhaW50LgogICAgICovCgogICAgLyoqCiAgICAgKiBCb2R5IEEuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEJvZHkgQi4KICAgICAqLwoKICAgIC8qKgogICAgICogU2V0IHRvIGZhbHNlIGlmIHlvdSBkb24ndCB3YW50IHRoZSBib2RpZXMgdG8gY29sbGlkZSB3aGVuIHRoZXkgYXJlIGNvbm5lY3RlZC4KICAgICAqLwogICAgY29uc3RydWN0b3IoYm9keUEsIGJvZHlCLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBVdGlscy5kZWZhdWx0cyhvcHRpb25zLCB7CiAgICAgICAgY29sbGlkZUNvbm5lY3RlZDogdHJ1ZSwKICAgICAgICB3YWtlVXBCb2RpZXM6IHRydWUKICAgICAgfSk7CiAgICAgIHRoaXMuZXF1YXRpb25zID0gW107CiAgICAgIHRoaXMuYm9keUEgPSBib2R5QTsKICAgICAgdGhpcy5ib2R5QiA9IGJvZHlCOwogICAgICB0aGlzLmlkID0gQ29uc3RyYWludC5pZENvdW50ZXIrKzsKICAgICAgdGhpcy5jb2xsaWRlQ29ubmVjdGVkID0gb3B0aW9ucy5jb2xsaWRlQ29ubmVjdGVkOwoKICAgICAgaWYgKG9wdGlvbnMud2FrZVVwQm9kaWVzKSB7CiAgICAgICAgaWYgKGJvZHlBKSB7CiAgICAgICAgICBib2R5QS53YWtlVXAoKTsKICAgICAgICB9CgogICAgICAgIGlmIChib2R5QikgewogICAgICAgICAgYm9keUIud2FrZVVwKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZSBhbGwgdGhlIGVxdWF0aW9ucyB3aXRoIGRhdGEuCiAgICAgKi8KCgogICAgdXBkYXRlKCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ21ldGhvZCB1cGRhdGUoKSBub3QgaW1wbG1lbWVudGVkIGluIHRoaXMgQ29uc3RyYWludCBzdWJjbGFzcyEnKTsKICAgIH0KICAgIC8qKgogICAgICogRW5hYmxlcyBhbGwgZXF1YXRpb25zIGluIHRoZSBjb25zdHJhaW50LgogICAgICovCgoKICAgIGVuYWJsZSgpIHsKICAgICAgY29uc3QgZXFzID0gdGhpcy5lcXVhdGlvbnM7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVxcy5sZW5ndGg7IGkrKykgewogICAgICAgIGVxc1tpXS5lbmFibGVkID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBEaXNhYmxlcyBhbGwgZXF1YXRpb25zIGluIHRoZSBjb25zdHJhaW50LgogICAgICovCgoKICAgIGRpc2FibGUoKSB7CiAgICAgIGNvbnN0IGVxcyA9IHRoaXMuZXF1YXRpb25zOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlcXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBlcXNbaV0uZW5hYmxlZCA9IGZhbHNlOwogICAgICB9CiAgICB9CgogIH0KICBDb25zdHJhaW50LmlkQ291bnRlciA9IDA7CgogIC8qKgogICAqIEFuIGVsZW1lbnQgY29udGFpbmluZyA2IGVudHJpZXMsIDMgc3BhdGlhbCBhbmQgMyByb3RhdGlvbmFsIGRlZ3JlZXMgb2YgZnJlZWRvbS4KICAgKi8KCiAgY2xhc3MgSmFjb2JpYW5FbGVtZW50IHsKICAgIC8qKgogICAgICogc3BhdGlhbAogICAgICovCgogICAgLyoqCiAgICAgKiByb3RhdGlvbmFsCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKCkgewogICAgICB0aGlzLnNwYXRpYWwgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnJvdGF0aW9uYWwgPSBuZXcgVmVjMygpOwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSB3aXRoIG90aGVyIEphY29iaWFuRWxlbWVudAogICAgICovCgoKICAgIG11bHRpcGx5RWxlbWVudChlbGVtZW50KSB7CiAgICAgIHJldHVybiBlbGVtZW50LnNwYXRpYWwuZG90KHRoaXMuc3BhdGlhbCkgKyBlbGVtZW50LnJvdGF0aW9uYWwuZG90KHRoaXMucm90YXRpb25hbCk7CiAgICB9CiAgICAvKioKICAgICAqIE11bHRpcGx5IHdpdGggdHdvIHZlY3RvcnMKICAgICAqLwoKCiAgICBtdWx0aXBseVZlY3RvcnMoc3BhdGlhbCwgcm90YXRpb25hbCkgewogICAgICByZXR1cm4gc3BhdGlhbC5kb3QodGhpcy5zcGF0aWFsKSArIHJvdGF0aW9uYWwuZG90KHRoaXMucm90YXRpb25hbCk7CiAgICB9CgogIH0KCiAgLyoqCiAgICogRXF1YXRpb24gYmFzZSBjbGFzcy4KICAgKgogICAqIGBhYCwgYGJgIGFuZCBgZXBzYCBhcmUge0BsaW5rIGh0dHBzOi8vd3d3OC5jcy51bXUuc2Uva3Vyc2VyLzVEVjA1OC9WVDE1L2xlY3R1cmVzL1NQT09LbGFibm90ZXMucGRmIFNQT09LfSBwYXJhbWV0ZXJzIHRoYXQgZGVmYXVsdCB0byBgMC4wYC4gU2VlIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vc2NodGVwcGUvY2Fubm9uLmpzL2lzc3Vlcy8yMzgjaXNzdWVjb21tZW50LTE0NzE3MjMyNyB0aGlzIGV4Y2hhbmdlfSBmb3IgbW9yZSBkZXRhaWxzIG9uIENhbm5vbidzIHBoeXNpY3MgaW1wbGVtZW50YXRpb24uCiAgICovCiAgY2xhc3MgRXF1YXRpb24gewogICAgLyoqCiAgICAgKiBNaW5pbXVtIChyZWFkOiBuZWdhdGl2ZSBtYXgpIGZvcmNlIHRvIGJlIGFwcGxpZWQgYnkgdGhlIGNvbnN0cmFpbnQuCiAgICAgKi8KCiAgICAvKioKICAgICAqIE1heGltdW0gKHJlYWQ6IHBvc2l0aXZlIG1heCkgZm9yY2UgdG8gYmUgYXBwbGllZCBieSB0aGUgY29uc3RyYWludC4KICAgICAqLwoKICAgIC8qKgogICAgICogU1BPT0sgcGFyYW1ldGVyCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNQT09LIHBhcmFtZXRlcgogICAgICovCgogICAgLyoqCiAgICAgKiBTUE9PSyBwYXJhbWV0ZXIKICAgICAqLwoKICAgIC8qKgogICAgICogQSBudW1iZXIsIHByb3BvcnRpb25hbCB0byB0aGUgZm9yY2UgYWRkZWQgdG8gdGhlIGJvZGllcy4KICAgICAqLwogICAgY29uc3RydWN0b3IoYmksIGJqLCBtaW5Gb3JjZSwgbWF4Rm9yY2UpIHsKICAgICAgaWYgKG1pbkZvcmNlID09PSB2b2lkIDApIHsKICAgICAgICBtaW5Gb3JjZSA9IC0xZTY7CiAgICAgIH0KCiAgICAgIGlmIChtYXhGb3JjZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgbWF4Rm9yY2UgPSAxZTY7CiAgICAgIH0KCiAgICAgIHRoaXMuaWQgPSBFcXVhdGlvbi5pZENvdW50ZXIrKzsKICAgICAgdGhpcy5taW5Gb3JjZSA9IG1pbkZvcmNlOwogICAgICB0aGlzLm1heEZvcmNlID0gbWF4Rm9yY2U7CiAgICAgIHRoaXMuYmkgPSBiaTsKICAgICAgdGhpcy5iaiA9IGJqOwogICAgICB0aGlzLmEgPSAwLjA7IC8vIFNQT09LIHBhcmFtZXRlcgoKICAgICAgdGhpcy5iID0gMC4wOyAvLyBTUE9PSyBwYXJhbWV0ZXIKCiAgICAgIHRoaXMuZXBzID0gMC4wOyAvLyBTUE9PSyBwYXJhbWV0ZXIKCiAgICAgIHRoaXMuamFjb2JpYW5FbGVtZW50QSA9IG5ldyBKYWNvYmlhbkVsZW1lbnQoKTsKICAgICAgdGhpcy5qYWNvYmlhbkVsZW1lbnRCID0gbmV3IEphY29iaWFuRWxlbWVudCgpOwogICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwogICAgICB0aGlzLm11bHRpcGxpZXIgPSAwOwogICAgICB0aGlzLnNldFNwb29rUGFyYW1zKDFlNywgNCwgMSAvIDYwKTsgLy8gU2V0IHR5cGljYWwgc3Bvb2sgcGFyYW1zCiAgICB9CiAgICAvKioKICAgICAqIFJlY2FsY3VsYXRlcyBhLCBiLCBhbmQgZXBzLgogICAgICoKICAgICAqIFRoZSBFcXVhdGlvbiBjb25zdHJ1Y3RvciBzZXRzIHR5cGljYWwgU1BPT0sgcGFyYW1ldGVycyBhcyBzdWNoOgogICAgICogKiBgc3RpZmZuZXNzYCA9IDFlNwogICAgICogKiBgcmVsYXhhdGlvbmAgPSA0CiAgICAgKiAqIGB0aW1lU3RlcGA9IDEgLyA2MCwgX25vdGUgdGhlIGhhcmRjb2RlZCByZWZyZXNoIHJhdGUuXwogICAgICovCgoKICAgIHNldFNwb29rUGFyYW1zKHN0aWZmbmVzcywgcmVsYXhhdGlvbiwgdGltZVN0ZXApIHsKICAgICAgY29uc3QgZCA9IHJlbGF4YXRpb247CiAgICAgIGNvbnN0IGsgPSBzdGlmZm5lc3M7CiAgICAgIGNvbnN0IGggPSB0aW1lU3RlcDsKICAgICAgdGhpcy5hID0gNC4wIC8gKGggKiAoMSArIDQgKiBkKSk7CiAgICAgIHRoaXMuYiA9IDQuMCAqIGQgLyAoMSArIDQgKiBkKTsKICAgICAgdGhpcy5lcHMgPSA0LjAgLyAoaCAqIGggKiBrICogKDEgKyA0ICogZCkpOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyB0aGUgcmlnaHQgaGFuZCBzaWRlIG9mIHRoZSBTUE9PSyBlcXVhdGlvbgogICAgICovCgoKICAgIGNvbXB1dGVCKGEsIGIsIGgpIHsKICAgICAgY29uc3QgR1cgPSB0aGlzLmNvbXB1dGVHVygpOwogICAgICBjb25zdCBHcSA9IHRoaXMuY29tcHV0ZUdxKCk7CiAgICAgIGNvbnN0IEdpTWYgPSB0aGlzLmNvbXB1dGVHaU1mKCk7CiAgICAgIHJldHVybiAtR3EgKiBhIC0gR1cgKiBiIC0gR2lNZiAqIGg7CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGVzIEcqcSwgd2hlcmUgcSBhcmUgdGhlIGdlbmVyYWxpemVkIGJvZHkgY29vcmRpbmF0ZXMKICAgICAqLwoKCiAgICBjb21wdXRlR3EoKSB7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsKICAgICAgY29uc3QgYmkgPSB0aGlzLmJpOwogICAgICBjb25zdCBiaiA9IHRoaXMuYmo7CiAgICAgIGNvbnN0IHhpID0gYmkucG9zaXRpb247CiAgICAgIGNvbnN0IHhqID0gYmoucG9zaXRpb247CiAgICAgIHJldHVybiBHQS5zcGF0aWFsLmRvdCh4aSkgKyBHQi5zcGF0aWFsLmRvdCh4aik7CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGVzIEcqVywgd2hlcmUgVyBhcmUgdGhlIGJvZHkgdmVsb2NpdGllcwogICAgICovCgoKICAgIGNvbXB1dGVHVygpIHsKICAgICAgY29uc3QgR0EgPSB0aGlzLmphY29iaWFuRWxlbWVudEE7CiAgICAgIGNvbnN0IEdCID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRCOwogICAgICBjb25zdCBiaSA9IHRoaXMuYmk7CiAgICAgIGNvbnN0IGJqID0gdGhpcy5iajsKICAgICAgY29uc3QgdmkgPSBiaS52ZWxvY2l0eTsKICAgICAgY29uc3QgdmogPSBiai52ZWxvY2l0eTsKICAgICAgY29uc3Qgd2kgPSBiaS5hbmd1bGFyVmVsb2NpdHk7CiAgICAgIGNvbnN0IHdqID0gYmouYW5ndWxhclZlbG9jaXR5OwogICAgICByZXR1cm4gR0EubXVsdGlwbHlWZWN0b3JzKHZpLCB3aSkgKyBHQi5tdWx0aXBseVZlY3RvcnModmosIHdqKTsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZXMgRypXbGFtYmRhLCB3aGVyZSBXIGFyZSB0aGUgYm9keSB2ZWxvY2l0aWVzCiAgICAgKi8KCgogICAgY29tcHV0ZUdXbGFtYmRhKCkgewogICAgICBjb25zdCBHQSA9IHRoaXMuamFjb2JpYW5FbGVtZW50QTsKICAgICAgY29uc3QgR0IgPSB0aGlzLmphY29iaWFuRWxlbWVudEI7CiAgICAgIGNvbnN0IGJpID0gdGhpcy5iaTsKICAgICAgY29uc3QgYmogPSB0aGlzLmJqOwogICAgICBjb25zdCB2aSA9IGJpLnZsYW1iZGE7CiAgICAgIGNvbnN0IHZqID0gYmoudmxhbWJkYTsKICAgICAgY29uc3Qgd2kgPSBiaS53bGFtYmRhOwogICAgICBjb25zdCB3aiA9IGJqLndsYW1iZGE7CiAgICAgIHJldHVybiBHQS5tdWx0aXBseVZlY3RvcnModmksIHdpKSArIEdCLm11bHRpcGx5VmVjdG9ycyh2aiwgd2opOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyBHKmludihNKSpmLCB3aGVyZSBNIGlzIHRoZSBtYXNzIG1hdHJpeCB3aXRoIGRpYWdvbmFsIGJsb2NrcyBmb3IgZWFjaCBib2R5LCBhbmQgZiBhcmUgdGhlIGZvcmNlcyBvbiB0aGUgYm9kaWVzLgogICAgICovCgoKICAgIGNvbXB1dGVHaU1mKCkgewogICAgICBjb25zdCBHQSA9IHRoaXMuamFjb2JpYW5FbGVtZW50QTsKICAgICAgY29uc3QgR0IgPSB0aGlzLmphY29iaWFuRWxlbWVudEI7CiAgICAgIGNvbnN0IGJpID0gdGhpcy5iaTsKICAgICAgY29uc3QgYmogPSB0aGlzLmJqOwogICAgICBjb25zdCBmaSA9IGJpLmZvcmNlOwogICAgICBjb25zdCB0aSA9IGJpLnRvcnF1ZTsKICAgICAgY29uc3QgZmogPSBiai5mb3JjZTsKICAgICAgY29uc3QgdGogPSBiai50b3JxdWU7CiAgICAgIGNvbnN0IGludk1hc3NpID0gYmkuaW52TWFzc1NvbHZlOwogICAgICBjb25zdCBpbnZNYXNzaiA9IGJqLmludk1hc3NTb2x2ZTsKICAgICAgZmkuc2NhbGUoaW52TWFzc2ksIGlNZmkpOwogICAgICBmai5zY2FsZShpbnZNYXNzaiwgaU1maik7CiAgICAgIGJpLmludkluZXJ0aWFXb3JsZFNvbHZlLnZtdWx0KHRpLCBpbnZJaV92bXVsdF90YXVpKTsKICAgICAgYmouaW52SW5lcnRpYVdvcmxkU29sdmUudm11bHQodGosIGludklqX3ZtdWx0X3RhdWopOwogICAgICByZXR1cm4gR0EubXVsdGlwbHlWZWN0b3JzKGlNZmksIGludklpX3ZtdWx0X3RhdWkpICsgR0IubXVsdGlwbHlWZWN0b3JzKGlNZmosIGludklqX3ZtdWx0X3RhdWopOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyBHKmludihNKSpHJwogICAgICovCgoKICAgIGNvbXB1dGVHaU1HdCgpIHsKICAgICAgY29uc3QgR0EgPSB0aGlzLmphY29iaWFuRWxlbWVudEE7CiAgICAgIGNvbnN0IEdCID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRCOwogICAgICBjb25zdCBiaSA9IHRoaXMuYmk7CiAgICAgIGNvbnN0IGJqID0gdGhpcy5iajsKICAgICAgY29uc3QgaW52TWFzc2kgPSBiaS5pbnZNYXNzU29sdmU7CiAgICAgIGNvbnN0IGludk1hc3NqID0gYmouaW52TWFzc1NvbHZlOwogICAgICBjb25zdCBpbnZJaSA9IGJpLmludkluZXJ0aWFXb3JsZFNvbHZlOwogICAgICBjb25zdCBpbnZJaiA9IGJqLmludkluZXJ0aWFXb3JsZFNvbHZlOwogICAgICBsZXQgcmVzdWx0ID0gaW52TWFzc2kgKyBpbnZNYXNzajsKICAgICAgaW52SWkudm11bHQoR0Eucm90YXRpb25hbCwgdG1wKTsKICAgICAgcmVzdWx0ICs9IHRtcC5kb3QoR0Eucm90YXRpb25hbCk7CiAgICAgIGludklqLnZtdWx0KEdCLnJvdGF0aW9uYWwsIHRtcCk7CiAgICAgIHJlc3VsdCArPSB0bXAuZG90KEdCLnJvdGF0aW9uYWwpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgY29uc3RyYWludCB2ZWxvY2l0eSB0byB0aGUgYm9kaWVzLgogICAgICovCgoKICAgIGFkZFRvV2xhbWJkYShkZWx0YWxhbWJkYSkgewogICAgICBjb25zdCBHQSA9IHRoaXMuamFjb2JpYW5FbGVtZW50QTsKICAgICAgY29uc3QgR0IgPSB0aGlzLmphY29iaWFuRWxlbWVudEI7CiAgICAgIGNvbnN0IGJpID0gdGhpcy5iaTsKICAgICAgY29uc3QgYmogPSB0aGlzLmJqOwogICAgICBjb25zdCB0ZW1wID0gYWRkVG9XbGFtYmRhX3RlbXA7IC8vIEFkZCB0byBsaW5lYXIgdmVsb2NpdHkKICAgICAgLy8gdl9sYW1iZGEgKz0gaW52KE0pICogZGVsdGFfbGFtYmEgKiBHCgogICAgICBiaS52bGFtYmRhLmFkZFNjYWxlZFZlY3RvcihiaS5pbnZNYXNzU29sdmUgKiBkZWx0YWxhbWJkYSwgR0Euc3BhdGlhbCwgYmkudmxhbWJkYSk7CiAgICAgIGJqLnZsYW1iZGEuYWRkU2NhbGVkVmVjdG9yKGJqLmludk1hc3NTb2x2ZSAqIGRlbHRhbGFtYmRhLCBHQi5zcGF0aWFsLCBiai52bGFtYmRhKTsgLy8gQWRkIHRvIGFuZ3VsYXIgdmVsb2NpdHkKCiAgICAgIGJpLmludkluZXJ0aWFXb3JsZFNvbHZlLnZtdWx0KEdBLnJvdGF0aW9uYWwsIHRlbXApOwogICAgICBiaS53bGFtYmRhLmFkZFNjYWxlZFZlY3RvcihkZWx0YWxhbWJkYSwgdGVtcCwgYmkud2xhbWJkYSk7CiAgICAgIGJqLmludkluZXJ0aWFXb3JsZFNvbHZlLnZtdWx0KEdCLnJvdGF0aW9uYWwsIHRlbXApOwogICAgICBiai53bGFtYmRhLmFkZFNjYWxlZFZlY3RvcihkZWx0YWxhbWJkYSwgdGVtcCwgYmoud2xhbWJkYSk7CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGUgdGhlIGRlbm9taW5hdG9yIHBhcnQgb2YgdGhlIFNQT09LIGVxdWF0aW9uOiBDID0gRyppbnYoTSkqRycgKyBlcHMKICAgICAqLwoKCiAgICBjb21wdXRlQygpIHsKICAgICAgcmV0dXJuIHRoaXMuY29tcHV0ZUdpTUd0KCkgKyB0aGlzLmVwczsKICAgIH0KCiAgfQogIEVxdWF0aW9uLmlkQ291bnRlciA9IDA7CiAgY29uc3QgaU1maSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaU1maiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW52SWlfdm11bHRfdGF1aSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW52SWpfdm11bHRfdGF1aiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wID0gbmV3IFZlYzMoKTsKICBjb25zdCBhZGRUb1dsYW1iZGFfdGVtcCA9IG5ldyBWZWMzKCk7CgogIC8qKgogICAqIENvbnRhY3Qvbm9uLXBlbmV0cmF0aW9uIGNvbnN0cmFpbnQgZXF1YXRpb24KICAgKi8KICBjbGFzcyBDb250YWN0RXF1YXRpb24gZXh0ZW5kcyBFcXVhdGlvbiB7CiAgICAvKioKICAgICAqICJib3VuY2luZXNzIjogdTEgPSAtZSp1MAogICAgICovCgogICAgLyoqCiAgICAgKiBXb3JsZC1vcmllbnRlZCB2ZWN0b3IgdGhhdCBnb2VzIGZyb20gdGhlIGNlbnRlciBvZiBiaSB0byB0aGUgY29udGFjdCBwb2ludC4KICAgICAqLwoKICAgIC8qKgogICAgICogV29ybGQtb3JpZW50ZWQgdmVjdG9yIHRoYXQgc3RhcnRzIGluIGJvZHkgaiBwb3NpdGlvbiBhbmQgZ29lcyB0byB0aGUgY29udGFjdCBwb2ludC4KICAgICAqLwoKICAgIC8qKgogICAgICogQ29udGFjdCBub3JtYWwsIHBvaW50aW5nIG91dCBvZiBib2R5IGkuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5QiwgbWF4Rm9yY2UpIHsKICAgICAgaWYgKG1heEZvcmNlID09PSB2b2lkIDApIHsKICAgICAgICBtYXhGb3JjZSA9IDFlNjsKICAgICAgfQoKICAgICAgc3VwZXIoYm9keUEsIGJvZHlCLCAwLCBtYXhGb3JjZSk7CiAgICAgIHRoaXMucmVzdGl0dXRpb24gPSAwLjA7CiAgICAgIHRoaXMucmkgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnJqID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5uaSA9IG5ldyBWZWMzKCk7CiAgICB9CgogICAgY29tcHV0ZUIoaCkgewogICAgICBjb25zdCBhID0gdGhpcy5hOwogICAgICBjb25zdCBiID0gdGhpcy5iOwogICAgICBjb25zdCBiaSA9IHRoaXMuYmk7CiAgICAgIGNvbnN0IGJqID0gdGhpcy5iajsKICAgICAgY29uc3QgcmkgPSB0aGlzLnJpOwogICAgICBjb25zdCByaiA9IHRoaXMucmo7CiAgICAgIGNvbnN0IHJpeG4gPSBDb250YWN0RXF1YXRpb25fY29tcHV0ZUJfdGVtcDE7CiAgICAgIGNvbnN0IHJqeG4gPSBDb250YWN0RXF1YXRpb25fY29tcHV0ZUJfdGVtcDI7CiAgICAgIGNvbnN0IHZpID0gYmkudmVsb2NpdHk7CiAgICAgIGNvbnN0IHdpID0gYmkuYW5ndWxhclZlbG9jaXR5OwogICAgICBiaS5mb3JjZTsKICAgICAgYmkudG9ycXVlOwogICAgICBjb25zdCB2aiA9IGJqLnZlbG9jaXR5OwogICAgICBjb25zdCB3aiA9IGJqLmFuZ3VsYXJWZWxvY2l0eTsKICAgICAgYmouZm9yY2U7CiAgICAgIGJqLnRvcnF1ZTsKICAgICAgY29uc3QgcGVuZXRyYXRpb25WZWMgPSBDb250YWN0RXF1YXRpb25fY29tcHV0ZUJfdGVtcDM7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsKICAgICAgY29uc3QgbiA9IHRoaXMubmk7IC8vIENhbHVjbGF0ZSBjcm9zcyBwcm9kdWN0cwoKICAgICAgcmkuY3Jvc3Mobiwgcml4bik7CiAgICAgIHJqLmNyb3NzKG4sIHJqeG4pOyAvLyBnID0geGorcmogLSh4aStyaSkKICAgICAgLy8gRyA9IFsgLW5pICAtcml4biAgbmkgIHJqeG4gXQoKICAgICAgbi5uZWdhdGUoR0Euc3BhdGlhbCk7CiAgICAgIHJpeG4ubmVnYXRlKEdBLnJvdGF0aW9uYWwpOwogICAgICBHQi5zcGF0aWFsLmNvcHkobik7CiAgICAgIEdCLnJvdGF0aW9uYWwuY29weShyanhuKTsgLy8gQ2FsY3VsYXRlIHRoZSBwZW5ldHJhdGlvbiB2ZWN0b3IKCiAgICAgIHBlbmV0cmF0aW9uVmVjLmNvcHkoYmoucG9zaXRpb24pOwogICAgICBwZW5ldHJhdGlvblZlYy52YWRkKHJqLCBwZW5ldHJhdGlvblZlYyk7CiAgICAgIHBlbmV0cmF0aW9uVmVjLnZzdWIoYmkucG9zaXRpb24sIHBlbmV0cmF0aW9uVmVjKTsKICAgICAgcGVuZXRyYXRpb25WZWMudnN1YihyaSwgcGVuZXRyYXRpb25WZWMpOwogICAgICBjb25zdCBnID0gbi5kb3QocGVuZXRyYXRpb25WZWMpOyAvLyBDb21wdXRlIGl0ZXJhdGlvbgoKICAgICAgY29uc3QgZVBsdXNPbmUgPSB0aGlzLnJlc3RpdHV0aW9uICsgMTsKICAgICAgY29uc3QgR1cgPSBlUGx1c09uZSAqIHZqLmRvdChuKSAtIGVQbHVzT25lICogdmkuZG90KG4pICsgd2ouZG90KHJqeG4pIC0gd2kuZG90KHJpeG4pOwogICAgICBjb25zdCBHaU1mID0gdGhpcy5jb21wdXRlR2lNZigpOwogICAgICBjb25zdCBCID0gLWcgKiBhIC0gR1cgKiBiIC0gaCAqIEdpTWY7CiAgICAgIHJldHVybiBCOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIGN1cnJlbnQgcmVsYXRpdmUgdmVsb2NpdHkgaW4gdGhlIGNvbnRhY3QgcG9pbnQuCiAgICAgKi8KCgogICAgZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbCgpIHsKICAgICAgY29uc3QgdmkgPSBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF92aTsKICAgICAgY29uc3QgdmogPSBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF92ajsKICAgICAgY29uc3QgeGkgPSBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF94aTsKICAgICAgY29uc3QgeGogPSBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF94ajsKICAgICAgY29uc3QgcmVsVmVsID0gQ29udGFjdEVxdWF0aW9uX2dldEltcGFjdFZlbG9jaXR5QWxvbmdOb3JtYWxfcmVsVmVsOwogICAgICB0aGlzLmJpLnBvc2l0aW9uLnZhZGQodGhpcy5yaSwgeGkpOwogICAgICB0aGlzLmJqLnBvc2l0aW9uLnZhZGQodGhpcy5yaiwgeGopOwogICAgICB0aGlzLmJpLmdldFZlbG9jaXR5QXRXb3JsZFBvaW50KHhpLCB2aSk7CiAgICAgIHRoaXMuYmouZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQoeGosIHZqKTsKICAgICAgdmkudnN1Yih2aiwgcmVsVmVsKTsKICAgICAgcmV0dXJuIHRoaXMubmkuZG90KHJlbFZlbCk7CiAgICB9CgogIH0KICBjb25zdCBDb250YWN0RXF1YXRpb25fY29tcHV0ZUJfdGVtcDEgPSBuZXcgVmVjMygpOyAvLyBUZW1wIHZlY3RvcnMKCiAgY29uc3QgQ29udGFjdEVxdWF0aW9uX2NvbXB1dGVCX3RlbXAyID0gbmV3IFZlYzMoKTsKICBjb25zdCBDb250YWN0RXF1YXRpb25fY29tcHV0ZUJfdGVtcDMgPSBuZXcgVmVjMygpOwogIGNvbnN0IENvbnRhY3RFcXVhdGlvbl9nZXRJbXBhY3RWZWxvY2l0eUFsb25nTm9ybWFsX3ZpID0gbmV3IFZlYzMoKTsKICBjb25zdCBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF92aiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQ29udGFjdEVxdWF0aW9uX2dldEltcGFjdFZlbG9jaXR5QWxvbmdOb3JtYWxfeGkgPSBuZXcgVmVjMygpOwogIGNvbnN0IENvbnRhY3RFcXVhdGlvbl9nZXRJbXBhY3RWZWxvY2l0eUFsb25nTm9ybWFsX3hqID0gbmV3IFZlYzMoKTsKICBjb25zdCBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF9yZWxWZWwgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBDb25uZWN0cyB0d28gYm9kaWVzIGF0IGdpdmVuIG9mZnNldCBwb2ludHMuCiAgICogQGV4YW1wbGUKICAgKiAgICAgY29uc3QgYm9keUEgPSBuZXcgQm9keSh7IG1hc3M6IDEgfSkKICAgKiAgICAgY29uc3QgYm9keUIgPSBuZXcgQm9keSh7IG1hc3M6IDEgfSkKICAgKiAgICAgYm9keUEucG9zaXRpb24uc2V0KC0xLCAwLCAwKQogICAqICAgICBib2R5Qi5wb3NpdGlvbi5zZXQoMSwgMCwgMCkKICAgKiAgICAgYm9keUEuYWRkU2hhcGUoc2hhcGVBKQogICAqICAgICBib2R5Qi5hZGRTaGFwZShzaGFwZUIpCiAgICogICAgIHdvcmxkLmFkZEJvZHkoYm9keUEpCiAgICogICAgIHdvcmxkLmFkZEJvZHkoYm9keUIpCiAgICogICAgIGNvbnN0IGxvY2FsUGl2b3RBID0gbmV3IFZlYzMoMSwgMCwgMCkKICAgKiAgICAgY29uc3QgbG9jYWxQaXZvdEIgPSBuZXcgVmVjMygtMSwgMCwgMCkKICAgKiAgICAgY29uc3QgY29uc3RyYWludCA9IG5ldyBQb2ludFRvUG9pbnRDb25zdHJhaW50KGJvZHlBLCBsb2NhbFBpdm90QSwgYm9keUIsIGxvY2FsUGl2b3RCKQogICAqICAgICB3b3JsZC5hZGRDb25zdHJhaW50KGNvbnN0cmFpbnQpCiAgICovCiAgY2xhc3MgUG9pbnRUb1BvaW50Q29uc3RyYWludCBleHRlbmRzIENvbnN0cmFpbnQgewogICAgLyoqCiAgICAgKiBQaXZvdCwgZGVmaW5lZCBsb2NhbGx5IGluIGJvZHlBLgogICAgICovCgogICAgLyoqCiAgICAgKiBQaXZvdCwgZGVmaW5lZCBsb2NhbGx5IGluIGJvZHlCLgogICAgICovCgogICAgLyoqCiAgICAgKiBAcGFyYW0gcGl2b3RBIFRoZSBwb2ludCByZWxhdGl2ZSB0byB0aGUgY2VudGVyIG9mIG1hc3Mgb2YgYm9keUEgd2hpY2ggYm9keUEgaXMgY29uc3RyYWluZWQgdG8uCiAgICAgKiBAcGFyYW0gYm9keUIgQm9keSB0aGF0IHdpbGwgYmUgY29uc3RyYWluZWQgaW4gYSBzaW1pbGFyIHdheSB0byB0aGUgc2FtZSBwb2ludCBhcyBib2R5QS4gV2Ugd2lsbCB0aGVyZWZvcmUgZ2V0IGEgbGluayBiZXR3ZWVuIGJvZHlBIGFuZCBib2R5Qi4gSWYgbm90IHNwZWNpZmllZCwgYm9keUEgd2lsbCBiZSBjb25zdHJhaW5lZCB0byBhIHN0YXRpYyBwb2ludC4KICAgICAqIEBwYXJhbSBwaXZvdEIgVGhlIHBvaW50IHJlbGF0aXZlIHRvIHRoZSBjZW50ZXIgb2YgbWFzcyBvZiBib2R5QiB3aGljaCBib2R5QiBpcyBjb25zdHJhaW5lZCB0by4KICAgICAqIEBwYXJhbSBtYXhGb3JjZSBUaGUgbWF4aW11bSBmb3JjZSB0aGF0IHNob3VsZCBiZSBhcHBsaWVkIHRvIGNvbnN0cmFpbiB0aGUgYm9kaWVzLgogICAgICovCiAgICBjb25zdHJ1Y3Rvcihib2R5QSwgcGl2b3RBLCBib2R5QiwgcGl2b3RCLCBtYXhGb3JjZSkgewogICAgICBpZiAocGl2b3RBID09PSB2b2lkIDApIHsKICAgICAgICBwaXZvdEEgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBpZiAocGl2b3RCID09PSB2b2lkIDApIHsKICAgICAgICBwaXZvdEIgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBpZiAobWF4Rm9yY2UgPT09IHZvaWQgMCkgewogICAgICAgIG1heEZvcmNlID0gMWU2OwogICAgICB9CgogICAgICBzdXBlcihib2R5QSwgYm9keUIpOwogICAgICB0aGlzLnBpdm90QSA9IHBpdm90QS5jbG9uZSgpOwogICAgICB0aGlzLnBpdm90QiA9IHBpdm90Qi5jbG9uZSgpOwogICAgICBjb25zdCB4ID0gdGhpcy5lcXVhdGlvblggPSBuZXcgQ29udGFjdEVxdWF0aW9uKGJvZHlBLCBib2R5Qik7CiAgICAgIGNvbnN0IHkgPSB0aGlzLmVxdWF0aW9uWSA9IG5ldyBDb250YWN0RXF1YXRpb24oYm9keUEsIGJvZHlCKTsKICAgICAgY29uc3QgeiA9IHRoaXMuZXF1YXRpb25aID0gbmV3IENvbnRhY3RFcXVhdGlvbihib2R5QSwgYm9keUIpOyAvLyBFcXVhdGlvbnMgdG8gYmUgZmVkIHRvIHRoZSBzb2x2ZXIKCiAgICAgIHRoaXMuZXF1YXRpb25zLnB1c2goeCwgeSwgeik7IC8vIE1ha2UgdGhlIGVxdWF0aW9ucyBiaWRpcmVjdGlvbmFsCgogICAgICB4Lm1pbkZvcmNlID0geS5taW5Gb3JjZSA9IHoubWluRm9yY2UgPSAtbWF4Rm9yY2U7CiAgICAgIHgubWF4Rm9yY2UgPSB5Lm1heEZvcmNlID0gei5tYXhGb3JjZSA9IG1heEZvcmNlOwogICAgICB4Lm5pLnNldCgxLCAwLCAwKTsKICAgICAgeS5uaS5zZXQoMCwgMSwgMCk7CiAgICAgIHoubmkuc2V0KDAsIDAsIDEpOwogICAgfQoKICAgIHVwZGF0ZSgpIHsKICAgICAgY29uc3QgYm9keUEgPSB0aGlzLmJvZHlBOwogICAgICBjb25zdCBib2R5QiA9IHRoaXMuYm9keUI7CiAgICAgIGNvbnN0IHggPSB0aGlzLmVxdWF0aW9uWDsKICAgICAgY29uc3QgeSA9IHRoaXMuZXF1YXRpb25ZOwogICAgICBjb25zdCB6ID0gdGhpcy5lcXVhdGlvblo7IC8vIFJvdGF0ZSB0aGUgcGl2b3RzIHRvIHdvcmxkIHNwYWNlCgogICAgICBib2R5QS5xdWF0ZXJuaW9uLnZtdWx0KHRoaXMucGl2b3RBLCB4LnJpKTsKICAgICAgYm9keUIucXVhdGVybmlvbi52bXVsdCh0aGlzLnBpdm90QiwgeC5yaik7CiAgICAgIHkucmkuY29weSh4LnJpKTsKICAgICAgeS5yai5jb3B5KHgucmopOwogICAgICB6LnJpLmNvcHkoeC5yaSk7CiAgICAgIHoucmouY29weSh4LnJqKTsKICAgIH0KCiAgfQoKICAvKioKICAgKiBDb25lIGVxdWF0aW9uLiBXb3JrcyB0byBrZWVwIHRoZSBnaXZlbiBib2R5IHdvcmxkIHZlY3RvcnMgYWxpZ25lZCwgb3IgdGlsdGVkIHdpdGhpbiBhIGdpdmVuIGFuZ2xlIGZyb20gZWFjaCBvdGhlci4KICAgKi8KICBjbGFzcyBDb25lRXF1YXRpb24gZXh0ZW5kcyBFcXVhdGlvbiB7CiAgICAvKioKICAgICAqIExvY2FsIGF4aXMgaW4gQQogICAgICovCgogICAgLyoqCiAgICAgKiBMb2NhbCBheGlzIGluIEIKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlICJjb25lIGFuZ2xlIiB0byBrZWVwCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBjb25zdCBtYXhGb3JjZSA9IHR5cGVvZiBvcHRpb25zLm1heEZvcmNlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMubWF4Rm9yY2UgOiAxZTY7CiAgICAgIHN1cGVyKGJvZHlBLCBib2R5QiwgLW1heEZvcmNlLCBtYXhGb3JjZSk7CiAgICAgIHRoaXMuYXhpc0EgPSBvcHRpb25zLmF4aXNBID8gb3B0aW9ucy5heGlzQS5jbG9uZSgpIDogbmV3IFZlYzMoMSwgMCwgMCk7CiAgICAgIHRoaXMuYXhpc0IgPSBvcHRpb25zLmF4aXNCID8gb3B0aW9ucy5heGlzQi5jbG9uZSgpIDogbmV3IFZlYzMoMCwgMSwgMCk7CiAgICAgIHRoaXMuYW5nbGUgPSB0eXBlb2Ygb3B0aW9ucy5hbmdsZSAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmFuZ2xlIDogMDsKICAgIH0KCiAgICBjb21wdXRlQihoKSB7CiAgICAgIGNvbnN0IGEgPSB0aGlzLmE7CiAgICAgIGNvbnN0IGIgPSB0aGlzLmI7CiAgICAgIGNvbnN0IG5pID0gdGhpcy5heGlzQTsKICAgICAgY29uc3QgbmogPSB0aGlzLmF4aXNCOwogICAgICBjb25zdCBuaXhuaiA9IHRtcFZlYzEkMjsKICAgICAgY29uc3Qgbmp4bmkgPSB0bXBWZWMyJDI7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsgLy8gQ2FsdWNsYXRlIGNyb3NzIHByb2R1Y3RzCgogICAgICBuaS5jcm9zcyhuaiwgbml4bmopOwogICAgICBuai5jcm9zcyhuaSwgbmp4bmkpOyAvLyBUaGUgYW5nbGUgYmV0d2VlbiB0d28gdmVjdG9yIGlzOgogICAgICAvLyBjb3ModGhldGEpID0gYSAqIGIgLyAobGVuZ3RoKGEpICogbGVuZ3RoKGIpID0geyBsZW4oYSkgPSBsZW4oYikgPSAxIH0gPSBhICogYgogICAgICAvLyBnID0gYSAqIGIKICAgICAgLy8gZ2RvdCA9IChiIHggYSkgKiB3aSArIChhIHggYikgKiB3agogICAgICAvLyBHID0gWzAgYnhhIDAgYXhiXQogICAgICAvLyBXID0gW3ZpIHdpIHZqIHdqXQoKICAgICAgR0Eucm90YXRpb25hbC5jb3B5KG5qeG5pKTsKICAgICAgR0Iucm90YXRpb25hbC5jb3B5KG5peG5qKTsKICAgICAgY29uc3QgZyA9IE1hdGguY29zKHRoaXMuYW5nbGUpIC0gbmkuZG90KG5qKTsKICAgICAgY29uc3QgR1cgPSB0aGlzLmNvbXB1dGVHVygpOwogICAgICBjb25zdCBHaU1mID0gdGhpcy5jb21wdXRlR2lNZigpOwogICAgICBjb25zdCBCID0gLWcgKiBhIC0gR1cgKiBiIC0gaCAqIEdpTWY7CiAgICAgIHJldHVybiBCOwogICAgfQoKICB9CiAgY29uc3QgdG1wVmVjMSQyID0gbmV3IFZlYzMoKTsKICBjb25zdCB0bXBWZWMyJDIgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBSb3RhdGlvbmFsIGNvbnN0cmFpbnQuIFdvcmtzIHRvIGtlZXAgdGhlIGxvY2FsIHZlY3RvcnMgb3J0aG9nb25hbCB0byBlYWNoIG90aGVyIGluIHdvcmxkIHNwYWNlLgogICAqLwogIGNsYXNzIFJvdGF0aW9uYWxFcXVhdGlvbiBleHRlbmRzIEVxdWF0aW9uIHsKICAgIC8qKgogICAgICogV29ybGQgb3JpZW50ZWQgcm90YXRpb25hbCBheGlzLgogICAgICovCgogICAgLyoqCiAgICAgKiBXb3JsZCBvcmllbnRlZCByb3RhdGlvbmFsIGF4aXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIG1heEFuZ2xlCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBjb25zdCBtYXhGb3JjZSA9IHR5cGVvZiBvcHRpb25zLm1heEZvcmNlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMubWF4Rm9yY2UgOiAxZTY7CiAgICAgIHN1cGVyKGJvZHlBLCBib2R5QiwgLW1heEZvcmNlLCBtYXhGb3JjZSk7CiAgICAgIHRoaXMuYXhpc0EgPSBvcHRpb25zLmF4aXNBID8gb3B0aW9ucy5heGlzQS5jbG9uZSgpIDogbmV3IFZlYzMoMSwgMCwgMCk7CiAgICAgIHRoaXMuYXhpc0IgPSBvcHRpb25zLmF4aXNCID8gb3B0aW9ucy5heGlzQi5jbG9uZSgpIDogbmV3IFZlYzMoMCwgMSwgMCk7CiAgICAgIHRoaXMubWF4QW5nbGUgPSBNYXRoLlBJIC8gMjsKICAgIH0KCiAgICBjb21wdXRlQihoKSB7CiAgICAgIGNvbnN0IGEgPSB0aGlzLmE7CiAgICAgIGNvbnN0IGIgPSB0aGlzLmI7CiAgICAgIGNvbnN0IG5pID0gdGhpcy5heGlzQTsKICAgICAgY29uc3QgbmogPSB0aGlzLmF4aXNCOwogICAgICBjb25zdCBuaXhuaiA9IHRtcFZlYzEkMTsKICAgICAgY29uc3Qgbmp4bmkgPSB0bXBWZWMyJDE7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsgLy8gQ2FsdWNsYXRlIGNyb3NzIHByb2R1Y3RzCgogICAgICBuaS5jcm9zcyhuaiwgbml4bmopOwogICAgICBuai5jcm9zcyhuaSwgbmp4bmkpOyAvLyBnID0gbmkgKiBuagogICAgICAvLyBnZG90ID0gKG5qIHggbmkpICogd2kgKyAobmkgeCBuaikgKiB3agogICAgICAvLyBHID0gWzAgbmp4bmkgMCBuaXhual0KICAgICAgLy8gVyA9IFt2aSB3aSB2aiB3al0KCiAgICAgIEdBLnJvdGF0aW9uYWwuY29weShuanhuaSk7CiAgICAgIEdCLnJvdGF0aW9uYWwuY29weShuaXhuaik7CiAgICAgIGNvbnN0IGcgPSBNYXRoLmNvcyh0aGlzLm1heEFuZ2xlKSAtIG5pLmRvdChuaik7CiAgICAgIGNvbnN0IEdXID0gdGhpcy5jb21wdXRlR1coKTsKICAgICAgY29uc3QgR2lNZiA9IHRoaXMuY29tcHV0ZUdpTWYoKTsKICAgICAgY29uc3QgQiA9IC1nICogYSAtIEdXICogYiAtIGggKiBHaU1mOwogICAgICByZXR1cm4gQjsKICAgIH0KCiAgfQogIGNvbnN0IHRtcFZlYzEkMSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wVmVjMiQxID0gbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogQSBDb25lIFR3aXN0IGNvbnN0cmFpbnQsIHVzZWZ1bCBmb3IgcmFnZG9sbHMuCiAgICovCiAgY2xhc3MgQ29uZVR3aXN0Q29uc3RyYWludCBleHRlbmRzIFBvaW50VG9Qb2ludENvbnN0cmFpbnQgewogICAgLyoqCiAgICAgKiBUaGUgYXhpcyBkaXJlY3Rpb24gZm9yIHRoZSBjb25zdHJhaW50IG9mIHRoZSBib2R5IEEuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBheGlzIGRpcmVjdGlvbiBmb3IgdGhlIGNvbnN0cmFpbnQgb2YgdGhlIGJvZHkgQi4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGFwZXJ0dXJlIGFuZ2xlIG9mIHRoZSBjb25lLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgdHdpc3QgYW5nbGUgb2YgdGhlIGpvaW50LgogICAgICovCiAgICBjb25zdHJ1Y3Rvcihib2R5QSwgYm9keUIsIG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgY29uc3QgbWF4Rm9yY2UgPSB0eXBlb2Ygb3B0aW9ucy5tYXhGb3JjZSAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLm1heEZvcmNlIDogMWU2OyAvLyBTZXQgcGl2b3QgcG9pbnQgaW4gYmV0d2VlbgoKICAgICAgY29uc3QgcGl2b3RBID0gb3B0aW9ucy5waXZvdEEgPyBvcHRpb25zLnBpdm90QS5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgY29uc3QgcGl2b3RCID0gb3B0aW9ucy5waXZvdEIgPyBvcHRpb25zLnBpdm90Qi5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgc3VwZXIoYm9keUEsIHBpdm90QSwgYm9keUIsIHBpdm90QiwgbWF4Rm9yY2UpOwogICAgICB0aGlzLmF4aXNBID0gb3B0aW9ucy5heGlzQSA/IG9wdGlvbnMuYXhpc0EuY2xvbmUoKSA6IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuYXhpc0IgPSBvcHRpb25zLmF4aXNCID8gb3B0aW9ucy5heGlzQi5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgdGhpcy5jb2xsaWRlQ29ubmVjdGVkID0gISFvcHRpb25zLmNvbGxpZGVDb25uZWN0ZWQ7CiAgICAgIHRoaXMuYW5nbGUgPSB0eXBlb2Ygb3B0aW9ucy5hbmdsZSAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmFuZ2xlIDogMDsKICAgICAgY29uc3QgYyA9IHRoaXMuY29uZUVxdWF0aW9uID0gbmV3IENvbmVFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICBjb25zdCB0ID0gdGhpcy50d2lzdEVxdWF0aW9uID0gbmV3IFJvdGF0aW9uYWxFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICB0aGlzLnR3aXN0QW5nbGUgPSB0eXBlb2Ygb3B0aW9ucy50d2lzdEFuZ2xlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMudHdpc3RBbmdsZSA6IDA7IC8vIE1ha2UgdGhlIGNvbmUgZXF1YXRpb24gcHVzaCB0aGUgYm9kaWVzIHRvd2FyZCB0aGUgY29uZSBheGlzLCBub3Qgb3V0d2FyZAoKICAgICAgYy5tYXhGb3JjZSA9IDA7CiAgICAgIGMubWluRm9yY2UgPSAtbWF4Rm9yY2U7IC8vIE1ha2UgdGhlIHR3aXN0IGVxdWF0aW9uIGFkZCB0b3JxdWUgdG93YXJkIHRoZSBpbml0aWFsIHBvc2l0aW9uCgogICAgICB0Lm1heEZvcmNlID0gMDsKICAgICAgdC5taW5Gb3JjZSA9IC1tYXhGb3JjZTsKICAgICAgdGhpcy5lcXVhdGlvbnMucHVzaChjLCB0KTsKICAgIH0KCiAgICB1cGRhdGUoKSB7CiAgICAgIGNvbnN0IGJvZHlBID0gdGhpcy5ib2R5QTsKICAgICAgY29uc3QgYm9keUIgPSB0aGlzLmJvZHlCOwogICAgICBjb25zdCBjb25lID0gdGhpcy5jb25lRXF1YXRpb247CiAgICAgIGNvbnN0IHR3aXN0ID0gdGhpcy50d2lzdEVxdWF0aW9uOwogICAgICBzdXBlci51cGRhdGUoKTsgLy8gVXBkYXRlIHRoZSBheGVzIHRvIHRoZSBjb25lIGNvbnN0cmFpbnQKCiAgICAgIGJvZHlBLnZlY3RvclRvV29ybGRGcmFtZSh0aGlzLmF4aXNBLCBjb25lLmF4aXNBKTsKICAgICAgYm9keUIudmVjdG9yVG9Xb3JsZEZyYW1lKHRoaXMuYXhpc0IsIGNvbmUuYXhpc0IpOyAvLyBVcGRhdGUgdGhlIHdvcmxkIGF4ZXMgaW4gdGhlIHR3aXN0IGNvbnN0cmFpbnQKCiAgICAgIHRoaXMuYXhpc0EudGFuZ2VudHModHdpc3QuYXhpc0EsIHR3aXN0LmF4aXNBKTsKICAgICAgYm9keUEudmVjdG9yVG9Xb3JsZEZyYW1lKHR3aXN0LmF4aXNBLCB0d2lzdC5heGlzQSk7CiAgICAgIHRoaXMuYXhpc0IudGFuZ2VudHModHdpc3QuYXhpc0IsIHR3aXN0LmF4aXNCKTsKICAgICAgYm9keUIudmVjdG9yVG9Xb3JsZEZyYW1lKHR3aXN0LmF4aXNCLCB0d2lzdC5heGlzQik7CiAgICAgIGNvbmUuYW5nbGUgPSB0aGlzLmFuZ2xlOwogICAgICB0d2lzdC5tYXhBbmdsZSA9IHRoaXMudHdpc3RBbmdsZTsKICAgIH0KCiAgfQogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogQ29uc3RyYWlucyB0d28gYm9kaWVzIHRvIGJlIGF0IGEgY29uc3RhbnQgZGlzdGFuY2UgZnJvbSBlYWNoIG90aGVycyBjZW50ZXIgb2YgbWFzcy4KICAgKi8KICBjbGFzcyBEaXN0YW5jZUNvbnN0cmFpbnQgZXh0ZW5kcyBDb25zdHJhaW50IHsKICAgIC8qKgogICAgICogVGhlIGRpc3RhbmNlIHRvIGtlZXAuIElmIHVuZGVmaW5lZCwgaXQgd2lsbCBiZSBzZXQgdG8gdGhlIGN1cnJlbnQgZGlzdGFuY2UgYmV0d2VlbiBib2R5QSBhbmQgYm9keUIKICAgICAqLwoKICAgIC8qKgogICAgICogQHBhcmFtIGRpc3RhbmNlIFRoZSBkaXN0YW5jZSB0byBrZWVwLiBJZiB1bmRlZmluZWQsIGl0IHdpbGwgYmUgc2V0IHRvIHRoZSBjdXJyZW50IGRpc3RhbmNlIGJldHdlZW4gYm9keUEgYW5kIGJvZHlCLgogICAgICogQHBhcmFtIG1heEZvcmNlIFRoZSBtYXhpbXVtIGZvcmNlIHRoYXQgc2hvdWxkIGJlIGFwcGxpZWQgdG8gY29uc3RyYWluIHRoZSBib2RpZXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5QiwgZGlzdGFuY2UsIG1heEZvcmNlKSB7CiAgICAgIGlmIChtYXhGb3JjZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgbWF4Rm9yY2UgPSAxZTY7CiAgICAgIH0KCiAgICAgIHN1cGVyKGJvZHlBLCBib2R5Qik7CgogICAgICBpZiAodHlwZW9mIGRpc3RhbmNlID09PSAndW5kZWZpbmVkJykgewogICAgICAgIGRpc3RhbmNlID0gYm9keUEucG9zaXRpb24uZGlzdGFuY2VUbyhib2R5Qi5wb3NpdGlvbik7CiAgICAgIH0KCiAgICAgIHRoaXMuZGlzdGFuY2UgPSBkaXN0YW5jZTsKICAgICAgY29uc3QgZXEgPSB0aGlzLmRpc3RhbmNlRXF1YXRpb24gPSBuZXcgQ29udGFjdEVxdWF0aW9uKGJvZHlBLCBib2R5Qik7CiAgICAgIHRoaXMuZXF1YXRpb25zLnB1c2goZXEpOyAvLyBNYWtlIGl0IGJpZGlyZWN0aW9uYWwKCiAgICAgIGVxLm1pbkZvcmNlID0gLW1heEZvcmNlOwogICAgICBlcS5tYXhGb3JjZSA9IG1heEZvcmNlOwogICAgfQogICAgLyoqCiAgICAgKiB1cGRhdGUKICAgICAqLwoKCiAgICB1cGRhdGUoKSB7CiAgICAgIGNvbnN0IGJvZHlBID0gdGhpcy5ib2R5QTsKICAgICAgY29uc3QgYm9keUIgPSB0aGlzLmJvZHlCOwogICAgICBjb25zdCBlcSA9IHRoaXMuZGlzdGFuY2VFcXVhdGlvbjsKICAgICAgY29uc3QgaGFsZkRpc3QgPSB0aGlzLmRpc3RhbmNlICogMC41OwogICAgICBjb25zdCBub3JtYWwgPSBlcS5uaTsKICAgICAgYm9keUIucG9zaXRpb24udnN1Yihib2R5QS5wb3NpdGlvbiwgbm9ybWFsKTsKICAgICAgbm9ybWFsLm5vcm1hbGl6ZSgpOwogICAgICBub3JtYWwuc2NhbGUoaGFsZkRpc3QsIGVxLnJpKTsKICAgICAgbm9ybWFsLnNjYWxlKC1oYWxmRGlzdCwgZXEucmopOwogICAgfQoKICB9CgogIC8qKgogICAqIExvY2sgY29uc3RyYWludC4gV2lsbCByZW1vdmUgYWxsIGRlZ3JlZXMgb2YgZnJlZWRvbSBiZXR3ZWVuIHRoZSBib2RpZXMuCiAgICovCiAgY2xhc3MgTG9ja0NvbnN0cmFpbnQgZXh0ZW5kcyBQb2ludFRvUG9pbnRDb25zdHJhaW50IHsKICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBjb25zdCBtYXhGb3JjZSA9IHR5cGVvZiBvcHRpb25zLm1heEZvcmNlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMubWF4Rm9yY2UgOiAxZTY7IC8vIFNldCBwaXZvdCBwb2ludCBpbiBiZXR3ZWVuCgogICAgICBjb25zdCBwaXZvdEEgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBwaXZvdEIgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBoYWxmV2F5ID0gbmV3IFZlYzMoKTsKICAgICAgYm9keUEucG9zaXRpb24udmFkZChib2R5Qi5wb3NpdGlvbiwgaGFsZldheSk7CiAgICAgIGhhbGZXYXkuc2NhbGUoMC41LCBoYWxmV2F5KTsKICAgICAgYm9keUIucG9pbnRUb0xvY2FsRnJhbWUoaGFsZldheSwgcGl2b3RCKTsKICAgICAgYm9keUEucG9pbnRUb0xvY2FsRnJhbWUoaGFsZldheSwgcGl2b3RBKTsgLy8gVGhlIHBvaW50LXRvLXBvaW50IGNvbnN0cmFpbnQgd2lsbCBrZWVwIGEgcG9pbnQgc2hhcmVkIGJldHdlZW4gdGhlIGJvZGllcwoKICAgICAgc3VwZXIoYm9keUEsIHBpdm90QSwgYm9keUIsIHBpdm90QiwgbWF4Rm9yY2UpOyAvLyBTdG9yZSBpbml0aWFsIHJvdGF0aW9uIG9mIHRoZSBib2RpZXMgYXMgdW5pdCB2ZWN0b3JzIGluIHRoZSBsb2NhbCBib2R5IHNwYWNlcwoKICAgICAgdGhpcy54QSA9IGJvZHlBLnZlY3RvclRvTG9jYWxGcmFtZShWZWMzLlVOSVRfWCk7CiAgICAgIHRoaXMueEIgPSBib2R5Qi52ZWN0b3JUb0xvY2FsRnJhbWUoVmVjMy5VTklUX1gpOwogICAgICB0aGlzLnlBID0gYm9keUEudmVjdG9yVG9Mb2NhbEZyYW1lKFZlYzMuVU5JVF9ZKTsKICAgICAgdGhpcy55QiA9IGJvZHlCLnZlY3RvclRvTG9jYWxGcmFtZShWZWMzLlVOSVRfWSk7CiAgICAgIHRoaXMuekEgPSBib2R5QS52ZWN0b3JUb0xvY2FsRnJhbWUoVmVjMy5VTklUX1opOwogICAgICB0aGlzLnpCID0gYm9keUIudmVjdG9yVG9Mb2NhbEZyYW1lKFZlYzMuVU5JVF9aKTsgLy8gLi4uYW5kIHRoZSBmb2xsb3dpbmcgcm90YXRpb25hbCBlcXVhdGlvbnMgd2lsbCBrZWVwIGFsbCByb3RhdGlvbmFsIERPRidzIGluIHBsYWNlCgogICAgICBjb25zdCByMSA9IHRoaXMucm90YXRpb25hbEVxdWF0aW9uMSA9IG5ldyBSb3RhdGlvbmFsRXF1YXRpb24oYm9keUEsIGJvZHlCLCBvcHRpb25zKTsKICAgICAgY29uc3QgcjIgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjIgPSBuZXcgUm90YXRpb25hbEVxdWF0aW9uKGJvZHlBLCBib2R5Qiwgb3B0aW9ucyk7CiAgICAgIGNvbnN0IHIzID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24zID0gbmV3IFJvdGF0aW9uYWxFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICB0aGlzLmVxdWF0aW9ucy5wdXNoKHIxLCByMiwgcjMpOwogICAgfQogICAgLyoqCiAgICAgKiB1cGRhdGUKICAgICAqLwoKCiAgICB1cGRhdGUoKSB7CiAgICAgIGNvbnN0IGJvZHlBID0gdGhpcy5ib2R5QTsKICAgICAgY29uc3QgYm9keUIgPSB0aGlzLmJvZHlCOwogICAgICB0aGlzLm1vdG9yRXF1YXRpb247CiAgICAgIGNvbnN0IHIxID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24xOwogICAgICBjb25zdCByMiA9IHRoaXMucm90YXRpb25hbEVxdWF0aW9uMjsKICAgICAgY29uc3QgcjMgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjM7CiAgICAgIHN1cGVyLnVwZGF0ZSgpOyAvLyBUaGVzZSB2ZWN0b3IgcGFpcnMgbXVzdCBiZSBvcnRob2dvbmFsCgogICAgICBib2R5QS52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy54QSwgcjEuYXhpc0EpOwogICAgICBib2R5Qi52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy55QiwgcjEuYXhpc0IpOwogICAgICBib2R5QS52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy55QSwgcjIuYXhpc0EpOwogICAgICBib2R5Qi52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy56QiwgcjIuYXhpc0IpOwogICAgICBib2R5QS52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy56QSwgcjMuYXhpc0EpOwogICAgICBib2R5Qi52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy54QiwgcjMuYXhpc0IpOwogICAgfQoKICB9CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwoKICAvKioKICAgKiBSb3RhdGlvbmFsIG1vdG9yIGNvbnN0cmFpbnQuIFRyaWVzIHRvIGtlZXAgdGhlIHJlbGF0aXZlIGFuZ3VsYXIgdmVsb2NpdHkgb2YgdGhlIGJvZGllcyB0byBhIGdpdmVuIHZhbHVlLgogICAqLwogIGNsYXNzIFJvdGF0aW9uYWxNb3RvckVxdWF0aW9uIGV4dGVuZHMgRXF1YXRpb24gewogICAgLyoqCiAgICAgKiBXb3JsZCBvcmllbnRlZCByb3RhdGlvbmFsIGF4aXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFdvcmxkIG9yaWVudGVkIHJvdGF0aW9uYWwgYXhpcy4KICAgICAqLwoKICAgIC8qKgogICAgICogTW90b3IgdmVsb2NpdHkuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5QiwgbWF4Rm9yY2UpIHsKICAgICAgaWYgKG1heEZvcmNlID09PSB2b2lkIDApIHsKICAgICAgICBtYXhGb3JjZSA9IDFlNjsKICAgICAgfQoKICAgICAgc3VwZXIoYm9keUEsIGJvZHlCLCAtbWF4Rm9yY2UsIG1heEZvcmNlKTsKICAgICAgdGhpcy5heGlzQSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuYXhpc0IgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnRhcmdldFZlbG9jaXR5ID0gMDsKICAgIH0KCiAgICBjb21wdXRlQihoKSB7CiAgICAgIHRoaXMuYTsKICAgICAgY29uc3QgYiA9IHRoaXMuYjsKICAgICAgdGhpcy5iaTsKICAgICAgdGhpcy5iajsKICAgICAgY29uc3QgYXhpc0EgPSB0aGlzLmF4aXNBOwogICAgICBjb25zdCBheGlzQiA9IHRoaXMuYXhpc0I7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsgLy8gZyA9IDAKICAgICAgLy8gZ2RvdCA9IGF4aXNBICogd2kgLSBheGlzQiAqIHdqCiAgICAgIC8vIGdkb3QgPSBHICogVyA9IEcgKiBbdmkgd2kgdmogd2pdCiAgICAgIC8vID0+CiAgICAgIC8vIEcgPSBbMCBheGlzQSAwIC1heGlzQl0KCiAgICAgIEdBLnJvdGF0aW9uYWwuY29weShheGlzQSk7CiAgICAgIGF4aXNCLm5lZ2F0ZShHQi5yb3RhdGlvbmFsKTsKICAgICAgY29uc3QgR1cgPSB0aGlzLmNvbXB1dGVHVygpIC0gdGhpcy50YXJnZXRWZWxvY2l0eTsKICAgICAgY29uc3QgR2lNZiA9IHRoaXMuY29tcHV0ZUdpTWYoKTsKICAgICAgY29uc3QgQiA9IC1HVyAqIGIgLSBoICogR2lNZjsKICAgICAgcmV0dXJuIEI7CiAgICB9CgogIH0KCiAgLyoqCiAgICogSGluZ2UgY29uc3RyYWludC4gVGhpbmsgb2YgaXQgYXMgYSBkb29yIGhpbmdlLiBJdCB0cmllcyB0byBrZWVwIHRoZSBkb29yIGluIHRoZSBjb3JyZWN0IHBsYWNlIGFuZCB3aXRoIHRoZSBjb3JyZWN0IG9yaWVudGF0aW9uLgogICAqLwogIGNsYXNzIEhpbmdlQ29uc3RyYWludCBleHRlbmRzIFBvaW50VG9Qb2ludENvbnN0cmFpbnQgewogICAgLyoqCiAgICAgKiBSb3RhdGlvbiBheGlzLCBkZWZpbmVkIGxvY2FsbHkgaW4gYm9keUEuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFJvdGF0aW9uIGF4aXMsIGRlZmluZWQgbG9jYWxseSBpbiBib2R5Qi4KICAgICAqLwogICAgY29uc3RydWN0b3IoYm9keUEsIGJvZHlCLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIGNvbnN0IG1heEZvcmNlID0gdHlwZW9mIG9wdGlvbnMubWF4Rm9yY2UgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5tYXhGb3JjZSA6IDFlNjsKICAgICAgY29uc3QgcGl2b3RBID0gb3B0aW9ucy5waXZvdEEgPyBvcHRpb25zLnBpdm90QS5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgY29uc3QgcGl2b3RCID0gb3B0aW9ucy5waXZvdEIgPyBvcHRpb25zLnBpdm90Qi5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgc3VwZXIoYm9keUEsIHBpdm90QSwgYm9keUIsIHBpdm90QiwgbWF4Rm9yY2UpOwogICAgICBjb25zdCBheGlzQSA9IHRoaXMuYXhpc0EgPSBvcHRpb25zLmF4aXNBID8gb3B0aW9ucy5heGlzQS5jbG9uZSgpIDogbmV3IFZlYzMoMSwgMCwgMCk7CiAgICAgIGF4aXNBLm5vcm1hbGl6ZSgpOwogICAgICBjb25zdCBheGlzQiA9IHRoaXMuYXhpc0IgPSBvcHRpb25zLmF4aXNCID8gb3B0aW9ucy5heGlzQi5jbG9uZSgpIDogbmV3IFZlYzMoMSwgMCwgMCk7CiAgICAgIGF4aXNCLm5vcm1hbGl6ZSgpOwogICAgICB0aGlzLmNvbGxpZGVDb25uZWN0ZWQgPSAhIW9wdGlvbnMuY29sbGlkZUNvbm5lY3RlZDsKICAgICAgY29uc3Qgcm90YXRpb25hbDEgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjEgPSBuZXcgUm90YXRpb25hbEVxdWF0aW9uKGJvZHlBLCBib2R5Qiwgb3B0aW9ucyk7CiAgICAgIGNvbnN0IHJvdGF0aW9uYWwyID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24yID0gbmV3IFJvdGF0aW9uYWxFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICBjb25zdCBtb3RvciA9IHRoaXMubW90b3JFcXVhdGlvbiA9IG5ldyBSb3RhdGlvbmFsTW90b3JFcXVhdGlvbihib2R5QSwgYm9keUIsIG1heEZvcmNlKTsKICAgICAgbW90b3IuZW5hYmxlZCA9IGZhbHNlOyAvLyBOb3QgZW5hYmxlZCBieSBkZWZhdWx0CiAgICAgIC8vIEVxdWF0aW9ucyB0byBiZSBmZWQgdG8gdGhlIHNvbHZlcgoKICAgICAgdGhpcy5lcXVhdGlvbnMucHVzaChyb3RhdGlvbmFsMSwgcm90YXRpb25hbDIsIG1vdG9yKTsKICAgIH0KICAgIC8qKgogICAgICogZW5hYmxlTW90b3IKICAgICAqLwoKCiAgICBlbmFibGVNb3RvcigpIHsKICAgICAgdGhpcy5tb3RvckVxdWF0aW9uLmVuYWJsZWQgPSB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBkaXNhYmxlTW90b3IKICAgICAqLwoKCiAgICBkaXNhYmxlTW90b3IoKSB7CiAgICAgIHRoaXMubW90b3JFcXVhdGlvbi5lbmFibGVkID0gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIHNldE1vdG9yU3BlZWQKICAgICAqLwoKCiAgICBzZXRNb3RvclNwZWVkKHNwZWVkKSB7CiAgICAgIHRoaXMubW90b3JFcXVhdGlvbi50YXJnZXRWZWxvY2l0eSA9IHNwZWVkOwogICAgfQogICAgLyoqCiAgICAgKiBzZXRNb3Rvck1heEZvcmNlCiAgICAgKi8KCgogICAgc2V0TW90b3JNYXhGb3JjZShtYXhGb3JjZSkgewogICAgICB0aGlzLm1vdG9yRXF1YXRpb24ubWF4Rm9yY2UgPSBtYXhGb3JjZTsKICAgICAgdGhpcy5tb3RvckVxdWF0aW9uLm1pbkZvcmNlID0gLW1heEZvcmNlOwogICAgfQogICAgLyoqCiAgICAgKiB1cGRhdGUKICAgICAqLwoKCiAgICB1cGRhdGUoKSB7CiAgICAgIGNvbnN0IGJvZHlBID0gdGhpcy5ib2R5QTsKICAgICAgY29uc3QgYm9keUIgPSB0aGlzLmJvZHlCOwogICAgICBjb25zdCBtb3RvciA9IHRoaXMubW90b3JFcXVhdGlvbjsKICAgICAgY29uc3QgcjEgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjE7CiAgICAgIGNvbnN0IHIyID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24yOwogICAgICBjb25zdCB3b3JsZEF4aXNBID0gSGluZ2VDb25zdHJhaW50X3VwZGF0ZV90bXBWZWMxOwogICAgICBjb25zdCB3b3JsZEF4aXNCID0gSGluZ2VDb25zdHJhaW50X3VwZGF0ZV90bXBWZWMyOwogICAgICBjb25zdCBheGlzQSA9IHRoaXMuYXhpc0E7CiAgICAgIGNvbnN0IGF4aXNCID0gdGhpcy5heGlzQjsKICAgICAgc3VwZXIudXBkYXRlKCk7IC8vIEdldCB3b3JsZCBheGVzCgogICAgICBib2R5QS5xdWF0ZXJuaW9uLnZtdWx0KGF4aXNBLCB3b3JsZEF4aXNBKTsKICAgICAgYm9keUIucXVhdGVybmlvbi52bXVsdChheGlzQiwgd29ybGRBeGlzQik7CiAgICAgIHdvcmxkQXhpc0EudGFuZ2VudHMocjEuYXhpc0EsIHIyLmF4aXNBKTsKICAgICAgcjEuYXhpc0IuY29weSh3b3JsZEF4aXNCKTsKICAgICAgcjIuYXhpc0IuY29weSh3b3JsZEF4aXNCKTsKCiAgICAgIGlmICh0aGlzLm1vdG9yRXF1YXRpb24uZW5hYmxlZCkgewogICAgICAgIGJvZHlBLnF1YXRlcm5pb24udm11bHQodGhpcy5heGlzQSwgbW90b3IuYXhpc0EpOwogICAgICAgIGJvZHlCLnF1YXRlcm5pb24udm11bHQodGhpcy5heGlzQiwgbW90b3IuYXhpc0IpOwogICAgICB9CiAgICB9CgogIH0KICBjb25zdCBIaW5nZUNvbnN0cmFpbnRfdXBkYXRlX3RtcFZlYzEgPSBuZXcgVmVjMygpOwogIGNvbnN0IEhpbmdlQ29uc3RyYWludF91cGRhdGVfdG1wVmVjMiA9IG5ldyBWZWMzKCk7CgogIC8qKgogICAqIENvbnN0cmFpbnMgdGhlIHNsaXBwaW5nIGluIGEgY29udGFjdCBhbG9uZyBhIHRhbmdlbnQKICAgKi8KICBjbGFzcyBGcmljdGlvbkVxdWF0aW9uIGV4dGVuZHMgRXF1YXRpb24gewogICAgLy8gVGFuZ2VudAoKICAgIC8qKgogICAgICogQHBhcmFtIHNsaXBGb3JjZSBzaG91bGQgYmUgKy1GX2ZyaWN0aW9uID0gKy1tdSAqIEZfbm9ybWFsID0gKy1tdSAqIG0gKiBnCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgc2xpcEZvcmNlKSB7CiAgICAgIHN1cGVyKGJvZHlBLCBib2R5QiwgLXNsaXBGb3JjZSwgc2xpcEZvcmNlKTsKICAgICAgdGhpcy5yaSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMucmogPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnQgPSBuZXcgVmVjMygpOwogICAgfQoKICAgIGNvbXB1dGVCKGgpIHsKICAgICAgdGhpcy5hOwogICAgICBjb25zdCBiID0gdGhpcy5iOwogICAgICB0aGlzLmJpOwogICAgICB0aGlzLmJqOwogICAgICBjb25zdCByaSA9IHRoaXMucmk7CiAgICAgIGNvbnN0IHJqID0gdGhpcy5yajsKICAgICAgY29uc3Qgcml4dCA9IEZyaWN0aW9uRXF1YXRpb25fY29tcHV0ZUJfdGVtcDE7CiAgICAgIGNvbnN0IHJqeHQgPSBGcmljdGlvbkVxdWF0aW9uX2NvbXB1dGVCX3RlbXAyOwogICAgICBjb25zdCB0ID0gdGhpcy50OyAvLyBDYWx1Y2xhdGUgY3Jvc3MgcHJvZHVjdHMKCiAgICAgIHJpLmNyb3NzKHQsIHJpeHQpOwogICAgICByai5jcm9zcyh0LCByanh0KTsgLy8gRyA9IFstdCAtcml4dCB0IHJqeHRdCiAgICAgIC8vIEFuZCByZW1lbWJlciwgdGhpcyBpcyBhIHB1cmUgdmVsb2NpdHkgY29uc3RyYWludCwgZyBpcyBhbHdheXMgemVybyEKCiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsKICAgICAgdC5uZWdhdGUoR0Euc3BhdGlhbCk7CiAgICAgIHJpeHQubmVnYXRlKEdBLnJvdGF0aW9uYWwpOwogICAgICBHQi5zcGF0aWFsLmNvcHkodCk7CiAgICAgIEdCLnJvdGF0aW9uYWwuY29weShyanh0KTsKICAgICAgY29uc3QgR1cgPSB0aGlzLmNvbXB1dGVHVygpOwogICAgICBjb25zdCBHaU1mID0gdGhpcy5jb21wdXRlR2lNZigpOwogICAgICBjb25zdCBCID0gLUdXICogYiAtIGggKiBHaU1mOwogICAgICByZXR1cm4gQjsKICAgIH0KCiAgfQogIGNvbnN0IEZyaWN0aW9uRXF1YXRpb25fY29tcHV0ZUJfdGVtcDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IEZyaWN0aW9uRXF1YXRpb25fY29tcHV0ZUJfdGVtcDIgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBEZWZpbmVzIHdoYXQgaGFwcGVucyB3aGVuIHR3byBtYXRlcmlhbHMgbWVldC4KICAgKiBAdG9kbyBSZWZhY3RvciBtYXRlcmlhbHMgdG8gbWF0ZXJpYWxBIGFuZCBtYXRlcmlhbEIKICAgKi8KICBjbGFzcyBDb250YWN0TWF0ZXJpYWwgewogICAgLyoqCiAgICAgKiBJZGVudGlmaWVyIG9mIHRoaXMgbWF0ZXJpYWwuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFBhcnRpY2lwYXRpbmcgbWF0ZXJpYWxzLgogICAgICovCgogICAgLyoqCiAgICAgKiBGcmljdGlvbiBjb2VmZmljaWVudC4KICAgICAqIEBkZWZhdWx0IDAuMwogICAgICovCgogICAgLyoqCiAgICAgKiBSZXN0aXR1dGlvbiBjb2VmZmljaWVudC4KICAgICAqIEBkZWZhdWx0IDAuMwogICAgICovCgogICAgLyoqCiAgICAgKiBTdGlmZm5lc3Mgb2YgdGhlIHByb2R1Y2VkIGNvbnRhY3QgZXF1YXRpb25zLgogICAgICogQGRlZmF1bHQgMWU3CiAgICAgKi8KCiAgICAvKioKICAgICAqIFJlbGF4YXRpb24gdGltZSBvZiB0aGUgcHJvZHVjZWQgY29udGFjdCBlcXVhdGlvbnMuCiAgICAgKiBAZGVmYXVsdCAzCiAgICAgKi8KCiAgICAvKioKICAgICAqIFN0aWZmbmVzcyBvZiB0aGUgcHJvZHVjZWQgZnJpY3Rpb24gZXF1YXRpb25zLgogICAgICogQGRlZmF1bHQgMWU3CiAgICAgKi8KCiAgICAvKioKICAgICAqIFJlbGF4YXRpb24gdGltZSBvZiB0aGUgcHJvZHVjZWQgZnJpY3Rpb24gZXF1YXRpb25zCiAgICAgKiBAZGVmYXVsdCAzCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG0xLCBtMiwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gVXRpbHMuZGVmYXVsdHMob3B0aW9ucywgewogICAgICAgIGZyaWN0aW9uOiAwLjMsCiAgICAgICAgcmVzdGl0dXRpb246IDAuMywKICAgICAgICBjb250YWN0RXF1YXRpb25TdGlmZm5lc3M6IDFlNywKICAgICAgICBjb250YWN0RXF1YXRpb25SZWxheGF0aW9uOiAzLAogICAgICAgIGZyaWN0aW9uRXF1YXRpb25TdGlmZm5lc3M6IDFlNywKICAgICAgICBmcmljdGlvbkVxdWF0aW9uUmVsYXhhdGlvbjogMwogICAgICB9KTsKICAgICAgdGhpcy5pZCA9IENvbnRhY3RNYXRlcmlhbC5pZENvdW50ZXIrKzsKICAgICAgdGhpcy5tYXRlcmlhbHMgPSBbbTEsIG0yXTsKICAgICAgdGhpcy5mcmljdGlvbiA9IG9wdGlvbnMuZnJpY3Rpb247CiAgICAgIHRoaXMucmVzdGl0dXRpb24gPSBvcHRpb25zLnJlc3RpdHV0aW9uOwogICAgICB0aGlzLmNvbnRhY3RFcXVhdGlvblN0aWZmbmVzcyA9IG9wdGlvbnMuY29udGFjdEVxdWF0aW9uU3RpZmZuZXNzOwogICAgICB0aGlzLmNvbnRhY3RFcXVhdGlvblJlbGF4YXRpb24gPSBvcHRpb25zLmNvbnRhY3RFcXVhdGlvblJlbGF4YXRpb247CiAgICAgIHRoaXMuZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcyA9IG9wdGlvbnMuZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzczsKICAgICAgdGhpcy5mcmljdGlvbkVxdWF0aW9uUmVsYXhhdGlvbiA9IG9wdGlvbnMuZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb247CiAgICB9CgogIH0KICBDb250YWN0TWF0ZXJpYWwuaWRDb3VudGVyID0gMDsKCiAgLyoqCiAgICogRGVmaW5lcyBhIHBoeXNpY3MgbWF0ZXJpYWwuCiAgICovCiAgY2xhc3MgTWF0ZXJpYWwgewogICAgLyoqCiAgICAgKiBNYXRlcmlhbCBuYW1lLgogICAgICogSWYgb3B0aW9ucyBpcyBhIHN0cmluZywgbmFtZSB3aWxsIGJlIHNldCB0byB0aGF0IHN0cmluZy4KICAgICAqIEB0b2RvIERlcHJlY2F0ZSB0aGlzCiAgICAgKi8KCiAgICAvKiogTWF0ZXJpYWwgaWQuICovCgogICAgLyoqCiAgICAgKiBGcmljdGlvbiBmb3IgdGhpcyBtYXRlcmlhbC4KICAgICAqIElmIG5vbi1uZWdhdGl2ZSwgaXQgd2lsbCBiZSB1c2VkIGluc3RlYWQgb2YgdGhlIGZyaWN0aW9uIGdpdmVuIGJ5IENvbnRhY3RNYXRlcmlhbHMuIElmIHRoZXJlJ3Mgbm8gbWF0Y2hpbmcgQ29udGFjdE1hdGVyaWFsLCB0aGUgdmFsdWUgZnJvbSBgZGVmYXVsdENvbnRhY3RNYXRlcmlhbGAgaW4gdGhlIFdvcmxkIHdpbGwgYmUgdXNlZC4KICAgICAqLwoKICAgIC8qKgogICAgICogUmVzdGl0dXRpb24gZm9yIHRoaXMgbWF0ZXJpYWwuCiAgICAgKiBJZiBub24tbmVnYXRpdmUsIGl0IHdpbGwgYmUgdXNlZCBpbnN0ZWFkIG9mIHRoZSByZXN0aXR1dGlvbiBnaXZlbiBieSBDb250YWN0TWF0ZXJpYWxzLiBJZiB0aGVyZSdzIG5vIG1hdGNoaW5nIENvbnRhY3RNYXRlcmlhbCwgdGhlIHZhbHVlIGZyb20gYGRlZmF1bHRDb250YWN0TWF0ZXJpYWxgIGluIHRoZSBXb3JsZCB3aWxsIGJlIHVzZWQuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgbGV0IG5hbWUgPSAnJzsgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgZml4CgogICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgLy9jb25zb2xlLndhcm4oYFBhc3NpbmcgYSBzdHJpbmcgdG8gTWF0ZXJpYWxPcHRpb25zIGlzIGRlcHJlY2F0ZWQsIGFuZCBoYXMgbm8gZWZmZWN0YCkKICAgICAgICBuYW1lID0gb3B0aW9uczsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuaWQgPSBNYXRlcmlhbC5pZENvdW50ZXIrKzsKICAgICAgdGhpcy5mcmljdGlvbiA9IHR5cGVvZiBvcHRpb25zLmZyaWN0aW9uICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuZnJpY3Rpb24gOiAtMTsKICAgICAgdGhpcy5yZXN0aXR1dGlvbiA9IHR5cGVvZiBvcHRpb25zLnJlc3RpdHV0aW9uICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMucmVzdGl0dXRpb24gOiAtMTsKICAgIH0KCiAgfQogIE1hdGVyaWFsLmlkQ291bnRlciA9IDA7CgogIC8qKgogICAqIEEgc3ByaW5nLCBjb25uZWN0aW5nIHR3byBib2RpZXMuCiAgICogQGV4YW1wbGUKICAgKiAgICAgY29uc3Qgc3ByaW5nID0gbmV3IFNwcmluZyhib3hCb2R5LCBzcGhlcmVCb2R5LCB7CiAgICogICAgICAgcmVzdExlbmd0aDogMCwKICAgKiAgICAgICBzdGlmZm5lc3M6IDUwLAogICAqICAgICAgIGRhbXBpbmc6IDEsCiAgICogICAgIH0pCiAgICoKICAgKiAgICAgLy8gQ29tcHV0ZSB0aGUgZm9yY2UgYWZ0ZXIgZWFjaCBzdGVwCiAgICogICAgIHdvcmxkLmFkZEV2ZW50TGlzdGVuZXIoJ3Bvc3RTdGVwJywgKGV2ZW50KSA9PiB7CiAgICogICAgICAgc3ByaW5nLmFwcGx5Rm9yY2UoKQogICAqICAgICB9KQogICAqLwogIGNsYXNzIFNwcmluZyB7CiAgICAvKioKICAgICAqIFJlc3QgbGVuZ3RoIG9mIHRoZSBzcHJpbmcuIEEgbnVtYmVyID4gMC4KICAgICAqIEBkZWZhdWx0IDEKICAgICAqLwoKICAgIC8qKgogICAgICogU3RpZmZuZXNzIG9mIHRoZSBzcHJpbmcuIEEgbnVtYmVyID49IDAuCiAgICAgKiBAZGVmYXVsdCAxMDAKICAgICAqLwoKICAgIC8qKgogICAgICogRGFtcGluZyBvZiB0aGUgc3ByaW5nLiBBIG51bWJlciA+PSAwLgogICAgICogQGRlZmF1bHQgMQogICAgICovCgogICAgLyoqCiAgICAgKiBGaXJzdCBjb25uZWN0ZWQgYm9keS4KICAgICAqLwoKICAgIC8qKgogICAgICogU2Vjb25kIGNvbm5lY3RlZCBib2R5LgogICAgICovCgogICAgLyoqCiAgICAgKiBBbmNob3IgZm9yIGJvZHlBIGluIGxvY2FsIGJvZHlBIGNvb3JkaW5hdGVzLgogICAgICogV2hlcmUgdG8gaG9vayB0aGUgc3ByaW5nIHRvIGJvZHkgQSwgaW4gbG9jYWwgYm9keSBjb29yZGluYXRlcy4KICAgICAqIEBkZWZhdWx0IG5ldyBWZWMzKCkKICAgICAqLwoKICAgIC8qKgogICAgICogQW5jaG9yIGZvciBib2R5QiBpbiBsb2NhbCBib2R5QiBjb29yZGluYXRlcy4KICAgICAqIFdoZXJlIHRvIGhvb2sgdGhlIHNwcmluZyB0byBib2R5IEIsIGluIGxvY2FsIGJvZHkgY29vcmRpbmF0ZXMuCiAgICAgKiBAZGVmYXVsdCBuZXcgVmVjMygpCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLnJlc3RMZW5ndGggPSB0eXBlb2Ygb3B0aW9ucy5yZXN0TGVuZ3RoID09PSAnbnVtYmVyJyA/IG9wdGlvbnMucmVzdExlbmd0aCA6IDE7CiAgICAgIHRoaXMuc3RpZmZuZXNzID0gb3B0aW9ucy5zdGlmZm5lc3MgfHwgMTAwOwogICAgICB0aGlzLmRhbXBpbmcgPSBvcHRpb25zLmRhbXBpbmcgfHwgMTsKICAgICAgdGhpcy5ib2R5QSA9IGJvZHlBOwogICAgICB0aGlzLmJvZHlCID0gYm9keUI7CiAgICAgIHRoaXMubG9jYWxBbmNob3JBID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5sb2NhbEFuY2hvckIgPSBuZXcgVmVjMygpOwoKICAgICAgaWYgKG9wdGlvbnMubG9jYWxBbmNob3JBKSB7CiAgICAgICAgdGhpcy5sb2NhbEFuY2hvckEuY29weShvcHRpb25zLmxvY2FsQW5jaG9yQSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLmxvY2FsQW5jaG9yQikgewogICAgICAgIHRoaXMubG9jYWxBbmNob3JCLmNvcHkob3B0aW9ucy5sb2NhbEFuY2hvckIpOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy53b3JsZEFuY2hvckEpIHsKICAgICAgICB0aGlzLnNldFdvcmxkQW5jaG9yQShvcHRpb25zLndvcmxkQW5jaG9yQSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLndvcmxkQW5jaG9yQikgewogICAgICAgIHRoaXMuc2V0V29ybGRBbmNob3JCKG9wdGlvbnMud29ybGRBbmNob3JCKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIGFuY2hvciBwb2ludCBvbiBib2R5IEEsIHVzaW5nIHdvcmxkIGNvb3JkaW5hdGVzLgogICAgICovCgoKICAgIHNldFdvcmxkQW5jaG9yQSh3b3JsZEFuY2hvckEpIHsKICAgICAgdGhpcy5ib2R5QS5wb2ludFRvTG9jYWxGcmFtZSh3b3JsZEFuY2hvckEsIHRoaXMubG9jYWxBbmNob3JBKTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBhbmNob3IgcG9pbnQgb24gYm9keSBCLCB1c2luZyB3b3JsZCBjb29yZGluYXRlcy4KICAgICAqLwoKCiAgICBzZXRXb3JsZEFuY2hvckIod29ybGRBbmNob3JCKSB7CiAgICAgIHRoaXMuYm9keUIucG9pbnRUb0xvY2FsRnJhbWUod29ybGRBbmNob3JCLCB0aGlzLmxvY2FsQW5jaG9yQik7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgYW5jaG9yIHBvaW50IG9uIGJvZHkgQSwgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiAgICAgKiBAcGFyYW0gcmVzdWx0IFRoZSB2ZWN0b3IgdG8gc3RvcmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBnZXRXb3JsZEFuY2hvckEocmVzdWx0KSB7CiAgICAgIHRoaXMuYm9keUEucG9pbnRUb1dvcmxkRnJhbWUodGhpcy5sb2NhbEFuY2hvckEsIHJlc3VsdCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgYW5jaG9yIHBvaW50IG9uIGJvZHkgQiwgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiAgICAgKiBAcGFyYW0gcmVzdWx0IFRoZSB2ZWN0b3IgdG8gc3RvcmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBnZXRXb3JsZEFuY2hvckIocmVzdWx0KSB7CiAgICAgIHRoaXMuYm9keUIucG9pbnRUb1dvcmxkRnJhbWUodGhpcy5sb2NhbEFuY2hvckIsIHJlc3VsdCk7CiAgICB9CiAgICAvKioKICAgICAqIEFwcGx5IHRoZSBzcHJpbmcgZm9yY2UgdG8gdGhlIGNvbm5lY3RlZCBib2RpZXMuCiAgICAgKi8KCgogICAgYXBwbHlGb3JjZSgpIHsKICAgICAgY29uc3QgayA9IHRoaXMuc3RpZmZuZXNzOwogICAgICBjb25zdCBkID0gdGhpcy5kYW1waW5nOwogICAgICBjb25zdCBsID0gdGhpcy5yZXN0TGVuZ3RoOwogICAgICBjb25zdCBib2R5QSA9IHRoaXMuYm9keUE7CiAgICAgIGNvbnN0IGJvZHlCID0gdGhpcy5ib2R5QjsKICAgICAgY29uc3QgciA9IGFwcGx5Rm9yY2VfcjsKICAgICAgY29uc3Qgcl91bml0ID0gYXBwbHlGb3JjZV9yX3VuaXQ7CiAgICAgIGNvbnN0IHUgPSBhcHBseUZvcmNlX3U7CiAgICAgIGNvbnN0IGYgPSBhcHBseUZvcmNlX2Y7CiAgICAgIGNvbnN0IHRtcCA9IGFwcGx5Rm9yY2VfdG1wOwogICAgICBjb25zdCB3b3JsZEFuY2hvckEgPSBhcHBseUZvcmNlX3dvcmxkQW5jaG9yQTsKICAgICAgY29uc3Qgd29ybGRBbmNob3JCID0gYXBwbHlGb3JjZV93b3JsZEFuY2hvckI7CiAgICAgIGNvbnN0IHJpID0gYXBwbHlGb3JjZV9yaTsKICAgICAgY29uc3QgcmogPSBhcHBseUZvcmNlX3JqOwogICAgICBjb25zdCByaV94X2YgPSBhcHBseUZvcmNlX3JpX3hfZjsKICAgICAgY29uc3QgcmpfeF9mID0gYXBwbHlGb3JjZV9yal94X2Y7IC8vIEdldCB3b3JsZCBhbmNob3JzCgogICAgICB0aGlzLmdldFdvcmxkQW5jaG9yQSh3b3JsZEFuY2hvckEpOwogICAgICB0aGlzLmdldFdvcmxkQW5jaG9yQih3b3JsZEFuY2hvckIpOyAvLyBHZXQgb2Zmc2V0IHBvaW50cwoKICAgICAgd29ybGRBbmNob3JBLnZzdWIoYm9keUEucG9zaXRpb24sIHJpKTsKICAgICAgd29ybGRBbmNob3JCLnZzdWIoYm9keUIucG9zaXRpb24sIHJqKTsgLy8gQ29tcHV0ZSBkaXN0YW5jZSB2ZWN0b3IgYmV0d2VlbiB3b3JsZCBhbmNob3IgcG9pbnRzCgogICAgICB3b3JsZEFuY2hvckIudnN1Yih3b3JsZEFuY2hvckEsIHIpOwogICAgICBjb25zdCBybGVuID0gci5sZW5ndGgoKTsKICAgICAgcl91bml0LmNvcHkocik7CiAgICAgIHJfdW5pdC5ub3JtYWxpemUoKTsgLy8gQ29tcHV0ZSByZWxhdGl2ZSB2ZWxvY2l0eSBvZiB0aGUgYW5jaG9yIHBvaW50cywgdQoKICAgICAgYm9keUIudmVsb2NpdHkudnN1Yihib2R5QS52ZWxvY2l0eSwgdSk7IC8vIEFkZCByb3RhdGlvbmFsIHZlbG9jaXR5CgogICAgICBib2R5Qi5hbmd1bGFyVmVsb2NpdHkuY3Jvc3MocmosIHRtcCk7CiAgICAgIHUudmFkZCh0bXAsIHUpOwogICAgICBib2R5QS5hbmd1bGFyVmVsb2NpdHkuY3Jvc3MocmksIHRtcCk7CiAgICAgIHUudnN1Yih0bXAsIHUpOyAvLyBGID0gLSBrICogKCB4IC0gTCApIC0gRCAqICggdSApCgogICAgICByX3VuaXQuc2NhbGUoLWsgKiAocmxlbiAtIGwpIC0gZCAqIHUuZG90KHJfdW5pdCksIGYpOyAvLyBBZGQgZm9yY2VzIHRvIGJvZGllcwoKICAgICAgYm9keUEuZm9yY2UudnN1YihmLCBib2R5QS5mb3JjZSk7CiAgICAgIGJvZHlCLmZvcmNlLnZhZGQoZiwgYm9keUIuZm9yY2UpOyAvLyBBbmd1bGFyIGZvcmNlCgogICAgICByaS5jcm9zcyhmLCByaV94X2YpOwogICAgICByai5jcm9zcyhmLCByal94X2YpOwogICAgICBib2R5QS50b3JxdWUudnN1YihyaV94X2YsIGJvZHlBLnRvcnF1ZSk7CiAgICAgIGJvZHlCLnRvcnF1ZS52YWRkKHJqX3hfZiwgYm9keUIudG9ycXVlKTsKICAgIH0KCiAgfQogIGNvbnN0IGFwcGx5Rm9yY2VfciA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYXBwbHlGb3JjZV9yX3VuaXQgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2VfdSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYXBwbHlGb3JjZV9mID0gbmV3IFZlYzMoKTsKICBjb25zdCBhcHBseUZvcmNlX3dvcmxkQW5jaG9yQSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYXBwbHlGb3JjZV93b3JsZEFuY2hvckIgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2VfcmkgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2VfcmogPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2VfcmlfeF9mID0gbmV3IFZlYzMoKTsKICBjb25zdCBhcHBseUZvcmNlX3JqX3hfZiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYXBwbHlGb3JjZV90bXAgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBXaGVlbEluZm8KICAgKi8KICBjbGFzcyBXaGVlbEluZm8gewogICAgLyoqCiAgICAgKiBNYXggdHJhdmVsIGRpc3RhbmNlIG9mIHRoZSBzdXNwZW5zaW9uLCBpbiBtZXRlcnMuCiAgICAgKiBAZGVmYXVsdCAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNwZWVkIHRvIGFwcGx5IHRvIHRoZSB3aGVlbCByb3RhdGlvbiB3aGVuIHRoZSB3aGVlbCBpcyBzbGlkaW5nLgogICAgICogQGRlZmF1bHQgLTAuMQogICAgICovCgogICAgLyoqCiAgICAgKiBJZiB0aGUgY3VzdG9tU2xpZGluZ1JvdGF0aW9uYWxTcGVlZCBzaG91bGQgYmUgdXNlZC4KICAgICAqIEBkZWZhdWx0IGZhbHNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIHNsaWRpbmcKICAgICAqLwoKICAgIC8qKgogICAgICogQ29ubmVjdGlvbiBwb2ludCwgZGVmaW5lZCBsb2NhbGx5IGluIHRoZSBjaGFzc2lzIGJvZHkgZnJhbWUuCiAgICAgKi8KCiAgICAvKioKICAgICAqIGNoYXNzaXNDb25uZWN0aW9uUG9pbnRXb3JsZAogICAgICovCgogICAgLyoqCiAgICAgKiBkaXJlY3Rpb25Mb2NhbAogICAgICovCgogICAgLyoqCiAgICAgKiBkaXJlY3Rpb25Xb3JsZAogICAgICovCgogICAgLyoqCiAgICAgKiBheGxlTG9jYWwKICAgICAqLwoKICAgIC8qKgogICAgICogYXhsZVdvcmxkCiAgICAgKi8KCiAgICAvKioKICAgICAqIHN1c3BlbnNpb25SZXN0TGVuZ3RoCiAgICAgKiBAZGVmYXVsdCAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIHN1c3BlbnNpb25NYXhMZW5ndGgKICAgICAqIEBkZWZhdWx0IDIKICAgICAqLwoKICAgIC8qKgogICAgICogcmFkaXVzCiAgICAgKiBAZGVmYXVsdCAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIHN1c3BlbnNpb25TdGlmZm5lc3MKICAgICAqIEBkZWZhdWx0IDEwMAogICAgICovCgogICAgLyoqCiAgICAgKiBkYW1waW5nQ29tcHJlc3Npb24KICAgICAqIEBkZWZhdWx0IDEwCiAgICAgKi8KCiAgICAvKioKICAgICAqIGRhbXBpbmdSZWxheGF0aW9uCiAgICAgKiBAZGVmYXVsdCAxMAogICAgICovCgogICAgLyoqCiAgICAgKiBmcmljdGlvblNsaXAKICAgICAqIEBkZWZhdWx0IDEwLjUKICAgICAqLwoKICAgIC8qKiBmb3J3YXJkQWNjZWxlcmF0aW9uICovCgogICAgLyoqIHNpZGVBY2NlbGVyYXRpb24gKi8KCiAgICAvKioKICAgICAqIHN0ZWVyaW5nCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIFJvdGF0aW9uIHZhbHVlLCBpbiByYWRpYW5zLgogICAgICogQGRlZmF1bHQgMAogICAgICovCgogICAgLyoqCiAgICAgKiBkZWx0YVJvdGF0aW9uCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIHJvbGxJbmZsdWVuY2UKICAgICAqIEBkZWZhdWx0IDAuMDEKICAgICAqLwoKICAgIC8qKgogICAgICogbWF4U3VzcGVuc2lvbkZvcmNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIGVuZ2luZUZvcmNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIGJyYWtlCiAgICAgKi8KCiAgICAvKioKICAgICAqIGlzRnJvbnRXaGVlbAogICAgICogQGRlZmF1bHQgdHJ1ZQogICAgICovCgogICAgLyoqCiAgICAgKiBjbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24KICAgICAqIEBkZWZhdWx0IDEKICAgICAqLwoKICAgIC8qKgogICAgICogc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHkKICAgICAqIEBkZWZhdWx0IDAKICAgICAqLwoKICAgIC8qKgogICAgICogc3VzcGVuc2lvbkZvcmNlCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIHNsaXBJbmZvCiAgICAgKi8KCiAgICAvKioKICAgICAqIHNraWRJbmZvCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIHN1c3BlbnNpb25MZW5ndGgKICAgICAqIEBkZWZhdWx0IDAKICAgICAqLwoKICAgIC8qKgogICAgICogc2lkZUltcHVsc2UKICAgICAqLwoKICAgIC8qKgogICAgICogZm9yd2FyZEltcHVsc2UKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIHJlc3VsdCBmcm9tIHJheWNhc3RpbmcuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFdoZWVsIHdvcmxkIHRyYW5zZm9ybS4KICAgICAqLwoKICAgIC8qKgogICAgICogaXNJbkNvbnRhY3QKICAgICAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBvcHRpb25zID0gVXRpbHMuZGVmYXVsdHMob3B0aW9ucywgewogICAgICAgIGNoYXNzaXNDb25uZWN0aW9uUG9pbnRMb2NhbDogbmV3IFZlYzMoKSwKICAgICAgICBjaGFzc2lzQ29ubmVjdGlvblBvaW50V29ybGQ6IG5ldyBWZWMzKCksCiAgICAgICAgZGlyZWN0aW9uTG9jYWw6IG5ldyBWZWMzKCksCiAgICAgICAgZGlyZWN0aW9uV29ybGQ6IG5ldyBWZWMzKCksCiAgICAgICAgYXhsZUxvY2FsOiBuZXcgVmVjMygpLAogICAgICAgIGF4bGVXb3JsZDogbmV3IFZlYzMoKSwKICAgICAgICBzdXNwZW5zaW9uUmVzdExlbmd0aDogMSwKICAgICAgICBzdXNwZW5zaW9uTWF4TGVuZ3RoOiAyLAogICAgICAgIHJhZGl1czogMSwKICAgICAgICBzdXNwZW5zaW9uU3RpZmZuZXNzOiAxMDAsCiAgICAgICAgZGFtcGluZ0NvbXByZXNzaW9uOiAxMCwKICAgICAgICBkYW1waW5nUmVsYXhhdGlvbjogMTAsCiAgICAgICAgZnJpY3Rpb25TbGlwOiAxMC41LAogICAgICAgIGZvcndhcmRBY2NlbGVyYXRpb246IDEsCiAgICAgICAgc2lkZUFjY2VsZXJhdGlvbjogMSwKICAgICAgICBzdGVlcmluZzogMCwKICAgICAgICByb3RhdGlvbjogMCwKICAgICAgICBkZWx0YVJvdGF0aW9uOiAwLAogICAgICAgIHJvbGxJbmZsdWVuY2U6IDAuMDEsCiAgICAgICAgbWF4U3VzcGVuc2lvbkZvcmNlOiBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgIGlzRnJvbnRXaGVlbDogdHJ1ZSwKICAgICAgICBjbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb246IDEsCiAgICAgICAgc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHk6IDAsCiAgICAgICAgc3VzcGVuc2lvbkZvcmNlOiAwLAogICAgICAgIHNsaXBJbmZvOiAwLAogICAgICAgIHNraWRJbmZvOiAwLAogICAgICAgIHN1c3BlbnNpb25MZW5ndGg6IDAsCiAgICAgICAgbWF4U3VzcGVuc2lvblRyYXZlbDogMSwKICAgICAgICB1c2VDdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkOiBmYWxzZSwKICAgICAgICBjdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkOiAtMC4xCiAgICAgIH0pOwogICAgICB0aGlzLm1heFN1c3BlbnNpb25UcmF2ZWwgPSBvcHRpb25zLm1heFN1c3BlbnNpb25UcmF2ZWw7CiAgICAgIHRoaXMuY3VzdG9tU2xpZGluZ1JvdGF0aW9uYWxTcGVlZCA9IG9wdGlvbnMuY3VzdG9tU2xpZGluZ1JvdGF0aW9uYWxTcGVlZDsKICAgICAgdGhpcy51c2VDdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkID0gb3B0aW9ucy51c2VDdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkOwogICAgICB0aGlzLnNsaWRpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5jaGFzc2lzQ29ubmVjdGlvblBvaW50TG9jYWwgPSBvcHRpb25zLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRMb2NhbC5jbG9uZSgpOwogICAgICB0aGlzLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRXb3JsZCA9IG9wdGlvbnMuY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludFdvcmxkLmNsb25lKCk7CiAgICAgIHRoaXMuZGlyZWN0aW9uTG9jYWwgPSBvcHRpb25zLmRpcmVjdGlvbkxvY2FsLmNsb25lKCk7CiAgICAgIHRoaXMuZGlyZWN0aW9uV29ybGQgPSBvcHRpb25zLmRpcmVjdGlvbldvcmxkLmNsb25lKCk7CiAgICAgIHRoaXMuYXhsZUxvY2FsID0gb3B0aW9ucy5heGxlTG9jYWwuY2xvbmUoKTsKICAgICAgdGhpcy5heGxlV29ybGQgPSBvcHRpb25zLmF4bGVXb3JsZC5jbG9uZSgpOwogICAgICB0aGlzLnN1c3BlbnNpb25SZXN0TGVuZ3RoID0gb3B0aW9ucy5zdXNwZW5zaW9uUmVzdExlbmd0aDsKICAgICAgdGhpcy5zdXNwZW5zaW9uTWF4TGVuZ3RoID0gb3B0aW9ucy5zdXNwZW5zaW9uTWF4TGVuZ3RoOwogICAgICB0aGlzLnJhZGl1cyA9IG9wdGlvbnMucmFkaXVzOwogICAgICB0aGlzLnN1c3BlbnNpb25TdGlmZm5lc3MgPSBvcHRpb25zLnN1c3BlbnNpb25TdGlmZm5lc3M7CiAgICAgIHRoaXMuZGFtcGluZ0NvbXByZXNzaW9uID0gb3B0aW9ucy5kYW1waW5nQ29tcHJlc3Npb247CiAgICAgIHRoaXMuZGFtcGluZ1JlbGF4YXRpb24gPSBvcHRpb25zLmRhbXBpbmdSZWxheGF0aW9uOwogICAgICB0aGlzLmZyaWN0aW9uU2xpcCA9IG9wdGlvbnMuZnJpY3Rpb25TbGlwOwogICAgICB0aGlzLmZvcndhcmRBY2NlbGVyYXRpb24gPSBvcHRpb25zLmZvcndhcmRBY2NlbGVyYXRpb247CiAgICAgIHRoaXMuc2lkZUFjY2VsZXJhdGlvbiA9IG9wdGlvbnMuc2lkZUFjY2VsZXJhdGlvbjsKICAgICAgdGhpcy5zdGVlcmluZyA9IDA7CiAgICAgIHRoaXMucm90YXRpb24gPSAwOwogICAgICB0aGlzLmRlbHRhUm90YXRpb24gPSAwOwogICAgICB0aGlzLnJvbGxJbmZsdWVuY2UgPSBvcHRpb25zLnJvbGxJbmZsdWVuY2U7CiAgICAgIHRoaXMubWF4U3VzcGVuc2lvbkZvcmNlID0gb3B0aW9ucy5tYXhTdXNwZW5zaW9uRm9yY2U7CiAgICAgIHRoaXMuZW5naW5lRm9yY2UgPSAwOwogICAgICB0aGlzLmJyYWtlID0gMDsKICAgICAgdGhpcy5pc0Zyb250V2hlZWwgPSBvcHRpb25zLmlzRnJvbnRXaGVlbDsKICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxOwogICAgICB0aGlzLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5ID0gMDsKICAgICAgdGhpcy5zdXNwZW5zaW9uRm9yY2UgPSAwOwogICAgICB0aGlzLnNsaXBJbmZvID0gMDsKICAgICAgdGhpcy5za2lkSW5mbyA9IDA7CiAgICAgIHRoaXMuc3VzcGVuc2lvbkxlbmd0aCA9IDA7CiAgICAgIHRoaXMuc2lkZUltcHVsc2UgPSAwOwogICAgICB0aGlzLmZvcndhcmRJbXB1bHNlID0gMDsKICAgICAgdGhpcy5yYXljYXN0UmVzdWx0ID0gbmV3IFJheWNhc3RSZXN1bHQoKTsKICAgICAgdGhpcy53b3JsZFRyYW5zZm9ybSA9IG5ldyBUcmFuc2Zvcm0oKTsKICAgICAgdGhpcy5pc0luQ29udGFjdCA9IGZhbHNlOwogICAgfQoKICAgIHVwZGF0ZVdoZWVsKGNoYXNzaXMpIHsKICAgICAgY29uc3QgcmF5Y2FzdFJlc3VsdCA9IHRoaXMucmF5Y2FzdFJlc3VsdDsKCiAgICAgIGlmICh0aGlzLmlzSW5Db250YWN0KSB7CiAgICAgICAgY29uc3QgcHJvamVjdCA9IHJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQuZG90KHJheWNhc3RSZXN1bHQuZGlyZWN0aW9uV29ybGQpOwogICAgICAgIHJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZC52c3ViKGNoYXNzaXMucG9zaXRpb24sIHJlbHBvcyk7CiAgICAgICAgY2hhc3Npcy5nZXRWZWxvY2l0eUF0V29ybGRQb2ludChyZWxwb3MsIGNoYXNzaXNfdmVsb2NpdHlfYXRfY29udGFjdFBvaW50KTsKICAgICAgICBjb25zdCBwcm9qVmVsID0gcmF5Y2FzdFJlc3VsdC5oaXROb3JtYWxXb3JsZC5kb3QoY2hhc3Npc192ZWxvY2l0eV9hdF9jb250YWN0UG9pbnQpOwoKICAgICAgICBpZiAocHJvamVjdCA+PSAtMC4xKSB7CiAgICAgICAgICB0aGlzLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5ID0gMC4wOwogICAgICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxLjAgLyAwLjE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGludiA9IC0xIC8gcHJvamVjdDsKICAgICAgICAgIHRoaXMuc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHkgPSBwcm9qVmVsICogaW52OwogICAgICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSBpbnY7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIE5vdCBpbiBjb250YWN0IDogcG9zaXRpb24gd2hlZWwgaW4gYSBuaWNlIChyZXN0IGxlbmd0aCkgcG9zaXRpb24KICAgICAgICByYXljYXN0UmVzdWx0LnN1c3BlbnNpb25MZW5ndGggPSB0aGlzLnN1c3BlbnNpb25SZXN0TGVuZ3RoOwogICAgICAgIHRoaXMuc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHkgPSAwLjA7CiAgICAgICAgcmF5Y2FzdFJlc3VsdC5kaXJlY3Rpb25Xb3JsZC5zY2FsZSgtMSwgcmF5Y2FzdFJlc3VsdC5oaXROb3JtYWxXb3JsZCk7CiAgICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxLjA7CiAgICAgIH0KICAgIH0KCiAgfQogIGNvbnN0IGNoYXNzaXNfdmVsb2NpdHlfYXRfY29udGFjdFBvaW50ID0gbmV3IFZlYzMoKTsKICBjb25zdCByZWxwb3MgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBWZWhpY2xlIGhlbHBlciBjbGFzcyB0aGF0IGNhc3RzIHJheXMgZnJvbSB0aGUgd2hlZWwgcG9zaXRpb25zIHRvd2FyZHMgdGhlIGdyb3VuZCBhbmQgYXBwbGllcyBmb3JjZXMuCiAgICovCiAgY2xhc3MgUmF5Y2FzdFZlaGljbGUgewogICAgLyoqIFRoZSBjYXIgY2hhc3NpcyBib2R5LiAqLwoKICAgIC8qKiBUaGUgd2hlZWxzLiAqLwoKICAgIC8qKiBXaWxsIGJlIHNldCB0byB0cnVlIGlmIHRoZSBjYXIgaXMgc2xpZGluZy4gKi8KCiAgICAvKiogSW5kZXggb2YgdGhlIHJpZ2h0IGF4aXMuIHg9MCwgeT0xLCB6PTIgKi8KCiAgICAvKiogSW5kZXggb2YgdGhlIGZvcndhcmQgYXhpcy4geD0wLCB5PTEsIHo9MiAqLwoKICAgIC8qKiBJbmRleCBvZiB0aGUgdXAgYXhpcy4geD0wLCB5PTEsIHo9MiAqLwoKICAgIC8qKiBUaGUgY29uc3RyYWludHMuICovCgogICAgLyoqIE9wdGlvbmFsIHByZS1zdGVwIGNhbGxiYWNrLiAqLwoKICAgIC8qKiBOdW1iZXIgb2Ygd2hlZWxzIG9uIHRoZSBncm91bmQuICovCiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICAgIHRoaXMuY2hhc3Npc0JvZHkgPSBvcHRpb25zLmNoYXNzaXNCb2R5OwogICAgICB0aGlzLndoZWVsSW5mb3MgPSBbXTsKICAgICAgdGhpcy5zbGlkaW5nID0gZmFsc2U7CiAgICAgIHRoaXMud29ybGQgPSBudWxsOwogICAgICB0aGlzLmluZGV4UmlnaHRBeGlzID0gdHlwZW9mIG9wdGlvbnMuaW5kZXhSaWdodEF4aXMgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5pbmRleFJpZ2h0QXhpcyA6IDI7CiAgICAgIHRoaXMuaW5kZXhGb3J3YXJkQXhpcyA9IHR5cGVvZiBvcHRpb25zLmluZGV4Rm9yd2FyZEF4aXMgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5pbmRleEZvcndhcmRBeGlzIDogMDsKICAgICAgdGhpcy5pbmRleFVwQXhpcyA9IHR5cGVvZiBvcHRpb25zLmluZGV4VXBBeGlzICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuaW5kZXhVcEF4aXMgOiAxOwogICAgICB0aGlzLmNvbnN0cmFpbnRzID0gW107CgogICAgICB0aGlzLnByZVN0ZXBDYWxsYmFjayA9ICgpID0+IHt9OwoKICAgICAgdGhpcy5jdXJyZW50VmVoaWNsZVNwZWVkS21Ib3VyID0gMDsKICAgICAgdGhpcy5udW1XaGVlbHNPbkdyb3VuZCA9IDA7CiAgICB9CiAgICAvKioKICAgICAqIEFkZCBhIHdoZWVsLiBGb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIG9wdGlvbnMsIHNlZSBgV2hlZWxJbmZvYC4KICAgICAqLwoKCiAgICBhZGRXaGVlbChvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIGNvbnN0IGluZm8gPSBuZXcgV2hlZWxJbmZvKG9wdGlvbnMpOwogICAgICBjb25zdCBpbmRleCA9IHRoaXMud2hlZWxJbmZvcy5sZW5ndGg7CiAgICAgIHRoaXMud2hlZWxJbmZvcy5wdXNoKGluZm8pOwogICAgICByZXR1cm4gaW5kZXg7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgc3RlZXJpbmcgdmFsdWUgb2YgYSB3aGVlbC4KICAgICAqLwoKCiAgICBzZXRTdGVlcmluZ1ZhbHVlKHZhbHVlLCB3aGVlbEluZGV4KSB7CiAgICAgIGNvbnN0IHdoZWVsID0gdGhpcy53aGVlbEluZm9zW3doZWVsSW5kZXhdOwogICAgICB3aGVlbC5zdGVlcmluZyA9IHZhbHVlOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHdoZWVsIGZvcmNlIHRvIGFwcGx5IG9uIG9uZSBvZiB0aGUgd2hlZWxzIGVhY2ggdGltZSBzdGVwCiAgICAgKi8KCgogICAgYXBwbHlFbmdpbmVGb3JjZSh2YWx1ZSwgd2hlZWxJbmRleCkgewogICAgICB0aGlzLndoZWVsSW5mb3Nbd2hlZWxJbmRleF0uZW5naW5lRm9yY2UgPSB2YWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBicmFraW5nIGZvcmNlIG9mIGEgd2hlZWwKICAgICAqLwoKCiAgICBzZXRCcmFrZShicmFrZSwgd2hlZWxJbmRleCkgewogICAgICB0aGlzLndoZWVsSW5mb3Nbd2hlZWxJbmRleF0uYnJha2UgPSBicmFrZTsKICAgIH0KICAgIC8qKgogICAgICogQWRkIHRoZSB2ZWhpY2xlIGluY2x1ZGluZyBpdHMgY29uc3RyYWludHMgdG8gdGhlIHdvcmxkLgogICAgICovCgoKICAgIGFkZFRvV29ybGQod29ybGQpIHsKICAgICAgd29ybGQuYWRkQm9keSh0aGlzLmNoYXNzaXNCb2R5KTsKICAgICAgY29uc3QgdGhhdCA9IHRoaXM7CgogICAgICB0aGlzLnByZVN0ZXBDYWxsYmFjayA9ICgpID0+IHsKICAgICAgICB0aGF0LnVwZGF0ZVZlaGljbGUod29ybGQuZHQpOwogICAgICB9OwoKICAgICAgd29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncHJlU3RlcCcsIHRoaXMucHJlU3RlcENhbGxiYWNrKTsKICAgICAgdGhpcy53b3JsZCA9IHdvcmxkOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgb25lIG9mIHRoZSB3aGVlbCBheGxlcywgd29ybGQtb3JpZW50ZWQuCiAgICAgKi8KCgogICAgZ2V0VmVoaWNsZUF4aXNXb3JsZChheGlzSW5kZXgsIHJlc3VsdCkgewogICAgICByZXN1bHQuc2V0KGF4aXNJbmRleCA9PT0gMCA/IDEgOiAwLCBheGlzSW5kZXggPT09IDEgPyAxIDogMCwgYXhpc0luZGV4ID09PSAyID8gMSA6IDApOwogICAgICB0aGlzLmNoYXNzaXNCb2R5LnZlY3RvclRvV29ybGRGcmFtZShyZXN1bHQsIHJlc3VsdCk7CiAgICB9CgogICAgdXBkYXRlVmVoaWNsZSh0aW1lU3RlcCkgewogICAgICBjb25zdCB3aGVlbEluZm9zID0gdGhpcy53aGVlbEluZm9zOwogICAgICBjb25zdCBudW1XaGVlbHMgPSB3aGVlbEluZm9zLmxlbmd0aDsKICAgICAgY29uc3QgY2hhc3Npc0JvZHkgPSB0aGlzLmNoYXNzaXNCb2R5OwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1XaGVlbHM7IGkrKykgewogICAgICAgIHRoaXMudXBkYXRlV2hlZWxUcmFuc2Zvcm0oaSk7CiAgICAgIH0KCiAgICAgIHRoaXMuY3VycmVudFZlaGljbGVTcGVlZEttSG91ciA9IDMuNiAqIGNoYXNzaXNCb2R5LnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICBjb25zdCBmb3J3YXJkV29ybGQgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmdldFZlaGljbGVBeGlzV29ybGQodGhpcy5pbmRleEZvcndhcmRBeGlzLCBmb3J3YXJkV29ybGQpOwoKICAgICAgaWYgKGZvcndhcmRXb3JsZC5kb3QoY2hhc3Npc0JvZHkudmVsb2NpdHkpIDwgMCkgewogICAgICAgIHRoaXMuY3VycmVudFZlaGljbGVTcGVlZEttSG91ciAqPSAtMTsKICAgICAgfSAvLyBzaW11bGF0ZSBzdXNwZW5zaW9uCgoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1XaGVlbHM7IGkrKykgewogICAgICAgIHRoaXMuY2FzdFJheSh3aGVlbEluZm9zW2ldKTsKICAgICAgfQoKICAgICAgdGhpcy51cGRhdGVTdXNwZW5zaW9uKHRpbWVTdGVwKTsKICAgICAgY29uc3QgaW1wdWxzZSA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHJlbHBvcyA9IG5ldyBWZWMzKCk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVdoZWVsczsgaSsrKSB7CiAgICAgICAgLy9hcHBseSBzdXNwZW5zaW9uIGZvcmNlCiAgICAgICAgY29uc3Qgd2hlZWwgPSB3aGVlbEluZm9zW2ldOwogICAgICAgIGxldCBzdXNwZW5zaW9uRm9yY2UgPSB3aGVlbC5zdXNwZW5zaW9uRm9yY2U7CgogICAgICAgIGlmIChzdXNwZW5zaW9uRm9yY2UgPiB3aGVlbC5tYXhTdXNwZW5zaW9uRm9yY2UpIHsKICAgICAgICAgIHN1c3BlbnNpb25Gb3JjZSA9IHdoZWVsLm1heFN1c3BlbnNpb25Gb3JjZTsKICAgICAgICB9CgogICAgICAgIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQuc2NhbGUoc3VzcGVuc2lvbkZvcmNlICogdGltZVN0ZXAsIGltcHVsc2UpOwogICAgICAgIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZC52c3ViKGNoYXNzaXNCb2R5LnBvc2l0aW9uLCByZWxwb3MpOwogICAgICAgIGNoYXNzaXNCb2R5LmFwcGx5SW1wdWxzZShpbXB1bHNlLCByZWxwb3MpOwogICAgICB9CgogICAgICB0aGlzLnVwZGF0ZUZyaWN0aW9uKHRpbWVTdGVwKTsKICAgICAgY29uc3QgaGl0Tm9ybWFsV29ybGRTY2FsZWRXaXRoUHJvaiA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHZlbCA9IG5ldyBWZWMzKCk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVdoZWVsczsgaSsrKSB7CiAgICAgICAgY29uc3Qgd2hlZWwgPSB3aGVlbEluZm9zW2ldOyAvL2NvbnN0IHJlbHBvcyA9IG5ldyBWZWMzKCk7CiAgICAgICAgLy93aGVlbC5jaGFzc2lzQ29ubmVjdGlvblBvaW50V29ybGQudnN1YihjaGFzc2lzQm9keS5wb3NpdGlvbiwgcmVscG9zKTsKCiAgICAgICAgY2hhc3Npc0JvZHkuZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQod2hlZWwuY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludFdvcmxkLCB2ZWwpOyAvLyBIYWNrIHRvIGdldCB0aGUgcm90YXRpb24gaW4gdGhlIGNvcnJlY3QgZGlyZWN0aW9uCgogICAgICAgIGxldCBtID0gMTsKCiAgICAgICAgc3dpdGNoICh0aGlzLmluZGV4VXBBeGlzKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIG0gPSAtMTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBpZiAod2hlZWwuaXNJbkNvbnRhY3QpIHsKICAgICAgICAgIHRoaXMuZ2V0VmVoaWNsZUF4aXNXb3JsZCh0aGlzLmluZGV4Rm9yd2FyZEF4aXMsIGZ3ZCk7CiAgICAgICAgICBjb25zdCBwcm9qID0gZndkLmRvdCh3aGVlbC5yYXljYXN0UmVzdWx0LmhpdE5vcm1hbFdvcmxkKTsKICAgICAgICAgIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQuc2NhbGUocHJvaiwgaGl0Tm9ybWFsV29ybGRTY2FsZWRXaXRoUHJvaik7CiAgICAgICAgICBmd2QudnN1YihoaXROb3JtYWxXb3JsZFNjYWxlZFdpdGhQcm9qLCBmd2QpOwogICAgICAgICAgY29uc3QgcHJvajIgPSBmd2QuZG90KHZlbCk7CiAgICAgICAgICB3aGVlbC5kZWx0YVJvdGF0aW9uID0gbSAqIHByb2oyICogdGltZVN0ZXAgLyB3aGVlbC5yYWRpdXM7CiAgICAgICAgfQoKICAgICAgICBpZiAoKHdoZWVsLnNsaWRpbmcgfHwgIXdoZWVsLmlzSW5Db250YWN0KSAmJiB3aGVlbC5lbmdpbmVGb3JjZSAhPT0gMCAmJiB3aGVlbC51c2VDdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkKSB7CiAgICAgICAgICAvLyBBcHBseSBjdXN0b20gcm90YXRpb24gd2hlbiBhY2NlbGVyYXRpbmcgYW5kIHNsaWRpbmcKICAgICAgICAgIHdoZWVsLmRlbHRhUm90YXRpb24gPSAod2hlZWwuZW5naW5lRm9yY2UgPiAwID8gMSA6IC0xKSAqIHdoZWVsLmN1c3RvbVNsaWRpbmdSb3RhdGlvbmFsU3BlZWQgKiB0aW1lU3RlcDsKICAgICAgICB9IC8vIExvY2sgd2hlZWxzCgoKICAgICAgICBpZiAoTWF0aC5hYnMod2hlZWwuYnJha2UpID4gTWF0aC5hYnMod2hlZWwuZW5naW5lRm9yY2UpKSB7CiAgICAgICAgICB3aGVlbC5kZWx0YVJvdGF0aW9uID0gMDsKICAgICAgICB9CgogICAgICAgIHdoZWVsLnJvdGF0aW9uICs9IHdoZWVsLmRlbHRhUm90YXRpb247IC8vIFVzZSB0aGUgb2xkIHZhbHVlCgogICAgICAgIHdoZWVsLmRlbHRhUm90YXRpb24gKj0gMC45OTsgLy8gZGFtcGluZyBvZiByb3RhdGlvbiB3aGVuIG5vdCBpbiBjb250YWN0CiAgICAgIH0KICAgIH0KCiAgICB1cGRhdGVTdXNwZW5zaW9uKGRlbHRhVGltZSkgewogICAgICBjb25zdCBjaGFzc2lzQm9keSA9IHRoaXMuY2hhc3Npc0JvZHk7CiAgICAgIGNvbnN0IGNoYXNzaXNNYXNzID0gY2hhc3Npc0JvZHkubWFzczsKICAgICAgY29uc3Qgd2hlZWxJbmZvcyA9IHRoaXMud2hlZWxJbmZvczsKICAgICAgY29uc3QgbnVtV2hlZWxzID0gd2hlZWxJbmZvcy5sZW5ndGg7CgogICAgICBmb3IgKGxldCB3X2l0ID0gMDsgd19pdCA8IG51bVdoZWVsczsgd19pdCsrKSB7CiAgICAgICAgY29uc3Qgd2hlZWwgPSB3aGVlbEluZm9zW3dfaXRdOwoKICAgICAgICBpZiAod2hlZWwuaXNJbkNvbnRhY3QpIHsKICAgICAgICAgIGxldCBmb3JjZTsgLy8gU3ByaW5nCgogICAgICAgICAgY29uc3Qgc3VzcF9sZW5ndGggPSB3aGVlbC5zdXNwZW5zaW9uUmVzdExlbmd0aDsKICAgICAgICAgIGNvbnN0IGN1cnJlbnRfbGVuZ3RoID0gd2hlZWwuc3VzcGVuc2lvbkxlbmd0aDsKICAgICAgICAgIGNvbnN0IGxlbmd0aF9kaWZmID0gc3VzcF9sZW5ndGggLSBjdXJyZW50X2xlbmd0aDsKICAgICAgICAgIGZvcmNlID0gd2hlZWwuc3VzcGVuc2lvblN0aWZmbmVzcyAqIGxlbmd0aF9kaWZmICogd2hlZWwuY2xpcHBlZEludkNvbnRhY3REb3RTdXNwZW5zaW9uOyAvLyBEYW1wZXIKCiAgICAgICAgICBjb25zdCBwcm9qZWN0ZWRfcmVsX3ZlbCA9IHdoZWVsLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5OwogICAgICAgICAgbGV0IHN1c3BfZGFtcGluZzsKCiAgICAgICAgICBpZiAocHJvamVjdGVkX3JlbF92ZWwgPCAwKSB7CiAgICAgICAgICAgIHN1c3BfZGFtcGluZyA9IHdoZWVsLmRhbXBpbmdDb21wcmVzc2lvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1c3BfZGFtcGluZyA9IHdoZWVsLmRhbXBpbmdSZWxheGF0aW9uOwogICAgICAgICAgfQoKICAgICAgICAgIGZvcmNlIC09IHN1c3BfZGFtcGluZyAqIHByb2plY3RlZF9yZWxfdmVsOwogICAgICAgICAgd2hlZWwuc3VzcGVuc2lvbkZvcmNlID0gZm9yY2UgKiBjaGFzc2lzTWFzczsKCiAgICAgICAgICBpZiAod2hlZWwuc3VzcGVuc2lvbkZvcmNlIDwgMCkgewogICAgICAgICAgICB3aGVlbC5zdXNwZW5zaW9uRm9yY2UgPSAwOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3aGVlbC5zdXNwZW5zaW9uRm9yY2UgPSAwOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmUgdGhlIHZlaGljbGUgaW5jbHVkaW5nIGl0cyBjb25zdHJhaW50cyBmcm9tIHRoZSB3b3JsZC4KICAgICAqLwoKCiAgICByZW1vdmVGcm9tV29ybGQod29ybGQpIHsKICAgICAgdGhpcy5jb25zdHJhaW50czsKICAgICAgd29ybGQucmVtb3ZlQm9keSh0aGlzLmNoYXNzaXNCb2R5KTsKICAgICAgd29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncHJlU3RlcCcsIHRoaXMucHJlU3RlcENhbGxiYWNrKTsKICAgICAgdGhpcy53b3JsZCA9IG51bGw7CiAgICB9CgogICAgY2FzdFJheSh3aGVlbCkgewogICAgICBjb25zdCByYXl2ZWN0b3IgPSBjYXN0UmF5X3JheXZlY3RvcjsKICAgICAgY29uc3QgdGFyZ2V0ID0gY2FzdFJheV90YXJnZXQ7CiAgICAgIHRoaXMudXBkYXRlV2hlZWxUcmFuc2Zvcm1Xb3JsZCh3aGVlbCk7CiAgICAgIGNvbnN0IGNoYXNzaXNCb2R5ID0gdGhpcy5jaGFzc2lzQm9keTsKICAgICAgbGV0IGRlcHRoID0gLTE7CiAgICAgIGNvbnN0IHJheWxlbiA9IHdoZWVsLnN1c3BlbnNpb25SZXN0TGVuZ3RoICsgd2hlZWwucmFkaXVzOwogICAgICB3aGVlbC5kaXJlY3Rpb25Xb3JsZC5zY2FsZShyYXlsZW4sIHJheXZlY3Rvcik7CiAgICAgIGNvbnN0IHNvdXJjZSA9IHdoZWVsLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRXb3JsZDsKICAgICAgc291cmNlLnZhZGQocmF5dmVjdG9yLCB0YXJnZXQpOwogICAgICBjb25zdCByYXljYXN0UmVzdWx0ID0gd2hlZWwucmF5Y2FzdFJlc3VsdDsKICAgICAgcmF5Y2FzdFJlc3VsdC5yZXNldCgpOyAvLyBUdXJuIG9mZiByYXkgY29sbGlzaW9uIHdpdGggdGhlIGNoYXNzaXMgdGVtcG9yYXJpbHkKCiAgICAgIGNvbnN0IG9sZFN0YXRlID0gY2hhc3Npc0JvZHkuY29sbGlzaW9uUmVzcG9uc2U7CiAgICAgIGNoYXNzaXNCb2R5LmNvbGxpc2lvblJlc3BvbnNlID0gZmFsc2U7IC8vIENhc3QgcmF5IGFnYWluc3Qgd29ybGQKCiAgICAgIHRoaXMud29ybGQucmF5VGVzdChzb3VyY2UsIHRhcmdldCwgcmF5Y2FzdFJlc3VsdCk7CiAgICAgIGNoYXNzaXNCb2R5LmNvbGxpc2lvblJlc3BvbnNlID0gb2xkU3RhdGU7CiAgICAgIGNvbnN0IG9iamVjdCA9IHJheWNhc3RSZXN1bHQuYm9keTsKICAgICAgd2hlZWwucmF5Y2FzdFJlc3VsdC5ncm91bmRPYmplY3QgPSAwOwoKICAgICAgaWYgKG9iamVjdCkgewogICAgICAgIGRlcHRoID0gcmF5Y2FzdFJlc3VsdC5kaXN0YW5jZTsKICAgICAgICB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdE5vcm1hbFdvcmxkID0gcmF5Y2FzdFJlc3VsdC5oaXROb3JtYWxXb3JsZDsKICAgICAgICB3aGVlbC5pc0luQ29udGFjdCA9IHRydWU7CiAgICAgICAgY29uc3QgaGl0RGlzdGFuY2UgPSByYXljYXN0UmVzdWx0LmRpc3RhbmNlOwogICAgICAgIHdoZWVsLnN1c3BlbnNpb25MZW5ndGggPSBoaXREaXN0YW5jZSAtIHdoZWVsLnJhZGl1czsgLy8gY2xhbXAgb24gbWF4IHN1c3BlbnNpb24gdHJhdmVsCgogICAgICAgIGNvbnN0IG1pblN1c3BlbnNpb25MZW5ndGggPSB3aGVlbC5zdXNwZW5zaW9uUmVzdExlbmd0aCAtIHdoZWVsLm1heFN1c3BlbnNpb25UcmF2ZWw7CiAgICAgICAgY29uc3QgbWF4U3VzcGVuc2lvbkxlbmd0aCA9IHdoZWVsLnN1c3BlbnNpb25SZXN0TGVuZ3RoICsgd2hlZWwubWF4U3VzcGVuc2lvblRyYXZlbDsKCiAgICAgICAgaWYgKHdoZWVsLnN1c3BlbnNpb25MZW5ndGggPCBtaW5TdXNwZW5zaW9uTGVuZ3RoKSB7CiAgICAgICAgICB3aGVlbC5zdXNwZW5zaW9uTGVuZ3RoID0gbWluU3VzcGVuc2lvbkxlbmd0aDsKICAgICAgICB9CgogICAgICAgIGlmICh3aGVlbC5zdXNwZW5zaW9uTGVuZ3RoID4gbWF4U3VzcGVuc2lvbkxlbmd0aCkgewogICAgICAgICAgd2hlZWwuc3VzcGVuc2lvbkxlbmd0aCA9IG1heFN1c3BlbnNpb25MZW5ndGg7CiAgICAgICAgICB3aGVlbC5yYXljYXN0UmVzdWx0LnJlc2V0KCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBkZW5vbWluYXRvciA9IHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQuZG90KHdoZWVsLmRpcmVjdGlvbldvcmxkKTsKICAgICAgICBjb25zdCBjaGFzc2lzX3ZlbG9jaXR5X2F0X2NvbnRhY3RQb2ludCA9IG5ldyBWZWMzKCk7CiAgICAgICAgY2hhc3Npc0JvZHkuZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQod2hlZWwucmF5Y2FzdFJlc3VsdC5oaXRQb2ludFdvcmxkLCBjaGFzc2lzX3ZlbG9jaXR5X2F0X2NvbnRhY3RQb2ludCk7CiAgICAgICAgY29uc3QgcHJvalZlbCA9IHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQuZG90KGNoYXNzaXNfdmVsb2NpdHlfYXRfY29udGFjdFBvaW50KTsKCiAgICAgICAgaWYgKGRlbm9taW5hdG9yID49IC0wLjEpIHsKICAgICAgICAgIHdoZWVsLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5ID0gMDsKICAgICAgICAgIHdoZWVsLmNsaXBwZWRJbnZDb250YWN0RG90U3VzcGVuc2lvbiA9IDEgLyAwLjE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGludiA9IC0xIC8gZGVub21pbmF0b3I7CiAgICAgICAgICB3aGVlbC5zdXNwZW5zaW9uUmVsYXRpdmVWZWxvY2l0eSA9IHByb2pWZWwgKiBpbnY7CiAgICAgICAgICB3aGVlbC5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSBpbnY7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vcHV0IHdoZWVsIGluZm8gYXMgaW4gcmVzdCBwb3NpdGlvbgogICAgICAgIHdoZWVsLnN1c3BlbnNpb25MZW5ndGggPSB3aGVlbC5zdXNwZW5zaW9uUmVzdExlbmd0aCArIDAgKiB3aGVlbC5tYXhTdXNwZW5zaW9uVHJhdmVsOwogICAgICAgIHdoZWVsLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5ID0gMC4wOwogICAgICAgIHdoZWVsLmRpcmVjdGlvbldvcmxkLnNjYWxlKC0xLCB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdE5vcm1hbFdvcmxkKTsKICAgICAgICB3aGVlbC5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxLjA7CiAgICAgIH0KCiAgICAgIHJldHVybiBkZXB0aDsKICAgIH0KCiAgICB1cGRhdGVXaGVlbFRyYW5zZm9ybVdvcmxkKHdoZWVsKSB7CiAgICAgIHdoZWVsLmlzSW5Db250YWN0ID0gZmFsc2U7CiAgICAgIGNvbnN0IGNoYXNzaXNCb2R5ID0gdGhpcy5jaGFzc2lzQm9keTsKICAgICAgY2hhc3Npc0JvZHkucG9pbnRUb1dvcmxkRnJhbWUod2hlZWwuY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludExvY2FsLCB3aGVlbC5jaGFzc2lzQ29ubmVjdGlvblBvaW50V29ybGQpOwogICAgICBjaGFzc2lzQm9keS52ZWN0b3JUb1dvcmxkRnJhbWUod2hlZWwuZGlyZWN0aW9uTG9jYWwsIHdoZWVsLmRpcmVjdGlvbldvcmxkKTsKICAgICAgY2hhc3Npc0JvZHkudmVjdG9yVG9Xb3JsZEZyYW1lKHdoZWVsLmF4bGVMb2NhbCwgd2hlZWwuYXhsZVdvcmxkKTsKICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlIG9uZSBvZiB0aGUgd2hlZWwgdHJhbnNmb3JtLgogICAgICogTm90ZSB3aGVuIHJlbmRlcmluZyB3aGVlbHM6IGR1cmluZyBlYWNoIHN0ZXAsIHdoZWVsIHRyYW5zZm9ybXMgYXJlIHVwZGF0ZWQgQkVGT1JFIHRoZSBjaGFzc2lzOyBpZS4gdGhlaXIgcG9zaXRpb24gYmVjb21lcyBpbnZhbGlkIGFmdGVyIHRoZSBzdGVwLiBUaHVzIHdoZW4geW91IHJlbmRlciB3aGVlbHMsIHlvdSBtdXN0IHVwZGF0ZSB3aGVlbCB0cmFuc2Zvcm1zIGJlZm9yZSByZW5kZXJpbmcgdGhlbS4gU2VlIHJheWNhc3RWZWhpY2xlIGRlbW8gZm9yIGFuIGV4YW1wbGUuCiAgICAgKiBAcGFyYW0gd2hlZWxJbmRleCBUaGUgd2hlZWwgaW5kZXggdG8gdXBkYXRlLgogICAgICovCgoKICAgIHVwZGF0ZVdoZWVsVHJhbnNmb3JtKHdoZWVsSW5kZXgpIHsKICAgICAgY29uc3QgdXAgPSB0bXBWZWM0OwogICAgICBjb25zdCByaWdodCA9IHRtcFZlYzU7CiAgICAgIGNvbnN0IGZ3ZCA9IHRtcFZlYzY7CiAgICAgIGNvbnN0IHdoZWVsID0gdGhpcy53aGVlbEluZm9zW3doZWVsSW5kZXhdOwogICAgICB0aGlzLnVwZGF0ZVdoZWVsVHJhbnNmb3JtV29ybGQod2hlZWwpOwogICAgICB3aGVlbC5kaXJlY3Rpb25Mb2NhbC5zY2FsZSgtMSwgdXApOwogICAgICByaWdodC5jb3B5KHdoZWVsLmF4bGVMb2NhbCk7CiAgICAgIHVwLmNyb3NzKHJpZ2h0LCBmd2QpOwogICAgICBmd2Qubm9ybWFsaXplKCk7CiAgICAgIHJpZ2h0Lm5vcm1hbGl6ZSgpOyAvLyBSb3RhdGUgYXJvdW5kIHN0ZWVyaW5nIG92ZXIgdGhlIHdoZWVsQXhsZQoKICAgICAgY29uc3Qgc3RlZXJpbmcgPSB3aGVlbC5zdGVlcmluZzsKICAgICAgY29uc3Qgc3RlZXJpbmdPcm4gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzdGVlcmluZ09ybi5zZXRGcm9tQXhpc0FuZ2xlKHVwLCBzdGVlcmluZyk7CiAgICAgIGNvbnN0IHJvdGF0aW5nT3JuID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgcm90YXRpbmdPcm4uc2V0RnJvbUF4aXNBbmdsZShyaWdodCwgd2hlZWwucm90YXRpb24pOyAvLyBXb3JsZCByb3RhdGlvbiBvZiB0aGUgd2hlZWwKCiAgICAgIGNvbnN0IHEgPSB3aGVlbC53b3JsZFRyYW5zZm9ybS5xdWF0ZXJuaW9uOwogICAgICB0aGlzLmNoYXNzaXNCb2R5LnF1YXRlcm5pb24ubXVsdChzdGVlcmluZ09ybiwgcSk7CiAgICAgIHEubXVsdChyb3RhdGluZ09ybiwgcSk7CiAgICAgIHEubm9ybWFsaXplKCk7IC8vIHdvcmxkIHBvc2l0aW9uIG9mIHRoZSB3aGVlbAoKICAgICAgY29uc3QgcCA9IHdoZWVsLndvcmxkVHJhbnNmb3JtLnBvc2l0aW9uOwogICAgICBwLmNvcHkod2hlZWwuZGlyZWN0aW9uV29ybGQpOwogICAgICBwLnNjYWxlKHdoZWVsLnN1c3BlbnNpb25MZW5ndGgsIHApOwogICAgICBwLnZhZGQod2hlZWwuY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludFdvcmxkLCBwKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSB3b3JsZCB0cmFuc2Zvcm0gb2Ygb25lIG9mIHRoZSB3aGVlbHMKICAgICAqLwoKCiAgICBnZXRXaGVlbFRyYW5zZm9ybVdvcmxkKHdoZWVsSW5kZXgpIHsKICAgICAgcmV0dXJuIHRoaXMud2hlZWxJbmZvc1t3aGVlbEluZGV4XS53b3JsZFRyYW5zZm9ybTsKICAgIH0KCiAgICB1cGRhdGVGcmljdGlvbih0aW1lU3RlcCkgewogICAgICBjb25zdCBzdXJmTm9ybWFsV1Nfc2NhbGVkX3Byb2ogPSB1cGRhdGVGcmljdGlvbl9zdXJmTm9ybWFsV1Nfc2NhbGVkX3Byb2o7IC8vY2FsY3VsYXRlIHRoZSBpbXB1bHNlLCBzbyB0aGF0IHRoZSB3aGVlbHMgZG9uJ3QgbW92ZSBzaWRld2FyZHMKCiAgICAgIGNvbnN0IHdoZWVsSW5mb3MgPSB0aGlzLndoZWVsSW5mb3M7CiAgICAgIGNvbnN0IG51bVdoZWVscyA9IHdoZWVsSW5mb3MubGVuZ3RoOwogICAgICBjb25zdCBjaGFzc2lzQm9keSA9IHRoaXMuY2hhc3Npc0JvZHk7CiAgICAgIGNvbnN0IGZvcndhcmRXUyA9IHVwZGF0ZUZyaWN0aW9uX2ZvcndhcmRXUzsKICAgICAgY29uc3QgYXhsZSA9IHVwZGF0ZUZyaWN0aW9uX2F4bGU7CiAgICAgIHRoaXMubnVtV2hlZWxzT25Hcm91bmQgPSAwOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1XaGVlbHM7IGkrKykgewogICAgICAgIGNvbnN0IHdoZWVsID0gd2hlZWxJbmZvc1tpXTsKICAgICAgICBjb25zdCBncm91bmRPYmplY3QgPSB3aGVlbC5yYXljYXN0UmVzdWx0LmJvZHk7CgogICAgICAgIGlmIChncm91bmRPYmplY3QpIHsKICAgICAgICAgIHRoaXMubnVtV2hlZWxzT25Hcm91bmQrKzsKICAgICAgICB9CgogICAgICAgIHdoZWVsLnNpZGVJbXB1bHNlID0gMDsKICAgICAgICB3aGVlbC5mb3J3YXJkSW1wdWxzZSA9IDA7CgogICAgICAgIGlmICghZm9yd2FyZFdTW2ldKSB7CiAgICAgICAgICBmb3J3YXJkV1NbaV0gPSBuZXcgVmVjMygpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFheGxlW2ldKSB7CiAgICAgICAgICBheGxlW2ldID0gbmV3IFZlYzMoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtV2hlZWxzOyBpKyspIHsKICAgICAgICBjb25zdCB3aGVlbCA9IHdoZWVsSW5mb3NbaV07CiAgICAgICAgY29uc3QgZ3JvdW5kT2JqZWN0ID0gd2hlZWwucmF5Y2FzdFJlc3VsdC5ib2R5OwoKICAgICAgICBpZiAoZ3JvdW5kT2JqZWN0KSB7CiAgICAgICAgICBjb25zdCBheGxlaSA9IGF4bGVbaV07CiAgICAgICAgICBjb25zdCB3aGVlbFRyYW5zID0gdGhpcy5nZXRXaGVlbFRyYW5zZm9ybVdvcmxkKGkpOyAvLyBHZXQgd29ybGQgYXhsZQoKICAgICAgICAgIHdoZWVsVHJhbnMudmVjdG9yVG9Xb3JsZEZyYW1lKGRpcmVjdGlvbnNbdGhpcy5pbmRleFJpZ2h0QXhpc10sIGF4bGVpKTsKICAgICAgICAgIGNvbnN0IHN1cmZOb3JtYWxXUyA9IHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQ7CiAgICAgICAgICBjb25zdCBwcm9qID0gYXhsZWkuZG90KHN1cmZOb3JtYWxXUyk7CiAgICAgICAgICBzdXJmTm9ybWFsV1Muc2NhbGUocHJvaiwgc3VyZk5vcm1hbFdTX3NjYWxlZF9wcm9qKTsKICAgICAgICAgIGF4bGVpLnZzdWIoc3VyZk5vcm1hbFdTX3NjYWxlZF9wcm9qLCBheGxlaSk7CiAgICAgICAgICBheGxlaS5ub3JtYWxpemUoKTsKICAgICAgICAgIHN1cmZOb3JtYWxXUy5jcm9zcyhheGxlaSwgZm9yd2FyZFdTW2ldKTsKICAgICAgICAgIGZvcndhcmRXU1tpXS5ub3JtYWxpemUoKTsKICAgICAgICAgIHdoZWVsLnNpZGVJbXB1bHNlID0gcmVzb2x2ZVNpbmdsZUJpbGF0ZXJhbChjaGFzc2lzQm9keSwgd2hlZWwucmF5Y2FzdFJlc3VsdC5oaXRQb2ludFdvcmxkLCBncm91bmRPYmplY3QsIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZCwgYXhsZWkpOwogICAgICAgICAgd2hlZWwuc2lkZUltcHVsc2UgKj0gc2lkZUZyaWN0aW9uU3RpZmZuZXNzMjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHNpZGVGYWN0b3IgPSAxOwogICAgICBjb25zdCBmd2RGYWN0b3IgPSAwLjU7CiAgICAgIHRoaXMuc2xpZGluZyA9IGZhbHNlOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1XaGVlbHM7IGkrKykgewogICAgICAgIGNvbnN0IHdoZWVsID0gd2hlZWxJbmZvc1tpXTsKICAgICAgICBjb25zdCBncm91bmRPYmplY3QgPSB3aGVlbC5yYXljYXN0UmVzdWx0LmJvZHk7CiAgICAgICAgbGV0IHJvbGxpbmdGcmljdGlvbiA9IDA7CiAgICAgICAgd2hlZWwuc2xpcEluZm8gPSAxOwoKICAgICAgICBpZiAoZ3JvdW5kT2JqZWN0KSB7CiAgICAgICAgICBjb25zdCBkZWZhdWx0Um9sbGluZ0ZyaWN0aW9uSW1wdWxzZSA9IDA7CiAgICAgICAgICBjb25zdCBtYXhJbXB1bHNlID0gd2hlZWwuYnJha2UgPyB3aGVlbC5icmFrZSA6IGRlZmF1bHRSb2xsaW5nRnJpY3Rpb25JbXB1bHNlOyAvLyBidFdoZWVsQ29udGFjdFBvaW50IGNvbnRhY3RQdChjaGFzc2lzQm9keSxncm91bmRPYmplY3Qsd2hlZWxJbmZyYXljYXN0SW5mby5oaXRQb2ludFdvcmxkLGZvcndhcmRXU1t3aGVlbF0sbWF4SW1wdWxzZSk7CiAgICAgICAgICAvLyByb2xsaW5nRnJpY3Rpb24gPSBjYWxjUm9sbGluZ0ZyaWN0aW9uKGNvbnRhY3RQdCk7CgogICAgICAgICAgcm9sbGluZ0ZyaWN0aW9uID0gY2FsY1JvbGxpbmdGcmljdGlvbihjaGFzc2lzQm9keSwgZ3JvdW5kT2JqZWN0LCB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdFBvaW50V29ybGQsIGZvcndhcmRXU1tpXSwgbWF4SW1wdWxzZSk7CiAgICAgICAgICByb2xsaW5nRnJpY3Rpb24gKz0gd2hlZWwuZW5naW5lRm9yY2UgKiB0aW1lU3RlcDsgLy8gcm9sbGluZ0ZyaWN0aW9uID0gMDsKCiAgICAgICAgICBjb25zdCBmYWN0b3IgPSBtYXhJbXB1bHNlIC8gcm9sbGluZ0ZyaWN0aW9uOwogICAgICAgICAgd2hlZWwuc2xpcEluZm8gKj0gZmFjdG9yOwogICAgICAgIH0gLy9zd2l0Y2ggYmV0d2VlbiBhY3RpdmUgcm9sbGluZyAodGhyb3R0bGUpLCBicmFraW5nIGFuZCBub24tYWN0aXZlIHJvbGxpbmcgZnJpY3Rpb24gKG50aHJvdHRsZS9icmVhaykKCgogICAgICAgIHdoZWVsLmZvcndhcmRJbXB1bHNlID0gMDsKICAgICAgICB3aGVlbC5za2lkSW5mbyA9IDE7CgogICAgICAgIGlmIChncm91bmRPYmplY3QpIHsKICAgICAgICAgIHdoZWVsLnNraWRJbmZvID0gMTsKICAgICAgICAgIGNvbnN0IG1heGltcCA9IHdoZWVsLnN1c3BlbnNpb25Gb3JjZSAqIHRpbWVTdGVwICogd2hlZWwuZnJpY3Rpb25TbGlwOwogICAgICAgICAgY29uc3QgbWF4aW1wU2lkZSA9IG1heGltcDsKICAgICAgICAgIGNvbnN0IG1heGltcFNxdWFyZWQgPSBtYXhpbXAgKiBtYXhpbXBTaWRlOwogICAgICAgICAgd2hlZWwuZm9yd2FyZEltcHVsc2UgPSByb2xsaW5nRnJpY3Rpb247IC8vd2hlZWxJbmZvLmVuZ2luZUZvcmNlKiB0aW1lU3RlcDsKCiAgICAgICAgICBjb25zdCB4ID0gd2hlZWwuZm9yd2FyZEltcHVsc2UgKiBmd2RGYWN0b3IgLyB3aGVlbC5mb3J3YXJkQWNjZWxlcmF0aW9uOwogICAgICAgICAgY29uc3QgeSA9IHdoZWVsLnNpZGVJbXB1bHNlICogc2lkZUZhY3RvciAvIHdoZWVsLnNpZGVBY2NlbGVyYXRpb247CiAgICAgICAgICBjb25zdCBpbXB1bHNlU3F1YXJlZCA9IHggKiB4ICsgeSAqIHk7CiAgICAgICAgICB3aGVlbC5zbGlkaW5nID0gZmFsc2U7CgogICAgICAgICAgaWYgKGltcHVsc2VTcXVhcmVkID4gbWF4aW1wU3F1YXJlZCkgewogICAgICAgICAgICB0aGlzLnNsaWRpbmcgPSB0cnVlOwogICAgICAgICAgICB3aGVlbC5zbGlkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgZmFjdG9yID0gbWF4aW1wIC8gTWF0aC5zcXJ0KGltcHVsc2VTcXVhcmVkKTsKICAgICAgICAgICAgd2hlZWwuc2tpZEluZm8gKj0gZmFjdG9yOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuc2xpZGluZykgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtV2hlZWxzOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHdoZWVsID0gd2hlZWxJbmZvc1tpXTsKCiAgICAgICAgICBpZiAod2hlZWwuc2lkZUltcHVsc2UgIT09IDApIHsKICAgICAgICAgICAgaWYgKHdoZWVsLnNraWRJbmZvIDwgMSkgewogICAgICAgICAgICAgIHdoZWVsLmZvcndhcmRJbXB1bHNlICo9IHdoZWVsLnNraWRJbmZvOwogICAgICAgICAgICAgIHdoZWVsLnNpZGVJbXB1bHNlICo9IHdoZWVsLnNraWRJbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIGFwcGx5IHRoZSBpbXB1bHNlcwoKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtV2hlZWxzOyBpKyspIHsKICAgICAgICBjb25zdCB3aGVlbCA9IHdoZWVsSW5mb3NbaV07CiAgICAgICAgY29uc3QgcmVsX3BvcyA9IG5ldyBWZWMzKCk7CiAgICAgICAgd2hlZWwucmF5Y2FzdFJlc3VsdC5oaXRQb2ludFdvcmxkLnZzdWIoY2hhc3Npc0JvZHkucG9zaXRpb24sIHJlbF9wb3MpOyAvLyBjYW5ub25zIGFwcGx5aW1wdWxzZSBpcyB1c2luZyB3b3JsZCBjb29yZCBmb3IgdGhlIHBvc2l0aW9uCiAgICAgICAgLy9yZWxfcG9zLmNvcHkod2hlZWwucmF5Y2FzdFJlc3VsdC5oaXRQb2ludFdvcmxkKTsKCiAgICAgICAgaWYgKHdoZWVsLmZvcndhcmRJbXB1bHNlICE9PSAwKSB7CiAgICAgICAgICBjb25zdCBpbXB1bHNlID0gbmV3IFZlYzMoKTsKICAgICAgICAgIGZvcndhcmRXU1tpXS5zY2FsZSh3aGVlbC5mb3J3YXJkSW1wdWxzZSwgaW1wdWxzZSk7CiAgICAgICAgICBjaGFzc2lzQm9keS5hcHBseUltcHVsc2UoaW1wdWxzZSwgcmVsX3Bvcyk7CiAgICAgICAgfQoKICAgICAgICBpZiAod2hlZWwuc2lkZUltcHVsc2UgIT09IDApIHsKICAgICAgICAgIGNvbnN0IGdyb3VuZE9iamVjdCA9IHdoZWVsLnJheWNhc3RSZXN1bHQuYm9keTsKICAgICAgICAgIGNvbnN0IHJlbF9wb3MyID0gbmV3IFZlYzMoKTsKICAgICAgICAgIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZC52c3ViKGdyb3VuZE9iamVjdC5wb3NpdGlvbiwgcmVsX3BvczIpOyAvL3JlbF9wb3MyLmNvcHkod2hlZWwucmF5Y2FzdFJlc3VsdC5oaXRQb2ludFdvcmxkKTsKCiAgICAgICAgICBjb25zdCBzaWRlSW1wID0gbmV3IFZlYzMoKTsKICAgICAgICAgIGF4bGVbaV0uc2NhbGUod2hlZWwuc2lkZUltcHVsc2UsIHNpZGVJbXApOyAvLyBTY2FsZSB0aGUgcmVsYXRpdmUgcG9zaXRpb24gaW4gdGhlIHVwIGRpcmVjdGlvbiB3aXRoIHJvbGxJbmZsdWVuY2UuCiAgICAgICAgICAvLyBJZiByb2xsSW5mbHVlbmNlIGlzIDEsIHRoZSBpbXB1bHNlIHdpbGwgYmUgYXBwbGllZCBvbiB0aGUgaGl0UG9pbnQgKGVhc3kgdG8gcm9sbCBvdmVyKSwgaWYgaXQgaXMgemVybyBpdCB3aWxsIGJlIGFwcGxpZWQgaW4gdGhlIHNhbWUgcGxhbmUgYXMgdGhlIGNlbnRlciBvZiBtYXNzIChub3QgZWFzeSB0byByb2xsIG92ZXIpLgoKICAgICAgICAgIGNoYXNzaXNCb2R5LnZlY3RvclRvTG9jYWxGcmFtZShyZWxfcG9zLCByZWxfcG9zKTsKICAgICAgICAgIHJlbF9wb3NbJ3h5eidbdGhpcy5pbmRleFVwQXhpc11dICo9IHdoZWVsLnJvbGxJbmZsdWVuY2U7CiAgICAgICAgICBjaGFzc2lzQm9keS52ZWN0b3JUb1dvcmxkRnJhbWUocmVsX3BvcywgcmVsX3Bvcyk7CiAgICAgICAgICBjaGFzc2lzQm9keS5hcHBseUltcHVsc2Uoc2lkZUltcCwgcmVsX3Bvcyk7IC8vYXBwbHkgZnJpY3Rpb24gaW1wdWxzZSBvbiB0aGUgZ3JvdW5kCgogICAgICAgICAgc2lkZUltcC5zY2FsZSgtMSwgc2lkZUltcCk7CiAgICAgICAgICBncm91bmRPYmplY3QuYXBwbHlJbXB1bHNlKHNpZGVJbXAsIHJlbF9wb3MyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgfQogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFZlYzQgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFZlYzUgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFZlYzYgPSBuZXcgVmVjMygpOwogIG5ldyBSYXkoKTsKICBuZXcgVmVjMygpOwogIGNvbnN0IGNhc3RSYXlfcmF5dmVjdG9yID0gbmV3IFZlYzMoKTsKICBjb25zdCBjYXN0UmF5X3RhcmdldCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgZGlyZWN0aW9ucyA9IFtuZXcgVmVjMygxLCAwLCAwKSwgbmV3IFZlYzMoMCwgMSwgMCksIG5ldyBWZWMzKDAsIDAsIDEpXTsKICBjb25zdCB1cGRhdGVGcmljdGlvbl9zdXJmTm9ybWFsV1Nfc2NhbGVkX3Byb2ogPSBuZXcgVmVjMygpOwogIGNvbnN0IHVwZGF0ZUZyaWN0aW9uX2F4bGUgPSBbXTsKICBjb25zdCB1cGRhdGVGcmljdGlvbl9mb3J3YXJkV1MgPSBbXTsKICBjb25zdCBzaWRlRnJpY3Rpb25TdGlmZm5lc3MyID0gMTsKICBjb25zdCBjYWxjUm9sbGluZ0ZyaWN0aW9uX3ZlbDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNhbGNSb2xsaW5nRnJpY3Rpb25fdmVsMiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgY2FsY1JvbGxpbmdGcmljdGlvbl92ZWwgPSBuZXcgVmVjMygpOwoKICBmdW5jdGlvbiBjYWxjUm9sbGluZ0ZyaWN0aW9uKGJvZHkwLCBib2R5MSwgZnJpY3Rpb25Qb3NXb3JsZCwgZnJpY3Rpb25EaXJlY3Rpb25Xb3JsZCwgbWF4SW1wdWxzZSkgewogICAgbGV0IGoxID0gMDsKICAgIGNvbnN0IGNvbnRhY3RQb3NXb3JsZCA9IGZyaWN0aW9uUG9zV29ybGQ7IC8vIGNvbnN0IHJlbF9wb3MxID0gbmV3IFZlYzMoKTsKICAgIC8vIGNvbnN0IHJlbF9wb3MyID0gbmV3IFZlYzMoKTsKCiAgICBjb25zdCB2ZWwxID0gY2FsY1JvbGxpbmdGcmljdGlvbl92ZWwxOwogICAgY29uc3QgdmVsMiA9IGNhbGNSb2xsaW5nRnJpY3Rpb25fdmVsMjsKICAgIGNvbnN0IHZlbCA9IGNhbGNSb2xsaW5nRnJpY3Rpb25fdmVsOyAvLyBjb250YWN0UG9zV29ybGQudnN1Yihib2R5MC5wb3NpdGlvbiwgcmVsX3BvczEpOwogICAgLy8gY29udGFjdFBvc1dvcmxkLnZzdWIoYm9keTEucG9zaXRpb24sIHJlbF9wb3MyKTsKCiAgICBib2R5MC5nZXRWZWxvY2l0eUF0V29ybGRQb2ludChjb250YWN0UG9zV29ybGQsIHZlbDEpOwogICAgYm9keTEuZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQoY29udGFjdFBvc1dvcmxkLCB2ZWwyKTsKICAgIHZlbDEudnN1Yih2ZWwyLCB2ZWwpOwogICAgY29uc3QgdnJlbCA9IGZyaWN0aW9uRGlyZWN0aW9uV29ybGQuZG90KHZlbCk7CiAgICBjb25zdCBkZW5vbTAgPSBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yKGJvZHkwLCBmcmljdGlvblBvc1dvcmxkLCBmcmljdGlvbkRpcmVjdGlvbldvcmxkKTsKICAgIGNvbnN0IGRlbm9tMSA9IGNvbXB1dGVJbXB1bHNlRGVub21pbmF0b3IoYm9keTEsIGZyaWN0aW9uUG9zV29ybGQsIGZyaWN0aW9uRGlyZWN0aW9uV29ybGQpOwogICAgY29uc3QgcmVsYXhhdGlvbiA9IDE7CiAgICBjb25zdCBqYWNEaWFnQUJJbnYgPSByZWxheGF0aW9uIC8gKGRlbm9tMCArIGRlbm9tMSk7IC8vIGNhbGN1bGF0ZSBqIHRoYXQgbW92ZXMgdXMgdG8gemVybyByZWxhdGl2ZSB2ZWxvY2l0eQoKICAgIGoxID0gLXZyZWwgKiBqYWNEaWFnQUJJbnY7CgogICAgaWYgKG1heEltcHVsc2UgPCBqMSkgewogICAgICBqMSA9IG1heEltcHVsc2U7CiAgICB9CgogICAgaWYgKGoxIDwgLW1heEltcHVsc2UpIHsKICAgICAgajEgPSAtbWF4SW1wdWxzZTsKICAgIH0KCiAgICByZXR1cm4gajE7CiAgfQoKICBjb25zdCBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX3IwID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX2MwID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX3ZlYyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcl9tID0gbmV3IFZlYzMoKTsKCiAgZnVuY3Rpb24gY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcihib2R5LCBwb3MsIG5vcm1hbCkgewogICAgY29uc3QgcjAgPSBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX3IwOwogICAgY29uc3QgYzAgPSBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX2MwOwogICAgY29uc3QgdmVjID0gY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcl92ZWM7CiAgICBjb25zdCBtID0gY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcl9tOwogICAgcG9zLnZzdWIoYm9keS5wb3NpdGlvbiwgcjApOwogICAgcjAuY3Jvc3Mobm9ybWFsLCBjMCk7CiAgICBib2R5LmludkluZXJ0aWFXb3JsZC52bXVsdChjMCwgbSk7CiAgICBtLmNyb3NzKHIwLCB2ZWMpOwogICAgcmV0dXJuIGJvZHkuaW52TWFzcyArIG5vcm1hbC5kb3QodmVjKTsKICB9CgogIGNvbnN0IHJlc29sdmVTaW5nbGVCaWxhdGVyYWxfdmVsMSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcmVzb2x2ZVNpbmdsZUJpbGF0ZXJhbF92ZWwyID0gbmV3IFZlYzMoKTsKICBjb25zdCByZXNvbHZlU2luZ2xlQmlsYXRlcmFsX3ZlbCA9IG5ldyBWZWMzKCk7IC8vIGJpbGF0ZXJhbCBjb25zdHJhaW50IGJldHdlZW4gdHdvIGR5bmFtaWMgb2JqZWN0cwoKICBmdW5jdGlvbiByZXNvbHZlU2luZ2xlQmlsYXRlcmFsKGJvZHkxLCBwb3MxLCBib2R5MiwgcG9zMiwgbm9ybWFsKSB7CiAgICBjb25zdCBub3JtYWxMZW5TcXIgPSBub3JtYWwubGVuZ3RoU3F1YXJlZCgpOwoKICAgIGlmIChub3JtYWxMZW5TcXIgPiAxLjEpIHsKICAgICAgcmV0dXJuIDA7IC8vIG5vIGltcHVsc2UKICAgIH0gLy8gY29uc3QgcmVsX3BvczEgPSBuZXcgVmVjMygpOwogICAgLy8gY29uc3QgcmVsX3BvczIgPSBuZXcgVmVjMygpOwogICAgLy8gcG9zMS52c3ViKGJvZHkxLnBvc2l0aW9uLCByZWxfcG9zMSk7CiAgICAvLyBwb3MyLnZzdWIoYm9keTIucG9zaXRpb24sIHJlbF9wb3MyKTsKCgogICAgY29uc3QgdmVsMSA9IHJlc29sdmVTaW5nbGVCaWxhdGVyYWxfdmVsMTsKICAgIGNvbnN0IHZlbDIgPSByZXNvbHZlU2luZ2xlQmlsYXRlcmFsX3ZlbDI7CiAgICBjb25zdCB2ZWwgPSByZXNvbHZlU2luZ2xlQmlsYXRlcmFsX3ZlbDsKICAgIGJvZHkxLmdldFZlbG9jaXR5QXRXb3JsZFBvaW50KHBvczEsIHZlbDEpOwogICAgYm9keTIuZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQocG9zMiwgdmVsMik7CiAgICB2ZWwxLnZzdWIodmVsMiwgdmVsKTsKICAgIGNvbnN0IHJlbF92ZWwgPSBub3JtYWwuZG90KHZlbCk7CiAgICBjb25zdCBjb250YWN0RGFtcGluZyA9IDAuMjsKICAgIGNvbnN0IG1hc3NUZXJtID0gMSAvIChib2R5MS5pbnZNYXNzICsgYm9keTIuaW52TWFzcyk7CiAgICBjb25zdCBpbXB1bHNlID0gLWNvbnRhY3REYW1waW5nICogcmVsX3ZlbCAqIG1hc3NUZXJtOwogICAgcmV0dXJuIGltcHVsc2U7CiAgfQoKICAvKioKICAgKiBTcGhlcmljYWwgc2hhcGUKICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCByYWRpdXMgPSAxCiAgICogICAgIGNvbnN0IHNwaGVyZVNoYXBlID0gbmV3IENBTk5PTi5TcGhlcmUocmFkaXVzKQogICAqICAgICBjb25zdCBzcGhlcmVCb2R5ID0gbmV3IENBTk5PTi5Cb2R5KHsgbWFzczogMSwgc2hhcGU6IHNwaGVyZVNoYXBlIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkoc3BoZXJlQm9keSkKICAgKi8KICBjbGFzcyBTcGhlcmUgZXh0ZW5kcyBTaGFwZSB7CiAgICAvKioKICAgICAqIFRoZSByYWRpdXMgb2YgdGhlIHNwaGVyZS4KICAgICAqLwoKICAgIC8qKgogICAgICoKICAgICAqIEBwYXJhbSByYWRpdXMgVGhlIHJhZGl1cyBvZiB0aGUgc3BoZXJlLCBhIG5vbi1uZWdhdGl2ZSBudW1iZXIuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKHJhZGl1cykgewogICAgICBzdXBlcih7CiAgICAgICAgdHlwZTogU2hhcGUudHlwZXMuU1BIRVJFCiAgICAgIH0pOwogICAgICB0aGlzLnJhZGl1cyA9IHJhZGl1cyAhPT0gdW5kZWZpbmVkID8gcmFkaXVzIDogMS4wOwoKICAgICAgaWYgKHRoaXMucmFkaXVzIDwgMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIHNwaGVyZSByYWRpdXMgY2Fubm90IGJlIG5lZ2F0aXZlLicpOwogICAgICB9CgogICAgICB0aGlzLnVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCk7CiAgICB9CiAgICAvKiogY2FsY3VsYXRlTG9jYWxJbmVydGlhICovCgoKICAgIGNhbGN1bGF0ZUxvY2FsSW5lcnRpYShtYXNzLCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgY29uc3QgSSA9IDIuMCAqIG1hc3MgKiB0aGlzLnJhZGl1cyAqIHRoaXMucmFkaXVzIC8gNS4wOwogICAgICB0YXJnZXQueCA9IEk7CiAgICAgIHRhcmdldC55ID0gSTsKICAgICAgdGFyZ2V0LnogPSBJOwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqIHZvbHVtZSAqLwoKCiAgICB2b2x1bWUoKSB7CiAgICAgIHJldHVybiA0LjAgKiBNYXRoLlBJICogTWF0aC5wb3codGhpcy5yYWRpdXMsIDMpIC8gMy4wOwogICAgfQoKICAgIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCkgewogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlUmFkaXVzID0gdGhpcy5yYWRpdXM7CiAgICB9CgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgY29uc3QgciA9IHRoaXMucmFkaXVzOwogICAgICBjb25zdCBheGVzID0gWyd4JywgJ3knLCAneiddOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBheGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgYXggPSBheGVzW2ldOwogICAgICAgIG1pbltheF0gPSBwb3NbYXhdIC0gcjsKICAgICAgICBtYXhbYXhdID0gcG9zW2F4XSArIHI7CiAgICAgIH0KICAgIH0KCiAgfQogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOyAvLyBUZW1wIHZlY3RvcnMgZm9yIGNhbGN1bGF0aW9uCgogIG5ldyBWZWMzKCk7IC8vIFJlbGF0aXZlIHZlbG9jaXR5CgogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogQ3lsaW5kZXIgY2xhc3MuCiAgICogQGV4YW1wbGUKICAgKiAgICAgY29uc3QgcmFkaXVzVG9wID0gMC41CiAgICogICAgIGNvbnN0IHJhZGl1c0JvdHRvbSA9IDAuNQogICAqICAgICBjb25zdCBoZWlnaHQgPSAyCiAgICogICAgIGNvbnN0IG51bVNlZ21lbnRzID0gMTIKICAgKiAgICAgY29uc3QgY3lsaW5kZXJTaGFwZSA9IG5ldyBDQU5OT04uQ3lsaW5kZXIocmFkaXVzVG9wLCByYWRpdXNCb3R0b20sIGhlaWdodCwgbnVtU2VnbWVudHMpCiAgICogICAgIGNvbnN0IGN5bGluZGVyQm9keSA9IG5ldyBDQU5OT04uQm9keSh7IG1hc3M6IDEsIHNoYXBlOiBjeWxpbmRlclNoYXBlIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkoY3lsaW5kZXJCb2R5KQogICAqLwoKICBjbGFzcyBDeWxpbmRlciBleHRlbmRzIENvbnZleFBvbHloZWRyb24gewogICAgLyoqIFRoZSByYWRpdXMgb2YgdGhlIHRvcCBvZiB0aGUgQ3lsaW5kZXIuICovCgogICAgLyoqIFRoZSByYWRpdXMgb2YgdGhlIGJvdHRvbSBvZiB0aGUgQ3lsaW5kZXIuICovCgogICAgLyoqIFRoZSBoZWlnaHQgb2YgdGhlIEN5bGluZGVyLiAqLwoKICAgIC8qKiBUaGUgbnVtYmVyIG9mIHNlZ21lbnRzIHRvIGJ1aWxkIHRoZSBjeWxpbmRlciBvdXQgb2YuICovCgogICAgLyoqCiAgICAgKiBAcGFyYW0gcmFkaXVzVG9wIFRoZSByYWRpdXMgb2YgdGhlIHRvcCBvZiB0aGUgQ3lsaW5kZXIuCiAgICAgKiBAcGFyYW0gcmFkaXVzQm90dG9tIFRoZSByYWRpdXMgb2YgdGhlIGJvdHRvbSBvZiB0aGUgQ3lsaW5kZXIuCiAgICAgKiBAcGFyYW0gaGVpZ2h0IFRoZSBoZWlnaHQgb2YgdGhlIEN5bGluZGVyLgogICAgICogQHBhcmFtIG51bVNlZ21lbnRzIFRoZSBudW1iZXIgb2Ygc2VnbWVudHMgdG8gYnVpbGQgdGhlIGN5bGluZGVyIG91dCBvZi4KICAgICAqLwogICAgY29uc3RydWN0b3IocmFkaXVzVG9wLCByYWRpdXNCb3R0b20sIGhlaWdodCwgbnVtU2VnbWVudHMpIHsKICAgICAgaWYgKHJhZGl1c1RvcCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmFkaXVzVG9wID0gMTsKICAgICAgfQoKICAgICAgaWYgKHJhZGl1c0JvdHRvbSA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmFkaXVzQm90dG9tID0gMTsKICAgICAgfQoKICAgICAgaWYgKGhlaWdodCA9PT0gdm9pZCAwKSB7CiAgICAgICAgaGVpZ2h0ID0gMTsKICAgICAgfQoKICAgICAgaWYgKG51bVNlZ21lbnRzID09PSB2b2lkIDApIHsKICAgICAgICBudW1TZWdtZW50cyA9IDg7CiAgICAgIH0KCiAgICAgIGlmIChyYWRpdXNUb3AgPCAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgY3lsaW5kZXIgcmFkaXVzVG9wIGNhbm5vdCBiZSBuZWdhdGl2ZS4nKTsKICAgICAgfQoKICAgICAgaWYgKHJhZGl1c0JvdHRvbSA8IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBjeWxpbmRlciByYWRpdXNCb3R0b20gY2Fubm90IGJlIG5lZ2F0aXZlLicpOwogICAgICB9CgogICAgICBjb25zdCBOID0gbnVtU2VnbWVudHM7CiAgICAgIGNvbnN0IHZlcnRpY2VzID0gW107CiAgICAgIGNvbnN0IGF4ZXMgPSBbXTsKICAgICAgY29uc3QgZmFjZXMgPSBbXTsKICAgICAgY29uc3QgYm90dG9tZmFjZSA9IFtdOwogICAgICBjb25zdCB0b3BmYWNlID0gW107CiAgICAgIGNvbnN0IGNvcyA9IE1hdGguY29zOwogICAgICBjb25zdCBzaW4gPSBNYXRoLnNpbjsgLy8gRmlyc3QgYm90dG9tIHBvaW50CgogICAgICB2ZXJ0aWNlcy5wdXNoKG5ldyBWZWMzKC1yYWRpdXNCb3R0b20gKiBzaW4oMCksIC1oZWlnaHQgKiAwLjUsIHJhZGl1c0JvdHRvbSAqIGNvcygwKSkpOwogICAgICBib3R0b21mYWNlLnB1c2goMCk7IC8vIEZpcnN0IHRvcCBwb2ludAoKICAgICAgdmVydGljZXMucHVzaChuZXcgVmVjMygtcmFkaXVzVG9wICogc2luKDApLCBoZWlnaHQgKiAwLjUsIHJhZGl1c1RvcCAqIGNvcygwKSkpOwogICAgICB0b3BmYWNlLnB1c2goMSk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE47IGkrKykgewogICAgICAgIGNvbnN0IHRoZXRhID0gMiAqIE1hdGguUEkgLyBOICogKGkgKyAxKTsKICAgICAgICBjb25zdCB0aGV0YU4gPSAyICogTWF0aC5QSSAvIE4gKiAoaSArIDAuNSk7CgogICAgICAgIGlmIChpIDwgTiAtIDEpIHsKICAgICAgICAgIC8vIEJvdHRvbQogICAgICAgICAgdmVydGljZXMucHVzaChuZXcgVmVjMygtcmFkaXVzQm90dG9tICogc2luKHRoZXRhKSwgLWhlaWdodCAqIDAuNSwgcmFkaXVzQm90dG9tICogY29zKHRoZXRhKSkpOwogICAgICAgICAgYm90dG9tZmFjZS5wdXNoKDIgKiBpICsgMik7IC8vIFRvcAoKICAgICAgICAgIHZlcnRpY2VzLnB1c2gobmV3IFZlYzMoLXJhZGl1c1RvcCAqIHNpbih0aGV0YSksIGhlaWdodCAqIDAuNSwgcmFkaXVzVG9wICogY29zKHRoZXRhKSkpOwogICAgICAgICAgdG9wZmFjZS5wdXNoKDIgKiBpICsgMyk7IC8vIEZhY2UKCiAgICAgICAgICBmYWNlcy5wdXNoKFsyICogaSwgMiAqIGkgKyAxLCAyICogaSArIDMsIDIgKiBpICsgMl0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmYWNlcy5wdXNoKFsyICogaSwgMiAqIGkgKyAxLCAxLCAwXSk7IC8vIENvbm5lY3QKICAgICAgICB9IC8vIEF4aXM6IHdlIGNhbiBjdXQgb2ZmIGhhbGYgb2YgdGhlbSBpZiB3ZSBoYXZlIGV2ZW4gbnVtYmVyIG9mIHNlZ21lbnRzCgoKICAgICAgICBpZiAoTiAlIDIgPT09IDEgfHwgaSA8IE4gLyAyKSB7CiAgICAgICAgICBheGVzLnB1c2gobmV3IFZlYzMoLXNpbih0aGV0YU4pLCAwLCBjb3ModGhldGFOKSkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZmFjZXMucHVzaChib3R0b21mYWNlKTsKICAgICAgYXhlcy5wdXNoKG5ldyBWZWMzKDAsIDEsIDApKTsgLy8gUmVvcmRlciB0b3AgZmFjZQoKICAgICAgY29uc3QgdGVtcCA9IFtdOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b3BmYWNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGVtcC5wdXNoKHRvcGZhY2VbdG9wZmFjZS5sZW5ndGggLSBpIC0gMV0pOwogICAgICB9CgogICAgICBmYWNlcy5wdXNoKHRlbXApOwogICAgICBzdXBlcih7CiAgICAgICAgdmVydGljZXMsCiAgICAgICAgZmFjZXMsCiAgICAgICAgYXhlcwogICAgICB9KTsKICAgICAgdGhpcy50eXBlID0gU2hhcGUudHlwZXMuQ1lMSU5ERVI7CiAgICAgIHRoaXMucmFkaXVzVG9wID0gcmFkaXVzVG9wOwogICAgICB0aGlzLnJhZGl1c0JvdHRvbSA9IHJhZGl1c0JvdHRvbTsKICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIHRoaXMubnVtU2VnbWVudHMgPSBudW1TZWdtZW50czsKICAgIH0KCiAgfQoKICAvKioKICAgKiBQYXJ0aWNsZSBzaGFwZS4KICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCBwYXJ0aWNsZVNoYXBlID0gbmV3IENBTk5PTi5QYXJ0aWNsZSgpCiAgICogICAgIGNvbnN0IHBhcnRpY2xlQm9keSA9IG5ldyBDQU5OT04uQm9keSh7IG1hc3M6IDEsIHNoYXBlOiBwYXJ0aWNsZVNoYXBlIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkocGFydGljbGVCb2R5KQogICAqLwogIGNsYXNzIFBhcnRpY2xlIGV4dGVuZHMgU2hhcGUgewogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHN1cGVyKHsKICAgICAgICB0eXBlOiBTaGFwZS50eXBlcy5QQVJUSUNMRQogICAgICB9KTsKICAgIH0KICAgIC8qKgogICAgICogY2FsY3VsYXRlTG9jYWxJbmVydGlhCiAgICAgKi8KCgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0YXJnZXQuc2V0KDAsIDAsIDApOwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQoKICAgIHZvbHVtZSgpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgdXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKSB7CiAgICAgIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgPSAwOwogICAgfQoKICAgIGNhbGN1bGF0ZVdvcmxkQUFCQihwb3MsIHF1YXQsIG1pbiwgbWF4KSB7CiAgICAgIC8vIEdldCBlYWNoIGF4aXMgbWF4CiAgICAgIG1pbi5jb3B5KHBvcyk7CiAgICAgIG1heC5jb3B5KHBvcyk7CiAgICB9CgogIH0KCiAgLyoqCiAgICogQSBwbGFuZSwgZmFjaW5nIGluIHRoZSBaIGRpcmVjdGlvbi4gVGhlIHBsYW5lIGhhcyBpdHMgc3VyZmFjZSBhdCB6PTAgYW5kIGV2ZXJ5dGhpbmcgYmVsb3cgej0wIGlzIGFzc3VtZWQgdG8gYmUgc29saWQgcGxhbmUuIFRvIG1ha2UgdGhlIHBsYW5lIGZhY2UgaW4gc29tZSBvdGhlciBkaXJlY3Rpb24gdGhhbiB6LCB5b3UgbXVzdCBwdXQgaXQgaW5zaWRlIGEgQm9keSBhbmQgcm90YXRlIHRoYXQgYm9keS4gU2VlIHRoZSBkZW1vcy4KICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCBwbGFuZVNoYXBlID0gbmV3IENBTk5PTi5QbGFuZSgpCiAgICogICAgIGNvbnN0IHBsYW5lQm9keSA9IG5ldyBDQU5OT04uQm9keSh7IG1hc3M6IDAsIHNoYXBlOiAgcGxhbmVTaGFwZSB9KQogICAqICAgICBwbGFuZUJvZHkucXVhdGVybmlvbi5zZXRGcm9tRXVsZXIoLU1hdGguUEkgLyAyLCAwLCAwKSAvLyBtYWtlIGl0IGZhY2UgdXAKICAgKiAgICAgd29ybGQuYWRkQm9keShwbGFuZUJvZHkpCiAgICovCiAgY2xhc3MgUGxhbmUgZXh0ZW5kcyBTaGFwZSB7CiAgICAvKiogd29ybGROb3JtYWwgKi8KCiAgICAvKiogd29ybGROb3JtYWxOZWVkc1VwZGF0ZSAqLwogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHN1cGVyKHsKICAgICAgICB0eXBlOiBTaGFwZS50eXBlcy5QTEFORQogICAgICB9KTsgLy8gV29ybGQgb3JpZW50ZWQgbm9ybWFsCgogICAgICB0aGlzLndvcmxkTm9ybWFsID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy53b3JsZE5vcm1hbE5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyA9IE51bWJlci5NQVhfVkFMVUU7CiAgICB9CiAgICAvKiogY29tcHV0ZVdvcmxkTm9ybWFsICovCgoKICAgIGNvbXB1dGVXb3JsZE5vcm1hbChxdWF0KSB7CiAgICAgIGNvbnN0IG4gPSB0aGlzLndvcmxkTm9ybWFsOwogICAgICBuLnNldCgwLCAwLCAxKTsKICAgICAgcXVhdC52bXVsdChuLCBuKTsKICAgICAgdGhpcy53b3JsZE5vcm1hbE5lZWRzVXBkYXRlID0gZmFsc2U7CiAgICB9CgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQoKICAgIHZvbHVtZSgpIHsKICAgICAgcmV0dXJuICgvLyBUaGUgcGxhbmUgaXMgaW5maW5pdGUuLi4KICAgICAgICBOdW1iZXIuTUFYX1ZBTFVFCiAgICAgICk7CiAgICB9CgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgLy8gVGhlIHBsYW5lIEFBQkIgaXMgaW5maW5pdGUsIGV4Y2VwdCBpZiB0aGUgbm9ybWFsIGlzIHBvaW50aW5nIGFsb25nIGFueSBheGlzCiAgICAgIHRlbXBOb3JtYWwuc2V0KDAsIDAsIDEpOyAvLyBEZWZhdWx0IHBsYW5lIG5vcm1hbCBpcyB6CgogICAgICBxdWF0LnZtdWx0KHRlbXBOb3JtYWwsIHRlbXBOb3JtYWwpOwogICAgICBjb25zdCBtYXhWYWwgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICBtaW4uc2V0KC1tYXhWYWwsIC1tYXhWYWwsIC1tYXhWYWwpOwogICAgICBtYXguc2V0KG1heFZhbCwgbWF4VmFsLCBtYXhWYWwpOwoKICAgICAgaWYgKHRlbXBOb3JtYWwueCA9PT0gMSkgewogICAgICAgIG1heC54ID0gcG9zLng7CiAgICAgIH0gZWxzZSBpZiAodGVtcE5vcm1hbC54ID09PSAtMSkgewogICAgICAgIG1pbi54ID0gcG9zLng7CiAgICAgIH0KCiAgICAgIGlmICh0ZW1wTm9ybWFsLnkgPT09IDEpIHsKICAgICAgICBtYXgueSA9IHBvcy55OwogICAgICB9IGVsc2UgaWYgKHRlbXBOb3JtYWwueSA9PT0gLTEpIHsKICAgICAgICBtaW4ueSA9IHBvcy55OwogICAgICB9CgogICAgICBpZiAodGVtcE5vcm1hbC56ID09PSAxKSB7CiAgICAgICAgbWF4LnogPSBwb3MuejsKICAgICAgfSBlbHNlIGlmICh0ZW1wTm9ybWFsLnogPT09IC0xKSB7CiAgICAgICAgbWluLnogPSBwb3MuejsKICAgICAgfQogICAgfQoKICAgIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCkgewogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlUmFkaXVzID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgIH0KCiAgfQogIGNvbnN0IHRlbXBOb3JtYWwgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBIZWlnaHRmaWVsZCBzaGFwZSBjbGFzcy4gSGVpZ2h0IGRhdGEgaXMgZ2l2ZW4gYXMgYW4gYXJyYXkuIFRoZXNlIGRhdGEgcG9pbnRzIGFyZSBzcHJlYWQgb3V0IGV2ZW5seSB3aXRoIGEgZ2l2ZW4gZGlzdGFuY2UuCiAgICogQHRvZG8gU2hvdWxkIGJlIHBvc3NpYmxlIHRvIHVzZSBhbG9uZyBhbGwgYXhlcywgbm90IGp1c3QgeQogICAqIEB0b2RvIHNob3VsZCBiZSBwb3NzaWJsZSB0byBzY2FsZSBhbG9uZyBhbGwgYXhlcwogICAqIEB0b2RvIFJlZmFjdG9yIGVsZW1lbnRTaXplIHRvIGVsZW1lbnRTaXplWCBhbmQgZWxlbWVudFNpemVZCiAgICoKICAgKiBAZXhhbXBsZQogICAqICAgICAvLyBHZW5lcmF0ZSBzb21lIGhlaWdodCBkYXRhICh5LXZhbHVlcykuCiAgICogICAgIGNvbnN0IGRhdGEgPSBbXQogICAqICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwMDA7IGkrKykgewogICAqICAgICAgICAgY29uc3QgeSA9IDAuNSAqIE1hdGguY29zKDAuMiAqIGkpCiAgICogICAgICAgICBkYXRhLnB1c2goeSkKICAgKiAgICAgfQogICAqCiAgICogICAgIC8vIENyZWF0ZSB0aGUgaGVpZ2h0ZmllbGQgc2hhcGUKICAgKiAgICAgY29uc3QgaGVpZ2h0ZmllbGRTaGFwZSA9IG5ldyBDQU5OT04uSGVpZ2h0ZmllbGQoZGF0YSwgewogICAqICAgICAgICAgZWxlbWVudFNpemU6IDEgLy8gRGlzdGFuY2UgYmV0d2VlbiB0aGUgZGF0YSBwb2ludHMgaW4gWCBhbmQgWSBkaXJlY3Rpb25zCiAgICogICAgIH0pCiAgICogICAgIGNvbnN0IGhlaWdodGZpZWxkQm9keSA9IG5ldyBDQU5OT04uQm9keSh7IHNoYXBlOiBoZWlnaHRmaWVsZFNoYXBlIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkoaGVpZ2h0ZmllbGRCb2R5KQogICAqLwogIGNsYXNzIEhlaWdodGZpZWxkIGV4dGVuZHMgU2hhcGUgewogICAgLyoqCiAgICAgKiBBbiBhcnJheSBvZiBudW1iZXJzLCBvciBoZWlnaHQgdmFsdWVzLCB0aGF0IGFyZSBzcHJlYWQgb3V0IGFsb25nIHRoZSB4IGF4aXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIE1heCB2YWx1ZSBvZiB0aGUgZGF0YSBwb2ludHMgaW4gdGhlIGRhdGEgYXJyYXkuCiAgICAgKi8KCiAgICAvKioKICAgICAqIE1pbmltdW0gdmFsdWUgb2YgdGhlIGRhdGEgcG9pbnRzIGluIHRoZSBkYXRhIGFycmF5LgogICAgICovCgogICAgLyoqCiAgICAgKiBXb3JsZCBzcGFjaW5nIGJldHdlZW4gdGhlIGRhdGEgcG9pbnRzIGluIFggYW5kIFkgZGlyZWN0aW9uLgogICAgICogQHRvZG8gZWxlbWVudFNpemVYIGFuZCBZCiAgICAgKiBAZGVmYXVsdCAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBkZWZhdWx0IHRydWUKICAgICAqLwoKICAgIC8qKgogICAgICogQHBhcmFtIGRhdGEgQW4gYXJyYXkgb2YgbnVtYmVycywgb3IgaGVpZ2h0IHZhbHVlcywgdGhhdCBhcmUgc3ByZWFkIG91dCBhbG9uZyB0aGUgeCBheGlzLgogICAgICovCiAgICBjb25zdHJ1Y3RvcihkYXRhLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBVdGlscy5kZWZhdWx0cyhvcHRpb25zLCB7CiAgICAgICAgbWF4VmFsdWU6IG51bGwsCiAgICAgICAgbWluVmFsdWU6IG51bGwsCiAgICAgICAgZWxlbWVudFNpemU6IDEKICAgICAgfSk7CiAgICAgIHN1cGVyKHsKICAgICAgICB0eXBlOiBTaGFwZS50eXBlcy5IRUlHSFRGSUVMRAogICAgICB9KTsKICAgICAgdGhpcy5kYXRhID0gZGF0YTsKICAgICAgdGhpcy5tYXhWYWx1ZSA9IG9wdGlvbnMubWF4VmFsdWU7CiAgICAgIHRoaXMubWluVmFsdWUgPSBvcHRpb25zLm1pblZhbHVlOwogICAgICB0aGlzLmVsZW1lbnRTaXplID0gb3B0aW9ucy5lbGVtZW50U2l6ZTsKCiAgICAgIGlmIChvcHRpb25zLm1pblZhbHVlID09PSBudWxsKSB7CiAgICAgICAgdGhpcy51cGRhdGVNaW5WYWx1ZSgpOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5tYXhWYWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHRoaXMudXBkYXRlTWF4VmFsdWUoKTsKICAgICAgfQoKICAgICAgdGhpcy5jYWNoZUVuYWJsZWQgPSB0cnVlOwogICAgICB0aGlzLnBpbGxhckNvbnZleCA9IG5ldyBDb252ZXhQb2x5aGVkcm9uKCk7CiAgICAgIHRoaXMucGlsbGFyT2Zmc2V0ID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy51cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpOyAvLyAiaV9qX2lzVXBwZXIiID0+IHsgY29udmV4OiAuLi4sIG9mZnNldDogLi4uIH0KICAgICAgLy8gZm9yIGV4YW1wbGU6CiAgICAgIC8vIF9jYWNoZWRQaWxsYXJzWyIwXzJfMSJdCgogICAgICB0aGlzLl9jYWNoZWRQaWxsYXJzID0ge307CiAgICB9CiAgICAvKioKICAgICAqIENhbGwgd2hlbmV2ZXIgeW91IGNoYW5nZSB0aGUgZGF0YSBhcnJheS4KICAgICAqLwoKCiAgICB1cGRhdGUoKSB7CiAgICAgIHRoaXMuX2NhY2hlZFBpbGxhcnMgPSB7fTsKICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlIHRoZSBgbWluVmFsdWVgIHByb3BlcnR5CiAgICAgKi8KCgogICAgdXBkYXRlTWluVmFsdWUoKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGxldCBtaW5WYWx1ZSA9IGRhdGFbMF1bMF07CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSBkYXRhW2ldLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCB2ID0gZGF0YVtpXVtqXTsKCiAgICAgICAgICBpZiAodiA8IG1pblZhbHVlKSB7CiAgICAgICAgICAgIG1pblZhbHVlID0gdjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMubWluVmFsdWUgPSBtaW5WYWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlIHRoZSBgbWF4VmFsdWVgIHByb3BlcnR5CiAgICAgKi8KCgogICAgdXBkYXRlTWF4VmFsdWUoKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGxldCBtYXhWYWx1ZSA9IGRhdGFbMF1bMF07CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSBkYXRhW2ldLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCB2ID0gZGF0YVtpXVtqXTsKCiAgICAgICAgICBpZiAodiA+IG1heFZhbHVlKSB7CiAgICAgICAgICAgIG1heFZhbHVlID0gdjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMubWF4VmFsdWUgPSBtYXhWYWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBoZWlnaHQgdmFsdWUgYXQgYW4gaW5kZXguIERvbid0IGZvcmdldCB0byB1cGRhdGUgbWF4VmFsdWUgYW5kIG1pblZhbHVlIGFmdGVyIHlvdSdyZSBkb25lLgogICAgICovCgoKICAgIHNldEhlaWdodFZhbHVlQXRJbmRleCh4aSwgeWksIHZhbHVlKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGRhdGFbeGldW3lpXSA9IHZhbHVlOyAvLyBJbnZhbGlkYXRlIGNhY2hlCgogICAgICB0aGlzLmNsZWFyQ2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGksIHlpLCBmYWxzZSk7CgogICAgICBpZiAoeGkgPiAwKSB7CiAgICAgICAgdGhpcy5jbGVhckNhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpIC0gMSwgeWksIHRydWUpOwogICAgICAgIHRoaXMuY2xlYXJDYWNoZWRDb252ZXhUcmlhbmdsZVBpbGxhcih4aSAtIDEsIHlpLCBmYWxzZSk7CiAgICAgIH0KCiAgICAgIGlmICh5aSA+IDApIHsKICAgICAgICB0aGlzLmNsZWFyQ2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGksIHlpIC0gMSwgdHJ1ZSk7CiAgICAgICAgdGhpcy5jbGVhckNhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpLCB5aSAtIDEsIGZhbHNlKTsKICAgICAgfQoKICAgICAgaWYgKHlpID4gMCAmJiB4aSA+IDApIHsKICAgICAgICB0aGlzLmNsZWFyQ2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGkgLSAxLCB5aSAtIDEsIHRydWUpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCBtYXgvbWluIGluIGEgcmVjdGFuZ2xlIGluIHRoZSBtYXRyaXggZGF0YQogICAgICogQHBhcmFtIHJlc3VsdCBBbiBhcnJheSB0byBzdG9yZSB0aGUgcmVzdWx0cyBpbi4KICAgICAqIEByZXR1cm4gVGhlIHJlc3VsdCBhcnJheSwgaWYgaXQgd2FzIHBhc3NlZCBpbi4gTWluaW11bSB3aWxsIGJlIGF0IHBvc2l0aW9uIDAgYW5kIG1heCBhdCAxLgogICAgICovCgoKICAgIGdldFJlY3RNaW5NYXgoaU1pblgsIGlNaW5ZLCBpTWF4WCwgaU1heFksIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgfQoKICAgICAgLy8gR2V0IG1heCBhbmQgbWluIG9mIHRoZSBkYXRhCiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7IC8vIFNldCBmaXJzdCB2YWx1ZQoKICAgICAgbGV0IG1heCA9IHRoaXMubWluVmFsdWU7CgogICAgICBmb3IgKGxldCBpID0gaU1pblg7IGkgPD0gaU1heFg7IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSBpTWluWTsgaiA8PSBpTWF4WTsgaisrKSB7CiAgICAgICAgICBjb25zdCBoZWlnaHQgPSBkYXRhW2ldW2pdOwoKICAgICAgICAgIGlmIChoZWlnaHQgPiBtYXgpIHsKICAgICAgICAgICAgbWF4ID0gaGVpZ2h0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmVzdWx0WzBdID0gdGhpcy5taW5WYWx1ZTsKICAgICAgcmVzdWx0WzFdID0gbWF4OwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIGluZGV4IG9mIGEgbG9jYWwgcG9zaXRpb24gb24gdGhlIGhlaWdodGZpZWxkLiBUaGUgaW5kZXhlcyBpbmRpY2F0ZSB0aGUgcmVjdGFuZ2xlcywgc28gaWYgeW91ciB0ZXJyYWluIGlzIG1hZGUgb2YgTiB4IE4gaGVpZ2h0IGRhdGEgcG9pbnRzLCB5b3Ugd2lsbCBoYXZlIHJlY3RhbmdsZSBpbmRleGVzIHJhbmdpbmcgZnJvbSAwIHRvIE4tMS4KICAgICAqIEBwYXJhbSByZXN1bHQgVHdvLWVsZW1lbnQgYXJyYXkKICAgICAqIEBwYXJhbSBjbGFtcCBJZiB0aGUgcG9zaXRpb24gc2hvdWxkIGJlIGNsYW1wZWQgdG8gdGhlIGhlaWdodGZpZWxkIGVkZ2UuCiAgICAgKi8KCgogICAgZ2V0SW5kZXhPZlBvc2l0aW9uKHgsIHksIHJlc3VsdCwgY2xhbXApIHsKICAgICAgLy8gR2V0IHRoZSBpbmRleCBvZiB0aGUgZGF0YSBwb2ludHMgdG8gdGVzdCBhZ2FpbnN0CiAgICAgIGNvbnN0IHcgPSB0aGlzLmVsZW1lbnRTaXplOwogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgICBsZXQgeGkgPSBNYXRoLmZsb29yKHggLyB3KTsKICAgICAgbGV0IHlpID0gTWF0aC5mbG9vcih5IC8gdyk7CiAgICAgIHJlc3VsdFswXSA9IHhpOwogICAgICByZXN1bHRbMV0gPSB5aTsKCiAgICAgIGlmIChjbGFtcCkgewogICAgICAgIC8vIENsYW1wIGluZGV4IHRvIGVkZ2VzCiAgICAgICAgaWYgKHhpIDwgMCkgewogICAgICAgICAgeGkgPSAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKHlpIDwgMCkgewogICAgICAgICAgeWkgPSAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKHhpID49IGRhdGEubGVuZ3RoIC0gMSkgewogICAgICAgICAgeGkgPSBkYXRhLmxlbmd0aCAtIDE7CiAgICAgICAgfQoKICAgICAgICBpZiAoeWkgPj0gZGF0YVswXS5sZW5ndGggLSAxKSB7CiAgICAgICAgICB5aSA9IGRhdGFbMF0ubGVuZ3RoIC0gMTsKICAgICAgICB9CiAgICAgIH0gLy8gQmFpbCBvdXQgaWYgd2UgYXJlIG91dCBvZiB0aGUgdGVycmFpbgoKCiAgICAgIGlmICh4aSA8IDAgfHwgeWkgPCAwIHx8IHhpID49IGRhdGEubGVuZ3RoIC0gMSB8fCB5aSA+PSBkYXRhWzBdLmxlbmd0aCAtIDEpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGdldFRyaWFuZ2xlQXQoeCwgeSwgZWRnZUNsYW1wLCBhLCBiLCBjKSB7CiAgICAgIGNvbnN0IGlkeCA9IGdldEhlaWdodEF0X2lkeDsKICAgICAgdGhpcy5nZXRJbmRleE9mUG9zaXRpb24oeCwgeSwgaWR4LCBlZGdlQ2xhbXApOwogICAgICBsZXQgeGkgPSBpZHhbMF07CiAgICAgIGxldCB5aSA9IGlkeFsxXTsKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTsKCiAgICAgIGlmIChlZGdlQ2xhbXApIHsKICAgICAgICB4aSA9IE1hdGgubWluKGRhdGEubGVuZ3RoIC0gMiwgTWF0aC5tYXgoMCwgeGkpKTsKICAgICAgICB5aSA9IE1hdGgubWluKGRhdGFbMF0ubGVuZ3RoIC0gMiwgTWF0aC5tYXgoMCwgeWkpKTsKICAgICAgfQoKICAgICAgY29uc3QgZWxlbWVudFNpemUgPSB0aGlzLmVsZW1lbnRTaXplOwogICAgICBjb25zdCBsb3dlckRpc3QyID0gKHggLyBlbGVtZW50U2l6ZSAtIHhpKSAqKiAyICsgKHkgLyBlbGVtZW50U2l6ZSAtIHlpKSAqKiAyOwogICAgICBjb25zdCB1cHBlckRpc3QyID0gKHggLyBlbGVtZW50U2l6ZSAtICh4aSArIDEpKSAqKiAyICsgKHkgLyBlbGVtZW50U2l6ZSAtICh5aSArIDEpKSAqKiAyOwogICAgICBjb25zdCB1cHBlciA9IGxvd2VyRGlzdDIgPiB1cHBlckRpc3QyOwogICAgICB0aGlzLmdldFRyaWFuZ2xlKHhpLCB5aSwgdXBwZXIsIGEsIGIsIGMpOwogICAgICByZXR1cm4gdXBwZXI7CiAgICB9CgogICAgZ2V0Tm9ybWFsQXQoeCwgeSwgZWRnZUNsYW1wLCByZXN1bHQpIHsKICAgICAgY29uc3QgYSA9IGdldE5vcm1hbEF0X2E7CiAgICAgIGNvbnN0IGIgPSBnZXROb3JtYWxBdF9iOwogICAgICBjb25zdCBjID0gZ2V0Tm9ybWFsQXRfYzsKICAgICAgY29uc3QgZTAgPSBnZXROb3JtYWxBdF9lMDsKICAgICAgY29uc3QgZTEgPSBnZXROb3JtYWxBdF9lMTsKICAgICAgdGhpcy5nZXRUcmlhbmdsZUF0KHgsIHksIGVkZ2VDbGFtcCwgYSwgYiwgYyk7CiAgICAgIGIudnN1YihhLCBlMCk7CiAgICAgIGMudnN1YihhLCBlMSk7CiAgICAgIGUwLmNyb3NzKGUxLCByZXN1bHQpOwogICAgICByZXN1bHQubm9ybWFsaXplKCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbiBBQUJCIG9mIGEgc3F1YXJlIGluIHRoZSBoZWlnaHRmaWVsZAogICAgICogQHBhcmFtIHhpCiAgICAgKiBAcGFyYW0geWkKICAgICAqIEBwYXJhbSByZXN1bHQKICAgICAqLwoKCiAgICBnZXRBYWJiQXRJbmRleCh4aSwgeWksIF9yZWYpIHsKICAgICAgbGV0IHsKICAgICAgICBsb3dlckJvdW5kLAogICAgICAgIHVwcGVyQm91bmQKICAgICAgfSA9IF9yZWY7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGNvbnN0IGVsZW1lbnRTaXplID0gdGhpcy5lbGVtZW50U2l6ZTsKICAgICAgbG93ZXJCb3VuZC5zZXQoeGkgKiBlbGVtZW50U2l6ZSwgeWkgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aV1beWldKTsKICAgICAgdXBwZXJCb3VuZC5zZXQoKHhpICsgMSkgKiBlbGVtZW50U2l6ZSwgKHlpICsgMSkgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aSArIDFdW3lpICsgMV0pOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIGhlaWdodCBpbiB0aGUgaGVpZ2h0ZmllbGQgYXQgYSBnaXZlbiBwb3NpdGlvbgogICAgICovCgoKICAgIGdldEhlaWdodEF0KHgsIHksIGVkZ2VDbGFtcCkgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgICBjb25zdCBhID0gZ2V0SGVpZ2h0QXRfYTsKICAgICAgY29uc3QgYiA9IGdldEhlaWdodEF0X2I7CiAgICAgIGNvbnN0IGMgPSBnZXRIZWlnaHRBdF9jOwogICAgICBjb25zdCBpZHggPSBnZXRIZWlnaHRBdF9pZHg7CiAgICAgIHRoaXMuZ2V0SW5kZXhPZlBvc2l0aW9uKHgsIHksIGlkeCwgZWRnZUNsYW1wKTsKICAgICAgbGV0IHhpID0gaWR4WzBdOwogICAgICBsZXQgeWkgPSBpZHhbMV07CgogICAgICBpZiAoZWRnZUNsYW1wKSB7CiAgICAgICAgeGkgPSBNYXRoLm1pbihkYXRhLmxlbmd0aCAtIDIsIE1hdGgubWF4KDAsIHhpKSk7CiAgICAgICAgeWkgPSBNYXRoLm1pbihkYXRhWzBdLmxlbmd0aCAtIDIsIE1hdGgubWF4KDAsIHlpKSk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHVwcGVyID0gdGhpcy5nZXRUcmlhbmdsZUF0KHgsIHksIGVkZ2VDbGFtcCwgYSwgYiwgYyk7CiAgICAgIGJhcnljZW50cmljV2VpZ2h0cyh4LCB5LCBhLngsIGEueSwgYi54LCBiLnksIGMueCwgYy55LCBnZXRIZWlnaHRBdF93ZWlnaHRzKTsKICAgICAgY29uc3QgdyA9IGdldEhlaWdodEF0X3dlaWdodHM7CgogICAgICBpZiAodXBwZXIpIHsKICAgICAgICAvLyBUb3AgdHJpYW5nbGUgdmVydHMKICAgICAgICByZXR1cm4gZGF0YVt4aSArIDFdW3lpICsgMV0gKiB3LnggKyBkYXRhW3hpXVt5aSArIDFdICogdy55ICsgZGF0YVt4aSArIDFdW3lpXSAqIHcuejsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBUb3AgdHJpYW5nbGUgdmVydHMKICAgICAgICByZXR1cm4gZGF0YVt4aV1beWldICogdy54ICsgZGF0YVt4aSArIDFdW3lpXSAqIHcueSArIGRhdGFbeGldW3lpICsgMV0gKiB3Lno7CiAgICAgIH0KICAgIH0KCiAgICBnZXRDYWNoZUNvbnZleFRyaWFuZ2xlUGlsbGFyS2V5KHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSkgewogICAgICByZXR1cm4gYCR7eGl9XyR7eWl9XyR7Z2V0VXBwZXJUcmlhbmdsZSA/IDEgOiAwfWA7CiAgICB9CgogICAgZ2V0Q2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGksIHlpLCBnZXRVcHBlclRyaWFuZ2xlKSB7CiAgICAgIHJldHVybiB0aGlzLl9jYWNoZWRQaWxsYXJzW3RoaXMuZ2V0Q2FjaGVDb252ZXhUcmlhbmdsZVBpbGxhcktleSh4aSwgeWksIGdldFVwcGVyVHJpYW5nbGUpXTsKICAgIH0KCiAgICBzZXRDYWNoZWRDb252ZXhUcmlhbmdsZVBpbGxhcih4aSwgeWksIGdldFVwcGVyVHJpYW5nbGUsIGNvbnZleCwgb2Zmc2V0KSB7CiAgICAgIHRoaXMuX2NhY2hlZFBpbGxhcnNbdGhpcy5nZXRDYWNoZUNvbnZleFRyaWFuZ2xlUGlsbGFyS2V5KHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSldID0gewogICAgICAgIGNvbnZleCwKICAgICAgICBvZmZzZXQKICAgICAgfTsKICAgIH0KCiAgICBjbGVhckNhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSkgewogICAgICBkZWxldGUgdGhpcy5fY2FjaGVkUGlsbGFyc1t0aGlzLmdldENhY2hlQ29udmV4VHJpYW5nbGVQaWxsYXJLZXkoeGksIHlpLCBnZXRVcHBlclRyaWFuZ2xlKV07CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhIHRyaWFuZ2xlIGZyb20gdGhlIGhlaWdodGZpZWxkCiAgICAgKi8KCgogICAgZ2V0VHJpYW5nbGUoeGksIHlpLCB1cHBlciwgYSwgYiwgYykgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgICBjb25zdCBlbGVtZW50U2l6ZSA9IHRoaXMuZWxlbWVudFNpemU7CgogICAgICBpZiAodXBwZXIpIHsKICAgICAgICAvLyBUb3AgdHJpYW5nbGUgdmVydHMKICAgICAgICBhLnNldCgoeGkgKyAxKSAqIGVsZW1lbnRTaXplLCAoeWkgKyAxKSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpICsgMV1beWkgKyAxXSk7CiAgICAgICAgYi5zZXQoeGkgKiBlbGVtZW50U2l6ZSwgKHlpICsgMSkgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aV1beWkgKyAxXSk7CiAgICAgICAgYy5zZXQoKHhpICsgMSkgKiBlbGVtZW50U2l6ZSwgeWkgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aSArIDFdW3lpXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVG9wIHRyaWFuZ2xlIHZlcnRzCiAgICAgICAgYS5zZXQoeGkgKiBlbGVtZW50U2l6ZSwgeWkgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aV1beWldKTsKICAgICAgICBiLnNldCgoeGkgKyAxKSAqIGVsZW1lbnRTaXplLCB5aSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpICsgMV1beWldKTsKICAgICAgICBjLnNldCh4aSAqIGVsZW1lbnRTaXplLCAoeWkgKyAxKSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpXVt5aSArIDFdKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBHZXQgYSB0cmlhbmdsZSBpbiB0aGUgdGVycmFpbiBpbiB0aGUgZm9ybSBvZiBhIHRyaWFuZ3VsYXIgY29udmV4IHNoYXBlLgogICAgICovCgoKICAgIGdldENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSkgewogICAgICBsZXQgcmVzdWx0ID0gdGhpcy5waWxsYXJDb252ZXg7CiAgICAgIGxldCBvZmZzZXRSZXN1bHQgPSB0aGlzLnBpbGxhck9mZnNldDsKCiAgICAgIGlmICh0aGlzLmNhY2hlRW5hYmxlZCkgewogICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmdldENhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSk7CgogICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICB0aGlzLnBpbGxhckNvbnZleCA9IGRhdGEuY29udmV4OwogICAgICAgICAgdGhpcy5waWxsYXJPZmZzZXQgPSBkYXRhLm9mZnNldDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHJlc3VsdCA9IG5ldyBDb252ZXhQb2x5aGVkcm9uKCk7CiAgICAgICAgb2Zmc2V0UmVzdWx0ID0gbmV3IFZlYzMoKTsKICAgICAgICB0aGlzLnBpbGxhckNvbnZleCA9IHJlc3VsdDsKICAgICAgICB0aGlzLnBpbGxhck9mZnNldCA9IG9mZnNldFJlc3VsdDsKICAgICAgfQoKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTsKICAgICAgY29uc3QgZWxlbWVudFNpemUgPSB0aGlzLmVsZW1lbnRTaXplOwogICAgICBjb25zdCBmYWNlcyA9IHJlc3VsdC5mYWNlczsgLy8gUmV1c2UgdmVydHMgaWYgcG9zc2libGUKCiAgICAgIHJlc3VsdC52ZXJ0aWNlcy5sZW5ndGggPSA2OwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpKyspIHsKICAgICAgICBpZiAoIXJlc3VsdC52ZXJ0aWNlc1tpXSkgewogICAgICAgICAgcmVzdWx0LnZlcnRpY2VzW2ldID0gbmV3IFZlYzMoKTsKICAgICAgICB9CiAgICAgIH0gLy8gUmV1c2UgZmFjZXMgaWYgcG9zc2libGUKCgogICAgICBmYWNlcy5sZW5ndGggPSA1OwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1OyBpKyspIHsKICAgICAgICBpZiAoIWZhY2VzW2ldKSB7CiAgICAgICAgICBmYWNlc1tpXSA9IFtdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgdmVydHMgPSByZXN1bHQudmVydGljZXM7CiAgICAgIGNvbnN0IGggPSAoTWF0aC5taW4oZGF0YVt4aV1beWldLCBkYXRhW3hpICsgMV1beWldLCBkYXRhW3hpXVt5aSArIDFdLCBkYXRhW3hpICsgMV1beWkgKyAxXSkgLSB0aGlzLm1pblZhbHVlKSAvIDIgKyB0aGlzLm1pblZhbHVlOwoKICAgICAgaWYgKCFnZXRVcHBlclRyaWFuZ2xlKSB7CiAgICAgICAgLy8gQ2VudGVyIG9mIHRoZSB0cmlhbmdsZSBwaWxsYXIgLSBhbGwgcG9seWdvbnMgYXJlIGdpdmVuIHJlbGF0aXZlIHRvIHRoaXMgb25lCiAgICAgICAgb2Zmc2V0UmVzdWx0LnNldCgoeGkgKyAwLjI1KSAqIGVsZW1lbnRTaXplLCAvLyBzb3J0IG9mIGNlbnRlciBvZiBhIHRyaWFuZ2xlCiAgICAgICAgKHlpICsgMC4yNSkgKiBlbGVtZW50U2l6ZSwgaCAvLyB2ZXJ0aWNhbCBjZW50ZXIKICAgICAgICApOyAvLyBUb3AgdHJpYW5nbGUgdmVydHMKCiAgICAgICAgdmVydHNbMF0uc2V0KC0wLjI1ICogZWxlbWVudFNpemUsIC0wLjI1ICogZWxlbWVudFNpemUsIGRhdGFbeGldW3lpXSAtIGgpOwogICAgICAgIHZlcnRzWzFdLnNldCgwLjc1ICogZWxlbWVudFNpemUsIC0wLjI1ICogZWxlbWVudFNpemUsIGRhdGFbeGkgKyAxXVt5aV0gLSBoKTsKICAgICAgICB2ZXJ0c1syXS5zZXQoLTAuMjUgKiBlbGVtZW50U2l6ZSwgMC43NSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpXVt5aSArIDFdIC0gaCk7IC8vIGJvdHRvbSB0cmlhbmdsZSB2ZXJ0cwoKICAgICAgICB2ZXJ0c1szXS5zZXQoLTAuMjUgKiBlbGVtZW50U2l6ZSwgLTAuMjUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7CiAgICAgICAgdmVydHNbNF0uc2V0KDAuNzUgKiBlbGVtZW50U2l6ZSwgLTAuMjUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7CiAgICAgICAgdmVydHNbNV0uc2V0KC0wLjI1ICogZWxlbWVudFNpemUsIDAuNzUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7IC8vIHRvcCB0cmlhbmdsZQoKICAgICAgICBmYWNlc1swXVswXSA9IDA7CiAgICAgICAgZmFjZXNbMF1bMV0gPSAxOwogICAgICAgIGZhY2VzWzBdWzJdID0gMjsgLy8gYm90dG9tIHRyaWFuZ2xlCgogICAgICAgIGZhY2VzWzFdWzBdID0gNTsKICAgICAgICBmYWNlc1sxXVsxXSA9IDQ7CiAgICAgICAgZmFjZXNbMV1bMl0gPSAzOyAvLyAteCBmYWNpbmcgcXVhZAoKICAgICAgICBmYWNlc1syXVswXSA9IDA7CiAgICAgICAgZmFjZXNbMl1bMV0gPSAyOwogICAgICAgIGZhY2VzWzJdWzJdID0gNTsKICAgICAgICBmYWNlc1syXVszXSA9IDM7IC8vIC15IGZhY2luZyBxdWFkCgogICAgICAgIGZhY2VzWzNdWzBdID0gMTsKICAgICAgICBmYWNlc1szXVsxXSA9IDA7CiAgICAgICAgZmFjZXNbM11bMl0gPSAzOwogICAgICAgIGZhY2VzWzNdWzNdID0gNDsgLy8gK3h5IGZhY2luZyBxdWFkCgogICAgICAgIGZhY2VzWzRdWzBdID0gNDsKICAgICAgICBmYWNlc1s0XVsxXSA9IDU7CiAgICAgICAgZmFjZXNbNF1bMl0gPSAyOwogICAgICAgIGZhY2VzWzRdWzNdID0gMTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBDZW50ZXIgb2YgdGhlIHRyaWFuZ2xlIHBpbGxhciAtIGFsbCBwb2x5Z29ucyBhcmUgZ2l2ZW4gcmVsYXRpdmUgdG8gdGhpcyBvbmUKICAgICAgICBvZmZzZXRSZXN1bHQuc2V0KCh4aSArIDAuNzUpICogZWxlbWVudFNpemUsIC8vIHNvcnQgb2YgY2VudGVyIG9mIGEgdHJpYW5nbGUKICAgICAgICAoeWkgKyAwLjc1KSAqIGVsZW1lbnRTaXplLCBoIC8vIHZlcnRpY2FsIGNlbnRlcgogICAgICAgICk7IC8vIFRvcCB0cmlhbmdsZSB2ZXJ0cwoKICAgICAgICB2ZXJ0c1swXS5zZXQoMC4yNSAqIGVsZW1lbnRTaXplLCAwLjI1ICogZWxlbWVudFNpemUsIGRhdGFbeGkgKyAxXVt5aSArIDFdIC0gaCk7CiAgICAgICAgdmVydHNbMV0uc2V0KC0wLjc1ICogZWxlbWVudFNpemUsIDAuMjUgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aV1beWkgKyAxXSAtIGgpOwogICAgICAgIHZlcnRzWzJdLnNldCgwLjI1ICogZWxlbWVudFNpemUsIC0wLjc1ICogZWxlbWVudFNpemUsIGRhdGFbeGkgKyAxXVt5aV0gLSBoKTsgLy8gYm90dG9tIHRyaWFuZ2xlIHZlcnRzCgogICAgICAgIHZlcnRzWzNdLnNldCgwLjI1ICogZWxlbWVudFNpemUsIDAuMjUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7CiAgICAgICAgdmVydHNbNF0uc2V0KC0wLjc1ICogZWxlbWVudFNpemUsIDAuMjUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7CiAgICAgICAgdmVydHNbNV0uc2V0KDAuMjUgKiBlbGVtZW50U2l6ZSwgLTAuNzUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7IC8vIFRvcCB0cmlhbmdsZQoKICAgICAgICBmYWNlc1swXVswXSA9IDA7CiAgICAgICAgZmFjZXNbMF1bMV0gPSAxOwogICAgICAgIGZhY2VzWzBdWzJdID0gMjsgLy8gYm90dG9tIHRyaWFuZ2xlCgogICAgICAgIGZhY2VzWzFdWzBdID0gNTsKICAgICAgICBmYWNlc1sxXVsxXSA9IDQ7CiAgICAgICAgZmFjZXNbMV1bMl0gPSAzOyAvLyAreCBmYWNpbmcgcXVhZAoKICAgICAgICBmYWNlc1syXVswXSA9IDI7CiAgICAgICAgZmFjZXNbMl1bMV0gPSA1OwogICAgICAgIGZhY2VzWzJdWzJdID0gMzsKICAgICAgICBmYWNlc1syXVszXSA9IDA7IC8vICt5IGZhY2luZyBxdWFkCgogICAgICAgIGZhY2VzWzNdWzBdID0gMzsKICAgICAgICBmYWNlc1szXVsxXSA9IDQ7CiAgICAgICAgZmFjZXNbM11bMl0gPSAxOwogICAgICAgIGZhY2VzWzNdWzNdID0gMDsgLy8gLXh5IGZhY2luZyBxdWFkCgogICAgICAgIGZhY2VzWzRdWzBdID0gMTsKICAgICAgICBmYWNlc1s0XVsxXSA9IDQ7CiAgICAgICAgZmFjZXNbNF1bMl0gPSA1OwogICAgICAgIGZhY2VzWzRdWzNdID0gMjsKICAgICAgfQoKICAgICAgcmVzdWx0LmNvbXB1dGVOb3JtYWxzKCk7CiAgICAgIHJlc3VsdC5jb21wdXRlRWRnZXMoKTsKICAgICAgcmVzdWx0LnVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCk7CiAgICAgIHRoaXMuc2V0Q2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGksIHlpLCBnZXRVcHBlclRyaWFuZ2xlLCByZXN1bHQsIG9mZnNldFJlc3VsdCk7CiAgICB9CgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0YXJnZXQuc2V0KDAsIDAsIDApOwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQoKICAgIHZvbHVtZSgpIHsKICAgICAgcmV0dXJuICgvLyBUaGUgdGVycmFpbiBpcyBpbmZpbml0ZQogICAgICAgIE51bWJlci5NQVhfVkFMVUUKICAgICAgKTsKICAgIH0KCiAgICBjYWxjdWxhdGVXb3JsZEFBQkIocG9zLCBxdWF0LCBtaW4sIG1heCkgewogICAgICAvKiogQFRPRE8gZG8gaXQgcHJvcGVybHkgKi8KICAgICAgbWluLnNldCgtTnVtYmVyLk1BWF9WQUxVRSwgLU51bWJlci5NQVhfVkFMVUUsIC1OdW1iZXIuTUFYX1ZBTFVFKTsKICAgICAgbWF4LnNldChOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFKTsKICAgIH0KCiAgICB1cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpIHsKICAgICAgLy8gVXNlIHRoZSBib3VuZGluZyBib3ggb2YgdGhlIG1pbi9tYXggdmFsdWVzCiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGNvbnN0IHMgPSB0aGlzLmVsZW1lbnRTaXplOwogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlUmFkaXVzID0gbmV3IFZlYzMoZGF0YS5sZW5ndGggKiBzLCBkYXRhWzBdLmxlbmd0aCAqIHMsIE1hdGgubWF4KE1hdGguYWJzKHRoaXMubWF4VmFsdWUpLCBNYXRoLmFicyh0aGlzLm1pblZhbHVlKSkpLmxlbmd0aCgpOwogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBoZWlnaHQgdmFsdWVzIGZyb20gYW4gaW1hZ2UuIEN1cnJlbnRseSBvbmx5IHN1cHBvcnRlZCBpbiBicm93c2VyLgogICAgICovCgoKICAgIHNldEhlaWdodHNGcm9tSW1hZ2UoaW1hZ2UsIHNjYWxlKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICB4LAogICAgICAgIHosCiAgICAgICAgeQogICAgICB9ID0gc2NhbGU7CiAgICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICBjYW52YXMud2lkdGggPSBpbWFnZS53aWR0aDsKICAgICAgY2FudmFzLmhlaWdodCA9IGltYWdlLmhlaWdodDsKICAgICAgY29uc3QgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwogICAgICBjb250ZXh0LmRyYXdJbWFnZShpbWFnZSwgMCwgMCk7CiAgICAgIGNvbnN0IGltYWdlRGF0YSA9IGNvbnRleHQuZ2V0SW1hZ2VEYXRhKDAsIDAsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQpOwogICAgICBjb25zdCBtYXRyaXggPSB0aGlzLmRhdGE7CiAgICAgIG1hdHJpeC5sZW5ndGggPSAwOwogICAgICB0aGlzLmVsZW1lbnRTaXplID0gTWF0aC5hYnMoeCkgLyBpbWFnZURhdGEud2lkdGg7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGltYWdlRGF0YS5oZWlnaHQ7IGkrKykgewogICAgICAgIGNvbnN0IHJvdyA9IFtdOwoKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGltYWdlRGF0YS53aWR0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBhID0gaW1hZ2VEYXRhLmRhdGFbKGkgKiBpbWFnZURhdGEuaGVpZ2h0ICsgaikgKiA0XTsKICAgICAgICAgIGNvbnN0IGIgPSBpbWFnZURhdGEuZGF0YVsoaSAqIGltYWdlRGF0YS5oZWlnaHQgKyBqKSAqIDQgKyAxXTsKICAgICAgICAgIGNvbnN0IGMgPSBpbWFnZURhdGEuZGF0YVsoaSAqIGltYWdlRGF0YS5oZWlnaHQgKyBqKSAqIDQgKyAyXTsKICAgICAgICAgIGNvbnN0IGhlaWdodCA9IChhICsgYiArIGMpIC8gNCAvIDI1NSAqIHo7CgogICAgICAgICAgaWYgKHggPCAwKSB7CiAgICAgICAgICAgIHJvdy5wdXNoKGhlaWdodCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb3cudW5zaGlmdChoZWlnaHQpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHkgPCAwKSB7CiAgICAgICAgICBtYXRyaXgudW5zaGlmdChyb3cpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtYXRyaXgucHVzaChyb3cpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy51cGRhdGVNYXhWYWx1ZSgpOwogICAgICB0aGlzLnVwZGF0ZU1pblZhbHVlKCk7CiAgICAgIHRoaXMudXBkYXRlKCk7CiAgICB9CgogIH0KICBjb25zdCBnZXRIZWlnaHRBdF9pZHggPSBbXTsKICBjb25zdCBnZXRIZWlnaHRBdF93ZWlnaHRzID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXRIZWlnaHRBdF9hID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXRIZWlnaHRBdF9iID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXRIZWlnaHRBdF9jID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9hID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9iID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9jID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9lMCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgZ2V0Tm9ybWFsQXRfZTEgPSBuZXcgVmVjMygpOyAvLyBmcm9tIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0JhcnljZW50cmljX2Nvb3JkaW5hdGVfc3lzdGVtCgogIGZ1bmN0aW9uIGJhcnljZW50cmljV2VpZ2h0cyh4LCB5LCBheCwgYXksIGJ4LCBieSwgY3gsIGN5LCByZXN1bHQpIHsKICAgIHJlc3VsdC54ID0gKChieSAtIGN5KSAqICh4IC0gY3gpICsgKGN4IC0gYngpICogKHkgLSBjeSkpIC8gKChieSAtIGN5KSAqIChheCAtIGN4KSArIChjeCAtIGJ4KSAqIChheSAtIGN5KSk7CiAgICByZXN1bHQueSA9ICgoY3kgLSBheSkgKiAoeCAtIGN4KSArIChheCAtIGN4KSAqICh5IC0gY3kpKSAvICgoYnkgLSBjeSkgKiAoYXggLSBjeCkgKyAoY3ggLSBieCkgKiAoYXkgLSBjeSkpOwogICAgcmVzdWx0LnogPSAxIC0gcmVzdWx0LnggLSByZXN1bHQueTsKICB9CgogIC8qKgogICAqIE9jdHJlZU5vZGUKICAgKi8KICBjbGFzcyBPY3RyZWVOb2RlIHsKICAgIC8qKiBUaGUgcm9vdCBub2RlICovCgogICAgLyoqIEJvdW5kYXJ5IG9mIHRoaXMgbm9kZSAqLwoKICAgIC8qKiBDb250YWluZWQgZGF0YSBhdCB0aGUgY3VycmVudCBub2RlIGxldmVsICovCgogICAgLyoqIENoaWxkcmVuIHRvIHRoaXMgbm9kZSAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLnJvb3QgPSBvcHRpb25zLnJvb3QgfHwgbnVsbDsKICAgICAgdGhpcy5hYWJiID0gb3B0aW9ucy5hYWJiID8gb3B0aW9ucy5hYWJiLmNsb25lKCkgOiBuZXcgQUFCQigpOwogICAgICB0aGlzLmRhdGEgPSBbXTsKICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgfQogICAgLyoqCiAgICAgKiByZXNldAogICAgICovCgoKICAgIHJlc2V0KCkgewogICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCA9IHRoaXMuZGF0YS5sZW5ndGggPSAwOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnQgZGF0YSBpbnRvIHRoaXMgbm9kZQogICAgICogQHJldHVybiBUcnVlIGlmIHN1Y2Nlc3NmdWwsIG90aGVyd2lzZSBmYWxzZQogICAgICovCgoKICAgIGluc2VydChhYWJiLCBlbGVtZW50RGF0YSwgbGV2ZWwpIHsKICAgICAgaWYgKGxldmVsID09PSB2b2lkIDApIHsKICAgICAgICBsZXZlbCA9IDA7CiAgICAgIH0KCiAgICAgIGNvbnN0IG5vZGVEYXRhID0gdGhpcy5kYXRhOyAvLyBJZ25vcmUgb2JqZWN0cyB0aGF0IGRvIG5vdCBiZWxvbmcgaW4gdGhpcyBub2RlCgogICAgICBpZiAoIXRoaXMuYWFiYi5jb250YWlucyhhYWJiKSkgewogICAgICAgIHJldHVybiBmYWxzZTsgLy8gb2JqZWN0IGNhbm5vdCBiZSBhZGRlZAogICAgICB9CgogICAgICBjb25zdCBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW47CiAgICAgIGNvbnN0IG1heERlcHRoID0gdGhpcy5tYXhEZXB0aCB8fCB0aGlzLnJvb3QubWF4RGVwdGg7CgogICAgICBpZiAobGV2ZWwgPCBtYXhEZXB0aCkgewogICAgICAgIC8vIFN1YmRpdmlkZSBpZiB0aGVyZSBhcmUgbm8gY2hpbGRyZW4geWV0CiAgICAgICAgbGV0IHN1YmRpdmlkZWQgPSBmYWxzZTsKCiAgICAgICAgaWYgKCFjaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMuc3ViZGl2aWRlKCk7CiAgICAgICAgICBzdWJkaXZpZGVkID0gdHJ1ZTsKICAgICAgICB9IC8vIGFkZCB0byB3aGljaGV2ZXIgbm9kZSB3aWxsIGFjY2VwdCBpdAoKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IDg7IGkrKykgewogICAgICAgICAgaWYgKGNoaWxkcmVuW2ldLmluc2VydChhYWJiLCBlbGVtZW50RGF0YSwgbGV2ZWwgKyAxKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChzdWJkaXZpZGVkKSB7CiAgICAgICAgICAvLyBObyBjaGlsZHJlbiBhY2NlcHRlZCEgTWlnaHQgYXMgd2VsbCBqdXN0IHJlbW92ZSBlbSBzaW5jZSB0aGV5IGNvbnRhaW4gbm9uZQogICAgICAgICAgY2hpbGRyZW4ubGVuZ3RoID0gMDsKICAgICAgICB9CiAgICAgIH0gLy8gVG9vIGRlZXAsIG9yIGNoaWxkcmVuIGRpZG50IHdhbnQgaXQuIGFkZCBpdCBpbiBjdXJyZW50IG5vZGUKCgogICAgICBub2RlRGF0YS5wdXNoKGVsZW1lbnREYXRhKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIENyZWF0ZSA4IGVxdWFsbHkgc2l6ZWQgY2hpbGRyZW4gbm9kZXMgYW5kIHB1dCB0aGVtIGluIHRoZSBgY2hpbGRyZW5gIGFycmF5LgogICAgICovCgoKICAgIHN1YmRpdmlkZSgpIHsKICAgICAgY29uc3QgYWFiYiA9IHRoaXMuYWFiYjsKICAgICAgY29uc3QgbCA9IGFhYmIubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdSA9IGFhYmIudXBwZXJCb3VuZDsKICAgICAgY29uc3QgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgICBjaGlsZHJlbi5wdXNoKG5ldyBPY3RyZWVOb2RlKHsKICAgICAgICBhYWJiOiBuZXcgQUFCQih7CiAgICAgICAgICBsb3dlckJvdW5kOiBuZXcgVmVjMygwLCAwLCAwKQogICAgICAgIH0pCiAgICAgIH0pLCBuZXcgT2N0cmVlTm9kZSh7CiAgICAgICAgYWFiYjogbmV3IEFBQkIoewogICAgICAgICAgbG93ZXJCb3VuZDogbmV3IFZlYzMoMSwgMCwgMCkKICAgICAgICB9KQogICAgICB9KSwgbmV3IE9jdHJlZU5vZGUoewogICAgICAgIGFhYmI6IG5ldyBBQUJCKHsKICAgICAgICAgIGxvd2VyQm91bmQ6IG5ldyBWZWMzKDEsIDEsIDApCiAgICAgICAgfSkKICAgICAgfSksIG5ldyBPY3RyZWVOb2RlKHsKICAgICAgICBhYWJiOiBuZXcgQUFCQih7CiAgICAgICAgICBsb3dlckJvdW5kOiBuZXcgVmVjMygxLCAxLCAxKQogICAgICAgIH0pCiAgICAgIH0pLCBuZXcgT2N0cmVlTm9kZSh7CiAgICAgICAgYWFiYjogbmV3IEFBQkIoewogICAgICAgICAgbG93ZXJCb3VuZDogbmV3IFZlYzMoMCwgMSwgMSkKICAgICAgICB9KQogICAgICB9KSwgbmV3IE9jdHJlZU5vZGUoewogICAgICAgIGFhYmI6IG5ldyBBQUJCKHsKICAgICAgICAgIGxvd2VyQm91bmQ6IG5ldyBWZWMzKDAsIDAsIDEpCiAgICAgICAgfSkKICAgICAgfSksIG5ldyBPY3RyZWVOb2RlKHsKICAgICAgICBhYWJiOiBuZXcgQUFCQih7CiAgICAgICAgICBsb3dlckJvdW5kOiBuZXcgVmVjMygxLCAwLCAxKQogICAgICAgIH0pCiAgICAgIH0pLCBuZXcgT2N0cmVlTm9kZSh7CiAgICAgICAgYWFiYjogbmV3IEFBQkIoewogICAgICAgICAgbG93ZXJCb3VuZDogbmV3IFZlYzMoMCwgMSwgMCkKICAgICAgICB9KQogICAgICB9KSk7CiAgICAgIHUudnN1YihsLCBoYWxmRGlhZ29uYWwpOwogICAgICBoYWxmRGlhZ29uYWwuc2NhbGUoMC41LCBoYWxmRGlhZ29uYWwpOwogICAgICBjb25zdCByb290ID0gdGhpcy5yb290IHx8IHRoaXM7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gODsgaSsrKSB7CiAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsgLy8gU2V0IGN1cnJlbnQgbm9kZSBhcyByb290CgogICAgICAgIGNoaWxkLnJvb3QgPSByb290OyAvLyBDb21wdXRlIGJvdW5kcwoKICAgICAgICBjb25zdCBsb3dlckJvdW5kID0gY2hpbGQuYWFiYi5sb3dlckJvdW5kOwogICAgICAgIGxvd2VyQm91bmQueCAqPSBoYWxmRGlhZ29uYWwueDsKICAgICAgICBsb3dlckJvdW5kLnkgKj0gaGFsZkRpYWdvbmFsLnk7CiAgICAgICAgbG93ZXJCb3VuZC56ICo9IGhhbGZEaWFnb25hbC56OwogICAgICAgIGxvd2VyQm91bmQudmFkZChsLCBsb3dlckJvdW5kKTsgLy8gVXBwZXIgYm91bmQgaXMgYWx3YXlzIGxvd2VyIGJvdW5kICsgaGFsZkRpYWdvbmFsCgogICAgICAgIGxvd2VyQm91bmQudmFkZChoYWxmRGlhZ29uYWwsIGNoaWxkLmFhYmIudXBwZXJCb3VuZCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogR2V0IGFsbCBkYXRhLCBwb3RlbnRpYWxseSB3aXRoaW4gYW4gQUFCQgogICAgICogQHJldHVybiBUaGUgInJlc3VsdCIgb2JqZWN0CiAgICAgKi8KCgogICAgYWFiYlF1ZXJ5KGFhYmIsIHJlc3VsdCkgewogICAgICB0aGlzLmRhdGE7IC8vIGFib3J0IGlmIHRoZSByYW5nZSBkb2VzIG5vdCBpbnRlcnNlY3QgdGhpcyBub2RlCiAgICAgIC8vIGlmICghdGhpcy5hYWJiLm92ZXJsYXBzKGFhYmIpKXsKICAgICAgLy8gICAgIHJldHVybiByZXN1bHQ7CiAgICAgIC8vIH0KICAgICAgLy8gQWRkIG9iamVjdHMgYXQgdGhpcyBsZXZlbAogICAgICAvLyBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShyZXN1bHQsIG5vZGVEYXRhKTsKICAgICAgLy8gQWRkIGNoaWxkIGRhdGEKICAgICAgLy8gQHRvZG8gdW53cmFwIHJlY3Vyc2lvbiBpbnRvIGEgcXVldWUgLyBsb29wLCB0aGF0J3MgZmFzdGVyIGluIEpTCgogICAgICB0aGlzLmNoaWxkcmVuOyAvLyBmb3IgKGxldCBpID0gMCwgTiA9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpICE9PSBOOyBpKyspIHsKICAgICAgLy8gICAgIGNoaWxkcmVuW2ldLmFhYmJRdWVyeShhYWJiLCByZXN1bHQpOwogICAgICAvLyB9CgogICAgICBjb25zdCBxdWV1ZSA9IFt0aGlzXTsKCiAgICAgIHdoaWxlIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgICBjb25zdCBub2RlID0gcXVldWUucG9wKCk7CgogICAgICAgIGlmIChub2RlLmFhYmIub3ZlcmxhcHMoYWFiYikpIHsKICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHJlc3VsdCwgbm9kZS5kYXRhKTsKICAgICAgICB9CgogICAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHF1ZXVlLCBub2RlLmNoaWxkcmVuKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGFsbCBkYXRhLCBwb3RlbnRpYWxseSBpbnRlcnNlY3RlZCBieSBhIHJheS4KICAgICAqIEByZXR1cm4gVGhlICJyZXN1bHQiIG9iamVjdAogICAgICovCgoKICAgIHJheVF1ZXJ5KHJheSwgdHJlZVRyYW5zZm9ybSwgcmVzdWx0KSB7CiAgICAgIC8vIFVzZSBhYWJiIHF1ZXJ5IGZvciBub3cuCgogICAgICAvKiogQHRvZG8gaW1wbGVtZW50IHJlYWwgcmF5IHF1ZXJ5IHdoaWNoIG5lZWRzIGxlc3MgbG9va3VwcyAqLwogICAgICByYXkuZ2V0QUFCQih0bXBBQUJCKTsKICAgICAgdG1wQUFCQi50b0xvY2FsRnJhbWUodHJlZVRyYW5zZm9ybSwgdG1wQUFCQik7CiAgICAgIHRoaXMuYWFiYlF1ZXJ5KHRtcEFBQkIsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIHJlbW92ZUVtcHR5Tm9kZXMKICAgICAqLwoKCiAgICByZW1vdmVFbXB0eU5vZGVzKCkgewogICAgICBmb3IgKGxldCBpID0gdGhpcy5jaGlsZHJlbi5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIHRoaXMuY2hpbGRyZW5baV0ucmVtb3ZlRW1wdHlOb2RlcygpOwoKICAgICAgICBpZiAoIXRoaXMuY2hpbGRyZW5baV0uY2hpbGRyZW4ubGVuZ3RoICYmICF0aGlzLmNoaWxkcmVuW2ldLmRhdGEubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpLCAxKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgfQogIC8qKgogICAqIE9jdHJlZQogICAqLwoKCiAgY2xhc3MgT2N0cmVlIGV4dGVuZHMgT2N0cmVlTm9kZSB7CiAgICAvKioKICAgICAqIE1heGltdW0gc3ViZGl2aXNpb24gZGVwdGgKICAgICAqIEBkZWZhdWx0IDgKICAgICAqLwoKICAgIC8qKgogICAgICogQHBhcmFtIGFhYmIgVGhlIHRvdGFsIEFBQkIgb2YgdGhlIHRyZWUKICAgICAqLwogICAgY29uc3RydWN0b3IoYWFiYiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBzdXBlcih7CiAgICAgICAgcm9vdDogbnVsbCwKICAgICAgICBhYWJiCiAgICAgIH0pOwogICAgICB0aGlzLm1heERlcHRoID0gdHlwZW9mIG9wdGlvbnMubWF4RGVwdGggIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5tYXhEZXB0aCA6IDg7CiAgICB9CgogIH0KICBjb25zdCBoYWxmRGlhZ29uYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcEFBQkIgPSBuZXcgQUFCQigpOwoKICAvKioKICAgKiBUcmltZXNoLgogICAqIEBleGFtcGxlCiAgICogICAgIC8vIEhvdyB0byBtYWtlIGEgbWVzaCB3aXRoIGEgc2luZ2xlIHRyaWFuZ2xlCiAgICogICAgIGNvbnN0IHZlcnRpY2VzID0gWwogICAqICAgICAgICAgMCwgMCwgMCwgLy8gdmVydGV4IDAKICAgKiAgICAgICAgIDEsIDAsIDAsIC8vIHZlcnRleCAxCiAgICogICAgICAgICAwLCAxLCAwICAvLyB2ZXJ0ZXggMgogICAqICAgICBdCiAgICogICAgIGNvbnN0IGluZGljZXMgPSBbCiAgICogICAgICAgICAwLCAxLCAyICAvLyB0cmlhbmdsZSAwCiAgICogICAgIF0KICAgKiAgICAgY29uc3QgdHJpbWVzaFNoYXBlID0gbmV3IENBTk5PTi5UcmltZXNoKHZlcnRpY2VzLCBpbmRpY2VzKQogICAqLwogIGNsYXNzIFRyaW1lc2ggZXh0ZW5kcyBTaGFwZSB7CiAgICAvKioKICAgICAqIHZlcnRpY2VzCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFycmF5IG9mIGludGVnZXJzLCBpbmRpY2F0aW5nIHdoaWNoIHZlcnRpY2VzIGVhY2ggdHJpYW5nbGUgY29uc2lzdHMgb2YuIFRoZSBsZW5ndGggb2YgdGhpcyBhcnJheSBpcyB0aHVzIDMgdGltZXMgdGhlIG51bWJlciBvZiB0cmlhbmdsZXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBub3JtYWxzIGRhdGEuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBsb2NhbCBBQUJCIG9mIHRoZSBtZXNoLgogICAgICovCgogICAgLyoqCiAgICAgKiBSZWZlcmVuY2VzIHRvIHZlcnRleCBwYWlycywgbWFraW5nIHVwIGFsbCB1bmlxdWUgZWRnZXMgaW4gdGhlIHRyaW1lc2guCiAgICAgKi8KCiAgICAvKioKICAgICAqIExvY2FsIHNjYWxpbmcgb2YgdGhlIG1lc2guIFVzZSAuc2V0U2NhbGUoKSB0byBzZXQgaXQuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBpbmRleGVkIHRyaWFuZ2xlcy4gVXNlIC51cGRhdGVUcmVlKCkgdG8gdXBkYXRlIGl0LgogICAgICovCiAgICBjb25zdHJ1Y3Rvcih2ZXJ0aWNlcywgaW5kaWNlcykgewogICAgICBzdXBlcih7CiAgICAgICAgdHlwZTogU2hhcGUudHlwZXMuVFJJTUVTSAogICAgICB9KTsKICAgICAgdGhpcy52ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkodmVydGljZXMpOwogICAgICB0aGlzLmluZGljZXMgPSBuZXcgSW50MTZBcnJheShpbmRpY2VzKTsKICAgICAgdGhpcy5ub3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheShpbmRpY2VzLmxlbmd0aCk7CiAgICAgIHRoaXMuYWFiYiA9IG5ldyBBQUJCKCk7CiAgICAgIHRoaXMuZWRnZXMgPSBudWxsOwogICAgICB0aGlzLnNjYWxlID0gbmV3IFZlYzMoMSwgMSwgMSk7CiAgICAgIHRoaXMudHJlZSA9IG5ldyBPY3RyZWUoKTsKICAgICAgdGhpcy51cGRhdGVFZGdlcygpOwogICAgICB0aGlzLnVwZGF0ZU5vcm1hbHMoKTsKICAgICAgdGhpcy51cGRhdGVBQUJCKCk7CiAgICAgIHRoaXMudXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKTsKICAgICAgdGhpcy51cGRhdGVUcmVlKCk7CiAgICB9CiAgICAvKioKICAgICAqIHVwZGF0ZVRyZWUKICAgICAqLwoKCiAgICB1cGRhdGVUcmVlKCkgewogICAgICBjb25zdCB0cmVlID0gdGhpcy50cmVlOwogICAgICB0cmVlLnJlc2V0KCk7CiAgICAgIHRyZWUuYWFiYi5jb3B5KHRoaXMuYWFiYik7CiAgICAgIGNvbnN0IHNjYWxlID0gdGhpcy5zY2FsZTsgLy8gVGhlIGxvY2FsIG1lc2ggQUFCQiBpcyBzY2FsZWQsIGJ1dCB0aGUgb2N0cmVlIEFBQkIgc2hvdWxkIGJlIHVuc2NhbGVkCgogICAgICB0cmVlLmFhYmIubG93ZXJCb3VuZC54ICo9IDEgLyBzY2FsZS54OwogICAgICB0cmVlLmFhYmIubG93ZXJCb3VuZC55ICo9IDEgLyBzY2FsZS55OwogICAgICB0cmVlLmFhYmIubG93ZXJCb3VuZC56ICo9IDEgLyBzY2FsZS56OwogICAgICB0cmVlLmFhYmIudXBwZXJCb3VuZC54ICo9IDEgLyBzY2FsZS54OwogICAgICB0cmVlLmFhYmIudXBwZXJCb3VuZC55ICo9IDEgLyBzY2FsZS55OwogICAgICB0cmVlLmFhYmIudXBwZXJCb3VuZC56ICo9IDEgLyBzY2FsZS56OyAvLyBJbnNlcnQgYWxsIHRyaWFuZ2xlcwoKICAgICAgY29uc3QgdHJpYW5nbGVBQUJCID0gbmV3IEFBQkIoKTsKICAgICAgY29uc3QgYSA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGIgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBjID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgcG9pbnRzID0gW2EsIGIsIGNdOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAgICAgLy90aGlzLmdldFRyaWFuZ2xlVmVydGljZXMoaSwgYSwgYiwgYyk7CiAgICAgICAgLy8gR2V0IHVuc2NhbGVkIHRyaWFuZ2xlIHZlcnRzCiAgICAgICAgY29uc3QgaTMgPSBpICogMzsKCiAgICAgICAgdGhpcy5fZ2V0VW5zY2FsZWRWZXJ0ZXgodGhpcy5pbmRpY2VzW2kzXSwgYSk7CgogICAgICAgIHRoaXMuX2dldFVuc2NhbGVkVmVydGV4KHRoaXMuaW5kaWNlc1tpMyArIDFdLCBiKTsKCiAgICAgICAgdGhpcy5fZ2V0VW5zY2FsZWRWZXJ0ZXgodGhpcy5pbmRpY2VzW2kzICsgMl0sIGMpOwoKICAgICAgICB0cmlhbmdsZUFBQkIuc2V0RnJvbVBvaW50cyhwb2ludHMpOwogICAgICAgIHRyZWUuaW5zZXJ0KHRyaWFuZ2xlQUFCQiwgaSk7CiAgICAgIH0KCiAgICAgIHRyZWUucmVtb3ZlRW1wdHlOb2RlcygpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdHJpYW5nbGVzIGluIGEgbG9jYWwgQUFCQiBmcm9tIHRoZSB0cmltZXNoLgogICAgICogQHBhcmFtIHJlc3VsdCBBbiBhcnJheSBvZiBpbnRlZ2VycywgcmVmZXJlbmNpbmcgdGhlIHF1ZXJpZWQgdHJpYW5nbGVzLgogICAgICovCgoKICAgIGdldFRyaWFuZ2xlc0luQUFCQihhYWJiLCByZXN1bHQpIHsKICAgICAgdW5zY2FsZWRBQUJCLmNvcHkoYWFiYik7IC8vIFNjYWxlIGl0IHRvIGxvY2FsCgogICAgICBjb25zdCBzY2FsZSA9IHRoaXMuc2NhbGU7CiAgICAgIGNvbnN0IGlzeCA9IHNjYWxlLng7CiAgICAgIGNvbnN0IGlzeSA9IHNjYWxlLnk7CiAgICAgIGNvbnN0IGlzeiA9IHNjYWxlLno7CiAgICAgIGNvbnN0IGwgPSB1bnNjYWxlZEFBQkIubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdSA9IHVuc2NhbGVkQUFCQi51cHBlckJvdW5kOwogICAgICBsLnggLz0gaXN4OwogICAgICBsLnkgLz0gaXN5OwogICAgICBsLnogLz0gaXN6OwogICAgICB1LnggLz0gaXN4OwogICAgICB1LnkgLz0gaXN5OwogICAgICB1LnogLz0gaXN6OwogICAgICByZXR1cm4gdGhpcy50cmVlLmFhYmJRdWVyeSh1bnNjYWxlZEFBQkIsIHJlc3VsdCk7CiAgICB9CiAgICAvKioKICAgICAqIHNldFNjYWxlCiAgICAgKi8KCgogICAgc2V0U2NhbGUoc2NhbGUpIHsKICAgICAgY29uc3Qgd2FzVW5pZm9ybSA9IHRoaXMuc2NhbGUueCA9PT0gdGhpcy5zY2FsZS55ICYmIHRoaXMuc2NhbGUueSA9PT0gdGhpcy5zY2FsZS56OwogICAgICBjb25zdCBpc1VuaWZvcm0gPSBzY2FsZS54ID09PSBzY2FsZS55ICYmIHNjYWxlLnkgPT09IHNjYWxlLno7CgogICAgICBpZiAoISh3YXNVbmlmb3JtICYmIGlzVW5pZm9ybSkpIHsKICAgICAgICAvLyBOb24tdW5pZm9ybSBzY2FsaW5nLiBOZWVkIHRvIHVwZGF0ZSBub3JtYWxzLgogICAgICAgIHRoaXMudXBkYXRlTm9ybWFscygpOwogICAgICB9CgogICAgICB0aGlzLnNjYWxlLmNvcHkoc2NhbGUpOwogICAgICB0aGlzLnVwZGF0ZUFBQkIoKTsKICAgICAgdGhpcy51cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlIHRoZSBub3JtYWxzIG9mIHRoZSBmYWNlcy4gV2lsbCBzYXZlIGluIHRoZSBgLm5vcm1hbHNgIGFycmF5LgogICAgICovCgoKICAgIHVwZGF0ZU5vcm1hbHMoKSB7CiAgICAgIGNvbnN0IG4gPSBjb21wdXRlTm9ybWFsc19uOyAvLyBHZW5lcmF0ZSBub3JtYWxzCgogICAgICBjb25zdCBub3JtYWxzID0gdGhpcy5ub3JtYWxzOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgICBjb25zdCBhID0gdGhpcy5pbmRpY2VzW2kzXTsKICAgICAgICBjb25zdCBiID0gdGhpcy5pbmRpY2VzW2kzICsgMV07CiAgICAgICAgY29uc3QgYyA9IHRoaXMuaW5kaWNlc1tpMyArIDJdOwogICAgICAgIHRoaXMuZ2V0VmVydGV4KGEsIHZhKTsKICAgICAgICB0aGlzLmdldFZlcnRleChiLCB2Yik7CiAgICAgICAgdGhpcy5nZXRWZXJ0ZXgoYywgdmMpOwogICAgICAgIFRyaW1lc2guY29tcHV0ZU5vcm1hbCh2YiwgdmEsIHZjLCBuKTsKICAgICAgICBub3JtYWxzW2kzXSA9IG4ueDsKICAgICAgICBub3JtYWxzW2kzICsgMV0gPSBuLnk7CiAgICAgICAgbm9ybWFsc1tpMyArIDJdID0gbi56OwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZSB0aGUgYC5lZGdlc2AgcHJvcGVydHkKICAgICAqLwoKCiAgICB1cGRhdGVFZGdlcygpIHsKICAgICAgY29uc3QgZWRnZXMgPSB7fTsKCiAgICAgIGNvbnN0IGFkZCA9IChhLCBiKSA9PiB7CiAgICAgICAgY29uc3Qga2V5ID0gYSA8IGIgPyBgJHthfV8ke2J9YCA6IGAke2J9XyR7YX1gOwogICAgICAgIGVkZ2VzW2tleV0gPSB0cnVlOwogICAgICB9OwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgICBjb25zdCBhID0gdGhpcy5pbmRpY2VzW2kzXTsKICAgICAgICBjb25zdCBiID0gdGhpcy5pbmRpY2VzW2kzICsgMV07CiAgICAgICAgY29uc3QgYyA9IHRoaXMuaW5kaWNlc1tpMyArIDJdOwogICAgICAgIGFkZChhLCBiKTsKICAgICAgICBhZGQoYiwgYyk7CiAgICAgICAgYWRkKGMsIGEpOwogICAgICB9CgogICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZWRnZXMpOwogICAgICB0aGlzLmVkZ2VzID0gbmV3IEludDE2QXJyYXkoa2V5cy5sZW5ndGggKiAyKTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGluZGljZXMgPSBrZXlzW2ldLnNwbGl0KCdfJyk7CiAgICAgICAgdGhpcy5lZGdlc1syICogaV0gPSBwYXJzZUludChpbmRpY2VzWzBdLCAxMCk7CiAgICAgICAgdGhpcy5lZGdlc1syICogaSArIDFdID0gcGFyc2VJbnQoaW5kaWNlc1sxXSwgMTApOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbiBlZGdlIHZlcnRleAogICAgICogQHBhcmFtIGZpcnN0T3JTZWNvbmQgMCBvciAxLCBkZXBlbmRpbmcgb24gd2hpY2ggb25lIG9mIHRoZSB2ZXJ0aWNlcyB5b3UgbmVlZC4KICAgICAqIEBwYXJhbSB2ZXJ0ZXhTdG9yZSBXaGVyZSB0byBzdG9yZSB0aGUgcmVzdWx0CiAgICAgKi8KCgogICAgZ2V0RWRnZVZlcnRleChlZGdlSW5kZXgsIGZpcnN0T3JTZWNvbmQsIHZlcnRleFN0b3JlKSB7CiAgICAgIGNvbnN0IHZlcnRleEluZGV4ID0gdGhpcy5lZGdlc1tlZGdlSW5kZXggKiAyICsgKGZpcnN0T3JTZWNvbmQgPyAxIDogMCldOwogICAgICB0aGlzLmdldFZlcnRleCh2ZXJ0ZXhJbmRleCwgdmVydGV4U3RvcmUpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgYSB2ZWN0b3IgYWxvbmcgYW4gZWRnZS4KICAgICAqLwoKCiAgICBnZXRFZGdlVmVjdG9yKGVkZ2VJbmRleCwgdmVjdG9yU3RvcmUpIHsKICAgICAgY29uc3QgdmEgPSBnZXRFZGdlVmVjdG9yX3ZhOwogICAgICBjb25zdCB2YiA9IGdldEVkZ2VWZWN0b3JfdmI7CiAgICAgIHRoaXMuZ2V0RWRnZVZlcnRleChlZGdlSW5kZXgsIDAsIHZhKTsKICAgICAgdGhpcy5nZXRFZGdlVmVydGV4KGVkZ2VJbmRleCwgMSwgdmIpOwogICAgICB2Yi52c3ViKHZhLCB2ZWN0b3JTdG9yZSk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBmYWNlIG5vcm1hbCBnaXZlbiAzIHZlcnRpY2VzCiAgICAgKi8KCgogICAgc3RhdGljIGNvbXB1dGVOb3JtYWwodmEsIHZiLCB2YywgdGFyZ2V0KSB7CiAgICAgIHZiLnZzdWIodmEsIGFiKTsKICAgICAgdmMudnN1Yih2YiwgY2IpOwogICAgICBjYi5jcm9zcyhhYiwgdGFyZ2V0KTsKCiAgICAgIGlmICghdGFyZ2V0LmlzWmVybygpKSB7CiAgICAgICAgdGFyZ2V0Lm5vcm1hbGl6ZSgpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCB2ZXJ0ZXggaS4KICAgICAqIEByZXR1cm4gVGhlICJvdXQiIHZlY3RvciBvYmplY3QKICAgICAqLwoKCiAgICBnZXRWZXJ0ZXgoaSwgb3V0KSB7CiAgICAgIGNvbnN0IHNjYWxlID0gdGhpcy5zY2FsZTsKCiAgICAgIHRoaXMuX2dldFVuc2NhbGVkVmVydGV4KGksIG91dCk7CgogICAgICBvdXQueCAqPSBzY2FsZS54OwogICAgICBvdXQueSAqPSBzY2FsZS55OwogICAgICBvdXQueiAqPSBzY2FsZS56OwogICAgICByZXR1cm4gb3V0OwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgcmF3IHZlcnRleCBpCiAgICAgKiBAcmV0dXJuIFRoZSAib3V0IiB2ZWN0b3Igb2JqZWN0CiAgICAgKi8KCgogICAgX2dldFVuc2NhbGVkVmVydGV4KGksIG91dCkgewogICAgICBjb25zdCBpMyA9IGkgKiAzOwogICAgICBjb25zdCB2ZXJ0aWNlcyA9IHRoaXMudmVydGljZXM7CiAgICAgIHJldHVybiBvdXQuc2V0KHZlcnRpY2VzW2kzXSwgdmVydGljZXNbaTMgKyAxXSwgdmVydGljZXNbaTMgKyAyXSk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhIHZlcnRleCBmcm9tIHRoZSB0cmltZXNoLHRyYW5zZm9ybWVkIGJ5IHRoZSBnaXZlbiBwb3NpdGlvbiBhbmQgcXVhdGVybmlvbi4KICAgICAqIEByZXR1cm4gVGhlICJvdXQiIHZlY3RvciBvYmplY3QKICAgICAqLwoKCiAgICBnZXRXb3JsZFZlcnRleChpLCBwb3MsIHF1YXQsIG91dCkgewogICAgICB0aGlzLmdldFZlcnRleChpLCBvdXQpOwogICAgICBUcmFuc2Zvcm0ucG9pbnRUb1dvcmxkRnJhbWUocG9zLCBxdWF0LCBvdXQsIG91dCk7CiAgICAgIHJldHVybiBvdXQ7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgdGhyZWUgdmVydGljZXMgZm9yIHRyaWFuZ2xlIGkuCiAgICAgKi8KCgogICAgZ2V0VHJpYW5nbGVWZXJ0aWNlcyhpLCBhLCBiLCBjKSB7CiAgICAgIGNvbnN0IGkzID0gaSAqIDM7CiAgICAgIHRoaXMuZ2V0VmVydGV4KHRoaXMuaW5kaWNlc1tpM10sIGEpOwogICAgICB0aGlzLmdldFZlcnRleCh0aGlzLmluZGljZXNbaTMgKyAxXSwgYik7CiAgICAgIHRoaXMuZ2V0VmVydGV4KHRoaXMuaW5kaWNlc1tpMyArIDJdLCBjKTsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZSB0aGUgbm9ybWFsIG9mIHRyaWFuZ2xlIGkuCiAgICAgKiBAcmV0dXJuIFRoZSAidGFyZ2V0IiB2ZWN0b3Igb2JqZWN0CiAgICAgKi8KCgogICAgZ2V0Tm9ybWFsKGksIHRhcmdldCkgewogICAgICBjb25zdCBpMyA9IGkgKiAzOwogICAgICByZXR1cm4gdGFyZ2V0LnNldCh0aGlzLm5vcm1hbHNbaTNdLCB0aGlzLm5vcm1hbHNbaTMgKyAxXSwgdGhpcy5ub3JtYWxzW2kzICsgMl0pOwogICAgfQogICAgLyoqCiAgICAgKiBAcmV0dXJuIFRoZSAidGFyZ2V0IiB2ZWN0b3Igb2JqZWN0CiAgICAgKi8KCgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICAvLyBBcHByb3hpbWF0ZSB3aXRoIGJveCBpbmVydGlhCiAgICAgIC8vIEV4YWN0IGluZXJ0aWEgY2FsY3VsYXRpb24gaXMgb3ZlcmtpbGwsIGJ1dCBzZWUgaHR0cDovL2dlb21ldHJpY3Rvb2xzLmNvbS9Eb2N1bWVudGF0aW9uL1BvbHloZWRyYWxNYXNzUHJvcGVydGllcy5wZGYgZm9yIHRoZSBjb3JyZWN0IHdheSB0byBkbyBpdAogICAgICB0aGlzLmNvbXB1dGVMb2NhbEFBQkIoY2xpX2FhYmIpOwogICAgICBjb25zdCB4ID0gY2xpX2FhYmIudXBwZXJCb3VuZC54IC0gY2xpX2FhYmIubG93ZXJCb3VuZC54OwogICAgICBjb25zdCB5ID0gY2xpX2FhYmIudXBwZXJCb3VuZC55IC0gY2xpX2FhYmIubG93ZXJCb3VuZC55OwogICAgICBjb25zdCB6ID0gY2xpX2FhYmIudXBwZXJCb3VuZC56IC0gY2xpX2FhYmIubG93ZXJCb3VuZC56OwogICAgICByZXR1cm4gdGFyZ2V0LnNldCgxLjAgLyAxMi4wICogbWFzcyAqICgyICogeSAqIDIgKiB5ICsgMiAqIHogKiAyICogeiksIDEuMCAvIDEyLjAgKiBtYXNzICogKDIgKiB4ICogMiAqIHggKyAyICogeiAqIDIgKiB6KSwgMS4wIC8gMTIuMCAqIG1hc3MgKiAoMiAqIHkgKiAyICogeSArIDIgKiB4ICogMiAqIHgpKTsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZSB0aGUgbG9jYWwgQUFCQiBmb3IgdGhlIHRyaW1lc2gKICAgICAqLwoKCiAgICBjb21wdXRlTG9jYWxBQUJCKGFhYmIpIHsKICAgICAgY29uc3QgbCA9IGFhYmIubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdSA9IGFhYmIudXBwZXJCb3VuZDsKICAgICAgY29uc3QgbiA9IHRoaXMudmVydGljZXMubGVuZ3RoOwogICAgICB0aGlzLnZlcnRpY2VzOwogICAgICBjb25zdCB2ID0gY29tcHV0ZUxvY2FsQUFCQl93b3JsZFZlcnQ7CiAgICAgIHRoaXMuZ2V0VmVydGV4KDAsIHYpOwogICAgICBsLmNvcHkodik7CiAgICAgIHUuY29weSh2KTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBuOyBpKyspIHsKICAgICAgICB0aGlzLmdldFZlcnRleChpLCB2KTsKCiAgICAgICAgaWYgKHYueCA8IGwueCkgewogICAgICAgICAgbC54ID0gdi54OwogICAgICAgIH0gZWxzZSBpZiAodi54ID4gdS54KSB7CiAgICAgICAgICB1LnggPSB2Lng7CiAgICAgICAgfQoKICAgICAgICBpZiAodi55IDwgbC55KSB7CiAgICAgICAgICBsLnkgPSB2Lnk7CiAgICAgICAgfSBlbHNlIGlmICh2LnkgPiB1LnkpIHsKICAgICAgICAgIHUueSA9IHYueTsKICAgICAgICB9CgogICAgICAgIGlmICh2LnogPCBsLnopIHsKICAgICAgICAgIGwueiA9IHYuejsKICAgICAgICB9IGVsc2UgaWYgKHYueiA+IHUueikgewogICAgICAgICAgdS56ID0gdi56OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGUgdGhlIGAuYWFiYmAgcHJvcGVydHkKICAgICAqLwoKCiAgICB1cGRhdGVBQUJCKCkgewogICAgICB0aGlzLmNvbXB1dGVMb2NhbEFBQkIodGhpcy5hYWJiKTsKICAgIH0KICAgIC8qKgogICAgICogV2lsbCB1cGRhdGUgdGhlIGAuYm91bmRpbmdTcGhlcmVSYWRpdXNgIHByb3BlcnR5CiAgICAgKi8KCgogICAgdXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKSB7CiAgICAgIC8vIEFzc3VtZSBwb2ludHMgYXJlIGRpc3RyaWJ1dGVkIHdpdGggbG9jYWwgKDAsMCwwKSBhcyBjZW50ZXIKICAgICAgbGV0IG1heDIgPSAwOwogICAgICBjb25zdCB2ZXJ0aWNlcyA9IHRoaXMudmVydGljZXM7CiAgICAgIGNvbnN0IHYgPSBuZXcgVmVjMygpOwoKICAgICAgZm9yIChsZXQgaSA9IDAsIE4gPSB2ZXJ0aWNlcy5sZW5ndGggLyAzOyBpICE9PSBOOyBpKyspIHsKICAgICAgICB0aGlzLmdldFZlcnRleChpLCB2KTsKICAgICAgICBjb25zdCBub3JtMiA9IHYubGVuZ3RoU3F1YXJlZCgpOwoKICAgICAgICBpZiAobm9ybTIgPiBtYXgyKSB7CiAgICAgICAgICBtYXgyID0gbm9ybTI7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlUmFkaXVzID0gTWF0aC5zcXJ0KG1heDIpOwogICAgfQogICAgLyoqCiAgICAgKiBjYWxjdWxhdGVXb3JsZEFBQkIKICAgICAqLwoKCiAgICBjYWxjdWxhdGVXb3JsZEFBQkIocG9zLCBxdWF0LCBtaW4sIG1heCkgewogICAgICAvKgogICAgICAgICAgY29uc3QgbiA9IHRoaXMudmVydGljZXMubGVuZ3RoIC8gMywKICAgICAgICAgICAgICB2ZXJ0cyA9IHRoaXMudmVydGljZXM7CiAgICAgICAgICBjb25zdCBtaW54LG1pbnksbWlueixtYXh4LG1heHksbWF4ejsKICAgICAgICAgICBjb25zdCB2ID0gdGVtcFdvcmxkVmVydGV4OwogICAgICAgICAgZm9yKGxldCBpPTA7IGk8bjsgaSsrKXsKICAgICAgICAgICAgICB0aGlzLmdldFZlcnRleChpLCB2KTsKICAgICAgICAgICAgICBxdWF0LnZtdWx0KHYsIHYpOwogICAgICAgICAgICAgIHBvcy52YWRkKHYsIHYpOwogICAgICAgICAgICAgIGlmICh2LnggPCBtaW54IHx8IG1pbng9PT11bmRlZmluZWQpewogICAgICAgICAgICAgICAgICBtaW54ID0gdi54OwogICAgICAgICAgICAgIH0gZWxzZSBpZih2LnggPiBtYXh4IHx8IG1heHg9PT11bmRlZmluZWQpewogICAgICAgICAgICAgICAgICBtYXh4ID0gdi54OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgaWYgKHYueSA8IG1pbnkgfHwgbWlueT09PXVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgIG1pbnkgPSB2Lnk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmKHYueSA+IG1heHkgfHwgbWF4eT09PXVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgIG1heHkgPSB2Lnk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICBpZiAodi56IDwgbWlueiB8fCBtaW56PT09dW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgbWlueiA9IHYuejsKICAgICAgICAgICAgICB9IGVsc2UgaWYodi56ID4gbWF4eiB8fCBtYXh6PT09dW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgbWF4eiA9IHYuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtaW4uc2V0KG1pbngsbWlueSxtaW56KTsKICAgICAgICAgIG1heC5zZXQobWF4eCxtYXh5LG1heHopOwogICAgICAgICAgKi8KICAgICAgLy8gRmFzdGVyIGFwcHJveGltYXRpb24gdXNpbmcgbG9jYWwgQUFCQgogICAgICBjb25zdCBmcmFtZSA9IGNhbGN1bGF0ZVdvcmxkQUFCQl9mcmFtZTsKICAgICAgY29uc3QgcmVzdWx0ID0gY2FsY3VsYXRlV29ybGRBQUJCX2FhYmI7CiAgICAgIGZyYW1lLnBvc2l0aW9uID0gcG9zOwogICAgICBmcmFtZS5xdWF0ZXJuaW9uID0gcXVhdDsKICAgICAgdGhpcy5hYWJiLnRvV29ybGRGcmFtZShmcmFtZSwgcmVzdWx0KTsKICAgICAgbWluLmNvcHkocmVzdWx0Lmxvd2VyQm91bmQpOwogICAgICBtYXguY29weShyZXN1bHQudXBwZXJCb3VuZCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhcHByb3hpbWF0ZSB2b2x1bWUKICAgICAqLwoKCiAgICB2b2x1bWUoKSB7CiAgICAgIHJldHVybiA0LjAgKiBNYXRoLlBJICogdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyAvIDMuMDsKICAgIH0KICAgIC8qKgogICAgICogQ3JlYXRlIGEgVHJpbWVzaCBpbnN0YW5jZSwgc2hhcGVkIGFzIGEgdG9ydXMuCiAgICAgKi8KCgogICAgc3RhdGljIGNyZWF0ZVRvcnVzKHJhZGl1cywgdHViZSwgcmFkaWFsU2VnbWVudHMsIHR1YnVsYXJTZWdtZW50cywgYXJjKSB7CiAgICAgIGlmIChyYWRpdXMgPT09IHZvaWQgMCkgewogICAgICAgIHJhZGl1cyA9IDE7CiAgICAgIH0KCiAgICAgIGlmICh0dWJlID09PSB2b2lkIDApIHsKICAgICAgICB0dWJlID0gMC41OwogICAgICB9CgogICAgICBpZiAocmFkaWFsU2VnbWVudHMgPT09IHZvaWQgMCkgewogICAgICAgIHJhZGlhbFNlZ21lbnRzID0gODsKICAgICAgfQoKICAgICAgaWYgKHR1YnVsYXJTZWdtZW50cyA9PT0gdm9pZCAwKSB7CiAgICAgICAgdHVidWxhclNlZ21lbnRzID0gNjsKICAgICAgfQoKICAgICAgaWYgKGFyYyA9PT0gdm9pZCAwKSB7CiAgICAgICAgYXJjID0gTWF0aC5QSSAqIDI7CiAgICAgIH0KCiAgICAgIGNvbnN0IHZlcnRpY2VzID0gW107CiAgICAgIGNvbnN0IGluZGljZXMgPSBbXTsKCiAgICAgIGZvciAobGV0IGogPSAwOyBqIDw9IHJhZGlhbFNlZ21lbnRzOyBqKyspIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSB0dWJ1bGFyU2VnbWVudHM7IGkrKykgewogICAgICAgICAgY29uc3QgdSA9IGkgLyB0dWJ1bGFyU2VnbWVudHMgKiBhcmM7CiAgICAgICAgICBjb25zdCB2ID0gaiAvIHJhZGlhbFNlZ21lbnRzICogTWF0aC5QSSAqIDI7CiAgICAgICAgICBjb25zdCB4ID0gKHJhZGl1cyArIHR1YmUgKiBNYXRoLmNvcyh2KSkgKiBNYXRoLmNvcyh1KTsKICAgICAgICAgIGNvbnN0IHkgPSAocmFkaXVzICsgdHViZSAqIE1hdGguY29zKHYpKSAqIE1hdGguc2luKHUpOwogICAgICAgICAgY29uc3QgeiA9IHR1YmUgKiBNYXRoLnNpbih2KTsKICAgICAgICAgIHZlcnRpY2VzLnB1c2goeCwgeSwgeik7CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKGxldCBqID0gMTsgaiA8PSByYWRpYWxTZWdtZW50czsgaisrKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gdHVidWxhclNlZ21lbnRzOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGEgPSAodHVidWxhclNlZ21lbnRzICsgMSkgKiBqICsgaSAtIDE7CiAgICAgICAgICBjb25zdCBiID0gKHR1YnVsYXJTZWdtZW50cyArIDEpICogKGogLSAxKSArIGkgLSAxOwogICAgICAgICAgY29uc3QgYyA9ICh0dWJ1bGFyU2VnbWVudHMgKyAxKSAqIChqIC0gMSkgKyBpOwogICAgICAgICAgY29uc3QgZCA9ICh0dWJ1bGFyU2VnbWVudHMgKyAxKSAqIGogKyBpOwogICAgICAgICAgaW5kaWNlcy5wdXNoKGEsIGIsIGQpOwogICAgICAgICAgaW5kaWNlcy5wdXNoKGIsIGMsIGQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBUcmltZXNoKHZlcnRpY2VzLCBpbmRpY2VzKTsKICAgIH0KCiAgfQogIGNvbnN0IGNvbXB1dGVOb3JtYWxzX24gPSBuZXcgVmVjMygpOwogIGNvbnN0IHVuc2NhbGVkQUFCQiA9IG5ldyBBQUJCKCk7CiAgY29uc3QgZ2V0RWRnZVZlY3Rvcl92YSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgZ2V0RWRnZVZlY3Rvcl92YiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgY2IgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFiID0gbmV3IFZlYzMoKTsKICBjb25zdCB2YSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdmIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHZjID0gbmV3IFZlYzMoKTsKICBjb25zdCBjbGlfYWFiYiA9IG5ldyBBQUJCKCk7CiAgY29uc3QgY29tcHV0ZUxvY2FsQUFCQl93b3JsZFZlcnQgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNhbGN1bGF0ZVdvcmxkQUFCQl9mcmFtZSA9IG5ldyBUcmFuc2Zvcm0oKTsKICBjb25zdCBjYWxjdWxhdGVXb3JsZEFBQkJfYWFiYiA9IG5ldyBBQUJCKCk7CgogIC8qKgogICAqIENvbnN0cmFpbnQgZXF1YXRpb24gc29sdmVyIGJhc2UgY2xhc3MuCiAgICovCiAgY2xhc3MgU29sdmVyIHsKICAgIC8qKgogICAgICogQWxsIGVxdWF0aW9ucyB0byBiZSBzb2x2ZWQKICAgICAqLwoKICAgIC8qKgogICAgICogQHRvZG8gcmVtb3ZlIHVzZWxlc3MgY29uc3RydWN0b3IKICAgICAqLwogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHRoaXMuZXF1YXRpb25zID0gW107CiAgICB9CiAgICAvKioKICAgICAqIFNob3VsZCBiZSBpbXBsZW1lbnRlZCBpbiBzdWJjbGFzc2VzIQogICAgICogQHRvZG8gdXNlIGFic3RyYWN0CiAgICAgKiBAcmV0dXJuIG51bWJlciBvZiBpdGVyYXRpb25zIHBlcmZvcm1lZAogICAgICovCgoKICAgIHNvbHZlKGR0LCB3b3JsZCkgewogICAgICByZXR1cm4gKC8vIFNob3VsZCByZXR1cm4gdGhlIG51bWJlciBvZiBpdGVyYXRpb25zIGRvbmUhCiAgICAgICAgMAogICAgICApOwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgYW4gZXF1YXRpb24KICAgICAqLwoKCiAgICBhZGRFcXVhdGlvbihlcSkgewogICAgICBpZiAoZXEuZW5hYmxlZCAmJiAhZXEuYmkuaXNUcmlnZ2VyICYmICFlcS5iai5pc1RyaWdnZXIpIHsKICAgICAgICB0aGlzLmVxdWF0aW9ucy5wdXNoKGVxKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmUgYW4gZXF1YXRpb24KICAgICAqLwoKCiAgICByZW1vdmVFcXVhdGlvbihlcSkgewogICAgICBjb25zdCBlcXMgPSB0aGlzLmVxdWF0aW9uczsKICAgICAgY29uc3QgaSA9IGVxcy5pbmRleE9mKGVxKTsKCiAgICAgIGlmIChpICE9PSAtMSkgewogICAgICAgIGVxcy5zcGxpY2UoaSwgMSk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQWRkIGFsbCBlcXVhdGlvbnMKICAgICAqLwoKCiAgICByZW1vdmVBbGxFcXVhdGlvbnMoKSB7CiAgICAgIHRoaXMuZXF1YXRpb25zLmxlbmd0aCA9IDA7CiAgICB9CgogIH0KCiAgLyoqCiAgICogQ29uc3RyYWludCBlcXVhdGlvbiBHYXVzcy1TZWlkZWwgc29sdmVyLgogICAqIEB0b2RvIFRoZSBzcG9vayBwYXJhbWV0ZXJzIHNob3VsZCBiZSBzcGVjaWZpZWQgZm9yIGVhY2ggY29uc3RyYWludCwgbm90IGdsb2JhbGx5LgogICAqIEBzZWUgaHR0cHM6Ly93d3c4LmNzLnVtdS5zZS9rdXJzZXIvNURWMDU4L1ZUMDkvbGVjdHVyZXMvc3Bvb2tub3Rlcy5wZGYKICAgKi8KICBjbGFzcyBHU1NvbHZlciBleHRlbmRzIFNvbHZlciB7CiAgICAvKioKICAgICAqIFRoZSBudW1iZXIgb2Ygc29sdmVyIGl0ZXJhdGlvbnMgZGV0ZXJtaW5lcyBxdWFsaXR5IG9mIHRoZSBjb25zdHJhaW50cyBpbiB0aGUgd29ybGQuCiAgICAgKiBUaGUgbW9yZSBpdGVyYXRpb25zLCB0aGUgbW9yZSBjb3JyZWN0IHNpbXVsYXRpb24uIE1vcmUgaXRlcmF0aW9ucyBuZWVkIG1vcmUgY29tcHV0YXRpb25zIHRob3VnaC4gSWYgeW91IGhhdmUgYSBsYXJnZSBncmF2aXR5IGZvcmNlIGluIHlvdXIgd29ybGQsIHlvdSB3aWxsIG5lZWQgbW9yZSBpdGVyYXRpb25zLgogICAgICovCgogICAgLyoqCiAgICAgKiBXaGVuIHRvbGVyYW5jZSBpcyByZWFjaGVkLCB0aGUgc3lzdGVtIGlzIGFzc3VtZWQgdG8gYmUgY29udmVyZ2VkLgogICAgICovCgogICAgLyoqCiAgICAgKiBAdG9kbyByZW1vdmUgdXNlbGVzcyBjb25zdHJ1Y3RvcgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5pdGVyYXRpb25zID0gMTA7CiAgICAgIHRoaXMudG9sZXJhbmNlID0gMWUtNzsKICAgIH0KICAgIC8qKgogICAgICogU29sdmUKICAgICAqIEByZXR1cm4gbnVtYmVyIG9mIGl0ZXJhdGlvbnMgcGVyZm9ybWVkCiAgICAgKi8KCgogICAgc29sdmUoZHQsIHdvcmxkKSB7CiAgICAgIGxldCBpdGVyID0gMDsKICAgICAgY29uc3QgbWF4SXRlciA9IHRoaXMuaXRlcmF0aW9uczsKICAgICAgY29uc3QgdG9sU3F1YXJlZCA9IHRoaXMudG9sZXJhbmNlICogdGhpcy50b2xlcmFuY2U7CiAgICAgIGNvbnN0IGVxdWF0aW9ucyA9IHRoaXMuZXF1YXRpb25zOwogICAgICBjb25zdCBOZXEgPSBlcXVhdGlvbnMubGVuZ3RoOwogICAgICBjb25zdCBib2RpZXMgPSB3b3JsZC5ib2RpZXM7CiAgICAgIGNvbnN0IE5ib2RpZXMgPSBib2RpZXMubGVuZ3RoOwogICAgICBjb25zdCBoID0gZHQ7CiAgICAgIGxldCBCOwogICAgICBsZXQgaW52QzsKICAgICAgbGV0IGRlbHRhbGFtYmRhOwogICAgICBsZXQgZGVsdGFsYW1iZGFUb3Q7CiAgICAgIGxldCBHV2xhbWJkYTsKICAgICAgbGV0IGxhbWJkYWo7IC8vIFVwZGF0ZSBzb2x2ZSBtYXNzCgogICAgICBpZiAoTmVxICE9PSAwKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5ib2RpZXM7IGkrKykgewogICAgICAgICAgYm9kaWVzW2ldLnVwZGF0ZVNvbHZlTWFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB9CiAgICAgIH0gLy8gVGhpbmdzIHRoYXQgZG8gbm90IGNoYW5nZSBkdXJpbmcgaXRlcmF0aW9uIGNhbiBiZSBjb21wdXRlZCBvbmNlCgoKICAgICAgY29uc3QgaW52Q3MgPSBHU1NvbHZlcl9zb2x2ZV9pbnZDczsKICAgICAgY29uc3QgQnMgPSBHU1NvbHZlcl9zb2x2ZV9CczsKICAgICAgY29uc3QgbGFtYmRhID0gR1NTb2x2ZXJfc29sdmVfbGFtYmRhOwogICAgICBpbnZDcy5sZW5ndGggPSBOZXE7CiAgICAgIEJzLmxlbmd0aCA9IE5lcTsKICAgICAgbGFtYmRhLmxlbmd0aCA9IE5lcTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBOZXE7IGkrKykgewogICAgICAgIGNvbnN0IGMgPSBlcXVhdGlvbnNbaV07CiAgICAgICAgbGFtYmRhW2ldID0gMC4wOwogICAgICAgIEJzW2ldID0gYy5jb21wdXRlQihoKTsKICAgICAgICBpbnZDc1tpXSA9IDEuMCAvIGMuY29tcHV0ZUMoKTsKICAgICAgfQoKICAgICAgaWYgKE5lcSAhPT0gMCkgewogICAgICAgIC8vIFJlc2V0IHZsYW1iZGEKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTmJvZGllczsgaSsrKSB7CiAgICAgICAgICBjb25zdCBiID0gYm9kaWVzW2ldOwogICAgICAgICAgY29uc3QgdmxhbWJkYSA9IGIudmxhbWJkYTsKICAgICAgICAgIGNvbnN0IHdsYW1iZGEgPSBiLndsYW1iZGE7CiAgICAgICAgICB2bGFtYmRhLnNldCgwLCAwLCAwKTsKICAgICAgICAgIHdsYW1iZGEuc2V0KDAsIDAsIDApOwogICAgICAgIH0gLy8gSXRlcmF0ZSBvdmVyIGVxdWF0aW9ucwoKCiAgICAgICAgZm9yIChpdGVyID0gMDsgaXRlciAhPT0gbWF4SXRlcjsgaXRlcisrKSB7CiAgICAgICAgICAvLyBBY2N1bXVsYXRlIHRoZSB0b3RhbCBlcnJvciBmb3IgZWFjaCBpdGVyYXRpb24uCiAgICAgICAgICBkZWx0YWxhbWJkYVRvdCA9IDAuMDsKCiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiAhPT0gTmVxOyBqKyspIHsKICAgICAgICAgICAgY29uc3QgYyA9IGVxdWF0aW9uc1tqXTsgLy8gQ29tcHV0ZSBpdGVyYXRpb24KCiAgICAgICAgICAgIEIgPSBCc1tqXTsKICAgICAgICAgICAgaW52QyA9IGludkNzW2pdOwogICAgICAgICAgICBsYW1iZGFqID0gbGFtYmRhW2pdOwogICAgICAgICAgICBHV2xhbWJkYSA9IGMuY29tcHV0ZUdXbGFtYmRhKCk7CiAgICAgICAgICAgIGRlbHRhbGFtYmRhID0gaW52QyAqIChCIC0gR1dsYW1iZGEgLSBjLmVwcyAqIGxhbWJkYWopOyAvLyBDbGFtcCBpZiB3ZSBhcmUgbm90IHdpdGhpbiB0aGUgbWluL21heCBpbnRlcnZhbAoKICAgICAgICAgICAgaWYgKGxhbWJkYWogKyBkZWx0YWxhbWJkYSA8IGMubWluRm9yY2UpIHsKICAgICAgICAgICAgICBkZWx0YWxhbWJkYSA9IGMubWluRm9yY2UgLSBsYW1iZGFqOwogICAgICAgICAgICB9IGVsc2UgaWYgKGxhbWJkYWogKyBkZWx0YWxhbWJkYSA+IGMubWF4Rm9yY2UpIHsKICAgICAgICAgICAgICBkZWx0YWxhbWJkYSA9IGMubWF4Rm9yY2UgLSBsYW1iZGFqOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsYW1iZGFbal0gKz0gZGVsdGFsYW1iZGE7CiAgICAgICAgICAgIGRlbHRhbGFtYmRhVG90ICs9IGRlbHRhbGFtYmRhID4gMC4wID8gZGVsdGFsYW1iZGEgOiAtZGVsdGFsYW1iZGE7IC8vIGFicyhkZWx0YWxhbWJkYSkKCiAgICAgICAgICAgIGMuYWRkVG9XbGFtYmRhKGRlbHRhbGFtYmRhKTsKICAgICAgICAgIH0gLy8gSWYgdGhlIHRvdGFsIGVycm9yIGlzIHNtYWxsIGVub3VnaCAtIHN0b3AgaXRlcmF0ZQoKCiAgICAgICAgICBpZiAoZGVsdGFsYW1iZGFUb3QgKiBkZWx0YWxhbWJkYVRvdCA8IHRvbFNxdWFyZWQpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBBZGQgcmVzdWx0IHRvIHZlbG9jaXR5CgoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTmJvZGllczsgaSsrKSB7CiAgICAgICAgICBjb25zdCBiID0gYm9kaWVzW2ldOwogICAgICAgICAgY29uc3QgdiA9IGIudmVsb2NpdHk7CiAgICAgICAgICBjb25zdCB3ID0gYi5hbmd1bGFyVmVsb2NpdHk7CiAgICAgICAgICBiLnZsYW1iZGEudm11bChiLmxpbmVhckZhY3RvciwgYi52bGFtYmRhKTsKICAgICAgICAgIHYudmFkZChiLnZsYW1iZGEsIHYpOwogICAgICAgICAgYi53bGFtYmRhLnZtdWwoYi5hbmd1bGFyRmFjdG9yLCBiLndsYW1iZGEpOwogICAgICAgICAgdy52YWRkKGIud2xhbWJkYSwgdyk7CiAgICAgICAgfSAvLyBTZXQgdGhlIGAubXVsdGlwbGllcmAgcHJvcGVydHkgb2YgZWFjaCBlcXVhdGlvbgoKCiAgICAgICAgbGV0IGwgPSBlcXVhdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGludkR0ID0gMSAvIGg7CgogICAgICAgIHdoaWxlIChsLS0pIHsKICAgICAgICAgIGVxdWF0aW9uc1tsXS5tdWx0aXBsaWVyID0gbGFtYmRhW2xdICogaW52RHQ7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaXRlcjsKICAgIH0KCiAgfSAvLyBKdXN0IHRlbXBvcmFyeSBudW1iZXIgaG9sZGVycyB0aGF0IHdlIHdhbnQgdG8gcmV1c2UgZWFjaCBpdGVyYXRpb24uCgogIGNvbnN0IEdTU29sdmVyX3NvbHZlX2xhbWJkYSA9IFtdOwogIGNvbnN0IEdTU29sdmVyX3NvbHZlX2ludkNzID0gW107CiAgY29uc3QgR1NTb2x2ZXJfc29sdmVfQnMgPSBbXTsKCiAgLyoqCiAgICogU3BsaXRzIHRoZSBlcXVhdGlvbnMgaW50byBpc2xhbmRzIGFuZCBzb2x2ZXMgdGhlbSBpbmRlcGVuZGVudGx5LiBDYW4gaW1wcm92ZSBwZXJmb3JtYW5jZS4KICAgKi8KICBjbGFzcyBTcGxpdFNvbHZlciBleHRlbmRzIFNvbHZlciB7CiAgICAvKioKICAgICAqIFRoZSBudW1iZXIgb2Ygc29sdmVyIGl0ZXJhdGlvbnMgZGV0ZXJtaW5lcyBxdWFsaXR5IG9mIHRoZSBjb25zdHJhaW50cyBpbiB0aGUgd29ybGQuIFRoZSBtb3JlIGl0ZXJhdGlvbnMsIHRoZSBtb3JlIGNvcnJlY3Qgc2ltdWxhdGlvbi4gTW9yZSBpdGVyYXRpb25zIG5lZWQgbW9yZSBjb21wdXRhdGlvbnMgdGhvdWdoLiBJZiB5b3UgaGF2ZSBhIGxhcmdlIGdyYXZpdHkgZm9yY2UgaW4geW91ciB3b3JsZCwgeW91IHdpbGwgbmVlZCBtb3JlIGl0ZXJhdGlvbnMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFdoZW4gdG9sZXJhbmNlIGlzIHJlYWNoZWQsIHRoZSBzeXN0ZW0gaXMgYXNzdW1lZCB0byBiZSBjb252ZXJnZWQuCiAgICAgKi8KCiAgICAvKiogc3Vic29sdmVyICovCiAgICBjb25zdHJ1Y3RvcihzdWJzb2x2ZXIpIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5pdGVyYXRpb25zID0gMTA7CiAgICAgIHRoaXMudG9sZXJhbmNlID0gMWUtNzsKICAgICAgdGhpcy5zdWJzb2x2ZXIgPSBzdWJzb2x2ZXI7CiAgICAgIHRoaXMubm9kZXMgPSBbXTsKICAgICAgdGhpcy5ub2RlUG9vbCA9IFtdOyAvLyBDcmVhdGUgbmVlZGVkIG5vZGVzLCByZXVzZSBpZiBwb3NzaWJsZQoKICAgICAgd2hpbGUgKHRoaXMubm9kZVBvb2wubGVuZ3RoIDwgMTI4KSB7CiAgICAgICAgdGhpcy5ub2RlUG9vbC5wdXNoKHRoaXMuY3JlYXRlTm9kZSgpKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBjcmVhdGVOb2RlCiAgICAgKi8KCgogICAgY3JlYXRlTm9kZSgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBib2R5OiBudWxsLAogICAgICAgIGNoaWxkcmVuOiBbXSwKICAgICAgICBlcXM6IFtdLAogICAgICAgIHZpc2l0ZWQ6IGZhbHNlCiAgICAgIH07CiAgICB9CiAgICAvKioKICAgICAqIFNvbHZlIHRoZSBzdWJzeXN0ZW1zCiAgICAgKiBAcmV0dXJuIG51bWJlciBvZiBpdGVyYXRpb25zIHBlcmZvcm1lZAogICAgICovCgoKICAgIHNvbHZlKGR0LCB3b3JsZCkgewogICAgICBjb25zdCBub2RlcyA9IFNwbGl0U29sdmVyX3NvbHZlX25vZGVzOwogICAgICBjb25zdCBub2RlUG9vbCA9IHRoaXMubm9kZVBvb2w7CiAgICAgIGNvbnN0IGJvZGllcyA9IHdvcmxkLmJvZGllczsKICAgICAgY29uc3QgZXF1YXRpb25zID0gdGhpcy5lcXVhdGlvbnM7CiAgICAgIGNvbnN0IE5lcSA9IGVxdWF0aW9ucy5sZW5ndGg7CiAgICAgIGNvbnN0IE5ib2RpZXMgPSBib2RpZXMubGVuZ3RoOwogICAgICBjb25zdCBzdWJzb2x2ZXIgPSB0aGlzLnN1YnNvbHZlcjsgLy8gQ3JlYXRlIG5lZWRlZCBub2RlcywgcmV1c2UgaWYgcG9zc2libGUKCiAgICAgIHdoaWxlIChub2RlUG9vbC5sZW5ndGggPCBOYm9kaWVzKSB7CiAgICAgICAgbm9kZVBvb2wucHVzaCh0aGlzLmNyZWF0ZU5vZGUoKSk7CiAgICAgIH0KCiAgICAgIG5vZGVzLmxlbmd0aCA9IE5ib2RpZXM7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE5ib2RpZXM7IGkrKykgewogICAgICAgIG5vZGVzW2ldID0gbm9kZVBvb2xbaV07CiAgICAgIH0gLy8gUmVzZXQgbm9kZSB2YWx1ZXMKCgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTmJvZGllczsgaSsrKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldOwogICAgICAgIG5vZGUuYm9keSA9IGJvZGllc1tpXTsKICAgICAgICBub2RlLmNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgICAgICAgbm9kZS5lcXMubGVuZ3RoID0gMDsKICAgICAgICBub2RlLnZpc2l0ZWQgPSBmYWxzZTsKICAgICAgfQoKICAgICAgZm9yIChsZXQgayA9IDA7IGsgIT09IE5lcTsgaysrKSB7CiAgICAgICAgY29uc3QgZXEgPSBlcXVhdGlvbnNba107CiAgICAgICAgY29uc3QgaSA9IGJvZGllcy5pbmRleE9mKGVxLmJpKTsKICAgICAgICBjb25zdCBqID0gYm9kaWVzLmluZGV4T2YoZXEuYmopOwogICAgICAgIGNvbnN0IG5pID0gbm9kZXNbaV07CiAgICAgICAgY29uc3QgbmogPSBub2Rlc1tqXTsKICAgICAgICBuaS5jaGlsZHJlbi5wdXNoKG5qKTsKICAgICAgICBuaS5lcXMucHVzaChlcSk7CiAgICAgICAgbmouY2hpbGRyZW4ucHVzaChuaSk7CiAgICAgICAgbmouZXFzLnB1c2goZXEpOwogICAgICB9CgogICAgICBsZXQgY2hpbGQ7CiAgICAgIGxldCBuID0gMDsKICAgICAgbGV0IGVxcyA9IFNwbGl0U29sdmVyX3NvbHZlX2VxczsKICAgICAgc3Vic29sdmVyLnRvbGVyYW5jZSA9IHRoaXMudG9sZXJhbmNlOwogICAgICBzdWJzb2x2ZXIuaXRlcmF0aW9ucyA9IHRoaXMuaXRlcmF0aW9uczsKICAgICAgY29uc3QgZHVtbXlXb3JsZCA9IFNwbGl0U29sdmVyX3NvbHZlX2R1bW15V29ybGQ7CgogICAgICB3aGlsZSAoY2hpbGQgPSBnZXRVbnZpc2l0ZWROb2RlKG5vZGVzKSkgewogICAgICAgIGVxcy5sZW5ndGggPSAwOwogICAgICAgIGR1bW15V29ybGQuYm9kaWVzLmxlbmd0aCA9IDA7CiAgICAgICAgYmZzKGNoaWxkLCB2aXNpdEZ1bmMsIGR1bW15V29ybGQuYm9kaWVzLCBlcXMpOwogICAgICAgIGNvbnN0IE5lcXMgPSBlcXMubGVuZ3RoOwogICAgICAgIGVxcyA9IGVxcy5zb3J0KHNvcnRCeUlkKTsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5lcXM7IGkrKykgewogICAgICAgICAgc3Vic29sdmVyLmFkZEVxdWF0aW9uKGVxc1tpXSk7CiAgICAgICAgfQoKICAgICAgICBzdWJzb2x2ZXIuc29sdmUoZHQsIGR1bW15V29ybGQpOwogICAgICAgIHN1YnNvbHZlci5yZW1vdmVBbGxFcXVhdGlvbnMoKTsKICAgICAgICBuKys7CiAgICAgIH0KCiAgICAgIHJldHVybiBuOwogICAgfQoKICB9IC8vIFJldHVybnMgdGhlIG51bWJlciBvZiBzdWJzeXN0ZW1zCgogIGNvbnN0IFNwbGl0U29sdmVyX3NvbHZlX25vZGVzID0gW107IC8vIEFsbCBhbGxvY2F0ZWQgbm9kZSBvYmplY3RzCgogIGNvbnN0IFNwbGl0U29sdmVyX3NvbHZlX2VxcyA9IFtdOyAvLyBUZW1wIGFycmF5CgogIGNvbnN0IFNwbGl0U29sdmVyX3NvbHZlX2R1bW15V29ybGQgPSB7CiAgICBib2RpZXM6IFtdCiAgfTsgLy8gVGVtcCBvYmplY3QKCiAgY29uc3QgU1RBVElDID0gQm9keS5TVEFUSUM7CgogIGZ1bmN0aW9uIGdldFVudmlzaXRlZE5vZGUobm9kZXMpIHsKICAgIGNvbnN0IE5ub2RlcyA9IG5vZGVzLmxlbmd0aDsKCiAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTm5vZGVzOyBpKyspIHsKICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldOwoKICAgICAgaWYgKCFub2RlLnZpc2l0ZWQgJiYgIShub2RlLmJvZHkudHlwZSAmIFNUQVRJQykpIHsKICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGNvbnN0IHF1ZXVlID0gW107CgogIGZ1bmN0aW9uIGJmcyhyb290LCB2aXNpdEZ1bmMsIGJkcywgZXFzKSB7CiAgICBxdWV1ZS5wdXNoKHJvb3QpOwogICAgcm9vdC52aXNpdGVkID0gdHJ1ZTsKICAgIHZpc2l0RnVuYyhyb290LCBiZHMsIGVxcyk7CgogICAgd2hpbGUgKHF1ZXVlLmxlbmd0aCkgewogICAgICBjb25zdCBub2RlID0gcXVldWUucG9wKCk7IC8vIExvb3Agb3ZlciB1bnZpc2l0ZWQgY2hpbGQgbm9kZXMKCiAgICAgIGxldCBjaGlsZDsKCiAgICAgIHdoaWxlIChjaGlsZCA9IGdldFVudmlzaXRlZE5vZGUobm9kZS5jaGlsZHJlbikpIHsKICAgICAgICBjaGlsZC52aXNpdGVkID0gdHJ1ZTsKICAgICAgICB2aXNpdEZ1bmMoY2hpbGQsIGJkcywgZXFzKTsKICAgICAgICBxdWV1ZS5wdXNoKGNoaWxkKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gdmlzaXRGdW5jKG5vZGUsIGJkcywgZXFzKSB7CiAgICBiZHMucHVzaChub2RlLmJvZHkpOwogICAgY29uc3QgTmVxcyA9IG5vZGUuZXFzLmxlbmd0aDsKCiAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTmVxczsgaSsrKSB7CiAgICAgIGNvbnN0IGVxID0gbm9kZS5lcXNbaV07CgogICAgICBpZiAoIWVxcy5pbmNsdWRlcyhlcSkpIHsKICAgICAgICBlcXMucHVzaChlcSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHNvcnRCeUlkKGEsIGIpIHsKICAgIHJldHVybiBiLmlkIC0gYS5pZDsKICB9CgogIC8qKgogICAqIEZvciBwb29saW5nIG9iamVjdHMgdGhhdCBjYW4gYmUgcmV1c2VkLgogICAqLwogIGNsYXNzIFBvb2wgewogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHRoaXMub2JqZWN0cyA9IFtdOwogICAgICB0aGlzLnR5cGUgPSBPYmplY3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZWxlYXNlIGFuIG9iamVjdCBhZnRlciB1c2UKICAgICAqLwogICAgcmVsZWFzZSgpIHsKICAgICAgY29uc3QgTmFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5hcmdzOyBpKyspIHsKICAgICAgICB0aGlzLm9iamVjdHMucHVzaChpIDwgMCB8fCBhcmd1bWVudHMubGVuZ3RoIDw9IGkgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbaV0pOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGFuIG9iamVjdAogICAgICovCgoKICAgIGdldCgpIHsKICAgICAgaWYgKHRoaXMub2JqZWN0cy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3RPYmplY3QoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5vYmplY3RzLnBvcCgpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENvbnN0cnVjdCBhbiBvYmplY3QuIFNob3VsZCBiZSBpbXBsZW1lbnRlZCBpbiBlYWNoIHN1YmNsYXNzLgogICAgICovCgoKICAgIGNvbnN0cnVjdE9iamVjdCgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdjb25zdHJ1Y3RPYmplY3QoKSBub3QgaW1wbGVtZW50ZWQgaW4gdGhpcyBQb29sIHN1YmNsYXNzIHlldCEnKTsKICAgIH0KICAgIC8qKgogICAgICogQHJldHVybiBTZWxmLCBmb3IgY2hhaW5pbmcKICAgICAqLwoKCiAgICByZXNpemUoc2l6ZSkgewogICAgICBjb25zdCBvYmplY3RzID0gdGhpcy5vYmplY3RzOwoKICAgICAgd2hpbGUgKG9iamVjdHMubGVuZ3RoID4gc2l6ZSkgewogICAgICAgIG9iamVjdHMucG9wKCk7CiAgICAgIH0KCiAgICAgIHdoaWxlIChvYmplY3RzLmxlbmd0aCA8IHNpemUpIHsKICAgICAgICBvYmplY3RzLnB1c2godGhpcy5jb25zdHJ1Y3RPYmplY3QoKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICB9CgogIC8qKgogICAqIFZlYzNQb29sCiAgICovCgogIGNsYXNzIFZlYzNQb29sIGV4dGVuZHMgUG9vbCB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgdGhpcy50eXBlID0gVmVjMzsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnN0cnVjdCBhIHZlY3RvcgogICAgICovCiAgICBjb25zdHJ1Y3RPYmplY3QoKSB7CiAgICAgIHJldHVybiBuZXcgVmVjMygpOwogICAgfQoKICB9CgogIC8vIE5hbWluZyBydWxlOiBiYXNlZCBvZiB0aGUgb3JkZXIgaW4gU0hBUEVfVFlQRVMsCiAgLy8gdGhlIGZpcnN0IHBhcnQgb2YgdGhlIG1ldGhvZCBpcyBmb3JtZWQgYnkgdGhlCiAgLy8gc2hhcGUgdHlwZSB0aGF0IGNvbWVzIGJlZm9yZSwgaW4gdGhlIHNlY29uZCBwYXJ0CiAgLy8gdGhlcmUgaXMgdGhlIHNoYXBlIHR5cGUgdGhhdCBjb21lcyBhZnRlciBpbiB0aGUgU0hBUEVfVFlQRVMgbGlzdAogIGNvbnN0IENPTExJU0lPTl9UWVBFUyA9IHsKICAgIHNwaGVyZVNwaGVyZTogU2hhcGUudHlwZXMuU1BIRVJFLAogICAgc3BoZXJlUGxhbmU6IFNoYXBlLnR5cGVzLlNQSEVSRSB8IFNoYXBlLnR5cGVzLlBMQU5FLAogICAgYm94Qm94OiBTaGFwZS50eXBlcy5CT1ggfCBTaGFwZS50eXBlcy5CT1gsCiAgICBzcGhlcmVCb3g6IFNoYXBlLnR5cGVzLlNQSEVSRSB8IFNoYXBlLnR5cGVzLkJPWCwKICAgIHBsYW5lQm94OiBTaGFwZS50eXBlcy5QTEFORSB8IFNoYXBlLnR5cGVzLkJPWCwKICAgIGNvbnZleENvbnZleDogU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiwKICAgIHNwaGVyZUNvbnZleDogU2hhcGUudHlwZXMuU1BIRVJFIHwgU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiwKICAgIHBsYW5lQ29udmV4OiBTaGFwZS50eXBlcy5QTEFORSB8IFNoYXBlLnR5cGVzLkNPTlZFWFBPTFlIRURST04sCiAgICBib3hDb252ZXg6IFNoYXBlLnR5cGVzLkJPWCB8IFNoYXBlLnR5cGVzLkNPTlZFWFBPTFlIRURST04sCiAgICBzcGhlcmVIZWlnaHRmaWVsZDogU2hhcGUudHlwZXMuU1BIRVJFIHwgU2hhcGUudHlwZXMuSEVJR0hURklFTEQsCiAgICBib3hIZWlnaHRmaWVsZDogU2hhcGUudHlwZXMuQk9YIHwgU2hhcGUudHlwZXMuSEVJR0hURklFTEQsCiAgICBjb252ZXhIZWlnaHRmaWVsZDogU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiB8IFNoYXBlLnR5cGVzLkhFSUdIVEZJRUxELAogICAgc3BoZXJlUGFydGljbGU6IFNoYXBlLnR5cGVzLlBBUlRJQ0xFIHwgU2hhcGUudHlwZXMuU1BIRVJFLAogICAgcGxhbmVQYXJ0aWNsZTogU2hhcGUudHlwZXMuUExBTkUgfCBTaGFwZS50eXBlcy5QQVJUSUNMRSwKICAgIGJveFBhcnRpY2xlOiBTaGFwZS50eXBlcy5CT1ggfCBTaGFwZS50eXBlcy5QQVJUSUNMRSwKICAgIGNvbnZleFBhcnRpY2xlOiBTaGFwZS50eXBlcy5QQVJUSUNMRSB8IFNoYXBlLnR5cGVzLkNPTlZFWFBPTFlIRURST04sCiAgICBjeWxpbmRlckN5bGluZGVyOiBTaGFwZS50eXBlcy5DWUxJTkRFUiwKICAgIHNwaGVyZUN5bGluZGVyOiBTaGFwZS50eXBlcy5TUEhFUkUgfCBTaGFwZS50eXBlcy5DWUxJTkRFUiwKICAgIHBsYW5lQ3lsaW5kZXI6IFNoYXBlLnR5cGVzLlBMQU5FIHwgU2hhcGUudHlwZXMuQ1lMSU5ERVIsCiAgICBib3hDeWxpbmRlcjogU2hhcGUudHlwZXMuQk9YIHwgU2hhcGUudHlwZXMuQ1lMSU5ERVIsCiAgICBjb252ZXhDeWxpbmRlcjogU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiB8IFNoYXBlLnR5cGVzLkNZTElOREVSLAogICAgaGVpZ2h0ZmllbGRDeWxpbmRlcjogU2hhcGUudHlwZXMuSEVJR0hURklFTEQgfCBTaGFwZS50eXBlcy5DWUxJTkRFUiwKICAgIHBhcnRpY2xlQ3lsaW5kZXI6IFNoYXBlLnR5cGVzLlBBUlRJQ0xFIHwgU2hhcGUudHlwZXMuQ1lMSU5ERVIsCiAgICBzcGhlcmVUcmltZXNoOiBTaGFwZS50eXBlcy5TUEhFUkUgfCBTaGFwZS50eXBlcy5UUklNRVNILAogICAgcGxhbmVUcmltZXNoOiBTaGFwZS50eXBlcy5QTEFORSB8IFNoYXBlLnR5cGVzLlRSSU1FU0gKICB9OwoKICAvKioKICAgKiBIZWxwZXIgY2xhc3MgZm9yIHRoZSBXb3JsZC4gR2VuZXJhdGVzIENvbnRhY3RFcXVhdGlvbnMuCiAgICogQHRvZG8gU3BoZXJlLUNvbnZleFBvbHloZWRyb24gY29udGFjdHMKICAgKiBAdG9kbyBDb250YWN0IHJlZHVjdGlvbgogICAqIEB0b2RvIHNob3VsZCBtb3ZlIG1ldGhvZHMgdG8gcHJvdG90eXBlCiAgICovCiAgY2xhc3MgTmFycm93cGhhc2UgewogICAgLyoqCiAgICAgKiBJbnRlcm5hbCBzdG9yYWdlIG9mIHBvb2xlZCBjb250YWN0IHBvaW50cy4KICAgICAqLwoKICAgIC8qKgogICAgICogUG9vbGVkIHZlY3RvcnMuCiAgICAgKi8KICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnNwaGVyZVNwaGVyZV0oKSB7CiAgICAgIHJldHVybiB0aGlzLnNwaGVyZVNwaGVyZTsKICAgIH0KCiAgICBnZXQgW0NPTExJU0lPTl9UWVBFUy5zcGhlcmVQbGFuZV0oKSB7CiAgICAgIHJldHVybiB0aGlzLnNwaGVyZVBsYW5lOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLmJveEJveF0oKSB7CiAgICAgIHJldHVybiB0aGlzLmJveEJveDsKICAgIH0KCiAgICBnZXQgW0NPTExJU0lPTl9UWVBFUy5zcGhlcmVCb3hdKCkgewogICAgICByZXR1cm4gdGhpcy5zcGhlcmVCb3g7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMucGxhbmVCb3hdKCkgewogICAgICByZXR1cm4gdGhpcy5wbGFuZUJveDsKICAgIH0KCiAgICBnZXQgW0NPTExJU0lPTl9UWVBFUy5jb252ZXhDb252ZXhdKCkgewogICAgICByZXR1cm4gdGhpcy5jb252ZXhDb252ZXg7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMuc3BoZXJlQ29udmV4XSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3BoZXJlQ29udmV4OwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnBsYW5lQ29udmV4XSgpIHsKICAgICAgcmV0dXJuIHRoaXMucGxhbmVDb252ZXg7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMuYm94Q29udmV4XSgpIHsKICAgICAgcmV0dXJuIHRoaXMuYm94Q29udmV4OwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnNwaGVyZUhlaWdodGZpZWxkXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3BoZXJlSGVpZ2h0ZmllbGQ7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMuYm94SGVpZ2h0ZmllbGRdKCkgewogICAgICByZXR1cm4gdGhpcy5ib3hIZWlnaHRmaWVsZDsKICAgIH0KCiAgICBnZXQgW0NPTExJU0lPTl9UWVBFUy5jb252ZXhIZWlnaHRmaWVsZF0oKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbnZleEhlaWdodGZpZWxkOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnNwaGVyZVBhcnRpY2xlXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3BoZXJlUGFydGljbGU7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMucGxhbmVQYXJ0aWNsZV0oKSB7CiAgICAgIHJldHVybiB0aGlzLnBsYW5lUGFydGljbGU7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMuYm94UGFydGljbGVdKCkgewogICAgICByZXR1cm4gdGhpcy5ib3hQYXJ0aWNsZTsKICAgIH0KCiAgICBnZXQgW0NPTExJU0lPTl9UWVBFUy5jb252ZXhQYXJ0aWNsZV0oKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbnZleFBhcnRpY2xlOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLmN5bGluZGVyQ3lsaW5kZXJdKCkgewogICAgICByZXR1cm4gdGhpcy5jb252ZXhDb252ZXg7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMuc3BoZXJlQ3lsaW5kZXJdKCkgewogICAgICByZXR1cm4gdGhpcy5zcGhlcmVDb252ZXg7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMucGxhbmVDeWxpbmRlcl0oKSB7CiAgICAgIHJldHVybiB0aGlzLnBsYW5lQ29udmV4OwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLmJveEN5bGluZGVyXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuYm94Q29udmV4OwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLmNvbnZleEN5bGluZGVyXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuY29udmV4Q29udmV4OwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLmhlaWdodGZpZWxkQ3lsaW5kZXJdKCkgewogICAgICByZXR1cm4gdGhpcy5oZWlnaHRmaWVsZEN5bGluZGVyOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnBhcnRpY2xlQ3lsaW5kZXJdKCkgewogICAgICByZXR1cm4gdGhpcy5wYXJ0aWNsZUN5bGluZGVyOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnNwaGVyZVRyaW1lc2hdKCkgewogICAgICByZXR1cm4gdGhpcy5zcGhlcmVUcmltZXNoOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnBsYW5lVHJpbWVzaF0oKSB7CiAgICAgIHJldHVybiB0aGlzLnBsYW5lVHJpbWVzaDsKICAgIH0gLy8gZ2V0IFtDT0xMSVNJT05fVFlQRVMuY29udmV4VHJpbWVzaF0oKSB7CiAgICAvLyAgIHJldHVybiB0aGlzLmNvbnZleFRyaW1lc2gKICAgIC8vIH0KCgogICAgY29uc3RydWN0b3Iod29ybGQpIHsKICAgICAgdGhpcy5jb250YWN0UG9pbnRQb29sID0gW107CiAgICAgIHRoaXMuZnJpY3Rpb25FcXVhdGlvblBvb2wgPSBbXTsKICAgICAgdGhpcy5yZXN1bHQgPSBbXTsKICAgICAgdGhpcy5mcmljdGlvblJlc3VsdCA9IFtdOwogICAgICB0aGlzLnYzcG9vbCA9IG5ldyBWZWMzUG9vbCgpOwogICAgICB0aGlzLndvcmxkID0gd29ybGQ7CiAgICAgIHRoaXMuY3VycmVudENvbnRhY3RNYXRlcmlhbCA9IHdvcmxkLmRlZmF1bHRDb250YWN0TWF0ZXJpYWw7CiAgICAgIHRoaXMuZW5hYmxlRnJpY3Rpb25SZWR1Y3Rpb24gPSBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogTWFrZSBhIGNvbnRhY3Qgb2JqZWN0LCBieSB1c2luZyB0aGUgaW50ZXJuYWwgcG9vbCBvciBjcmVhdGluZyBhIG5ldyBvbmUuCiAgICAgKi8KCgogICAgY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCBvdmVycmlkZVNoYXBlQSwgb3ZlcnJpZGVTaGFwZUIpIHsKICAgICAgbGV0IGM7CgogICAgICBpZiAodGhpcy5jb250YWN0UG9pbnRQb29sLmxlbmd0aCkgewogICAgICAgIGMgPSB0aGlzLmNvbnRhY3RQb2ludFBvb2wucG9wKCk7CiAgICAgICAgYy5iaSA9IGJpOwogICAgICAgIGMuYmogPSBiajsKICAgICAgfSBlbHNlIHsKICAgICAgICBjID0gbmV3IENvbnRhY3RFcXVhdGlvbihiaSwgYmopOwogICAgICB9CgogICAgICBjLmVuYWJsZWQgPSBiaS5jb2xsaXNpb25SZXNwb25zZSAmJiBiai5jb2xsaXNpb25SZXNwb25zZSAmJiBzaS5jb2xsaXNpb25SZXNwb25zZSAmJiBzai5jb2xsaXNpb25SZXNwb25zZTsKICAgICAgY29uc3QgY20gPSB0aGlzLmN1cnJlbnRDb250YWN0TWF0ZXJpYWw7CiAgICAgIGMucmVzdGl0dXRpb24gPSBjbS5yZXN0aXR1dGlvbjsKICAgICAgYy5zZXRTcG9va1BhcmFtcyhjbS5jb250YWN0RXF1YXRpb25TdGlmZm5lc3MsIGNtLmNvbnRhY3RFcXVhdGlvblJlbGF4YXRpb24sIHRoaXMud29ybGQuZHQpOwogICAgICBjb25zdCBtYXRBID0gc2kubWF0ZXJpYWwgfHwgYmkubWF0ZXJpYWw7CiAgICAgIGNvbnN0IG1hdEIgPSBzai5tYXRlcmlhbCB8fCBiai5tYXRlcmlhbDsKCiAgICAgIGlmIChtYXRBICYmIG1hdEIgJiYgbWF0QS5yZXN0aXR1dGlvbiA+PSAwICYmIG1hdEIucmVzdGl0dXRpb24gPj0gMCkgewogICAgICAgIGMucmVzdGl0dXRpb24gPSBtYXRBLnJlc3RpdHV0aW9uICogbWF0Qi5yZXN0aXR1dGlvbjsKICAgICAgfQoKICAgICAgYy5zaSA9IG92ZXJyaWRlU2hhcGVBIHx8IHNpOwogICAgICBjLnNqID0gb3ZlcnJpZGVTaGFwZUIgfHwgc2o7CiAgICAgIHJldHVybiBjOwogICAgfQoKICAgIGNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QoY29udGFjdEVxdWF0aW9uLCBvdXRBcnJheSkgewogICAgICBjb25zdCBib2R5QSA9IGNvbnRhY3RFcXVhdGlvbi5iaTsKICAgICAgY29uc3QgYm9keUIgPSBjb250YWN0RXF1YXRpb24uYmo7CiAgICAgIGNvbnN0IHNoYXBlQSA9IGNvbnRhY3RFcXVhdGlvbi5zaTsKICAgICAgY29uc3Qgc2hhcGVCID0gY29udGFjdEVxdWF0aW9uLnNqOwogICAgICBjb25zdCB3b3JsZCA9IHRoaXMud29ybGQ7CiAgICAgIGNvbnN0IGNtID0gdGhpcy5jdXJyZW50Q29udGFjdE1hdGVyaWFsOyAvLyBJZiBmcmljdGlvbiBvciByZXN0aXR1dGlvbiB3ZXJlIHNwZWNpZmllZCBpbiB0aGUgbWF0ZXJpYWwsIHVzZSB0aGVtCgogICAgICBsZXQgZnJpY3Rpb24gPSBjbS5mcmljdGlvbjsKICAgICAgY29uc3QgbWF0QSA9IHNoYXBlQS5tYXRlcmlhbCB8fCBib2R5QS5tYXRlcmlhbDsKICAgICAgY29uc3QgbWF0QiA9IHNoYXBlQi5tYXRlcmlhbCB8fCBib2R5Qi5tYXRlcmlhbDsKCiAgICAgIGlmIChtYXRBICYmIG1hdEIgJiYgbWF0QS5mcmljdGlvbiA+PSAwICYmIG1hdEIuZnJpY3Rpb24gPj0gMCkgewogICAgICAgIGZyaWN0aW9uID0gbWF0QS5mcmljdGlvbiAqIG1hdEIuZnJpY3Rpb247CiAgICAgIH0KCiAgICAgIGlmIChmcmljdGlvbiA+IDApIHsKICAgICAgICAvLyBDcmVhdGUgMiB0YW5nZW50IGVxdWF0aW9ucwogICAgICAgIC8vIFVzZXJzIG1heSBwcm92aWRlIGEgZm9yY2UgZGlmZmVyZW50IGZyb20gZ2xvYmFsIGdyYXZpdHkgdG8gdXNlIHdoZW4gY29tcHV0aW5nIGNvbnRhY3QgZnJpY3Rpb24uCiAgICAgICAgY29uc3QgbXVnID0gZnJpY3Rpb24gKiAod29ybGQuZnJpY3Rpb25HcmF2aXR5IHx8IHdvcmxkLmdyYXZpdHkpLmxlbmd0aCgpOwogICAgICAgIGxldCByZWR1Y2VkTWFzcyA9IGJvZHlBLmludk1hc3MgKyBib2R5Qi5pbnZNYXNzOwoKICAgICAgICBpZiAocmVkdWNlZE1hc3MgPiAwKSB7CiAgICAgICAgICByZWR1Y2VkTWFzcyA9IDEgLyByZWR1Y2VkTWFzczsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHBvb2wgPSB0aGlzLmZyaWN0aW9uRXF1YXRpb25Qb29sOwogICAgICAgIGNvbnN0IGMxID0gcG9vbC5sZW5ndGggPyBwb29sLnBvcCgpIDogbmV3IEZyaWN0aW9uRXF1YXRpb24oYm9keUEsIGJvZHlCLCBtdWcgKiByZWR1Y2VkTWFzcyk7CiAgICAgICAgY29uc3QgYzIgPSBwb29sLmxlbmd0aCA/IHBvb2wucG9wKCkgOiBuZXcgRnJpY3Rpb25FcXVhdGlvbihib2R5QSwgYm9keUIsIG11ZyAqIHJlZHVjZWRNYXNzKTsKICAgICAgICBjMS5iaSA9IGMyLmJpID0gYm9keUE7CiAgICAgICAgYzEuYmogPSBjMi5iaiA9IGJvZHlCOwogICAgICAgIGMxLm1pbkZvcmNlID0gYzIubWluRm9yY2UgPSAtbXVnICogcmVkdWNlZE1hc3M7CiAgICAgICAgYzEubWF4Rm9yY2UgPSBjMi5tYXhGb3JjZSA9IG11ZyAqIHJlZHVjZWRNYXNzOyAvLyBDb3B5IG92ZXIgdGhlIHJlbGF0aXZlIHZlY3RvcnMKCiAgICAgICAgYzEucmkuY29weShjb250YWN0RXF1YXRpb24ucmkpOwogICAgICAgIGMxLnJqLmNvcHkoY29udGFjdEVxdWF0aW9uLnJqKTsKICAgICAgICBjMi5yaS5jb3B5KGNvbnRhY3RFcXVhdGlvbi5yaSk7CiAgICAgICAgYzIucmouY29weShjb250YWN0RXF1YXRpb24ucmopOyAvLyBDb25zdHJ1Y3QgdGFuZ2VudHMKCiAgICAgICAgY29udGFjdEVxdWF0aW9uLm5pLnRhbmdlbnRzKGMxLnQsIGMyLnQpOyAvLyBTZXQgc3Bvb2sgcGFyYW1zCgogICAgICAgIGMxLnNldFNwb29rUGFyYW1zKGNtLmZyaWN0aW9uRXF1YXRpb25TdGlmZm5lc3MsIGNtLmZyaWN0aW9uRXF1YXRpb25SZWxheGF0aW9uLCB3b3JsZC5kdCk7CiAgICAgICAgYzIuc2V0U3Bvb2tQYXJhbXMoY20uZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcywgY20uZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb24sIHdvcmxkLmR0KTsKICAgICAgICBjMS5lbmFibGVkID0gYzIuZW5hYmxlZCA9IGNvbnRhY3RFcXVhdGlvbi5lbmFibGVkOwogICAgICAgIG91dEFycmF5LnB1c2goYzEsIGMyKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLyoqCiAgICAgKiBUYWtlIHRoZSBhdmVyYWdlIE4gbGF0ZXN0IGNvbnRhY3QgcG9pbnQgb24gdGhlIHBsYW5lLgogICAgICovCgoKICAgIGNyZWF0ZUZyaWN0aW9uRnJvbUF2ZXJhZ2UobnVtQ29udGFjdHMpIHsKICAgICAgLy8gVGhlIGxhc3QgY29udGFjdEVxdWF0aW9uCiAgICAgIGxldCBjID0gdGhpcy5yZXN1bHRbdGhpcy5yZXN1bHQubGVuZ3RoIC0gMV07IC8vIENyZWF0ZSB0aGUgcmVzdWx0OiB0d28gImF2ZXJhZ2UiIGZyaWN0aW9uIGVxdWF0aW9ucwoKICAgICAgaWYgKCF0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QoYywgdGhpcy5mcmljdGlvblJlc3VsdCkgfHwgbnVtQ29udGFjdHMgPT09IDEpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IGYxID0gdGhpcy5mcmljdGlvblJlc3VsdFt0aGlzLmZyaWN0aW9uUmVzdWx0Lmxlbmd0aCAtIDJdOwogICAgICBjb25zdCBmMiA9IHRoaXMuZnJpY3Rpb25SZXN1bHRbdGhpcy5mcmljdGlvblJlc3VsdC5sZW5ndGggLSAxXTsKICAgICAgYXZlcmFnZU5vcm1hbC5zZXRaZXJvKCk7CiAgICAgIGF2ZXJhZ2VDb250YWN0UG9pbnRBLnNldFplcm8oKTsKICAgICAgYXZlcmFnZUNvbnRhY3RQb2ludEIuc2V0WmVybygpOwogICAgICBjb25zdCBib2R5QSA9IGMuYmk7CiAgICAgIGMuYmo7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gbnVtQ29udGFjdHM7IGkrKykgewogICAgICAgIGMgPSB0aGlzLnJlc3VsdFt0aGlzLnJlc3VsdC5sZW5ndGggLSAxIC0gaV07CgogICAgICAgIGlmIChjLmJpICE9PSBib2R5QSkgewogICAgICAgICAgYXZlcmFnZU5vcm1hbC52YWRkKGMubmksIGF2ZXJhZ2VOb3JtYWwpOwogICAgICAgICAgYXZlcmFnZUNvbnRhY3RQb2ludEEudmFkZChjLnJpLCBhdmVyYWdlQ29udGFjdFBvaW50QSk7CiAgICAgICAgICBhdmVyYWdlQ29udGFjdFBvaW50Qi52YWRkKGMucmosIGF2ZXJhZ2VDb250YWN0UG9pbnRCKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXZlcmFnZU5vcm1hbC52c3ViKGMubmksIGF2ZXJhZ2VOb3JtYWwpOwogICAgICAgICAgYXZlcmFnZUNvbnRhY3RQb2ludEEudmFkZChjLnJqLCBhdmVyYWdlQ29udGFjdFBvaW50QSk7CiAgICAgICAgICBhdmVyYWdlQ29udGFjdFBvaW50Qi52YWRkKGMucmksIGF2ZXJhZ2VDb250YWN0UG9pbnRCKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGludk51bUNvbnRhY3RzID0gMSAvIG51bUNvbnRhY3RzOwogICAgICBhdmVyYWdlQ29udGFjdFBvaW50QS5zY2FsZShpbnZOdW1Db250YWN0cywgZjEucmkpOwogICAgICBhdmVyYWdlQ29udGFjdFBvaW50Qi5zY2FsZShpbnZOdW1Db250YWN0cywgZjEucmopOwogICAgICBmMi5yaS5jb3B5KGYxLnJpKTsgLy8gU2hvdWxkIGJlIHRoZSBzYW1lCgogICAgICBmMi5yai5jb3B5KGYxLnJqKTsKICAgICAgYXZlcmFnZU5vcm1hbC5ub3JtYWxpemUoKTsKICAgICAgYXZlcmFnZU5vcm1hbC50YW5nZW50cyhmMS50LCBmMi50KTsgLy8gcmV0dXJuIGVxOwogICAgfQogICAgLyoqCiAgICAgKiBHZW5lcmF0ZSBhbGwgY29udGFjdHMgYmV0d2VlbiBhIGxpc3Qgb2YgYm9keSBwYWlycwogICAgICogQHBhcmFtIHAxIEFycmF5IG9mIGJvZHkgaW5kaWNlcwogICAgICogQHBhcmFtIHAyIEFycmF5IG9mIGJvZHkgaW5kaWNlcwogICAgICogQHBhcmFtIHJlc3VsdCBBcnJheSB0byBzdG9yZSBnZW5lcmF0ZWQgY29udGFjdHMKICAgICAqIEBwYXJhbSBvbGRjb250YWN0cyBPcHRpb25hbC4gQXJyYXkgb2YgcmV1c2FibGUgY29udGFjdCBvYmplY3RzCiAgICAgKi8KCgogICAgZ2V0Q29udGFjdHMocDEsIHAyLCB3b3JsZCwgcmVzdWx0LCBvbGRjb250YWN0cywgZnJpY3Rpb25SZXN1bHQsIGZyaWN0aW9uUG9vbCkgewogICAgICAvLyBTYXZlIG9sZCBjb250YWN0IG9iamVjdHMKICAgICAgdGhpcy5jb250YWN0UG9pbnRQb29sID0gb2xkY29udGFjdHM7CiAgICAgIHRoaXMuZnJpY3Rpb25FcXVhdGlvblBvb2wgPSBmcmljdGlvblBvb2w7CiAgICAgIHRoaXMucmVzdWx0ID0gcmVzdWx0OwogICAgICB0aGlzLmZyaWN0aW9uUmVzdWx0ID0gZnJpY3Rpb25SZXN1bHQ7CiAgICAgIGNvbnN0IHFpID0gdG1wUXVhdDE7CiAgICAgIGNvbnN0IHFqID0gdG1wUXVhdDI7CiAgICAgIGNvbnN0IHhpID0gdG1wVmVjMTsKICAgICAgY29uc3QgeGogPSB0bXBWZWMyOwoKICAgICAgZm9yIChsZXQgayA9IDAsIE4gPSBwMS5sZW5ndGg7IGsgIT09IE47IGsrKykgewogICAgICAgIC8vIEdldCBjdXJyZW50IGNvbGxpc2lvbiBib2RpZXMKICAgICAgICBjb25zdCBiaSA9IHAxW2tdOwogICAgICAgIGNvbnN0IGJqID0gcDJba107IC8vIEdldCBjb250YWN0IG1hdGVyaWFsCgogICAgICAgIGxldCBib2R5Q29udGFjdE1hdGVyaWFsID0gbnVsbDsKCiAgICAgICAgaWYgKGJpLm1hdGVyaWFsICYmIGJqLm1hdGVyaWFsKSB7CiAgICAgICAgICBib2R5Q29udGFjdE1hdGVyaWFsID0gd29ybGQuZ2V0Q29udGFjdE1hdGVyaWFsKGJpLm1hdGVyaWFsLCBiai5tYXRlcmlhbCkgfHwgbnVsbDsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGp1c3RUZXN0ID0gYmkudHlwZSAmIEJvZHkuS0lORU1BVElDICYmIGJqLnR5cGUgJiBCb2R5LlNUQVRJQyB8fCBiaS50eXBlICYgQm9keS5TVEFUSUMgJiYgYmoudHlwZSAmIEJvZHkuS0lORU1BVElDIHx8IGJpLnR5cGUgJiBCb2R5LktJTkVNQVRJQyAmJiBiai50eXBlICYgQm9keS5LSU5FTUFUSUM7CgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmkuc2hhcGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBiaS5xdWF0ZXJuaW9uLm11bHQoYmkuc2hhcGVPcmllbnRhdGlvbnNbaV0sIHFpKTsKICAgICAgICAgIGJpLnF1YXRlcm5pb24udm11bHQoYmkuc2hhcGVPZmZzZXRzW2ldLCB4aSk7CiAgICAgICAgICB4aS52YWRkKGJpLnBvc2l0aW9uLCB4aSk7CiAgICAgICAgICBjb25zdCBzaSA9IGJpLnNoYXBlc1tpXTsKCiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGJqLnNoYXBlcy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAvLyBDb21wdXRlIHdvcmxkIHRyYW5zZm9ybSBvZiBzaGFwZXMKICAgICAgICAgICAgYmoucXVhdGVybmlvbi5tdWx0KGJqLnNoYXBlT3JpZW50YXRpb25zW2pdLCBxaik7CiAgICAgICAgICAgIGJqLnF1YXRlcm5pb24udm11bHQoYmouc2hhcGVPZmZzZXRzW2pdLCB4aik7CiAgICAgICAgICAgIHhqLnZhZGQoYmoucG9zaXRpb24sIHhqKTsKICAgICAgICAgICAgY29uc3Qgc2ogPSBiai5zaGFwZXNbal07CgogICAgICAgICAgICBpZiAoIShzaS5jb2xsaXNpb25GaWx0ZXJNYXNrICYgc2ouY29sbGlzaW9uRmlsdGVyR3JvdXAgJiYgc2ouY29sbGlzaW9uRmlsdGVyTWFzayAmIHNpLmNvbGxpc2lvbkZpbHRlckdyb3VwKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoeGkuZGlzdGFuY2VUbyh4aikgPiBzaS5ib3VuZGluZ1NwaGVyZVJhZGl1cyArIHNqLmJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gLy8gR2V0IGNvbGxpc2lvbiBtYXRlcmlhbAoKCiAgICAgICAgICAgIGxldCBzaGFwZUNvbnRhY3RNYXRlcmlhbCA9IG51bGw7CgogICAgICAgICAgICBpZiAoc2kubWF0ZXJpYWwgJiYgc2oubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICBzaGFwZUNvbnRhY3RNYXRlcmlhbCA9IHdvcmxkLmdldENvbnRhY3RNYXRlcmlhbChzaS5tYXRlcmlhbCwgc2oubWF0ZXJpYWwpIHx8IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuY3VycmVudENvbnRhY3RNYXRlcmlhbCA9IHNoYXBlQ29udGFjdE1hdGVyaWFsIHx8IGJvZHlDb250YWN0TWF0ZXJpYWwgfHwgd29ybGQuZGVmYXVsdENvbnRhY3RNYXRlcmlhbDsgLy8gR2V0IGNvbnRhY3RzCgogICAgICAgICAgICBjb25zdCByZXNvbHZlckluZGV4ID0gc2kudHlwZSB8IHNqLnR5cGU7CiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVyID0gdGhpc1tyZXNvbHZlckluZGV4XTsKCiAgICAgICAgICAgIGlmIChyZXNvbHZlcikgewogICAgICAgICAgICAgIGxldCByZXR2YWwgPSBmYWxzZTsgLy8gVE8gRE86IGludmVzdGlnYXRlIHdoeSBzcGhlcmVQYXJ0aWNsZSBhbmQgY29udmV4UGFydGljbGUKICAgICAgICAgICAgICAvLyByZXNvbHZlcnMgZXhwZWN0IHNpIGFuZCBzaiBzaGFwZXMgdG8gYmUgaW4gcmV2ZXJzZSBvcmRlcgogICAgICAgICAgICAgIC8vIChpLmUuIGxhcmdlciBpbnRlZ2VyIHZhbHVlIHR5cGUgZmlyc3QgaW5zdGVhZCBvZiBzbWFsbGVyIGZpcnN0KQoKICAgICAgICAgICAgICBpZiAoc2kudHlwZSA8IHNqLnR5cGUpIHsKICAgICAgICAgICAgICAgIHJldHZhbCA9IHJlc29sdmVyLmNhbGwodGhpcywgc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCBzaSwgc2osIGp1c3RUZXN0KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dmFsID0gcmVzb2x2ZXIuY2FsbCh0aGlzLCBzaiwgc2ksIHhqLCB4aSwgcWosIHFpLCBiaiwgYmksIHNpLCBzaiwganVzdFRlc3QpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKHJldHZhbCAmJiBqdXN0VGVzdCkgewogICAgICAgICAgICAgICAgLy8gUmVnaXN0ZXIgb3ZlcmxhcAogICAgICAgICAgICAgICAgd29ybGQuc2hhcGVPdmVybGFwS2VlcGVyLnNldChzaS5pZCwgc2ouaWQpOwogICAgICAgICAgICAgICAgd29ybGQuYm9keU92ZXJsYXBLZWVwZXIuc2V0KGJpLmlkLCBiai5pZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgc3BoZXJlU3BoZXJlKHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgIHJldHVybiB4aS5kaXN0YW5jZVNxdWFyZWQoeGopIDwgKHNpLnJhZGl1cyArIHNqLnJhZGl1cykgKiogMjsKICAgICAgfSAvLyBXZSB3aWxsIGhhdmUgb25seSBvbmUgY29udGFjdCBpbiB0aGlzIGNhc2UKCgogICAgICBjb25zdCBjb250YWN0RXEgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOyAvLyBDb250YWN0IG5vcm1hbAoKICAgICAgeGoudnN1Yih4aSwgY29udGFjdEVxLm5pKTsKICAgICAgY29udGFjdEVxLm5pLm5vcm1hbGl6ZSgpOyAvLyBDb250YWN0IHBvaW50IGxvY2F0aW9ucwoKICAgICAgY29udGFjdEVxLnJpLmNvcHkoY29udGFjdEVxLm5pKTsKICAgICAgY29udGFjdEVxLnJqLmNvcHkoY29udGFjdEVxLm5pKTsKICAgICAgY29udGFjdEVxLnJpLnNjYWxlKHNpLnJhZGl1cywgY29udGFjdEVxLnJpKTsKICAgICAgY29udGFjdEVxLnJqLnNjYWxlKC1zai5yYWRpdXMsIGNvbnRhY3RFcS5yaik7CiAgICAgIGNvbnRhY3RFcS5yaS52YWRkKHhpLCBjb250YWN0RXEucmkpOwogICAgICBjb250YWN0RXEucmkudnN1YihiaS5wb3NpdGlvbiwgY29udGFjdEVxLnJpKTsKICAgICAgY29udGFjdEVxLnJqLnZhZGQoeGosIGNvbnRhY3RFcS5yaik7CiAgICAgIGNvbnRhY3RFcS5yai52c3ViKGJqLnBvc2l0aW9uLCBjb250YWN0RXEucmopOwogICAgICB0aGlzLnJlc3VsdC5wdXNoKGNvbnRhY3RFcSk7CiAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChjb250YWN0RXEsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgfQoKICAgIHNwaGVyZVBsYW5lKHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIC8vIFdlIHdpbGwgaGF2ZSBvbmUgY29udGFjdCBpbiB0aGlzIGNhc2UKICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7IC8vIENvbnRhY3Qgbm9ybWFsCgogICAgICByLm5pLnNldCgwLCAwLCAxKTsKICAgICAgcWoudm11bHQoci5uaSwgci5uaSk7CiAgICAgIHIubmkubmVnYXRlKHIubmkpOyAvLyBib2R5IGkgaXMgdGhlIHNwaGVyZSwgZmxpcCBub3JtYWwKCiAgICAgIHIubmkubm9ybWFsaXplKCk7IC8vIE5lZWRlZD8KICAgICAgLy8gVmVjdG9yIGZyb20gc3BoZXJlIGNlbnRlciB0byBjb250YWN0IHBvaW50CgogICAgICByLm5pLnNjYWxlKHNpLnJhZGl1cywgci5yaSk7IC8vIFByb2plY3QgZG93biBzcGhlcmUgb24gcGxhbmUKCiAgICAgIHhpLnZzdWIoeGosIHBvaW50X29uX3BsYW5lX3RvX3NwaGVyZSk7CiAgICAgIHIubmkuc2NhbGUoci5uaS5kb3QocG9pbnRfb25fcGxhbmVfdG9fc3BoZXJlKSwgcGxhbmVfdG9fc3BoZXJlX29ydGhvKTsKICAgICAgcG9pbnRfb25fcGxhbmVfdG9fc3BoZXJlLnZzdWIocGxhbmVfdG9fc3BoZXJlX29ydGhvLCByLnJqKTsgLy8gVGhlIHNwaGVyZSBwb3NpdGlvbiBwcm9qZWN0ZWQgdG8gcGxhbmUKCiAgICAgIGlmICgtcG9pbnRfb25fcGxhbmVfdG9fc3BoZXJlLmRvdChyLm5pKSA8PSBzaS5yYWRpdXMpIHsKICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gLy8gTWFrZSBpdCByZWxhdGl2ZSB0byB0aGUgYm9keQoKCiAgICAgICAgY29uc3QgcmkgPSByLnJpOwogICAgICAgIGNvbnN0IHJqID0gci5yajsKICAgICAgICByaS52YWRkKHhpLCByaSk7CiAgICAgICAgcmkudnN1YihiaS5wb3NpdGlvbiwgcmkpOwogICAgICAgIHJqLnZhZGQoeGosIHJqKTsKICAgICAgICByai52c3ViKGJqLnBvc2l0aW9uLCByaik7CiAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICAgIH0KICAgIH0KCiAgICBib3hCb3goc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLm1hdGVyaWFsID0gc2kubWF0ZXJpYWw7CiAgICAgIHNqLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5tYXRlcmlhbCA9IHNqLm1hdGVyaWFsOwogICAgICBzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24uY29sbGlzaW9uUmVzcG9uc2UgPSBzaS5jb2xsaXNpb25SZXNwb25zZTsKICAgICAgc2ouY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLmNvbGxpc2lvblJlc3BvbnNlID0gc2ouY29sbGlzaW9uUmVzcG9uc2U7CiAgICAgIHJldHVybiB0aGlzLmNvbnZleENvbnZleChzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24sIHNqLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgc2ksIHNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgc3BoZXJlQm94KHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIGNvbnN0IHYzcG9vbCA9IHRoaXMudjNwb29sOyAvLyB3ZSByZWZlciB0byB0aGUgYm94IGFzIGJvZHkgagoKICAgICAgY29uc3Qgc2lkZXMgPSBzcGhlcmVCb3hfc2lkZXM7CiAgICAgIHhpLnZzdWIoeGosIGJveF90b19zcGhlcmUpOwogICAgICBzai5nZXRTaWRlTm9ybWFscyhzaWRlcywgcWopOwogICAgICBjb25zdCBSID0gc2kucmFkaXVzOwoKICAgICAgbGV0IGZvdW5kID0gZmFsc2U7IC8vIFN0b3JlIHRoZSByZXN1bHRpbmcgc2lkZSBwZW5ldHJhdGlvbiBpbmZvCgogICAgICBjb25zdCBzaWRlX25zID0gc3BoZXJlQm94X3NpZGVfbnM7CiAgICAgIGNvbnN0IHNpZGVfbnMxID0gc3BoZXJlQm94X3NpZGVfbnMxOwogICAgICBjb25zdCBzaWRlX25zMiA9IHNwaGVyZUJveF9zaWRlX25zMjsKICAgICAgbGV0IHNpZGVfaCA9IG51bGw7CiAgICAgIGxldCBzaWRlX3BlbmV0cmF0aW9ucyA9IDA7CiAgICAgIGxldCBzaWRlX2RvdDEgPSAwOwogICAgICBsZXQgc2lkZV9kb3QyID0gMDsKICAgICAgbGV0IHNpZGVfZGlzdGFuY2UgPSBudWxsOwoKICAgICAgZm9yIChsZXQgaWR4ID0gMCwgbnNpZGVzID0gc2lkZXMubGVuZ3RoOyBpZHggIT09IG5zaWRlcyAmJiBmb3VuZCA9PT0gZmFsc2U7IGlkeCsrKSB7CiAgICAgICAgLy8gR2V0IHRoZSBwbGFuZSBzaWRlIG5vcm1hbCAobnMpCiAgICAgICAgY29uc3QgbnMgPSBzcGhlcmVCb3hfbnM7CiAgICAgICAgbnMuY29weShzaWRlc1tpZHhdKTsKICAgICAgICBjb25zdCBoID0gbnMubGVuZ3RoKCk7CiAgICAgICAgbnMubm9ybWFsaXplKCk7IC8vIFRoZSBub3JtYWwvZGlzdGFuY2UgZG90IHByb2R1Y3QgdGVsbHMgd2hpY2ggc2lkZSBvZiB0aGUgcGxhbmUgd2UgYXJlCgogICAgICAgIGNvbnN0IGRvdCA9IGJveF90b19zcGhlcmUuZG90KG5zKTsKCiAgICAgICAgaWYgKGRvdCA8IGggKyBSICYmIGRvdCA+IDApIHsKICAgICAgICAgIC8vIEludGVyc2VjdHMgcGxhbmUuIE5vdyBjaGVjayB0aGUgb3RoZXIgdHdvIGRpbWVuc2lvbnMKICAgICAgICAgIGNvbnN0IG5zMSA9IHNwaGVyZUJveF9uczE7CiAgICAgICAgICBjb25zdCBuczIgPSBzcGhlcmVCb3hfbnMyOwogICAgICAgICAgbnMxLmNvcHkoc2lkZXNbKGlkeCArIDEpICUgM10pOwogICAgICAgICAgbnMyLmNvcHkoc2lkZXNbKGlkeCArIDIpICUgM10pOwogICAgICAgICAgY29uc3QgaDEgPSBuczEubGVuZ3RoKCk7CiAgICAgICAgICBjb25zdCBoMiA9IG5zMi5sZW5ndGgoKTsKICAgICAgICAgIG5zMS5ub3JtYWxpemUoKTsKICAgICAgICAgIG5zMi5ub3JtYWxpemUoKTsKICAgICAgICAgIGNvbnN0IGRvdDEgPSBib3hfdG9fc3BoZXJlLmRvdChuczEpOwogICAgICAgICAgY29uc3QgZG90MiA9IGJveF90b19zcGhlcmUuZG90KG5zMik7CgogICAgICAgICAgaWYgKGRvdDEgPCBoMSAmJiBkb3QxID4gLWgxICYmIGRvdDIgPCBoMiAmJiBkb3QyID4gLWgyKSB7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLmFicyhkb3QgLSBoIC0gUik7CgogICAgICAgICAgICBpZiAoc2lkZV9kaXN0YW5jZSA9PT0gbnVsbCB8fCBkaXN0IDwgc2lkZV9kaXN0YW5jZSkgewogICAgICAgICAgICAgIHNpZGVfZGlzdGFuY2UgPSBkaXN0OwogICAgICAgICAgICAgIHNpZGVfZG90MSA9IGRvdDE7CiAgICAgICAgICAgICAgc2lkZV9kb3QyID0gZG90MjsKICAgICAgICAgICAgICBzaWRlX2ggPSBoOwogICAgICAgICAgICAgIHNpZGVfbnMuY29weShucyk7CiAgICAgICAgICAgICAgc2lkZV9uczEuY29weShuczEpOwogICAgICAgICAgICAgIHNpZGVfbnMyLmNvcHkobnMyKTsKICAgICAgICAgICAgICBzaWRlX3BlbmV0cmF0aW9ucysrOwoKICAgICAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHNpZGVfcGVuZXRyYXRpb25zKSB7CiAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgIHNpZGVfbnMuc2NhbGUoLVIsIHIucmkpOyAvLyBTcGhlcmUgcgoKICAgICAgICByLm5pLmNvcHkoc2lkZV9ucyk7CiAgICAgICAgci5uaS5uZWdhdGUoci5uaSk7IC8vIE5vcm1hbCBzaG91bGQgYmUgb3V0IG9mIHNwaGVyZQoKICAgICAgICBzaWRlX25zLnNjYWxlKHNpZGVfaCwgc2lkZV9ucyk7CiAgICAgICAgc2lkZV9uczEuc2NhbGUoc2lkZV9kb3QxLCBzaWRlX25zMSk7CiAgICAgICAgc2lkZV9ucy52YWRkKHNpZGVfbnMxLCBzaWRlX25zKTsKICAgICAgICBzaWRlX25zMi5zY2FsZShzaWRlX2RvdDIsIHNpZGVfbnMyKTsKICAgICAgICBzaWRlX25zLnZhZGQoc2lkZV9uczIsIHIucmopOyAvLyBNYWtlIHJlbGF0aXZlIHRvIGJvZGllcwoKICAgICAgICByLnJpLnZhZGQoeGksIHIucmkpOwogICAgICAgIHIucmkudnN1YihiaS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgci5yai52YWRkKHhqLCByLnJqKTsKICAgICAgICByLnJqLnZzdWIoYmoucG9zaXRpb24sIHIucmopOwogICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICB9IC8vIENoZWNrIGNvcm5lcnMKCgogICAgICBsZXQgcmogPSB2M3Bvb2wuZ2V0KCk7CiAgICAgIGNvbnN0IHNwaGVyZV90b19jb3JuZXIgPSBzcGhlcmVCb3hfc3BoZXJlX3RvX2Nvcm5lcjsKCiAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSAyICYmICFmb3VuZDsgaisrKSB7CiAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgIT09IDIgJiYgIWZvdW5kOyBrKyspIHsKICAgICAgICAgIGZvciAobGV0IGwgPSAwOyBsICE9PSAyICYmICFmb3VuZDsgbCsrKSB7CiAgICAgICAgICAgIHJqLnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIGlmIChqKSB7CiAgICAgICAgICAgICAgcmoudmFkZChzaWRlc1swXSwgcmopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJqLnZzdWIoc2lkZXNbMF0sIHJqKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGspIHsKICAgICAgICAgICAgICByai52YWRkKHNpZGVzWzFdLCByaik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmoudnN1YihzaWRlc1sxXSwgcmopOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobCkgewogICAgICAgICAgICAgIHJqLnZhZGQoc2lkZXNbMl0sIHJqKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByai52c3ViKHNpZGVzWzJdLCByaik7CiAgICAgICAgICAgIH0gLy8gV29ybGQgcG9zaXRpb24gb2YgY29ybmVyCgoKICAgICAgICAgICAgeGoudmFkZChyaiwgc3BoZXJlX3RvX2Nvcm5lcik7CiAgICAgICAgICAgIHNwaGVyZV90b19jb3JuZXIudnN1Yih4aSwgc3BoZXJlX3RvX2Nvcm5lcik7CgogICAgICAgICAgICBpZiAoc3BoZXJlX3RvX2Nvcm5lci5sZW5ndGhTcXVhcmVkKCkgPCBSICogUikgewogICAgICAgICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7CiAgICAgICAgICAgICAgci5yaS5jb3B5KHNwaGVyZV90b19jb3JuZXIpOwogICAgICAgICAgICAgIHIucmkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgci5uaS5jb3B5KHIucmkpOwogICAgICAgICAgICAgIHIucmkuc2NhbGUoUiwgci5yaSk7CiAgICAgICAgICAgICAgci5yai5jb3B5KHJqKTsgLy8gTWFrZSByZWxhdGl2ZSB0byBib2RpZXMKCiAgICAgICAgICAgICAgci5yaS52YWRkKHhpLCByLnJpKTsKICAgICAgICAgICAgICByLnJpLnZzdWIoYmkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgICAgIHIucmoudmFkZCh4aiwgci5yaik7CiAgICAgICAgICAgICAgci5yai52c3ViKGJqLnBvc2l0aW9uLCByLnJqKTsKICAgICAgICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgdjNwb29sLnJlbGVhc2UocmopOwogICAgICByaiA9IG51bGw7IC8vIENoZWNrIGVkZ2VzCgogICAgICBjb25zdCBlZGdlVGFuZ2VudCA9IHYzcG9vbC5nZXQoKTsKICAgICAgY29uc3QgZWRnZUNlbnRlciA9IHYzcG9vbC5nZXQoKTsKICAgICAgY29uc3QgciA9IHYzcG9vbC5nZXQoKTsgLy8gciA9IGVkZ2UgY2VudGVyIHRvIHNwaGVyZSBjZW50ZXIKCiAgICAgIGNvbnN0IG9ydGhvZ29uYWwgPSB2M3Bvb2wuZ2V0KCk7CiAgICAgIGNvbnN0IGRpc3QgPSB2M3Bvb2wuZ2V0KCk7CiAgICAgIGNvbnN0IE5zaWRlcyA9IHNpZGVzLmxlbmd0aDsKCiAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSBOc2lkZXMgJiYgIWZvdW5kOyBqKyspIHsKICAgICAgICBmb3IgKGxldCBrID0gMDsgayAhPT0gTnNpZGVzICYmICFmb3VuZDsgaysrKSB7CiAgICAgICAgICBpZiAoaiAlIDMgIT09IGsgJSAzKSB7CiAgICAgICAgICAgIC8vIEdldCBlZGdlIHRhbmdlbnQKICAgICAgICAgICAgc2lkZXNba10uY3Jvc3Moc2lkZXNbal0sIGVkZ2VUYW5nZW50KTsKICAgICAgICAgICAgZWRnZVRhbmdlbnQubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHNpZGVzW2pdLnZhZGQoc2lkZXNba10sIGVkZ2VDZW50ZXIpOwogICAgICAgICAgICByLmNvcHkoeGkpOwogICAgICAgICAgICByLnZzdWIoZWRnZUNlbnRlciwgcik7CiAgICAgICAgICAgIHIudnN1Yih4aiwgcik7CiAgICAgICAgICAgIGNvbnN0IG9ydGhvbm9ybSA9IHIuZG90KGVkZ2VUYW5nZW50KTsgLy8gZGlzdGFuY2UgZnJvbSBlZGdlIGNlbnRlciB0byBzcGhlcmUgY2VudGVyIGluIHRoZSB0YW5nZW50IGRpcmVjdGlvbgoKICAgICAgICAgICAgZWRnZVRhbmdlbnQuc2NhbGUob3J0aG9ub3JtLCBvcnRob2dvbmFsKTsgLy8gVmVjdG9yIGZyb20gZWRnZSBjZW50ZXIgdG8gc3BoZXJlIGNlbnRlciBpbiB0aGUgdGFuZ2VudCBkaXJlY3Rpb24KICAgICAgICAgICAgLy8gRmluZCB0aGUgdGhpcmQgc2lkZSBvcnRob2dvbmFsIHRvIHRoaXMgb25lCgogICAgICAgICAgICBsZXQgbCA9IDA7CgogICAgICAgICAgICB3aGlsZSAobCA9PT0gaiAlIDMgfHwgbCA9PT0gayAlIDMpIHsKICAgICAgICAgICAgICBsKys7CiAgICAgICAgICAgIH0gLy8gdmVjIGZyb20gZWRnZSBjZW50ZXIgdG8gc3BoZXJlIHByb2plY3RlZCB0byB0aGUgcGxhbmUgb3J0aG9nb25hbCB0byB0aGUgZWRnZSB0YW5nZW50CgoKICAgICAgICAgICAgZGlzdC5jb3B5KHhpKTsKICAgICAgICAgICAgZGlzdC52c3ViKG9ydGhvZ29uYWwsIGRpc3QpOwogICAgICAgICAgICBkaXN0LnZzdWIoZWRnZUNlbnRlciwgZGlzdCk7CiAgICAgICAgICAgIGRpc3QudnN1Yih4aiwgZGlzdCk7IC8vIERpc3RhbmNlcyBpbiB0YW5nZW50IGRpcmVjdGlvbiBhbmQgZGlzdGFuY2UgaW4gdGhlIHBsYW5lIG9ydGhvZ29uYWwgdG8gaXQKCiAgICAgICAgICAgIGNvbnN0IHRkaXN0ID0gTWF0aC5hYnMob3J0aG9ub3JtKTsKICAgICAgICAgICAgY29uc3QgbmRpc3QgPSBkaXN0Lmxlbmd0aCgpOwoKICAgICAgICAgICAgaWYgKHRkaXN0IDwgc2lkZXNbbF0ubGVuZ3RoKCkgJiYgbmRpc3QgPCBSKSB7CiAgICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICBjb25zdCByZXMgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgICAgICAgIGVkZ2VDZW50ZXIudmFkZChvcnRob2dvbmFsLCByZXMucmopOyAvLyBib3ggcmoKCiAgICAgICAgICAgICAgcmVzLnJqLmNvcHkocmVzLnJqKTsKICAgICAgICAgICAgICBkaXN0Lm5lZ2F0ZShyZXMubmkpOwogICAgICAgICAgICAgIHJlcy5uaS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICByZXMucmkuY29weShyZXMucmopOwogICAgICAgICAgICAgIHJlcy5yaS52YWRkKHhqLCByZXMucmkpOwogICAgICAgICAgICAgIHJlcy5yaS52c3ViKHhpLCByZXMucmkpOwogICAgICAgICAgICAgIHJlcy5yaS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICByZXMucmkuc2NhbGUoUiwgcmVzLnJpKTsgLy8gTWFrZSByZWxhdGl2ZSB0byBib2RpZXMKCiAgICAgICAgICAgICAgcmVzLnJpLnZhZGQoeGksIHJlcy5yaSk7CiAgICAgICAgICAgICAgcmVzLnJpLnZzdWIoYmkucG9zaXRpb24sIHJlcy5yaSk7CiAgICAgICAgICAgICAgcmVzLnJqLnZhZGQoeGosIHJlcy5yaik7CiAgICAgICAgICAgICAgcmVzLnJqLnZzdWIoYmoucG9zaXRpb24sIHJlcy5yaik7CiAgICAgICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyZXMpOwogICAgICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyZXMsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB2M3Bvb2wucmVsZWFzZShlZGdlVGFuZ2VudCwgZWRnZUNlbnRlciwgciwgb3J0aG9nb25hbCwgZGlzdCk7CiAgICB9CgogICAgcGxhbmVCb3goc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgc2ouY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLm1hdGVyaWFsID0gc2oubWF0ZXJpYWw7CiAgICAgIHNqLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5jb2xsaXNpb25SZXNwb25zZSA9IHNqLmNvbGxpc2lvblJlc3BvbnNlOwogICAgICBzai5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24uaWQgPSBzai5pZDsKICAgICAgcmV0dXJuIHRoaXMucGxhbmVDb252ZXgoc2ksIHNqLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgc2ksIHNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgY29udmV4Q29udmV4KHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0LCBmYWNlTGlzdEEsIGZhY2VMaXN0QikgewogICAgICBjb25zdCBzZXBBeGlzID0gY29udmV4Q29udmV4X3NlcEF4aXM7CgogICAgICBpZiAoeGkuZGlzdGFuY2VUbyh4aikgPiBzaS5ib3VuZGluZ1NwaGVyZVJhZGl1cyArIHNqLmJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoc2kuZmluZFNlcGFyYXRpbmdBeGlzKHNqLCB4aSwgcWksIHhqLCBxaiwgc2VwQXhpcywgZmFjZUxpc3RBLCBmYWNlTGlzdEIpKSB7CiAgICAgICAgY29uc3QgcmVzID0gW107CiAgICAgICAgY29uc3QgcSA9IGNvbnZleENvbnZleF9xOwogICAgICAgIHNpLmNsaXBBZ2FpbnN0SHVsbCh4aSwgcWksIHNqLCB4aiwgcWosIHNlcEF4aXMsIC0xMDAsIDEwMCwgcmVzKTsKICAgICAgICBsZXQgbnVtQ29udGFjdHMgPSAwOwoKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiAhPT0gcmVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7CiAgICAgICAgICBjb25zdCByaSA9IHIucmk7CiAgICAgICAgICBjb25zdCByaiA9IHIucmo7CiAgICAgICAgICBzZXBBeGlzLm5lZ2F0ZShyLm5pKTsKICAgICAgICAgIHJlc1tqXS5ub3JtYWwubmVnYXRlKHEpOwogICAgICAgICAgcS5zY2FsZShyZXNbal0uZGVwdGgsIHEpOwogICAgICAgICAgcmVzW2pdLnBvaW50LnZhZGQocSwgcmkpOwogICAgICAgICAgcmouY29weShyZXNbal0ucG9pbnQpOyAvLyBDb250YWN0IHBvaW50cyBhcmUgaW4gd29ybGQgY29vcmRpbmF0ZXMuIFRyYW5zZm9ybSBiYWNrIHRvIHJlbGF0aXZlCgogICAgICAgICAgcmkudnN1Yih4aSwgcmkpOwogICAgICAgICAgcmoudnN1Yih4aiwgcmopOyAvLyBNYWtlIHJlbGF0aXZlIHRvIGJvZGllcwoKICAgICAgICAgIHJpLnZhZGQoeGksIHJpKTsKICAgICAgICAgIHJpLnZzdWIoYmkucG9zaXRpb24sIHJpKTsKICAgICAgICAgIHJqLnZhZGQoeGosIHJqKTsKICAgICAgICAgIHJqLnZzdWIoYmoucG9zaXRpb24sIHJqKTsKICAgICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgICBudW1Db250YWN0cysrOwoKICAgICAgICAgIGlmICghdGhpcy5lbmFibGVGcmljdGlvblJlZHVjdGlvbikgewogICAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5lbmFibGVGcmljdGlvblJlZHVjdGlvbiAmJiBudW1Db250YWN0cykgewogICAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkZyb21BdmVyYWdlKG51bUNvbnRhY3RzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBzcGhlcmVDb252ZXgoc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgY29uc3QgdjNwb29sID0gdGhpcy52M3Bvb2w7CiAgICAgIHhpLnZzdWIoeGosIGNvbnZleF90b19zcGhlcmUpOwogICAgICBjb25zdCBub3JtYWxzID0gc2ouZmFjZU5vcm1hbHM7CiAgICAgIGNvbnN0IGZhY2VzID0gc2ouZmFjZXM7CiAgICAgIGNvbnN0IHZlcnRzID0gc2oudmVydGljZXM7CiAgICAgIGNvbnN0IFIgPSBzaS5yYWRpdXM7CiAgICAgIC8vICAgICByZXR1cm47CiAgICAgIC8vIH0KCiAgICAgIGxldCBmb3VuZCA9IGZhbHNlOyAvLyBDaGVjayBjb3JuZXJzCgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gdmVydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB2ID0gdmVydHNbaV07IC8vIFdvcmxkIHBvc2l0aW9uIG9mIGNvcm5lcgoKICAgICAgICBjb25zdCB3b3JsZENvcm5lciA9IHNwaGVyZUNvbnZleF93b3JsZENvcm5lcjsKICAgICAgICBxai52bXVsdCh2LCB3b3JsZENvcm5lcik7CiAgICAgICAgeGoudmFkZCh3b3JsZENvcm5lciwgd29ybGRDb3JuZXIpOwogICAgICAgIGNvbnN0IHNwaGVyZV90b19jb3JuZXIgPSBzcGhlcmVDb252ZXhfc3BoZXJlVG9Db3JuZXI7CiAgICAgICAgd29ybGRDb3JuZXIudnN1Yih4aSwgc3BoZXJlX3RvX2Nvcm5lcik7CgogICAgICAgIGlmIChzcGhlcmVfdG9fY29ybmVyLmxlbmd0aFNxdWFyZWQoKSA8IFIgKiBSKSB7CiAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7CiAgICAgICAgICByLnJpLmNvcHkoc3BoZXJlX3RvX2Nvcm5lcik7CiAgICAgICAgICByLnJpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgci5uaS5jb3B5KHIucmkpOwogICAgICAgICAgci5yaS5zY2FsZShSLCByLnJpKTsKICAgICAgICAgIHdvcmxkQ29ybmVyLnZzdWIoeGosIHIucmopOyAvLyBTaG91bGQgYmUgcmVsYXRpdmUgdG8gdGhlIGJvZHkuCgogICAgICAgICAgci5yaS52YWRkKHhpLCByLnJpKTsKICAgICAgICAgIHIucmkudnN1YihiaS5wb3NpdGlvbiwgci5yaSk7IC8vIFNob3VsZCBiZSByZWxhdGl2ZSB0byB0aGUgYm9keS4KCiAgICAgICAgICByLnJqLnZhZGQoeGosIHIucmopOwogICAgICAgICAgci5yai52c3ViKGJqLnBvc2l0aW9uLCByLnJqKTsKICAgICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9IC8vIENoZWNrIHNpZGUgKHBsYW5lKSBpbnRlcnNlY3Rpb25zCgoKICAgICAgZm9yIChsZXQgaSA9IDAsIG5mYWNlcyA9IGZhY2VzLmxlbmd0aDsgaSAhPT0gbmZhY2VzICYmIGZvdW5kID09PSBmYWxzZTsgaSsrKSB7CiAgICAgICAgY29uc3Qgbm9ybWFsID0gbm9ybWFsc1tpXTsKICAgICAgICBjb25zdCBmYWNlID0gZmFjZXNbaV07IC8vIEdldCB3b3JsZC10cmFuc2Zvcm1lZCBub3JtYWwgb2YgdGhlIGZhY2UKCiAgICAgICAgY29uc3Qgd29ybGROb3JtYWwgPSBzcGhlcmVDb252ZXhfd29ybGROb3JtYWw7CiAgICAgICAgcWoudm11bHQobm9ybWFsLCB3b3JsZE5vcm1hbCk7IC8vIEdldCBhIHdvcmxkIHZlcnRleCBmcm9tIHRoZSBmYWNlCgogICAgICAgIGNvbnN0IHdvcmxkUG9pbnQgPSBzcGhlcmVDb252ZXhfd29ybGRQb2ludDsKICAgICAgICBxai52bXVsdCh2ZXJ0c1tmYWNlWzBdXSwgd29ybGRQb2ludCk7CiAgICAgICAgd29ybGRQb2ludC52YWRkKHhqLCB3b3JsZFBvaW50KTsgLy8gR2V0IGEgcG9pbnQgb24gdGhlIHNwaGVyZSwgY2xvc2VzdCB0byB0aGUgZmFjZSBub3JtYWwKCiAgICAgICAgY29uc3Qgd29ybGRTcGhlcmVQb2ludENsb3Nlc3RUb1BsYW5lID0gc3BoZXJlQ29udmV4X3dvcmxkU3BoZXJlUG9pbnRDbG9zZXN0VG9QbGFuZTsKICAgICAgICB3b3JsZE5vcm1hbC5zY2FsZSgtUiwgd29ybGRTcGhlcmVQb2ludENsb3Nlc3RUb1BsYW5lKTsKICAgICAgICB4aS52YWRkKHdvcmxkU3BoZXJlUG9pbnRDbG9zZXN0VG9QbGFuZSwgd29ybGRTcGhlcmVQb2ludENsb3Nlc3RUb1BsYW5lKTsgLy8gVmVjdG9yIGZyb20gYSBmYWNlIHBvaW50IHRvIHRoZSBjbG9zZXN0IHBvaW50IG9uIHRoZSBzcGhlcmUKCiAgICAgICAgY29uc3QgcGVuZXRyYXRpb25WZWMgPSBzcGhlcmVDb252ZXhfcGVuZXRyYXRpb25WZWM7CiAgICAgICAgd29ybGRTcGhlcmVQb2ludENsb3Nlc3RUb1BsYW5lLnZzdWIod29ybGRQb2ludCwgcGVuZXRyYXRpb25WZWMpOyAvLyBUaGUgcGVuZXRyYXRpb24uIE5lZ2F0aXZlIHZhbHVlIG1lYW5zIG92ZXJsYXAuCgogICAgICAgIGNvbnN0IHBlbmV0cmF0aW9uID0gcGVuZXRyYXRpb25WZWMuZG90KHdvcmxkTm9ybWFsKTsKICAgICAgICBjb25zdCB3b3JsZFBvaW50VG9TcGhlcmUgPSBzcGhlcmVDb252ZXhfc3BoZXJlVG9Xb3JsZFBvaW50OwogICAgICAgIHhpLnZzdWIod29ybGRQb2ludCwgd29ybGRQb2ludFRvU3BoZXJlKTsKCiAgICAgICAgaWYgKHBlbmV0cmF0aW9uIDwgMCAmJiB3b3JsZFBvaW50VG9TcGhlcmUuZG90KHdvcmxkTm9ybWFsKSA+IDApIHsKICAgICAgICAgIC8vIEludGVyc2VjdHMgcGxhbmUuIE5vdyBjaGVjayBpZiB0aGUgc3BoZXJlIGlzIGluc2lkZSB0aGUgZmFjZSBwb2x5Z29uCiAgICAgICAgICBjb25zdCBmYWNlVmVydHMgPSBbXTsgLy8gRmFjZSB2ZXJ0aWNlcywgaW4gd29ybGQgY29vcmRzCgogICAgICAgICAgZm9yIChsZXQgaiA9IDAsIE52ZXJ0cyA9IGZhY2UubGVuZ3RoOyBqICE9PSBOdmVydHM7IGorKykgewogICAgICAgICAgICBjb25zdCB3b3JsZFZlcnRleCA9IHYzcG9vbC5nZXQoKTsKICAgICAgICAgICAgcWoudm11bHQodmVydHNbZmFjZVtqXV0sIHdvcmxkVmVydGV4KTsKICAgICAgICAgICAgeGoudmFkZCh3b3JsZFZlcnRleCwgd29ybGRWZXJ0ZXgpOwogICAgICAgICAgICBmYWNlVmVydHMucHVzaCh3b3JsZFZlcnRleCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHBvaW50SW5Qb2x5Z29uKGZhY2VWZXJ0cywgd29ybGROb3JtYWwsIHhpKSkgewogICAgICAgICAgICAvLyBJcyB0aGUgc3BoZXJlIGNlbnRlciBpbiB0aGUgZmFjZSBwb2x5Z29uPwogICAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oYmksIGJqLCBzaSwgc2osIHJzaSwgcnNqKTsKICAgICAgICAgICAgd29ybGROb3JtYWwuc2NhbGUoLVIsIHIucmkpOyAvLyBDb250YWN0IG9mZnNldCwgZnJvbSBzcGhlcmUgY2VudGVyIHRvIGNvbnRhY3QKCiAgICAgICAgICAgIHdvcmxkTm9ybWFsLm5lZ2F0ZShyLm5pKTsgLy8gTm9ybWFsIHBvaW50aW5nIG91dCBvZiBzcGhlcmUKCiAgICAgICAgICAgIGNvbnN0IHBlbmV0cmF0aW9uVmVjMiA9IHYzcG9vbC5nZXQoKTsKICAgICAgICAgICAgd29ybGROb3JtYWwuc2NhbGUoLXBlbmV0cmF0aW9uLCBwZW5ldHJhdGlvblZlYzIpOwogICAgICAgICAgICBjb25zdCBwZW5ldHJhdGlvblNwaGVyZVBvaW50ID0gdjNwb29sLmdldCgpOwogICAgICAgICAgICB3b3JsZE5vcm1hbC5zY2FsZSgtUiwgcGVuZXRyYXRpb25TcGhlcmVQb2ludCk7IC8veGkudnN1Yih4aikudmFkZChwZW5ldHJhdGlvblNwaGVyZVBvaW50KS52YWRkKHBlbmV0cmF0aW9uVmVjMiAsIHIucmopOwoKICAgICAgICAgICAgeGkudnN1Yih4aiwgci5yaik7CiAgICAgICAgICAgIHIucmoudmFkZChwZW5ldHJhdGlvblNwaGVyZVBvaW50LCByLnJqKTsKICAgICAgICAgICAgci5yai52YWRkKHBlbmV0cmF0aW9uVmVjMiwgci5yaik7IC8vIFNob3VsZCBiZSByZWxhdGl2ZSB0byB0aGUgYm9keS4KCiAgICAgICAgICAgIHIucmoudmFkZCh4aiwgci5yaik7CiAgICAgICAgICAgIHIucmoudnN1Yihiai5wb3NpdGlvbiwgci5yaik7IC8vIFNob3VsZCBiZSByZWxhdGl2ZSB0byB0aGUgYm9keS4KCiAgICAgICAgICAgIHIucmkudmFkZCh4aSwgci5yaSk7CiAgICAgICAgICAgIHIucmkudnN1YihiaS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHBlbmV0cmF0aW9uVmVjMik7CiAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHBlbmV0cmF0aW9uU3BoZXJlUG9pbnQpOwogICAgICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7IC8vIFJlbGVhc2Ugd29ybGQgdmVydGljZXMKCiAgICAgICAgICAgIGZvciAobGV0IGogPSAwLCBOZmFjZXZlcnRzID0gZmFjZVZlcnRzLmxlbmd0aDsgaiAhPT0gTmZhY2V2ZXJ0czsgaisrKSB7CiAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UoZmFjZVZlcnRzW2pdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuOyAvLyBXZSBvbmx5IGV4cGVjdCAqb25lKiBmYWNlIGNvbnRhY3QKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIEVkZ2U/CiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSBmYWNlLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgLy8gR2V0IHR3byB3b3JsZCB0cmFuc2Zvcm1lZCB2ZXJ0aWNlcwogICAgICAgICAgICAgIGNvbnN0IHYxID0gdjNwb29sLmdldCgpOwogICAgICAgICAgICAgIGNvbnN0IHYyID0gdjNwb29sLmdldCgpOwogICAgICAgICAgICAgIHFqLnZtdWx0KHZlcnRzW2ZhY2VbKGogKyAxKSAlIGZhY2UubGVuZ3RoXV0sIHYxKTsKICAgICAgICAgICAgICBxai52bXVsdCh2ZXJ0c1tmYWNlWyhqICsgMikgJSBmYWNlLmxlbmd0aF1dLCB2Mik7CiAgICAgICAgICAgICAgeGoudmFkZCh2MSwgdjEpOwogICAgICAgICAgICAgIHhqLnZhZGQodjIsIHYyKTsgLy8gQ29uc3RydWN0IGVkZ2UgdmVjdG9yCgogICAgICAgICAgICAgIGNvbnN0IGVkZ2UgPSBzcGhlcmVDb252ZXhfZWRnZTsKICAgICAgICAgICAgICB2Mi52c3ViKHYxLCBlZGdlKTsgLy8gQ29uc3RydWN0IHRoZSBzYW1lIHZlY3RvciwgYnV0IG5vcm1hbGl6ZWQKCiAgICAgICAgICAgICAgY29uc3QgZWRnZVVuaXQgPSBzcGhlcmVDb252ZXhfZWRnZVVuaXQ7CiAgICAgICAgICAgICAgZWRnZS51bml0KGVkZ2VVbml0KTsgLy8gcCBpcyB4aSBwcm9qZWN0ZWQgb250byB0aGUgZWRnZQoKICAgICAgICAgICAgICBjb25zdCBwID0gdjNwb29sLmdldCgpOwogICAgICAgICAgICAgIGNvbnN0IHYxX3RvX3hpID0gdjNwb29sLmdldCgpOwogICAgICAgICAgICAgIHhpLnZzdWIodjEsIHYxX3RvX3hpKTsKICAgICAgICAgICAgICBjb25zdCBkb3QgPSB2MV90b194aS5kb3QoZWRnZVVuaXQpOwogICAgICAgICAgICAgIGVkZ2VVbml0LnNjYWxlKGRvdCwgcCk7CiAgICAgICAgICAgICAgcC52YWRkKHYxLCBwKTsgLy8gQ29tcHV0ZSBhIHZlY3RvciBmcm9tIHAgdG8gdGhlIGNlbnRlciBvZiB0aGUgc3BoZXJlCgogICAgICAgICAgICAgIGNvbnN0IHhpX3RvX3AgPSB2M3Bvb2wuZ2V0KCk7CiAgICAgICAgICAgICAgcC52c3ViKHhpLCB4aV90b19wKTsgLy8gQ29sbGlzaW9uIGlmIHRoZSBlZGdlLXNwaGVyZSBkaXN0YW5jZSBpcyBsZXNzIHRoYW4gdGhlIHJhZGl1cwogICAgICAgICAgICAgIC8vIEFORCBpZiBwIGlzIGluIGJldHdlZW4gdjEgYW5kIHYyCgogICAgICAgICAgICAgIGlmIChkb3QgPiAwICYmIGRvdCAqIGRvdCA8IGVkZ2UubGVuZ3RoU3F1YXJlZCgpICYmIHhpX3RvX3AubGVuZ3RoU3F1YXJlZCgpIDwgUiAqIFIpIHsKICAgICAgICAgICAgICAgIC8vIENvbGxpc2lvbiBpZiB0aGUgZWRnZS1zcGhlcmUgZGlzdGFuY2UgaXMgbGVzcyB0aGFuIHRoZSByYWRpdXMKICAgICAgICAgICAgICAgIC8vIEVkZ2UgY29udGFjdCEKICAgICAgICAgICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oYmksIGJqLCBzaSwgc2osIHJzaSwgcnNqKTsKICAgICAgICAgICAgICAgIHAudnN1Yih4aiwgci5yaik7CiAgICAgICAgICAgICAgICBwLnZzdWIoeGksIHIubmkpOwogICAgICAgICAgICAgICAgci5uaS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHIubmkuc2NhbGUoUiwgci5yaSk7IC8vIFNob3VsZCBiZSByZWxhdGl2ZSB0byB0aGUgYm9keS4KCiAgICAgICAgICAgICAgICByLnJqLnZhZGQoeGosIHIucmopOwogICAgICAgICAgICAgICAgci5yai52c3ViKGJqLnBvc2l0aW9uLCByLnJqKTsgLy8gU2hvdWxkIGJlIHJlbGF0aXZlIHRvIHRoZSBib2R5LgoKICAgICAgICAgICAgICAgIHIucmkudmFkZCh4aSwgci5yaSk7CiAgICAgICAgICAgICAgICByLnJpLnZzdWIoYmkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsgLy8gUmVsZWFzZSB3b3JsZCB2ZXJ0aWNlcwoKICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwLCBOZmFjZXZlcnRzID0gZmFjZVZlcnRzLmxlbmd0aDsgaiAhPT0gTmZhY2V2ZXJ0czsgaisrKSB7CiAgICAgICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKGZhY2VWZXJ0c1tqXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UodjEpOwogICAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UodjIpOwogICAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UocCk7CiAgICAgICAgICAgICAgICB2M3Bvb2wucmVsZWFzZSh4aV90b19wKTsKICAgICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHYxX3RvX3hpKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHYxKTsKICAgICAgICAgICAgICB2M3Bvb2wucmVsZWFzZSh2Mik7CiAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UocCk7CiAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UoeGlfdG9fcCk7CiAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UodjFfdG9feGkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IC8vIFJlbGVhc2Ugd29ybGQgdmVydGljZXMKCgogICAgICAgICAgZm9yIChsZXQgaiA9IDAsIE5mYWNldmVydHMgPSBmYWNlVmVydHMubGVuZ3RoOyBqICE9PSBOZmFjZXZlcnRzOyBqKyspIHsKICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UoZmFjZVZlcnRzW2pdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBwbGFuZUNvbnZleChwbGFuZVNoYXBlLCBjb252ZXhTaGFwZSwgcGxhbmVQb3NpdGlvbiwgY29udmV4UG9zaXRpb24sIHBsYW5lUXVhdCwgY29udmV4UXVhdCwgcGxhbmVCb2R5LCBjb252ZXhCb2R5LCBzaSwgc2osIGp1c3RUZXN0KSB7CiAgICAgIC8vIFNpbXBseSByZXR1cm4gdGhlIHBvaW50cyBiZWhpbmQgdGhlIHBsYW5lLgogICAgICBjb25zdCB3b3JsZFZlcnRleCA9IHBsYW5lQ29udmV4X3Y7CiAgICAgIGNvbnN0IHdvcmxkTm9ybWFsID0gcGxhbmVDb252ZXhfbm9ybWFsOwogICAgICB3b3JsZE5vcm1hbC5zZXQoMCwgMCwgMSk7CiAgICAgIHBsYW5lUXVhdC52bXVsdCh3b3JsZE5vcm1hbCwgd29ybGROb3JtYWwpOyAvLyBUdXJuIG5vcm1hbCBhY2NvcmRpbmcgdG8gcGxhbmUgb3JpZW50YXRpb24KCiAgICAgIGxldCBudW1Db250YWN0cyA9IDA7CiAgICAgIGNvbnN0IHJlbHBvcyA9IHBsYW5lQ29udmV4X3JlbHBvczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBjb252ZXhTaGFwZS52ZXJ0aWNlcy5sZW5ndGg7IGkrKykgewogICAgICAgIC8vIEdldCB3b3JsZCBjb252ZXggdmVydGV4CiAgICAgICAgd29ybGRWZXJ0ZXguY29weShjb252ZXhTaGFwZS52ZXJ0aWNlc1tpXSk7CiAgICAgICAgY29udmV4UXVhdC52bXVsdCh3b3JsZFZlcnRleCwgd29ybGRWZXJ0ZXgpOwogICAgICAgIGNvbnZleFBvc2l0aW9uLnZhZGQod29ybGRWZXJ0ZXgsIHdvcmxkVmVydGV4KTsKICAgICAgICB3b3JsZFZlcnRleC52c3ViKHBsYW5lUG9zaXRpb24sIHJlbHBvcyk7CiAgICAgICAgY29uc3QgZG90ID0gd29ybGROb3JtYWwuZG90KHJlbHBvcyk7CgogICAgICAgIGlmIChkb3QgPD0gMC4wKSB7CiAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKHBsYW5lQm9keSwgY29udmV4Qm9keSwgcGxhbmVTaGFwZSwgY29udmV4U2hhcGUsIHNpLCBzaik7IC8vIEdldCB2ZXJ0ZXggcG9zaXRpb24gcHJvamVjdGVkIG9uIHBsYW5lCgogICAgICAgICAgY29uc3QgcHJvamVjdGVkID0gcGxhbmVDb252ZXhfcHJvamVjdGVkOwogICAgICAgICAgd29ybGROb3JtYWwuc2NhbGUod29ybGROb3JtYWwuZG90KHJlbHBvcyksIHByb2plY3RlZCk7CiAgICAgICAgICB3b3JsZFZlcnRleC52c3ViKHByb2plY3RlZCwgcHJvamVjdGVkKTsKICAgICAgICAgIHByb2plY3RlZC52c3ViKHBsYW5lUG9zaXRpb24sIHIucmkpOyAvLyBGcm9tIHBsYW5lIHRvIHZlcnRleCBwcm9qZWN0ZWQgb24gcGxhbmUKCiAgICAgICAgICByLm5pLmNvcHkod29ybGROb3JtYWwpOyAvLyBDb250YWN0IG5vcm1hbCBpcyB0aGUgcGxhbmUgbm9ybWFsIG91dCBmcm9tIHBsYW5lCiAgICAgICAgICAvLyByaiBpcyBub3cganVzdCB0aGUgdmVjdG9yIGZyb20gdGhlIGNvbnZleCBjZW50ZXIgdG8gdGhlIHZlcnRleAoKICAgICAgICAgIHdvcmxkVmVydGV4LnZzdWIoY29udmV4UG9zaXRpb24sIHIucmopOyAvLyBNYWtlIGl0IHJlbGF0aXZlIHRvIHRoZSBib2R5CgogICAgICAgICAgci5yaS52YWRkKHBsYW5lUG9zaXRpb24sIHIucmkpOwogICAgICAgICAgci5yaS52c3ViKHBsYW5lQm9keS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgICByLnJqLnZhZGQoY29udmV4UG9zaXRpb24sIHIucmopOwogICAgICAgICAgci5yai52c3ViKGNvbnZleEJvZHkucG9zaXRpb24sIHIucmopOwogICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgIG51bUNvbnRhY3RzKys7CgogICAgICAgICAgaWYgKCF0aGlzLmVuYWJsZUZyaWN0aW9uUmVkdWN0aW9uKSB7CiAgICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmVuYWJsZUZyaWN0aW9uUmVkdWN0aW9uICYmIG51bUNvbnRhY3RzKSB7CiAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkZyb21BdmVyYWdlKG51bUNvbnRhY3RzKTsKICAgICAgfQogICAgfQoKICAgIGJveENvbnZleChzaSwgc2osIHhpLCB4aiwgcWksIHFqLCBiaSwgYmosIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICBzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24ubWF0ZXJpYWwgPSBzaS5tYXRlcmlhbDsKICAgICAgc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLmNvbGxpc2lvblJlc3BvbnNlID0gc2kuY29sbGlzaW9uUmVzcG9uc2U7CiAgICAgIHJldHVybiB0aGlzLmNvbnZleENvbnZleChzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24sIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCBzaSwgc2osIGp1c3RUZXN0KTsKICAgIH0KCiAgICBzcGhlcmVIZWlnaHRmaWVsZChzcGhlcmVTaGFwZSwgaGZTaGFwZSwgc3BoZXJlUG9zLCBoZlBvcywgc3BoZXJlUXVhdCwgaGZRdWF0LCBzcGhlcmVCb2R5LCBoZkJvZHksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICBjb25zdCBkYXRhID0gaGZTaGFwZS5kYXRhOwogICAgICBjb25zdCByYWRpdXMgPSBzcGhlcmVTaGFwZS5yYWRpdXM7CiAgICAgIGNvbnN0IHcgPSBoZlNoYXBlLmVsZW1lbnRTaXplOwogICAgICBjb25zdCB3b3JsZFBpbGxhck9mZnNldCA9IHNwaGVyZUhlaWdodGZpZWxkX3RtcDI7IC8vIEdldCBzcGhlcmUgcG9zaXRpb24gdG8gaGVpZ2h0ZmllbGQgbG9jYWwhCgogICAgICBjb25zdCBsb2NhbFNwaGVyZVBvcyA9IHNwaGVyZUhlaWdodGZpZWxkX3RtcDE7CiAgICAgIFRyYW5zZm9ybS5wb2ludFRvTG9jYWxGcmFtZShoZlBvcywgaGZRdWF0LCBzcGhlcmVQb3MsIGxvY2FsU3BoZXJlUG9zKTsgLy8gR2V0IHRoZSBpbmRleCBvZiB0aGUgZGF0YSBwb2ludHMgdG8gdGVzdCBhZ2FpbnN0CgogICAgICBsZXQgaU1pblggPSBNYXRoLmZsb29yKChsb2NhbFNwaGVyZVBvcy54IC0gcmFkaXVzKSAvIHcpIC0gMTsKICAgICAgbGV0IGlNYXhYID0gTWF0aC5jZWlsKChsb2NhbFNwaGVyZVBvcy54ICsgcmFkaXVzKSAvIHcpICsgMTsKICAgICAgbGV0IGlNaW5ZID0gTWF0aC5mbG9vcigobG9jYWxTcGhlcmVQb3MueSAtIHJhZGl1cykgLyB3KSAtIDE7CiAgICAgIGxldCBpTWF4WSA9IE1hdGguY2VpbCgobG9jYWxTcGhlcmVQb3MueSArIHJhZGl1cykgLyB3KSArIDE7IC8vIEJhaWwgb3V0IGlmIHdlIGFyZSBvdXQgb2YgdGhlIHRlcnJhaW4KCiAgICAgIGlmIChpTWF4WCA8IDAgfHwgaU1heFkgPCAwIHx8IGlNaW5YID4gZGF0YS5sZW5ndGggfHwgaU1pblkgPiBkYXRhWzBdLmxlbmd0aCkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBDbGFtcCBpbmRleCB0byBlZGdlcwoKCiAgICAgIGlmIChpTWluWCA8IDApIHsKICAgICAgICBpTWluWCA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWF4WCA8IDApIHsKICAgICAgICBpTWF4WCA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWluWSA8IDApIHsKICAgICAgICBpTWluWSA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWF4WSA8IDApIHsKICAgICAgICBpTWF4WSA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWluWCA+PSBkYXRhLmxlbmd0aCkgewogICAgICAgIGlNaW5YID0gZGF0YS5sZW5ndGggLSAxOwogICAgICB9CgogICAgICBpZiAoaU1heFggPj0gZGF0YS5sZW5ndGgpIHsKICAgICAgICBpTWF4WCA9IGRhdGEubGVuZ3RoIC0gMTsKICAgICAgfQoKICAgICAgaWYgKGlNYXhZID49IGRhdGFbMF0ubGVuZ3RoKSB7CiAgICAgICAgaU1heFkgPSBkYXRhWzBdLmxlbmd0aCAtIDE7CiAgICAgIH0KCiAgICAgIGlmIChpTWluWSA+PSBkYXRhWzBdLmxlbmd0aCkgewogICAgICAgIGlNaW5ZID0gZGF0YVswXS5sZW5ndGggLSAxOwogICAgICB9CgogICAgICBjb25zdCBtaW5NYXggPSBbXTsKICAgICAgaGZTaGFwZS5nZXRSZWN0TWluTWF4KGlNaW5YLCBpTWluWSwgaU1heFgsIGlNYXhZLCBtaW5NYXgpOwogICAgICBjb25zdCBtaW4gPSBtaW5NYXhbMF07CiAgICAgIGNvbnN0IG1heCA9IG1pbk1heFsxXTsgLy8gQmFpbCBvdXQgaWYgd2UgY2FuJ3QgdG91Y2ggdGhlIGJvdW5kaW5nIGhlaWdodCBib3gKCiAgICAgIGlmIChsb2NhbFNwaGVyZVBvcy56IC0gcmFkaXVzID4gbWF4IHx8IGxvY2FsU3BoZXJlUG9zLnogKyByYWRpdXMgPCBtaW4pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucmVzdWx0OwoKICAgICAgZm9yIChsZXQgaSA9IGlNaW5YOyBpIDwgaU1heFg7IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSBpTWluWTsgaiA8IGlNYXhZOyBqKyspIHsKICAgICAgICAgIGNvbnN0IG51bUNvbnRhY3RzQmVmb3JlID0gcmVzdWx0Lmxlbmd0aDsKICAgICAgICAgIGxldCBpbnRlcnNlY3RpbmcgPSBmYWxzZTsgLy8gTG93ZXIgdHJpYW5nbGUKCiAgICAgICAgICBoZlNoYXBlLmdldENvbnZleFRyaWFuZ2xlUGlsbGFyKGksIGosIGZhbHNlKTsKICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZShoZlBvcywgaGZRdWF0LCBoZlNoYXBlLnBpbGxhck9mZnNldCwgd29ybGRQaWxsYXJPZmZzZXQpOwoKICAgICAgICAgIGlmIChzcGhlcmVQb3MuZGlzdGFuY2VUbyh3b3JsZFBpbGxhck9mZnNldCkgPCBoZlNoYXBlLnBpbGxhckNvbnZleC5ib3VuZGluZ1NwaGVyZVJhZGl1cyArIHNwaGVyZVNoYXBlLmJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgICAgIGludGVyc2VjdGluZyA9IHRoaXMuc3BoZXJlQ29udmV4KHNwaGVyZVNoYXBlLCBoZlNoYXBlLnBpbGxhckNvbnZleCwgc3BoZXJlUG9zLCB3b3JsZFBpbGxhck9mZnNldCwgc3BoZXJlUXVhdCwgaGZRdWF0LCBzcGhlcmVCb2R5LCBoZkJvZHksIHNwaGVyZVNoYXBlLCBoZlNoYXBlLCBqdXN0VGVzdCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGp1c3RUZXN0ICYmIGludGVyc2VjdGluZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gLy8gVXBwZXIgdHJpYW5nbGUKCgogICAgICAgICAgaGZTaGFwZS5nZXRDb252ZXhUcmlhbmdsZVBpbGxhcihpLCBqLCB0cnVlKTsKICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZShoZlBvcywgaGZRdWF0LCBoZlNoYXBlLnBpbGxhck9mZnNldCwgd29ybGRQaWxsYXJPZmZzZXQpOwoKICAgICAgICAgIGlmIChzcGhlcmVQb3MuZGlzdGFuY2VUbyh3b3JsZFBpbGxhck9mZnNldCkgPCBoZlNoYXBlLnBpbGxhckNvbnZleC5ib3VuZGluZ1NwaGVyZVJhZGl1cyArIHNwaGVyZVNoYXBlLmJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgICAgIGludGVyc2VjdGluZyA9IHRoaXMuc3BoZXJlQ29udmV4KHNwaGVyZVNoYXBlLCBoZlNoYXBlLnBpbGxhckNvbnZleCwgc3BoZXJlUG9zLCB3b3JsZFBpbGxhck9mZnNldCwgc3BoZXJlUXVhdCwgaGZRdWF0LCBzcGhlcmVCb2R5LCBoZkJvZHksIHNwaGVyZVNoYXBlLCBoZlNoYXBlLCBqdXN0VGVzdCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGp1c3RUZXN0ICYmIGludGVyc2VjdGluZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zdCBudW1Db250YWN0cyA9IHJlc3VsdC5sZW5ndGggLSBudW1Db250YWN0c0JlZm9yZTsKCiAgICAgICAgICBpZiAobnVtQ29udGFjdHMgPiAyKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIC8qCiAgICAgICAgICAgIC8vIFNraXAgYWxsIGJ1dCAxCiAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbnVtQ29udGFjdHMgLSAxOyBrKyspIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5wb3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgKi8KCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgYm94SGVpZ2h0ZmllbGQoc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLm1hdGVyaWFsID0gc2kubWF0ZXJpYWw7CiAgICAgIHNpLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5jb2xsaXNpb25SZXNwb25zZSA9IHNpLmNvbGxpc2lvblJlc3BvbnNlOwogICAgICByZXR1cm4gdGhpcy5jb252ZXhIZWlnaHRmaWVsZChzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24sIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCBzaSwgc2osIGp1c3RUZXN0KTsKICAgIH0KCiAgICBjb252ZXhIZWlnaHRmaWVsZChjb252ZXhTaGFwZSwgaGZTaGFwZSwgY29udmV4UG9zLCBoZlBvcywgY29udmV4UXVhdCwgaGZRdWF0LCBjb252ZXhCb2R5LCBoZkJvZHksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICBjb25zdCBkYXRhID0gaGZTaGFwZS5kYXRhOwogICAgICBjb25zdCB3ID0gaGZTaGFwZS5lbGVtZW50U2l6ZTsKICAgICAgY29uc3QgcmFkaXVzID0gY29udmV4U2hhcGUuYm91bmRpbmdTcGhlcmVSYWRpdXM7CiAgICAgIGNvbnN0IHdvcmxkUGlsbGFyT2Zmc2V0ID0gY29udmV4SGVpZ2h0ZmllbGRfdG1wMjsKICAgICAgY29uc3QgZmFjZUxpc3QgPSBjb252ZXhIZWlnaHRmaWVsZF9mYWNlTGlzdDsgLy8gR2V0IHNwaGVyZSBwb3NpdGlvbiB0byBoZWlnaHRmaWVsZCBsb2NhbCEKCiAgICAgIGNvbnN0IGxvY2FsQ29udmV4UG9zID0gY29udmV4SGVpZ2h0ZmllbGRfdG1wMTsKICAgICAgVHJhbnNmb3JtLnBvaW50VG9Mb2NhbEZyYW1lKGhmUG9zLCBoZlF1YXQsIGNvbnZleFBvcywgbG9jYWxDb252ZXhQb3MpOyAvLyBHZXQgdGhlIGluZGV4IG9mIHRoZSBkYXRhIHBvaW50cyB0byB0ZXN0IGFnYWluc3QKCiAgICAgIGxldCBpTWluWCA9IE1hdGguZmxvb3IoKGxvY2FsQ29udmV4UG9zLnggLSByYWRpdXMpIC8gdykgLSAxOwogICAgICBsZXQgaU1heFggPSBNYXRoLmNlaWwoKGxvY2FsQ29udmV4UG9zLnggKyByYWRpdXMpIC8gdykgKyAxOwogICAgICBsZXQgaU1pblkgPSBNYXRoLmZsb29yKChsb2NhbENvbnZleFBvcy55IC0gcmFkaXVzKSAvIHcpIC0gMTsKICAgICAgbGV0IGlNYXhZID0gTWF0aC5jZWlsKChsb2NhbENvbnZleFBvcy55ICsgcmFkaXVzKSAvIHcpICsgMTsgLy8gQmFpbCBvdXQgaWYgd2UgYXJlIG91dCBvZiB0aGUgdGVycmFpbgoKICAgICAgaWYgKGlNYXhYIDwgMCB8fCBpTWF4WSA8IDAgfHwgaU1pblggPiBkYXRhLmxlbmd0aCB8fCBpTWluWSA+IGRhdGFbMF0ubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIENsYW1wIGluZGV4IHRvIGVkZ2VzCgoKICAgICAgaWYgKGlNaW5YIDwgMCkgewogICAgICAgIGlNaW5YID0gMDsKICAgICAgfQoKICAgICAgaWYgKGlNYXhYIDwgMCkgewogICAgICAgIGlNYXhYID0gMDsKICAgICAgfQoKICAgICAgaWYgKGlNaW5ZIDwgMCkgewogICAgICAgIGlNaW5ZID0gMDsKICAgICAgfQoKICAgICAgaWYgKGlNYXhZIDwgMCkgewogICAgICAgIGlNYXhZID0gMDsKICAgICAgfQoKICAgICAgaWYgKGlNaW5YID49IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgaU1pblggPSBkYXRhLmxlbmd0aCAtIDE7CiAgICAgIH0KCiAgICAgIGlmIChpTWF4WCA+PSBkYXRhLmxlbmd0aCkgewogICAgICAgIGlNYXhYID0gZGF0YS5sZW5ndGggLSAxOwogICAgICB9CgogICAgICBpZiAoaU1heFkgPj0gZGF0YVswXS5sZW5ndGgpIHsKICAgICAgICBpTWF4WSA9IGRhdGFbMF0ubGVuZ3RoIC0gMTsKICAgICAgfQoKICAgICAgaWYgKGlNaW5ZID49IGRhdGFbMF0ubGVuZ3RoKSB7CiAgICAgICAgaU1pblkgPSBkYXRhWzBdLmxlbmd0aCAtIDE7CiAgICAgIH0KCiAgICAgIGNvbnN0IG1pbk1heCA9IFtdOwogICAgICBoZlNoYXBlLmdldFJlY3RNaW5NYXgoaU1pblgsIGlNaW5ZLCBpTWF4WCwgaU1heFksIG1pbk1heCk7CiAgICAgIGNvbnN0IG1pbiA9IG1pbk1heFswXTsKICAgICAgY29uc3QgbWF4ID0gbWluTWF4WzFdOyAvLyBCYWlsIG91dCBpZiB3ZSdyZSBjYW50IHRvdWNoIHRoZSBib3VuZGluZyBoZWlnaHQgYm94CgogICAgICBpZiAobG9jYWxDb252ZXhQb3MueiAtIHJhZGl1cyA+IG1heCB8fCBsb2NhbENvbnZleFBvcy56ICsgcmFkaXVzIDwgbWluKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gaU1pblg7IGkgPCBpTWF4WDsgaSsrKSB7CiAgICAgICAgZm9yIChsZXQgaiA9IGlNaW5ZOyBqIDwgaU1heFk7IGorKykgewogICAgICAgICAgbGV0IGludGVyc2VjdGluZyA9IGZhbHNlOyAvLyBMb3dlciB0cmlhbmdsZQoKICAgICAgICAgIGhmU2hhcGUuZ2V0Q29udmV4VHJpYW5nbGVQaWxsYXIoaSwgaiwgZmFsc2UpOwogICAgICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKGhmUG9zLCBoZlF1YXQsIGhmU2hhcGUucGlsbGFyT2Zmc2V0LCB3b3JsZFBpbGxhck9mZnNldCk7CgogICAgICAgICAgaWYgKGNvbnZleFBvcy5kaXN0YW5jZVRvKHdvcmxkUGlsbGFyT2Zmc2V0KSA8IGhmU2hhcGUucGlsbGFyQ29udmV4LmJvdW5kaW5nU3BoZXJlUmFkaXVzICsgY29udmV4U2hhcGUuYm91bmRpbmdTcGhlcmVSYWRpdXMpIHsKICAgICAgICAgICAgaW50ZXJzZWN0aW5nID0gdGhpcy5jb252ZXhDb252ZXgoY29udmV4U2hhcGUsIGhmU2hhcGUucGlsbGFyQ29udmV4LCBjb252ZXhQb3MsIHdvcmxkUGlsbGFyT2Zmc2V0LCBjb252ZXhRdWF0LCBoZlF1YXQsIGNvbnZleEJvZHksIGhmQm9keSwgbnVsbCwgbnVsbCwganVzdFRlc3QsIGZhY2VMaXN0LCBudWxsKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoanVzdFRlc3QgJiYgaW50ZXJzZWN0aW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSAvLyBVcHBlciB0cmlhbmdsZQoKCiAgICAgICAgICBoZlNoYXBlLmdldENvbnZleFRyaWFuZ2xlUGlsbGFyKGksIGosIHRydWUpOwogICAgICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKGhmUG9zLCBoZlF1YXQsIGhmU2hhcGUucGlsbGFyT2Zmc2V0LCB3b3JsZFBpbGxhck9mZnNldCk7CgogICAgICAgICAgaWYgKGNvbnZleFBvcy5kaXN0YW5jZVRvKHdvcmxkUGlsbGFyT2Zmc2V0KSA8IGhmU2hhcGUucGlsbGFyQ29udmV4LmJvdW5kaW5nU3BoZXJlUmFkaXVzICsgY29udmV4U2hhcGUuYm91bmRpbmdTcGhlcmVSYWRpdXMpIHsKICAgICAgICAgICAgaW50ZXJzZWN0aW5nID0gdGhpcy5jb252ZXhDb252ZXgoY29udmV4U2hhcGUsIGhmU2hhcGUucGlsbGFyQ29udmV4LCBjb252ZXhQb3MsIHdvcmxkUGlsbGFyT2Zmc2V0LCBjb252ZXhRdWF0LCBoZlF1YXQsIGNvbnZleEJvZHksIGhmQm9keSwgbnVsbCwgbnVsbCwganVzdFRlc3QsIGZhY2VMaXN0LCBudWxsKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoanVzdFRlc3QgJiYgaW50ZXJzZWN0aW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHNwaGVyZVBhcnRpY2xlKHNqLCBzaSwgeGosIHhpLCBxaiwgcWksIGJqLCBiaSwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIC8vIFRoZSBub3JtYWwgaXMgdGhlIHVuaXQgdmVjdG9yIGZyb20gc3BoZXJlIGNlbnRlciB0byBwYXJ0aWNsZSBjZW50ZXIKICAgICAgY29uc3Qgbm9ybWFsID0gcGFydGljbGVTcGhlcmVfbm9ybWFsOwogICAgICBub3JtYWwuc2V0KDAsIDAsIDEpOwogICAgICB4aS52c3ViKHhqLCBub3JtYWwpOwogICAgICBjb25zdCBsZW5ndGhTcXVhcmVkID0gbm9ybWFsLmxlbmd0aFNxdWFyZWQoKTsKCiAgICAgIGlmIChsZW5ndGhTcXVhcmVkIDw9IHNqLnJhZGl1cyAqIHNqLnJhZGl1cykgewogICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oYmksIGJqLCBzaSwgc2osIHJzaSwgcnNqKTsKICAgICAgICBub3JtYWwubm9ybWFsaXplKCk7CiAgICAgICAgci5yai5jb3B5KG5vcm1hbCk7CiAgICAgICAgci5yai5zY2FsZShzai5yYWRpdXMsIHIucmopOwogICAgICAgIHIubmkuY29weShub3JtYWwpOyAvLyBDb250YWN0IG5vcm1hbAoKICAgICAgICByLm5pLm5lZ2F0ZShyLm5pKTsKICAgICAgICByLnJpLnNldCgwLCAwLCAwKTsgLy8gQ2VudGVyIG9mIHBhcnRpY2xlCgogICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICB9CiAgICB9CgogICAgcGxhbmVQYXJ0aWNsZShzaiwgc2ksIHhqLCB4aSwgcWosIHFpLCBiaiwgYmksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICBjb25zdCBub3JtYWwgPSBwYXJ0aWNsZVBsYW5lX25vcm1hbDsKICAgICAgbm9ybWFsLnNldCgwLCAwLCAxKTsKICAgICAgYmoucXVhdGVybmlvbi52bXVsdChub3JtYWwsIG5vcm1hbCk7IC8vIFR1cm4gbm9ybWFsIGFjY29yZGluZyB0byBwbGFuZSBvcmllbnRhdGlvbgoKICAgICAgY29uc3QgcmVscG9zID0gcGFydGljbGVQbGFuZV9yZWxwb3M7CiAgICAgIHhpLnZzdWIoYmoucG9zaXRpb24sIHJlbHBvcyk7CiAgICAgIGNvbnN0IGRvdCA9IG5vcm1hbC5kb3QocmVscG9zKTsKCiAgICAgIGlmIChkb3QgPD0gMC4wKSB7CiAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgIHIubmkuY29weShub3JtYWwpOyAvLyBDb250YWN0IG5vcm1hbCBpcyB0aGUgcGxhbmUgbm9ybWFsCgogICAgICAgIHIubmkubmVnYXRlKHIubmkpOwogICAgICAgIHIucmkuc2V0KDAsIDAsIDApOyAvLyBDZW50ZXIgb2YgcGFydGljbGUKICAgICAgICAvLyBHZXQgcGFydGljbGUgcG9zaXRpb24gcHJvamVjdGVkIG9uIHBsYW5lCgogICAgICAgIGNvbnN0IHByb2plY3RlZCA9IHBhcnRpY2xlUGxhbmVfcHJvamVjdGVkOwogICAgICAgIG5vcm1hbC5zY2FsZShub3JtYWwuZG90KHhpKSwgcHJvamVjdGVkKTsKICAgICAgICB4aS52c3ViKHByb2plY3RlZCwgcHJvamVjdGVkKTsgLy9wcm9qZWN0ZWQudmFkZChiai5wb3NpdGlvbixwcm9qZWN0ZWQpOwogICAgICAgIC8vIHJqIGlzIG5vdyB0aGUgcHJvamVjdGVkIHdvcmxkIHBvc2l0aW9uIG1pbnVzIHBsYW5lIHBvc2l0aW9uCgogICAgICAgIHIucmouY29weShwcm9qZWN0ZWQpOwogICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICB9CiAgICB9CgogICAgYm94UGFydGljbGUoc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLm1hdGVyaWFsID0gc2kubWF0ZXJpYWw7CiAgICAgIHNpLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5jb2xsaXNpb25SZXNwb25zZSA9IHNpLmNvbGxpc2lvblJlc3BvbnNlOwogICAgICByZXR1cm4gdGhpcy5jb252ZXhQYXJ0aWNsZShzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24sIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCBzaSwgc2osIGp1c3RUZXN0KTsKICAgIH0KCiAgICBjb252ZXhQYXJ0aWNsZShzaiwgc2ksIHhqLCB4aSwgcWosIHFpLCBiaiwgYmksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICBsZXQgcGVuZXRyYXRlZEZhY2VJbmRleCA9IC0xOwogICAgICBjb25zdCBwZW5ldHJhdGVkRmFjZU5vcm1hbCA9IGNvbnZleFBhcnRpY2xlX3BlbmV0cmF0ZWRGYWNlTm9ybWFsOwogICAgICBjb25zdCB3b3JsZFBlbmV0cmF0aW9uVmVjID0gY29udmV4UGFydGljbGVfd29ybGRQZW5ldHJhdGlvblZlYzsKICAgICAgbGV0IG1pblBlbmV0cmF0aW9uID0gbnVsbDsKCiAgICAgIGNvbnN0IGxvY2FsID0gY29udmV4UGFydGljbGVfbG9jYWw7CiAgICAgIGxvY2FsLmNvcHkoeGkpOwogICAgICBsb2NhbC52c3ViKHhqLCBsb2NhbCk7IC8vIENvbnZlcnQgcG9zaXRpb24gdG8gcmVsYXRpdmUgdGhlIGNvbnZleCBvcmlnaW4KCiAgICAgIHFqLmNvbmp1Z2F0ZShjcWopOwogICAgICBjcWoudm11bHQobG9jYWwsIGxvY2FsKTsKCiAgICAgIGlmIChzai5wb2ludElzSW5zaWRlKGxvY2FsKSkgewogICAgICAgIGlmIChzai53b3JsZFZlcnRpY2VzTmVlZHNVcGRhdGUpIHsKICAgICAgICAgIHNqLmNvbXB1dGVXb3JsZFZlcnRpY2VzKHhqLCBxaik7CiAgICAgICAgfQoKICAgICAgICBpZiAoc2oud29ybGRGYWNlTm9ybWFsc05lZWRzVXBkYXRlKSB7CiAgICAgICAgICBzai5jb21wdXRlV29ybGRGYWNlTm9ybWFscyhxaik7CiAgICAgICAgfSAvLyBGb3IgZWFjaCB3b3JsZCBwb2x5Z29uIGluIHRoZSBwb2x5aGVkcmEKCgogICAgICAgIGZvciAobGV0IGkgPSAwLCBuZmFjZXMgPSBzai5mYWNlcy5sZW5ndGg7IGkgIT09IG5mYWNlczsgaSsrKSB7CiAgICAgICAgICAvLyBDb25zdHJ1Y3Qgd29ybGQgZmFjZSB2ZXJ0aWNlcwogICAgICAgICAgY29uc3QgdmVydHMgPSBbc2oud29ybGRWZXJ0aWNlc1tzai5mYWNlc1tpXVswXV1dOwogICAgICAgICAgY29uc3Qgbm9ybWFsID0gc2oud29ybGRGYWNlTm9ybWFsc1tpXTsgLy8gQ2hlY2sgaG93IG11Y2ggdGhlIHBhcnRpY2xlIHBlbmV0cmF0ZXMgdGhlIHBvbHlnb24gcGxhbmUuCgogICAgICAgICAgeGkudnN1Yih2ZXJ0c1swXSwgY29udmV4UGFydGljbGVfdmVydGV4VG9QYXJ0aWNsZSk7CiAgICAgICAgICBjb25zdCBwZW5ldHJhdGlvbiA9IC1ub3JtYWwuZG90KGNvbnZleFBhcnRpY2xlX3ZlcnRleFRvUGFydGljbGUpOwoKICAgICAgICAgIGlmIChtaW5QZW5ldHJhdGlvbiA9PT0gbnVsbCB8fCBNYXRoLmFicyhwZW5ldHJhdGlvbikgPCBNYXRoLmFicyhtaW5QZW5ldHJhdGlvbikpIHsKICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1pblBlbmV0cmF0aW9uID0gcGVuZXRyYXRpb247CiAgICAgICAgICAgIHBlbmV0cmF0ZWRGYWNlSW5kZXggPSBpOwogICAgICAgICAgICBwZW5ldHJhdGVkRmFjZU5vcm1hbC5jb3B5KG5vcm1hbCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAocGVuZXRyYXRlZEZhY2VJbmRleCAhPT0gLTEpIHsKICAgICAgICAgIC8vIFNldHVwIGNvbnRhY3QKICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgICAgcGVuZXRyYXRlZEZhY2VOb3JtYWwuc2NhbGUobWluUGVuZXRyYXRpb24sIHdvcmxkUGVuZXRyYXRpb25WZWMpOyAvLyByaiBpcyB0aGUgcGFydGljbGUgcG9zaXRpb24gcHJvamVjdGVkIHRvIHRoZSBmYWNlCgogICAgICAgICAgd29ybGRQZW5ldHJhdGlvblZlYy52YWRkKHhpLCB3b3JsZFBlbmV0cmF0aW9uVmVjKTsKICAgICAgICAgIHdvcmxkUGVuZXRyYXRpb25WZWMudnN1Yih4aiwgd29ybGRQZW5ldHJhdGlvblZlYyk7CiAgICAgICAgICByLnJqLmNvcHkod29ybGRQZW5ldHJhdGlvblZlYyk7IC8vY29uc3QgcHJvamVjdGVkVG9GYWNlID0geGkudnN1Yih4aikudmFkZCh3b3JsZFBlbmV0cmF0aW9uVmVjKTsKICAgICAgICAgIC8vcHJvamVjdGVkVG9GYWNlLmNvcHkoci5yaik7CiAgICAgICAgICAvL3FqLnZtdWx0KHIucmosci5yaik7CgogICAgICAgICAgcGVuZXRyYXRlZEZhY2VOb3JtYWwubmVnYXRlKHIubmkpOyAvLyBDb250YWN0IG5vcm1hbAoKICAgICAgICAgIHIucmkuc2V0KDAsIDAsIDApOyAvLyBDZW50ZXIgb2YgcGFydGljbGUKCiAgICAgICAgICBjb25zdCByaSA9IHIucmk7CiAgICAgICAgICBjb25zdCByaiA9IHIucmo7IC8vIE1ha2UgcmVsYXRpdmUgdG8gYm9kaWVzCgogICAgICAgICAgcmkudmFkZCh4aSwgcmkpOwogICAgICAgICAgcmkudnN1YihiaS5wb3NpdGlvbiwgcmkpOwogICAgICAgICAgcmoudmFkZCh4aiwgcmopOwogICAgICAgICAgcmoudnN1Yihiai5wb3NpdGlvbiwgcmopOwogICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS53YXJuKCdQb2ludCBmb3VuZCBpbnNpZGUgY29udmV4LCBidXQgZGlkIG5vdCBmaW5kIHBlbmV0cmF0aW5nIGZhY2UhJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaGVpZ2h0ZmllbGRDeWxpbmRlcihoZlNoYXBlLCBjb252ZXhTaGFwZSwgaGZQb3MsIGNvbnZleFBvcywgaGZRdWF0LCBjb252ZXhRdWF0LCBoZkJvZHksIGNvbnZleEJvZHksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICByZXR1cm4gdGhpcy5jb252ZXhIZWlnaHRmaWVsZChjb252ZXhTaGFwZSwgaGZTaGFwZSwgY29udmV4UG9zLCBoZlBvcywgY29udmV4UXVhdCwgaGZRdWF0LCBjb252ZXhCb2R5LCBoZkJvZHksIHJzaSwgcnNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgcGFydGljbGVDeWxpbmRlcihzaSwgc2osIHhpLCB4aiwgcWksIHFqLCBiaSwgYmosIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICByZXR1cm4gdGhpcy5jb252ZXhQYXJ0aWNsZShzaiwgc2ksIHhqLCB4aSwgcWosIHFpLCBiaiwgYmksIHJzaSwgcnNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgc3BoZXJlVHJpbWVzaChzcGhlcmVTaGFwZSwgdHJpbWVzaFNoYXBlLCBzcGhlcmVQb3MsIHRyaW1lc2hQb3MsIHNwaGVyZVF1YXQsIHRyaW1lc2hRdWF0LCBzcGhlcmVCb2R5LCB0cmltZXNoQm9keSwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIGNvbnN0IGVkZ2VWZXJ0ZXhBID0gc3BoZXJlVHJpbWVzaF9lZGdlVmVydGV4QTsKICAgICAgY29uc3QgZWRnZVZlcnRleEIgPSBzcGhlcmVUcmltZXNoX2VkZ2VWZXJ0ZXhCOwogICAgICBjb25zdCBlZGdlVmVjdG9yID0gc3BoZXJlVHJpbWVzaF9lZGdlVmVjdG9yOwogICAgICBjb25zdCBlZGdlVmVjdG9yVW5pdCA9IHNwaGVyZVRyaW1lc2hfZWRnZVZlY3RvclVuaXQ7CiAgICAgIGNvbnN0IGxvY2FsU3BoZXJlUG9zID0gc3BoZXJlVHJpbWVzaF9sb2NhbFNwaGVyZVBvczsKICAgICAgY29uc3QgdG1wID0gc3BoZXJlVHJpbWVzaF90bXA7CiAgICAgIGNvbnN0IGxvY2FsU3BoZXJlQUFCQiA9IHNwaGVyZVRyaW1lc2hfbG9jYWxTcGhlcmVBQUJCOwogICAgICBjb25zdCB2MiA9IHNwaGVyZVRyaW1lc2hfdjI7CiAgICAgIGNvbnN0IHJlbHBvcyA9IHNwaGVyZVRyaW1lc2hfcmVscG9zOwogICAgICBjb25zdCB0cmlhbmdsZXMgPSBzcGhlcmVUcmltZXNoX3RyaWFuZ2xlczsgLy8gQ29udmVydCBzcGhlcmUgcG9zaXRpb24gdG8gbG9jYWwgaW4gdGhlIHRyaW1lc2gKCiAgICAgIFRyYW5zZm9ybS5wb2ludFRvTG9jYWxGcmFtZSh0cmltZXNoUG9zLCB0cmltZXNoUXVhdCwgc3BoZXJlUG9zLCBsb2NhbFNwaGVyZVBvcyk7IC8vIEdldCB0aGUgYWFiYiBvZiB0aGUgc3BoZXJlIGxvY2FsbHkgaW4gdGhlIHRyaW1lc2gKCiAgICAgIGNvbnN0IHNwaGVyZVJhZGl1cyA9IHNwaGVyZVNoYXBlLnJhZGl1czsKICAgICAgbG9jYWxTcGhlcmVBQUJCLmxvd2VyQm91bmQuc2V0KGxvY2FsU3BoZXJlUG9zLnggLSBzcGhlcmVSYWRpdXMsIGxvY2FsU3BoZXJlUG9zLnkgLSBzcGhlcmVSYWRpdXMsIGxvY2FsU3BoZXJlUG9zLnogLSBzcGhlcmVSYWRpdXMpOwogICAgICBsb2NhbFNwaGVyZUFBQkIudXBwZXJCb3VuZC5zZXQobG9jYWxTcGhlcmVQb3MueCArIHNwaGVyZVJhZGl1cywgbG9jYWxTcGhlcmVQb3MueSArIHNwaGVyZVJhZGl1cywgbG9jYWxTcGhlcmVQb3MueiArIHNwaGVyZVJhZGl1cyk7CiAgICAgIHRyaW1lc2hTaGFwZS5nZXRUcmlhbmdsZXNJbkFBQkIobG9jYWxTcGhlcmVBQUJCLCB0cmlhbmdsZXMpOyAvL2ZvciAobGV0IGkgPSAwOyBpIDwgdHJpbWVzaFNoYXBlLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB0cmlhbmdsZXMucHVzaChpKTsgLy8gQWxsCiAgICAgIC8vIFZlcnRpY2VzCgogICAgICBjb25zdCB2ID0gc3BoZXJlVHJpbWVzaF92OwogICAgICBjb25zdCByYWRpdXNTcXVhcmVkID0gc3BoZXJlU2hhcGUucmFkaXVzICogc3BoZXJlU2hhcGUucmFkaXVzOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0cmlhbmdsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDM7IGorKykgewogICAgICAgICAgdHJpbWVzaFNoYXBlLmdldFZlcnRleCh0cmltZXNoU2hhcGUuaW5kaWNlc1t0cmlhbmdsZXNbaV0gKiAzICsgal0sIHYpOyAvLyBDaGVjayB2ZXJ0ZXggb3ZlcmxhcCBpbiBzcGhlcmUKCiAgICAgICAgICB2LnZzdWIobG9jYWxTcGhlcmVQb3MsIHJlbHBvcyk7CgogICAgICAgICAgaWYgKHJlbHBvcy5sZW5ndGhTcXVhcmVkKCkgPD0gcmFkaXVzU3F1YXJlZCkgewogICAgICAgICAgICAvLyBTYWZlIHVwCiAgICAgICAgICAgIHYyLmNvcHkodik7CiAgICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZSh0cmltZXNoUG9zLCB0cmltZXNoUXVhdCwgdjIsIHYpOwogICAgICAgICAgICB2LnZzdWIoc3BoZXJlUG9zLCByZWxwb3MpOwoKICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oc3BoZXJlQm9keSwgdHJpbWVzaEJvZHksIHNwaGVyZVNoYXBlLCB0cmltZXNoU2hhcGUsIHJzaSwgcnNqKTsKICAgICAgICAgICAgci5uaS5jb3B5KHJlbHBvcyk7CiAgICAgICAgICAgIHIubmkubm9ybWFsaXplKCk7IC8vIHJpIGlzIHRoZSB2ZWN0b3IgZnJvbSBzcGhlcmUgY2VudGVyIHRvIHRoZSBzcGhlcmUgc3VyZmFjZQoKICAgICAgICAgICAgci5yaS5jb3B5KHIubmkpOwogICAgICAgICAgICByLnJpLnNjYWxlKHNwaGVyZVNoYXBlLnJhZGl1cywgci5yaSk7CiAgICAgICAgICAgIHIucmkudmFkZChzcGhlcmVQb3MsIHIucmkpOwogICAgICAgICAgICByLnJpLnZzdWIoc3BoZXJlQm9keS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgICAgIHIucmouY29weSh2KTsKICAgICAgICAgICAgci5yai52c3ViKHRyaW1lc2hCb2R5LnBvc2l0aW9uLCByLnJqKTsgLy8gU3RvcmUgcmVzdWx0CgogICAgICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIENoZWNrIGFsbCBlZGdlcwoKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdHJpYW5nbGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCAzOyBqKyspIHsKICAgICAgICAgIHRyaW1lc2hTaGFwZS5nZXRWZXJ0ZXgodHJpbWVzaFNoYXBlLmluZGljZXNbdHJpYW5nbGVzW2ldICogMyArIGpdLCBlZGdlVmVydGV4QSk7CiAgICAgICAgICB0cmltZXNoU2hhcGUuZ2V0VmVydGV4KHRyaW1lc2hTaGFwZS5pbmRpY2VzW3RyaWFuZ2xlc1tpXSAqIDMgKyAoaiArIDEpICUgM10sIGVkZ2VWZXJ0ZXhCKTsKICAgICAgICAgIGVkZ2VWZXJ0ZXhCLnZzdWIoZWRnZVZlcnRleEEsIGVkZ2VWZWN0b3IpOyAvLyBQcm9qZWN0IHNwaGVyZSBwb3NpdGlvbiB0byB0aGUgZWRnZQoKICAgICAgICAgIGxvY2FsU3BoZXJlUG9zLnZzdWIoZWRnZVZlcnRleEIsIHRtcCk7CiAgICAgICAgICBjb25zdCBwb3NpdGlvbkFsb25nRWRnZUIgPSB0bXAuZG90KGVkZ2VWZWN0b3IpOwogICAgICAgICAgbG9jYWxTcGhlcmVQb3MudnN1YihlZGdlVmVydGV4QSwgdG1wKTsKICAgICAgICAgIGxldCBwb3NpdGlvbkFsb25nRWRnZUEgPSB0bXAuZG90KGVkZ2VWZWN0b3IpOwoKICAgICAgICAgIGlmIChwb3NpdGlvbkFsb25nRWRnZUEgPiAwICYmIHBvc2l0aW9uQWxvbmdFZGdlQiA8IDApIHsKICAgICAgICAgICAgLy8gTm93IGNoZWNrIHRoZSBvcnRob2dvbmFsIGRpc3RhbmNlIGZyb20gZWRnZSB0byBzcGhlcmUgY2VudGVyCiAgICAgICAgICAgIGxvY2FsU3BoZXJlUG9zLnZzdWIoZWRnZVZlcnRleEEsIHRtcCk7CiAgICAgICAgICAgIGVkZ2VWZWN0b3JVbml0LmNvcHkoZWRnZVZlY3Rvcik7CiAgICAgICAgICAgIGVkZ2VWZWN0b3JVbml0Lm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBwb3NpdGlvbkFsb25nRWRnZUEgPSB0bXAuZG90KGVkZ2VWZWN0b3JVbml0KTsKICAgICAgICAgICAgZWRnZVZlY3RvclVuaXQuc2NhbGUocG9zaXRpb25BbG9uZ0VkZ2VBLCB0bXApOwogICAgICAgICAgICB0bXAudmFkZChlZGdlVmVydGV4QSwgdG1wKTsgLy8gdG1wIGlzIG5vdyB0aGUgc3BoZXJlIGNlbnRlciBwb3NpdGlvbiBwcm9qZWN0ZWQgdG8gdGhlIGVkZ2UsIGRlZmluZWQgbG9jYWxseSBpbiB0aGUgdHJpbWVzaCBmcmFtZQoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRtcC5kaXN0YW5jZVRvKGxvY2FsU3BoZXJlUG9zKTsKCiAgICAgICAgICAgIGlmIChkaXN0IDwgc3BoZXJlU2hhcGUucmFkaXVzKSB7CiAgICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihzcGhlcmVCb2R5LCB0cmltZXNoQm9keSwgc3BoZXJlU2hhcGUsIHRyaW1lc2hTaGFwZSwgcnNpLCByc2opOwogICAgICAgICAgICAgIHRtcC52c3ViKGxvY2FsU3BoZXJlUG9zLCByLm5pKTsKICAgICAgICAgICAgICByLm5pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgIHIubmkuc2NhbGUoc3BoZXJlU2hhcGUucmFkaXVzLCByLnJpKTsKICAgICAgICAgICAgICByLnJpLnZhZGQoc3BoZXJlUG9zLCByLnJpKTsKICAgICAgICAgICAgICByLnJpLnZzdWIoc3BoZXJlQm9keS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKHRyaW1lc2hQb3MsIHRyaW1lc2hRdWF0LCB0bXAsIHRtcCk7CiAgICAgICAgICAgICAgdG1wLnZzdWIodHJpbWVzaEJvZHkucG9zaXRpb24sIHIucmopOwogICAgICAgICAgICAgIFRyYW5zZm9ybS52ZWN0b3JUb1dvcmxkRnJhbWUodHJpbWVzaFF1YXQsIHIubmksIHIubmkpOwogICAgICAgICAgICAgIFRyYW5zZm9ybS52ZWN0b3JUb1dvcmxkRnJhbWUodHJpbWVzaFF1YXQsIHIucmksIHIucmkpOwogICAgICAgICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIFRyaWFuZ2xlIGZhY2VzCgoKICAgICAgY29uc3QgdmEgPSBzcGhlcmVUcmltZXNoX3ZhOwogICAgICBjb25zdCB2YiA9IHNwaGVyZVRyaW1lc2hfdmI7CiAgICAgIGNvbnN0IHZjID0gc3BoZXJlVHJpbWVzaF92YzsKICAgICAgY29uc3Qgbm9ybWFsID0gc3BoZXJlVHJpbWVzaF9ub3JtYWw7CgogICAgICBmb3IgKGxldCBpID0gMCwgTiA9IHRyaWFuZ2xlcy5sZW5ndGg7IGkgIT09IE47IGkrKykgewogICAgICAgIHRyaW1lc2hTaGFwZS5nZXRUcmlhbmdsZVZlcnRpY2VzKHRyaWFuZ2xlc1tpXSwgdmEsIHZiLCB2Yyk7CiAgICAgICAgdHJpbWVzaFNoYXBlLmdldE5vcm1hbCh0cmlhbmdsZXNbaV0sIG5vcm1hbCk7CiAgICAgICAgbG9jYWxTcGhlcmVQb3MudnN1Yih2YSwgdG1wKTsKICAgICAgICBsZXQgZGlzdCA9IHRtcC5kb3Qobm9ybWFsKTsKICAgICAgICBub3JtYWwuc2NhbGUoZGlzdCwgdG1wKTsKICAgICAgICBsb2NhbFNwaGVyZVBvcy52c3ViKHRtcCwgdG1wKTsgLy8gdG1wIGlzIG5vdyB0aGUgc3BoZXJlIHBvc2l0aW9uIHByb2plY3RlZCB0byB0aGUgdHJpYW5nbGUgcGxhbmUKCiAgICAgICAgZGlzdCA9IHRtcC5kaXN0YW5jZVRvKGxvY2FsU3BoZXJlUG9zKTsKCiAgICAgICAgaWYgKFJheS5wb2ludEluVHJpYW5nbGUodG1wLCB2YSwgdmIsIHZjKSAmJiBkaXN0IDwgc3BoZXJlU2hhcGUucmFkaXVzKSB7CiAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgbGV0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihzcGhlcmVCb2R5LCB0cmltZXNoQm9keSwgc3BoZXJlU2hhcGUsIHRyaW1lc2hTaGFwZSwgcnNpLCByc2opOwogICAgICAgICAgdG1wLnZzdWIobG9jYWxTcGhlcmVQb3MsIHIubmkpOwogICAgICAgICAgci5uaS5ub3JtYWxpemUoKTsKICAgICAgICAgIHIubmkuc2NhbGUoc3BoZXJlU2hhcGUucmFkaXVzLCByLnJpKTsKICAgICAgICAgIHIucmkudmFkZChzcGhlcmVQb3MsIHIucmkpOwogICAgICAgICAgci5yaS52c3ViKHNwaGVyZUJvZHkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKHRyaW1lc2hQb3MsIHRyaW1lc2hRdWF0LCB0bXAsIHRtcCk7CiAgICAgICAgICB0bXAudnN1Yih0cmltZXNoQm9keS5wb3NpdGlvbiwgci5yaik7CiAgICAgICAgICBUcmFuc2Zvcm0udmVjdG9yVG9Xb3JsZEZyYW1lKHRyaW1lc2hRdWF0LCByLm5pLCByLm5pKTsKICAgICAgICAgIFRyYW5zZm9ybS52ZWN0b3JUb1dvcmxkRnJhbWUodHJpbWVzaFF1YXQsIHIucmksIHIucmkpOwogICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRyaWFuZ2xlcy5sZW5ndGggPSAwOwogICAgfQoKICAgIHBsYW5lVHJpbWVzaChwbGFuZVNoYXBlLCB0cmltZXNoU2hhcGUsIHBsYW5lUG9zLCB0cmltZXNoUG9zLCBwbGFuZVF1YXQsIHRyaW1lc2hRdWF0LCBwbGFuZUJvZHksIHRyaW1lc2hCb2R5LCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgLy8gTWFrZSBjb250YWN0cyEKICAgICAgY29uc3QgdiA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IG5vcm1hbCA9IHBsYW5lVHJpbWVzaF9ub3JtYWw7CiAgICAgIG5vcm1hbC5zZXQoMCwgMCwgMSk7CiAgICAgIHBsYW5lUXVhdC52bXVsdChub3JtYWwsIG5vcm1hbCk7IC8vIFR1cm4gbm9ybWFsIGFjY29yZGluZyB0byBwbGFuZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0cmltZXNoU2hhcGUudmVydGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAgICAgLy8gR2V0IHdvcmxkIHZlcnRleCBmcm9tIHRyaW1lc2gKICAgICAgICB0cmltZXNoU2hhcGUuZ2V0VmVydGV4KGksIHYpOyAvLyBTYWZlIHVwCgogICAgICAgIGNvbnN0IHYyID0gbmV3IFZlYzMoKTsKICAgICAgICB2Mi5jb3B5KHYpOwogICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZSh0cmltZXNoUG9zLCB0cmltZXNoUXVhdCwgdjIsIHYpOyAvLyBDaGVjayBwbGFuZSBzaWRlCgogICAgICAgIGNvbnN0IHJlbHBvcyA9IHBsYW5lVHJpbWVzaF9yZWxwb3M7CiAgICAgICAgdi52c3ViKHBsYW5lUG9zLCByZWxwb3MpOwogICAgICAgIGNvbnN0IGRvdCA9IG5vcm1hbC5kb3QocmVscG9zKTsKCiAgICAgICAgaWYgKGRvdCA8PSAwLjApIHsKICAgICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24ocGxhbmVCb2R5LCB0cmltZXNoQm9keSwgcGxhbmVTaGFwZSwgdHJpbWVzaFNoYXBlLCByc2ksIHJzaik7CiAgICAgICAgICByLm5pLmNvcHkobm9ybWFsKTsgLy8gQ29udGFjdCBub3JtYWwgaXMgdGhlIHBsYW5lIG5vcm1hbAogICAgICAgICAgLy8gR2V0IHZlcnRleCBwb3NpdGlvbiBwcm9qZWN0ZWQgb24gcGxhbmUKCiAgICAgICAgICBjb25zdCBwcm9qZWN0ZWQgPSBwbGFuZVRyaW1lc2hfcHJvamVjdGVkOwogICAgICAgICAgbm9ybWFsLnNjYWxlKHJlbHBvcy5kb3Qobm9ybWFsKSwgcHJvamVjdGVkKTsKICAgICAgICAgIHYudnN1Yihwcm9qZWN0ZWQsIHByb2plY3RlZCk7IC8vIHJpIGlzIHRoZSBwcm9qZWN0ZWQgd29ybGQgcG9zaXRpb24gbWludXMgcGxhbmUgcG9zaXRpb24KCiAgICAgICAgICByLnJpLmNvcHkocHJvamVjdGVkKTsKICAgICAgICAgIHIucmkudnN1YihwbGFuZUJvZHkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgci5yai5jb3B5KHYpOwogICAgICAgICAgci5yai52c3ViKHRyaW1lc2hCb2R5LnBvc2l0aW9uLCByLnJqKTsgLy8gU3RvcmUgcmVzdWx0CgogICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gLy8gY29udmV4VHJpbWVzaCgKICAgIC8vICAgc2k6IENvbnZleFBvbHloZWRyb24sIHNqOiBUcmltZXNoLCB4aTogVmVjMywgeGo6IFZlYzMsIHFpOiBRdWF0ZXJuaW9uLCBxajogUXVhdGVybmlvbiwKICAgIC8vICAgYmk6IEJvZHksIGJqOiBCb2R5LCByc2k/OiBTaGFwZSB8IG51bGwsIHJzaj86IFNoYXBlIHwgbnVsbCwKICAgIC8vICAgZmFjZUxpc3RBPzogbnVtYmVyW10gfCBudWxsLCBmYWNlTGlzdEI/OiBudW1iZXJbXSB8IG51bGwsCiAgICAvLyApIHsKICAgIC8vICAgY29uc3Qgc2VwQXhpcyA9IGNvbnZleENvbnZleF9zZXBBeGlzOwogICAgLy8gICBpZih4aS5kaXN0YW5jZVRvKHhqKSA+IHNpLmJvdW5kaW5nU3BoZXJlUmFkaXVzICsgc2ouYm91bmRpbmdTcGhlcmVSYWRpdXMpewogICAgLy8gICAgICAgcmV0dXJuOwogICAgLy8gICB9CiAgICAvLyAgIC8vIENvbnN0cnVjdCBhIHRlbXAgaHVsbCBmb3IgZWFjaCB0cmlhbmdsZQogICAgLy8gICBjb25zdCBodWxsQiA9IG5ldyBDb252ZXhQb2x5aGVkcm9uKCk7CiAgICAvLyAgIGh1bGxCLmZhY2VzID0gW1swLDEsMl1dOwogICAgLy8gICBjb25zdCB2YSA9IG5ldyBWZWMzKCk7CiAgICAvLyAgIGNvbnN0IHZiID0gbmV3IFZlYzMoKTsKICAgIC8vICAgY29uc3QgdmMgPSBuZXcgVmVjMygpOwogICAgLy8gICBodWxsQi52ZXJ0aWNlcyA9IFsKICAgIC8vICAgICAgIHZhLAogICAgLy8gICAgICAgdmIsCiAgICAvLyAgICAgICB2YwogICAgLy8gICBdOwogICAgLy8gICBmb3IgKGxldCBpID0gMDsgaSA8IHNqLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAvLyAgICAgICBjb25zdCB0cmlhbmdsZU5vcm1hbCA9IG5ldyBWZWMzKCk7CiAgICAvLyAgICAgICBzai5nZXROb3JtYWwoaSwgdHJpYW5nbGVOb3JtYWwpOwogICAgLy8gICAgICAgaHVsbEIuZmFjZU5vcm1hbHMgPSBbdHJpYW5nbGVOb3JtYWxdOwogICAgLy8gICAgICAgc2ouZ2V0VHJpYW5nbGVWZXJ0aWNlcyhpLCB2YSwgdmIsIHZjKTsKICAgIC8vICAgICAgIGxldCBkID0gc2kudGVzdFNlcEF4aXModHJpYW5nbGVOb3JtYWwsIGh1bGxCLCB4aSwgcWksIHhqLCBxaik7CiAgICAvLyAgICAgICBpZighZCl7CiAgICAvLyAgICAgICAgICAgdHJpYW5nbGVOb3JtYWwuc2NhbGUoLTEsIHRyaWFuZ2xlTm9ybWFsKTsKICAgIC8vICAgICAgICAgICBkID0gc2kudGVzdFNlcEF4aXModHJpYW5nbGVOb3JtYWwsIGh1bGxCLCB4aSwgcWksIHhqLCBxaik7CiAgICAvLyAgICAgICAgICAgaWYoIWQpewogICAgLy8gICAgICAgICAgICAgICBjb250aW51ZTsKICAgIC8vICAgICAgICAgICB9CiAgICAvLyAgICAgICB9CiAgICAvLyAgICAgICBjb25zdCByZXM6IENvbnZleFBvbHloZWRyb25Db250YWN0UG9pbnRbXSA9IFtdOwogICAgLy8gICAgICAgY29uc3QgcSA9IGNvbnZleENvbnZleF9xOwogICAgLy8gICAgICAgc2kuY2xpcEFnYWluc3RIdWxsKHhpLHFpLGh1bGxCLHhqLHFqLHRyaWFuZ2xlTm9ybWFsLC0xMDAsMTAwLHJlcyk7CiAgICAvLyAgICAgICBmb3IobGV0IGogPSAwOyBqICE9PSByZXMubGVuZ3RoOyBqKyspewogICAgLy8gICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSxiaixzaSxzaixyc2kscnNqKSwKICAgIC8vICAgICAgICAgICAgICAgcmkgPSByLnJpLAogICAgLy8gICAgICAgICAgICAgICByaiA9IHIucmo7CiAgICAvLyAgICAgICAgICAgci5uaS5jb3B5KHRyaWFuZ2xlTm9ybWFsKTsKICAgIC8vICAgICAgICAgICByLm5pLm5lZ2F0ZShyLm5pKTsKICAgIC8vICAgICAgICAgICByZXNbal0ubm9ybWFsLm5lZ2F0ZShxKTsKICAgIC8vICAgICAgICAgICBxLm11bHQocmVzW2pdLmRlcHRoLCBxKTsKICAgIC8vICAgICAgICAgICByZXNbal0ucG9pbnQudmFkZChxLCByaSk7CiAgICAvLyAgICAgICAgICAgcmouY29weShyZXNbal0ucG9pbnQpOwogICAgLy8gICAgICAgICAgIC8vIENvbnRhY3QgcG9pbnRzIGFyZSBpbiB3b3JsZCBjb29yZGluYXRlcy4gVHJhbnNmb3JtIGJhY2sgdG8gcmVsYXRpdmUKICAgIC8vICAgICAgICAgICByaS52c3ViKHhpLHJpKTsKICAgIC8vICAgICAgICAgICByai52c3ViKHhqLHJqKTsKICAgIC8vICAgICAgICAgICAvLyBNYWtlIHJlbGF0aXZlIHRvIGJvZGllcwogICAgLy8gICAgICAgICAgIHJpLnZhZGQoeGksIHJpKTsKICAgIC8vICAgICAgICAgICByaS52c3ViKGJpLnBvc2l0aW9uLCByaSk7CiAgICAvLyAgICAgICAgICAgcmoudmFkZCh4aiwgcmopOwogICAgLy8gICAgICAgICAgIHJqLnZzdWIoYmoucG9zaXRpb24sIHJqKTsKICAgIC8vICAgICAgICAgICByZXN1bHQucHVzaChyKTsKICAgIC8vICAgICAgIH0KICAgIC8vICAgfQogICAgLy8gfQoKCiAgfQogIGNvbnN0IGF2ZXJhZ2VOb3JtYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IGF2ZXJhZ2VDb250YWN0UG9pbnRBID0gbmV3IFZlYzMoKTsKICBjb25zdCBhdmVyYWdlQ29udGFjdFBvaW50QiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wVmVjMSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wVmVjMiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wUXVhdDEgPSBuZXcgUXVhdGVybmlvbigpOwogIGNvbnN0IHRtcFF1YXQyID0gbmV3IFF1YXRlcm5pb24oKTsKCiAgY29uc3QgcGxhbmVUcmltZXNoX25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGxhbmVUcmltZXNoX3JlbHBvcyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGxhbmVUcmltZXNoX3Byb2plY3RlZCA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9ub3JtYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfcmVscG9zID0gbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfdiA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF92MiA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9lZGdlVmVydGV4QSA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9lZGdlVmVydGV4QiA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9lZGdlVmVjdG9yID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVUcmltZXNoX2VkZ2VWZWN0b3JVbml0ID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVUcmltZXNoX2xvY2FsU3BoZXJlUG9zID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVUcmltZXNoX3RtcCA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF92YSA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF92YiA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF92YyA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9sb2NhbFNwaGVyZUFBQkIgPSBuZXcgQUFCQigpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfdHJpYW5nbGVzID0gW107CiAgY29uc3QgcG9pbnRfb25fcGxhbmVfdG9fc3BoZXJlID0gbmV3IFZlYzMoKTsKICBjb25zdCBwbGFuZV90b19zcGhlcmVfb3J0aG8gPSBuZXcgVmVjMygpOyAvLyBTZWUgaHR0cDovL2J1bGxldHBoeXNpY3MuY29tL0J1bGxldC9CdWxsZXRGdWxsL1NwaGVyZVRyaWFuZ2xlRGV0ZWN0b3JfOGNwcF9zb3VyY2UuaHRtbAoKICBjb25zdCBwb2ludEluUG9seWdvbl9lZGdlID0gbmV3IFZlYzMoKTsKICBjb25zdCBwb2ludEluUG9seWdvbl9lZGdlX3hfbm9ybWFsID0gbmV3IFZlYzMoKTsKICBjb25zdCBwb2ludEluUG9seWdvbl92dHAgPSBuZXcgVmVjMygpOwoKICBmdW5jdGlvbiBwb2ludEluUG9seWdvbih2ZXJ0cywgbm9ybWFsLCBwKSB7CiAgICBsZXQgcG9zaXRpdmVSZXN1bHQgPSBudWxsOwogICAgY29uc3QgTiA9IHZlcnRzLmxlbmd0aDsKCiAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgIGNvbnN0IHYgPSB2ZXJ0c1tpXTsgLy8gR2V0IGVkZ2UgdG8gdGhlIG5leHQgdmVydGV4CgogICAgICBjb25zdCBlZGdlID0gcG9pbnRJblBvbHlnb25fZWRnZTsKICAgICAgdmVydHNbKGkgKyAxKSAlIE5dLnZzdWIodiwgZWRnZSk7IC8vIEdldCBjcm9zcyBwcm9kdWN0IGJldHdlZW4gcG9seWdvbiBub3JtYWwgYW5kIHRoZSBlZGdlCgogICAgICBjb25zdCBlZGdlX3hfbm9ybWFsID0gcG9pbnRJblBvbHlnb25fZWRnZV94X25vcm1hbDsgLy9jb25zdCBlZGdlX3hfbm9ybWFsID0gbmV3IFZlYzMoKTsKCiAgICAgIGVkZ2UuY3Jvc3Mobm9ybWFsLCBlZGdlX3hfbm9ybWFsKTsgLy8gR2V0IHZlY3RvciBiZXR3ZWVuIHBvaW50IGFuZCBjdXJyZW50IHZlcnRleAoKICAgICAgY29uc3QgdmVydGV4X3RvX3AgPSBwb2ludEluUG9seWdvbl92dHA7CiAgICAgIHAudnN1Yih2LCB2ZXJ0ZXhfdG9fcCk7IC8vIFRoaXMgZG90IHByb2R1Y3QgZGV0ZXJtaW5lcyB3aGljaCBzaWRlIG9mIHRoZSBlZGdlIHRoZSBwb2ludCBpcwoKICAgICAgY29uc3QgciA9IGVkZ2VfeF9ub3JtYWwuZG90KHZlcnRleF90b19wKTsgLy8gSWYgYWxsIHN1Y2ggZG90IHByb2R1Y3RzIGhhdmUgc2FtZSBzaWduLCB3ZSBhcmUgaW5zaWRlIHRoZSBwb2x5Z29uLgoKICAgICAgaWYgKHBvc2l0aXZlUmVzdWx0ID09PSBudWxsIHx8IHIgPiAwICYmIHBvc2l0aXZlUmVzdWx0ID09PSB0cnVlIHx8IHIgPD0gMCAmJiBwb3NpdGl2ZVJlc3VsdCA9PT0gZmFsc2UpIHsKICAgICAgICBpZiAocG9zaXRpdmVSZXN1bHQgPT09IG51bGwpIHsKICAgICAgICAgIHBvc2l0aXZlUmVzdWx0ID0gciA+IDA7CiAgICAgICAgfQoKICAgICAgICBjb250aW51ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7IC8vIEVuY291bnRlcmVkIHNvbWUgb3RoZXIgc2lnbi4gRXhpdC4KICAgICAgfQogICAgfSAvLyBJZiB3ZSBnb3QgaGVyZSwgYWxsIGRvdCBwcm9kdWN0cyB3ZXJlIG9mIHRoZSBzYW1lIHNpZ24uCgoKICAgIHJldHVybiB0cnVlOwogIH0KCiAgY29uc3QgYm94X3RvX3NwaGVyZSA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQm94X25zID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVCb3hfbnMxID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVCb3hfbnMyID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVCb3hfc2lkZXMgPSBbbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKV07CiAgY29uc3Qgc3BoZXJlQm94X3NwaGVyZV90b19jb3JuZXIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUJveF9zaWRlX25zID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVCb3hfc2lkZV9uczEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUJveF9zaWRlX25zMiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgY29udmV4X3RvX3NwaGVyZSA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQ29udmV4X2VkZ2UgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF9lZGdlVW5pdCA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQ29udmV4X3NwaGVyZVRvQ29ybmVyID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVDb252ZXhfd29ybGRDb3JuZXIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF93b3JsZE5vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQ29udmV4X3dvcmxkUG9pbnQgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF93b3JsZFNwaGVyZVBvaW50Q2xvc2VzdFRvUGxhbmUgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF9wZW5ldHJhdGlvblZlYyA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQ29udmV4X3NwaGVyZVRvV29ybGRQb2ludCA9IG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIGNvbnN0IHBsYW5lQ29udmV4X3YgPSBuZXcgVmVjMygpOwogIGNvbnN0IHBsYW5lQ29udmV4X25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGxhbmVDb252ZXhfcmVscG9zID0gbmV3IFZlYzMoKTsKICBjb25zdCBwbGFuZUNvbnZleF9wcm9qZWN0ZWQgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleENvbnZleF9zZXBBeGlzID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb252ZXhDb252ZXhfcSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGFydGljbGVQbGFuZV9ub3JtYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IHBhcnRpY2xlUGxhbmVfcmVscG9zID0gbmV3IFZlYzMoKTsKICBjb25zdCBwYXJ0aWNsZVBsYW5lX3Byb2plY3RlZCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGFydGljbGVTcGhlcmVfbm9ybWFsID0gbmV3IFZlYzMoKTsgLy8gV0lQCgogIGNvbnN0IGNxaiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgY29uc3QgY29udmV4UGFydGljbGVfbG9jYWwgPSBuZXcgVmVjMygpOwogIG5ldyBWZWMzKCk7CiAgY29uc3QgY29udmV4UGFydGljbGVfcGVuZXRyYXRlZEZhY2VOb3JtYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleFBhcnRpY2xlX3ZlcnRleFRvUGFydGljbGUgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleFBhcnRpY2xlX3dvcmxkUGVuZXRyYXRpb25WZWMgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleEhlaWdodGZpZWxkX3RtcDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleEhlaWdodGZpZWxkX3RtcDIgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleEhlaWdodGZpZWxkX2ZhY2VMaXN0ID0gWzBdOwogIGNvbnN0IHNwaGVyZUhlaWdodGZpZWxkX3RtcDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUhlaWdodGZpZWxkX3RtcDIgPSBuZXcgVmVjMygpOwoKICBjbGFzcyBPdmVybGFwS2VlcGVyIHsKICAgIC8qKgogICAgICogQHRvZG8gUmVtb3ZlIHVzZWxlc3MgY29uc3RydWN0b3IKICAgICAqLwogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHRoaXMuY3VycmVudCA9IFtdOwogICAgICB0aGlzLnByZXZpb3VzID0gW107CiAgICB9CiAgICAvKioKICAgICAqIGdldEtleQogICAgICovCgoKICAgIGdldEtleShpLCBqKSB7CiAgICAgIGlmIChqIDwgaSkgewogICAgICAgIGNvbnN0IHRlbXAgPSBqOwogICAgICAgIGogPSBpOwogICAgICAgIGkgPSB0ZW1wOwogICAgICB9CgogICAgICByZXR1cm4gaSA8PCAxNiB8IGo7CiAgICB9CiAgICAvKioKICAgICAqIHNldAogICAgICovCgoKICAgIHNldChpLCBqKSB7CiAgICAgIC8vIEluc2VydGlvbiBzb3J0LiBUaGlzIHdheSB0aGUgZGlmZiB3aWxsIGhhdmUgbGluZWFyIGNvbXBsZXhpdHkuCiAgICAgIGNvbnN0IGtleSA9IHRoaXMuZ2V0S2V5KGksIGopOwogICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5jdXJyZW50OwogICAgICBsZXQgaW5kZXggPSAwOwoKICAgICAgd2hpbGUgKGtleSA+IGN1cnJlbnRbaW5kZXhdKSB7CiAgICAgICAgaW5kZXgrKzsKICAgICAgfQoKICAgICAgaWYgKGtleSA9PT0gY3VycmVudFtpbmRleF0pIHsKICAgICAgICByZXR1cm47IC8vIFBhaXIgd2FzIGFscmVhZHkgYWRkZWQKICAgICAgfQoKICAgICAgZm9yIChsZXQgaiA9IGN1cnJlbnQubGVuZ3RoIC0gMTsgaiA+PSBpbmRleDsgai0tKSB7CiAgICAgICAgY3VycmVudFtqICsgMV0gPSBjdXJyZW50W2pdOwogICAgICB9CgogICAgICBjdXJyZW50W2luZGV4XSA9IGtleTsKICAgIH0KICAgIC8qKgogICAgICogdGljawogICAgICovCgoKICAgIHRpY2soKSB7CiAgICAgIGNvbnN0IHRtcCA9IHRoaXMuY3VycmVudDsKICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5wcmV2aW91czsKICAgICAgdGhpcy5wcmV2aW91cyA9IHRtcDsKICAgICAgdGhpcy5jdXJyZW50Lmxlbmd0aCA9IDA7CiAgICB9CiAgICAvKioKICAgICAqIGdldERpZmYKICAgICAqLwoKCiAgICBnZXREaWZmKGFkZGl0aW9ucywgcmVtb3ZhbHMpIHsKICAgICAgY29uc3QgYSA9IHRoaXMuY3VycmVudDsKICAgICAgY29uc3QgYiA9IHRoaXMucHJldmlvdXM7CiAgICAgIGNvbnN0IGFsID0gYS5sZW5ndGg7CiAgICAgIGNvbnN0IGJsID0gYi5sZW5ndGg7CiAgICAgIGxldCBqID0gMDsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYWw7IGkrKykgewogICAgICAgIGxldCBmb3VuZCA9IGZhbHNlOwogICAgICAgIGNvbnN0IGtleUEgPSBhW2ldOwoKICAgICAgICB3aGlsZSAoa2V5QSA+IGJbal0pIHsKICAgICAgICAgIGorKzsKICAgICAgICB9CgogICAgICAgIGZvdW5kID0ga2V5QSA9PT0gYltqXTsKCiAgICAgICAgaWYgKCFmb3VuZCkgewogICAgICAgICAgdW5wYWNrQW5kUHVzaChhZGRpdGlvbnMsIGtleUEpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaiA9IDA7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsOyBpKyspIHsKICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTsKICAgICAgICBjb25zdCBrZXlCID0gYltpXTsKCiAgICAgICAgd2hpbGUgKGtleUIgPiBhW2pdKSB7CiAgICAgICAgICBqKys7CiAgICAgICAgfQoKICAgICAgICBmb3VuZCA9IGFbal0gPT09IGtleUI7CgogICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgIHVucGFja0FuZFB1c2gocmVtb3ZhbHMsIGtleUIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICB9CgogIGZ1bmN0aW9uIHVucGFja0FuZFB1c2goYXJyYXksIGtleSkgewogICAgYXJyYXkucHVzaCgoa2V5ICYgMHhmZmZmMDAwMCkgPj4gMTYsIGtleSAmIDB4MDAwMGZmZmYpOwogIH0KCiAgY29uc3QgZ2V0S2V5ID0gKGksIGopID0+IGkgPCBqID8gYCR7aX0tJHtqfWAgOiBgJHtqfS0ke2l9YDsKICAvKioKICAgKiBUdXBsZURpY3Rpb25hcnkKICAgKi8KCgogIGNsYXNzIFR1cGxlRGljdGlvbmFyeSB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5kYXRhID0gewogICAgICAgIGtleXM6IFtdCiAgICAgIH07CiAgICB9CgogICAgLyoqIGdldCAqLwogICAgZ2V0KGksIGopIHsKICAgICAgY29uc3Qga2V5ID0gZ2V0S2V5KGksIGopOwogICAgICByZXR1cm4gdGhpcy5kYXRhW2tleV07CiAgICB9CiAgICAvKiogc2V0ICovCgoKICAgIHNldChpLCBqLCB2YWx1ZSkgewogICAgICBjb25zdCBrZXkgPSBnZXRLZXkoaSwgaik7IC8vIENoZWNrIGlmIGtleSBhbHJlYWR5IGV4aXN0cwoKICAgICAgaWYgKCF0aGlzLmdldChpLCBqKSkgewogICAgICAgIHRoaXMuZGF0YS5rZXlzLnB1c2goa2V5KTsKICAgICAgfQoKICAgICAgdGhpcy5kYXRhW2tleV0gPSB2YWx1ZTsKICAgIH0KICAgIC8qKiBkZWxldGUgKi8KCgogICAgZGVsZXRlKGksIGopIHsKICAgICAgY29uc3Qga2V5ID0gZ2V0S2V5KGksIGopOwogICAgICBjb25zdCBpbmRleCA9IHRoaXMuZGF0YS5rZXlzLmluZGV4T2Yoa2V5KTsKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICB0aGlzLmRhdGEua2V5cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CgogICAgICBkZWxldGUgdGhpcy5kYXRhW2tleV07CiAgICB9CiAgICAvKiogcmVzZXQgKi8KCgogICAgcmVzZXQoKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGNvbnN0IGtleXMgPSBkYXRhLmtleXM7CgogICAgICB3aGlsZSAoa2V5cy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3Qga2V5ID0ga2V5cy5wb3AoKTsKICAgICAgICBkZWxldGUgZGF0YVtrZXldOwogICAgICB9CiAgICB9CgogIH0KCiAgLyoqCiAgICogVGhlIHBoeXNpY3Mgd29ybGQKICAgKi8KICBjbGFzcyBXb3JsZCBleHRlbmRzIEV2ZW50VGFyZ2V0IHsKICAgIC8qKgogICAgICogQ3VycmVudGx5IC8gbGFzdCB1c2VkIHRpbWVzdGVwLiBJcyBzZXQgdG8gLTEgaWYgbm90IGF2YWlsYWJsZS4gVGhpcyB2YWx1ZSBpcyB1cGRhdGVkIGJlZm9yZSBlYWNoIGludGVybmFsIHN0ZXAsIHdoaWNoIG1lYW5zIHRoYXQgaXQgaXMgImZyZXNoIiBpbnNpZGUgZXZlbnQgY2FsbGJhY2tzLgogICAgICovCgogICAgLyoqCiAgICAgKiBNYWtlcyBib2RpZXMgZ28gdG8gc2xlZXAgd2hlbiB0aGV5J3ZlIGJlZW4gaW5hY3RpdmUuCiAgICAgKiBAZGVmYXVsdCBmYWxzZQogICAgICovCgogICAgLyoqCiAgICAgKiBBbGwgdGhlIGN1cnJlbnQgY29udGFjdHMgKGluc3RhbmNlcyBvZiBDb250YWN0RXF1YXRpb24pIGluIHRoZSB3b3JsZC4KICAgICAqLwoKICAgIC8qKgogICAgICogSG93IG9mdGVuIHRvIG5vcm1hbGl6ZSBxdWF0ZXJuaW9ucy4gU2V0IHRvIDAgZm9yIGV2ZXJ5IHN0ZXAsIDEgZm9yIGV2ZXJ5IHNlY29uZCBldGMuLiBBIGxhcmdlciB2YWx1ZSBpbmNyZWFzZXMgcGVyZm9ybWFuY2UuIElmIGJvZGllcyB0ZW5kIHRvIGV4cGxvZGUsIHNldCB0byBhIHNtYWxsZXIgdmFsdWUgKHplcm8gdG8gYmUgc3VyZSBub3RoaW5nIGNhbiBnbyB3cm9uZykuCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNldCB0byB0cnVlIHRvIHVzZSBmYXN0IHF1YXRlcm5pb24gbm9ybWFsaXphdGlvbi4gSXQgaXMgb2Z0ZW4gZW5vdWdoIGFjY3VyYXRlIHRvIHVzZS4KICAgICAqIElmIGJvZGllcyB0ZW5kIHRvIGV4cGxvZGUsIHNldCB0byBmYWxzZS4KICAgICAqIEBkZWZhdWx0IGZhbHNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSB3YWxsLWNsb2NrIHRpbWUgc2luY2Ugc2ltdWxhdGlvbiBzdGFydC4KICAgICAqLwoKICAgIC8qKgogICAgICogTnVtYmVyIG9mIHRpbWVzdGVwcyB0YWtlbiBzaW5jZSBzdGFydC4KICAgICAqLwoKICAgIC8qKgogICAgICogRGVmYXVsdCBhbmQgbGFzdCB0aW1lc3RlcCBzaXplcy4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGdyYXZpdHkgb2YgdGhlIHdvcmxkLgogICAgICovCgogICAgLyoqCiAgICAgKiBHcmF2aXR5IHRvIHVzZSB3aGVuIGFwcHJveGltYXRpbmcgdGhlIGZyaWN0aW9uIG1heCBmb3JjZSAobXUqbWFzcypncmF2aXR5KS4KICAgICAqIElmIHVuZGVmaW5lZCwgZ2xvYmFsIGdyYXZpdHkgd2lsbCBiZSB1c2VkLgogICAgICogVXNlIHRvIGVuYWJsZSBmcmljdGlvbiBpbiBhIFdvcmxkIHdpdGggYSBudWxsIGdyYXZpdHkgdmVjdG9yIChubyBncmF2aXR5KS4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGJyb2FkcGhhc2UgYWxnb3JpdGhtIHRvIHVzZS4KICAgICAqIEBkZWZhdWx0IE5haXZlQnJvYWRwaGFzZQogICAgICovCgogICAgLyoqCiAgICAgKiBBbGwgYm9kaWVzIGluIHRoaXMgd29ybGQKICAgICAqLwoKICAgIC8qKgogICAgICogVHJ1ZSBpZiBhbnkgYm9kaWVzIGFyZSBub3Qgc2xlZXBpbmcsIGZhbHNlIGlmIGV2ZXJ5IGJvZHkgaXMgc2xlZXBpbmcuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBzb2x2ZXIgYWxnb3JpdGhtIHRvIHVzZS4KICAgICAqIEBkZWZhdWx0IEdTU29sdmVyCiAgICAgKi8KCiAgICAvKioKICAgICAqIGNvbGxpc2lvbk1hdHJpeAogICAgICovCgogICAgLyoqCiAgICAgKiBDb2xsaXNpb25NYXRyaXggZnJvbSB0aGUgcHJldmlvdXMgc3RlcC4KICAgICAqLwoKICAgIC8qKgogICAgICogQWxsIGFkZGVkIGNvbnRhY3RtYXRlcmlhbHMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFVzZWQgdG8gbG9vayB1cCBhIENvbnRhY3RNYXRlcmlhbCBnaXZlbiB0d28gaW5zdGFuY2VzIG9mIE1hdGVyaWFsLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgZGVmYXVsdCBtYXRlcmlhbCBvZiB0aGUgYm9kaWVzLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGlzIGNvbnRhY3QgbWF0ZXJpYWwgaXMgdXNlZCBpZiBubyBzdWl0YWJsZSBjb250YWN0bWF0ZXJpYWwgaXMgZm91bmQgZm9yIGEgY29udGFjdC4KICAgICAqLwoKICAgIC8qKgogICAgICogVGltZSBhY2N1bXVsYXRvciBmb3IgaW50ZXJwb2xhdGlvbi4KICAgICAqIEBzZWUgaHR0cHM6Ly9nYWZmZXJvbmdhbWVzLmNvbS9nYW1lLXBoeXNpY3MvZml4LXlvdXItdGltZXN0ZXAvCiAgICAgKi8KCiAgICAvKioKICAgICAqIERpc3BhdGNoZWQgYWZ0ZXIgYSBib2R5IGhhcyBiZWVuIGFkZGVkIHRvIHRoZSB3b3JsZC4KICAgICAqLwoKICAgIC8qKgogICAgICogRGlzcGF0Y2hlZCBhZnRlciBhIGJvZHkgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSB3b3JsZC4KICAgICAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBzdXBlcigpOwogICAgICB0aGlzLmR0ID0gLTE7CiAgICAgIHRoaXMuYWxsb3dTbGVlcCA9ICEhb3B0aW9ucy5hbGxvd1NsZWVwOwogICAgICB0aGlzLmNvbnRhY3RzID0gW107CiAgICAgIHRoaXMuZnJpY3Rpb25FcXVhdGlvbnMgPSBbXTsKICAgICAgdGhpcy5xdWF0Tm9ybWFsaXplU2tpcCA9IG9wdGlvbnMucXVhdE5vcm1hbGl6ZVNraXAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMucXVhdE5vcm1hbGl6ZVNraXAgOiAwOwogICAgICB0aGlzLnF1YXROb3JtYWxpemVGYXN0ID0gb3B0aW9ucy5xdWF0Tm9ybWFsaXplRmFzdCAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5xdWF0Tm9ybWFsaXplRmFzdCA6IGZhbHNlOwogICAgICB0aGlzLnRpbWUgPSAwLjA7CiAgICAgIHRoaXMuc3RlcG51bWJlciA9IDA7CiAgICAgIHRoaXMuZGVmYXVsdF9kdCA9IDEgLyA2MDsKICAgICAgdGhpcy5uZXh0SWQgPSAwOwogICAgICB0aGlzLmdyYXZpdHkgPSBuZXcgVmVjMygpOwoKICAgICAgaWYgKG9wdGlvbnMuZ3Jhdml0eSkgewogICAgICAgIHRoaXMuZ3Jhdml0eS5jb3B5KG9wdGlvbnMuZ3Jhdml0eSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLmZyaWN0aW9uR3Jhdml0eSkgewogICAgICAgIHRoaXMuZnJpY3Rpb25HcmF2aXR5ID0gbmV3IFZlYzMoKTsKICAgICAgICB0aGlzLmZyaWN0aW9uR3Jhdml0eS5jb3B5KG9wdGlvbnMuZnJpY3Rpb25HcmF2aXR5KTsKICAgICAgfQoKICAgICAgdGhpcy5icm9hZHBoYXNlID0gb3B0aW9ucy5icm9hZHBoYXNlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmJyb2FkcGhhc2UgOiBuZXcgTmFpdmVCcm9hZHBoYXNlKCk7CiAgICAgIHRoaXMuYm9kaWVzID0gW107CiAgICAgIHRoaXMuaGFzQWN0aXZlQm9kaWVzID0gZmFsc2U7CiAgICAgIHRoaXMuc29sdmVyID0gb3B0aW9ucy5zb2x2ZXIgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc29sdmVyIDogbmV3IEdTU29sdmVyKCk7CiAgICAgIHRoaXMuY29uc3RyYWludHMgPSBbXTsKICAgICAgdGhpcy5uYXJyb3dwaGFzZSA9IG5ldyBOYXJyb3dwaGFzZSh0aGlzKTsKICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXggPSBuZXcgQXJyYXlDb2xsaXNpb25NYXRyaXgoKTsKICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXhQcmV2aW91cyA9IG5ldyBBcnJheUNvbGxpc2lvbk1hdHJpeCgpOwogICAgICB0aGlzLmJvZHlPdmVybGFwS2VlcGVyID0gbmV3IE92ZXJsYXBLZWVwZXIoKTsKICAgICAgdGhpcy5zaGFwZU92ZXJsYXBLZWVwZXIgPSBuZXcgT3ZlcmxhcEtlZXBlcigpOwogICAgICB0aGlzLmNvbnRhY3RtYXRlcmlhbHMgPSBbXTsKICAgICAgdGhpcy5jb250YWN0TWF0ZXJpYWxUYWJsZSA9IG5ldyBUdXBsZURpY3Rpb25hcnkoKTsKICAgICAgdGhpcy5kZWZhdWx0TWF0ZXJpYWwgPSBuZXcgTWF0ZXJpYWwoJ2RlZmF1bHQnKTsKICAgICAgdGhpcy5kZWZhdWx0Q29udGFjdE1hdGVyaWFsID0gbmV3IENvbnRhY3RNYXRlcmlhbCh0aGlzLmRlZmF1bHRNYXRlcmlhbCwgdGhpcy5kZWZhdWx0TWF0ZXJpYWwsIHsKICAgICAgICBmcmljdGlvbjogMC4zLAogICAgICAgIHJlc3RpdHV0aW9uOiAwLjAKICAgICAgfSk7CiAgICAgIHRoaXMuZG9Qcm9maWxpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5wcm9maWxlID0gewogICAgICAgIHNvbHZlOiAwLAogICAgICAgIG1ha2VDb250YWN0Q29uc3RyYWludHM6IDAsCiAgICAgICAgYnJvYWRwaGFzZTogMCwKICAgICAgICBpbnRlZ3JhdGU6IDAsCiAgICAgICAgbmFycm93cGhhc2U6IDAKICAgICAgfTsKICAgICAgdGhpcy5hY2N1bXVsYXRvciA9IDA7CiAgICAgIHRoaXMuc3Vic3lzdGVtcyA9IFtdOwogICAgICB0aGlzLmFkZEJvZHlFdmVudCA9IHsKICAgICAgICB0eXBlOiAnYWRkQm9keScsCiAgICAgICAgYm9keTogbnVsbAogICAgICB9OwogICAgICB0aGlzLnJlbW92ZUJvZHlFdmVudCA9IHsKICAgICAgICB0eXBlOiAncmVtb3ZlQm9keScsCiAgICAgICAgYm9keTogbnVsbAogICAgICB9OwogICAgICB0aGlzLmlkVG9Cb2R5TWFwID0ge307CiAgICAgIHRoaXMuYnJvYWRwaGFzZS5zZXRXb3JsZCh0aGlzKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBjb250YWN0IG1hdGVyaWFsIGJldHdlZW4gbWF0ZXJpYWxzIG0xIGFuZCBtMgogICAgICogQHJldHVybiBUaGUgY29udGFjdCBtYXRlcmlhbCBpZiBpdCB3YXMgZm91bmQuCiAgICAgKi8KCgogICAgZ2V0Q29udGFjdE1hdGVyaWFsKG0xLCBtMikgewogICAgICByZXR1cm4gdGhpcy5jb250YWN0TWF0ZXJpYWxUYWJsZS5nZXQobTEuaWQsIG0yLmlkKTsKICAgIH0KICAgIC8qKgogICAgICogU3RvcmUgb2xkIGNvbGxpc2lvbiBzdGF0ZSBpbmZvCiAgICAgKi8KCgogICAgY29sbGlzaW9uTWF0cml4VGljaygpIHsKICAgICAgY29uc3QgdGVtcCA9IHRoaXMuY29sbGlzaW9uTWF0cml4UHJldmlvdXM7CiAgICAgIHRoaXMuY29sbGlzaW9uTWF0cml4UHJldmlvdXMgPSB0aGlzLmNvbGxpc2lvbk1hdHJpeDsKICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXggPSB0ZW1wOwogICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeC5yZXNldCgpOwogICAgICB0aGlzLmJvZHlPdmVybGFwS2VlcGVyLnRpY2soKTsKICAgICAgdGhpcy5zaGFwZU92ZXJsYXBLZWVwZXIudGljaygpOwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgYSBjb25zdHJhaW50IHRvIHRoZSBzaW11bGF0aW9uLgogICAgICovCgoKICAgIGFkZENvbnN0cmFpbnQoYykgewogICAgICB0aGlzLmNvbnN0cmFpbnRzLnB1c2goYyk7CiAgICB9CiAgICAvKioKICAgICAqIFJlbW92ZXMgYSBjb25zdHJhaW50CiAgICAgKi8KCgogICAgcmVtb3ZlQ29uc3RyYWludChjKSB7CiAgICAgIGNvbnN0IGlkeCA9IHRoaXMuY29uc3RyYWludHMuaW5kZXhPZihjKTsKCiAgICAgIGlmIChpZHggIT09IC0xKSB7CiAgICAgICAgdGhpcy5jb25zdHJhaW50cy5zcGxpY2UoaWR4LCAxKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSYXljYXN0IHRlc3QKICAgICAqIEBkZXByZWNhdGVkIFVzZSAucmF5Y2FzdEFsbCwgLnJheWNhc3RDbG9zZXN0IG9yIC5yYXljYXN0QW55IGluc3RlYWQuCiAgICAgKi8KCgogICAgcmF5VGVzdChmcm9tLCB0bywgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBSYXljYXN0UmVzdWx0KSB7CiAgICAgICAgLy8gRG8gcmF5Y2FzdENsb3Nlc3QKICAgICAgICB0aGlzLnJheWNhc3RDbG9zZXN0KGZyb20sIHRvLCB7CiAgICAgICAgICBza2lwQmFja2ZhY2VzOiB0cnVlCiAgICAgICAgfSwgcmVzdWx0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBEbyByYXljYXN0QWxsCiAgICAgICAgdGhpcy5yYXljYXN0QWxsKGZyb20sIHRvLCB7CiAgICAgICAgICBza2lwQmFja2ZhY2VzOiB0cnVlCiAgICAgICAgfSwgcmVzdWx0KTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSYXkgY2FzdCBhZ2FpbnN0IGFsbCBib2RpZXMuIFRoZSBwcm92aWRlZCBjYWxsYmFjayB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoIGhpdCB3aXRoIGEgUmF5Y2FzdFJlc3VsdCBhcyBzaW5nbGUgYXJndW1lbnQuCiAgICAgKiBAcmV0dXJuIFRydWUgaWYgYW55IGJvZHkgd2FzIGhpdC4KICAgICAqLwoKCiAgICByYXljYXN0QWxsKGZyb20sIHRvLCBvcHRpb25zLCBjYWxsYmFjaykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBvcHRpb25zLm1vZGUgPSBSYXkuQUxMOwogICAgICBvcHRpb25zLmZyb20gPSBmcm9tOwogICAgICBvcHRpb25zLnRvID0gdG87CiAgICAgIG9wdGlvbnMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgcmV0dXJuIHRtcFJheS5pbnRlcnNlY3RXb3JsZCh0aGlzLCBvcHRpb25zKTsKICAgIH0KICAgIC8qKgogICAgICogUmF5IGNhc3QsIGFuZCBzdG9wIGF0IHRoZSBmaXJzdCByZXN1bHQuIE5vdGUgdGhhdCB0aGUgb3JkZXIgaXMgcmFuZG9tIC0gYnV0IHRoZSBtZXRob2QgaXMgZmFzdC4KICAgICAqIEByZXR1cm4gVHJ1ZSBpZiBhbnkgYm9keSB3YXMgaGl0LgogICAgICovCgoKICAgIHJheWNhc3RBbnkoZnJvbSwgdG8sIG9wdGlvbnMsIHJlc3VsdCkgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBvcHRpb25zLm1vZGUgPSBSYXkuQU5ZOwogICAgICBvcHRpb25zLmZyb20gPSBmcm9tOwogICAgICBvcHRpb25zLnRvID0gdG87CiAgICAgIG9wdGlvbnMucmVzdWx0ID0gcmVzdWx0OwogICAgICByZXR1cm4gdG1wUmF5LmludGVyc2VjdFdvcmxkKHRoaXMsIG9wdGlvbnMpOwogICAgfQogICAgLyoqCiAgICAgKiBSYXkgY2FzdCwgYW5kIHJldHVybiBpbmZvcm1hdGlvbiBvZiB0aGUgY2xvc2VzdCBoaXQuCiAgICAgKiBAcmV0dXJuIFRydWUgaWYgYW55IGJvZHkgd2FzIGhpdC4KICAgICAqLwoKCiAgICByYXljYXN0Q2xvc2VzdChmcm9tLCB0bywgb3B0aW9ucywgcmVzdWx0KSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIG9wdGlvbnMubW9kZSA9IFJheS5DTE9TRVNUOwogICAgICBvcHRpb25zLmZyb20gPSBmcm9tOwogICAgICBvcHRpb25zLnRvID0gdG87CiAgICAgIG9wdGlvbnMucmVzdWx0ID0gcmVzdWx0OwogICAgICByZXR1cm4gdG1wUmF5LmludGVyc2VjdFdvcmxkKHRoaXMsIG9wdGlvbnMpOwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgYSByaWdpZCBib2R5IHRvIHRoZSBzaW11bGF0aW9uLgogICAgICogQHRvZG8gSWYgdGhlIHNpbXVsYXRpb24gaGFzIG5vdCB5ZXQgc3RhcnRlZCwgd2h5IHJlY3JldGUgYW5kIGNvcHkgYXJyYXlzIGZvciBlYWNoIGJvZHk/IEFjY3VtdWxhdGUgaW4gZHluYW1pYyBhcnJheXMgaW4gdGhpcyBjYXNlLgogICAgICogQHRvZG8gQWRkaW5nIGFuIGFycmF5IG9mIGJvZGllcyBzaG91bGQgYmUgcG9zc2libGUuIFRoaXMgd291bGQgc2F2ZSBzb21lIGxvb3BzIHRvbwogICAgICovCgoKICAgIGFkZEJvZHkoYm9keSkgewogICAgICBpZiAodGhpcy5ib2RpZXMuaW5jbHVkZXMoYm9keSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGJvZHkuaW5kZXggPSB0aGlzLmJvZGllcy5sZW5ndGg7CiAgICAgIHRoaXMuYm9kaWVzLnB1c2goYm9keSk7CiAgICAgIGJvZHkud29ybGQgPSB0aGlzOwogICAgICBib2R5LmluaXRQb3NpdGlvbi5jb3B5KGJvZHkucG9zaXRpb24pOwogICAgICBib2R5LmluaXRWZWxvY2l0eS5jb3B5KGJvZHkudmVsb2NpdHkpOwogICAgICBib2R5LnRpbWVMYXN0U2xlZXB5ID0gdGhpcy50aW1lOwoKICAgICAgaWYgKGJvZHkgaW5zdGFuY2VvZiBCb2R5KSB7CiAgICAgICAgYm9keS5pbml0QW5ndWxhclZlbG9jaXR5LmNvcHkoYm9keS5hbmd1bGFyVmVsb2NpdHkpOwogICAgICAgIGJvZHkuaW5pdFF1YXRlcm5pb24uY29weShib2R5LnF1YXRlcm5pb24pOwogICAgICB9CgogICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeC5zZXROdW1PYmplY3RzKHRoaXMuYm9kaWVzLmxlbmd0aCk7CiAgICAgIHRoaXMuYWRkQm9keUV2ZW50LmJvZHkgPSBib2R5OwogICAgICB0aGlzLmlkVG9Cb2R5TWFwW2JvZHkuaWRdID0gYm9keTsKICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KHRoaXMuYWRkQm9keUV2ZW50KTsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlIGEgcmlnaWQgYm9keSBmcm9tIHRoZSBzaW11bGF0aW9uLgogICAgICovCgoKICAgIHJlbW92ZUJvZHkoYm9keSkgewogICAgICBib2R5LndvcmxkID0gbnVsbDsKICAgICAgY29uc3QgbiA9IHRoaXMuYm9kaWVzLmxlbmd0aCAtIDE7CiAgICAgIGNvbnN0IGJvZGllcyA9IHRoaXMuYm9kaWVzOwogICAgICBjb25zdCBpZHggPSBib2RpZXMuaW5kZXhPZihib2R5KTsKCiAgICAgIGlmIChpZHggIT09IC0xKSB7CiAgICAgICAgYm9kaWVzLnNwbGljZShpZHgsIDEpOyAvLyBUb2RvOiBzaG91bGQgdXNlIGEgZ2FyYmFnZSBmcmVlIG1ldGhvZAogICAgICAgIC8vIFJlY29tcHV0ZSBpbmRleAoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gYm9kaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBib2RpZXNbaV0uaW5kZXggPSBpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXguc2V0TnVtT2JqZWN0cyhuKTsKICAgICAgICB0aGlzLnJlbW92ZUJvZHlFdmVudC5ib2R5ID0gYm9keTsKICAgICAgICBkZWxldGUgdGhpcy5pZFRvQm9keU1hcFtib2R5LmlkXTsKICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQodGhpcy5yZW1vdmVCb2R5RXZlbnQpOwogICAgICB9CiAgICB9CgogICAgZ2V0Qm9keUJ5SWQoaWQpIHsKICAgICAgcmV0dXJuIHRoaXMuaWRUb0JvZHlNYXBbaWRdOwogICAgfQogICAgLyoqCiAgICAgKiBAdG9kbyBNYWtlIGEgZmFzdGVyIG1hcAogICAgICovCgoKICAgIGdldFNoYXBlQnlJZChpZCkgewogICAgICBjb25zdCBib2RpZXMgPSB0aGlzLmJvZGllczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYm9kaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3Qgc2hhcGVzID0gYm9kaWVzW2ldLnNoYXBlczsKCiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzaGFwZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IHNoYXBlID0gc2hhcGVzW2pdOwoKICAgICAgICAgIGlmIChzaGFwZS5pZCA9PT0gaWQpIHsKICAgICAgICAgICAgcmV0dXJuIHNoYXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAvKioKICAgICAqIEFkZHMgYSBjb250YWN0IG1hdGVyaWFsIHRvIHRoZSBXb3JsZAogICAgICovCgoKICAgIGFkZENvbnRhY3RNYXRlcmlhbChjbWF0KSB7CiAgICAgIC8vIEFkZCBjb250YWN0IG1hdGVyaWFsCiAgICAgIHRoaXMuY29udGFjdG1hdGVyaWFscy5wdXNoKGNtYXQpOyAvLyBBZGQgY3VycmVudCBjb250YWN0IG1hdGVyaWFsIHRvIHRoZSBtYXRlcmlhbCB0YWJsZQoKICAgICAgdGhpcy5jb250YWN0TWF0ZXJpYWxUYWJsZS5zZXQoY21hdC5tYXRlcmlhbHNbMF0uaWQsIGNtYXQubWF0ZXJpYWxzWzFdLmlkLCBjbWF0KTsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlcyBhIGNvbnRhY3QgbWF0ZXJpYWwgZnJvbSB0aGUgV29ybGQuCiAgICAgKi8KCgogICAgcmVtb3ZlQ29udGFjdE1hdGVyaWFsKGNtYXQpIHsKICAgICAgY29uc3QgaWR4ID0gdGhpcy5jb250YWN0bWF0ZXJpYWxzLmluZGV4T2YoY21hdCk7CgogICAgICBpZiAoaWR4ID09PSAtMSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5jb250YWN0bWF0ZXJpYWxzLnNwbGljZShpZHgsIDEpOwogICAgICB0aGlzLmNvbnRhY3RNYXRlcmlhbFRhYmxlLmRlbGV0ZShjbWF0Lm1hdGVyaWFsc1swXS5pZCwgY21hdC5tYXRlcmlhbHNbMV0uaWQpOwogICAgfQogICAgLyoqCiAgICAgKiBTdGVwIHRoZSBzaW11bGF0aW9uIGZvcndhcmQga2VlcGluZyB0cmFjayBvZiBsYXN0IGNhbGxlZCB0aW1lCiAgICAgKiB0byBiZSBhYmxlIHRvIHN0ZXAgdGhlIHdvcmxkIGF0IGEgZml4ZWQgcmF0ZSwgaW5kZXBlbmRlbnRseSBvZiBmcmFtZXJhdGUuCiAgICAgKgogICAgICogQHBhcmFtIGR0IFRoZSBmaXhlZCB0aW1lIHN0ZXAgc2l6ZSB0byB1c2UgKGRlZmF1bHQ6IDEgLyA2MCkuCiAgICAgKiBAcGFyYW0gbWF4U3ViU3RlcHMgTWF4aW11bSBudW1iZXIgb2YgZml4ZWQgc3RlcHMgdG8gdGFrZSBwZXIgZnVuY3Rpb24gY2FsbCAoZGVmYXVsdDogMTApLgogICAgICogQHNlZSBodHRwczovL2dhZmZlcm9uZ2FtZXMuY29tL3Bvc3QvZml4X3lvdXJfdGltZXN0ZXAvCiAgICAgKiBAZXhhbXBsZQogICAgICogICAgIC8vIFJ1biB0aGUgc2ltdWxhdGlvbiBpbmRlcGVuZGVudGx5IG9mIGZyYW1lcmF0ZSBldmVyeSAxIC8gNjAgbXMKICAgICAqICAgICB3b3JsZC5maXhlZFN0ZXAoKQogICAgICovCgoKICAgIGZpeGVkU3RlcChkdCwgbWF4U3ViU3RlcHMpIHsKICAgICAgaWYgKGR0ID09PSB2b2lkIDApIHsKICAgICAgICBkdCA9IDEgLyA2MDsKICAgICAgfQoKICAgICAgaWYgKG1heFN1YlN0ZXBzID09PSB2b2lkIDApIHsKICAgICAgICBtYXhTdWJTdGVwcyA9IDEwOwogICAgICB9CgogICAgICBjb25zdCB0aW1lID0gcGVyZm9ybWFuY2Uubm93KCkgLyAxMDAwOyAvLyBzZWNvbmRzCgogICAgICBpZiAoIXRoaXMubGFzdENhbGxUaW1lKSB7CiAgICAgICAgdGhpcy5zdGVwKGR0LCB1bmRlZmluZWQsIG1heFN1YlN0ZXBzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCB0aW1lU2luY2VMYXN0Q2FsbGVkID0gdGltZSAtIHRoaXMubGFzdENhbGxUaW1lOwogICAgICAgIHRoaXMuc3RlcChkdCwgdGltZVNpbmNlTGFzdENhbGxlZCwgbWF4U3ViU3RlcHMpOwogICAgICB9CgogICAgICB0aGlzLmxhc3RDYWxsVGltZSA9IHRpbWU7CiAgICB9CiAgICAvKioKICAgICAqIFN0ZXAgdGhlIHBoeXNpY3Mgd29ybGQgZm9yd2FyZCBpbiB0aW1lLgogICAgICoKICAgICAqIFRoZXJlIGFyZSB0d28gbW9kZXMuIFRoZSBzaW1wbGUgbW9kZSBpcyBmaXhlZCB0aW1lc3RlcHBpbmcgd2l0aG91dCBpbnRlcnBvbGF0aW9uLiBJbiB0aGlzIGNhc2UgeW91IG9ubHkgdXNlIHRoZSBmaXJzdCBhcmd1bWVudC4gVGhlIHNlY29uZCBjYXNlIHVzZXMgaW50ZXJwb2xhdGlvbi4gSW4gdGhhdCB5b3UgYWxzbyBwcm92aWRlIHRoZSB0aW1lIHNpbmNlIHRoZSBmdW5jdGlvbiB3YXMgbGFzdCB1c2VkLCBhcyB3ZWxsIGFzIHRoZSBtYXhpbXVtIGZpeGVkIHRpbWVzdGVwcyB0byB0YWtlLgogICAgICoKICAgICAqIEBwYXJhbSBkdCBUaGUgZml4ZWQgdGltZSBzdGVwIHNpemUgdG8gdXNlLgogICAgICogQHBhcmFtIHRpbWVTaW5jZUxhc3RDYWxsZWQgVGhlIHRpbWUgZWxhcHNlZCBzaW5jZSB0aGUgZnVuY3Rpb24gd2FzIGxhc3QgY2FsbGVkLgogICAgICogQHBhcmFtIG1heFN1YlN0ZXBzIE1heGltdW0gbnVtYmVyIG9mIGZpeGVkIHN0ZXBzIHRvIHRha2UgcGVyIGZ1bmN0aW9uIGNhbGwgKGRlZmF1bHQ6IDEwKS4KICAgICAqIEBzZWUgaHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTgwNDI2MTU0NTMxL2h0dHA6Ly9idWxsZXRwaHlzaWNzLm9yZy9tZWRpYXdpa2ktMS41LjgvaW5kZXgucGhwL1N0ZXBwaW5nX1RoZV9Xb3JsZCNXaGF0X2RvX3RoZV9wYXJhbWV0ZXJzX3RvX2J0RHluYW1pY3NXb3JsZDo6c3RlcFNpbXVsYXRpb25fbWVhbi4zRgogICAgICogQGV4YW1wbGUKICAgICAqICAgICAvLyBmaXhlZCB0aW1lc3RlcHBpbmcgd2l0aG91dCBpbnRlcnBvbGF0aW9uCiAgICAgKiAgICAgd29ybGQuc3RlcCgxIC8gNjApCiAgICAgKi8KCgogICAgc3RlcChkdCwgdGltZVNpbmNlTGFzdENhbGxlZCwgbWF4U3ViU3RlcHMpIHsKICAgICAgaWYgKG1heFN1YlN0ZXBzID09PSB2b2lkIDApIHsKICAgICAgICBtYXhTdWJTdGVwcyA9IDEwOwogICAgICB9CgogICAgICBpZiAodGltZVNpbmNlTGFzdENhbGxlZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgLy8gRml4ZWQsIHNpbXBsZSBzdGVwcGluZwogICAgICAgIHRoaXMuaW50ZXJuYWxTdGVwKGR0KTsgLy8gSW5jcmVtZW50IHRpbWUKCiAgICAgICAgdGhpcy50aW1lICs9IGR0OwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYWNjdW11bGF0b3IgKz0gdGltZVNpbmNlTGFzdENhbGxlZDsKICAgICAgICBjb25zdCB0MCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICAgIGxldCBzdWJzdGVwcyA9IDA7CgogICAgICAgIHdoaWxlICh0aGlzLmFjY3VtdWxhdG9yID49IGR0ICYmIHN1YnN0ZXBzIDwgbWF4U3ViU3RlcHMpIHsKICAgICAgICAgIC8vIERvIGZpeGVkIHN0ZXBzIHRvIGNhdGNoIHVwCiAgICAgICAgICB0aGlzLmludGVybmFsU3RlcChkdCk7CiAgICAgICAgICB0aGlzLmFjY3VtdWxhdG9yIC09IGR0OwogICAgICAgICAgc3Vic3RlcHMrKzsKCiAgICAgICAgICBpZiAocGVyZm9ybWFuY2Uubm93KCkgLSB0MCA+IGR0ICogMTAwMCkgewogICAgICAgICAgICAvLyBUaGUgZnJhbWVyYXRlIGlzIG5vdCBpbnRlcmFjdGl2ZSBhbnltb3JlLgogICAgICAgICAgICAvLyBXZSBhcmUgYmVsb3cgdGhlIHRhcmdldCBmcmFtZXJhdGUuCiAgICAgICAgICAgIC8vIEJldHRlciBiYWlsIG91dC4KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBSZW1vdmUgdGhlIGV4Y2VzcyBhY2N1bXVsYXRvciwgc2luY2Ugd2UgbWF5IG5vdAogICAgICAgIC8vIGhhdmUgaGFkIGVub3VnaCBzdWJzdGVwcyBhdmFpbGFibGUgdG8gY2F0Y2ggdXAKCgogICAgICAgIHRoaXMuYWNjdW11bGF0b3IgPSB0aGlzLmFjY3VtdWxhdG9yICUgZHQ7CiAgICAgICAgY29uc3QgdCA9IHRoaXMuYWNjdW11bGF0b3IgLyBkdDsKCiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogIT09IHRoaXMuYm9kaWVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBiID0gdGhpcy5ib2RpZXNbal07CiAgICAgICAgICBiLnByZXZpb3VzUG9zaXRpb24ubGVycChiLnBvc2l0aW9uLCB0LCBiLmludGVycG9sYXRlZFBvc2l0aW9uKTsKICAgICAgICAgIGIucHJldmlvdXNRdWF0ZXJuaW9uLnNsZXJwKGIucXVhdGVybmlvbiwgdCwgYi5pbnRlcnBvbGF0ZWRRdWF0ZXJuaW9uKTsKICAgICAgICAgIGIucHJldmlvdXNRdWF0ZXJuaW9uLm5vcm1hbGl6ZSgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy50aW1lICs9IHRpbWVTaW5jZUxhc3RDYWxsZWQ7CiAgICAgIH0KICAgIH0KCiAgICBpbnRlcm5hbFN0ZXAoZHQpIHsKICAgICAgdGhpcy5kdCA9IGR0OwogICAgICBjb25zdCBjb250YWN0cyA9IHRoaXMuY29udGFjdHM7CiAgICAgIGNvbnN0IHAxID0gV29ybGRfc3RlcF9wMTsKICAgICAgY29uc3QgcDIgPSBXb3JsZF9zdGVwX3AyOwogICAgICBjb25zdCBOID0gdGhpcy5ib2RpZXMubGVuZ3RoOwogICAgICBjb25zdCBib2RpZXMgPSB0aGlzLmJvZGllczsKICAgICAgY29uc3Qgc29sdmVyID0gdGhpcy5zb2x2ZXI7CiAgICAgIGNvbnN0IGdyYXZpdHkgPSB0aGlzLmdyYXZpdHk7CiAgICAgIGNvbnN0IGRvUHJvZmlsaW5nID0gdGhpcy5kb1Byb2ZpbGluZzsKICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMucHJvZmlsZTsKICAgICAgY29uc3QgRFlOQU1JQyA9IEJvZHkuRFlOQU1JQzsKICAgICAgbGV0IHByb2ZpbGluZ1N0YXJ0ID0gLUluZmluaXR5OwogICAgICBjb25zdCBjb25zdHJhaW50cyA9IHRoaXMuY29uc3RyYWludHM7CiAgICAgIGNvbnN0IGZyaWN0aW9uRXF1YXRpb25Qb29sID0gV29ybGRfc3RlcF9mcmljdGlvbkVxdWF0aW9uUG9vbDsKICAgICAgZ3Jhdml0eS5sZW5ndGgoKTsKICAgICAgY29uc3QgZ3ggPSBncmF2aXR5Lng7CiAgICAgIGNvbnN0IGd5ID0gZ3Jhdml0eS55OwogICAgICBjb25zdCBneiA9IGdyYXZpdHkuejsKICAgICAgbGV0IGkgPSAwOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsaW5nU3RhcnQgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgICAgfSAvLyBBZGQgZ3Jhdml0eSB0byBhbGwgb2JqZWN0cwoKCiAgICAgIGZvciAoaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IGJpID0gYm9kaWVzW2ldOwoKICAgICAgICBpZiAoYmkudHlwZSA9PT0gRFlOQU1JQykgewogICAgICAgICAgLy8gT25seSBmb3IgZHluYW1pYyBib2RpZXMKICAgICAgICAgIGNvbnN0IGYgPSBiaS5mb3JjZTsKICAgICAgICAgIGNvbnN0IG0gPSBiaS5tYXNzOwogICAgICAgICAgZi54ICs9IG0gKiBneDsKICAgICAgICAgIGYueSArPSBtICogZ3k7CiAgICAgICAgICBmLnogKz0gbSAqIGd6OwogICAgICAgIH0KICAgICAgfSAvLyBVcGRhdGUgc3Vic3lzdGVtcwoKCiAgICAgIGZvciAobGV0IGkgPSAwLCBOc3Vic3lzdGVtcyA9IHRoaXMuc3Vic3lzdGVtcy5sZW5ndGg7IGkgIT09IE5zdWJzeXN0ZW1zOyBpKyspIHsKICAgICAgICB0aGlzLnN1YnN5c3RlbXNbaV0udXBkYXRlKCk7CiAgICAgIH0gLy8gQ29sbGlzaW9uIGRldGVjdGlvbgoKCiAgICAgIGlmIChkb1Byb2ZpbGluZykgewogICAgICAgIHByb2ZpbGluZ1N0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIH0KCiAgICAgIHAxLmxlbmd0aCA9IDA7IC8vIENsZWFuIHVwIHBhaXIgYXJyYXlzIGZyb20gbGFzdCBzdGVwCgogICAgICBwMi5sZW5ndGggPSAwOwogICAgICB0aGlzLmJyb2FkcGhhc2UuY29sbGlzaW9uUGFpcnModGhpcywgcDEsIHAyKTsKCiAgICAgIGlmIChkb1Byb2ZpbGluZykgewogICAgICAgIHByb2ZpbGUuYnJvYWRwaGFzZSA9IHBlcmZvcm1hbmNlLm5vdygpIC0gcHJvZmlsaW5nU3RhcnQ7CiAgICAgIH0gLy8gUmVtb3ZlIGNvbnN0cmFpbmVkIHBhaXJzIHdpdGggY29sbGlkZUNvbm5lY3RlZCA9PSBmYWxzZQoKCiAgICAgIGxldCBOY29uc3RyYWludHMgPSBjb25zdHJhaW50cy5sZW5ndGg7CgogICAgICBmb3IgKGkgPSAwOyBpICE9PSBOY29uc3RyYWludHM7IGkrKykgewogICAgICAgIGNvbnN0IGMgPSBjb25zdHJhaW50c1tpXTsKCiAgICAgICAgaWYgKCFjLmNvbGxpZGVDb25uZWN0ZWQpIHsKICAgICAgICAgIGZvciAobGV0IGogPSBwMS5sZW5ndGggLSAxOyBqID49IDA7IGogLT0gMSkgewogICAgICAgICAgICBpZiAoYy5ib2R5QSA9PT0gcDFbal0gJiYgYy5ib2R5QiA9PT0gcDJbal0gfHwgYy5ib2R5QiA9PT0gcDFbal0gJiYgYy5ib2R5QSA9PT0gcDJbal0pIHsKICAgICAgICAgICAgICBwMS5zcGxpY2UoaiwgMSk7CiAgICAgICAgICAgICAgcDIuc3BsaWNlKGosIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeFRpY2soKTsgLy8gR2VuZXJhdGUgY29udGFjdHMKCiAgICAgIGlmIChkb1Byb2ZpbGluZykgewogICAgICAgIHByb2ZpbGluZ1N0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IG9sZGNvbnRhY3RzID0gV29ybGRfc3RlcF9vbGRDb250YWN0czsKICAgICAgY29uc3QgTm9sZENvbnRhY3RzID0gY29udGFjdHMubGVuZ3RoOwoKICAgICAgZm9yIChpID0gMDsgaSAhPT0gTm9sZENvbnRhY3RzOyBpKyspIHsKICAgICAgICBvbGRjb250YWN0cy5wdXNoKGNvbnRhY3RzW2ldKTsKICAgICAgfQoKICAgICAgY29udGFjdHMubGVuZ3RoID0gMDsgLy8gVHJhbnNmZXIgRnJpY3Rpb25FcXVhdGlvbiBmcm9tIGN1cnJlbnQgbGlzdCB0byB0aGUgcG9vbCBmb3IgcmV1c2UKCiAgICAgIGNvbnN0IE5vbGRGcmljdGlvbkVxdWF0aW9ucyA9IHRoaXMuZnJpY3Rpb25FcXVhdGlvbnMubGVuZ3RoOwoKICAgICAgZm9yIChpID0gMDsgaSAhPT0gTm9sZEZyaWN0aW9uRXF1YXRpb25zOyBpKyspIHsKICAgICAgICBmcmljdGlvbkVxdWF0aW9uUG9vbC5wdXNoKHRoaXMuZnJpY3Rpb25FcXVhdGlvbnNbaV0pOwogICAgICB9CgogICAgICB0aGlzLmZyaWN0aW9uRXF1YXRpb25zLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubmFycm93cGhhc2UuZ2V0Q29udGFjdHMocDEsIHAyLCB0aGlzLCBjb250YWN0cywgb2xkY29udGFjdHMsIC8vIFRvIGJlIHJldXNlZAogICAgICB0aGlzLmZyaWN0aW9uRXF1YXRpb25zLCBmcmljdGlvbkVxdWF0aW9uUG9vbCk7CgogICAgICBpZiAoZG9Qcm9maWxpbmcpIHsKICAgICAgICBwcm9maWxlLm5hcnJvd3BoYXNlID0gcGVyZm9ybWFuY2Uubm93KCkgLSBwcm9maWxpbmdTdGFydDsKICAgICAgfSAvLyBMb29wIG92ZXIgYWxsIGNvbGxpc2lvbnMKCgogICAgICBpZiAoZG9Qcm9maWxpbmcpIHsKICAgICAgICBwcm9maWxpbmdTdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9IC8vIEFkZCBhbGwgZnJpY3Rpb24gZXFzCgoKICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMuZnJpY3Rpb25FcXVhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBzb2x2ZXIuYWRkRXF1YXRpb24odGhpcy5mcmljdGlvbkVxdWF0aW9uc1tpXSk7CiAgICAgIH0KCiAgICAgIGNvbnN0IG5jb250YWN0cyA9IGNvbnRhY3RzLmxlbmd0aDsKCiAgICAgIGZvciAobGV0IGsgPSAwOyBrICE9PSBuY29udGFjdHM7IGsrKykgewogICAgICAgIC8vIEN1cnJlbnQgY29udGFjdAogICAgICAgIGNvbnN0IGMgPSBjb250YWN0c1trXTsgLy8gR2V0IGN1cnJlbnQgY29sbGlzaW9uIGluZGVjZXMKCiAgICAgICAgY29uc3QgYmkgPSBjLmJpOwogICAgICAgIGNvbnN0IGJqID0gYy5iajsKICAgICAgICBjb25zdCBzaSA9IGMuc2k7CiAgICAgICAgY29uc3Qgc2ogPSBjLnNqOyAvLyBHZXQgY29sbGlzaW9uIHByb3BlcnRpZXMKCiAgICAgICAgbGV0IGNtOwoKICAgICAgICBpZiAoYmkubWF0ZXJpYWwgJiYgYmoubWF0ZXJpYWwpIHsKICAgICAgICAgIGNtID0gdGhpcy5nZXRDb250YWN0TWF0ZXJpYWwoYmkubWF0ZXJpYWwsIGJqLm1hdGVyaWFsKSB8fCB0aGlzLmRlZmF1bHRDb250YWN0TWF0ZXJpYWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNtID0gdGhpcy5kZWZhdWx0Q29udGFjdE1hdGVyaWFsOwogICAgICAgIH0gLy8gYy5lbmFibGVkID0gYmkuY29sbGlzaW9uUmVzcG9uc2UgJiYgYmouY29sbGlzaW9uUmVzcG9uc2UgJiYgc2kuY29sbGlzaW9uUmVzcG9uc2UgJiYgc2ouY29sbGlzaW9uUmVzcG9uc2U7CgoKICAgICAgICBjbS5mcmljdGlvbjsgLy8gYy5yZXN0aXR1dGlvbiA9IGNtLnJlc3RpdHV0aW9uOwogICAgICAgIC8vIElmIGZyaWN0aW9uIG9yIHJlc3RpdHV0aW9uIHdlcmUgc3BlY2lmaWVkIGluIHRoZSBtYXRlcmlhbCwgdXNlIHRoZW0KCiAgICAgICAgaWYgKGJpLm1hdGVyaWFsICYmIGJqLm1hdGVyaWFsKSB7CiAgICAgICAgICBpZiAoYmkubWF0ZXJpYWwuZnJpY3Rpb24gPj0gMCAmJiBiai5tYXRlcmlhbC5mcmljdGlvbiA+PSAwKSB7CiAgICAgICAgICAgIGJpLm1hdGVyaWFsLmZyaWN0aW9uICogYmoubWF0ZXJpYWwuZnJpY3Rpb247CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGJpLm1hdGVyaWFsLnJlc3RpdHV0aW9uID49IDAgJiYgYmoubWF0ZXJpYWwucmVzdGl0dXRpb24gPj0gMCkgewogICAgICAgICAgICBjLnJlc3RpdHV0aW9uID0gYmkubWF0ZXJpYWwucmVzdGl0dXRpb24gKiBiai5tYXRlcmlhbC5yZXN0aXR1dGlvbjsKICAgICAgICAgIH0KICAgICAgICB9IC8vIGMuc2V0U3Bvb2tQYXJhbXMoCiAgICAgICAgLy8gICAgICAgICAgIGNtLmNvbnRhY3RFcXVhdGlvblN0aWZmbmVzcywKICAgICAgICAvLyAgICAgICAgICAgY20uY29udGFjdEVxdWF0aW9uUmVsYXhhdGlvbiwKICAgICAgICAvLyAgICAgICAgICAgZHQKICAgICAgICAvLyAgICAgICApOwoKCiAgICAgICAgc29sdmVyLmFkZEVxdWF0aW9uKGMpOyAvLyAvLyBBZGQgZnJpY3Rpb24gY29uc3RyYWludCBlcXVhdGlvbgogICAgICAgIC8vIGlmKG11ID4gMCl7CiAgICAgICAgLy8gCS8vIENyZWF0ZSAyIHRhbmdlbnQgZXF1YXRpb25zCiAgICAgICAgLy8gCWNvbnN0IG11ZyA9IG11ICogZ25vcm07CiAgICAgICAgLy8gCWNvbnN0IHJlZHVjZWRNYXNzID0gKGJpLmludk1hc3MgKyBiai5pbnZNYXNzKTsKICAgICAgICAvLyAJaWYocmVkdWNlZE1hc3MgPiAwKXsKICAgICAgICAvLyAJCXJlZHVjZWRNYXNzID0gMS9yZWR1Y2VkTWFzczsKICAgICAgICAvLyAJfQogICAgICAgIC8vIAljb25zdCBwb29sID0gZnJpY3Rpb25FcXVhdGlvblBvb2w7CiAgICAgICAgLy8gCWNvbnN0IGMxID0gcG9vbC5sZW5ndGggPyBwb29sLnBvcCgpIDogbmV3IEZyaWN0aW9uRXF1YXRpb24oYmksYmosbXVnKnJlZHVjZWRNYXNzKTsKICAgICAgICAvLyAJY29uc3QgYzIgPSBwb29sLmxlbmd0aCA/IHBvb2wucG9wKCkgOiBuZXcgRnJpY3Rpb25FcXVhdGlvbihiaSxiaixtdWcqcmVkdWNlZE1hc3MpOwogICAgICAgIC8vIAl0aGlzLmZyaWN0aW9uRXF1YXRpb25zLnB1c2goYzEsIGMyKTsKICAgICAgICAvLyAJYzEuYmkgPSBjMi5iaSA9IGJpOwogICAgICAgIC8vIAljMS5iaiA9IGMyLmJqID0gYmo7CiAgICAgICAgLy8gCWMxLm1pbkZvcmNlID0gYzIubWluRm9yY2UgPSAtbXVnKnJlZHVjZWRNYXNzOwogICAgICAgIC8vIAljMS5tYXhGb3JjZSA9IGMyLm1heEZvcmNlID0gbXVnKnJlZHVjZWRNYXNzOwogICAgICAgIC8vIAkvLyBDb3B5IG92ZXIgdGhlIHJlbGF0aXZlIHZlY3RvcnMKICAgICAgICAvLyAJYzEucmkuY29weShjLnJpKTsKICAgICAgICAvLyAJYzEucmouY29weShjLnJqKTsKICAgICAgICAvLyAJYzIucmkuY29weShjLnJpKTsKICAgICAgICAvLyAJYzIucmouY29weShjLnJqKTsKICAgICAgICAvLyAJLy8gQ29uc3RydWN0IHRhbmdlbnRzCiAgICAgICAgLy8gCWMubmkudGFuZ2VudHMoYzEudCwgYzIudCk7CiAgICAgICAgLy8gICAgICAgICAgIC8vIFNldCBzcG9vayBwYXJhbXMKICAgICAgICAvLyAgICAgICAgICAgYzEuc2V0U3Bvb2tQYXJhbXMoY20uZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcywgY20uZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb24sIGR0KTsKICAgICAgICAvLyAgICAgICAgICAgYzIuc2V0U3Bvb2tQYXJhbXMoY20uZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcywgY20uZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb24sIGR0KTsKICAgICAgICAvLyAgICAgICAgICAgYzEuZW5hYmxlZCA9IGMyLmVuYWJsZWQgPSBjLmVuYWJsZWQ7CiAgICAgICAgLy8gCS8vIEFkZCBlcXVhdGlvbnMgdG8gc29sdmVyCiAgICAgICAgLy8gCXNvbHZlci5hZGRFcXVhdGlvbihjMSk7CiAgICAgICAgLy8gCXNvbHZlci5hZGRFcXVhdGlvbihjMik7CiAgICAgICAgLy8gfQoKICAgICAgICBpZiAoYmkuYWxsb3dTbGVlcCAmJiBiaS50eXBlID09PSBCb2R5LkRZTkFNSUMgJiYgYmkuc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUElORyAmJiBiai5zbGVlcFN0YXRlID09PSBCb2R5LkFXQUtFICYmIGJqLnR5cGUgIT09IEJvZHkuU1RBVElDKSB7CiAgICAgICAgICBjb25zdCBzcGVlZFNxdWFyZWRCID0gYmoudmVsb2NpdHkubGVuZ3RoU3F1YXJlZCgpICsgYmouYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxdWFyZWQoKTsKICAgICAgICAgIGNvbnN0IHNwZWVkTGltaXRTcXVhcmVkQiA9IGJqLnNsZWVwU3BlZWRMaW1pdCAqKiAyOwoKICAgICAgICAgIGlmIChzcGVlZFNxdWFyZWRCID49IHNwZWVkTGltaXRTcXVhcmVkQiAqIDIpIHsKICAgICAgICAgICAgYmkud2FrZVVwQWZ0ZXJOYXJyb3dwaGFzZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYmouYWxsb3dTbGVlcCAmJiBiai50eXBlID09PSBCb2R5LkRZTkFNSUMgJiYgYmouc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUElORyAmJiBiaS5zbGVlcFN0YXRlID09PSBCb2R5LkFXQUtFICYmIGJpLnR5cGUgIT09IEJvZHkuU1RBVElDKSB7CiAgICAgICAgICBjb25zdCBzcGVlZFNxdWFyZWRBID0gYmkudmVsb2NpdHkubGVuZ3RoU3F1YXJlZCgpICsgYmkuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxdWFyZWQoKTsKICAgICAgICAgIGNvbnN0IHNwZWVkTGltaXRTcXVhcmVkQSA9IGJpLnNsZWVwU3BlZWRMaW1pdCAqKiAyOwoKICAgICAgICAgIGlmIChzcGVlZFNxdWFyZWRBID49IHNwZWVkTGltaXRTcXVhcmVkQSAqIDIpIHsKICAgICAgICAgICAgYmoud2FrZVVwQWZ0ZXJOYXJyb3dwaGFzZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBOb3cgd2Uga25vdyB0aGF0IGkgYW5kIGogYXJlIGluIGNvbnRhY3QuIFNldCBjb2xsaXNpb24gbWF0cml4IHN0YXRlCgoKICAgICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeC5zZXQoYmksIGJqLCB0cnVlKTsKCiAgICAgICAgaWYgKCF0aGlzLmNvbGxpc2lvbk1hdHJpeFByZXZpb3VzLmdldChiaSwgYmopKSB7CiAgICAgICAgICAvLyBGaXJzdCBjb250YWN0IQogICAgICAgICAgLy8gV2UgcmV1c2UgdGhlIGNvbGxpZGVFdmVudCBvYmplY3QsIG90aGVyd2lzZSB3ZSB3aWxsIGVuZCB1cCBjcmVhdGluZyBuZXcgb2JqZWN0cyBmb3IgZWFjaCBuZXcgY29udGFjdCwgZXZlbiBpZiB0aGVyZSdzIG5vIGV2ZW50IGxpc3RlbmVyIGF0dGFjaGVkLgogICAgICAgICAgV29ybGRfc3RlcF9jb2xsaWRlRXZlbnQuYm9keSA9IGJqOwogICAgICAgICAgV29ybGRfc3RlcF9jb2xsaWRlRXZlbnQuY29udGFjdCA9IGM7CiAgICAgICAgICBiaS5kaXNwYXRjaEV2ZW50KFdvcmxkX3N0ZXBfY29sbGlkZUV2ZW50KTsKICAgICAgICAgIFdvcmxkX3N0ZXBfY29sbGlkZUV2ZW50LmJvZHkgPSBiaTsKICAgICAgICAgIGJqLmRpc3BhdGNoRXZlbnQoV29ybGRfc3RlcF9jb2xsaWRlRXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5ib2R5T3ZlcmxhcEtlZXBlci5zZXQoYmkuaWQsIGJqLmlkKTsKICAgICAgICB0aGlzLnNoYXBlT3ZlcmxhcEtlZXBlci5zZXQoc2kuaWQsIHNqLmlkKTsKICAgICAgfQoKICAgICAgdGhpcy5lbWl0Q29udGFjdEV2ZW50cygpOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsZS5tYWtlQ29udGFjdENvbnN0cmFpbnRzID0gcGVyZm9ybWFuY2Uubm93KCkgLSBwcm9maWxpbmdTdGFydDsKICAgICAgICBwcm9maWxpbmdTdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9IC8vIFdha2UgdXAgYm9kaWVzCgoKICAgICAgZm9yIChpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgY29uc3QgYmkgPSBib2RpZXNbaV07CgogICAgICAgIGlmIChiaS53YWtlVXBBZnRlck5hcnJvd3BoYXNlKSB7CiAgICAgICAgICBiaS53YWtlVXAoKTsKICAgICAgICAgIGJpLndha2VVcEFmdGVyTmFycm93cGhhc2UgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0gLy8gQWRkIHVzZXItYWRkZWQgY29uc3RyYWludHMKCgogICAgICBOY29uc3RyYWludHMgPSBjb25zdHJhaW50cy5sZW5ndGg7CgogICAgICBmb3IgKGkgPSAwOyBpICE9PSBOY29uc3RyYWludHM7IGkrKykgewogICAgICAgIGNvbnN0IGMgPSBjb25zdHJhaW50c1tpXTsKICAgICAgICBjLnVwZGF0ZSgpOwoKICAgICAgICBmb3IgKGxldCBqID0gMCwgTmVxID0gYy5lcXVhdGlvbnMubGVuZ3RoOyBqICE9PSBOZXE7IGorKykgewogICAgICAgICAgY29uc3QgZXEgPSBjLmVxdWF0aW9uc1tqXTsKICAgICAgICAgIHNvbHZlci5hZGRFcXVhdGlvbihlcSk7CiAgICAgICAgfQogICAgICB9IC8vIFNvbHZlIHRoZSBjb25zdHJhaW5lZCBzeXN0ZW0KCgogICAgICBzb2x2ZXIuc29sdmUoZHQsIHRoaXMpOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsZS5zb2x2ZSA9IHBlcmZvcm1hbmNlLm5vdygpIC0gcHJvZmlsaW5nU3RhcnQ7CiAgICAgIH0gLy8gUmVtb3ZlIGFsbCBjb250YWN0cyBmcm9tIHNvbHZlcgoKCiAgICAgIHNvbHZlci5yZW1vdmVBbGxFcXVhdGlvbnMoKTsgLy8gQXBwbHkgZGFtcGluZywgc2VlIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC9idWxsZXQvaXNzdWVzL2RldGFpbD9pZD03NCBmb3IgZGV0YWlscwoKICAgICAgY29uc3QgcG93ID0gTWF0aC5wb3c7CgogICAgICBmb3IgKGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBjb25zdCBiaSA9IGJvZGllc1tpXTsKCiAgICAgICAgaWYgKGJpLnR5cGUgJiBEWU5BTUlDKSB7CiAgICAgICAgICAvLyBPbmx5IGZvciBkeW5hbWljIGJvZGllcwogICAgICAgICAgY29uc3QgbGQgPSBwb3coMS4wIC0gYmkubGluZWFyRGFtcGluZywgZHQpOwogICAgICAgICAgY29uc3QgdiA9IGJpLnZlbG9jaXR5OwogICAgICAgICAgdi5zY2FsZShsZCwgdik7CiAgICAgICAgICBjb25zdCBhdiA9IGJpLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgICBpZiAoYXYpIHsKICAgICAgICAgICAgY29uc3QgYWQgPSBwb3coMS4wIC0gYmkuYW5ndWxhckRhbXBpbmcsIGR0KTsKICAgICAgICAgICAgYXYuc2NhbGUoYWQsIGF2KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChXb3JsZF9zdGVwX3ByZVN0ZXBFdmVudCk7IC8vIExlYXAgZnJvZwogICAgICAvLyB2bmV3ID0gdiArIGgqZi9tCiAgICAgIC8vIHhuZXcgPSB4ICsgaCp2bmV3CgogICAgICBpZiAoZG9Qcm9maWxpbmcpIHsKICAgICAgICBwcm9maWxpbmdTdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9CgogICAgICBjb25zdCBzdGVwbnVtYmVyID0gdGhpcy5zdGVwbnVtYmVyOwogICAgICBjb25zdCBxdWF0Tm9ybWFsaXplID0gc3RlcG51bWJlciAlICh0aGlzLnF1YXROb3JtYWxpemVTa2lwICsgMSkgPT09IDA7CiAgICAgIGNvbnN0IHF1YXROb3JtYWxpemVGYXN0ID0gdGhpcy5xdWF0Tm9ybWFsaXplRmFzdDsKCiAgICAgIGZvciAoaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGJvZGllc1tpXS5pbnRlZ3JhdGUoZHQsIHF1YXROb3JtYWxpemUsIHF1YXROb3JtYWxpemVGYXN0KTsKICAgICAgfQoKICAgICAgdGhpcy5jbGVhckZvcmNlcygpOwogICAgICB0aGlzLmJyb2FkcGhhc2UuZGlydHkgPSB0cnVlOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsZS5pbnRlZ3JhdGUgPSBwZXJmb3JtYW5jZS5ub3coKSAtIHByb2ZpbGluZ1N0YXJ0OwogICAgICB9IC8vIFVwZGF0ZSBzdGVwIG51bWJlcgoKCiAgICAgIHRoaXMuc3RlcG51bWJlciArPSAxOwogICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoV29ybGRfc3RlcF9wb3N0U3RlcEV2ZW50KTsgLy8gU2xlZXBpbmcgdXBkYXRlCgogICAgICBsZXQgaGFzQWN0aXZlQm9kaWVzID0gdHJ1ZTsKCiAgICAgIGlmICh0aGlzLmFsbG93U2xlZXApIHsKICAgICAgICBoYXNBY3RpdmVCb2RpZXMgPSBmYWxzZTsKCiAgICAgICAgZm9yIChpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBiaSA9IGJvZGllc1tpXTsKICAgICAgICAgIGJpLnNsZWVwVGljayh0aGlzLnRpbWUpOwoKICAgICAgICAgIGlmIChiaS5zbGVlcFN0YXRlICE9PSBCb2R5LlNMRUVQSU5HKSB7CiAgICAgICAgICAgIGhhc0FjdGl2ZUJvZGllcyA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmhhc0FjdGl2ZUJvZGllcyA9IGhhc0FjdGl2ZUJvZGllczsKICAgIH0KCiAgICBlbWl0Q29udGFjdEV2ZW50cygpIHsKICAgICAgY29uc3QgaGFzQmVnaW5Db250YWN0ID0gdGhpcy5oYXNBbnlFdmVudExpc3RlbmVyKCdiZWdpbkNvbnRhY3QnKTsKICAgICAgY29uc3QgaGFzRW5kQ29udGFjdCA9IHRoaXMuaGFzQW55RXZlbnRMaXN0ZW5lcignZW5kQ29udGFjdCcpOwoKICAgICAgaWYgKGhhc0JlZ2luQ29udGFjdCB8fCBoYXNFbmRDb250YWN0KSB7CiAgICAgICAgdGhpcy5ib2R5T3ZlcmxhcEtlZXBlci5nZXREaWZmKGFkZGl0aW9ucywgcmVtb3ZhbHMpOwogICAgICB9CgogICAgICBpZiAoaGFzQmVnaW5Db250YWN0KSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBhZGRpdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSArPSAyKSB7CiAgICAgICAgICBiZWdpbkNvbnRhY3RFdmVudC5ib2R5QSA9IHRoaXMuZ2V0Qm9keUJ5SWQoYWRkaXRpb25zW2ldKTsKICAgICAgICAgIGJlZ2luQ29udGFjdEV2ZW50LmJvZHlCID0gdGhpcy5nZXRCb2R5QnlJZChhZGRpdGlvbnNbaSArIDFdKTsKICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChiZWdpbkNvbnRhY3RFdmVudCk7CiAgICAgICAgfQoKICAgICAgICBiZWdpbkNvbnRhY3RFdmVudC5ib2R5QSA9IGJlZ2luQ29udGFjdEV2ZW50LmJvZHlCID0gbnVsbDsKICAgICAgfQoKICAgICAgaWYgKGhhc0VuZENvbnRhY3QpIHsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHJlbW92YWxzLmxlbmd0aDsgaSA8IGw7IGkgKz0gMikgewogICAgICAgICAgZW5kQ29udGFjdEV2ZW50LmJvZHlBID0gdGhpcy5nZXRCb2R5QnlJZChyZW1vdmFsc1tpXSk7CiAgICAgICAgICBlbmRDb250YWN0RXZlbnQuYm9keUIgPSB0aGlzLmdldEJvZHlCeUlkKHJlbW92YWxzW2kgKyAxXSk7CiAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoZW5kQ29udGFjdEV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGVuZENvbnRhY3RFdmVudC5ib2R5QSA9IGVuZENvbnRhY3RFdmVudC5ib2R5QiA9IG51bGw7CiAgICAgIH0KCiAgICAgIGFkZGl0aW9ucy5sZW5ndGggPSByZW1vdmFscy5sZW5ndGggPSAwOwogICAgICBjb25zdCBoYXNCZWdpblNoYXBlQ29udGFjdCA9IHRoaXMuaGFzQW55RXZlbnRMaXN0ZW5lcignYmVnaW5TaGFwZUNvbnRhY3QnKTsKICAgICAgY29uc3QgaGFzRW5kU2hhcGVDb250YWN0ID0gdGhpcy5oYXNBbnlFdmVudExpc3RlbmVyKCdlbmRTaGFwZUNvbnRhY3QnKTsKCiAgICAgIGlmIChoYXNCZWdpblNoYXBlQ29udGFjdCB8fCBoYXNFbmRTaGFwZUNvbnRhY3QpIHsKICAgICAgICB0aGlzLnNoYXBlT3ZlcmxhcEtlZXBlci5nZXREaWZmKGFkZGl0aW9ucywgcmVtb3ZhbHMpOwogICAgICB9CgogICAgICBpZiAoaGFzQmVnaW5TaGFwZUNvbnRhY3QpIHsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGFkZGl0aW9ucy5sZW5ndGg7IGkgPCBsOyBpICs9IDIpIHsKICAgICAgICAgIGNvbnN0IHNoYXBlQSA9IHRoaXMuZ2V0U2hhcGVCeUlkKGFkZGl0aW9uc1tpXSk7CiAgICAgICAgICBjb25zdCBzaGFwZUIgPSB0aGlzLmdldFNoYXBlQnlJZChhZGRpdGlvbnNbaSArIDFdKTsKICAgICAgICAgIGJlZ2luU2hhcGVDb250YWN0RXZlbnQuc2hhcGVBID0gc2hhcGVBOwogICAgICAgICAgYmVnaW5TaGFwZUNvbnRhY3RFdmVudC5zaGFwZUIgPSBzaGFwZUI7CiAgICAgICAgICBpZiAoc2hhcGVBKSBiZWdpblNoYXBlQ29udGFjdEV2ZW50LmJvZHlBID0gc2hhcGVBLmJvZHk7CiAgICAgICAgICBpZiAoc2hhcGVCKSBiZWdpblNoYXBlQ29udGFjdEV2ZW50LmJvZHlCID0gc2hhcGVCLmJvZHk7CiAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoYmVnaW5TaGFwZUNvbnRhY3RFdmVudCk7CiAgICAgICAgfQoKICAgICAgICBiZWdpblNoYXBlQ29udGFjdEV2ZW50LmJvZHlBID0gYmVnaW5TaGFwZUNvbnRhY3RFdmVudC5ib2R5QiA9IGJlZ2luU2hhcGVDb250YWN0RXZlbnQuc2hhcGVBID0gYmVnaW5TaGFwZUNvbnRhY3RFdmVudC5zaGFwZUIgPSBudWxsOwogICAgICB9CgogICAgICBpZiAoaGFzRW5kU2hhcGVDb250YWN0KSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSByZW1vdmFscy5sZW5ndGg7IGkgPCBsOyBpICs9IDIpIHsKICAgICAgICAgIGNvbnN0IHNoYXBlQSA9IHRoaXMuZ2V0U2hhcGVCeUlkKHJlbW92YWxzW2ldKTsKICAgICAgICAgIGNvbnN0IHNoYXBlQiA9IHRoaXMuZ2V0U2hhcGVCeUlkKHJlbW92YWxzW2kgKyAxXSk7CiAgICAgICAgICBlbmRTaGFwZUNvbnRhY3RFdmVudC5zaGFwZUEgPSBzaGFwZUE7CiAgICAgICAgICBlbmRTaGFwZUNvbnRhY3RFdmVudC5zaGFwZUIgPSBzaGFwZUI7CiAgICAgICAgICBpZiAoc2hhcGVBKSBlbmRTaGFwZUNvbnRhY3RFdmVudC5ib2R5QSA9IHNoYXBlQS5ib2R5OwogICAgICAgICAgaWYgKHNoYXBlQikgZW5kU2hhcGVDb250YWN0RXZlbnQuYm9keUIgPSBzaGFwZUIuYm9keTsKICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChlbmRTaGFwZUNvbnRhY3RFdmVudCk7CiAgICAgICAgfQoKICAgICAgICBlbmRTaGFwZUNvbnRhY3RFdmVudC5ib2R5QSA9IGVuZFNoYXBlQ29udGFjdEV2ZW50LmJvZHlCID0gZW5kU2hhcGVDb250YWN0RXZlbnQuc2hhcGVBID0gZW5kU2hhcGVDb250YWN0RXZlbnQuc2hhcGVCID0gbnVsbDsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIGFsbCBib2R5IGZvcmNlcyBpbiB0aGUgd29ybGQgdG8gemVyby4KICAgICAqLwoKCiAgICBjbGVhckZvcmNlcygpIHsKICAgICAgY29uc3QgYm9kaWVzID0gdGhpcy5ib2RpZXM7CiAgICAgIGNvbnN0IE4gPSBib2RpZXMubGVuZ3RoOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IGIgPSBib2RpZXNbaV07CiAgICAgICAgYi5mb3JjZTsKICAgICAgICBiLnRvcnF1ZTsKICAgICAgICBiLmZvcmNlLnNldCgwLCAwLCAwKTsKICAgICAgICBiLnRvcnF1ZS5zZXQoMCwgMCwgMCk7CiAgICAgIH0KICAgIH0KCiAgfSAvLyBUZW1wIHN0dWZmCgogIG5ldyBBQUJCKCk7CiAgY29uc3QgdG1wUmF5ID0gbmV3IFJheSgpOyAvLyBwZXJmb3JtYW5jZS5ub3coKSBmYWxsYmFjayBvbiBEYXRlLm5vdygpCgogIGNvbnN0IHBlcmZvcm1hbmNlID0gZ2xvYmFsVGhpcy5wZXJmb3JtYW5jZSB8fCB7fTsKCiAgaWYgKCFwZXJmb3JtYW5jZS5ub3cpIHsKICAgIGxldCBub3dPZmZzZXQgPSBEYXRlLm5vdygpOwoKICAgIGlmIChwZXJmb3JtYW5jZS50aW1pbmcgJiYgcGVyZm9ybWFuY2UudGltaW5nLm5hdmlnYXRpb25TdGFydCkgewogICAgICBub3dPZmZzZXQgPSBwZXJmb3JtYW5jZS50aW1pbmcubmF2aWdhdGlvblN0YXJ0OwogICAgfQoKICAgIHBlcmZvcm1hbmNlLm5vdyA9ICgpID0+IERhdGUubm93KCkgLSBub3dPZmZzZXQ7CiAgfQoKICBuZXcgVmVjMygpOyAvLyBEaXNwYXRjaGVkIGFmdGVyIHRoZSB3b3JsZCBoYXMgc3RlcHBlZCBmb3J3YXJkIGluIHRpbWUuCiAgLy8gUmV1c2FibGUgZXZlbnQgb2JqZWN0cyB0byBzYXZlIG1lbW9yeS4KCiAgY29uc3QgV29ybGRfc3RlcF9wb3N0U3RlcEV2ZW50ID0gewogICAgdHlwZTogJ3Bvc3RTdGVwJwogIH07IC8vIERpc3BhdGNoZWQgYmVmb3JlIHRoZSB3b3JsZCBzdGVwcyBmb3J3YXJkIGluIHRpbWUuCgogIGNvbnN0IFdvcmxkX3N0ZXBfcHJlU3RlcEV2ZW50ID0gewogICAgdHlwZTogJ3ByZVN0ZXAnCiAgfTsKICBjb25zdCBXb3JsZF9zdGVwX2NvbGxpZGVFdmVudCA9IHsKICAgIHR5cGU6IEJvZHkuQ09MTElERV9FVkVOVF9OQU1FLAogICAgYm9keTogbnVsbCwKICAgIGNvbnRhY3Q6IG51bGwKICB9OyAvLyBQb29scyBmb3IgdW51c2VkIG9iamVjdHMKCiAgY29uc3QgV29ybGRfc3RlcF9vbGRDb250YWN0cyA9IFtdOwogIGNvbnN0IFdvcmxkX3N0ZXBfZnJpY3Rpb25FcXVhdGlvblBvb2wgPSBbXTsgLy8gUmV1c2FibGUgYXJyYXlzIGZvciBjb2xsaXNpb24gcGFpcnMKCiAgY29uc3QgV29ybGRfc3RlcF9wMSA9IFtdOwogIGNvbnN0IFdvcmxkX3N0ZXBfcDIgPSBbXTsgLy8gU3R1ZmYgZm9yIGVtaXRDb250YWN0RXZlbnRzCgogIGNvbnN0IGFkZGl0aW9ucyA9IFtdOwogIGNvbnN0IHJlbW92YWxzID0gW107CiAgY29uc3QgYmVnaW5Db250YWN0RXZlbnQgPSB7CiAgICB0eXBlOiAnYmVnaW5Db250YWN0JywKICAgIGJvZHlBOiBudWxsLAogICAgYm9keUI6IG51bGwKICB9OwogIGNvbnN0IGVuZENvbnRhY3RFdmVudCA9IHsKICAgIHR5cGU6ICdlbmRDb250YWN0JywKICAgIGJvZHlBOiBudWxsLAogICAgYm9keUI6IG51bGwKICB9OwogIGNvbnN0IGJlZ2luU2hhcGVDb250YWN0RXZlbnQgPSB7CiAgICB0eXBlOiAnYmVnaW5TaGFwZUNvbnRhY3QnLAogICAgYm9keUE6IG51bGwsCiAgICBib2R5QjogbnVsbCwKICAgIHNoYXBlQTogbnVsbCwKICAgIHNoYXBlQjogbnVsbAogIH07CiAgY29uc3QgZW5kU2hhcGVDb250YWN0RXZlbnQgPSB7CiAgICB0eXBlOiAnZW5kU2hhcGVDb250YWN0JywKICAgIGJvZHlBOiBudWxsLAogICAgYm9keUI6IG51bGwsCiAgICBzaGFwZUE6IG51bGwsCiAgICBzaGFwZUI6IG51bGwKICB9OwoKICBjb25zdCBhZGRDb250YWN0TWF0ZXJpYWwgPSAod29ybGQsIGNyZWF0ZU1hdGVyaWFsLCBfcmVmLCB1dWlkKSA9PiB7CiAgICBsZXQgW21hdGVyaWFsQSwgbWF0ZXJpYWxCLCBvcHRpb25zXSA9IF9yZWY7CiAgICBjb25zdCBtYXRBID0gY3JlYXRlTWF0ZXJpYWwobWF0ZXJpYWxBKTsKICAgIGNvbnN0IG1hdEIgPSBjcmVhdGVNYXRlcmlhbChtYXRlcmlhbEIpOwogICAgY29uc3QgY29udGFjdE1hdGVyaWFsID0gbmV3IENvbnRhY3RNYXRlcmlhbChtYXRBLCBtYXRCLCBvcHRpb25zKTsKICAgIGNvbnRhY3RNYXRlcmlhbC51dWlkID0gdXVpZDsKICAgIHdvcmxkLmFkZENvbnRhY3RNYXRlcmlhbChjb250YWN0TWF0ZXJpYWwpOwogIH07CiAgY29uc3QgcmVtb3ZlQ29udGFjdE1hdGVyaWFsID0gKHdvcmxkLCBjbVVVSUQpID0+IHsKICAgIGNvbnN0IGluZGV4ID0gd29ybGQuY29udGFjdG1hdGVyaWFscy5maW5kSW5kZXgoX3JlZjIgPT4gewogICAgICBsZXQgewogICAgICAgIHV1aWQKICAgICAgfSA9IF9yZWYyOwogICAgICByZXR1cm4gdXVpZCA9PT0gY21VVUlEOwogICAgfSk7CiAgICBjb25zdCBbewogICAgICBpZDogaQogICAgfSwgewogICAgICBpZDogagogICAgfV0gPSB3b3JsZC5jb250YWN0bWF0ZXJpYWxzW2luZGV4XS5tYXRlcmlhbHM7CiAgICB3b3JsZC5jb250YWN0bWF0ZXJpYWxzLnNwbGljZShpbmRleCwgMSk7CiAgICBkZWxldGUgd29ybGQuY29udGFjdE1hdGVyaWFsVGFibGUuZGF0YVtpIDwgaiA/IGAke2l9LSR7an1gIDogYCR7an0tJHtpfWBdOwogIH07CgogIGxldCBtYXRlcmlhbElkID0gMDsKICBjb25zdCBjcmVhdGVNYXRlcmlhbEZhY3RvcnkgPSBtYXRlcmlhbHMgPT4gZnVuY3Rpb24gKG5hbWVPck9wdGlvbnMpIHsKICAgIGlmIChuYW1lT3JPcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgbmFtZU9yT3B0aW9ucyA9IHt9OwogICAgfQogICAgY29uc3QgbWF0ZXJpYWxPcHRpb25zID0gdHlwZW9mIG5hbWVPck9wdGlvbnMgPT09ICdzdHJpbmcnID8gewogICAgICBuYW1lOiBuYW1lT3JPcHRpb25zCiAgICB9IDogewogICAgICBuYW1lOiBTeW1ib2wuZm9yKGBNYXRlcmlhbCR7bWF0ZXJpYWxJZCsrfWApLAogICAgICAuLi5uYW1lT3JPcHRpb25zCiAgICB9OwogICAgY29uc3QgewogICAgICBuYW1lCiAgICB9ID0gbWF0ZXJpYWxPcHRpb25zOwogICAgbWF0ZXJpYWxzW25hbWVdID0gbWF0ZXJpYWxzW25hbWVdIHx8IG5ldyBNYXRlcmlhbChtYXRlcmlhbE9wdGlvbnMpOwogICAgcmV0dXJuIG1hdGVyaWFsc1tuYW1lXTsKICB9OwoKICAvKioKICAgKiBAdHlwZWRlZiB7IGltcG9ydCgnY2Fubm9uLWVzJykuTWF0ZXJpYWxPcHRpb25zIH0gTWF0ZXJpYWxPcHRpb25zCiAgICovCgogIGNvbnN0IG1ha2VWZWMzID0gX3JlZiA9PiB7CiAgICBsZXQgW3gsIHksIHpdID0gX3JlZjsKICAgIHJldHVybiBuZXcgVmVjMyh4LCB5LCB6KTsKICB9OwogIGNvbnN0IHByZXBhcmVTcGhlcmUgPSBhcmdzID0+IEFycmF5LmlzQXJyYXkoYXJncykgPyBhcmdzIDogW2FyZ3NdOwogIGNvbnN0IHByZXBhcmVDb252ZXhQb2x5aGVkcm9uID0gX3JlZjIgPT4gewogICAgbGV0IFt2LCBmYWNlcywgbiwgYSwgYm91bmRpbmdTcGhlcmVSYWRpdXNdID0gX3JlZjI7CiAgICByZXR1cm4gW3sKICAgICAgYXhlczogYSA/IGEubWFwKG1ha2VWZWMzKSA6IHVuZGVmaW5lZCwKICAgICAgYm91bmRpbmdTcGhlcmVSYWRpdXMsCiAgICAgIGZhY2VzLAogICAgICBub3JtYWxzOiBuID8gbi5tYXAobWFrZVZlYzMpIDogdW5kZWZpbmVkLAogICAgICB2ZXJ0aWNlczogdiA/IHYubWFwKG1ha2VWZWMzKSA6IHVuZGVmaW5lZAogICAgfV07CiAgfTsKICBmdW5jdGlvbiBjcmVhdGVTaGFwZSh0eXBlLCBhcmdzKSB7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSAnQm94JzoKICAgICAgICByZXR1cm4gbmV3IEJveChuZXcgVmVjMyguLi5hcmdzLm1hcCh2ID0+IHYgLyAyKSkpOwogICAgICAvLyBleHRlbnRzID0+IGhhbGZFeHRlbnRzCiAgICAgIGNhc2UgJ0NvbnZleFBvbHloZWRyb24nOgogICAgICAgIHJldHVybiBuZXcgQ29udmV4UG9seWhlZHJvbiguLi5wcmVwYXJlQ29udmV4UG9seWhlZHJvbihhcmdzKSk7CiAgICAgIGNhc2UgJ0N5bGluZGVyJzoKICAgICAgICByZXR1cm4gbmV3IEN5bGluZGVyKC4uLmFyZ3MpOwogICAgICAvLyBbIHJhZGl1c1RvcCwgcmFkaXVzQm90dG9tLCBoZWlnaHQsIG51bVNlZ21lbnRzIF0gPSBhcmdzCiAgICAgIGNhc2UgJ0hlaWdodGZpZWxkJzoKICAgICAgICByZXR1cm4gbmV3IEhlaWdodGZpZWxkKC4uLmFyZ3MpOwogICAgICAvLyBbIEFycmF5IGRhdGEsIG9wdGlvbnM6IHttaW5WYWx1ZSwgbWF4VmFsdWUsIGVsZW1lbnRTaXplfSAgXSA9IGFyZ3MKICAgICAgY2FzZSAnUGFydGljbGUnOgogICAgICAgIHJldHVybiBuZXcgUGFydGljbGUoKTsKICAgICAgLy8gbm8gYXJncwogICAgICBjYXNlICdQbGFuZSc6CiAgICAgICAgcmV0dXJuIG5ldyBQbGFuZSgpOwogICAgICAvLyBubyBhcmdzLCBpbmZpbml0ZSB4IGFuZCB5CiAgICAgIGNhc2UgJ1NwaGVyZSc6CiAgICAgICAgcmV0dXJuIG5ldyBTcGhlcmUoLi4ucHJlcGFyZVNwaGVyZShhcmdzKSk7CiAgICAgIC8vIHJhZGl1cyA9IGFyZ3MKICAgICAgY2FzZSAnVHJpbWVzaCc6CiAgICAgICAgcmV0dXJuIG5ldyBUcmltZXNoKC4uLmFyZ3MpOwogICAgICAvLyBbdmVydGljZXMsIGluZGljZXNdID0gYXJncwogICAgfQogIH0KCiAgLyoqCiAgICogQHBhcmFtIHtUSFJFRS5RdWF0ZXJuaW9ufSB0YXJnZXQKICAgKiBAcGFyYW0ge3sgcm90YXRpb24/OiBUSFJFRS5WZWN0b3IzVHVwbGUgcXVhdGVybmlvbj86IFRIUkVFLlZlY3RvcjRUdXBsZSB9fSBwcm9wcwogICAqIEByZXR1cm5zIHtUSFJFRS5RdWF0ZXJuaW9ufQogICAqLwogIGNvbnN0IHNldFF1YXRlcm5pb24gPSAodGFyZ2V0LCBfcmVmMykgPT4gewogICAgbGV0IHsKICAgICAgcXVhdGVybmlvbiwKICAgICAgcm90YXRpb24KICAgIH0gPSBfcmVmMzsKICAgIGlmIChxdWF0ZXJuaW9uKSB7CiAgICAgIHRhcmdldC5zZXQoLi4ucXVhdGVybmlvbik7CiAgICB9IGVsc2UgaWYgKHJvdGF0aW9uKSB7CiAgICAgIHRhcmdldC5zZXRGcm9tRXVsZXIoLi4ucm90YXRpb24pOwogICAgfQogICAgcmV0dXJuIHRhcmdldDsKICB9OwoKICAvKioKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLnV1aWQKICAgKiBAcGFyYW0ge0JvZHlQcm9wc30gb3B0aW9ucy5wcm9wcwogICAqIEBwYXJhbSB7Qm9keVNoYXBlVHlwZX0gb3B0aW9ucy50eXBlCiAgICogQHBhcmFtIHsobWF0ZXJpYWxPcHRpb25zOiBNYXRlcmlhbE9wdGlvbnMpID0+IE1hdGVyaWFsID19IG9wdGlvbnMuY3JlYXRlTWF0ZXJpYWwKICAgKiBAcmV0dXJucyB7Qm9keX0KICAgKi8KICBjb25zdCBwcm9wc1RvQm9keSA9IG9wdGlvbnMgPT4gewogICAgY29uc3QgewogICAgICB1dWlkLAogICAgICBwcm9wcywKICAgICAgdHlwZSwKICAgICAgY3JlYXRlTWF0ZXJpYWwgPSBtYXRlcmlhbE9wdGlvbnMgPT4gbmV3IE1hdGVyaWFsKG1hdGVyaWFsT3B0aW9ucykKICAgIH0gPSBvcHRpb25zOwogICAgY29uc3QgewogICAgICBhbmd1bGFyRmFjdG9yID0gWzEsIDEsIDFdLAogICAgICBhbmd1bGFyVmVsb2NpdHkgPSBbMCwgMCwgMF0sCiAgICAgIGFyZ3MgPSBbXSwKICAgICAgY29sbGlzaW9uUmVzcG9uc2UsCiAgICAgIGxpbmVhckZhY3RvciA9IFsxLCAxLCAxXSwKICAgICAgbWFzcywKICAgICAgbWF0ZXJpYWwsCiAgICAgIG9uQ29sbGlkZSwKICAgICAgcG9zaXRpb24gPSBbMCwgMCwgMF0sCiAgICAgIHJvdGF0aW9uLAogICAgICBxdWF0ZXJuaW9uLAogICAgICBzaGFwZXMsCiAgICAgIHR5cGU6IGJvZHlUeXBlLAogICAgICB2ZWxvY2l0eSA9IFswLCAwLCAwXSwKICAgICAgLi4uZXh0cmEKICAgIH0gPSBwcm9wczsKICAgIGNvbnN0IGJvZHkgPSBuZXcgQm9keSh7CiAgICAgIC4uLmV4dHJhLAogICAgICBtYXNzOiBib2R5VHlwZSA9PT0gJ1N0YXRpYycgPyAwIDogbWFzcywKICAgICAgbWF0ZXJpYWw6IG1hdGVyaWFsID8gY3JlYXRlTWF0ZXJpYWwobWF0ZXJpYWwpIDogdW5kZWZpbmVkLAogICAgICB0eXBlOiBib2R5VHlwZSA/IEJvZHlbYm9keVR5cGUudG9VcHBlckNhc2UoKV0gOiB1bmRlZmluZWQKICAgIH0pOwogICAgYm9keS51dWlkID0gdXVpZDsKICAgIGlmIChjb2xsaXNpb25SZXNwb25zZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGJvZHkuY29sbGlzaW9uUmVzcG9uc2UgPSBjb2xsaXNpb25SZXNwb25zZTsKICAgIH0KICAgIGlmICh0eXBlID09PSAnQ29tcG91bmQnKSB7CiAgICAgIHNoYXBlcy5mb3JFYWNoKF9yZWY0ID0+IHsKICAgICAgICBsZXQgewogICAgICAgICAgdHlwZSwKICAgICAgICAgIGFyZ3MsCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgcXVhdGVybmlvbiwKICAgICAgICAgIG1hdGVyaWFsLAogICAgICAgICAgLi4uZXh0cmEKICAgICAgICB9ID0gX3JlZjQ7CiAgICAgICAgY29uc3Qgc2hhcGVCb2R5ID0gYm9keS5hZGRTaGFwZShjcmVhdGVTaGFwZSh0eXBlLCBhcmdzKSwgcG9zaXRpb24gPyBuZXcgVmVjMyguLi5wb3NpdGlvbikgOiB1bmRlZmluZWQsIHNldFF1YXRlcm5pb24obmV3IFF1YXRlcm5pb24oMCwgMCwgMCwgMSksIHsKICAgICAgICAgIHF1YXRlcm5pb24sCiAgICAgICAgICByb3RhdGlvbgogICAgICAgIH0pKTsKICAgICAgICBpZiAobWF0ZXJpYWwpIHNoYXBlQm9keS5tYXRlcmlhbCA9IGNyZWF0ZU1hdGVyaWFsKG1hdGVyaWFsKTsKICAgICAgICBPYmplY3QuYXNzaWduKHNoYXBlQm9keSwgZXh0cmEpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGJvZHkuYWRkU2hhcGUoY3JlYXRlU2hhcGUodHlwZSwgYXJncykpOwogICAgfQogICAgYm9keS5wb3NpdGlvbi5zZXQocG9zaXRpb25bMF0sIHBvc2l0aW9uWzFdLCBwb3NpdGlvblsyXSk7CiAgICBib2R5LnZlbG9jaXR5LnNldCh2ZWxvY2l0eVswXSwgdmVsb2NpdHlbMV0sIHZlbG9jaXR5WzJdKTsKICAgIGJvZHkuYW5ndWxhclZlbG9jaXR5LnNldChhbmd1bGFyVmVsb2NpdHlbMF0sIGFuZ3VsYXJWZWxvY2l0eVsxXSwgYW5ndWxhclZlbG9jaXR5WzJdKTsKICAgIGJvZHkubGluZWFyRmFjdG9yLnNldChsaW5lYXJGYWN0b3JbMF0sIGxpbmVhckZhY3RvclsxXSwgbGluZWFyRmFjdG9yWzJdKTsKICAgIGJvZHkuYW5ndWxhckZhY3Rvci5zZXQoYW5ndWxhckZhY3RvclswXSwgYW5ndWxhckZhY3RvclsxXSwgYW5ndWxhckZhY3RvclsyXSk7CiAgICBzZXRRdWF0ZXJuaW9uKGJvZHkucXVhdGVybmlvbiwgewogICAgICBxdWF0ZXJuaW9uLAogICAgICByb3RhdGlvbgogICAgfSk7CiAgICByZXR1cm4gYm9keTsKICB9OwoKICBjb25zdCBhZGRCb2RpZXMgPSAoc3RhdGUsIGNyZWF0ZU1hdGVyaWFsLCBfcmVmKSA9PiB7CiAgICBsZXQgewogICAgICBwcm9wcywKICAgICAgdHlwZSwKICAgICAgdXVpZAogICAgfSA9IF9yZWY7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHV1aWQubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYm9keSA9IHByb3BzVG9Cb2R5KHsKICAgICAgICBjcmVhdGVNYXRlcmlhbCwKICAgICAgICBwcm9wczogcHJvcHNbaV0sCiAgICAgICAgdHlwZSwKICAgICAgICB1dWlkOiB1dWlkW2ldCiAgICAgIH0pOwogICAgICBzdGF0ZS53b3JsZC5hZGRCb2R5KGJvZHkpOwogICAgICBpZiAocHJvcHNbaV0ub25Db2xsaWRlKSBib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2NvbGxpZGUnLCBfcmVmMiA9PiB7CiAgICAgICAgbGV0IHsKICAgICAgICAgIHR5cGUsCiAgICAgICAgICBib2R5LAogICAgICAgICAgdGFyZ2V0LAogICAgICAgICAgY29udGFjdAogICAgICAgIH0gPSBfcmVmMjsKICAgICAgICBpZiAoIWJvZHkudXVpZCB8fCAhdGFyZ2V0LnV1aWQpIHJldHVybjsKICAgICAgICBjb25zdCB7CiAgICAgICAgICBuaSwKICAgICAgICAgIHJpLAogICAgICAgICAgcmosCiAgICAgICAgICBiaSwKICAgICAgICAgIGJqLAogICAgICAgICAgaWQKICAgICAgICB9ID0gY29udGFjdDsKICAgICAgICBjb25zdCBjb250YWN0UG9pbnQgPSBiaS5wb3NpdGlvbi52YWRkKHJpKTsKICAgICAgICBjb25zdCBjb250YWN0Tm9ybWFsID0gYmkgPT09IGJvZHkgPyBuaSA6IG5pLnNjYWxlKC0xKTsKICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICAgIGJvZHk6IGJvZHkudXVpZCwKICAgICAgICAgIGNvbGxpc2lvbkZpbHRlcnM6IHsKICAgICAgICAgICAgYm9keUZpbHRlckdyb3VwOiBib2R5LmNvbGxpc2lvbkZpbHRlckdyb3VwLAogICAgICAgICAgICBib2R5RmlsdGVyTWFzazogYm9keS5jb2xsaXNpb25GaWx0ZXJNYXNrLAogICAgICAgICAgICB0YXJnZXRGaWx0ZXJHcm91cDogdGFyZ2V0LmNvbGxpc2lvbkZpbHRlckdyb3VwLAogICAgICAgICAgICB0YXJnZXRGaWx0ZXJNYXNrOiB0YXJnZXQuY29sbGlzaW9uRmlsdGVyTWFzawogICAgICAgICAgfSwKICAgICAgICAgIGNvbnRhY3Q6IHsKICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBUT0RPOiB1c2UgaWQgaW5zdGVhZCBvZiB1dWlkCiAgICAgICAgICAgIGJpOiBiaS51dWlkLAogICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIFRPRE86IHVzZSBpZCBpbnN0ZWFkIG9mIHV1aWQKICAgICAgICAgICAgYmo6IGJqLnV1aWQsCiAgICAgICAgICAgIC8vIE5vcm1hbCBvZiB0aGUgY29udGFjdCwgcmVsYXRpdmUgdG8gdGhlIGNvbGxpZGluZyBib2R5CiAgICAgICAgICAgIGNvbnRhY3ROb3JtYWw6IGNvbnRhY3ROb3JtYWwudG9BcnJheSgpLAogICAgICAgICAgICAvLyBXb3JsZCBwb3NpdGlvbiBvZiB0aGUgY29udGFjdAogICAgICAgICAgICBjb250YWN0UG9pbnQ6IGNvbnRhY3RQb2ludC50b0FycmF5KCksCiAgICAgICAgICAgIGlkLAogICAgICAgICAgICBpbXBhY3RWZWxvY2l0eTogY29udGFjdC5nZXRJbXBhY3RWZWxvY2l0eUFsb25nTm9ybWFsKCksCiAgICAgICAgICAgIG5pOiBuaS50b0FycmF5KCksCiAgICAgICAgICAgIHJpOiByaS50b0FycmF5KCksCiAgICAgICAgICAgIHJqOiByai50b0FycmF5KCkKICAgICAgICAgIH0sCiAgICAgICAgICBvcDogJ2V2ZW50JywKICAgICAgICAgIHRhcmdldDogdGFyZ2V0LnV1aWQsCiAgICAgICAgICB0eXBlCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH07CgogIGNvbnN0IHRyaXBsZXRUb1ZlYzMgPSB0ID0+IHQgPyBuZXcgVmVjMyguLi50KSA6IHVuZGVmaW5lZDsKCiAgY29uc3QgYWRkQ29uc3RyYWludCA9IChzdGF0ZSwgX3JlZikgPT4gewogICAgbGV0IHsKICAgICAgcHJvcHM6IFtib2R5QSwgYm9keUIsIHsKICAgICAgICBhbmdsZSwKICAgICAgICBheGlzQSwKICAgICAgICBheGlzQiwKICAgICAgICBjb2xsaWRlQ29ubmVjdGVkLAogICAgICAgIGRpc3RhbmNlLAogICAgICAgIG1heEZvcmNlLAogICAgICAgIG1heE11bHRpcGxpZXIsCiAgICAgICAgcGl2b3RBLAogICAgICAgIHBpdm90QiwKICAgICAgICB0d2lzdEFuZ2xlLAogICAgICAgIHdha2VVcEJvZGllcwogICAgICB9XSwKICAgICAgdHlwZSwKICAgICAgdXVpZAogICAgfSA9IF9yZWY7CiAgICBsZXQgY29uc3RyYWludDsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlICdQb2ludFRvUG9pbnQnOgogICAgICAgIGNvbnN0cmFpbnQgPSBuZXcgUG9pbnRUb1BvaW50Q29uc3RyYWludChzdGF0ZS5ib2RpZXNbYm9keUFdLCB0cmlwbGV0VG9WZWMzKHBpdm90QSksIHN0YXRlLmJvZGllc1tib2R5Ql0sIHRyaXBsZXRUb1ZlYzMocGl2b3RCKSwgbWF4Rm9yY2UpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdDb25lVHdpc3QnOgogICAgICAgIGNvbnN0cmFpbnQgPSBuZXcgQ29uZVR3aXN0Q29uc3RyYWludChzdGF0ZS5ib2RpZXNbYm9keUFdLCBzdGF0ZS5ib2RpZXNbYm9keUJdLCB7CiAgICAgICAgICBhbmdsZSwKICAgICAgICAgIGF4aXNBOiB0cmlwbGV0VG9WZWMzKGF4aXNBKSwKICAgICAgICAgIGF4aXNCOiB0cmlwbGV0VG9WZWMzKGF4aXNCKSwKICAgICAgICAgIGNvbGxpZGVDb25uZWN0ZWQsCiAgICAgICAgICBtYXhGb3JjZSwKICAgICAgICAgIHBpdm90QTogdHJpcGxldFRvVmVjMyhwaXZvdEEpLAogICAgICAgICAgcGl2b3RCOiB0cmlwbGV0VG9WZWMzKHBpdm90QiksCiAgICAgICAgICB0d2lzdEFuZ2xlCiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ0hpbmdlJzoKICAgICAgICBjb25zdHJhaW50ID0gbmV3IEhpbmdlQ29uc3RyYWludChzdGF0ZS5ib2RpZXNbYm9keUFdLCBzdGF0ZS5ib2RpZXNbYm9keUJdLCB7CiAgICAgICAgICBheGlzQTogdHJpcGxldFRvVmVjMyhheGlzQSksCiAgICAgICAgICBheGlzQjogdHJpcGxldFRvVmVjMyhheGlzQiksCiAgICAgICAgICBjb2xsaWRlQ29ubmVjdGVkLAogICAgICAgICAgbWF4Rm9yY2UsCiAgICAgICAgICBwaXZvdEE6IHRyaXBsZXRUb1ZlYzMocGl2b3RBKSwKICAgICAgICAgIHBpdm90QjogdHJpcGxldFRvVmVjMyhwaXZvdEIpCiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ0Rpc3RhbmNlJzoKICAgICAgICBjb25zdHJhaW50ID0gbmV3IERpc3RhbmNlQ29uc3RyYWludChzdGF0ZS5ib2RpZXNbYm9keUFdLCBzdGF0ZS5ib2RpZXNbYm9keUJdLCBkaXN0YW5jZSwgbWF4Rm9yY2UpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdMb2NrJzoKICAgICAgICBjb25zdHJhaW50ID0gbmV3IExvY2tDb25zdHJhaW50KHN0YXRlLmJvZGllc1tib2R5QV0sIHN0YXRlLmJvZGllc1tib2R5Ql0sIHsKICAgICAgICAgIG1heEZvcmNlCiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgY29uc3RyYWludCA9IG5ldyBDb25zdHJhaW50KHN0YXRlLmJvZGllc1tib2R5QV0sIHN0YXRlLmJvZGllc1tib2R5Ql0sIHsKICAgICAgICAgIGNvbGxpZGVDb25uZWN0ZWQsCiAgICAgICAgICB3YWtlVXBCb2RpZXMKICAgICAgICB9KTsKICAgICAgICBicmVhazsKICAgIH0KICAgIGNvbnN0cmFpbnQudXVpZCA9IHV1aWQ7CiAgICBzdGF0ZS53b3JsZC5hZGRDb25zdHJhaW50KGNvbnN0cmFpbnQpOwogICAgaWYgKG1heE11bHRpcGxpZXIgIT09IHVuZGVmaW5lZCkgewogICAgICBjb25zdCBwb3N0U3RlcENvbnN0cmFpbnQgPSAoKSA9PiB7CiAgICAgICAgLy8gVGhlIG11bHRpcGxpZXIgaXMgcHJvcG9ydGlvbmFsIHRvIGhvdyBtdWNoIGZvcmNlIGlzIGFkZGVkIHRvIHRoZSBib2RpZXMgYnkgdGhlIGNvbnN0cmFpbnQuCiAgICAgICAgLy8gSWYgdGhpcyBleGNlZWRzIGEgbGltaXQgdGhlIGNvbnN0cmFpbnQgaXMgZGlzYWJsZWQuCiAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IE1hdGguYWJzKGNvbnN0cmFpbnQuZXF1YXRpb25zWzBdLm11bHRpcGxpZXIpOwogICAgICAgIGlmIChtdWx0aXBsaWVyID4gbWF4TXVsdGlwbGllcikgewogICAgICAgICAgY29uc3RyYWludC5kaXNhYmxlKCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBzdGF0ZS5jb25zdHJhaW50c1t1dWlkXSA9IHBvc3RTdGVwQ29uc3RyYWludDsKICAgICAgc3RhdGUud29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBzdGF0ZS5jb25zdHJhaW50c1t1dWlkXSk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gdG9VcHBlcmNhc2Uoc3RyKSB7CiAgICByZXR1cm4gc3RyLnRvVXBwZXJDYXNlKCk7CiAgfQogIGNvbnN0IGFkZFJheSA9IChzdGF0ZSwgX3JlZikgPT4gewogICAgbGV0IHsKICAgICAgcHJvcHM6IHsKICAgICAgICBmcm9tLAogICAgICAgIG1vZGUsCiAgICAgICAgdG8sCiAgICAgICAgLi4ucmF5T3B0aW9ucwogICAgICB9LAogICAgICB1dWlkCiAgICB9ID0gX3JlZjsKICAgIGNvbnN0IHJheSA9IG5ldyBSYXkodHJpcGxldFRvVmVjMyhmcm9tKSwgdHJpcGxldFRvVmVjMyh0bykpOwogICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgbW9kZTogUkFZX01PREVTW3RvVXBwZXJjYXNlKG1vZGUpXSwKICAgICAgcmVzdWx0OiBuZXcgUmF5Y2FzdFJlc3VsdCgpLAogICAgICAuLi5yYXlPcHRpb25zCiAgICB9OwogICAgc3RhdGUucmF5c1t1dWlkXSA9ICgpID0+IHsKICAgICAgcmF5LmludGVyc2VjdFdvcmxkKHN0YXRlLndvcmxkLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLnJlc3VsdCB8fCAhb3B0aW9ucy5yZXN1bHQuYm9keSkgcmV0dXJuOwogICAgICBjb25zdCB7CiAgICAgICAgYm9keSwKICAgICAgICBzaGFwZSwKICAgICAgICByYXlGcm9tV29ybGQsCiAgICAgICAgcmF5VG9Xb3JsZCwKICAgICAgICBoaXROb3JtYWxXb3JsZCwKICAgICAgICBoaXRQb2ludFdvcmxkLAogICAgICAgIC4uLnJlc3QKICAgICAgfSA9IG9wdGlvbnMucmVzdWx0OwogICAgICBjb25zdCBib2R5VVVJRCA9IGJvZHkudXVpZDsKICAgICAgaWYgKCFib2R5VVVJRCkgcmV0dXJuOwogICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICBib2R5OiBib2R5VVVJRCwKICAgICAgICBoaXROb3JtYWxXb3JsZDogaGl0Tm9ybWFsV29ybGQudG9BcnJheSgpLAogICAgICAgIGhpdFBvaW50V29ybGQ6IGhpdFBvaW50V29ybGQudG9BcnJheSgpLAogICAgICAgIG9wOiAnZXZlbnQnLAogICAgICAgIHJheTogewogICAgICAgICAgY29sbGlzaW9uRmlsdGVyR3JvdXA6IHJheS5jb2xsaXNpb25GaWx0ZXJHcm91cCwKICAgICAgICAgIGNvbGxpc2lvbkZpbHRlck1hc2s6IHJheS5jb2xsaXNpb25GaWx0ZXJNYXNrLAogICAgICAgICAgZGlyZWN0aW9uOiByYXkuZGlyZWN0aW9uLnRvQXJyYXkoKSwKICAgICAgICAgIGZyb20sCiAgICAgICAgICB0bywKICAgICAgICAgIHV1aWQKICAgICAgICB9LAogICAgICAgIHJheUZyb21Xb3JsZDogcmF5RnJvbVdvcmxkLnRvQXJyYXkoKSwKICAgICAgICByYXlUb1dvcmxkOiByYXlUb1dvcmxkLnRvQXJyYXkoKSwKICAgICAgICBzaGFwZTogc2hhcGUgPyB7CiAgICAgICAgICAuLi5zaGFwZSwKICAgICAgICAgIGJvZHk6IGJvZHlVVUlECiAgICAgICAgfSA6IG51bGwsCiAgICAgICAgdHlwZTogJ3JheWhpdCcsCiAgICAgICAgLi4ucmVzdAogICAgICB9KTsKICAgIH07CiAgICBzdGF0ZS53b3JsZC5hZGRFdmVudExpc3RlbmVyKCdwcmVTdGVwJywgc3RhdGUucmF5c1t1dWlkXSk7CiAgfTsKCiAgY29uc3QgYWRkUmF5Y2FzdFZlaGljbGUgPSAoc3RhdGUsIGRhdGEpID0+IHsKICAgIGNvbnN0IFtjaGFzc2lzQm9keSwgd2hlZWxzLCB3aGVlbEluZm9zLCBpbmRleEZvcndhcmRBeGlzLCBpbmRleFJpZ2h0QXhpcywgaW5kZXhVcEF4aXNdID0gZGF0YS5wcm9wczsKICAgIGNvbnN0IHZlaGljbGUgPSBuZXcgUmF5Y2FzdFZlaGljbGUoewogICAgICBjaGFzc2lzQm9keTogc3RhdGUuYm9kaWVzW2NoYXNzaXNCb2R5XSwKICAgICAgaW5kZXhGb3J3YXJkQXhpcywKICAgICAgaW5kZXhSaWdodEF4aXMsCiAgICAgIGluZGV4VXBBeGlzCiAgICB9KTsKICAgIHZlaGljbGUud29ybGQgPSBzdGF0ZS53b3JsZDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2hlZWxJbmZvcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB7CiAgICAgICAgYXhsZUxvY2FsLAogICAgICAgIGNoYXNzaXNDb25uZWN0aW9uUG9pbnRMb2NhbCwKICAgICAgICBkaXJlY3Rpb25Mb2NhbCwKICAgICAgICAuLi5yZXN0CiAgICAgIH0gPSB3aGVlbEluZm9zW2ldOwogICAgICB2ZWhpY2xlLmFkZFdoZWVsKHsKICAgICAgICBheGxlTG9jYWw6IHRyaXBsZXRUb1ZlYzMoYXhsZUxvY2FsKSwKICAgICAgICBjaGFzc2lzQ29ubmVjdGlvblBvaW50TG9jYWw6IHRyaXBsZXRUb1ZlYzMoY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludExvY2FsKSwKICAgICAgICBkaXJlY3Rpb25Mb2NhbDogdHJpcGxldFRvVmVjMyhkaXJlY3Rpb25Mb2NhbCksCiAgICAgICAgLi4ucmVzdAogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHByZVN0ZXAgPSAoKSA9PiB7CiAgICAgIHZlaGljbGUudXBkYXRlVmVoaWNsZShzdGF0ZS53b3JsZC5kdCk7CiAgICB9OwogICAgY29uc3QgcG9zdFN0ZXAgPSAoKSA9PiB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVoaWNsZS53aGVlbEluZm9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmVoaWNsZS51cGRhdGVXaGVlbFRyYW5zZm9ybShpKTsKICAgICAgICBjb25zdCB0ID0gdmVoaWNsZS53aGVlbEluZm9zW2ldLndvcmxkVHJhbnNmb3JtOwogICAgICAgIGNvbnN0IHdoZWVsQm9keSA9IHN0YXRlLmJvZGllc1t3aGVlbHNbaV1dOwogICAgICAgIHdoZWVsQm9keS5wb3NpdGlvbi5jb3B5KHQucG9zaXRpb24pOwogICAgICAgIHdoZWVsQm9keS5xdWF0ZXJuaW9uLmNvcHkodC5xdWF0ZXJuaW9uKTsKICAgICAgfQogICAgfTsKICAgIHN0YXRlLnZlaGljbGVzW2RhdGEudXVpZF0gPSB7CiAgICAgIHBvc3RTdGVwLAogICAgICBwcmVTdGVwLAogICAgICB2ZWhpY2xlCiAgICB9OwogICAgc3RhdGUud29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncHJlU3RlcCcsIHByZVN0ZXApOwogICAgc3RhdGUud29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBwb3N0U3RlcCk7CiAgfTsKCiAgY29uc3QgYWRkU3ByaW5nID0gKHN0YXRlLCBfcmVmKSA9PiB7CiAgICBsZXQgewogICAgICBwcm9wczogW2JvZHlBLCBib2R5QiwgewogICAgICAgIGRhbXBpbmcsCiAgICAgICAgbG9jYWxBbmNob3JBLAogICAgICAgIGxvY2FsQW5jaG9yQiwKICAgICAgICByZXN0TGVuZ3RoLAogICAgICAgIHN0aWZmbmVzcywKICAgICAgICB3b3JsZEFuY2hvckEsCiAgICAgICAgd29ybGRBbmNob3JCCiAgICAgIH1dLAogICAgICB1dWlkCiAgICB9ID0gX3JlZjsKICAgIGNvbnN0IHNwcmluZyA9IG5ldyBTcHJpbmcoc3RhdGUuYm9kaWVzW2JvZHlBXSwgc3RhdGUuYm9kaWVzW2JvZHlCXSwgewogICAgICBkYW1waW5nLAogICAgICBsb2NhbEFuY2hvckE6IHRyaXBsZXRUb1ZlYzMobG9jYWxBbmNob3JBKSwKICAgICAgbG9jYWxBbmNob3JCOiB0cmlwbGV0VG9WZWMzKGxvY2FsQW5jaG9yQiksCiAgICAgIHJlc3RMZW5ndGgsCiAgICAgIHN0aWZmbmVzcywKICAgICAgd29ybGRBbmNob3JBOiB0cmlwbGV0VG9WZWMzKHdvcmxkQW5jaG9yQSksCiAgICAgIHdvcmxkQW5jaG9yQjogdHJpcGxldFRvVmVjMyh3b3JsZEFuY2hvckIpCiAgICB9KTsKICAgIHNwcmluZy51dWlkID0gdXVpZDsKICAgIGNvbnN0IHBvc3RTdGVwU3ByaW5nID0gKCkgPT4gc3ByaW5nLmFwcGx5Rm9yY2UoKTsKICAgIHN0YXRlLnNwcmluZ3NbdXVpZF0gPSBwb3N0U3RlcFNwcmluZzsKICAgIHN0YXRlLnNwcmluZ0luc3RhbmNlc1t1dWlkXSA9IHNwcmluZzsKCiAgICAvLyBDb21wdXRlIHRoZSBmb3JjZSBhZnRlciBlYWNoIHN0ZXAKICAgIHN0YXRlLndvcmxkLmFkZEV2ZW50TGlzdGVuZXIoJ3Bvc3RTdGVwJywgc3RhdGUuc3ByaW5nc1t1dWlkXSk7CiAgfTsKCiAgZnVuY3Rpb24gZW1pdEJlZ2luQ29udGFjdChfcmVmKSB7CiAgICBsZXQgewogICAgICBib2R5QSwKICAgICAgYm9keUIKICAgIH0gPSBfcmVmOwogICAgaWYgKCEoYm9keUEgIT0gbnVsbCAmJiBib2R5QS51dWlkKSB8fCAhKGJvZHlCICE9IG51bGwgJiYgYm9keUIudXVpZCkpIHJldHVybjsKICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICBib2R5QTogYm9keUEudXVpZCwKICAgICAgYm9keUI6IGJvZHlCLnV1aWQsCiAgICAgIG9wOiAnZXZlbnQnLAogICAgICB0eXBlOiAnY29sbGlkZUJlZ2luJwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGVtaXRFbmRDb250YWN0KF9yZWYyKSB7CiAgICBsZXQgewogICAgICBib2R5QSwKICAgICAgYm9keUIKICAgIH0gPSBfcmVmMjsKICAgIGlmICghKGJvZHlBICE9IG51bGwgJiYgYm9keUEudXVpZCkgfHwgIShib2R5QiAhPSBudWxsICYmIGJvZHlCLnV1aWQpKSByZXR1cm47CiAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgYm9keUE6IGJvZHlBLnV1aWQsCiAgICAgIGJvZHlCOiBib2R5Qi51dWlkLAogICAgICBvcDogJ2V2ZW50JywKICAgICAgdHlwZTogJ2NvbGxpZGVFbmQnCiAgICB9KTsKICB9CiAgY29uc3QgaW5pdCA9ICh3b3JsZCwgX3JlZjMpID0+IHsKICAgIGxldCB7CiAgICAgIGFsbG93U2xlZXAsCiAgICAgIGF4aXNJbmRleCA9IDAsCiAgICAgIGJyb2FkcGhhc2UsCiAgICAgIGRlZmF1bHRDb250YWN0TWF0ZXJpYWwsCiAgICAgIGZyaWN0aW9uR3Jhdml0eSwKICAgICAgZ3Jhdml0eSwKICAgICAgaXRlcmF0aW9ucywKICAgICAgcXVhdE5vcm1hbGl6ZUZhc3QsCiAgICAgIHF1YXROb3JtYWxpemVTa2lwLAogICAgICBzb2x2ZXIsCiAgICAgIHRvbGVyYW5jZQogICAgfSA9IF9yZWYzOwogICAgd29ybGQuYWxsb3dTbGVlcCA9IGFsbG93U2xlZXA7CiAgICB3b3JsZC5ncmF2aXR5LnNldCguLi5ncmF2aXR5KTsKICAgIHdvcmxkLmZyaWN0aW9uR3Jhdml0eSA9IGZyaWN0aW9uR3Jhdml0eSA/IG5ldyBWZWMzKC4uLmZyaWN0aW9uR3Jhdml0eSkgOiB1bmRlZmluZWQ7CiAgICB3b3JsZC5xdWF0Tm9ybWFsaXplRmFzdCA9IHF1YXROb3JtYWxpemVGYXN0OwogICAgd29ybGQucXVhdE5vcm1hbGl6ZVNraXAgPSBxdWF0Tm9ybWFsaXplU2tpcDsKICAgIGlmIChzb2x2ZXIgPT09ICdTcGxpdCcpIHsKICAgICAgd29ybGQuc29sdmVyID0gbmV3IFNwbGl0U29sdmVyKG5ldyBHU1NvbHZlcigpKTsKICAgIH0KICAgIGlmICh3b3JsZC5zb2x2ZXIgaW5zdGFuY2VvZiBHU1NvbHZlcikgewogICAgICB3b3JsZC5zb2x2ZXIudG9sZXJhbmNlID0gdG9sZXJhbmNlOwogICAgICB3b3JsZC5zb2x2ZXIuaXRlcmF0aW9ucyA9IGl0ZXJhdGlvbnM7CiAgICB9CiAgICB3b3JsZC5icm9hZHBoYXNlID0gYnJvYWRwaGFzZSA9PT0gJ1NBUCcgPyBuZXcgU0FQQnJvYWRwaGFzZSh3b3JsZCkgOiBuZXcgTmFpdmVCcm9hZHBoYXNlKCk7CiAgICBpZiAod29ybGQuYnJvYWRwaGFzZSBpbnN0YW5jZW9mIFNBUEJyb2FkcGhhc2UpIHsKICAgICAgd29ybGQuYnJvYWRwaGFzZS5heGlzSW5kZXggPSBheGlzSW5kZXg7CiAgICB9CiAgICB3b3JsZC5hZGRFdmVudExpc3RlbmVyKCdiZWdpbkNvbnRhY3QnLCBlbWl0QmVnaW5Db250YWN0KTsKICAgIHdvcmxkLmFkZEV2ZW50TGlzdGVuZXIoJ2VuZENvbnRhY3QnLCBlbWl0RW5kQ29udGFjdCk7CiAgICBPYmplY3QuYXNzaWduKHdvcmxkLmRlZmF1bHRDb250YWN0TWF0ZXJpYWwsIGRlZmF1bHRDb250YWN0TWF0ZXJpYWwpOwogIH07CgogIGNvbnN0IGlzUW9yViA9IHYgPT4gdiBpbnN0YW5jZW9mIFF1YXRlcm5pb24gfHwgdiBpbnN0YW5jZW9mIFZlYzM7CiAgY29uc3Qgc3RlcCA9IChzdGF0ZSwgX3JlZikgPT4gewogICAgbGV0IHsKICAgICAgcG9zaXRpb25zLAogICAgICBwcm9wczogewogICAgICAgIG1heFN1YlN0ZXBzLAogICAgICAgIHN0ZXBTaXplLAogICAgICAgIHRpbWVTaW5jZUxhc3RDYWxsZWQKICAgICAgfSwKICAgICAgcXVhdGVybmlvbnMKICAgIH0gPSBfcmVmOwogICAgc3RhdGUud29ybGQuc3RlcChzdGVwU2l6ZSwgdGltZVNpbmNlTGFzdENhbGxlZCwgbWF4U3ViU3RlcHMpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdGF0ZS53b3JsZC5ib2RpZXMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgY29uc3QgcCA9IHN0YXRlLndvcmxkLmJvZGllc1tpXS5wb3NpdGlvbjsKICAgICAgY29uc3QgcSA9IHN0YXRlLndvcmxkLmJvZGllc1tpXS5xdWF0ZXJuaW9uOwogICAgICBwb3NpdGlvbnNbMyAqIGkgKyAwXSA9IHAueDsKICAgICAgcG9zaXRpb25zWzMgKiBpICsgMV0gPSBwLnk7CiAgICAgIHBvc2l0aW9uc1szICogaSArIDJdID0gcC56OwogICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDBdID0gcS54OwogICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDFdID0gcS55OwogICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDJdID0gcS56OwogICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDNdID0gcS53OwogICAgfQogICAgY29uc3Qgb2JzZXJ2YXRpb25zID0gW107CiAgICBmb3IgKGNvbnN0IGlkIG9mIE9iamVjdC5rZXlzKHN0YXRlLnN1YnNjcmlwdGlvbnMpKSB7CiAgICAgIGNvbnN0IFt1dWlkLCB0eXBlLCB0YXJnZXQgPSAnYm9kaWVzJ10gPSBzdGF0ZS5zdWJzY3JpcHRpb25zW2lkXTsKICAgICAgY29uc3QgewogICAgICAgIGJvZGllcywKICAgICAgICB2ZWhpY2xlcwogICAgICB9ID0gc3RhdGU7CiAgICAgIGNvbnN0IHZhbHVlID0gdGFyZ2V0ID09PSAndmVoaWNsZXMnID8KICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBUT0RPOiBEaWZmZXJlbnRpYXRlIHRoZXNlICJ0eXBlcyIKICAgICAgdmVoaWNsZXNbdXVpZF0udmVoaWNsZVt0eXBlXSA6CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgVE9ETzogRGlmZmVyZW50aWF0ZSB0aGVzZSAidHlwZXMiCiAgICAgIGJvZGllc1t1dWlkXVt0eXBlXTsKICAgICAgY29uc3Qgc2VyaWFsaXphYmxlVmFsdWUgPSBpc1FvclYodmFsdWUpID8gdmFsdWUudG9BcnJheSgpIDogdmFsdWU7CiAgICAgIG9ic2VydmF0aW9ucy5wdXNoKFtOdW1iZXIoaWQpLCBzZXJpYWxpemFibGVWYWx1ZSwKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBUT0RPOiBEaWZmZXJlbnRpYXRlIHRoZXNlICJ0eXBlcyIKICAgICAgdHlwZV0pOwogICAgfQogICAgY29uc3QgbWVzc2FnZSA9IHsKICAgICAgYWN0aXZlOiBzdGF0ZS53b3JsZC5oYXNBY3RpdmVCb2RpZXMsCiAgICAgIG9ic2VydmF0aW9ucywKICAgICAgb3A6ICdmcmFtZScsCiAgICAgIHBvc2l0aW9ucywKICAgICAgcXVhdGVybmlvbnMKICAgIH07CiAgICBpZiAoc3RhdGUuYm9kaWVzTmVlZFN5bmNpbmcpIHsKICAgICAgbWVzc2FnZS5ib2RpZXMgPSBzdGF0ZS53b3JsZC5ib2RpZXMucmVkdWNlKChib2RpZXMsIGJvZHkpID0+IHsKICAgICAgICBpZiAoYm9keS51dWlkKSBib2RpZXMucHVzaChib2R5LnV1aWQpOwogICAgICAgIHJldHVybiBib2RpZXM7CiAgICAgIH0sIFtdKTsKICAgICAgc3RhdGUuYm9kaWVzTmVlZFN5bmNpbmcgPSBmYWxzZTsKICAgIH0KICAgIHNlbGYucG9zdE1lc3NhZ2UobWVzc2FnZSwgW3Bvc2l0aW9ucy5idWZmZXIsIHF1YXRlcm5pb25zLmJ1ZmZlcl0pOwogIH07CgogIGNvbnN0IHN0YXRlID0gewogICAgYm9kaWVzOiB7fSwKICAgIGJvZGllc05lZWRTeW5jaW5nOiBmYWxzZSwKICAgIGNvbnN0cmFpbnRzOiB7fSwKICAgIG1hdGVyaWFsczoge30sCiAgICByYXlzOiB7fSwKICAgIHNwcmluZ0luc3RhbmNlczoge30sCiAgICBzcHJpbmdzOiB7fSwKICAgIHN1YnNjcmlwdGlvbnM6IHt9LAogICAgdmVoaWNsZXM6IHt9LAogICAgd29ybGQ6IG5ldyBXb3JsZCgpCiAgfTsKCiAgLy8vIDxyZWZlcmVuY2Ugbm8tZGVmYXVsdC1saWI9InRydWUiLz4KICBjb25zdCBpc0hpbmdlQ29uc3RyYWludCA9IGMgPT4gYyBpbnN0YW5jZW9mIEhpbmdlQ29uc3RyYWludDsKICBmdW5jdGlvbiBzeW5jQm9kaWVzKCkgewogICAgc3RhdGUuYm9kaWVzTmVlZFN5bmNpbmcgPSB0cnVlOwogICAgc3RhdGUuYm9kaWVzID0gc3RhdGUud29ybGQuYm9kaWVzLnJlZHVjZSgoYm9kaWVzLCBib2R5KSA9PiBib2R5LnV1aWQgPyB7CiAgICAgIC4uLmJvZGllcywKICAgICAgW2JvZHkudXVpZF06IGJvZHkKICAgIH0gOiBib2RpZXMsIHt9KTsKICB9CiAgY29uc3QgYnJvYWRwaGFzZXMgPSB7CiAgICBOYWl2ZUJyb2FkcGhhc2UsCiAgICBTQVBCcm9hZHBoYXNlCiAgfTsKICBjb25zdCBjcmVhdGVNYXRlcmlhbCA9IGNyZWF0ZU1hdGVyaWFsRmFjdG9yeShzdGF0ZS5tYXRlcmlhbHMpOwogIHNlbGYub25tZXNzYWdlID0gX3JlZiA9PiB7CiAgICBsZXQgewogICAgICBkYXRhCiAgICB9ID0gX3JlZjsKICAgIHN3aXRjaCAoZGF0YS5vcCkgewogICAgICBjYXNlICdpbml0JzoKICAgICAgICB7CiAgICAgICAgICBpbml0KHN0YXRlLndvcmxkLCBkYXRhLnByb3BzKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnc3RlcCc6CiAgICAgICAgewogICAgICAgICAgc3RlcChzdGF0ZSwgZGF0YSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ2FkZEJvZGllcyc6CiAgICAgICAgewogICAgICAgICAgYWRkQm9kaWVzKHN0YXRlLCBjcmVhdGVNYXRlcmlhbCwgZGF0YSk7CiAgICAgICAgICBzeW5jQm9kaWVzKCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3JlbW92ZUJvZGllcyc6CiAgICAgICAgewogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLnV1aWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgc3RhdGUud29ybGQucmVtb3ZlQm9keShzdGF0ZS5ib2RpZXNbZGF0YS51dWlkW2ldXSk7CiAgICAgICAgICAgIGNvbnN0IGtleSA9IE9iamVjdC5rZXlzKHN0YXRlLnN1YnNjcmlwdGlvbnMpLmZpbmQoayA9PiBzdGF0ZS5zdWJzY3JpcHRpb25zW2tdWzBdID09PSBkYXRhLnV1aWRbaV0pOwogICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnN1YnNjcmlwdGlvbnNba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3luY0JvZGllcygpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdzdWJzY3JpYmUnOgogICAgICAgIHsKICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgaWQsCiAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgdHlwZQogICAgICAgICAgfSA9IGRhdGEucHJvcHM7CiAgICAgICAgICBzdGF0ZS5zdWJzY3JpcHRpb25zW2lkXSA9IFtkYXRhLnV1aWQsIHR5cGUsIHRhcmdldF07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3Vuc3Vic2NyaWJlJzoKICAgICAgICB7CiAgICAgICAgICBkZWxldGUgc3RhdGUuc3Vic2NyaXB0aW9uc1tkYXRhLnByb3BzXTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnc2V0UG9zaXRpb24nOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLnBvc2l0aW9uLnNldChkYXRhLnByb3BzWzBdLCBkYXRhLnByb3BzWzFdLCBkYXRhLnByb3BzWzJdKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0UXVhdGVybmlvbic6CiAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0ucXVhdGVybmlvbi5zZXQoZGF0YS5wcm9wc1swXSwgZGF0YS5wcm9wc1sxXSwgZGF0YS5wcm9wc1syXSwgZGF0YS5wcm9wc1szXSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldFJvdGF0aW9uJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5xdWF0ZXJuaW9uLnNldEZyb21FdWxlcihkYXRhLnByb3BzWzBdLCBkYXRhLnByb3BzWzFdLCBkYXRhLnByb3BzWzJdKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0VmVsb2NpdHknOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLnZlbG9jaXR5LnNldChkYXRhLnByb3BzWzBdLCBkYXRhLnByb3BzWzFdLCBkYXRhLnByb3BzWzJdKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0QW5ndWxhclZlbG9jaXR5JzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5hbmd1bGFyVmVsb2NpdHkuc2V0KGRhdGEucHJvcHNbMF0sIGRhdGEucHJvcHNbMV0sIGRhdGEucHJvcHNbMl0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRMaW5lYXJGYWN0b3InOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmxpbmVhckZhY3Rvci5zZXQoZGF0YS5wcm9wc1swXSwgZGF0YS5wcm9wc1sxXSwgZGF0YS5wcm9wc1syXSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldEFuZ3VsYXJGYWN0b3InOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmFuZ3VsYXJGYWN0b3Iuc2V0KGRhdGEucHJvcHNbMF0sIGRhdGEucHJvcHNbMV0sIGRhdGEucHJvcHNbMl0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRNYXNzJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5tYXNzID0gZGF0YS5wcm9wczsKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS51cGRhdGVNYXNzUHJvcGVydGllcygpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRNYXRlcmlhbCc6CiAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0ubWF0ZXJpYWwgPSBkYXRhLnByb3BzID8gY3JlYXRlTWF0ZXJpYWwoZGF0YS5wcm9wcykgOiBudWxsOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRMaW5lYXJEYW1waW5nJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5saW5lYXJEYW1waW5nID0gZGF0YS5wcm9wczsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0QW5ndWxhckRhbXBpbmcnOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmFuZ3VsYXJEYW1waW5nID0gZGF0YS5wcm9wczsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0QWxsb3dTbGVlcCc6CiAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0uYWxsb3dTbGVlcCA9IGRhdGEucHJvcHM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldFNsZWVwU3BlZWRMaW1pdCc6CiAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0uc2xlZXBTcGVlZExpbWl0ID0gZGF0YS5wcm9wczsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0U2xlZXBUaW1lTGltaXQnOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLnNsZWVwVGltZUxpbWl0ID0gZGF0YS5wcm9wczsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0Q29sbGlzaW9uRmlsdGVyR3JvdXAnOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmNvbGxpc2lvbkZpbHRlckdyb3VwID0gZGF0YS5wcm9wczsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0Q29sbGlzaW9uRmlsdGVyTWFzayc6CiAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0uY29sbGlzaW9uRmlsdGVyTWFzayA9IGRhdGEucHJvcHM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldENvbGxpc2lvblJlc3BvbnNlJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5jb2xsaXNpb25SZXNwb25zZSA9IGRhdGEucHJvcHM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldEZpeGVkUm90YXRpb24nOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmZpeGVkUm90YXRpb24gPSBkYXRhLnByb3BzOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRGcmljdGlvbkdyYXZpdHknOgogICAgICAgIHN0YXRlLndvcmxkLmZyaWN0aW9uR3Jhdml0eSA9IGRhdGEucHJvcHMgPyBuZXcgVmVjMyguLi5kYXRhLnByb3BzKSA6IHVuZGVmaW5lZDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0SXNUcmlnZ2VyJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5pc1RyaWdnZXIgPSBkYXRhLnByb3BzOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRHcmF2aXR5JzoKICAgICAgICBzdGF0ZS53b3JsZC5ncmF2aXR5LnNldChkYXRhLnByb3BzWzBdLCBkYXRhLnByb3BzWzFdLCBkYXRhLnByb3BzWzJdKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0VG9sZXJhbmNlJzoKICAgICAgICBpZiAoc3RhdGUud29ybGQuc29sdmVyIGluc3RhbmNlb2YgR1NTb2x2ZXIpIHsKICAgICAgICAgIHN0YXRlLndvcmxkLnNvbHZlci50b2xlcmFuY2UgPSBkYXRhLnByb3BzOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0SXRlcmF0aW9ucyc6CiAgICAgICAgaWYgKHN0YXRlLndvcmxkLnNvbHZlciBpbnN0YW5jZW9mIEdTU29sdmVyKSB7CiAgICAgICAgICBzdGF0ZS53b3JsZC5zb2x2ZXIuaXRlcmF0aW9ucyA9IGRhdGEucHJvcHM7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRCcm9hZHBoYXNlJzoKICAgICAgICBzdGF0ZS53b3JsZC5icm9hZHBoYXNlID0gbmV3IChicm9hZHBoYXNlc1tgJHtkYXRhLnByb3BzfUJyb2FkcGhhc2VgXSB8fCBOYWl2ZUJyb2FkcGhhc2UpKHN0YXRlLndvcmxkKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0QXhpc0luZGV4JzoKICAgICAgICBpZiAoc3RhdGUud29ybGQuYnJvYWRwaGFzZSBpbnN0YW5jZW9mIFNBUEJyb2FkcGhhc2UpIHsKICAgICAgICAgIHN0YXRlLndvcmxkLmJyb2FkcGhhc2UuYXhpc0luZGV4ID0gZGF0YS5wcm9wcyA9PT0gdW5kZWZpbmVkIHx8IGRhdGEucHJvcHMgPT09IG51bGwgPyAwIDogZGF0YS5wcm9wczsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2FwcGx5Rm9yY2UnOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmFwcGx5Rm9yY2UobmV3IFZlYzMoLi4uZGF0YS5wcm9wc1swXSksIG5ldyBWZWMzKC4uLmRhdGEucHJvcHNbMV0pKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnYXBwbHlJbXB1bHNlJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5hcHBseUltcHVsc2UobmV3IFZlYzMoLi4uZGF0YS5wcm9wc1swXSksIG5ldyBWZWMzKC4uLmRhdGEucHJvcHNbMV0pKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnYXBwbHlMb2NhbEZvcmNlJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5hcHBseUxvY2FsRm9yY2UobmV3IFZlYzMoLi4uZGF0YS5wcm9wc1swXSksIG5ldyBWZWMzKC4uLmRhdGEucHJvcHNbMV0pKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnYXBwbHlMb2NhbEltcHVsc2UnOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmFwcGx5TG9jYWxJbXB1bHNlKG5ldyBWZWMzKC4uLmRhdGEucHJvcHNbMF0pLCBuZXcgVmVjMyguLi5kYXRhLnByb3BzWzFdKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2FwcGx5VG9ycXVlJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5hcHBseVRvcnF1ZShuZXcgVmVjMyguLi5kYXRhLnByb3BzWzBdKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2FkZENvbnN0cmFpbnQnOgogICAgICAgIHsKICAgICAgICAgIGFkZENvbnN0cmFpbnQoc3RhdGUsIGRhdGEpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdyZW1vdmVDb25zdHJhaW50JzoKICAgICAgICBzdGF0ZS53b3JsZC5jb25zdHJhaW50cy5maWx0ZXIoX3JlZjIgPT4gewogICAgICAgICAgbGV0IHsKICAgICAgICAgICAgdXVpZAogICAgICAgICAgfSA9IF9yZWYyOwogICAgICAgICAgcmV0dXJuIHV1aWQgPT09IGRhdGEudXVpZDsKICAgICAgICB9KS5tYXAoYyA9PiBzdGF0ZS53b3JsZC5yZW1vdmVDb25zdHJhaW50KGMpKTsKICAgICAgICBpZiAoc3RhdGUuY29uc3RyYWludHNbZGF0YS51dWlkXSkgewogICAgICAgICAgc3RhdGUud29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBzdGF0ZS5jb25zdHJhaW50c1tkYXRhLnV1aWRdKTsKICAgICAgICAgIGRlbGV0ZSBzdGF0ZS5jb25zdHJhaW50c1tkYXRhLnV1aWRdOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAnZW5hYmxlQ29uc3RyYWludCc6CiAgICAgICAgc3RhdGUud29ybGQuY29uc3RyYWludHMuZmlsdGVyKGMgPT4gYy51dWlkID09PSBkYXRhLnV1aWQpLm1hcChjID0+IGMuZW5hYmxlKCkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdkaXNhYmxlQ29uc3RyYWludCc6CiAgICAgICAgc3RhdGUud29ybGQuY29uc3RyYWludHMuZmlsdGVyKGMgPT4gYy51dWlkID09PSBkYXRhLnV1aWQpLm1hcChjID0+IGMuZGlzYWJsZSgpKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnZW5hYmxlQ29uc3RyYWludE1vdG9yJzoKICAgICAgICBzdGF0ZS53b3JsZC5jb25zdHJhaW50cy5maWx0ZXIoYyA9PiBjLnV1aWQgPT09IGRhdGEudXVpZCkuZmlsdGVyKGlzSGluZ2VDb25zdHJhaW50KS5tYXAoYyA9PiBjLmVuYWJsZU1vdG9yKCkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdkaXNhYmxlQ29uc3RyYWludE1vdG9yJzoKICAgICAgICBzdGF0ZS53b3JsZC5jb25zdHJhaW50cy5maWx0ZXIoYyA9PiBjLnV1aWQgPT09IGRhdGEudXVpZCkuZmlsdGVyKGlzSGluZ2VDb25zdHJhaW50KS5tYXAoYyA9PiBjLmRpc2FibGVNb3RvcigpKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0Q29uc3RyYWludE1vdG9yU3BlZWQnOgogICAgICAgIHN0YXRlLndvcmxkLmNvbnN0cmFpbnRzLmZpbHRlcihjID0+IGMudXVpZCA9PT0gZGF0YS51dWlkKS5maWx0ZXIoaXNIaW5nZUNvbnN0cmFpbnQpLm1hcChjID0+IGMuc2V0TW90b3JTcGVlZChkYXRhLnByb3BzKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldENvbnN0cmFpbnRNb3Rvck1heEZvcmNlJzoKICAgICAgICBzdGF0ZS53b3JsZC5jb25zdHJhaW50cy5maWx0ZXIoYyA9PiBjLnV1aWQgPT09IGRhdGEudXVpZCkuZmlsdGVyKGlzSGluZ2VDb25zdHJhaW50KS5tYXAoYyA9PiBjLnNldE1vdG9yTWF4Rm9yY2UoZGF0YS5wcm9wcykpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdhZGRTcHJpbmcnOgogICAgICAgIHsKICAgICAgICAgIGFkZFNwcmluZyhzdGF0ZSwgZGF0YSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3NldFNwcmluZ1N0aWZmbmVzcyc6CiAgICAgICAgewogICAgICAgICAgc3RhdGUuc3ByaW5nSW5zdGFuY2VzW2RhdGEudXVpZF0uc3RpZmZuZXNzID0gZGF0YS5wcm9wczsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnc2V0U3ByaW5nUmVzdExlbmd0aCc6CiAgICAgICAgewogICAgICAgICAgc3RhdGUuc3ByaW5nSW5zdGFuY2VzW2RhdGEudXVpZF0ucmVzdExlbmd0aCA9IGRhdGEucHJvcHM7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3NldFNwcmluZ0RhbXBpbmcnOgogICAgICAgIHsKICAgICAgICAgIHN0YXRlLnNwcmluZ0luc3RhbmNlc1tkYXRhLnV1aWRdLmRhbXBpbmcgPSBkYXRhLnByb3BzOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdyZW1vdmVTcHJpbmcnOgogICAgICAgIHsKICAgICAgICAgIHN0YXRlLndvcmxkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Bvc3RTdGVwJywgc3RhdGUuc3ByaW5nc1tkYXRhLnV1aWRdKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnYWRkUmF5JzoKICAgICAgICB7CiAgICAgICAgICBhZGRSYXkoc3RhdGUsIGRhdGEpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdyZW1vdmVSYXknOgogICAgICAgIHsKICAgICAgICAgIHN0YXRlLndvcmxkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3ByZVN0ZXAnLCBzdGF0ZS5yYXlzW2RhdGEudXVpZF0pOwogICAgICAgICAgZGVsZXRlIHN0YXRlLnJheXNbZGF0YS51dWlkXTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnYWRkUmF5Y2FzdFZlaGljbGUnOgogICAgICAgIHsKICAgICAgICAgIGFkZFJheWNhc3RWZWhpY2xlKHN0YXRlLCBkYXRhKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAncmVtb3ZlUmF5Y2FzdFZlaGljbGUnOgogICAgICAgIHsKICAgICAgICAgIHN0YXRlLndvcmxkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3ByZVN0ZXAnLCBzdGF0ZS52ZWhpY2xlc1tkYXRhLnV1aWRdLnByZVN0ZXApOwogICAgICAgICAgc3RhdGUud29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBzdGF0ZS52ZWhpY2xlc1tkYXRhLnV1aWRdLnBvc3RTdGVwKTsKICAgICAgICAgIHN0YXRlLnZlaGljbGVzW2RhdGEudXVpZF0udmVoaWNsZS53b3JsZCA9IG51bGw7CiAgICAgICAgICBkZWxldGUgc3RhdGUudmVoaWNsZXNbZGF0YS51dWlkXTsKICAgICAgICAgIGNvbnN0IGtleSA9IE9iamVjdC5rZXlzKHN0YXRlLnN1YnNjcmlwdGlvbnMpLmZpbmQoayA9PiBzdGF0ZS5zdWJzY3JpcHRpb25zW2tdWzBdID09PSBkYXRhLnV1aWQpOwogICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUuc3Vic2NyaXB0aW9uc1trZXldOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdzZXRSYXljYXN0VmVoaWNsZVN0ZWVyaW5nVmFsdWUnOgogICAgICAgIHsKICAgICAgICAgIGNvbnN0IFt2YWx1ZSwgd2hlZWxJbmRleF0gPSBkYXRhLnByb3BzOwogICAgICAgICAgc3RhdGUudmVoaWNsZXNbZGF0YS51dWlkXS52ZWhpY2xlLnNldFN0ZWVyaW5nVmFsdWUodmFsdWUsIHdoZWVsSW5kZXgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdhcHBseVJheWNhc3RWZWhpY2xlRW5naW5lRm9yY2UnOgogICAgICAgIHsKICAgICAgICAgIGNvbnN0IFt2YWx1ZSwgd2hlZWxJbmRleF0gPSBkYXRhLnByb3BzOwogICAgICAgICAgc3RhdGUudmVoaWNsZXNbZGF0YS51dWlkXS52ZWhpY2xlLmFwcGx5RW5naW5lRm9yY2UodmFsdWUsIHdoZWVsSW5kZXgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdzZXRSYXljYXN0VmVoaWNsZUJyYWtlJzoKICAgICAgICB7CiAgICAgICAgICBjb25zdCBbYnJha2UsIHdoZWVsSW5kZXhdID0gZGF0YS5wcm9wczsKICAgICAgICAgIHN0YXRlLnZlaGljbGVzW2RhdGEudXVpZF0udmVoaWNsZS5zZXRCcmFrZShicmFrZSwgd2hlZWxJbmRleCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ2FkZENvbnRhY3RNYXRlcmlhbCc6CiAgICAgICAgewogICAgICAgICAgYWRkQ29udGFjdE1hdGVyaWFsKHN0YXRlLndvcmxkLCBjcmVhdGVNYXRlcmlhbCwgZGF0YS5wcm9wcywgZGF0YS51dWlkKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAncmVtb3ZlQ29udGFjdE1hdGVyaWFsJzoKICAgICAgICB7CiAgICAgICAgICByZW1vdmVDb250YWN0TWF0ZXJpYWwoc3RhdGUud29ybGQsIGRhdGEudXVpZCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3dha2VVcCc6CiAgICAgICAgewogICAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0ud2FrZVVwKCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3NsZWVwJzoKICAgICAgICB7CiAgICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5zbGVlcCgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQogIH07Cgp9KSgpOwoK",null,!1,function(e){return nb=nb||function(e,g,t){var I=void 0===g?null:g,n=function(e,g){var t=atob(e);if(g){for(var I=new Uint8Array(t.length),n=0,i=t.length;n<i;++n)I[n]=t.charCodeAt(n);return String.fromCharCode.apply(null,new Uint16Array(I.buffer))}return t}(e,void 0!==t&&t),i=n.indexOf("\n",10)+1,C=n.substring(i)+(I?"//# sourceMappingURL="+I:""),o=new Blob([C],{type:"application/javascript"});return URL.createObjectURL(o)}("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICogUmVjb3JkcyB3aGF0IG9iamVjdHMgYXJlIGNvbGxpZGluZyB3aXRoIGVhY2ggb3RoZXIKICAgKi8KCiAgLyoqCiAgICogQSAzeDMgbWF0cml4LgogICAqIEF1dGhvcmVkIGJ5IHtAbGluayBodHRwOi8vZ2l0aHViLmNvbS9zY2h0ZXBwZS8gc2NodGVwcGV9CiAgICovCiAgY2xhc3MgTWF0MyB7CiAgICAvKioKICAgICAqIEEgdmVjdG9yIG9mIGxlbmd0aCA5LCBjb250YWluaW5nIGFsbCBtYXRyaXggZWxlbWVudHMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBwYXJhbSBlbGVtZW50cyBBIHZlY3RvciBvZiBsZW5ndGggOSwgY29udGFpbmluZyBhbGwgbWF0cml4IGVsZW1lbnRzLgogICAgICovCiAgICBjb25zdHJ1Y3RvcihlbGVtZW50cykgewogICAgICBpZiAoZWxlbWVudHMgPT09IHZvaWQgMCkgewogICAgICAgIGVsZW1lbnRzID0gWzAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDBdOwogICAgICB9CgogICAgICB0aGlzLmVsZW1lbnRzID0gZWxlbWVudHM7CiAgICB9CiAgICAvKioKICAgICAqIFNldHMgdGhlIG1hdHJpeCB0byBpZGVudGl0eQogICAgICogQHRvZG8gU2hvdWxkIHBlcmhhcHMgYmUgcmVuYW1lZCB0byBgc2V0SWRlbnRpdHkoKWAgdG8gYmUgbW9yZSBjbGVhci4KICAgICAqIEB0b2RvIENyZWF0ZSBhbm90aGVyIGZ1bmN0aW9uIHRoYXQgaW1tZWRpYXRlbHkgY3JlYXRlcyBhbiBpZGVudGl0eSBtYXRyaXggZWcuIGBleWUoKWAKICAgICAqLwoKCiAgICBpZGVudGl0eSgpIHsKICAgICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHM7CiAgICAgIGVbMF0gPSAxOwogICAgICBlWzFdID0gMDsKICAgICAgZVsyXSA9IDA7CiAgICAgIGVbM10gPSAwOwogICAgICBlWzRdID0gMTsKICAgICAgZVs1XSA9IDA7CiAgICAgIGVbNl0gPSAwOwogICAgICBlWzddID0gMDsKICAgICAgZVs4XSA9IDE7CiAgICB9CiAgICAvKioKICAgICAqIFNldCBhbGwgZWxlbWVudHMgdG8gemVybwogICAgICovCgoKICAgIHNldFplcm8oKSB7CiAgICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgICBlWzBdID0gMDsKICAgICAgZVsxXSA9IDA7CiAgICAgIGVbMl0gPSAwOwogICAgICBlWzNdID0gMDsKICAgICAgZVs0XSA9IDA7CiAgICAgIGVbNV0gPSAwOwogICAgICBlWzZdID0gMDsKICAgICAgZVs3XSA9IDA7CiAgICAgIGVbOF0gPSAwOwogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBtYXRyaXggZGlhZ29uYWwgZWxlbWVudHMgZnJvbSBhIFZlYzMKICAgICAqLwoKCiAgICBzZXRUcmFjZSh2ZWN0b3IpIHsKICAgICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHM7CiAgICAgIGVbMF0gPSB2ZWN0b3IueDsKICAgICAgZVs0XSA9IHZlY3Rvci55OwogICAgICBlWzhdID0gdmVjdG9yLno7CiAgICB9CiAgICAvKioKICAgICAqIEdldHMgdGhlIG1hdHJpeCBkaWFnb25hbCBlbGVtZW50cwogICAgICovCgoKICAgIGdldFRyYWNlKHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50czsKICAgICAgdGFyZ2V0LnggPSBlWzBdOwogICAgICB0YXJnZXQueSA9IGVbNF07CiAgICAgIHRhcmdldC56ID0gZVs4XTsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogTWF0cml4LVZlY3RvciBtdWx0aXBsaWNhdGlvbgogICAgICogQHBhcmFtIHYgVGhlIHZlY3RvciB0byBtdWx0aXBseSB3aXRoCiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsLCB0YXJnZXQgdG8gc2F2ZSB0aGUgcmVzdWx0IGluLgogICAgICovCgoKICAgIHZtdWx0KHYsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50czsKICAgICAgY29uc3QgeCA9IHYueDsKICAgICAgY29uc3QgeSA9IHYueTsKICAgICAgY29uc3QgeiA9IHYuejsKICAgICAgdGFyZ2V0LnggPSBlWzBdICogeCArIGVbMV0gKiB5ICsgZVsyXSAqIHo7CiAgICAgIHRhcmdldC55ID0gZVszXSAqIHggKyBlWzRdICogeSArIGVbNV0gKiB6OwogICAgICB0YXJnZXQueiA9IGVbNl0gKiB4ICsgZVs3XSAqIHkgKyBlWzhdICogejsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogTWF0cml4LXNjYWxhciBtdWx0aXBsaWNhdGlvbgogICAgICovCgoKICAgIHNtdWx0KHMpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5lbGVtZW50c1tpXSAqPSBzOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIE1hdHJpeCBtdWx0aXBsaWNhdGlvbgogICAgICogQHBhcmFtIG1hdHJpeCBNYXRyaXggdG8gbXVsdGlwbHkgd2l0aCBmcm9tIGxlZnQgc2lkZS4KICAgICAqLwoKCiAgICBtbXVsdChtYXRyaXgsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgTWF0MygpOwogICAgICB9CgogICAgICBjb25zdCBBID0gdGhpcy5lbGVtZW50czsKICAgICAgY29uc3QgQiA9IG1hdHJpeC5lbGVtZW50czsKICAgICAgY29uc3QgVCA9IHRhcmdldC5lbGVtZW50czsKICAgICAgY29uc3QgYTExID0gQVswXSwKICAgICAgICAgICAgYTEyID0gQVsxXSwKICAgICAgICAgICAgYTEzID0gQVsyXSwKICAgICAgICAgICAgYTIxID0gQVszXSwKICAgICAgICAgICAgYTIyID0gQVs0XSwKICAgICAgICAgICAgYTIzID0gQVs1XSwKICAgICAgICAgICAgYTMxID0gQVs2XSwKICAgICAgICAgICAgYTMyID0gQVs3XSwKICAgICAgICAgICAgYTMzID0gQVs4XTsKICAgICAgY29uc3QgYjExID0gQlswXSwKICAgICAgICAgICAgYjEyID0gQlsxXSwKICAgICAgICAgICAgYjEzID0gQlsyXSwKICAgICAgICAgICAgYjIxID0gQlszXSwKICAgICAgICAgICAgYjIyID0gQls0XSwKICAgICAgICAgICAgYjIzID0gQls1XSwKICAgICAgICAgICAgYjMxID0gQls2XSwKICAgICAgICAgICAgYjMyID0gQls3XSwKICAgICAgICAgICAgYjMzID0gQls4XTsKICAgICAgVFswXSA9IGExMSAqIGIxMSArIGExMiAqIGIyMSArIGExMyAqIGIzMTsKICAgICAgVFsxXSA9IGExMSAqIGIxMiArIGExMiAqIGIyMiArIGExMyAqIGIzMjsKICAgICAgVFsyXSA9IGExMSAqIGIxMyArIGExMiAqIGIyMyArIGExMyAqIGIzMzsKICAgICAgVFszXSA9IGEyMSAqIGIxMSArIGEyMiAqIGIyMSArIGEyMyAqIGIzMTsKICAgICAgVFs0XSA9IGEyMSAqIGIxMiArIGEyMiAqIGIyMiArIGEyMyAqIGIzMjsKICAgICAgVFs1XSA9IGEyMSAqIGIxMyArIGEyMiAqIGIyMyArIGEyMyAqIGIzMzsKICAgICAgVFs2XSA9IGEzMSAqIGIxMSArIGEzMiAqIGIyMSArIGEzMyAqIGIzMTsKICAgICAgVFs3XSA9IGEzMSAqIGIxMiArIGEzMiAqIGIyMiArIGEzMyAqIGIzMjsKICAgICAgVFs4XSA9IGEzMSAqIGIxMyArIGEzMiAqIGIyMyArIGEzMyAqIGIzMzsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogU2NhbGUgZWFjaCBjb2x1bW4gb2YgdGhlIG1hdHJpeAogICAgICovCgoKICAgIHNjYWxlKHZlY3RvciwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBNYXQzKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgICBjb25zdCB0ID0gdGFyZ2V0LmVsZW1lbnRzOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IDM7IGkrKykgewogICAgICAgIHRbMyAqIGkgKyAwXSA9IHZlY3Rvci54ICogZVszICogaSArIDBdOwogICAgICAgIHRbMyAqIGkgKyAxXSA9IHZlY3Rvci55ICogZVszICogaSArIDFdOwogICAgICAgIHRbMyAqIGkgKyAyXSA9IHZlY3Rvci56ICogZVszICogaSArIDJdOwogICAgICB9CgogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBTb2x2ZSBBeD1iCiAgICAgKiBAcGFyYW0gYiBUaGUgcmlnaHQgaGFuZCBzaWRlCiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsLiBUYXJnZXQgdmVjdG9yIHRvIHNhdmUgaW4uCiAgICAgKiBAcmV0dXJuIFRoZSBzb2x1dGlvbiB4CiAgICAgKiBAdG9kbyBzaG91bGQgcmV1c2UgYXJyYXlzCiAgICAgKi8KCgogICAgc29sdmUoYiwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIC8vIENvbnN0cnVjdCBlcXVhdGlvbnMKICAgICAgY29uc3QgbnIgPSAzOyAvLyBudW0gcm93cwoKICAgICAgY29uc3QgbmMgPSA0OyAvLyBudW0gY29scwoKICAgICAgY29uc3QgZXFucyA9IFtdOwogICAgICBsZXQgaTsKICAgICAgbGV0IGo7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgbnIgKiBuYzsgaSsrKSB7CiAgICAgICAgZXFucy5wdXNoKDApOwogICAgICB9CgogICAgICBmb3IgKGkgPSAwOyBpIDwgMzsgaSsrKSB7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IDM7IGorKykgewogICAgICAgICAgZXFuc1tpICsgbmMgKiBqXSA9IHRoaXMuZWxlbWVudHNbaSArIDMgKiBqXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGVxbnNbMyArIDQgKiAwXSA9IGIueDsKICAgICAgZXFuc1szICsgNCAqIDFdID0gYi55OwogICAgICBlcW5zWzMgKyA0ICogMl0gPSBiLno7IC8vIENvbXB1dGUgcmlnaHQgdXBwZXIgdHJpYW5ndWxhciB2ZXJzaW9uIG9mIHRoZSBtYXRyaXggLSBHYXVzcyBlbGltaW5hdGlvbgoKICAgICAgbGV0IG4gPSAzOwogICAgICBjb25zdCBrID0gbjsKICAgICAgbGV0IG5wOwogICAgICBjb25zdCBrcCA9IDQ7IC8vIG51bSByb3dzCgogICAgICBsZXQgcDsKCiAgICAgIGRvIHsKICAgICAgICBpID0gayAtIG47CgogICAgICAgIGlmIChlcW5zW2kgKyBuYyAqIGldID09PSAwKSB7CiAgICAgICAgICAvLyB0aGUgcGl2b3QgaXMgbnVsbCwgc3dhcCBsaW5lcwogICAgICAgICAgZm9yIChqID0gaSArIDE7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgaWYgKGVxbnNbaSArIG5jICogal0gIT09IDApIHsKICAgICAgICAgICAgICBucCA9IGtwOwoKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAvLyBkbyBsaWduZSggaSApID0gbGlnbmUoIGkgKSArIGxpZ25lKCBrICkKICAgICAgICAgICAgICAgIHAgPSBrcCAtIG5wOwogICAgICAgICAgICAgICAgZXFuc1twICsgbmMgKiBpXSArPSBlcW5zW3AgKyBuYyAqIGpdOwogICAgICAgICAgICAgIH0gd2hpbGUgKC0tbnApOwoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGVxbnNbaSArIG5jICogaV0gIT09IDApIHsKICAgICAgICAgIGZvciAoaiA9IGkgKyAxOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgIGNvbnN0IG11bHRpcGxpZXIgPSBlcW5zW2kgKyBuYyAqIGpdIC8gZXFuc1tpICsgbmMgKiBpXTsKICAgICAgICAgICAgbnAgPSBrcDsKCiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAvLyBkbyBsaWduZSggayApID0gbGlnbmUoIGsgKSAtIG11bHRpcGxpZXIgKiBsaWduZSggaSApCiAgICAgICAgICAgICAgcCA9IGtwIC0gbnA7CiAgICAgICAgICAgICAgZXFuc1twICsgbmMgKiBqXSA9IHAgPD0gaSA/IDAgOiBlcW5zW3AgKyBuYyAqIGpdIC0gZXFuc1twICsgbmMgKiBpXSAqIG11bHRpcGxpZXI7CiAgICAgICAgICAgIH0gd2hpbGUgKC0tbnApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSB3aGlsZSAoLS1uKTsgLy8gR2V0IHRoZSBzb2x1dGlvbgoKCiAgICAgIHRhcmdldC56ID0gZXFuc1syICogbmMgKyAzXSAvIGVxbnNbMiAqIG5jICsgMl07CiAgICAgIHRhcmdldC55ID0gKGVxbnNbMSAqIG5jICsgM10gLSBlcW5zWzEgKiBuYyArIDJdICogdGFyZ2V0LnopIC8gZXFuc1sxICogbmMgKyAxXTsKICAgICAgdGFyZ2V0LnggPSAoZXFuc1swICogbmMgKyAzXSAtIGVxbnNbMCAqIG5jICsgMl0gKiB0YXJnZXQueiAtIGVxbnNbMCAqIG5jICsgMV0gKiB0YXJnZXQueSkgLyBlcW5zWzAgKiBuYyArIDBdOwoKICAgICAgaWYgKGlzTmFOKHRhcmdldC54KSB8fCBpc05hTih0YXJnZXQueSkgfHwgaXNOYU4odGFyZ2V0LnopIHx8IHRhcmdldC54ID09PSBJbmZpbml0eSB8fCB0YXJnZXQueSA9PT0gSW5maW5pdHkgfHwgdGFyZ2V0LnogPT09IEluZmluaXR5KSB7CiAgICAgICAgdGhyb3cgYENvdWxkIG5vdCBzb2x2ZSBlcXVhdGlvbiEgR290IHg9WyR7dGFyZ2V0LnRvU3RyaW5nKCl9XSwgYj1bJHtiLnRvU3RyaW5nKCl9XSwgQT1bJHt0aGlzLnRvU3RyaW5nKCl9XWA7CiAgICAgIH0KCiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbiBlbGVtZW50IGluIHRoZSBtYXRyaXggYnkgaW5kZXguIEluZGV4IHN0YXJ0cyBhdCAwLCBub3QgMSEhIQogICAgICogQHBhcmFtIHZhbHVlIElmIHByb3ZpZGVkLCB0aGUgbWF0cml4IGVsZW1lbnQgd2lsbCBiZSBzZXQgdG8gdGhpcyB2YWx1ZS4KICAgICAqLwoKCiAgICBlKHJvdywgY29sdW1uLCB2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB0aGlzLmVsZW1lbnRzW2NvbHVtbiArIDMgKiByb3ddOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNldCB2YWx1ZQogICAgICAgIHRoaXMuZWxlbWVudHNbY29sdW1uICsgMyAqIHJvd10gPSB2YWx1ZTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDb3B5IGFub3RoZXIgbWF0cml4IGludG8gdGhpcyBtYXRyaXggb2JqZWN0LgogICAgICovCgoKICAgIGNvcHkobWF0cml4KSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWF0cml4LmVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5lbGVtZW50c1tpXSA9IG1hdHJpeC5lbGVtZW50c1tpXTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIG1hdHJpeC4KICAgICAqLwoKCiAgICB0b1N0cmluZygpIHsKICAgICAgbGV0IHIgPSAnJzsKICAgICAgY29uc3Qgc2VwID0gJywnOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA5OyBpKyspIHsKICAgICAgICByICs9IHRoaXMuZWxlbWVudHNbaV0gKyBzZXA7CiAgICAgIH0KCiAgICAgIHJldHVybiByOwogICAgfQogICAgLyoqCiAgICAgKiByZXZlcnNlIHRoZSBtYXRyaXgKICAgICAqIEBwYXJhbSB0YXJnZXQgVGFyZ2V0IG1hdHJpeCB0byBzYXZlIGluLgogICAgICogQHJldHVybiBUaGUgc29sdXRpb24geAogICAgICovCgoKICAgIHJldmVyc2UodGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBNYXQzKCk7CiAgICAgIH0KCiAgICAgIC8vIENvbnN0cnVjdCBlcXVhdGlvbnMKICAgICAgY29uc3QgbnIgPSAzOyAvLyBudW0gcm93cwoKICAgICAgY29uc3QgbmMgPSA2OyAvLyBudW0gY29scwoKICAgICAgY29uc3QgZXFucyA9IHJldmVyc2VfZXFuczsKICAgICAgbGV0IGk7CiAgICAgIGxldCBqOwoKICAgICAgZm9yIChpID0gMDsgaSA8IDM7IGkrKykgewogICAgICAgIGZvciAoaiA9IDA7IGogPCAzOyBqKyspIHsKICAgICAgICAgIGVxbnNbaSArIG5jICogal0gPSB0aGlzLmVsZW1lbnRzW2kgKyAzICogal07CiAgICAgICAgfQogICAgICB9CgogICAgICBlcW5zWzMgKyA2ICogMF0gPSAxOwogICAgICBlcW5zWzMgKyA2ICogMV0gPSAwOwogICAgICBlcW5zWzMgKyA2ICogMl0gPSAwOwogICAgICBlcW5zWzQgKyA2ICogMF0gPSAwOwogICAgICBlcW5zWzQgKyA2ICogMV0gPSAxOwogICAgICBlcW5zWzQgKyA2ICogMl0gPSAwOwogICAgICBlcW5zWzUgKyA2ICogMF0gPSAwOwogICAgICBlcW5zWzUgKyA2ICogMV0gPSAwOwogICAgICBlcW5zWzUgKyA2ICogMl0gPSAxOyAvLyBDb21wdXRlIHJpZ2h0IHVwcGVyIHRyaWFuZ3VsYXIgdmVyc2lvbiBvZiB0aGUgbWF0cml4IC0gR2F1c3MgZWxpbWluYXRpb24KCiAgICAgIGxldCBuID0gMzsKICAgICAgY29uc3QgayA9IG47CiAgICAgIGxldCBucDsKICAgICAgY29uc3Qga3AgPSBuYzsgLy8gbnVtIHJvd3MKCiAgICAgIGxldCBwOwoKICAgICAgZG8gewogICAgICAgIGkgPSBrIC0gbjsKCiAgICAgICAgaWYgKGVxbnNbaSArIG5jICogaV0gPT09IDApIHsKICAgICAgICAgIC8vIHRoZSBwaXZvdCBpcyBudWxsLCBzd2FwIGxpbmVzCiAgICAgICAgICBmb3IgKGogPSBpICsgMTsgaiA8IGs7IGorKykgewogICAgICAgICAgICBpZiAoZXFuc1tpICsgbmMgKiBqXSAhPT0gMCkgewogICAgICAgICAgICAgIG5wID0ga3A7CgogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIC8vIGRvIGxpbmUoIGkgKSA9IGxpbmUoIGkgKSArIGxpbmUoIGsgKQogICAgICAgICAgICAgICAgcCA9IGtwIC0gbnA7CiAgICAgICAgICAgICAgICBlcW5zW3AgKyBuYyAqIGldICs9IGVxbnNbcCArIG5jICogal07CiAgICAgICAgICAgICAgfSB3aGlsZSAoLS1ucCk7CgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZXFuc1tpICsgbmMgKiBpXSAhPT0gMCkgewogICAgICAgICAgZm9yIChqID0gaSArIDE7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IGVxbnNbaSArIG5jICogal0gLyBlcW5zW2kgKyBuYyAqIGldOwogICAgICAgICAgICBucCA9IGtwOwoKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIC8vIGRvIGxpbmUoIGsgKSA9IGxpbmUoIGsgKSAtIG11bHRpcGxpZXIgKiBsaW5lKCBpICkKICAgICAgICAgICAgICBwID0ga3AgLSBucDsKICAgICAgICAgICAgICBlcW5zW3AgKyBuYyAqIGpdID0gcCA8PSBpID8gMCA6IGVxbnNbcCArIG5jICogal0gLSBlcW5zW3AgKyBuYyAqIGldICogbXVsdGlwbGllcjsKICAgICAgICAgICAgfSB3aGlsZSAoLS1ucCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IHdoaWxlICgtLW4pOyAvLyBlbGltaW5hdGUgdGhlIHVwcGVyIGxlZnQgdHJpYW5nbGUgb2YgdGhlIG1hdHJpeAoKCiAgICAgIGkgPSAyOwoKICAgICAgZG8gewogICAgICAgIGogPSBpIC0gMTsKCiAgICAgICAgZG8gewogICAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IGVxbnNbaSArIG5jICogal0gLyBlcW5zW2kgKyBuYyAqIGldOwogICAgICAgICAgbnAgPSBuYzsKCiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHAgPSBuYyAtIG5wOwogICAgICAgICAgICBlcW5zW3AgKyBuYyAqIGpdID0gZXFuc1twICsgbmMgKiBqXSAtIGVxbnNbcCArIG5jICogaV0gKiBtdWx0aXBsaWVyOwogICAgICAgICAgfSB3aGlsZSAoLS1ucCk7CiAgICAgICAgfSB3aGlsZSAoai0tKTsKICAgICAgfSB3aGlsZSAoLS1pKTsgLy8gb3BlcmF0aW9ucyBvbiB0aGUgZGlhZ29uYWwKCgogICAgICBpID0gMjsKCiAgICAgIGRvIHsKICAgICAgICBjb25zdCBtdWx0aXBsaWVyID0gMSAvIGVxbnNbaSArIG5jICogaV07CiAgICAgICAgbnAgPSBuYzsKCiAgICAgICAgZG8gewogICAgICAgICAgcCA9IG5jIC0gbnA7CiAgICAgICAgICBlcW5zW3AgKyBuYyAqIGldID0gZXFuc1twICsgbmMgKiBpXSAqIG11bHRpcGxpZXI7CiAgICAgICAgfSB3aGlsZSAoLS1ucCk7CiAgICAgIH0gd2hpbGUgKGktLSk7CgogICAgICBpID0gMjsKCiAgICAgIGRvIHsKICAgICAgICBqID0gMjsKCiAgICAgICAgZG8gewogICAgICAgICAgcCA9IGVxbnNbbnIgKyBqICsgbmMgKiBpXTsKCiAgICAgICAgICBpZiAoaXNOYU4ocCkgfHwgcCA9PT0gSW5maW5pdHkpIHsKICAgICAgICAgICAgdGhyb3cgYENvdWxkIG5vdCByZXZlcnNlISBBPVske3RoaXMudG9TdHJpbmcoKX1dYDsKICAgICAgICAgIH0KCiAgICAgICAgICB0YXJnZXQuZShpLCBqLCBwKTsKICAgICAgICB9IHdoaWxlIChqLS0pOwogICAgICB9IHdoaWxlIChpLS0pOwoKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBtYXRyaXggZnJvbSBhIHF1YXRlcmlvbgogICAgICovCgoKICAgIHNldFJvdGF0aW9uRnJvbVF1YXRlcm5pb24ocSkgewogICAgICBjb25zdCB4ID0gcS54OwogICAgICBjb25zdCB5ID0gcS55OwogICAgICBjb25zdCB6ID0gcS56OwogICAgICBjb25zdCB3ID0gcS53OwogICAgICBjb25zdCB4MiA9IHggKyB4OwogICAgICBjb25zdCB5MiA9IHkgKyB5OwogICAgICBjb25zdCB6MiA9IHogKyB6OwogICAgICBjb25zdCB4eCA9IHggKiB4MjsKICAgICAgY29uc3QgeHkgPSB4ICogeTI7CiAgICAgIGNvbnN0IHh6ID0geCAqIHoyOwogICAgICBjb25zdCB5eSA9IHkgKiB5MjsKICAgICAgY29uc3QgeXogPSB5ICogejI7CiAgICAgIGNvbnN0IHp6ID0geiAqIHoyOwogICAgICBjb25zdCB3eCA9IHcgKiB4MjsKICAgICAgY29uc3Qgd3kgPSB3ICogeTI7CiAgICAgIGNvbnN0IHd6ID0gdyAqIHoyOwogICAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50czsKICAgICAgZVszICogMCArIDBdID0gMSAtICh5eSArIHp6KTsKICAgICAgZVszICogMCArIDFdID0geHkgLSB3ejsKICAgICAgZVszICogMCArIDJdID0geHogKyB3eTsKICAgICAgZVszICogMSArIDBdID0geHkgKyB3ejsKICAgICAgZVszICogMSArIDFdID0gMSAtICh4eCArIHp6KTsKICAgICAgZVszICogMSArIDJdID0geXogLSB3eDsKICAgICAgZVszICogMiArIDBdID0geHogLSB3eTsKICAgICAgZVszICogMiArIDFdID0geXogKyB3eDsKICAgICAgZVszICogMiArIDJdID0gMSAtICh4eCArIHl5KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIFRyYW5zcG9zZSB0aGUgbWF0cml4CiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsLiBXaGVyZSB0byBzdG9yZSB0aGUgcmVzdWx0LgogICAgICogQHJldHVybiBUaGUgdGFyZ2V0IE1hdDMsIG9yIGEgbmV3IE1hdDMgaWYgdGFyZ2V0IHdhcyBvbWl0dGVkLgogICAgICovCgoKICAgIHRyYW5zcG9zZSh0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IE1hdDMoKTsKICAgICAgfQoKICAgICAgY29uc3QgTSA9IHRoaXMuZWxlbWVudHM7CiAgICAgIGNvbnN0IFQgPSB0YXJnZXQuZWxlbWVudHM7CiAgICAgIGxldCB0bXA7IC8vU2V0IGRpYWdvbmFscwoKICAgICAgVFswXSA9IE1bMF07CiAgICAgIFRbNF0gPSBNWzRdOwogICAgICBUWzhdID0gTVs4XTsKICAgICAgdG1wID0gTVsxXTsKICAgICAgVFsxXSA9IE1bM107CiAgICAgIFRbM10gPSB0bXA7CiAgICAgIHRtcCA9IE1bMl07CiAgICAgIFRbMl0gPSBNWzZdOwogICAgICBUWzZdID0gdG1wOwogICAgICB0bXAgPSBNWzVdOwogICAgICBUWzVdID0gTVs3XTsKICAgICAgVFs3XSA9IHRtcDsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KCiAgfQogIGNvbnN0IHJldmVyc2VfZXFucyA9IFswLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwXTsKCiAgLyoqCiAgICogMy1kaW1lbnNpb25hbCB2ZWN0b3IKICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCB2ID0gbmV3IFZlYzMoMSwgMiwgMykKICAgKiAgICAgY29uc29sZS5sb2coJ3g9JyArIHYueCkgLy8geD0xCiAgICovCgogIGNsYXNzIFZlYzMgewogICAgY29uc3RydWN0b3IoeCwgeSwgeikgewogICAgICBpZiAoeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgeCA9IDAuMDsKICAgICAgfQoKICAgICAgaWYgKHkgPT09IHZvaWQgMCkgewogICAgICAgIHkgPSAwLjA7CiAgICAgIH0KCiAgICAgIGlmICh6ID09PSB2b2lkIDApIHsKICAgICAgICB6ID0gMC4wOwogICAgICB9CgogICAgICB0aGlzLnggPSB4OwogICAgICB0aGlzLnkgPSB5OwogICAgICB0aGlzLnogPSB6OwogICAgfQogICAgLyoqCiAgICAgKiBWZWN0b3IgY3Jvc3MgcHJvZHVjdAogICAgICogQHBhcmFtIHRhcmdldCBPcHRpb25hbCB0YXJnZXQgdG8gc2F2ZSBpbi4KICAgICAqLwoKCiAgICBjcm9zcyh2ZWN0b3IsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCB2eCA9IHZlY3Rvci54OwogICAgICBjb25zdCB2eSA9IHZlY3Rvci55OwogICAgICBjb25zdCB2eiA9IHZlY3Rvci56OwogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICB0YXJnZXQueCA9IHkgKiB2eiAtIHogKiB2eTsKICAgICAgdGFyZ2V0LnkgPSB6ICogdnggLSB4ICogdno7CiAgICAgIHRhcmdldC56ID0geCAqIHZ5IC0geSAqIHZ4OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHZlY3RvcnMnIDMgZWxlbWVudHMKICAgICAqLwoKCiAgICBzZXQoeCwgeSwgeikgewogICAgICB0aGlzLnggPSB4OwogICAgICB0aGlzLnkgPSB5OwogICAgICB0aGlzLnogPSB6OwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogU2V0IGFsbCBjb21wb25lbnRzIG9mIHRoZSB2ZWN0b3IgdG8gemVyby4KICAgICAqLwoKCiAgICBzZXRaZXJvKCkgewogICAgICB0aGlzLnggPSB0aGlzLnkgPSB0aGlzLnogPSAwOwogICAgfQogICAgLyoqCiAgICAgKiBWZWN0b3IgYWRkaXRpb24KICAgICAqLwoKCiAgICB2YWRkKHZlY3RvciwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICB0YXJnZXQueCA9IHZlY3Rvci54ICsgdGhpcy54OwogICAgICAgIHRhcmdldC55ID0gdmVjdG9yLnkgKyB0aGlzLnk7CiAgICAgICAgdGFyZ2V0LnogPSB2ZWN0b3IueiArIHRoaXMuejsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IFZlYzModGhpcy54ICsgdmVjdG9yLngsIHRoaXMueSArIHZlY3Rvci55LCB0aGlzLnogKyB2ZWN0b3Iueik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogVmVjdG9yIHN1YnRyYWN0aW9uCiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsIHRhcmdldCB0byBzYXZlIGluLgogICAgICovCgoKICAgIHZzdWIodmVjdG9yLCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCkgewogICAgICAgIHRhcmdldC54ID0gdGhpcy54IC0gdmVjdG9yLng7CiAgICAgICAgdGFyZ2V0LnkgPSB0aGlzLnkgLSB2ZWN0b3IueTsKICAgICAgICB0YXJnZXQueiA9IHRoaXMueiAtIHZlY3Rvci56OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgVmVjMyh0aGlzLnggLSB2ZWN0b3IueCwgdGhpcy55IC0gdmVjdG9yLnksIHRoaXMueiAtIHZlY3Rvci56KTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIGNyb3NzIHByb2R1Y3QgbWF0cml4IGFfY3Jvc3MgZnJvbSBhIHZlY3Rvciwgc3VjaCB0aGF0IGEgeCBiID0gYV9jcm9zcyAqIGIgPSBjCiAgICAgKgogICAgICogU2VlIHtAbGluayBodHRwczovL3d3dzguY3MudW11LnNlL2t1cnNlci9UREJEMjQvVlQwNi9sZWN0dXJlcy9MZWN0dXJlNi5wZGYgVW1lw6UgVW5pdmVyc2l0eSBMZWN0dXJlfQogICAgICovCgoKICAgIGNyb3NzbWF0KCkgewogICAgICByZXR1cm4gbmV3IE1hdDMoWzAsIC10aGlzLnosIHRoaXMueSwgdGhpcy56LCAwLCAtdGhpcy54LCAtdGhpcy55LCB0aGlzLngsIDBdKTsKICAgIH0KICAgIC8qKgogICAgICogTm9ybWFsaXplIHRoZSB2ZWN0b3IuIE5vdGUgdGhhdCB0aGlzIGNoYW5nZXMgdGhlIHZhbHVlcyBpbiB0aGUgdmVjdG9yLgogICAgICAqIEByZXR1cm4gUmV0dXJucyB0aGUgbm9ybSBvZiB0aGUgdmVjdG9yCiAgICAgKi8KCgogICAgbm9ybWFsaXplKCkgewogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICBjb25zdCBuID0gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CgogICAgICBpZiAobiA+IDAuMCkgewogICAgICAgIGNvbnN0IGludk4gPSAxIC8gbjsKICAgICAgICB0aGlzLnggKj0gaW52TjsKICAgICAgICB0aGlzLnkgKj0gaW52TjsKICAgICAgICB0aGlzLnogKj0gaW52TjsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBNYWtlIHNvbWV0aGluZyB1cAogICAgICAgIHRoaXMueCA9IDA7CiAgICAgICAgdGhpcy55ID0gMDsKICAgICAgICB0aGlzLnogPSAwOwogICAgICB9CgogICAgICByZXR1cm4gbjsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSB2ZXJzaW9uIG9mIHRoaXMgdmVjdG9yIHRoYXQgaXMgb2YgbGVuZ3RoIDEuCiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsIHRhcmdldCB0byBzYXZlIGluCiAgICAgKiBAcmV0dXJuIFJldHVybnMgdGhlIHVuaXQgdmVjdG9yCiAgICAgKi8KCgogICAgdW5pdCh0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgY29uc3QgeCA9IHRoaXMueDsKICAgICAgY29uc3QgeSA9IHRoaXMueTsKICAgICAgY29uc3QgeiA9IHRoaXMuejsKICAgICAgbGV0IG5pbnYgPSBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSArIHogKiB6KTsKCiAgICAgIGlmIChuaW52ID4gMC4wKSB7CiAgICAgICAgbmludiA9IDEuMCAvIG5pbnY7CiAgICAgICAgdGFyZ2V0LnggPSB4ICogbmludjsKICAgICAgICB0YXJnZXQueSA9IHkgKiBuaW52OwogICAgICAgIHRhcmdldC56ID0geiAqIG5pbnY7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0LnggPSAxOwogICAgICAgIHRhcmdldC55ID0gMDsKICAgICAgICB0YXJnZXQueiA9IDA7CiAgICAgIH0KCiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgbGVuZ3RoIG9mIHRoZSB2ZWN0b3IKICAgICAqLwoKCiAgICBsZW5ndGgoKSB7CiAgICAgIGNvbnN0IHggPSB0aGlzLng7CiAgICAgIGNvbnN0IHkgPSB0aGlzLnk7CiAgICAgIGNvbnN0IHogPSB0aGlzLno7CiAgICAgIHJldHVybiBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSArIHogKiB6KTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBzcXVhcmVkIGxlbmd0aCBvZiB0aGUgdmVjdG9yLgogICAgICovCgoKICAgIGxlbmd0aFNxdWFyZWQoKSB7CiAgICAgIHJldHVybiB0aGlzLmRvdCh0aGlzKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGRpc3RhbmNlIGZyb20gdGhpcyBwb2ludCB0byBhbm90aGVyIHBvaW50CiAgICAgKi8KCgogICAgZGlzdGFuY2VUbyhwKSB7CiAgICAgIGNvbnN0IHggPSB0aGlzLng7CiAgICAgIGNvbnN0IHkgPSB0aGlzLnk7CiAgICAgIGNvbnN0IHogPSB0aGlzLno7CiAgICAgIGNvbnN0IHB4ID0gcC54OwogICAgICBjb25zdCBweSA9IHAueTsKICAgICAgY29uc3QgcHogPSBwLno7CiAgICAgIHJldHVybiBNYXRoLnNxcnQoKHB4IC0geCkgKiAocHggLSB4KSArIChweSAtIHkpICogKHB5IC0geSkgKyAocHogLSB6KSAqIChweiAtIHopKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHNxdWFyZWQgZGlzdGFuY2UgZnJvbSB0aGlzIHBvaW50IHRvIGFub3RoZXIgcG9pbnQKICAgICAqLwoKCiAgICBkaXN0YW5jZVNxdWFyZWQocCkgewogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICBjb25zdCBweCA9IHAueDsKICAgICAgY29uc3QgcHkgPSBwLnk7CiAgICAgIGNvbnN0IHB6ID0gcC56OwogICAgICByZXR1cm4gKHB4IC0geCkgKiAocHggLSB4KSArIChweSAtIHkpICogKHB5IC0geSkgKyAocHogLSB6KSAqIChweiAtIHopOwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSBhbGwgdGhlIGNvbXBvbmVudHMgb2YgdGhlIHZlY3RvciB3aXRoIGEgc2NhbGFyLgogICAgICogQHBhcmFtIHRhcmdldCBUaGUgdmVjdG9yIHRvIHNhdmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBzY2FsZShzY2FsYXIsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICB0YXJnZXQueCA9IHNjYWxhciAqIHg7CiAgICAgIHRhcmdldC55ID0gc2NhbGFyICogeTsKICAgICAgdGFyZ2V0LnogPSBzY2FsYXIgKiB6OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSB0aGUgdmVjdG9yIHdpdGggYW4gb3RoZXIgdmVjdG9yLCBjb21wb25lbnQtd2lzZS4KICAgICAqIEBwYXJhbSB0YXJnZXQgVGhlIHZlY3RvciB0byBzYXZlIHRoZSByZXN1bHQgaW4uCiAgICAgKi8KCgogICAgdm11bCh2ZWN0b3IsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0YXJnZXQueCA9IHZlY3Rvci54ICogdGhpcy54OwogICAgICB0YXJnZXQueSA9IHZlY3Rvci55ICogdGhpcy55OwogICAgICB0YXJnZXQueiA9IHZlY3Rvci56ICogdGhpcy56OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBTY2FsZSBhIHZlY3RvciBhbmQgYWRkIGl0IHRvIHRoaXMgdmVjdG9yLiBTYXZlIHRoZSByZXN1bHQgaW4gInRhcmdldCIuICh0YXJnZXQgPSB0aGlzICsgdmVjdG9yICogc2NhbGFyKQogICAgICogQHBhcmFtIHRhcmdldCBUaGUgdmVjdG9yIHRvIHNhdmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBhZGRTY2FsZWRWZWN0b3Ioc2NhbGFyLCB2ZWN0b3IsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0YXJnZXQueCA9IHRoaXMueCArIHNjYWxhciAqIHZlY3Rvci54OwogICAgICB0YXJnZXQueSA9IHRoaXMueSArIHNjYWxhciAqIHZlY3Rvci55OwogICAgICB0YXJnZXQueiA9IHRoaXMueiArIHNjYWxhciAqIHZlY3Rvci56OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBDYWxjdWxhdGUgZG90IHByb2R1Y3QKICAgICAqIEBwYXJhbSB2ZWN0b3IKICAgICAqLwoKCiAgICBkb3QodmVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLnggKiB2ZWN0b3IueCArIHRoaXMueSAqIHZlY3Rvci55ICsgdGhpcy56ICogdmVjdG9yLno7CiAgICB9CgogICAgaXNaZXJvKCkgewogICAgICByZXR1cm4gdGhpcy54ID09PSAwICYmIHRoaXMueSA9PT0gMCAmJiB0aGlzLnogPT09IDA7CiAgICB9CiAgICAvKioKICAgICAqIE1ha2UgdGhlIHZlY3RvciBwb2ludCBpbiB0aGUgb3Bwb3NpdGUgZGlyZWN0aW9uLgogICAgICogQHBhcmFtIHRhcmdldCBPcHRpb25hbCB0YXJnZXQgdG8gc2F2ZSBpbgogICAgICovCgoKICAgIG5lZ2F0ZSh0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgdGFyZ2V0LnggPSAtdGhpcy54OwogICAgICB0YXJnZXQueSA9IC10aGlzLnk7CiAgICAgIHRhcmdldC56ID0gLXRoaXMuejsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZSB0d28gYXJ0aWZpY2lhbCB0YW5nZW50cyB0byB0aGUgdmVjdG9yCiAgICAgKiBAcGFyYW0gdDEgVmVjdG9yIG9iamVjdCB0byBzYXZlIHRoZSBmaXJzdCB0YW5nZW50IGluCiAgICAgKiBAcGFyYW0gdDIgVmVjdG9yIG9iamVjdCB0byBzYXZlIHRoZSBzZWNvbmQgdGFuZ2VudCBpbgogICAgICovCgoKICAgIHRhbmdlbnRzKHQxLCB0MikgewogICAgICBjb25zdCBub3JtID0gdGhpcy5sZW5ndGgoKTsKCiAgICAgIGlmIChub3JtID4gMC4wKSB7CiAgICAgICAgY29uc3QgbiA9IFZlYzNfdGFuZ2VudHNfbjsKICAgICAgICBjb25zdCBpbm9ybSA9IDEgLyBub3JtOwogICAgICAgIG4uc2V0KHRoaXMueCAqIGlub3JtLCB0aGlzLnkgKiBpbm9ybSwgdGhpcy56ICogaW5vcm0pOwogICAgICAgIGNvbnN0IHJhbmRWZWMgPSBWZWMzX3RhbmdlbnRzX3JhbmRWZWM7CgogICAgICAgIGlmIChNYXRoLmFicyhuLngpIDwgMC45KSB7CiAgICAgICAgICByYW5kVmVjLnNldCgxLCAwLCAwKTsKICAgICAgICAgIG4uY3Jvc3MocmFuZFZlYywgdDEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByYW5kVmVjLnNldCgwLCAxLCAwKTsKICAgICAgICAgIG4uY3Jvc3MocmFuZFZlYywgdDEpOwogICAgICAgIH0KCiAgICAgICAgbi5jcm9zcyh0MSwgdDIpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFRoZSBub3JtYWwgbGVuZ3RoIGlzIHplcm8sIG1ha2Ugc29tZXRoaW5nIHVwCiAgICAgICAgdDEuc2V0KDEsIDAsIDApOwogICAgICAgIHQyLnNldCgwLCAxLCAwKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0byBhIG1vcmUgcmVhZGFibGUgZm9ybWF0CiAgICAgKi8KCgogICAgdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiBgJHt0aGlzLnh9LCR7dGhpcy55fSwke3RoaXMuen1gOwogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0byBhbiBhcnJheQogICAgICovCgoKICAgIHRvQXJyYXkoKSB7CiAgICAgIHJldHVybiBbdGhpcy54LCB0aGlzLnksIHRoaXMuel07CiAgICB9CiAgICAvKioKICAgICAqIENvcGllcyB2YWx1ZSBvZiBzb3VyY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICAgKi8KCgogICAgY29weSh2ZWN0b3IpIHsKICAgICAgdGhpcy54ID0gdmVjdG9yLng7CiAgICAgIHRoaXMueSA9IHZlY3Rvci55OwogICAgICB0aGlzLnogPSB2ZWN0b3IuejsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIERvIGEgbGluZWFyIGludGVycG9sYXRpb24gYmV0d2VlbiB0d28gdmVjdG9ycwogICAgICogQHBhcmFtIHQgQSBudW1iZXIgYmV0d2VlbiAwIGFuZCAxLiAwIHdpbGwgbWFrZSB0aGlzIGZ1bmN0aW9uIHJldHVybiB1LCBhbmQgMSB3aWxsIG1ha2UgaXQgcmV0dXJuIHYuIE51bWJlcnMgaW4gYmV0d2VlbiB3aWxsIGdlbmVyYXRlIGEgdmVjdG9yIGluIGJldHdlZW4gdGhlbS4KICAgICAqLwoKCiAgICBsZXJwKHZlY3RvciwgdCwgdGFyZ2V0KSB7CiAgICAgIGNvbnN0IHggPSB0aGlzLng7CiAgICAgIGNvbnN0IHkgPSB0aGlzLnk7CiAgICAgIGNvbnN0IHogPSB0aGlzLno7CiAgICAgIHRhcmdldC54ID0geCArICh2ZWN0b3IueCAtIHgpICogdDsKICAgICAgdGFyZ2V0LnkgPSB5ICsgKHZlY3Rvci55IC0geSkgKiB0OwogICAgICB0YXJnZXQueiA9IHogKyAodmVjdG9yLnogLSB6KSAqIHQ7CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrIGlmIGEgdmVjdG9yIGVxdWFscyBpcyBhbG1vc3QgZXF1YWwgdG8gYW5vdGhlciBvbmUuCiAgICAgKi8KCgogICAgYWxtb3N0RXF1YWxzKHZlY3RvciwgcHJlY2lzaW9uKSB7CiAgICAgIGlmIChwcmVjaXNpb24gPT09IHZvaWQgMCkgewogICAgICAgIHByZWNpc2lvbiA9IDFlLTY7CiAgICAgIH0KCiAgICAgIGlmIChNYXRoLmFicyh0aGlzLnggLSB2ZWN0b3IueCkgPiBwcmVjaXNpb24gfHwgTWF0aC5hYnModGhpcy55IC0gdmVjdG9yLnkpID4gcHJlY2lzaW9uIHx8IE1hdGguYWJzKHRoaXMueiAtIHZlY3Rvci56KSA+IHByZWNpc2lvbikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrIGlmIGEgdmVjdG9yIGlzIGFsbW9zdCB6ZXJvCiAgICAgKi8KCgogICAgYWxtb3N0WmVybyhwcmVjaXNpb24pIHsKICAgICAgaWYgKHByZWNpc2lvbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgcHJlY2lzaW9uID0gMWUtNjsKICAgICAgfQoKICAgICAgaWYgKE1hdGguYWJzKHRoaXMueCkgPiBwcmVjaXNpb24gfHwgTWF0aC5hYnModGhpcy55KSA+IHByZWNpc2lvbiB8fCBNYXRoLmFicyh0aGlzLnopID4gcHJlY2lzaW9uKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIHZlY3RvciBpcyBhbnRpLXBhcmFsbGVsIHRvIGFub3RoZXIgdmVjdG9yLgogICAgICogQHBhcmFtIHByZWNpc2lvbiBTZXQgdG8gemVybyBmb3IgZXhhY3QgY29tcGFyaXNvbnMKICAgICAqLwoKCiAgICBpc0FudGlwYXJhbGxlbFRvKHZlY3RvciwgcHJlY2lzaW9uKSB7CiAgICAgIHRoaXMubmVnYXRlKGFudGlwX25lZyk7CiAgICAgIHJldHVybiBhbnRpcF9uZWcuYWxtb3N0RXF1YWxzKHZlY3RvciwgcHJlY2lzaW9uKTsKICAgIH0KICAgIC8qKgogICAgICogQ2xvbmUgdGhlIHZlY3RvcgogICAgICovCgoKICAgIGNsb25lKCkgewogICAgICByZXR1cm4gbmV3IFZlYzModGhpcy54LCB0aGlzLnksIHRoaXMueik7CiAgICB9CgogIH0KICBWZWMzLlpFUk8gPSBuZXcgVmVjMygwLCAwLCAwKTsKICBWZWMzLlVOSVRfWCA9IG5ldyBWZWMzKDEsIDAsIDApOwogIFZlYzMuVU5JVF9ZID0gbmV3IFZlYzMoMCwgMSwgMCk7CiAgVmVjMy5VTklUX1ogPSBuZXcgVmVjMygwLCAwLCAxKTsKICBjb25zdCBWZWMzX3RhbmdlbnRzX24gPSBuZXcgVmVjMygpOwogIGNvbnN0IFZlYzNfdGFuZ2VudHNfcmFuZFZlYyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYW50aXBfbmVnID0gbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogQXhpcyBhbGlnbmVkIGJvdW5kaW5nIGJveCBjbGFzcy4KICAgKi8KICBjbGFzcyBBQUJCIHsKICAgIC8qKgogICAgICogVGhlIGxvd2VyIGJvdW5kIG9mIHRoZSBib3VuZGluZyBib3gKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIHVwcGVyIGJvdW5kIG9mIHRoZSBib3VuZGluZyBib3gKICAgICAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLmxvd2VyQm91bmQgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnVwcGVyQm91bmQgPSBuZXcgVmVjMygpOwoKICAgICAgaWYgKG9wdGlvbnMubG93ZXJCb3VuZCkgewogICAgICAgIHRoaXMubG93ZXJCb3VuZC5jb3B5KG9wdGlvbnMubG93ZXJCb3VuZCk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnVwcGVyQm91bmQpIHsKICAgICAgICB0aGlzLnVwcGVyQm91bmQuY29weShvcHRpb25zLnVwcGVyQm91bmQpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgQUFCQiBib3VuZHMgZnJvbSBhIHNldCBvZiBwb2ludHMuCiAgICAgKiBAcGFyYW0gcG9pbnRzIEFuIGFycmF5IG9mIFZlYzMncy4KICAgICAqIEByZXR1cm4gVGhlIHNlbGYgb2JqZWN0CiAgICAgKi8KCgogICAgc2V0RnJvbVBvaW50cyhwb2ludHMsIHBvc2l0aW9uLCBxdWF0ZXJuaW9uLCBza2luU2l6ZSkgewogICAgICBjb25zdCBsID0gdGhpcy5sb3dlckJvdW5kOwogICAgICBjb25zdCB1ID0gdGhpcy51cHBlckJvdW5kOwogICAgICBjb25zdCBxID0gcXVhdGVybmlvbjsgLy8gU2V0IHRvIHRoZSBmaXJzdCBwb2ludAoKICAgICAgbC5jb3B5KHBvaW50c1swXSk7CgogICAgICBpZiAocSkgewogICAgICAgIHEudm11bHQobCwgbCk7CiAgICAgIH0KCiAgICAgIHUuY29weShsKTsKCiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgcG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGV0IHAgPSBwb2ludHNbaV07CgogICAgICAgIGlmIChxKSB7CiAgICAgICAgICBxLnZtdWx0KHAsIHRtcCQxKTsKICAgICAgICAgIHAgPSB0bXAkMTsKICAgICAgICB9CgogICAgICAgIGlmIChwLnggPiB1LngpIHsKICAgICAgICAgIHUueCA9IHAueDsKICAgICAgICB9CgogICAgICAgIGlmIChwLnggPCBsLngpIHsKICAgICAgICAgIGwueCA9IHAueDsKICAgICAgICB9CgogICAgICAgIGlmIChwLnkgPiB1LnkpIHsKICAgICAgICAgIHUueSA9IHAueTsKICAgICAgICB9CgogICAgICAgIGlmIChwLnkgPCBsLnkpIHsKICAgICAgICAgIGwueSA9IHAueTsKICAgICAgICB9CgogICAgICAgIGlmIChwLnogPiB1LnopIHsKICAgICAgICAgIHUueiA9IHAuejsKICAgICAgICB9CgogICAgICAgIGlmIChwLnogPCBsLnopIHsKICAgICAgICAgIGwueiA9IHAuejsKICAgICAgICB9CiAgICAgIH0gLy8gQWRkIG9mZnNldAoKCiAgICAgIGlmIChwb3NpdGlvbikgewogICAgICAgIHBvc2l0aW9uLnZhZGQobCwgbCk7CiAgICAgICAgcG9zaXRpb24udmFkZCh1LCB1KTsKICAgICAgfQoKICAgICAgaWYgKHNraW5TaXplKSB7CiAgICAgICAgbC54IC09IHNraW5TaXplOwogICAgICAgIGwueSAtPSBza2luU2l6ZTsKICAgICAgICBsLnogLT0gc2tpblNpemU7CiAgICAgICAgdS54ICs9IHNraW5TaXplOwogICAgICAgIHUueSArPSBza2luU2l6ZTsKICAgICAgICB1LnogKz0gc2tpblNpemU7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBDb3B5IGJvdW5kcyBmcm9tIGFuIEFBQkIgdG8gdGhpcyBBQUJCCiAgICAgKiBAcGFyYW0gYWFiYiBTb3VyY2UgdG8gY29weSBmcm9tCiAgICAgKiBAcmV0dXJuIFRoZSB0aGlzIG9iamVjdCwgZm9yIGNoYWluYWJpbGl0eQogICAgICovCgoKICAgIGNvcHkoYWFiYikgewogICAgICB0aGlzLmxvd2VyQm91bmQuY29weShhYWJiLmxvd2VyQm91bmQpOwogICAgICB0aGlzLnVwcGVyQm91bmQuY29weShhYWJiLnVwcGVyQm91bmQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogQ2xvbmUgYW4gQUFCQgogICAgICovCgoKICAgIGNsb25lKCkgewogICAgICByZXR1cm4gbmV3IEFBQkIoKS5jb3B5KHRoaXMpOwogICAgfQogICAgLyoqCiAgICAgKiBFeHRlbmQgdGhpcyBBQUJCIHNvIHRoYXQgaXQgY292ZXJzIHRoZSBnaXZlbiBBQUJCIHRvby4KICAgICAqLwoKCiAgICBleHRlbmQoYWFiYikgewogICAgICB0aGlzLmxvd2VyQm91bmQueCA9IE1hdGgubWluKHRoaXMubG93ZXJCb3VuZC54LCBhYWJiLmxvd2VyQm91bmQueCk7CiAgICAgIHRoaXMudXBwZXJCb3VuZC54ID0gTWF0aC5tYXgodGhpcy51cHBlckJvdW5kLngsIGFhYmIudXBwZXJCb3VuZC54KTsKICAgICAgdGhpcy5sb3dlckJvdW5kLnkgPSBNYXRoLm1pbih0aGlzLmxvd2VyQm91bmQueSwgYWFiYi5sb3dlckJvdW5kLnkpOwogICAgICB0aGlzLnVwcGVyQm91bmQueSA9IE1hdGgubWF4KHRoaXMudXBwZXJCb3VuZC55LCBhYWJiLnVwcGVyQm91bmQueSk7CiAgICAgIHRoaXMubG93ZXJCb3VuZC56ID0gTWF0aC5taW4odGhpcy5sb3dlckJvdW5kLnosIGFhYmIubG93ZXJCb3VuZC56KTsKICAgICAgdGhpcy51cHBlckJvdW5kLnogPSBNYXRoLm1heCh0aGlzLnVwcGVyQm91bmQueiwgYWFiYi51cHBlckJvdW5kLnopOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGdpdmVuIEFBQkIgb3ZlcmxhcHMgdGhpcyBBQUJCLgogICAgICovCgoKICAgIG92ZXJsYXBzKGFhYmIpIHsKICAgICAgY29uc3QgbDEgPSB0aGlzLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUxID0gdGhpcy51cHBlckJvdW5kOwogICAgICBjb25zdCBsMiA9IGFhYmIubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdTIgPSBhYWJiLnVwcGVyQm91bmQ7IC8vICAgICAgbDIgICAgICAgIHUyCiAgICAgIC8vICAgICAgfC0tLS0tLS0tLXwKICAgICAgLy8gfC0tLS0tLS0tfAogICAgICAvLyBsMSAgICAgICB1MQoKICAgICAgY29uc3Qgb3ZlcmxhcHNYID0gbDIueCA8PSB1MS54ICYmIHUxLnggPD0gdTIueCB8fCBsMS54IDw9IHUyLnggJiYgdTIueCA8PSB1MS54OwogICAgICBjb25zdCBvdmVybGFwc1kgPSBsMi55IDw9IHUxLnkgJiYgdTEueSA8PSB1Mi55IHx8IGwxLnkgPD0gdTIueSAmJiB1Mi55IDw9IHUxLnk7CiAgICAgIGNvbnN0IG92ZXJsYXBzWiA9IGwyLnogPD0gdTEueiAmJiB1MS56IDw9IHUyLnogfHwgbDEueiA8PSB1Mi56ICYmIHUyLnogPD0gdTEuejsKICAgICAgcmV0dXJuIG92ZXJsYXBzWCAmJiBvdmVybGFwc1kgJiYgb3ZlcmxhcHNaOwogICAgfSAvLyBNb3N0bHkgZm9yIGRlYnVnZ2luZwoKCiAgICB2b2x1bWUoKSB7CiAgICAgIGNvbnN0IGwgPSB0aGlzLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUgPSB0aGlzLnVwcGVyQm91bmQ7CiAgICAgIHJldHVybiAodS54IC0gbC54KSAqICh1LnkgLSBsLnkpICogKHUueiAtIGwueik7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgZ2l2ZW4gQUFCQiBpcyBmdWxseSBjb250YWluZWQgaW4gdGhpcyBBQUJCLgogICAgICovCgoKICAgIGNvbnRhaW5zKGFhYmIpIHsKICAgICAgY29uc3QgbDEgPSB0aGlzLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUxID0gdGhpcy51cHBlckJvdW5kOwogICAgICBjb25zdCBsMiA9IGFhYmIubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdTIgPSBhYWJiLnVwcGVyQm91bmQ7IC8vICAgICAgbDIgICAgICAgIHUyCiAgICAgIC8vICAgICAgfC0tLS0tLS0tLXwKICAgICAgLy8gfC0tLS0tLS0tLS0tLS0tLXwKICAgICAgLy8gbDEgICAgICAgICAgICAgIHUxCgogICAgICByZXR1cm4gbDEueCA8PSBsMi54ICYmIHUxLnggPj0gdTIueCAmJiBsMS55IDw9IGwyLnkgJiYgdTEueSA+PSB1Mi55ICYmIGwxLnogPD0gbDIueiAmJiB1MS56ID49IHUyLno7CiAgICB9CgogICAgZ2V0Q29ybmVycyhhLCBiLCBjLCBkLCBlLCBmLCBnLCBoKSB7CiAgICAgIGNvbnN0IGwgPSB0aGlzLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUgPSB0aGlzLnVwcGVyQm91bmQ7CiAgICAgIGEuY29weShsKTsKICAgICAgYi5zZXQodS54LCBsLnksIGwueik7CiAgICAgIGMuc2V0KHUueCwgdS55LCBsLnopOwogICAgICBkLnNldChsLngsIHUueSwgdS56KTsKICAgICAgZS5zZXQodS54LCBsLnksIHUueik7CiAgICAgIGYuc2V0KGwueCwgdS55LCBsLnopOwogICAgICBnLnNldChsLngsIGwueSwgdS56KTsKICAgICAgaC5jb3B5KHUpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHJlcHJlc2VudGF0aW9uIG9mIGFuIEFBQkIgaW4gYW5vdGhlciBmcmFtZS4KICAgICAqIEByZXR1cm4gVGhlICJ0YXJnZXQiIEFBQkIgb2JqZWN0LgogICAgICovCgoKICAgIHRvTG9jYWxGcmFtZShmcmFtZSwgdGFyZ2V0KSB7CiAgICAgIGNvbnN0IGNvcm5lcnMgPSB0cmFuc2Zvcm1JbnRvRnJhbWVfY29ybmVyczsKICAgICAgY29uc3QgYSA9IGNvcm5lcnNbMF07CiAgICAgIGNvbnN0IGIgPSBjb3JuZXJzWzFdOwogICAgICBjb25zdCBjID0gY29ybmVyc1syXTsKICAgICAgY29uc3QgZCA9IGNvcm5lcnNbM107CiAgICAgIGNvbnN0IGUgPSBjb3JuZXJzWzRdOwogICAgICBjb25zdCBmID0gY29ybmVyc1s1XTsKICAgICAgY29uc3QgZyA9IGNvcm5lcnNbNl07CiAgICAgIGNvbnN0IGggPSBjb3JuZXJzWzddOyAvLyBHZXQgY29ybmVycyBpbiBjdXJyZW50IGZyYW1lCgogICAgICB0aGlzLmdldENvcm5lcnMoYSwgYiwgYywgZCwgZSwgZiwgZywgaCk7IC8vIFRyYW5zZm9ybSB0aGVtIHRvIG5ldyBsb2NhbCBmcmFtZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IDg7IGkrKykgewogICAgICAgIGNvbnN0IGNvcm5lciA9IGNvcm5lcnNbaV07CiAgICAgICAgZnJhbWUucG9pbnRUb0xvY2FsKGNvcm5lciwgY29ybmVyKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRhcmdldC5zZXRGcm9tUG9pbnRzKGNvcm5lcnMpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHJlcHJlc2VudGF0aW9uIG9mIGFuIEFBQkIgaW4gdGhlIGdsb2JhbCBmcmFtZS4KICAgICAqIEByZXR1cm4gVGhlICJ0YXJnZXQiIEFBQkIgb2JqZWN0LgogICAgICovCgoKICAgIHRvV29ybGRGcmFtZShmcmFtZSwgdGFyZ2V0KSB7CiAgICAgIGNvbnN0IGNvcm5lcnMgPSB0cmFuc2Zvcm1JbnRvRnJhbWVfY29ybmVyczsKICAgICAgY29uc3QgYSA9IGNvcm5lcnNbMF07CiAgICAgIGNvbnN0IGIgPSBjb3JuZXJzWzFdOwogICAgICBjb25zdCBjID0gY29ybmVyc1syXTsKICAgICAgY29uc3QgZCA9IGNvcm5lcnNbM107CiAgICAgIGNvbnN0IGUgPSBjb3JuZXJzWzRdOwogICAgICBjb25zdCBmID0gY29ybmVyc1s1XTsKICAgICAgY29uc3QgZyA9IGNvcm5lcnNbNl07CiAgICAgIGNvbnN0IGggPSBjb3JuZXJzWzddOyAvLyBHZXQgY29ybmVycyBpbiBjdXJyZW50IGZyYW1lCgogICAgICB0aGlzLmdldENvcm5lcnMoYSwgYiwgYywgZCwgZSwgZiwgZywgaCk7IC8vIFRyYW5zZm9ybSB0aGVtIHRvIG5ldyBsb2NhbCBmcmFtZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IDg7IGkrKykgewogICAgICAgIGNvbnN0IGNvcm5lciA9IGNvcm5lcnNbaV07CiAgICAgICAgZnJhbWUucG9pbnRUb1dvcmxkKGNvcm5lciwgY29ybmVyKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRhcmdldC5zZXRGcm9tUG9pbnRzKGNvcm5lcnMpOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgQUFCQiBpcyBoaXQgYnkgYSByYXkuCiAgICAgKi8KCgogICAgb3ZlcmxhcHNSYXkocmF5KSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBkaXJlY3Rpb24sCiAgICAgICAgZnJvbQogICAgICB9ID0gcmF5OyAvLyBjb25zdCB0ID0gMAogICAgICAvLyByYXkuZGlyZWN0aW9uIGlzIHVuaXQgZGlyZWN0aW9uIHZlY3RvciBvZiByYXkKCiAgICAgIGNvbnN0IGRpckZyYWNYID0gMSAvIGRpcmVjdGlvbi54OwogICAgICBjb25zdCBkaXJGcmFjWSA9IDEgLyBkaXJlY3Rpb24ueTsKICAgICAgY29uc3QgZGlyRnJhY1ogPSAxIC8gZGlyZWN0aW9uLno7IC8vIHRoaXMubG93ZXJCb3VuZCBpcyB0aGUgY29ybmVyIG9mIEFBQkIgd2l0aCBtaW5pbWFsIGNvb3JkaW5hdGVzIC0gbGVmdCBib3R0b20sIHJ0IGlzIG1heGltYWwgY29ybmVyCgogICAgICBjb25zdCB0MSA9ICh0aGlzLmxvd2VyQm91bmQueCAtIGZyb20ueCkgKiBkaXJGcmFjWDsKICAgICAgY29uc3QgdDIgPSAodGhpcy51cHBlckJvdW5kLnggLSBmcm9tLngpICogZGlyRnJhY1g7CiAgICAgIGNvbnN0IHQzID0gKHRoaXMubG93ZXJCb3VuZC55IC0gZnJvbS55KSAqIGRpckZyYWNZOwogICAgICBjb25zdCB0NCA9ICh0aGlzLnVwcGVyQm91bmQueSAtIGZyb20ueSkgKiBkaXJGcmFjWTsKICAgICAgY29uc3QgdDUgPSAodGhpcy5sb3dlckJvdW5kLnogLSBmcm9tLnopICogZGlyRnJhY1o7CiAgICAgIGNvbnN0IHQ2ID0gKHRoaXMudXBwZXJCb3VuZC56IC0gZnJvbS56KSAqIGRpckZyYWNaOyAvLyBjb25zdCB0bWluID0gTWF0aC5tYXgoTWF0aC5tYXgoTWF0aC5taW4odDEsIHQyKSwgTWF0aC5taW4odDMsIHQ0KSkpOwogICAgICAvLyBjb25zdCB0bWF4ID0gTWF0aC5taW4oTWF0aC5taW4oTWF0aC5tYXgodDEsIHQyKSwgTWF0aC5tYXgodDMsIHQ0KSkpOwoKICAgICAgY29uc3QgdG1pbiA9IE1hdGgubWF4KE1hdGgubWF4KE1hdGgubWluKHQxLCB0MiksIE1hdGgubWluKHQzLCB0NCkpLCBNYXRoLm1pbih0NSwgdDYpKTsKICAgICAgY29uc3QgdG1heCA9IE1hdGgubWluKE1hdGgubWluKE1hdGgubWF4KHQxLCB0MiksIE1hdGgubWF4KHQzLCB0NCkpLCBNYXRoLm1heCh0NSwgdDYpKTsgLy8gaWYgdG1heCA8IDAsIHJheSAobGluZSkgaXMgaW50ZXJzZWN0aW5nIEFBQkIsIGJ1dCB3aG9sZSBBQUJCIGlzIGJlaGluZyB1cwoKICAgICAgaWYgKHRtYXggPCAwKSB7CiAgICAgICAgLy90ID0gdG1heDsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy8gaWYgdG1pbiA+IHRtYXgsIHJheSBkb2Vzbid0IGludGVyc2VjdCBBQUJCCgoKICAgICAgaWYgKHRtaW4gPiB0bWF4KSB7CiAgICAgICAgLy90ID0gdG1heDsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICB9CiAgY29uc3QgdG1wJDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRyYW5zZm9ybUludG9GcmFtZV9jb3JuZXJzID0gW25ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCldOwoKICAvKioKICAgKiBDb2xsaXNpb24gIm1hdHJpeCIuCiAgICogSXQncyBhY3R1YWxseSBhIHRyaWFuZ3VsYXItc2hhcGVkIGFycmF5IG9mIHdoZXRoZXIgdHdvIGJvZGllcyBhcmUgdG91Y2hpbmcgdGhpcyBzdGVwLCBmb3IgcmVmZXJlbmNlIG5leHQgc3RlcAogICAqLwogIGNsYXNzIEFycmF5Q29sbGlzaW9uTWF0cml4IHsKICAgIC8qKgogICAgICogVGhlIG1hdHJpeCBzdG9yYWdlLgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5tYXRyaXggPSBbXTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGFuIGVsZW1lbnQKICAgICAqLwoKCiAgICBnZXQoYmksIGJqKSB7CiAgICAgIGxldCB7CiAgICAgICAgaW5kZXg6IGkKICAgICAgfSA9IGJpOwogICAgICBsZXQgewogICAgICAgIGluZGV4OiBqCiAgICAgIH0gPSBiajsKCiAgICAgIGlmIChqID4gaSkgewogICAgICAgIGNvbnN0IHRlbXAgPSBqOwogICAgICAgIGogPSBpOwogICAgICAgIGkgPSB0ZW1wOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5tYXRyaXhbKGkgKiAoaSArIDEpID4+IDEpICsgaiAtIDFdOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgYW4gZWxlbWVudAogICAgICovCgoKICAgIHNldChiaSwgYmosIHZhbHVlKSB7CiAgICAgIGxldCB7CiAgICAgICAgaW5kZXg6IGkKICAgICAgfSA9IGJpOwogICAgICBsZXQgewogICAgICAgIGluZGV4OiBqCiAgICAgIH0gPSBiajsKCiAgICAgIGlmIChqID4gaSkgewogICAgICAgIGNvbnN0IHRlbXAgPSBqOwogICAgICAgIGogPSBpOwogICAgICAgIGkgPSB0ZW1wOwogICAgICB9CgogICAgICB0aGlzLm1hdHJpeFsoaSAqIChpICsgMSkgPj4gMSkgKyBqIC0gMV0gPSB2YWx1ZSA/IDEgOiAwOwogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIGFsbCBlbGVtZW50cyB0byB6ZXJvCiAgICAgKi8KCgogICAgcmVzZXQoKSB7CiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gdGhpcy5tYXRyaXgubGVuZ3RoOyBpICE9PSBsOyBpKyspIHsKICAgICAgICB0aGlzLm1hdHJpeFtpXSA9IDA7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogU2V0cyB0aGUgbWF4IG51bWJlciBvZiBvYmplY3RzCiAgICAgKi8KCgogICAgc2V0TnVtT2JqZWN0cyhuKSB7CiAgICAgIHRoaXMubWF0cml4Lmxlbmd0aCA9IG4gKiAobiAtIDEpID4+IDE7CiAgICB9CgogIH0KCiAgLyoqCiAgICogQmFzZSBjbGFzcyBmb3Igb2JqZWN0cyB0aGF0IGRpc3BhdGNoZXMgZXZlbnRzLgogICAqLwogIGNsYXNzIEV2ZW50VGFyZ2V0IHsKICAgIC8qKgogICAgICogQWRkIGFuIGV2ZW50IGxpc3RlbmVyCiAgICAgKiBAcmV0dXJuIFRoZSBzZWxmIG9iamVjdCwgZm9yIGNoYWluYWJpbGl0eS4KICAgICAqLwogICAgYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcikgewogICAgICBpZiAodGhpcy5fbGlzdGVuZXJzID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLl9saXN0ZW5lcnMgPSB7fTsKICAgICAgfQoKICAgICAgY29uc3QgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwoKICAgICAgaWYgKGxpc3RlbmVyc1t0eXBlXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgbGlzdGVuZXJzW3R5cGVdID0gW107CiAgICAgIH0KCiAgICAgIGlmICghbGlzdGVuZXJzW3R5cGVdLmluY2x1ZGVzKGxpc3RlbmVyKSkgewogICAgICAgIGxpc3RlbmVyc1t0eXBlXS5wdXNoKGxpc3RlbmVyKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrIGlmIGFuIGV2ZW50IGxpc3RlbmVyIGlzIGFkZGVkCiAgICAgKi8KCgogICAgaGFzRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcikgewogICAgICBpZiAodGhpcy5fbGlzdGVuZXJzID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGNvbnN0IGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKCiAgICAgIGlmIChsaXN0ZW5lcnNbdHlwZV0gIT09IHVuZGVmaW5lZCAmJiBsaXN0ZW5lcnNbdHlwZV0uaW5jbHVkZXMobGlzdGVuZXIpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgYW55IGV2ZW50IGxpc3RlbmVyIG9mIHRoZSBnaXZlbiB0eXBlIGlzIGFkZGVkCiAgICAgKi8KCgogICAgaGFzQW55RXZlbnRMaXN0ZW5lcih0eXBlKSB7CiAgICAgIGlmICh0aGlzLl9saXN0ZW5lcnMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgY29uc3QgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwogICAgICByZXR1cm4gbGlzdGVuZXJzW3R5cGVdICE9PSB1bmRlZmluZWQ7CiAgICB9CiAgICAvKioKICAgICAqIFJlbW92ZSBhbiBldmVudCBsaXN0ZW5lcgogICAgICogQHJldHVybiBUaGUgc2VsZiBvYmplY3QsIGZvciBjaGFpbmFiaWxpdHkuCiAgICAgKi8KCgogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcikgewogICAgICBpZiAodGhpcy5fbGlzdGVuZXJzID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgY29uc3QgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwoKICAgICAgaWYgKGxpc3RlbmVyc1t0eXBlXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIGNvbnN0IGluZGV4ID0gbGlzdGVuZXJzW3R5cGVdLmluZGV4T2YobGlzdGVuZXIpOwoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIGxpc3RlbmVyc1t0eXBlXS5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogRW1pdCBhbiBldmVudC4KICAgICAqIEByZXR1cm4gVGhlIHNlbGYgb2JqZWN0LCBmb3IgY2hhaW5hYmlsaXR5LgogICAgICovCgoKICAgIGRpc3BhdGNoRXZlbnQoZXZlbnQpIHsKICAgICAgaWYgKHRoaXMuX2xpc3RlbmVycyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIGNvbnN0IGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKICAgICAgY29uc3QgbGlzdGVuZXJBcnJheSA9IGxpc3RlbmVyc1tldmVudC50eXBlXTsKCiAgICAgIGlmIChsaXN0ZW5lckFycmF5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBldmVudC50YXJnZXQgPSB0aGlzOwoKICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGxpc3RlbmVyQXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBsaXN0ZW5lckFycmF5W2ldLmNhbGwodGhpcywgZXZlbnQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogIH0KCiAgLyoqCiAgICogQSBRdWF0ZXJuaW9uIGRlc2NyaWJlcyBhIHJvdGF0aW9uIGluIDNEIHNwYWNlLiBUaGUgUXVhdGVybmlvbiBpcyBtYXRoZW1hdGljYWxseSBkZWZpbmVkIGFzIFEgPSB4KmkgKyB5KmogKyB6KmsgKyB3LCB3aGVyZSAoaSxqLGspIGFyZSBpbWFnaW5hcnkgYmFzaXMgdmVjdG9ycy4gKHgseSx6KSBjYW4gYmUgc2VlbiBhcyBhIHZlY3RvciByZWxhdGVkIHRvIHRoZSBheGlzIG9mIHJvdGF0aW9uLCB3aGlsZSB0aGUgcmVhbCBtdWx0aXBsaWVyLCB3LCBpcyByZWxhdGVkIHRvIHRoZSBhbW91bnQgb2Ygcm90YXRpb24uCiAgICogQHBhcmFtIHggTXVsdGlwbGllciBvZiB0aGUgaW1hZ2luYXJ5IGJhc2lzIHZlY3RvciBpLgogICAqIEBwYXJhbSB5IE11bHRpcGxpZXIgb2YgdGhlIGltYWdpbmFyeSBiYXNpcyB2ZWN0b3Igai4KICAgKiBAcGFyYW0geiBNdWx0aXBsaWVyIG9mIHRoZSBpbWFnaW5hcnkgYmFzaXMgdmVjdG9yIGsuCiAgICogQHBhcmFtIHcgTXVsdGlwbGllciBvZiB0aGUgcmVhbCBwYXJ0LgogICAqIEBzZWUgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9RdWF0ZXJuaW9uCiAgICovCgogIGNsYXNzIFF1YXRlcm5pb24gewogICAgY29uc3RydWN0b3IoeCwgeSwgeiwgdykgewogICAgICBpZiAoeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgeCA9IDA7CiAgICAgIH0KCiAgICAgIGlmICh5ID09PSB2b2lkIDApIHsKICAgICAgICB5ID0gMDsKICAgICAgfQoKICAgICAgaWYgKHogPT09IHZvaWQgMCkgewogICAgICAgIHogPSAwOwogICAgICB9CgogICAgICBpZiAodyA9PT0gdm9pZCAwKSB7CiAgICAgICAgdyA9IDE7CiAgICAgIH0KCiAgICAgIHRoaXMueCA9IHg7CiAgICAgIHRoaXMueSA9IHk7CiAgICAgIHRoaXMueiA9IHo7CiAgICAgIHRoaXMudyA9IHc7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgdmFsdWUgb2YgdGhlIHF1YXRlcm5pb24uCiAgICAgKi8KCgogICAgc2V0KHgsIHksIHosIHcpIHsKICAgICAgdGhpcy54ID0geDsKICAgICAgdGhpcy55ID0geTsKICAgICAgdGhpcy56ID0gejsKICAgICAgdGhpcy53ID0gdzsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnQgdG8gYSByZWFkYWJsZSBmb3JtYXQKICAgICAqIEByZXR1cm4gIngseSx6LHciCiAgICAgKi8KCgogICAgdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiBgJHt0aGlzLnh9LCR7dGhpcy55fSwke3RoaXMuen0sJHt0aGlzLnd9YDsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydCB0byBhbiBBcnJheQogICAgICogQHJldHVybiBbeCwgeSwgeiwgd10KICAgICAqLwoKCiAgICB0b0FycmF5KCkgewogICAgICByZXR1cm4gW3RoaXMueCwgdGhpcy55LCB0aGlzLnosIHRoaXMud107CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgcXVhdGVybmlvbiBjb21wb25lbnRzIGdpdmVuIGFuIGF4aXMgYW5kIGFuIGFuZ2xlIGluIHJhZGlhbnMuCiAgICAgKi8KCgogICAgc2V0RnJvbUF4aXNBbmdsZSh2ZWN0b3IsIGFuZ2xlKSB7CiAgICAgIGNvbnN0IHMgPSBNYXRoLnNpbihhbmdsZSAqIDAuNSk7CiAgICAgIHRoaXMueCA9IHZlY3Rvci54ICogczsKICAgICAgdGhpcy55ID0gdmVjdG9yLnkgKiBzOwogICAgICB0aGlzLnogPSB2ZWN0b3IueiAqIHM7CiAgICAgIHRoaXMudyA9IE1hdGguY29zKGFuZ2xlICogMC41KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnRzIHRoZSBxdWF0ZXJuaW9uIHRvIFsgYXhpcywgYW5nbGUgXSByZXByZXNlbnRhdGlvbi4KICAgICAqIEBwYXJhbSB0YXJnZXRBeGlzIEEgdmVjdG9yIG9iamVjdCB0byByZXVzZSBmb3Igc3RvcmluZyB0aGUgYXhpcy4KICAgICAqIEByZXR1cm4gQW4gYXJyYXksIGZpcnN0IGVsZW1lbnQgaXMgdGhlIGF4aXMgYW5kIHRoZSBzZWNvbmQgaXMgdGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICAgKi8KCgogICAgdG9BeGlzQW5nbGUodGFyZ2V0QXhpcykgewogICAgICBpZiAodGFyZ2V0QXhpcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0QXhpcyA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHRoaXMubm9ybWFsaXplKCk7IC8vIGlmIHc+MSBhY29zIGFuZCBzcXJ0IHdpbGwgcHJvZHVjZSBlcnJvcnMsIHRoaXMgY2FudCBoYXBwZW4gaWYgcXVhdGVybmlvbiBpcyBub3JtYWxpc2VkCgogICAgICBjb25zdCBhbmdsZSA9IDIgKiBNYXRoLmFjb3ModGhpcy53KTsKICAgICAgY29uc3QgcyA9IE1hdGguc3FydCgxIC0gdGhpcy53ICogdGhpcy53KTsgLy8gYXNzdW1pbmcgcXVhdGVybmlvbiBub3JtYWxpc2VkIHRoZW4gdyBpcyBsZXNzIHRoYW4gMSwgc28gdGVybSBhbHdheXMgcG9zaXRpdmUuCgogICAgICBpZiAocyA8IDAuMDAxKSB7CiAgICAgICAgLy8gdGVzdCB0byBhdm9pZCBkaXZpZGUgYnkgemVybywgcyBpcyBhbHdheXMgcG9zaXRpdmUgZHVlIHRvIHNxcnQKICAgICAgICAvLyBpZiBzIGNsb3NlIHRvIHplcm8gdGhlbiBkaXJlY3Rpb24gb2YgYXhpcyBub3QgaW1wb3J0YW50CiAgICAgICAgdGFyZ2V0QXhpcy54ID0gdGhpcy54OyAvLyBpZiBpdCBpcyBpbXBvcnRhbnQgdGhhdCBheGlzIGlzIG5vcm1hbGlzZWQgdGhlbiByZXBsYWNlIHdpdGggeD0xOyB5PXo9MDsKCiAgICAgICAgdGFyZ2V0QXhpcy55ID0gdGhpcy55OwogICAgICAgIHRhcmdldEF4aXMueiA9IHRoaXMuejsKICAgICAgfSBlbHNlIHsKICAgICAgICB0YXJnZXRBeGlzLnggPSB0aGlzLnggLyBzOyAvLyBub3JtYWxpc2UgYXhpcwoKICAgICAgICB0YXJnZXRBeGlzLnkgPSB0aGlzLnkgLyBzOwogICAgICAgIHRhcmdldEF4aXMueiA9IHRoaXMueiAvIHM7CiAgICAgIH0KCiAgICAgIHJldHVybiBbdGFyZ2V0QXhpcywgYW5nbGVdOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHF1YXRlcm5pb24gdmFsdWUgZ2l2ZW4gdHdvIHZlY3RvcnMuIFRoZSByZXN1bHRpbmcgcm90YXRpb24gd2lsbCBiZSB0aGUgbmVlZGVkIHJvdGF0aW9uIHRvIHJvdGF0ZSB1IHRvIHYuCiAgICAgKi8KCgogICAgc2V0RnJvbVZlY3RvcnModSwgdikgewogICAgICBpZiAodS5pc0FudGlwYXJhbGxlbFRvKHYpKSB7CiAgICAgICAgY29uc3QgdDEgPSBzZnZfdDE7CiAgICAgICAgY29uc3QgdDIgPSBzZnZfdDI7CiAgICAgICAgdS50YW5nZW50cyh0MSwgdDIpOwogICAgICAgIHRoaXMuc2V0RnJvbUF4aXNBbmdsZSh0MSwgTWF0aC5QSSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYSA9IHUuY3Jvc3Modik7CiAgICAgICAgdGhpcy54ID0gYS54OwogICAgICAgIHRoaXMueSA9IGEueTsKICAgICAgICB0aGlzLnogPSBhLno7CiAgICAgICAgdGhpcy53ID0gTWF0aC5zcXJ0KHUubGVuZ3RoKCkgKiogMiAqIHYubGVuZ3RoKCkgKiogMikgKyB1LmRvdCh2KTsKICAgICAgICB0aGlzLm5vcm1hbGl6ZSgpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogTXVsdGlwbHkgdGhlIHF1YXRlcm5pb24gd2l0aCBhbiBvdGhlciBxdWF0ZXJuaW9uLgogICAgICovCgoKICAgIG11bHQocXVhdCwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IGF4ID0gdGhpcy54OwogICAgICBjb25zdCBheSA9IHRoaXMueTsKICAgICAgY29uc3QgYXogPSB0aGlzLno7CiAgICAgIGNvbnN0IGF3ID0gdGhpcy53OwogICAgICBjb25zdCBieCA9IHF1YXQueDsKICAgICAgY29uc3QgYnkgPSBxdWF0Lnk7CiAgICAgIGNvbnN0IGJ6ID0gcXVhdC56OwogICAgICBjb25zdCBidyA9IHF1YXQudzsKICAgICAgdGFyZ2V0LnggPSBheCAqIGJ3ICsgYXcgKiBieCArIGF5ICogYnogLSBheiAqIGJ5OwogICAgICB0YXJnZXQueSA9IGF5ICogYncgKyBhdyAqIGJ5ICsgYXogKiBieCAtIGF4ICogYno7CiAgICAgIHRhcmdldC56ID0gYXogKiBidyArIGF3ICogYnogKyBheCAqIGJ5IC0gYXkgKiBieDsKICAgICAgdGFyZ2V0LncgPSBhdyAqIGJ3IC0gYXggKiBieCAtIGF5ICogYnkgLSBheiAqIGJ6OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIGludmVyc2UgcXVhdGVybmlvbiByb3RhdGlvbi4KICAgICAqLwoKCiAgICBpbnZlcnNlKHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICB9CgogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICBjb25zdCB3ID0gdGhpcy53OwogICAgICB0aGlzLmNvbmp1Z2F0ZSh0YXJnZXQpOwogICAgICBjb25zdCBpbm9ybTIgPSAxIC8gKHggKiB4ICsgeSAqIHkgKyB6ICogeiArIHcgKiB3KTsKICAgICAgdGFyZ2V0LnggKj0gaW5vcm0yOwogICAgICB0YXJnZXQueSAqPSBpbm9ybTI7CiAgICAgIHRhcmdldC56ICo9IGlub3JtMjsKICAgICAgdGFyZ2V0LncgKj0gaW5vcm0yOwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHF1YXRlcm5pb24gY29uanVnYXRlCiAgICAgKi8KCgogICAgY29uanVnYXRlKHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICB9CgogICAgICB0YXJnZXQueCA9IC10aGlzLng7CiAgICAgIHRhcmdldC55ID0gLXRoaXMueTsKICAgICAgdGFyZ2V0LnogPSAtdGhpcy56OwogICAgICB0YXJnZXQudyA9IHRoaXMudzsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogTm9ybWFsaXplIHRoZSBxdWF0ZXJuaW9uLiBOb3RlIHRoYXQgdGhpcyBjaGFuZ2VzIHRoZSB2YWx1ZXMgb2YgdGhlIHF1YXRlcm5pb24uCiAgICAgKi8KCgogICAgbm9ybWFsaXplKCkgewogICAgICBsZXQgbCA9IE1hdGguc3FydCh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkgKyB0aGlzLnogKiB0aGlzLnogKyB0aGlzLncgKiB0aGlzLncpOwoKICAgICAgaWYgKGwgPT09IDApIHsKICAgICAgICB0aGlzLnggPSAwOwogICAgICAgIHRoaXMueSA9IDA7CiAgICAgICAgdGhpcy56ID0gMDsKICAgICAgICB0aGlzLncgPSAwOwogICAgICB9IGVsc2UgewogICAgICAgIGwgPSAxIC8gbDsKICAgICAgICB0aGlzLnggKj0gbDsKICAgICAgICB0aGlzLnkgKj0gbDsKICAgICAgICB0aGlzLnogKj0gbDsKICAgICAgICB0aGlzLncgKj0gbDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIEFwcHJveGltYXRpb24gb2YgcXVhdGVybmlvbiBub3JtYWxpemF0aW9uLiBXb3JrcyBiZXN0IHdoZW4gcXVhdCBpcyBhbHJlYWR5IGFsbW9zdC1ub3JtYWxpemVkLgogICAgICogQGF1dGhvciB1bnBoYXNlZCwgaHR0cHM6Ly9naXRodWIuY29tL3VucGhhc2VkCiAgICAgKi8KCgogICAgbm9ybWFsaXplRmFzdCgpIHsKICAgICAgY29uc3QgZiA9ICgzLjAgLSAodGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55ICsgdGhpcy56ICogdGhpcy56ICsgdGhpcy53ICogdGhpcy53KSkgLyAyLjA7CgogICAgICBpZiAoZiA9PT0gMCkgewogICAgICAgIHRoaXMueCA9IDA7CiAgICAgICAgdGhpcy55ID0gMDsKICAgICAgICB0aGlzLnogPSAwOwogICAgICAgIHRoaXMudyA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy54ICo9IGY7CiAgICAgICAgdGhpcy55ICo9IGY7CiAgICAgICAgdGhpcy56ICo9IGY7CiAgICAgICAgdGhpcy53ICo9IGY7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSB0aGUgcXVhdGVybmlvbiBieSBhIHZlY3RvcgogICAgICovCgoKICAgIHZtdWx0KHYsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCB4ID0gdi54OwogICAgICBjb25zdCB5ID0gdi55OwogICAgICBjb25zdCB6ID0gdi56OwogICAgICBjb25zdCBxeCA9IHRoaXMueDsKICAgICAgY29uc3QgcXkgPSB0aGlzLnk7CiAgICAgIGNvbnN0IHF6ID0gdGhpcy56OwogICAgICBjb25zdCBxdyA9IHRoaXMudzsgLy8gcSp2CgogICAgICBjb25zdCBpeCA9IHF3ICogeCArIHF5ICogeiAtIHF6ICogeTsKICAgICAgY29uc3QgaXkgPSBxdyAqIHkgKyBxeiAqIHggLSBxeCAqIHo7CiAgICAgIGNvbnN0IGl6ID0gcXcgKiB6ICsgcXggKiB5IC0gcXkgKiB4OwogICAgICBjb25zdCBpdyA9IC1xeCAqIHggLSBxeSAqIHkgLSBxeiAqIHo7CiAgICAgIHRhcmdldC54ID0gaXggKiBxdyArIGl3ICogLXF4ICsgaXkgKiAtcXogLSBpeiAqIC1xeTsKICAgICAgdGFyZ2V0LnkgPSBpeSAqIHF3ICsgaXcgKiAtcXkgKyBpeiAqIC1xeCAtIGl4ICogLXF6OwogICAgICB0YXJnZXQueiA9IGl6ICogcXcgKyBpdyAqIC1xeiArIGl4ICogLXF5IC0gaXkgKiAtcXg7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIENvcGllcyB2YWx1ZSBvZiBzb3VyY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KCgogICAgY29weShxdWF0KSB7CiAgICAgIHRoaXMueCA9IHF1YXQueDsKICAgICAgdGhpcy55ID0gcXVhdC55OwogICAgICB0aGlzLnogPSBxdWF0Lno7CiAgICAgIHRoaXMudyA9IHF1YXQudzsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnQgdGhlIHF1YXRlcm5pb24gdG8gZXVsZXIgYW5nbGUgcmVwcmVzZW50YXRpb24uIE9yZGVyOiBZWlgsIGFzIHRoaXMgcGFnZSBkZXNjcmliZXM6IGh0dHBzOi8vd3d3LmV1Y2xpZGVhbnNwYWNlLmNvbS9tYXRocy9zdGFuZGFyZHMvaW5kZXguaHRtCiAgICAgKiBAcGFyYW0gb3JkZXIgVGhyZWUtY2hhcmFjdGVyIHN0cmluZywgZGVmYXVsdHMgdG8gIllaWCIKICAgICAqLwoKCiAgICB0b0V1bGVyKHRhcmdldCwgb3JkZXIpIHsKICAgICAgaWYgKG9yZGVyID09PSB2b2lkIDApIHsKICAgICAgICBvcmRlciA9ICdZWlgnOwogICAgICB9CgogICAgICBsZXQgaGVhZGluZzsKICAgICAgbGV0IGF0dGl0dWRlOwogICAgICBsZXQgYmFuazsKICAgICAgY29uc3QgeCA9IHRoaXMueDsKICAgICAgY29uc3QgeSA9IHRoaXMueTsKICAgICAgY29uc3QgeiA9IHRoaXMuejsKICAgICAgY29uc3QgdyA9IHRoaXMudzsKCiAgICAgIHN3aXRjaCAob3JkZXIpIHsKICAgICAgICBjYXNlICdZWlgnOgogICAgICAgICAgY29uc3QgdGVzdCA9IHggKiB5ICsgeiAqIHc7CgogICAgICAgICAgaWYgKHRlc3QgPiAwLjQ5OSkgewogICAgICAgICAgICAvLyBzaW5ndWxhcml0eSBhdCBub3J0aCBwb2xlCiAgICAgICAgICAgIGhlYWRpbmcgPSAyICogTWF0aC5hdGFuMih4LCB3KTsKICAgICAgICAgICAgYXR0aXR1ZGUgPSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgYmFuayA9IDA7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHRlc3QgPCAtMC40OTkpIHsKICAgICAgICAgICAgLy8gc2luZ3VsYXJpdHkgYXQgc291dGggcG9sZQogICAgICAgICAgICBoZWFkaW5nID0gLTIgKiBNYXRoLmF0YW4yKHgsIHcpOwogICAgICAgICAgICBhdHRpdHVkZSA9IC1NYXRoLlBJIC8gMjsKICAgICAgICAgICAgYmFuayA9IDA7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGhlYWRpbmcgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjb25zdCBzcXggPSB4ICogeDsKICAgICAgICAgICAgY29uc3Qgc3F5ID0geSAqIHk7CiAgICAgICAgICAgIGNvbnN0IHNxeiA9IHogKiB6OwogICAgICAgICAgICBoZWFkaW5nID0gTWF0aC5hdGFuMigyICogeSAqIHcgLSAyICogeCAqIHosIDEgLSAyICogc3F5IC0gMiAqIHNxeik7IC8vIEhlYWRpbmcKCiAgICAgICAgICAgIGF0dGl0dWRlID0gTWF0aC5hc2luKDIgKiB0ZXN0KTsgLy8gYXR0aXR1ZGUKCiAgICAgICAgICAgIGJhbmsgPSBNYXRoLmF0YW4yKDIgKiB4ICogdyAtIDIgKiB5ICogeiwgMSAtIDIgKiBzcXggLSAyICogc3F6KTsgLy8gYmFuawogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFdWxlciBvcmRlciAke29yZGVyfSBub3Qgc3VwcG9ydGVkIHlldC5gKTsKICAgICAgfQoKICAgICAgdGFyZ2V0LnkgPSBoZWFkaW5nOwogICAgICB0YXJnZXQueiA9IGF0dGl0dWRlOwogICAgICB0YXJnZXQueCA9IGJhbms7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgcXVhdGVybmlvbiBjb21wb25lbnRzIGdpdmVuIEV1bGVyIGFuZ2xlIHJlcHJlc2VudGF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSBvcmRlciBUaGUgb3JkZXIgdG8gYXBwbHkgYW5nbGVzOiAnWFlaJyBvciAnWVhaJyBvciBhbnkgb3RoZXIgY29tYmluYXRpb24uCiAgICAgKgogICAgICogU2VlIHtAbGluayBodHRwczovL3d3dy5tYXRod29ya3MuY29tL21hdGxhYmNlbnRyYWwvZmlsZWV4Y2hhbmdlLzIwNjk2LWZ1bmN0aW9uLXRvLWNvbnZlcnQtYmV0d2Vlbi1kY20tZXVsZXItYW5nbGVzLXF1YXRlcm5pb25zLWFuZC1ldWxlci12ZWN0b3JzIE1hdGhXb3Jrc30gcmVmZXJlbmNlCiAgICAgKi8KCgogICAgc2V0RnJvbUV1bGVyKHgsIHksIHosIG9yZGVyKSB7CiAgICAgIGlmIChvcmRlciA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3JkZXIgPSAnWFlaJzsKICAgICAgfQoKICAgICAgY29uc3QgYzEgPSBNYXRoLmNvcyh4IC8gMik7CiAgICAgIGNvbnN0IGMyID0gTWF0aC5jb3MoeSAvIDIpOwogICAgICBjb25zdCBjMyA9IE1hdGguY29zKHogLyAyKTsKICAgICAgY29uc3QgczEgPSBNYXRoLnNpbih4IC8gMik7CiAgICAgIGNvbnN0IHMyID0gTWF0aC5zaW4oeSAvIDIpOwogICAgICBjb25zdCBzMyA9IE1hdGguc2luKHogLyAyKTsKCiAgICAgIGlmIChvcmRlciA9PT0gJ1hZWicpIHsKICAgICAgICB0aGlzLnggPSBzMSAqIGMyICogYzMgKyBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy55ID0gYzEgKiBzMiAqIGMzIC0gczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMueiA9IGMxICogYzIgKiBzMyArIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLncgPSBjMSAqIGMyICogYzMgLSBzMSAqIHMyICogczM7CiAgICAgIH0gZWxzZSBpZiAob3JkZXIgPT09ICdZWFonKSB7CiAgICAgICAgdGhpcy54ID0gczEgKiBjMiAqIGMzICsgYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMueSA9IGMxICogczIgKiBjMyAtIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLnogPSBjMSAqIGMyICogczMgLSBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy53ID0gYzEgKiBjMiAqIGMzICsgczEgKiBzMiAqIHMzOwogICAgICB9IGVsc2UgaWYgKG9yZGVyID09PSAnWlhZJykgewogICAgICAgIHRoaXMueCA9IHMxICogYzIgKiBjMyAtIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLnkgPSBjMSAqIHMyICogYzMgKyBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy56ID0gYzEgKiBjMiAqIHMzICsgczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMudyA9IGMxICogYzIgKiBjMyAtIHMxICogczIgKiBzMzsKICAgICAgfSBlbHNlIGlmIChvcmRlciA9PT0gJ1pZWCcpIHsKICAgICAgICB0aGlzLnggPSBzMSAqIGMyICogYzMgLSBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy55ID0gYzEgKiBzMiAqIGMzICsgczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMueiA9IGMxICogYzIgKiBzMyAtIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLncgPSBjMSAqIGMyICogYzMgKyBzMSAqIHMyICogczM7CiAgICAgIH0gZWxzZSBpZiAob3JkZXIgPT09ICdZWlgnKSB7CiAgICAgICAgdGhpcy54ID0gczEgKiBjMiAqIGMzICsgYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMueSA9IGMxICogczIgKiBjMyArIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLnogPSBjMSAqIGMyICogczMgLSBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy53ID0gYzEgKiBjMiAqIGMzIC0gczEgKiBzMiAqIHMzOwogICAgICB9IGVsc2UgaWYgKG9yZGVyID09PSAnWFpZJykgewogICAgICAgIHRoaXMueCA9IHMxICogYzIgKiBjMyAtIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLnkgPSBjMSAqIHMyICogYzMgLSBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy56ID0gYzEgKiBjMiAqIHMzICsgczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMudyA9IGMxICogYzIgKiBjMyArIHMxICogczIgKiBzMzsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgY2xvbmUoKSB7CiAgICAgIHJldHVybiBuZXcgUXVhdGVybmlvbih0aGlzLngsIHRoaXMueSwgdGhpcy56LCB0aGlzLncpOwogICAgfQogICAgLyoqCiAgICAgKiBQZXJmb3JtcyBhIHNwaGVyaWNhbCBsaW5lYXIgaW50ZXJwb2xhdGlvbiBiZXR3ZWVuIHR3byBxdWF0CiAgICAgKgogICAgICogQHBhcmFtIHRvUXVhdCBzZWNvbmQgb3BlcmFuZAogICAgICogQHBhcmFtIHQgaW50ZXJwb2xhdGlvbiBhbW91bnQgYmV0d2VlbiB0aGUgc2VsZiBxdWF0ZXJuaW9uIGFuZCB0b1F1YXQKICAgICAqIEBwYXJhbSB0YXJnZXQgQSBxdWF0ZXJuaW9uIHRvIHN0b3JlIHRoZSByZXN1bHQgaW4uIElmIG5vdCBwcm92aWRlZCwgYSBuZXcgb25lIHdpbGwgYmUgY3JlYXRlZC4KICAgICAqIEByZXR1cm5zIHtRdWF0ZXJuaW9ufSBUaGUgInRhcmdldCIgb2JqZWN0CiAgICAgKi8KCgogICAgc2xlcnAodG9RdWF0LCB0LCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgfQoKICAgICAgY29uc3QgYXggPSB0aGlzLng7CiAgICAgIGNvbnN0IGF5ID0gdGhpcy55OwogICAgICBjb25zdCBheiA9IHRoaXMuejsKICAgICAgY29uc3QgYXcgPSB0aGlzLnc7CiAgICAgIGxldCBieCA9IHRvUXVhdC54OwogICAgICBsZXQgYnkgPSB0b1F1YXQueTsKICAgICAgbGV0IGJ6ID0gdG9RdWF0Lno7CiAgICAgIGxldCBidyA9IHRvUXVhdC53OwogICAgICBsZXQgb21lZ2E7CiAgICAgIGxldCBjb3NvbTsKICAgICAgbGV0IHNpbm9tOwogICAgICBsZXQgc2NhbGUwOwogICAgICBsZXQgc2NhbGUxOyAvLyBjYWxjIGNvc2luZQoKICAgICAgY29zb20gPSBheCAqIGJ4ICsgYXkgKiBieSArIGF6ICogYnogKyBhdyAqIGJ3OyAvLyBhZGp1c3Qgc2lnbnMgKGlmIG5lY2Vzc2FyeSkKCiAgICAgIGlmIChjb3NvbSA8IDAuMCkgewogICAgICAgIGNvc29tID0gLWNvc29tOwogICAgICAgIGJ4ID0gLWJ4OwogICAgICAgIGJ5ID0gLWJ5OwogICAgICAgIGJ6ID0gLWJ6OwogICAgICAgIGJ3ID0gLWJ3OwogICAgICB9IC8vIGNhbGN1bGF0ZSBjb2VmZmljaWVudHMKCgogICAgICBpZiAoMS4wIC0gY29zb20gPiAwLjAwMDAwMSkgewogICAgICAgIC8vIHN0YW5kYXJkIGNhc2UgKHNsZXJwKQogICAgICAgIG9tZWdhID0gTWF0aC5hY29zKGNvc29tKTsKICAgICAgICBzaW5vbSA9IE1hdGguc2luKG9tZWdhKTsKICAgICAgICBzY2FsZTAgPSBNYXRoLnNpbigoMS4wIC0gdCkgKiBvbWVnYSkgLyBzaW5vbTsKICAgICAgICBzY2FsZTEgPSBNYXRoLnNpbih0ICogb21lZ2EpIC8gc2lub207CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gImZyb20iIGFuZCAidG8iIHF1YXRlcm5pb25zIGFyZSB2ZXJ5IGNsb3NlCiAgICAgICAgLy8gIC4uLiBzbyB3ZSBjYW4gZG8gYSBsaW5lYXIgaW50ZXJwb2xhdGlvbgogICAgICAgIHNjYWxlMCA9IDEuMCAtIHQ7CiAgICAgICAgc2NhbGUxID0gdDsKICAgICAgfSAvLyBjYWxjdWxhdGUgZmluYWwgdmFsdWVzCgoKICAgICAgdGFyZ2V0LnggPSBzY2FsZTAgKiBheCArIHNjYWxlMSAqIGJ4OwogICAgICB0YXJnZXQueSA9IHNjYWxlMCAqIGF5ICsgc2NhbGUxICogYnk7CiAgICAgIHRhcmdldC56ID0gc2NhbGUwICogYXogKyBzY2FsZTEgKiBiejsKICAgICAgdGFyZ2V0LncgPSBzY2FsZTAgKiBhdyArIHNjYWxlMSAqIGJ3OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBSb3RhdGUgYW4gYWJzb2x1dGUgb3JpZW50YXRpb24gcXVhdGVybmlvbiBnaXZlbiBhbiBhbmd1bGFyIHZlbG9jaXR5IGFuZCBhIHRpbWUgc3RlcC4KICAgICAqLwoKCiAgICBpbnRlZ3JhdGUoYW5ndWxhclZlbG9jaXR5LCBkdCwgYW5ndWxhckZhY3RvciwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IGF4ID0gYW5ndWxhclZlbG9jaXR5LnggKiBhbmd1bGFyRmFjdG9yLngsCiAgICAgICAgICAgIGF5ID0gYW5ndWxhclZlbG9jaXR5LnkgKiBhbmd1bGFyRmFjdG9yLnksCiAgICAgICAgICAgIGF6ID0gYW5ndWxhclZlbG9jaXR5LnogKiBhbmd1bGFyRmFjdG9yLnosCiAgICAgICAgICAgIGJ4ID0gdGhpcy54LAogICAgICAgICAgICBieSA9IHRoaXMueSwKICAgICAgICAgICAgYnogPSB0aGlzLnosCiAgICAgICAgICAgIGJ3ID0gdGhpcy53OwogICAgICBjb25zdCBoYWxmX2R0ID0gZHQgKiAwLjU7CiAgICAgIHRhcmdldC54ICs9IGhhbGZfZHQgKiAoYXggKiBidyArIGF5ICogYnogLSBheiAqIGJ5KTsKICAgICAgdGFyZ2V0LnkgKz0gaGFsZl9kdCAqIChheSAqIGJ3ICsgYXogKiBieCAtIGF4ICogYnopOwogICAgICB0YXJnZXQueiArPSBoYWxmX2R0ICogKGF6ICogYncgKyBheCAqIGJ5IC0gYXkgKiBieCk7CiAgICAgIHRhcmdldC53ICs9IGhhbGZfZHQgKiAoLWF4ICogYnggLSBheSAqIGJ5IC0gYXogKiBieik7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CgogIH0KICBjb25zdCBzZnZfdDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNmdl90MiA9IG5ldyBWZWMzKCk7CgogIC8qKgogICAqIFRoZSBhdmFpbGFibGUgc2hhcGUgdHlwZXMuCiAgICovCiAgY29uc3QgU0hBUEVfVFlQRVMgPSB7CiAgICAvKiogU1BIRVJFICovCiAgICBTUEhFUkU6IDEsCgogICAgLyoqIFBMQU5FICovCiAgICBQTEFORTogMiwKCiAgICAvKiogQk9YICovCiAgICBCT1g6IDQsCgogICAgLyoqIENPTVBPVU5EICovCiAgICBDT01QT1VORDogOCwKCiAgICAvKiogQ09OVkVYUE9MWUhFRFJPTiAqLwogICAgQ09OVkVYUE9MWUhFRFJPTjogMTYsCgogICAgLyoqIEhFSUdIVEZJRUxEICovCiAgICBIRUlHSFRGSUVMRDogMzIsCgogICAgLyoqIFBBUlRJQ0xFICovCiAgICBQQVJUSUNMRTogNjQsCgogICAgLyoqIENZTElOREVSICovCiAgICBDWUxJTkRFUjogMTI4LAoKICAgIC8qKiBUUklNRVNIICovCiAgICBUUklNRVNIOiAyNTYKICB9OwogIC8qKgogICAqIFNoYXBlVHlwZQogICAqLwoKICAvKioKICAgKiBCYXNlIGNsYXNzIGZvciBzaGFwZXMKICAgKi8KICBjbGFzcyBTaGFwZSB7CiAgICAvKioKICAgICAqIElkZW50aWZpZXIgb2YgdGhlIFNoYXBlLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgdHlwZSBvZiB0aGlzIHNoYXBlLiBNdXN0IGJlIHNldCB0byBhbiBpbnQgPiAwIGJ5IHN1YmNsYXNzZXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBsb2NhbCBib3VuZGluZyBzcGhlcmUgcmFkaXVzIG9mIHRoaXMgc2hhcGUuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFdoZXRoZXIgdG8gcHJvZHVjZSBjb250YWN0IGZvcmNlcyB3aGVuIGluIGNvbnRhY3Qgd2l0aCBvdGhlciBib2RpZXMuIE5vdGUgdGhhdCBjb250YWN0cyB3aWxsIGJlIGdlbmVyYXRlZCwgYnV0IHRoZXkgd2lsbCBiZSBkaXNhYmxlZC4KICAgICAqIEBkZWZhdWx0IHRydWUKICAgICAqLwoKICAgIC8qKgogICAgICogQGRlZmF1bHQgMQogICAgICovCgogICAgLyoqCiAgICAgKiBAZGVmYXVsdCAtMQogICAgICovCgogICAgLyoqCiAgICAgKiBPcHRpb25hbCBtYXRlcmlhbCBvZiB0aGUgc2hhcGUgdGhhdCByZWd1bGF0ZXMgY29udGFjdCBwcm9wZXJ0aWVzLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgYm9keSB0byB3aGljaCB0aGUgc2hhcGUgaXMgYWRkZWQgdG8uCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFsbCB0aGUgU2hhcGUgdHlwZXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgdGhpcy5pZCA9IFNoYXBlLmlkQ291bnRlcisrOwogICAgICB0aGlzLnR5cGUgPSBvcHRpb25zLnR5cGUgfHwgMDsKICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyA9IDA7CiAgICAgIHRoaXMuY29sbGlzaW9uUmVzcG9uc2UgPSBvcHRpb25zLmNvbGxpc2lvblJlc3BvbnNlID8gb3B0aW9ucy5jb2xsaXNpb25SZXNwb25zZSA6IHRydWU7CiAgICAgIHRoaXMuY29sbGlzaW9uRmlsdGVyR3JvdXAgPSBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwIDogMTsKICAgICAgdGhpcy5jb2xsaXNpb25GaWx0ZXJNYXNrID0gb3B0aW9ucy5jb2xsaXNpb25GaWx0ZXJNYXNrICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlck1hc2sgOiAtMTsKICAgICAgdGhpcy5tYXRlcmlhbCA9IG9wdGlvbnMubWF0ZXJpYWwgPyBvcHRpb25zLm1hdGVyaWFsIDogbnVsbDsKICAgICAgdGhpcy5ib2R5ID0gbnVsbDsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZXMgdGhlIGJvdW5kaW5nIHNwaGVyZSByYWRpdXMuCiAgICAgKiBUaGUgcmVzdWx0IGlzIHN0b3JlZCBpbiB0aGUgcHJvcGVydHkgYC5ib3VuZGluZ1NwaGVyZVJhZGl1c2AKICAgICAqLwoKCiAgICB1cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpIHsKICAgICAgdGhyb3cgYGNvbXB1dGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpIG5vdCBpbXBsZW1lbnRlZCBmb3Igc2hhcGUgdHlwZSAke3RoaXMudHlwZX1gOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHZvbHVtZSBvZiB0aGlzIHNoYXBlCiAgICAgKi8KCgogICAgdm9sdW1lKCkgewogICAgICB0aHJvdyBgdm9sdW1lKCkgbm90IGltcGxlbWVudGVkIGZvciBzaGFwZSB0eXBlICR7dGhpcy50eXBlfWA7CiAgICB9CiAgICAvKioKICAgICAqIENhbGN1bGF0ZXMgdGhlIGluZXJ0aWEgaW4gdGhlIGxvY2FsIGZyYW1lIGZvciB0aGlzIHNoYXBlLgogICAgICogQHNlZSBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0xpc3Rfb2ZfbW9tZW50c19vZl9pbmVydGlhCiAgICAgKi8KCgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICB0aHJvdyBgY2FsY3VsYXRlTG9jYWxJbmVydGlhKCkgbm90IGltcGxlbWVudGVkIGZvciBzaGFwZSB0eXBlICR7dGhpcy50eXBlfWA7CiAgICB9CiAgICAvKioKICAgICAqIEB0b2RvIHVzZSBhYnN0cmFjdCBmb3IgdGhlc2Uga2luZCBvZiBtZXRob2RzCiAgICAgKi8KCgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgdGhyb3cgYGNhbGN1bGF0ZVdvcmxkQUFCQigpIG5vdCBpbXBsZW1lbnRlZCBmb3Igc2hhcGUgdHlwZSAke3RoaXMudHlwZX1gOwogICAgfQoKICB9CiAgU2hhcGUuaWRDb3VudGVyID0gMDsKICBTaGFwZS50eXBlcyA9IFNIQVBFX1RZUEVTOwoKICAvKioKICAgKiBUcmFuc2Zvcm1hdGlvbiB1dGlsaXRpZXMuCiAgICovCiAgY2xhc3MgVHJhbnNmb3JtIHsKICAgIC8qKgogICAgICogcG9zaXRpb24KICAgICAqLwoKICAgIC8qKgogICAgICogcXVhdGVybmlvbgogICAgICovCiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIHRoaXMucG9zaXRpb24gPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwoKICAgICAgaWYgKG9wdGlvbnMucG9zaXRpb24pIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLmNvcHkob3B0aW9ucy5wb3NpdGlvbik7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnF1YXRlcm5pb24pIHsKICAgICAgICB0aGlzLnF1YXRlcm5pb24uY29weShvcHRpb25zLnF1YXRlcm5pb24pOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhIGdsb2JhbCBwb2ludCBpbiBsb2NhbCB0cmFuc2Zvcm0gY29vcmRpbmF0ZXMuCiAgICAgKi8KCgogICAgcG9pbnRUb0xvY2FsKHdvcmxkUG9pbnQsIHJlc3VsdCkgewogICAgICByZXR1cm4gVHJhbnNmb3JtLnBvaW50VG9Mb2NhbEZyYW1lKHRoaXMucG9zaXRpb24sIHRoaXMucXVhdGVybmlvbiwgd29ybGRQb2ludCwgcmVzdWx0KTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGEgbG9jYWwgcG9pbnQgaW4gZ2xvYmFsIHRyYW5zZm9ybSBjb29yZGluYXRlcy4KICAgICAqLwoKCiAgICBwb2ludFRvV29ybGQobG9jYWxQb2ludCwgcmVzdWx0KSB7CiAgICAgIHJldHVybiBUcmFuc2Zvcm0ucG9pbnRUb1dvcmxkRnJhbWUodGhpcy5wb3NpdGlvbiwgdGhpcy5xdWF0ZXJuaW9uLCBsb2NhbFBvaW50LCByZXN1bHQpOwogICAgfQogICAgLyoqCiAgICAgKiB2ZWN0b3JUb1dvcmxkRnJhbWUKICAgICAqLwoKCiAgICB2ZWN0b3JUb1dvcmxkRnJhbWUobG9jYWxWZWN0b3IsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0aGlzLnF1YXRlcm5pb24udm11bHQobG9jYWxWZWN0b3IsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIHBvaW50VG9Mb2NhbEZyYW1lCiAgICAgKi8KCgogICAgc3RhdGljIHBvaW50VG9Mb2NhbEZyYW1lKHBvc2l0aW9uLCBxdWF0ZXJuaW9uLCB3b3JsZFBvaW50LCByZXN1bHQpIHsKICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVzdWx0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgd29ybGRQb2ludC52c3ViKHBvc2l0aW9uLCByZXN1bHQpOwogICAgICBxdWF0ZXJuaW9uLmNvbmp1Z2F0ZSh0bXBRdWF0JDEpOwogICAgICB0bXBRdWF0JDEudm11bHQocmVzdWx0LCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiBwb2ludFRvV29ybGRGcmFtZQogICAgICovCgoKICAgIHN0YXRpYyBwb2ludFRvV29ybGRGcmFtZShwb3NpdGlvbiwgcXVhdGVybmlvbiwgbG9jYWxQb2ludCwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHF1YXRlcm5pb24udm11bHQobG9jYWxQb2ludCwgcmVzdWx0KTsKICAgICAgcmVzdWx0LnZhZGQocG9zaXRpb24sIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIHZlY3RvclRvV29ybGRGcmFtZQogICAgICovCgoKICAgIHN0YXRpYyB2ZWN0b3JUb1dvcmxkRnJhbWUocXVhdGVybmlvbiwgbG9jYWxWZWN0b3IsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBxdWF0ZXJuaW9uLnZtdWx0KGxvY2FsVmVjdG9yLCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiB2ZWN0b3JUb0xvY2FsRnJhbWUKICAgICAqLwoKCiAgICBzdGF0aWMgdmVjdG9yVG9Mb2NhbEZyYW1lKHBvc2l0aW9uLCBxdWF0ZXJuaW9uLCB3b3JsZFZlY3RvciwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHF1YXRlcm5pb24udyAqPSAtMTsKICAgICAgcXVhdGVybmlvbi52bXVsdCh3b3JsZFZlY3RvciwgcmVzdWx0KTsKICAgICAgcXVhdGVybmlvbi53ICo9IC0xOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICB9CiAgY29uc3QgdG1wUXVhdCQxID0gbmV3IFF1YXRlcm5pb24oKTsKCiAgLyoqCiAgICogQSBzZXQgb2YgcG9seWdvbnMgZGVzY3JpYmluZyBhIGNvbnZleCBzaGFwZS4KICAgKgogICAqIFRoZSBzaGFwZSBNVVNUIGJlIGNvbnZleCBmb3IgdGhlIGNvZGUgdG8gd29yayBwcm9wZXJseS4gTm8gcG9seWdvbnMgbWF5IGJlIGNvcGxhbmFyIChjb250YWluZWQKICAgKiBpbiB0aGUgc2FtZSAzRCBwbGFuZSksIGluc3RlYWQgdGhlc2Ugc2hvdWxkIGJlIG1lcmdlZCBpbnRvIG9uZSBwb2x5Z29uLgogICAqCiAgICogQGF1dGhvciBxaWFvIC8gaHR0cHM6Ly9naXRodWIuY29tL3FpYW8gKG9yaWdpbmFsIGF1dGhvciwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9xaWFvL3RocmVlLmpzL2NvbW1pdC84NTAyNmYwYzc2OWU0MDAwMTQ4YTY3ZDQ1YTllOWI5YzUxMDg4MzZmKQogICAqIEBhdXRob3Igc2NodGVwcGUgLyBodHRwczovL2dpdGh1Yi5jb20vc2NodGVwcGUKICAgKiBAc2VlIGh0dHBzOi8vd3d3LmFsdGRldmJsb2dhZGF5LmNvbS8yMDExLzA1LzEzL2NvbnRhY3QtZ2VuZXJhdGlvbi1iZXR3ZWVuLTNkLWNvbnZleC1tZXNoZXMvCiAgICoKICAgKiBAdG9kbyBNb3ZlIHRoZSBjbGlwcGluZyBmdW5jdGlvbnMgdG8gQ29udGFjdEdlbmVyYXRvcj8KICAgKiBAdG9kbyBBdXRvbWF0aWNhbGx5IG1lcmdlIGNvcGxhbmFyIHBvbHlnb25zIGluIGNvbnN0cnVjdG9yLgogICAqIEBleGFtcGxlCiAgICogICAgIGNvbnN0IGNvbnZleFNoYXBlID0gbmV3IENBTk5PTi5Db252ZXhQb2x5aGVkcm9uKHsgdmVydGljZXMsIGZhY2VzIH0pCiAgICogICAgIGNvbnN0IGNvbnZleEJvZHkgPSBuZXcgQ0FOTk9OLkJvZHkoeyBtYXNzOiAxLCBzaGFwZTogY29udmV4U2hhcGUgfSkKICAgKiAgICAgd29ybGQuYWRkQm9keShjb252ZXhCb2R5KQogICAqLwogIGNsYXNzIENvbnZleFBvbHloZWRyb24gZXh0ZW5kcyBTaGFwZSB7CiAgICAvKiogdmVydGljZXMgKi8KCiAgICAvKioKICAgICAqIEFycmF5IG9mIGludGVnZXIgYXJyYXlzLCBpbmRpY2F0aW5nIHdoaWNoIHZlcnRpY2VzIGVhY2ggZmFjZSBjb25zaXN0cyBvZgogICAgICovCgogICAgLyoqIGZhY2VOb3JtYWxzICovCgogICAgLyoqIHdvcmxkVmVydGljZXMgKi8KCiAgICAvKiogd29ybGRWZXJ0aWNlc05lZWRzVXBkYXRlICovCgogICAgLyoqIHdvcmxkRmFjZU5vcm1hbHMgKi8KCiAgICAvKiogd29ybGRGYWNlTm9ybWFsc05lZWRzVXBkYXRlICovCgogICAgLyoqCiAgICAgKiBJZiBnaXZlbiwgdGhlc2UgbG9jYWxseSBkZWZpbmVkLCBub3JtYWxpemVkIGF4ZXMgYXJlIHRoZSBvbmx5IG9uZXMgYmVpbmcgY2hlY2tlZCB3aGVuIGRvaW5nIHNlcGFyYXRpbmcgYXhpcyBjaGVjay4KICAgICAqLwoKICAgIC8qKiB1bmlxdWVFZGdlcyAqLwoKICAgIC8qKgogICAgICogQHBhcmFtIHZlcnRpY2VzIEFuIGFycmF5IG9mIFZlYzMncwogICAgICogQHBhcmFtIGZhY2VzIEFycmF5IG9mIGludGVnZXIgYXJyYXlzLCBkZXNjcmliaW5nIHdoaWNoIHZlcnRpY2VzIHRoYXQgaXMgaW5jbHVkZWQgaW4gZWFjaCBmYWNlLgogICAgICovCiAgICBjb25zdHJ1Y3Rvcihwcm9wcykgewogICAgICBpZiAocHJvcHMgPT09IHZvaWQgMCkgewogICAgICAgIHByb3BzID0ge307CiAgICAgIH0KCiAgICAgIGNvbnN0IHsKICAgICAgICB2ZXJ0aWNlcyA9IFtdLAogICAgICAgIGZhY2VzID0gW10sCiAgICAgICAgbm9ybWFscyA9IFtdLAogICAgICAgIGF4ZXMsCiAgICAgICAgYm91bmRpbmdTcGhlcmVSYWRpdXMKICAgICAgfSA9IHByb3BzOwogICAgICBzdXBlcih7CiAgICAgICAgdHlwZTogU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTgogICAgICB9KTsKICAgICAgdGhpcy52ZXJ0aWNlcyA9IHZlcnRpY2VzOwogICAgICB0aGlzLmZhY2VzID0gZmFjZXM7CiAgICAgIHRoaXMuZmFjZU5vcm1hbHMgPSBub3JtYWxzOwoKICAgICAgaWYgKHRoaXMuZmFjZU5vcm1hbHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy5jb21wdXRlTm9ybWFscygpOwogICAgICB9CgogICAgICBpZiAoIWJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgdGhpcy51cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgPSBib3VuZGluZ1NwaGVyZVJhZGl1czsKICAgICAgfQoKICAgICAgdGhpcy53b3JsZFZlcnRpY2VzID0gW107IC8vIFdvcmxkIHRyYW5zZm9ybWVkIHZlcnNpb24gb2YgLnZlcnRpY2VzCgogICAgICB0aGlzLndvcmxkVmVydGljZXNOZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgIHRoaXMud29ybGRGYWNlTm9ybWFscyA9IFtdOyAvLyBXb3JsZCB0cmFuc2Zvcm1lZCB2ZXJzaW9uIG9mIC5mYWNlTm9ybWFscwoKICAgICAgdGhpcy53b3JsZEZhY2VOb3JtYWxzTmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICB0aGlzLnVuaXF1ZUF4ZXMgPSBheGVzID8gYXhlcy5zbGljZSgpIDogbnVsbDsKICAgICAgdGhpcy51bmlxdWVFZGdlcyA9IFtdOwogICAgICB0aGlzLmNvbXB1dGVFZGdlcygpOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyB1bmlxdWVFZGdlcwogICAgICovCgoKICAgIGNvbXB1dGVFZGdlcygpIHsKICAgICAgY29uc3QgZmFjZXMgPSB0aGlzLmZhY2VzOwogICAgICBjb25zdCB2ZXJ0aWNlcyA9IHRoaXMudmVydGljZXM7CiAgICAgIGNvbnN0IGVkZ2VzID0gdGhpcy51bmlxdWVFZGdlczsKICAgICAgZWRnZXMubGVuZ3RoID0gMDsKICAgICAgY29uc3QgZWRnZSA9IG5ldyBWZWMzKCk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gZmFjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBmYWNlID0gZmFjZXNbaV07CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBmYWNlLmxlbmd0aDsKCiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogIT09IG51bVZlcnRpY2VzOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGsgPSAoaiArIDEpICUgbnVtVmVydGljZXM7CiAgICAgICAgICB2ZXJ0aWNlc1tmYWNlW2pdXS52c3ViKHZlcnRpY2VzW2ZhY2Vba11dLCBlZGdlKTsKICAgICAgICAgIGVkZ2Uubm9ybWFsaXplKCk7CiAgICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTsKCiAgICAgICAgICBmb3IgKGxldCBwID0gMDsgcCAhPT0gZWRnZXMubGVuZ3RoOyBwKyspIHsKICAgICAgICAgICAgaWYgKGVkZ2VzW3BdLmFsbW9zdEVxdWFscyhlZGdlKSB8fCBlZGdlc1twXS5hbG1vc3RFcXVhbHMoZWRnZSkpIHsKICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWZvdW5kKSB7CiAgICAgICAgICAgIGVkZ2VzLnB1c2goZWRnZS5jbG9uZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZSB0aGUgbm9ybWFscyBvZiB0aGUgZmFjZXMuCiAgICAgKiBXaWxsIHJldXNlIGV4aXN0aW5nIFZlYzMgb2JqZWN0cyBpbiB0aGUgYGZhY2VOb3JtYWxzYCBhcnJheSBpZiB0aGV5IGV4aXN0LgogICAgICovCgoKICAgIGNvbXB1dGVOb3JtYWxzKCkgewogICAgICB0aGlzLmZhY2VOb3JtYWxzLmxlbmd0aCA9IHRoaXMuZmFjZXMubGVuZ3RoOyAvLyBHZW5lcmF0ZSBub3JtYWxzCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZmFjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAvLyBDaGVjayBzbyBhbGwgdmVydGljZXMgZXhpc3RzIGZvciB0aGlzIGZhY2UKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRoaXMuZmFjZXNbaV0ubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmICghdGhpcy52ZXJ0aWNlc1t0aGlzLmZhY2VzW2ldW2pdXSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFZlcnRleCAke3RoaXMuZmFjZXNbaV1bal19IG5vdCBmb3VuZCFgKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNvbnN0IG4gPSB0aGlzLmZhY2VOb3JtYWxzW2ldIHx8IG5ldyBWZWMzKCk7CiAgICAgICAgdGhpcy5nZXRGYWNlTm9ybWFsKGksIG4pOwogICAgICAgIG4ubmVnYXRlKG4pOwogICAgICAgIHRoaXMuZmFjZU5vcm1hbHNbaV0gPSBuOwogICAgICAgIGNvbnN0IHZlcnRleCA9IHRoaXMudmVydGljZXNbdGhpcy5mYWNlc1tpXVswXV07CgogICAgICAgIGlmIChuLmRvdCh2ZXJ0ZXgpIDwgMCkgewogICAgICAgICAgY29uc29sZS5lcnJvcihgLmZhY2VOb3JtYWxzWyR7aX1dID0gVmVjMygke24udG9TdHJpbmcoKX0pIGxvb2tzIGxpa2UgaXQgcG9pbnRzIGludG8gdGhlIHNoYXBlPyBUaGUgdmVydGljZXMgZm9sbG93LiBNYWtlIHN1cmUgdGhleSBhcmUgb3JkZXJlZCBDQ1cgYXJvdW5kIHRoZSBub3JtYWwsIHVzaW5nIHRoZSByaWdodCBoYW5kIHJ1bGUuYCk7CgogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0aGlzLmZhY2VzW2ldLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgLnZlcnRpY2VzWyR7dGhpcy5mYWNlc1tpXVtqXX1dID0gVmVjMygke3RoaXMudmVydGljZXNbdGhpcy5mYWNlc1tpXVtqXV0udG9TdHJpbmcoKX0pYCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGUgdGhlIG5vcm1hbCBvZiBhIGZhY2UgZnJvbSBpdHMgdmVydGljZXMKICAgICAqLwoKCiAgICBnZXRGYWNlTm9ybWFsKGksIHRhcmdldCkgewogICAgICBjb25zdCBmID0gdGhpcy5mYWNlc1tpXTsKICAgICAgY29uc3QgdmEgPSB0aGlzLnZlcnRpY2VzW2ZbMF1dOwogICAgICBjb25zdCB2YiA9IHRoaXMudmVydGljZXNbZlsxXV07CiAgICAgIGNvbnN0IHZjID0gdGhpcy52ZXJ0aWNlc1tmWzJdXTsKICAgICAgQ29udmV4UG9seWhlZHJvbi5jb21wdXRlTm9ybWFsKHZhLCB2YiwgdmMsIHRhcmdldCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBmYWNlIG5vcm1hbCBnaXZlbiAzIHZlcnRpY2VzCiAgICAgKi8KCgogICAgc3RhdGljIGNvbXB1dGVOb3JtYWwodmEsIHZiLCB2YywgdGFyZ2V0KSB7CiAgICAgIGNvbnN0IGNiID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgYWIgPSBuZXcgVmVjMygpOwogICAgICB2Yi52c3ViKHZhLCBhYik7CiAgICAgIHZjLnZzdWIodmIsIGNiKTsKICAgICAgY2IuY3Jvc3MoYWIsIHRhcmdldCk7CgogICAgICBpZiAoIXRhcmdldC5pc1plcm8oKSkgewogICAgICAgIHRhcmdldC5ub3JtYWxpemUoKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBAcGFyYW0gbWluRGlzdCBDbGFtcCBkaXN0YW5jZQogICAgICogQHBhcmFtIHJlc3VsdCBUaGUgYW4gYXJyYXkgb2YgY29udGFjdCBwb2ludCBvYmplY3RzLCBzZWUgY2xpcEZhY2VBZ2FpbnN0SHVsbAogICAgICovCgoKICAgIGNsaXBBZ2FpbnN0SHVsbChwb3NBLCBxdWF0QSwgaHVsbEIsIHBvc0IsIHF1YXRCLCBzZXBhcmF0aW5nTm9ybWFsLCBtaW5EaXN0LCBtYXhEaXN0LCByZXN1bHQpIHsKICAgICAgY29uc3QgV29ybGROb3JtYWwgPSBuZXcgVmVjMygpOwogICAgICBsZXQgY2xvc2VzdEZhY2VCID0gLTE7CiAgICAgIGxldCBkbWF4ID0gLU51bWJlci5NQVhfVkFMVUU7CgogICAgICBmb3IgKGxldCBmYWNlID0gMDsgZmFjZSA8IGh1bGxCLmZhY2VzLmxlbmd0aDsgZmFjZSsrKSB7CiAgICAgICAgV29ybGROb3JtYWwuY29weShodWxsQi5mYWNlTm9ybWFsc1tmYWNlXSk7CiAgICAgICAgcXVhdEIudm11bHQoV29ybGROb3JtYWwsIFdvcmxkTm9ybWFsKTsKICAgICAgICBjb25zdCBkID0gV29ybGROb3JtYWwuZG90KHNlcGFyYXRpbmdOb3JtYWwpOwoKICAgICAgICBpZiAoZCA+IGRtYXgpIHsKICAgICAgICAgIGRtYXggPSBkOwogICAgICAgICAgY2xvc2VzdEZhY2VCID0gZmFjZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHdvcmxkVmVydHNCMSA9IFtdOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBodWxsQi5mYWNlc1tjbG9zZXN0RmFjZUJdLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgYiA9IGh1bGxCLnZlcnRpY2VzW2h1bGxCLmZhY2VzW2Nsb3Nlc3RGYWNlQl1baV1dOwogICAgICAgIGNvbnN0IHdvcmxkYiA9IG5ldyBWZWMzKCk7CiAgICAgICAgd29ybGRiLmNvcHkoYik7CiAgICAgICAgcXVhdEIudm11bHQod29ybGRiLCB3b3JsZGIpOwogICAgICAgIHBvc0IudmFkZCh3b3JsZGIsIHdvcmxkYik7CiAgICAgICAgd29ybGRWZXJ0c0IxLnB1c2god29ybGRiKTsKICAgICAgfQoKICAgICAgaWYgKGNsb3Nlc3RGYWNlQiA+PSAwKSB7CiAgICAgICAgdGhpcy5jbGlwRmFjZUFnYWluc3RIdWxsKHNlcGFyYXRpbmdOb3JtYWwsIHBvc0EsIHF1YXRBLCB3b3JsZFZlcnRzQjEsIG1pbkRpc3QsIG1heERpc3QsIHJlc3VsdCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogRmluZCB0aGUgc2VwYXJhdGluZyBheGlzIGJldHdlZW4gdGhpcyBodWxsIGFuZCBhbm90aGVyCiAgICAgKiBAcGFyYW0gdGFyZ2V0IFRoZSB0YXJnZXQgdmVjdG9yIHRvIHNhdmUgdGhlIGF4aXMgaW4KICAgICAqIEByZXR1cm4gUmV0dXJucyBmYWxzZSBpZiBhIHNlcGFyYXRpb24gaXMgZm91bmQsIGVsc2UgdHJ1ZQogICAgICovCgoKICAgIGZpbmRTZXBhcmF0aW5nQXhpcyhodWxsQiwgcG9zQSwgcXVhdEEsIHBvc0IsIHF1YXRCLCB0YXJnZXQsIGZhY2VMaXN0QSwgZmFjZUxpc3RCKSB7CiAgICAgIGNvbnN0IGZhY2VBTm9ybWFsV1MzID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgV29ybGRub3JtYWwxID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgZGVsdGFDID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3Qgd29ybGRFZGdlMCA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHdvcmxkRWRnZTEgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBDcm9zcyA9IG5ldyBWZWMzKCk7CiAgICAgIGxldCBkbWluID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgY29uc3QgaHVsbEEgPSB0aGlzOwoKICAgICAgaWYgKCFodWxsQS51bmlxdWVBeGVzKSB7CiAgICAgICAgY29uc3QgbnVtRmFjZXNBID0gZmFjZUxpc3RBID8gZmFjZUxpc3RBLmxlbmd0aCA6IGh1bGxBLmZhY2VzLmxlbmd0aDsgLy8gVGVzdCBmYWNlIG5vcm1hbHMgZnJvbSBodWxsQQoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUZhY2VzQTsgaSsrKSB7CiAgICAgICAgICBjb25zdCBmaSA9IGZhY2VMaXN0QSA/IGZhY2VMaXN0QVtpXSA6IGk7IC8vIEdldCB3b3JsZCBmYWNlIG5vcm1hbAoKICAgICAgICAgIGZhY2VBTm9ybWFsV1MzLmNvcHkoaHVsbEEuZmFjZU5vcm1hbHNbZmldKTsKICAgICAgICAgIHF1YXRBLnZtdWx0KGZhY2VBTm9ybWFsV1MzLCBmYWNlQU5vcm1hbFdTMyk7CiAgICAgICAgICBjb25zdCBkID0gaHVsbEEudGVzdFNlcEF4aXMoZmFjZUFOb3JtYWxXUzMsIGh1bGxCLCBwb3NBLCBxdWF0QSwgcG9zQiwgcXVhdEIpOwoKICAgICAgICAgIGlmIChkID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGQgPCBkbWluKSB7CiAgICAgICAgICAgIGRtaW4gPSBkOwogICAgICAgICAgICB0YXJnZXQuY29weShmYWNlQU5vcm1hbFdTMyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIFRlc3QgdW5pcXVlIGF4ZXMKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gaHVsbEEudW5pcXVlQXhlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgLy8gR2V0IHdvcmxkIGF4aXMKICAgICAgICAgIHF1YXRBLnZtdWx0KGh1bGxBLnVuaXF1ZUF4ZXNbaV0sIGZhY2VBTm9ybWFsV1MzKTsKICAgICAgICAgIGNvbnN0IGQgPSBodWxsQS50ZXN0U2VwQXhpcyhmYWNlQU5vcm1hbFdTMywgaHVsbEIsIHBvc0EsIHF1YXRBLCBwb3NCLCBxdWF0Qik7CgogICAgICAgICAgaWYgKGQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZCA8IGRtaW4pIHsKICAgICAgICAgICAgZG1pbiA9IGQ7CiAgICAgICAgICAgIHRhcmdldC5jb3B5KGZhY2VBTm9ybWFsV1MzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghaHVsbEIudW5pcXVlQXhlcykgewogICAgICAgIC8vIFRlc3QgZmFjZSBub3JtYWxzIGZyb20gaHVsbEIKICAgICAgICBjb25zdCBudW1GYWNlc0IgPSBmYWNlTGlzdEIgPyBmYWNlTGlzdEIubGVuZ3RoIDogaHVsbEIuZmFjZXMubGVuZ3RoOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUZhY2VzQjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBmaSA9IGZhY2VMaXN0QiA/IGZhY2VMaXN0QltpXSA6IGk7CiAgICAgICAgICBXb3JsZG5vcm1hbDEuY29weShodWxsQi5mYWNlTm9ybWFsc1tmaV0pOwogICAgICAgICAgcXVhdEIudm11bHQoV29ybGRub3JtYWwxLCBXb3JsZG5vcm1hbDEpOwogICAgICAgICAgY29uc3QgZCA9IGh1bGxBLnRlc3RTZXBBeGlzKFdvcmxkbm9ybWFsMSwgaHVsbEIsIHBvc0EsIHF1YXRBLCBwb3NCLCBxdWF0Qik7CgogICAgICAgICAgaWYgKGQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZCA8IGRtaW4pIHsKICAgICAgICAgICAgZG1pbiA9IGQ7CiAgICAgICAgICAgIHRhcmdldC5jb3B5KFdvcmxkbm9ybWFsMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIFRlc3QgdW5pcXVlIGF4ZXMgaW4gQgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBodWxsQi51bmlxdWVBeGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBxdWF0Qi52bXVsdChodWxsQi51bmlxdWVBeGVzW2ldLCBXb3JsZG5vcm1hbDEpOwogICAgICAgICAgY29uc3QgZCA9IGh1bGxBLnRlc3RTZXBBeGlzKFdvcmxkbm9ybWFsMSwgaHVsbEIsIHBvc0EsIHF1YXRBLCBwb3NCLCBxdWF0Qik7CgogICAgICAgICAgaWYgKGQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZCA8IGRtaW4pIHsKICAgICAgICAgICAgZG1pbiA9IGQ7CiAgICAgICAgICAgIHRhcmdldC5jb3B5KFdvcmxkbm9ybWFsMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIFRlc3QgZWRnZXMKCgogICAgICBmb3IgKGxldCBlMCA9IDA7IGUwICE9PSBodWxsQS51bmlxdWVFZGdlcy5sZW5ndGg7IGUwKyspIHsKICAgICAgICAvLyBHZXQgd29ybGQgZWRnZQogICAgICAgIHF1YXRBLnZtdWx0KGh1bGxBLnVuaXF1ZUVkZ2VzW2UwXSwgd29ybGRFZGdlMCk7CgogICAgICAgIGZvciAobGV0IGUxID0gMDsgZTEgIT09IGh1bGxCLnVuaXF1ZUVkZ2VzLmxlbmd0aDsgZTErKykgewogICAgICAgICAgLy8gR2V0IHdvcmxkIGVkZ2UgMgogICAgICAgICAgcXVhdEIudm11bHQoaHVsbEIudW5pcXVlRWRnZXNbZTFdLCB3b3JsZEVkZ2UxKTsKICAgICAgICAgIHdvcmxkRWRnZTAuY3Jvc3Mod29ybGRFZGdlMSwgQ3Jvc3MpOwoKICAgICAgICAgIGlmICghQ3Jvc3MuYWxtb3N0WmVybygpKSB7CiAgICAgICAgICAgIENyb3NzLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBjb25zdCBkaXN0ID0gaHVsbEEudGVzdFNlcEF4aXMoQ3Jvc3MsIGh1bGxCLCBwb3NBLCBxdWF0QSwgcG9zQiwgcXVhdEIpOwoKICAgICAgICAgICAgaWYgKGRpc3QgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlzdCA8IGRtaW4pIHsKICAgICAgICAgICAgICBkbWluID0gZGlzdDsKICAgICAgICAgICAgICB0YXJnZXQuY29weShDcm9zcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHBvc0IudnN1Yihwb3NBLCBkZWx0YUMpOwoKICAgICAgaWYgKGRlbHRhQy5kb3QodGFyZ2V0KSA+IDAuMCkgewogICAgICAgIHRhcmdldC5uZWdhdGUodGFyZ2V0KTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIFRlc3Qgc2VwYXJhdGluZyBheGlzIGFnYWluc3QgdHdvIGh1bGxzLiBCb3RoIGh1bGxzIGFyZSBwcm9qZWN0ZWQgb250byB0aGUgYXhpcyBhbmQgdGhlIG92ZXJsYXAgc2l6ZSBpcyByZXR1cm5lZCBpZiB0aGVyZSBpcyBvbmUuCiAgICAgKiBAcmV0dXJuIFRoZSBvdmVybGFwIGRlcHRoLCBvciBGQUxTRSBpZiBubyBwZW5ldHJhdGlvbi4KICAgICAqLwoKCiAgICB0ZXN0U2VwQXhpcyhheGlzLCBodWxsQiwgcG9zQSwgcXVhdEEsIHBvc0IsIHF1YXRCKSB7CiAgICAgIGNvbnN0IGh1bGxBID0gdGhpczsKICAgICAgQ29udmV4UG9seWhlZHJvbi5wcm9qZWN0KGh1bGxBLCBheGlzLCBwb3NBLCBxdWF0QSwgbWF4bWluQSk7CiAgICAgIENvbnZleFBvbHloZWRyb24ucHJvamVjdChodWxsQiwgYXhpcywgcG9zQiwgcXVhdEIsIG1heG1pbkIpOwogICAgICBjb25zdCBtYXhBID0gbWF4bWluQVswXTsKICAgICAgY29uc3QgbWluQSA9IG1heG1pbkFbMV07CiAgICAgIGNvbnN0IG1heEIgPSBtYXhtaW5CWzBdOwogICAgICBjb25zdCBtaW5CID0gbWF4bWluQlsxXTsKCiAgICAgIGlmIChtYXhBIDwgbWluQiB8fCBtYXhCIDwgbWluQSkgewogICAgICAgIHJldHVybiBmYWxzZTsgLy8gU2VwYXJhdGVkCiAgICAgIH0KCiAgICAgIGNvbnN0IGQwID0gbWF4QSAtIG1pbkI7CiAgICAgIGNvbnN0IGQxID0gbWF4QiAtIG1pbkE7CiAgICAgIGNvbnN0IGRlcHRoID0gZDAgPCBkMSA/IGQwIDogZDE7CiAgICAgIHJldHVybiBkZXB0aDsKICAgIH0KICAgIC8qKgogICAgICogY2FsY3VsYXRlTG9jYWxJbmVydGlhCiAgICAgKi8KCgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICAvLyBBcHByb3hpbWF0ZSB3aXRoIGJveCBpbmVydGlhCiAgICAgIC8vIEV4YWN0IGluZXJ0aWEgY2FsY3VsYXRpb24gaXMgb3ZlcmtpbGwsIGJ1dCBzZWUgaHR0cDovL2dlb21ldHJpY3Rvb2xzLmNvbS9Eb2N1bWVudGF0aW9uL1BvbHloZWRyYWxNYXNzUHJvcGVydGllcy5wZGYgZm9yIHRoZSBjb3JyZWN0IHdheSB0byBkbyBpdAogICAgICBjb25zdCBhYWJibWF4ID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgYWFiYm1pbiA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuY29tcHV0ZUxvY2FsQUFCQihhYWJibWluLCBhYWJibWF4KTsKICAgICAgY29uc3QgeCA9IGFhYmJtYXgueCAtIGFhYmJtaW4ueDsKICAgICAgY29uc3QgeSA9IGFhYmJtYXgueSAtIGFhYmJtaW4ueTsKICAgICAgY29uc3QgeiA9IGFhYmJtYXgueiAtIGFhYmJtaW4uejsKICAgICAgdGFyZ2V0LnggPSAxLjAgLyAxMi4wICogbWFzcyAqICgyICogeSAqIDIgKiB5ICsgMiAqIHogKiAyICogeik7CiAgICAgIHRhcmdldC55ID0gMS4wIC8gMTIuMCAqIG1hc3MgKiAoMiAqIHggKiAyICogeCArIDIgKiB6ICogMiAqIHopOwogICAgICB0YXJnZXQueiA9IDEuMCAvIDEyLjAgKiBtYXNzICogKDIgKiB5ICogMiAqIHkgKyAyICogeCAqIDIgKiB4KTsKICAgIH0KICAgIC8qKgogICAgICogQHBhcmFtIGZhY2VfaSBJbmRleCBvZiB0aGUgZmFjZQogICAgICovCgoKICAgIGdldFBsYW5lQ29uc3RhbnRPZkZhY2UoZmFjZV9pKSB7CiAgICAgIGNvbnN0IGYgPSB0aGlzLmZhY2VzW2ZhY2VfaV07CiAgICAgIGNvbnN0IG4gPSB0aGlzLmZhY2VOb3JtYWxzW2ZhY2VfaV07CiAgICAgIGNvbnN0IHYgPSB0aGlzLnZlcnRpY2VzW2ZbMF1dOwogICAgICBjb25zdCBjID0gLW4uZG90KHYpOwogICAgICByZXR1cm4gYzsKICAgIH0KICAgIC8qKgogICAgICogQ2xpcCBhIGZhY2UgYWdhaW5zdCBhIGh1bGwuCiAgICAgKiBAcGFyYW0gd29ybGRWZXJ0c0IxIEFuIGFycmF5IG9mIFZlYzMgd2l0aCB2ZXJ0aWNlcyBpbiB0aGUgd29ybGQgZnJhbWUuCiAgICAgKiBAcGFyYW0gbWluRGlzdCBEaXN0YW5jZSBjbGFtcGluZwogICAgICogQHBhcmFtIEFycmF5IHJlc3VsdCBBcnJheSB0byBzdG9yZSByZXN1bHRpbmcgY29udGFjdCBwb2ludHMgaW4uIFdpbGwgYmUgb2JqZWN0cyB3aXRoIHByb3BlcnRpZXM6IHBvaW50LCBkZXB0aCwgbm9ybWFsLiBUaGVzZSBhcmUgcmVwcmVzZW50ZWQgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiAgICAgKi8KCgogICAgY2xpcEZhY2VBZ2FpbnN0SHVsbChzZXBhcmF0aW5nTm9ybWFsLCBwb3NBLCBxdWF0QSwgd29ybGRWZXJ0c0IxLCBtaW5EaXN0LCBtYXhEaXN0LCByZXN1bHQpIHsKICAgICAgY29uc3QgZmFjZUFOb3JtYWxXUyA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGVkZ2UwID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgV29ybGRFZGdlMCA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHdvcmxkUGxhbmVBbm9ybWFsMSA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHBsYW5lTm9ybWFsV1MxID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3Qgd29ybGRBMSA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGxvY2FsUGxhbmVOb3JtYWwgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBwbGFuZU5vcm1hbFdTID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgaHVsbEEgPSB0aGlzOwogICAgICBjb25zdCB3b3JsZFZlcnRzQjIgPSBbXTsKICAgICAgY29uc3QgcFZ0eEluID0gd29ybGRWZXJ0c0IxOwogICAgICBjb25zdCBwVnR4T3V0ID0gd29ybGRWZXJ0c0IyOwogICAgICBsZXQgY2xvc2VzdEZhY2VBID0gLTE7CiAgICAgIGxldCBkbWluID0gTnVtYmVyLk1BWF9WQUxVRTsgLy8gRmluZCB0aGUgZmFjZSB3aXRoIG5vcm1hbCBjbG9zZXN0IHRvIHRoZSBzZXBhcmF0aW5nIGF4aXMKCiAgICAgIGZvciAobGV0IGZhY2UgPSAwOyBmYWNlIDwgaHVsbEEuZmFjZXMubGVuZ3RoOyBmYWNlKyspIHsKICAgICAgICBmYWNlQU5vcm1hbFdTLmNvcHkoaHVsbEEuZmFjZU5vcm1hbHNbZmFjZV0pOwogICAgICAgIHF1YXRBLnZtdWx0KGZhY2VBTm9ybWFsV1MsIGZhY2VBTm9ybWFsV1MpOwogICAgICAgIGNvbnN0IGQgPSBmYWNlQU5vcm1hbFdTLmRvdChzZXBhcmF0aW5nTm9ybWFsKTsKCiAgICAgICAgaWYgKGQgPCBkbWluKSB7CiAgICAgICAgICBkbWluID0gZDsKICAgICAgICAgIGNsb3Nlc3RGYWNlQSA9IGZhY2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoY2xvc2VzdEZhY2VBIDwgMCkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBHZXQgdGhlIGZhY2UgYW5kIGNvbnN0cnVjdCBjb25uZWN0ZWQgZmFjZXMKCgogICAgICBjb25zdCBwb2x5QSA9IGh1bGxBLmZhY2VzW2Nsb3Nlc3RGYWNlQV07CiAgICAgIHBvbHlBLmNvbm5lY3RlZEZhY2VzID0gW107CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGh1bGxBLmZhY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBodWxsQS5mYWNlc1tpXS5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKAogICAgICAgICAgLyogU2hhcmluZyBhIHZlcnRleCovCiAgICAgICAgICBwb2x5QS5pbmRleE9mKGh1bGxBLmZhY2VzW2ldW2pdKSAhPT0gLTEgJiYKICAgICAgICAgIC8qIE5vdCB0aGUgb25lIHdlIGFyZSBsb29raW5nIGZvciBjb25uZWN0aW9ucyBmcm9tICovCiAgICAgICAgICBpICE9PSBjbG9zZXN0RmFjZUEgJiYKICAgICAgICAgIC8qIE5vdCBhbHJlYWR5IGFkZGVkICovCiAgICAgICAgICBwb2x5QS5jb25uZWN0ZWRGYWNlcy5pbmRleE9mKGkpID09PSAtMSkgewogICAgICAgICAgICBwb2x5QS5jb25uZWN0ZWRGYWNlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvLyBDbGlwIHRoZSBwb2x5Z29uIHRvIHRoZSBiYWNrIG9mIHRoZSBwbGFuZXMgb2YgYWxsIGZhY2VzIG9mIGh1bGwgQSwKICAgICAgLy8gdGhhdCBhcmUgYWRqYWNlbnQgdG8gdGhlIHdpdG5lc3MgZmFjZQoKCiAgICAgIGNvbnN0IG51bVZlcnRpY2VzQSA9IHBvbHlBLmxlbmd0aDsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtVmVydGljZXNBOyBpKyspIHsKICAgICAgICBjb25zdCBhID0gaHVsbEEudmVydGljZXNbcG9seUFbaV1dOwogICAgICAgIGNvbnN0IGIgPSBodWxsQS52ZXJ0aWNlc1twb2x5QVsoaSArIDEpICUgbnVtVmVydGljZXNBXV07CiAgICAgICAgYS52c3ViKGIsIGVkZ2UwKTsKICAgICAgICBXb3JsZEVkZ2UwLmNvcHkoZWRnZTApOwogICAgICAgIHF1YXRBLnZtdWx0KFdvcmxkRWRnZTAsIFdvcmxkRWRnZTApOwogICAgICAgIHBvc0EudmFkZChXb3JsZEVkZ2UwLCBXb3JsZEVkZ2UwKTsKICAgICAgICB3b3JsZFBsYW5lQW5vcm1hbDEuY29weSh0aGlzLmZhY2VOb3JtYWxzW2Nsb3Nlc3RGYWNlQV0pOwogICAgICAgIHF1YXRBLnZtdWx0KHdvcmxkUGxhbmVBbm9ybWFsMSwgd29ybGRQbGFuZUFub3JtYWwxKTsKICAgICAgICBwb3NBLnZhZGQod29ybGRQbGFuZUFub3JtYWwxLCB3b3JsZFBsYW5lQW5vcm1hbDEpOwogICAgICAgIFdvcmxkRWRnZTAuY3Jvc3Mod29ybGRQbGFuZUFub3JtYWwxLCBwbGFuZU5vcm1hbFdTMSk7CiAgICAgICAgcGxhbmVOb3JtYWxXUzEubmVnYXRlKHBsYW5lTm9ybWFsV1MxKTsKICAgICAgICB3b3JsZEExLmNvcHkoYSk7CiAgICAgICAgcXVhdEEudm11bHQod29ybGRBMSwgd29ybGRBMSk7CiAgICAgICAgcG9zQS52YWRkKHdvcmxkQTEsIHdvcmxkQTEpOwogICAgICAgIGNvbnN0IG90aGVyRmFjZSA9IHBvbHlBLmNvbm5lY3RlZEZhY2VzW2ldOwogICAgICAgIGxvY2FsUGxhbmVOb3JtYWwuY29weSh0aGlzLmZhY2VOb3JtYWxzW290aGVyRmFjZV0pOwogICAgICAgIGNvbnN0IGxvY2FsUGxhbmVFcSA9IHRoaXMuZ2V0UGxhbmVDb25zdGFudE9mRmFjZShvdGhlckZhY2UpOwogICAgICAgIHBsYW5lTm9ybWFsV1MuY29weShsb2NhbFBsYW5lTm9ybWFsKTsKICAgICAgICBxdWF0QS52bXVsdChwbGFuZU5vcm1hbFdTLCBwbGFuZU5vcm1hbFdTKTsKICAgICAgICBjb25zdCBwbGFuZUVxV1MgPSBsb2NhbFBsYW5lRXEgLSBwbGFuZU5vcm1hbFdTLmRvdChwb3NBKTsgLy8gQ2xpcCBmYWNlIGFnYWluc3Qgb3VyIGNvbnN0cnVjdGVkIHBsYW5lCgogICAgICAgIHRoaXMuY2xpcEZhY2VBZ2FpbnN0UGxhbmUocFZ0eEluLCBwVnR4T3V0LCBwbGFuZU5vcm1hbFdTLCBwbGFuZUVxV1MpOyAvLyBUaHJvdyBhd2F5IGFsbCBjbGlwcGVkIHBvaW50cywgYnV0IHNhdmUgdGhlIHJlbWFpbmluZyB1bnRpbCBuZXh0IGNsaXAKCiAgICAgICAgd2hpbGUgKHBWdHhJbi5sZW5ndGgpIHsKICAgICAgICAgIHBWdHhJbi5zaGlmdCgpOwogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKHBWdHhPdXQubGVuZ3RoKSB7CiAgICAgICAgICBwVnR4SW4ucHVzaChwVnR4T3V0LnNoaWZ0KCkpOwogICAgICAgIH0KICAgICAgfSAvLyBvbmx5IGtlZXAgY29udGFjdCBwb2ludHMgdGhhdCBhcmUgYmVoaW5kIHRoZSB3aXRuZXNzIGZhY2UKCgogICAgICBsb2NhbFBsYW5lTm9ybWFsLmNvcHkodGhpcy5mYWNlTm9ybWFsc1tjbG9zZXN0RmFjZUFdKTsKICAgICAgY29uc3QgbG9jYWxQbGFuZUVxID0gdGhpcy5nZXRQbGFuZUNvbnN0YW50T2ZGYWNlKGNsb3Nlc3RGYWNlQSk7CiAgICAgIHBsYW5lTm9ybWFsV1MuY29weShsb2NhbFBsYW5lTm9ybWFsKTsKICAgICAgcXVhdEEudm11bHQocGxhbmVOb3JtYWxXUywgcGxhbmVOb3JtYWxXUyk7CiAgICAgIGNvbnN0IHBsYW5lRXFXUyA9IGxvY2FsUGxhbmVFcSAtIHBsYW5lTm9ybWFsV1MuZG90KHBvc0EpOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwVnR4SW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICBsZXQgZGVwdGggPSBwbGFuZU5vcm1hbFdTLmRvdChwVnR4SW5baV0pICsgcGxhbmVFcVdTOyAvLyA/Pz8KCiAgICAgICAgaWYgKGRlcHRoIDw9IG1pbkRpc3QpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKGBjbGFtcGVkOiBkZXB0aD0ke2RlcHRofSB0byBtaW5EaXN0PSR7bWluRGlzdH1gKTsKICAgICAgICAgIGRlcHRoID0gbWluRGlzdDsKICAgICAgICB9CgogICAgICAgIGlmIChkZXB0aCA8PSBtYXhEaXN0KSB7CiAgICAgICAgICBjb25zdCBwb2ludCA9IHBWdHhJbltpXTsKCiAgICAgICAgICBpZiAoZGVwdGggPD0gMWUtNikgewogICAgICAgICAgICBjb25zdCBwID0gewogICAgICAgICAgICAgIHBvaW50LAogICAgICAgICAgICAgIG5vcm1hbDogcGxhbmVOb3JtYWxXUywKICAgICAgICAgICAgICBkZXB0aAogICAgICAgICAgICB9OwogICAgICAgICAgICByZXN1bHQucHVzaChwKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2xpcCBhIGZhY2UgaW4gYSBodWxsIGFnYWluc3QgdGhlIGJhY2sgb2YgYSBwbGFuZS4KICAgICAqIEBwYXJhbSBwbGFuZUNvbnN0YW50IFRoZSBjb25zdGFudCBpbiB0aGUgbWF0aGVtYXRpY2FsIHBsYW5lIGVxdWF0aW9uCiAgICAgKi8KCgogICAgY2xpcEZhY2VBZ2FpbnN0UGxhbmUoaW5WZXJ0aWNlcywgb3V0VmVydGljZXMsIHBsYW5lTm9ybWFsLCBwbGFuZUNvbnN0YW50KSB7CiAgICAgIGxldCBuX2RvdF9maXJzdDsKICAgICAgbGV0IG5fZG90X2xhc3Q7CiAgICAgIGNvbnN0IG51bVZlcnRzID0gaW5WZXJ0aWNlcy5sZW5ndGg7CgogICAgICBpZiAobnVtVmVydHMgPCAyKSB7CiAgICAgICAgcmV0dXJuIG91dFZlcnRpY2VzOwogICAgICB9CgogICAgICBsZXQgZmlyc3RWZXJ0ZXggPSBpblZlcnRpY2VzW2luVmVydGljZXMubGVuZ3RoIC0gMV07CiAgICAgIGxldCBsYXN0VmVydGV4ID0gaW5WZXJ0aWNlc1swXTsKICAgICAgbl9kb3RfZmlyc3QgPSBwbGFuZU5vcm1hbC5kb3QoZmlyc3RWZXJ0ZXgpICsgcGxhbmVDb25zdGFudDsKCiAgICAgIGZvciAobGV0IHZpID0gMDsgdmkgPCBudW1WZXJ0czsgdmkrKykgewogICAgICAgIGxhc3RWZXJ0ZXggPSBpblZlcnRpY2VzW3ZpXTsKICAgICAgICBuX2RvdF9sYXN0ID0gcGxhbmVOb3JtYWwuZG90KGxhc3RWZXJ0ZXgpICsgcGxhbmVDb25zdGFudDsKCiAgICAgICAgaWYgKG5fZG90X2ZpcnN0IDwgMCkgewogICAgICAgICAgaWYgKG5fZG90X2xhc3QgPCAwKSB7CiAgICAgICAgICAgIC8vIFN0YXJ0IDwgMCwgZW5kIDwgMCwgc28gb3V0cHV0IGxhc3RWZXJ0ZXgKICAgICAgICAgICAgY29uc3QgbmV3diA9IG5ldyBWZWMzKCk7CiAgICAgICAgICAgIG5ld3YuY29weShsYXN0VmVydGV4KTsKICAgICAgICAgICAgb3V0VmVydGljZXMucHVzaChuZXd2KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFN0YXJ0IDwgMCwgZW5kID49IDAsIHNvIG91dHB1dCBpbnRlcnNlY3Rpb24KICAgICAgICAgICAgY29uc3QgbmV3diA9IG5ldyBWZWMzKCk7CiAgICAgICAgICAgIGZpcnN0VmVydGV4LmxlcnAobGFzdFZlcnRleCwgbl9kb3RfZmlyc3QgLyAobl9kb3RfZmlyc3QgLSBuX2RvdF9sYXN0KSwgbmV3dik7CiAgICAgICAgICAgIG91dFZlcnRpY2VzLnB1c2gobmV3dik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChuX2RvdF9sYXN0IDwgMCkgewogICAgICAgICAgICAvLyBTdGFydCA+PSAwLCBlbmQgPCAwIHNvIG91dHB1dCBpbnRlcnNlY3Rpb24gYW5kIGVuZAogICAgICAgICAgICBjb25zdCBuZXd2ID0gbmV3IFZlYzMoKTsKICAgICAgICAgICAgZmlyc3RWZXJ0ZXgubGVycChsYXN0VmVydGV4LCBuX2RvdF9maXJzdCAvIChuX2RvdF9maXJzdCAtIG5fZG90X2xhc3QpLCBuZXd2KTsKICAgICAgICAgICAgb3V0VmVydGljZXMucHVzaChuZXd2KTsKICAgICAgICAgICAgb3V0VmVydGljZXMucHVzaChsYXN0VmVydGV4KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZpcnN0VmVydGV4ID0gbGFzdFZlcnRleDsKICAgICAgICBuX2RvdF9maXJzdCA9IG5fZG90X2xhc3Q7CiAgICAgIH0KCiAgICAgIHJldHVybiBvdXRWZXJ0aWNlczsKICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlcyBgLndvcmxkVmVydGljZXNgIGFuZCBzZXRzIGAud29ybGRWZXJ0aWNlc05lZWRzVXBkYXRlYCB0byBmYWxzZS4KICAgICAqLwoKCiAgICBjb21wdXRlV29ybGRWZXJ0aWNlcyhwb3NpdGlvbiwgcXVhdCkgewogICAgICB3aGlsZSAodGhpcy53b3JsZFZlcnRpY2VzLmxlbmd0aCA8IHRoaXMudmVydGljZXMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy53b3JsZFZlcnRpY2VzLnB1c2gobmV3IFZlYzMoKSk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHZlcnRzID0gdGhpcy52ZXJ0aWNlczsKICAgICAgY29uc3Qgd29ybGRWZXJ0cyA9IHRoaXMud29ybGRWZXJ0aWNlczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSB0aGlzLnZlcnRpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcXVhdC52bXVsdCh2ZXJ0c1tpXSwgd29ybGRWZXJ0c1tpXSk7CiAgICAgICAgcG9zaXRpb24udmFkZCh3b3JsZFZlcnRzW2ldLCB3b3JsZFZlcnRzW2ldKTsKICAgICAgfQoKICAgICAgdGhpcy53b3JsZFZlcnRpY2VzTmVlZHNVcGRhdGUgPSBmYWxzZTsKICAgIH0KCiAgICBjb21wdXRlTG9jYWxBQUJCKGFhYmJtaW4sIGFhYmJtYXgpIHsKICAgICAgY29uc3QgdmVydGljZXMgPSB0aGlzLnZlcnRpY2VzOwogICAgICBhYWJibWluLnNldChOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFKTsKICAgICAgYWFiYm1heC5zZXQoLU51bWJlci5NQVhfVkFMVUUsIC1OdW1iZXIuTUFYX1ZBTFVFLCAtTnVtYmVyLk1BWF9WQUxVRSk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudmVydGljZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB2ID0gdmVydGljZXNbaV07CgogICAgICAgIGlmICh2LnggPCBhYWJibWluLngpIHsKICAgICAgICAgIGFhYmJtaW4ueCA9IHYueDsKICAgICAgICB9IGVsc2UgaWYgKHYueCA+IGFhYmJtYXgueCkgewogICAgICAgICAgYWFiYm1heC54ID0gdi54OwogICAgICAgIH0KCiAgICAgICAgaWYgKHYueSA8IGFhYmJtaW4ueSkgewogICAgICAgICAgYWFiYm1pbi55ID0gdi55OwogICAgICAgIH0gZWxzZSBpZiAodi55ID4gYWFiYm1heC55KSB7CiAgICAgICAgICBhYWJibWF4LnkgPSB2Lnk7CiAgICAgICAgfQoKICAgICAgICBpZiAodi56IDwgYWFiYm1pbi56KSB7CiAgICAgICAgICBhYWJibWluLnogPSB2Lno7CiAgICAgICAgfSBlbHNlIGlmICh2LnogPiBhYWJibWF4LnopIHsKICAgICAgICAgIGFhYmJtYXgueiA9IHYuejsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlcyBgd29ybGRWZXJ0aWNlc2AgYW5kIHNldHMgYHdvcmxkVmVydGljZXNOZWVkc1VwZGF0ZWAgdG8gZmFsc2UuCiAgICAgKi8KCgogICAgY29tcHV0ZVdvcmxkRmFjZU5vcm1hbHMocXVhdCkgewogICAgICBjb25zdCBOID0gdGhpcy5mYWNlTm9ybWFscy5sZW5ndGg7CgogICAgICB3aGlsZSAodGhpcy53b3JsZEZhY2VOb3JtYWxzLmxlbmd0aCA8IE4pIHsKICAgICAgICB0aGlzLndvcmxkRmFjZU5vcm1hbHMucHVzaChuZXcgVmVjMygpKTsKICAgICAgfQoKICAgICAgY29uc3Qgbm9ybWFscyA9IHRoaXMuZmFjZU5vcm1hbHM7CiAgICAgIGNvbnN0IHdvcmxkTm9ybWFscyA9IHRoaXMud29ybGRGYWNlTm9ybWFsczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBxdWF0LnZtdWx0KG5vcm1hbHNbaV0sIHdvcmxkTm9ybWFsc1tpXSk7CiAgICAgIH0KCiAgICAgIHRoaXMud29ybGRGYWNlTm9ybWFsc05lZWRzVXBkYXRlID0gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzCiAgICAgKi8KCgogICAgdXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKSB7CiAgICAgIC8vIEFzc3VtZSBwb2ludHMgYXJlIGRpc3RyaWJ1dGVkIHdpdGggbG9jYWwgKDAsMCwwKSBhcyBjZW50ZXIKICAgICAgbGV0IG1heDIgPSAwOwogICAgICBjb25zdCB2ZXJ0cyA9IHRoaXMudmVydGljZXM7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gdmVydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBub3JtMiA9IHZlcnRzW2ldLmxlbmd0aFNxdWFyZWQoKTsKCiAgICAgICAgaWYgKG5vcm0yID4gbWF4MikgewogICAgICAgICAgbWF4MiA9IG5vcm0yOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyA9IE1hdGguc3FydChtYXgyKTsKICAgIH0KICAgIC8qKgogICAgICogY2FsY3VsYXRlV29ybGRBQUJCCiAgICAgKi8KCgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgY29uc3QgdmVydHMgPSB0aGlzLnZlcnRpY2VzOwogICAgICBsZXQgbWlueDsKICAgICAgbGV0IG1pbnk7CiAgICAgIGxldCBtaW56OwogICAgICBsZXQgbWF4eDsKICAgICAgbGV0IG1heHk7CiAgICAgIGxldCBtYXh6OwogICAgICBsZXQgdGVtcFdvcmxkVmVydGV4ID0gbmV3IFZlYzMoKTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0ZW1wV29ybGRWZXJ0ZXguY29weSh2ZXJ0c1tpXSk7CiAgICAgICAgcXVhdC52bXVsdCh0ZW1wV29ybGRWZXJ0ZXgsIHRlbXBXb3JsZFZlcnRleCk7CiAgICAgICAgcG9zLnZhZGQodGVtcFdvcmxkVmVydGV4LCB0ZW1wV29ybGRWZXJ0ZXgpOwogICAgICAgIGNvbnN0IHYgPSB0ZW1wV29ybGRWZXJ0ZXg7CgogICAgICAgIGlmIChtaW54ID09PSB1bmRlZmluZWQgfHwgdi54IDwgbWlueCkgewogICAgICAgICAgbWlueCA9IHYueDsKICAgICAgICB9CgogICAgICAgIGlmIChtYXh4ID09PSB1bmRlZmluZWQgfHwgdi54ID4gbWF4eCkgewogICAgICAgICAgbWF4eCA9IHYueDsKICAgICAgICB9CgogICAgICAgIGlmIChtaW55ID09PSB1bmRlZmluZWQgfHwgdi55IDwgbWlueSkgewogICAgICAgICAgbWlueSA9IHYueTsKICAgICAgICB9CgogICAgICAgIGlmIChtYXh5ID09PSB1bmRlZmluZWQgfHwgdi55ID4gbWF4eSkgewogICAgICAgICAgbWF4eSA9IHYueTsKICAgICAgICB9CgogICAgICAgIGlmIChtaW56ID09PSB1bmRlZmluZWQgfHwgdi56IDwgbWlueikgewogICAgICAgICAgbWlueiA9IHYuejsKICAgICAgICB9CgogICAgICAgIGlmIChtYXh6ID09PSB1bmRlZmluZWQgfHwgdi56ID4gbWF4eikgewogICAgICAgICAgbWF4eiA9IHYuejsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG1pbi5zZXQobWlueCwgbWlueSwgbWlueik7CiAgICAgIG1heC5zZXQobWF4eCwgbWF4eSwgbWF4eik7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhcHByb3hpbWF0ZSBjb252ZXggdm9sdW1lCiAgICAgKi8KCgogICAgdm9sdW1lKCkgewogICAgICByZXR1cm4gNC4wICogTWF0aC5QSSAqIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgLyAzLjA7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbiBhdmVyYWdlIG9mIGFsbCB0aGUgdmVydGljZXMgcG9zaXRpb25zCiAgICAgKi8KCgogICAgZ2V0QXZlcmFnZVBvaW50TG9jYWwodGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHZlcnRzID0gdGhpcy52ZXJ0aWNlczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0YXJnZXQudmFkZCh2ZXJ0c1tpXSwgdGFyZ2V0KTsKICAgICAgfQoKICAgICAgdGFyZ2V0LnNjYWxlKDEgLyB2ZXJ0cy5sZW5ndGgsIHRhcmdldCk7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIFRyYW5zZm9ybSBhbGwgbG9jYWwgcG9pbnRzLiBXaWxsIGNoYW5nZSB0aGUgLnZlcnRpY2VzCiAgICAgKi8KCgogICAgdHJhbnNmb3JtQWxsUG9pbnRzKG9mZnNldCwgcXVhdCkgewogICAgICBjb25zdCBuID0gdGhpcy52ZXJ0aWNlcy5sZW5ndGg7CiAgICAgIGNvbnN0IHZlcnRzID0gdGhpcy52ZXJ0aWNlczsgLy8gQXBwbHkgcm90YXRpb24KCiAgICAgIGlmIChxdWF0KSB7CiAgICAgICAgLy8gUm90YXRlIHZlcnRpY2VzCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHYgPSB2ZXJ0c1tpXTsKICAgICAgICAgIHF1YXQudm11bHQodiwgdik7CiAgICAgICAgfSAvLyBSb3RhdGUgZmFjZSBub3JtYWxzCgoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZmFjZU5vcm1hbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHYgPSB0aGlzLmZhY2VOb3JtYWxzW2ldOwogICAgICAgICAgcXVhdC52bXVsdCh2LCB2KTsKICAgICAgICB9CiAgICAgICAgLyoKICAgICAgICAgICAgICAvLyBSb3RhdGUgZWRnZXMKICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLnVuaXF1ZUVkZ2VzLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgY29uc3QgdiA9IHRoaXMudW5pcXVlRWRnZXNbaV07CiAgICAgICAgICAgICAgICAgIHF1YXQudm11bHQodix2KTsKICAgICAgICAgICAgICB9Ki8KCiAgICAgIH0gLy8gQXBwbHkgb2Zmc2V0CgoKICAgICAgaWYgKG9mZnNldCkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICBjb25zdCB2ID0gdmVydHNbaV07CiAgICAgICAgICB2LnZhZGQob2Zmc2V0LCB2KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2hlY2tzIHdoZXRoZXIgcCBpcyBpbnNpZGUgdGhlIHBvbHloZWRyYS4gTXVzdCBiZSBpbiBsb2NhbCBjb29yZHMuCiAgICAgKiBUaGUgcG9pbnQgbGllcyBvdXRzaWRlIG9mIHRoZSBjb252ZXggaHVsbCBvZiB0aGUgb3RoZXIgcG9pbnRzIGlmIGFuZCBvbmx5IGlmIHRoZSBkaXJlY3Rpb24KICAgICAqIG9mIGFsbCB0aGUgdmVjdG9ycyBmcm9tIGl0IHRvIHRob3NlIG90aGVyIHBvaW50cyBhcmUgb24gbGVzcyB0aGFuIG9uZSBoYWxmIG9mIGEgc3BoZXJlIGFyb3VuZCBpdC4KICAgICAqIEBwYXJhbSBwIEEgcG9pbnQgZ2l2ZW4gaW4gbG9jYWwgY29vcmRpbmF0ZXMKICAgICAqLwoKCiAgICBwb2ludElzSW5zaWRlKHApIHsKICAgICAgY29uc3QgdmVydHMgPSB0aGlzLnZlcnRpY2VzOwogICAgICBjb25zdCBmYWNlcyA9IHRoaXMuZmFjZXM7CiAgICAgIGNvbnN0IG5vcm1hbHMgPSB0aGlzLmZhY2VOb3JtYWxzOwogICAgICBjb25zdCBwb3NpdGl2ZVJlc3VsdCA9IG51bGw7CiAgICAgIGNvbnN0IHBvaW50SW5zaWRlID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5nZXRBdmVyYWdlUG9pbnRMb2NhbChwb2ludEluc2lkZSk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZmFjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBsZXQgbiA9IG5vcm1hbHNbaV07CiAgICAgICAgY29uc3QgdiA9IHZlcnRzW2ZhY2VzW2ldWzBdXTsgLy8gV2Ugb25seSBuZWVkIG9uZSBwb2ludCBpbiB0aGUgZmFjZQogICAgICAgIC8vIFRoaXMgZG90IHByb2R1Y3QgZGV0ZXJtaW5lcyB3aGljaCBzaWRlIG9mIHRoZSBlZGdlIHRoZSBwb2ludCBpcwoKICAgICAgICBjb25zdCB2VG9QID0gbmV3IFZlYzMoKTsKICAgICAgICBwLnZzdWIodiwgdlRvUCk7CiAgICAgICAgY29uc3QgcjEgPSBuLmRvdCh2VG9QKTsKICAgICAgICBjb25zdCB2VG9Qb2ludEluc2lkZSA9IG5ldyBWZWMzKCk7CiAgICAgICAgcG9pbnRJbnNpZGUudnN1Yih2LCB2VG9Qb2ludEluc2lkZSk7CiAgICAgICAgY29uc3QgcjIgPSBuLmRvdCh2VG9Qb2ludEluc2lkZSk7CgogICAgICAgIGlmIChyMSA8IDAgJiYgcjIgPiAwIHx8IHIxID4gMCAmJiByMiA8IDApIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gRW5jb3VudGVyZWQgc29tZSBvdGhlciBzaWduLiBFeGl0LgogICAgICAgIH0KICAgICAgfSAvLyBJZiB3ZSBnb3QgaGVyZSwgYWxsIGRvdCBwcm9kdWN0cyB3ZXJlIG9mIHRoZSBzYW1lIHNpZ24uCgoKICAgICAgcmV0dXJuIHBvc2l0aXZlUmVzdWx0ID8gMSA6IC0xOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgbWF4IGFuZCBtaW4gZG90IHByb2R1Y3Qgb2YgYSBjb252ZXggaHVsbCBhdCBwb3NpdGlvbiAocG9zLHF1YXQpIHByb2plY3RlZCBvbnRvIGFuIGF4aXMuCiAgICAgKiBSZXN1bHRzIGFyZSBzYXZlZCBpbiB0aGUgYXJyYXkgbWF4bWluLgogICAgICogQHBhcmFtIHJlc3VsdCByZXN1bHRbMF0gYW5kIHJlc3VsdFsxXSB3aWxsIGJlIHNldCB0byBtYXhpbXVtIGFuZCBtaW5pbXVtLCByZXNwZWN0aXZlbHkuCiAgICAgKi8KCgogICAgc3RhdGljIHByb2plY3Qoc2hhcGUsIGF4aXMsIHBvcywgcXVhdCwgcmVzdWx0KSB7CiAgICAgIGNvbnN0IG4gPSBzaGFwZS52ZXJ0aWNlcy5sZW5ndGg7CiAgICAgIGNvbnN0IGxvY2FsQXhpcyA9IHByb2plY3RfbG9jYWxBeGlzOwogICAgICBsZXQgbWF4ID0gMDsKICAgICAgbGV0IG1pbiA9IDA7CiAgICAgIGNvbnN0IGxvY2FsT3JpZ2luID0gcHJvamVjdF9sb2NhbE9yaWdpbjsKICAgICAgY29uc3QgdnMgPSBzaGFwZS52ZXJ0aWNlczsKICAgICAgbG9jYWxPcmlnaW4uc2V0WmVybygpOyAvLyBUcmFuc2Zvcm0gdGhlIGF4aXMgdG8gbG9jYWwKCiAgICAgIFRyYW5zZm9ybS52ZWN0b3JUb0xvY2FsRnJhbWUocG9zLCBxdWF0LCBheGlzLCBsb2NhbEF4aXMpOwogICAgICBUcmFuc2Zvcm0ucG9pbnRUb0xvY2FsRnJhbWUocG9zLCBxdWF0LCBsb2NhbE9yaWdpbiwgbG9jYWxPcmlnaW4pOwogICAgICBjb25zdCBhZGQgPSBsb2NhbE9yaWdpbi5kb3QobG9jYWxBeGlzKTsKICAgICAgbWluID0gbWF4ID0gdnNbMF0uZG90KGxvY2FsQXhpcyk7CgogICAgICBmb3IgKGxldCBpID0gMTsgaSA8IG47IGkrKykgewogICAgICAgIGNvbnN0IHZhbCA9IHZzW2ldLmRvdChsb2NhbEF4aXMpOwoKICAgICAgICBpZiAodmFsID4gbWF4KSB7CiAgICAgICAgICBtYXggPSB2YWw7CiAgICAgICAgfQoKICAgICAgICBpZiAodmFsIDwgbWluKSB7CiAgICAgICAgICBtaW4gPSB2YWw7CiAgICAgICAgfQogICAgICB9CgogICAgICBtaW4gLT0gYWRkOwogICAgICBtYXggLT0gYWRkOwoKICAgICAgaWYgKG1pbiA+IG1heCkgewogICAgICAgIC8vIEluY29uc2lzdGVudCAtIHN3YXAKICAgICAgICBjb25zdCB0ZW1wID0gbWluOwogICAgICAgIG1pbiA9IG1heDsKICAgICAgICBtYXggPSB0ZW1wOwogICAgICB9IC8vIE91dHB1dAoKCiAgICAgIHJlc3VsdFswXSA9IG1heDsKICAgICAgcmVzdWx0WzFdID0gbWluOwogICAgfQoKICB9CiAgY29uc3QgbWF4bWluQSA9IFtdOwogIGNvbnN0IG1heG1pbkIgPSBbXTsKICBuZXcgVmVjMygpOwogIGNvbnN0IHByb2plY3RfbG9jYWxBeGlzID0gbmV3IFZlYzMoKTsKICBjb25zdCBwcm9qZWN0X2xvY2FsT3JpZ2luID0gbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogQSAzZCBib3ggc2hhcGUuCiAgICogQGV4YW1wbGUKICAgKiAgICAgY29uc3Qgc2l6ZSA9IDEKICAgKiAgICAgY29uc3QgaGFsZkV4dGVudHMgPSBuZXcgQ0FOTk9OLlZlYzMoc2l6ZSwgc2l6ZSwgc2l6ZSkKICAgKiAgICAgY29uc3QgYm94U2hhcGUgPSBuZXcgQ0FOTk9OLkJveChoYWxmRXh0ZW50cykKICAgKiAgICAgY29uc3QgYm94Qm9keSA9IG5ldyBDQU5OT04uQm9keSh7IG1hc3M6IDEsIHNoYXBlOiBib3hTaGFwZSB9KQogICAqICAgICB3b3JsZC5hZGRCb2R5KGJveEJvZHkpCiAgICovCiAgY2xhc3MgQm94IGV4dGVuZHMgU2hhcGUgewogICAgLyoqCiAgICAgKiBUaGUgaGFsZiBleHRlbnRzIG9mIHRoZSBib3guCiAgICAgKi8KCiAgICAvKioKICAgICAqIFVzZWQgYnkgdGhlIGNvbnRhY3QgZ2VuZXJhdG9yIHRvIG1ha2UgY29udGFjdHMgd2l0aCBvdGhlciBjb252ZXggcG9seWhlZHJhIGZvciBleGFtcGxlLgogICAgICovCiAgICBjb25zdHJ1Y3RvcihoYWxmRXh0ZW50cykgewogICAgICBzdXBlcih7CiAgICAgICAgdHlwZTogU2hhcGUudHlwZXMuQk9YCiAgICAgIH0pOwogICAgICB0aGlzLmhhbGZFeHRlbnRzID0gaGFsZkV4dGVudHM7CiAgICAgIHRoaXMuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uID0gbnVsbDsKICAgICAgdGhpcy51cGRhdGVDb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24oKTsKICAgICAgdGhpcy51cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpOwogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGVzIHRoZSBsb2NhbCBjb252ZXggcG9seWhlZHJvbiByZXByZXNlbnRhdGlvbiB1c2VkIGZvciBzb21lIGNvbGxpc2lvbnMuCiAgICAgKi8KCgogICAgdXBkYXRlQ29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uKCkgewogICAgICBjb25zdCBzeCA9IHRoaXMuaGFsZkV4dGVudHMueDsKICAgICAgY29uc3Qgc3kgPSB0aGlzLmhhbGZFeHRlbnRzLnk7CiAgICAgIGNvbnN0IHN6ID0gdGhpcy5oYWxmRXh0ZW50cy56OwogICAgICBjb25zdCBWID0gVmVjMzsKICAgICAgY29uc3QgdmVydGljZXMgPSBbbmV3IFYoLXN4LCAtc3ksIC1zeiksIG5ldyBWKHN4LCAtc3ksIC1zeiksIG5ldyBWKHN4LCBzeSwgLXN6KSwgbmV3IFYoLXN4LCBzeSwgLXN6KSwgbmV3IFYoLXN4LCAtc3ksIHN6KSwgbmV3IFYoc3gsIC1zeSwgc3opLCBuZXcgVihzeCwgc3ksIHN6KSwgbmV3IFYoLXN4LCBzeSwgc3opXTsKICAgICAgY29uc3QgZmFjZXMgPSBbWzMsIDIsIDEsIDBdLCAvLyAtegogICAgICBbNCwgNSwgNiwgN10sIC8vICt6CiAgICAgIFs1LCA0LCAwLCAxXSwgLy8gLXkKICAgICAgWzIsIDMsIDcsIDZdLCAvLyAreQogICAgICBbMCwgNCwgNywgM10sIC8vIC14CiAgICAgIFsxLCAyLCA2LCA1XSAvLyAreAogICAgICBdOwogICAgICBjb25zdCBheGVzID0gW25ldyBWKDAsIDAsIDEpLCBuZXcgVigwLCAxLCAwKSwgbmV3IFYoMSwgMCwgMCldOwogICAgICBjb25zdCBoID0gbmV3IENvbnZleFBvbHloZWRyb24oewogICAgICAgIHZlcnRpY2VzLAogICAgICAgIGZhY2VzLAogICAgICAgIGF4ZXMKICAgICAgfSk7CiAgICAgIHRoaXMuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uID0gaDsKICAgICAgaC5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWw7CiAgICB9CiAgICAvKioKICAgICAqIENhbGN1bGF0ZSB0aGUgaW5lcnRpYSBvZiB0aGUgYm94LgogICAgICovCgoKICAgIGNhbGN1bGF0ZUxvY2FsSW5lcnRpYShtYXNzLCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgQm94LmNhbGN1bGF0ZUluZXJ0aWEodGhpcy5oYWxmRXh0ZW50cywgbWFzcywgdGFyZ2V0KTsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KCiAgICBzdGF0aWMgY2FsY3VsYXRlSW5lcnRpYShoYWxmRXh0ZW50cywgbWFzcywgdGFyZ2V0KSB7CiAgICAgIGNvbnN0IGUgPSBoYWxmRXh0ZW50czsKICAgICAgdGFyZ2V0LnggPSAxLjAgLyAxMi4wICogbWFzcyAqICgyICogZS55ICogMiAqIGUueSArIDIgKiBlLnogKiAyICogZS56KTsKICAgICAgdGFyZ2V0LnkgPSAxLjAgLyAxMi4wICogbWFzcyAqICgyICogZS54ICogMiAqIGUueCArIDIgKiBlLnogKiAyICogZS56KTsKICAgICAgdGFyZ2V0LnogPSAxLjAgLyAxMi4wICogbWFzcyAqICgyICogZS55ICogMiAqIGUueSArIDIgKiBlLnggKiAyICogZS54KTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBib3ggNiBzaWRlIG5vcm1hbHMKICAgICAqIEBwYXJhbSBzaXhUYXJnZXRWZWN0b3JzIEFuIGFycmF5IG9mIDYgdmVjdG9ycywgdG8gc3RvcmUgdGhlIHJlc3VsdGluZyBzaWRlIG5vcm1hbHMgaW4uCiAgICAgKiBAcGFyYW0gcXVhdCBPcmllbnRhdGlvbiB0byBhcHBseSB0byB0aGUgbm9ybWFsIHZlY3RvcnMuIElmIG5vdCBwcm92aWRlZCwgdGhlIHZlY3RvcnMgd2lsbCBiZSBpbiByZXNwZWN0IHRvIHRoZSBsb2NhbCBmcmFtZS4KICAgICAqLwoKCiAgICBnZXRTaWRlTm9ybWFscyhzaXhUYXJnZXRWZWN0b3JzLCBxdWF0KSB7CiAgICAgIGNvbnN0IHNpZGVzID0gc2l4VGFyZ2V0VmVjdG9yczsKICAgICAgY29uc3QgZXggPSB0aGlzLmhhbGZFeHRlbnRzOwogICAgICBzaWRlc1swXS5zZXQoZXgueCwgMCwgMCk7CiAgICAgIHNpZGVzWzFdLnNldCgwLCBleC55LCAwKTsKICAgICAgc2lkZXNbMl0uc2V0KDAsIDAsIGV4LnopOwogICAgICBzaWRlc1szXS5zZXQoLWV4LngsIDAsIDApOwogICAgICBzaWRlc1s0XS5zZXQoMCwgLWV4LnksIDApOwogICAgICBzaWRlc1s1XS5zZXQoMCwgMCwgLWV4LnopOwoKICAgICAgaWYgKHF1YXQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBzaWRlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgcXVhdC52bXVsdChzaWRlc1tpXSwgc2lkZXNbaV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHNpZGVzOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSB2b2x1bWUgb2YgdGhlIGJveC4KICAgICAqLwoKCiAgICB2b2x1bWUoKSB7CiAgICAgIHJldHVybiA4LjAgKiB0aGlzLmhhbGZFeHRlbnRzLnggKiB0aGlzLmhhbGZFeHRlbnRzLnkgKiB0aGlzLmhhbGZFeHRlbnRzLno7CiAgICB9CiAgICAvKioKICAgICAqIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzCiAgICAgKi8KCgogICAgdXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKSB7CiAgICAgIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgPSB0aGlzLmhhbGZFeHRlbnRzLmxlbmd0aCgpOwogICAgfQogICAgLyoqCiAgICAgKiBmb3JFYWNoV29ybGRDb3JuZXIKICAgICAqLwoKCiAgICBmb3JFYWNoV29ybGRDb3JuZXIocG9zLCBxdWF0LCBjYWxsYmFjaykgewogICAgICBjb25zdCBlID0gdGhpcy5oYWxmRXh0ZW50czsKICAgICAgY29uc3QgY29ybmVycyA9IFtbZS54LCBlLnksIGUuel0sIFstZS54LCBlLnksIGUuel0sIFstZS54LCAtZS55LCBlLnpdLCBbLWUueCwgLWUueSwgLWUuel0sIFtlLngsIC1lLnksIC1lLnpdLCBbZS54LCBlLnksIC1lLnpdLCBbLWUueCwgZS55LCAtZS56XSwgW2UueCwgLWUueSwgZS56XV07CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvcm5lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICB3b3JsZENvcm5lclRlbXBQb3Muc2V0KGNvcm5lcnNbaV1bMF0sIGNvcm5lcnNbaV1bMV0sIGNvcm5lcnNbaV1bMl0pOwogICAgICAgIHF1YXQudm11bHQod29ybGRDb3JuZXJUZW1wUG9zLCB3b3JsZENvcm5lclRlbXBQb3MpOwogICAgICAgIHBvcy52YWRkKHdvcmxkQ29ybmVyVGVtcFBvcywgd29ybGRDb3JuZXJUZW1wUG9zKTsKICAgICAgICBjYWxsYmFjayh3b3JsZENvcm5lclRlbXBQb3MueCwgd29ybGRDb3JuZXJUZW1wUG9zLnksIHdvcmxkQ29ybmVyVGVtcFBvcy56KTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBjYWxjdWxhdGVXb3JsZEFBQkIKICAgICAqLwoKCiAgICBjYWxjdWxhdGVXb3JsZEFBQkIocG9zLCBxdWF0LCBtaW4sIG1heCkgewogICAgICBjb25zdCBlID0gdGhpcy5oYWxmRXh0ZW50czsKICAgICAgd29ybGRDb3JuZXJzVGVtcFswXS5zZXQoZS54LCBlLnksIGUueik7CiAgICAgIHdvcmxkQ29ybmVyc1RlbXBbMV0uc2V0KC1lLngsIGUueSwgZS56KTsKICAgICAgd29ybGRDb3JuZXJzVGVtcFsyXS5zZXQoLWUueCwgLWUueSwgZS56KTsKICAgICAgd29ybGRDb3JuZXJzVGVtcFszXS5zZXQoLWUueCwgLWUueSwgLWUueik7CiAgICAgIHdvcmxkQ29ybmVyc1RlbXBbNF0uc2V0KGUueCwgLWUueSwgLWUueik7CiAgICAgIHdvcmxkQ29ybmVyc1RlbXBbNV0uc2V0KGUueCwgZS55LCAtZS56KTsKICAgICAgd29ybGRDb3JuZXJzVGVtcFs2XS5zZXQoLWUueCwgZS55LCAtZS56KTsKICAgICAgd29ybGRDb3JuZXJzVGVtcFs3XS5zZXQoZS54LCAtZS55LCBlLnopOwogICAgICBjb25zdCB3YyA9IHdvcmxkQ29ybmVyc1RlbXBbMF07CiAgICAgIHF1YXQudm11bHQod2MsIHdjKTsKICAgICAgcG9zLnZhZGQod2MsIHdjKTsKICAgICAgbWF4LmNvcHkod2MpOwogICAgICBtaW4uY29weSh3Yyk7CgogICAgICBmb3IgKGxldCBpID0gMTsgaSA8IDg7IGkrKykgewogICAgICAgIGNvbnN0IHdjID0gd29ybGRDb3JuZXJzVGVtcFtpXTsKICAgICAgICBxdWF0LnZtdWx0KHdjLCB3Yyk7CiAgICAgICAgcG9zLnZhZGQod2MsIHdjKTsKICAgICAgICBjb25zdCB4ID0gd2MueDsKICAgICAgICBjb25zdCB5ID0gd2MueTsKICAgICAgICBjb25zdCB6ID0gd2MuejsKCiAgICAgICAgaWYgKHggPiBtYXgueCkgewogICAgICAgICAgbWF4LnggPSB4OwogICAgICAgIH0KCiAgICAgICAgaWYgKHkgPiBtYXgueSkgewogICAgICAgICAgbWF4LnkgPSB5OwogICAgICAgIH0KCiAgICAgICAgaWYgKHogPiBtYXgueikgewogICAgICAgICAgbWF4LnogPSB6OwogICAgICAgIH0KCiAgICAgICAgaWYgKHggPCBtaW4ueCkgewogICAgICAgICAgbWluLnggPSB4OwogICAgICAgIH0KCiAgICAgICAgaWYgKHkgPCBtaW4ueSkgewogICAgICAgICAgbWluLnkgPSB5OwogICAgICAgIH0KCiAgICAgICAgaWYgKHogPCBtaW4ueikgewogICAgICAgICAgbWluLnogPSB6OwogICAgICAgIH0KICAgICAgfSAvLyBHZXQgZWFjaCBheGlzIG1heAogICAgICAvLyBtaW4uc2V0KEluZmluaXR5LEluZmluaXR5LEluZmluaXR5KTsKICAgICAgLy8gbWF4LnNldCgtSW5maW5pdHksLUluZmluaXR5LC1JbmZpbml0eSk7CiAgICAgIC8vIHRoaXMuZm9yRWFjaFdvcmxkQ29ybmVyKHBvcyxxdWF0LGZ1bmN0aW9uKHgseSx6KXsKICAgICAgLy8gICAgIGlmKHggPiBtYXgueCl7CiAgICAgIC8vICAgICAgICAgbWF4LnggPSB4OwogICAgICAvLyAgICAgfQogICAgICAvLyAgICAgaWYoeSA+IG1heC55KXsKICAgICAgLy8gICAgICAgICBtYXgueSA9IHk7CiAgICAgIC8vICAgICB9CiAgICAgIC8vICAgICBpZih6ID4gbWF4LnopewogICAgICAvLyAgICAgICAgIG1heC56ID0gejsKICAgICAgLy8gICAgIH0KICAgICAgLy8gICAgIGlmKHggPCBtaW4ueCl7CiAgICAgIC8vICAgICAgICAgbWluLnggPSB4OwogICAgICAvLyAgICAgfQogICAgICAvLyAgICAgaWYoeSA8IG1pbi55KXsKICAgICAgLy8gICAgICAgICBtaW4ueSA9IHk7CiAgICAgIC8vICAgICB9CiAgICAgIC8vICAgICBpZih6IDwgbWluLnopewogICAgICAvLyAgICAgICAgIG1pbi56ID0gejsKICAgICAgLy8gICAgIH0KICAgICAgLy8gfSk7CgogICAgfQoKICB9CiAgY29uc3Qgd29ybGRDb3JuZXJUZW1wUG9zID0gbmV3IFZlYzMoKTsKICBjb25zdCB3b3JsZENvcm5lcnNUZW1wID0gW25ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCldOwoKICAvKioKICAgKiBCT0RZX1RZUEVTCiAgICovCiAgY29uc3QgQk9EWV9UWVBFUyA9IHsKICAgIC8qKiBEWU5BTUlDICovCiAgICBEWU5BTUlDOiAxLAoKICAgIC8qKiBTVEFUSUMgKi8KICAgIFNUQVRJQzogMiwKCiAgICAvKiogS0lORU1BVElDICovCiAgICBLSU5FTUFUSUM6IDQKICB9OwogIC8qKgogICAqIEJvZHlUeXBlCiAgICovCgogIC8qKgogICAqIEJPRFlfU0xFRVBfU1RBVEVTCiAgICovCiAgY29uc3QgQk9EWV9TTEVFUF9TVEFURVMgPSB7CiAgICAvKiogQVdBS0UgKi8KICAgIEFXQUtFOiAwLAoKICAgIC8qKiBTTEVFUFkgKi8KICAgIFNMRUVQWTogMSwKCiAgICAvKiogU0xFRVBJTkcgKi8KICAgIFNMRUVQSU5HOiAyCiAgfTsKICAvKioKICAgKiBCb2R5U2xlZXBTdGF0ZQogICAqLwoKICAvKioKICAgKiBCYXNlIGNsYXNzIGZvciBhbGwgYm9keSB0eXBlcy4KICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCBzaGFwZSA9IG5ldyBDQU5OT04uU3BoZXJlKDEpCiAgICogICAgIGNvbnN0IGJvZHkgPSBuZXcgQ0FOTk9OLkJvZHkoewogICAqICAgICAgIG1hc3M6IDEsCiAgICogICAgICAgc2hhcGUsCiAgICogICAgIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkoYm9keSkKICAgKi8KICBjbGFzcyBCb2R5IGV4dGVuZHMgRXZlbnRUYXJnZXQgewogICAgLyoqCiAgICAgKiBEaXNwYXRjaGVkIGFmdGVyIHR3byBib2RpZXMgY29sbGlkZS4gVGhpcyBldmVudCBpcyBkaXNwYXRjaGVkIG9uIGVhY2gKICAgICAqIG9mIHRoZSB0d28gYm9kaWVzIGludm9sdmVkIGluIHRoZSBjb2xsaXNpb24uCiAgICAgKiBAZXZlbnQgY29sbGlkZQogICAgICogQHBhcmFtIGJvZHkgVGhlIGJvZHkgdGhhdCB3YXMgaW52b2x2ZWQgaW4gdGhlIGNvbGxpc2lvbi4KICAgICAqIEBwYXJhbSBjb250YWN0IFRoZSBkZXRhaWxzIG9mIHRoZSBjb2xsaXNpb24uCiAgICAgKi8KCiAgICAvKioKICAgICAqIEEgZHluYW1pYyBib2R5IGlzIGZ1bGx5IHNpbXVsYXRlZC4gQ2FuIGJlIG1vdmVkIG1hbnVhbGx5IGJ5IHRoZSB1c2VyLCBidXQgbm9ybWFsbHkgdGhleSBtb3ZlIGFjY29yZGluZyB0byBmb3JjZXMuIEEgZHluYW1pYyBib2R5IGNhbiBjb2xsaWRlIHdpdGggYWxsIGJvZHkgdHlwZXMuIEEgZHluYW1pYyBib2R5IGFsd2F5cyBoYXMgZmluaXRlLCBub24temVybyBtYXNzLgogICAgICovCgogICAgLyoqCiAgICAgKiBBIHN0YXRpYyBib2R5IGRvZXMgbm90IG1vdmUgZHVyaW5nIHNpbXVsYXRpb24gYW5kIGJlaGF2ZXMgYXMgaWYgaXQgaGFzIGluZmluaXRlIG1hc3MuIFN0YXRpYyBib2RpZXMgY2FuIGJlIG1vdmVkIG1hbnVhbGx5IGJ5IHNldHRpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSBib2R5LiBUaGUgdmVsb2NpdHkgb2YgYSBzdGF0aWMgYm9keSBpcyBhbHdheXMgemVyby4gU3RhdGljIGJvZGllcyBkbyBub3QgY29sbGlkZSB3aXRoIG90aGVyIHN0YXRpYyBvciBraW5lbWF0aWMgYm9kaWVzLgogICAgICovCgogICAgLyoqCiAgICAgKiBBIGtpbmVtYXRpYyBib2R5IG1vdmVzIHVuZGVyIHNpbXVsYXRpb24gYWNjb3JkaW5nIHRvIGl0cyB2ZWxvY2l0eS4gVGhleSBkbyBub3QgcmVzcG9uZCB0byBmb3JjZXMuIFRoZXkgY2FuIGJlIG1vdmVkIG1hbnVhbGx5LCBidXQgbm9ybWFsbHkgYSBraW5lbWF0aWMgYm9keSBpcyBtb3ZlZCBieSBzZXR0aW5nIGl0cyB2ZWxvY2l0eS4gQSBraW5lbWF0aWMgYm9keSBiZWhhdmVzIGFzIGlmIGl0IGhhcyBpbmZpbml0ZSBtYXNzLiBLaW5lbWF0aWMgYm9kaWVzIGRvIG5vdCBjb2xsaWRlIHdpdGggb3RoZXIgc3RhdGljIG9yIGtpbmVtYXRpYyBib2RpZXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFXQUtFCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNMRUVQWQogICAgICovCgogICAgLyoqCiAgICAgKiBTTEVFUElORwogICAgICovCgogICAgLyoqCiAgICAgKiBEaXNwYXRjaGVkIGFmdGVyIGEgc2xlZXBpbmcgYm9keSBoYXMgd29rZW4gdXAuCiAgICAgKiBAZXZlbnQgd2FrZXVwCiAgICAgKi8KCiAgICAvKioKICAgICAqIERpc3BhdGNoZWQgYWZ0ZXIgYSBib2R5IGhhcyBnb25lIGluIHRvIHRoZSBzbGVlcHkgc3RhdGUuCiAgICAgKiBAZXZlbnQgc2xlZXB5CiAgICAgKi8KCiAgICAvKioKICAgICAqIERpc3BhdGNoZWQgYWZ0ZXIgYSBib2R5IGhhcyBmYWxsZW4gYXNsZWVwLgogICAgICogQGV2ZW50IHNsZWVwCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5pZCA9IEJvZHkuaWRDb3VudGVyKys7CiAgICAgIHRoaXMuaW5kZXggPSAtMTsKICAgICAgdGhpcy53b3JsZCA9IG51bGw7CiAgICAgIHRoaXMudmxhbWJkYSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuY29sbGlzaW9uRmlsdGVyR3JvdXAgPSB0eXBlb2Ygb3B0aW9ucy5jb2xsaXNpb25GaWx0ZXJHcm91cCA9PT0gJ251bWJlcicgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwIDogMTsKICAgICAgdGhpcy5jb2xsaXNpb25GaWx0ZXJNYXNrID0gdHlwZW9mIG9wdGlvbnMuY29sbGlzaW9uRmlsdGVyTWFzayA9PT0gJ251bWJlcicgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlck1hc2sgOiAtMTsKICAgICAgdGhpcy5jb2xsaXNpb25SZXNwb25zZSA9IHR5cGVvZiBvcHRpb25zLmNvbGxpc2lvblJlc3BvbnNlID09PSAnYm9vbGVhbicgPyBvcHRpb25zLmNvbGxpc2lvblJlc3BvbnNlIDogdHJ1ZTsKICAgICAgdGhpcy5wb3NpdGlvbiA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMucHJldmlvdXNQb3NpdGlvbiA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaW50ZXJwb2xhdGVkUG9zaXRpb24gPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmluaXRQb3NpdGlvbiA9IG5ldyBWZWMzKCk7CgogICAgICBpZiAob3B0aW9ucy5wb3NpdGlvbikgewogICAgICAgIHRoaXMucG9zaXRpb24uY29weShvcHRpb25zLnBvc2l0aW9uKTsKICAgICAgICB0aGlzLnByZXZpb3VzUG9zaXRpb24uY29weShvcHRpb25zLnBvc2l0aW9uKTsKICAgICAgICB0aGlzLmludGVycG9sYXRlZFBvc2l0aW9uLmNvcHkob3B0aW9ucy5wb3NpdGlvbik7CiAgICAgICAgdGhpcy5pbml0UG9zaXRpb24uY29weShvcHRpb25zLnBvc2l0aW9uKTsKICAgICAgfQoKICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBWZWMzKCk7CgogICAgICBpZiAob3B0aW9ucy52ZWxvY2l0eSkgewogICAgICAgIHRoaXMudmVsb2NpdHkuY29weShvcHRpb25zLnZlbG9jaXR5KTsKICAgICAgfQoKICAgICAgdGhpcy5pbml0VmVsb2NpdHkgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmZvcmNlID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgbWFzcyA9IHR5cGVvZiBvcHRpb25zLm1hc3MgPT09ICdudW1iZXInID8gb3B0aW9ucy5tYXNzIDogMDsKICAgICAgdGhpcy5tYXNzID0gbWFzczsKICAgICAgdGhpcy5pbnZNYXNzID0gbWFzcyA+IDAgPyAxLjAgLyBtYXNzIDogMDsKICAgICAgdGhpcy5tYXRlcmlhbCA9IG9wdGlvbnMubWF0ZXJpYWwgfHwgbnVsbDsKICAgICAgdGhpcy5saW5lYXJEYW1waW5nID0gdHlwZW9mIG9wdGlvbnMubGluZWFyRGFtcGluZyA9PT0gJ251bWJlcicgPyBvcHRpb25zLmxpbmVhckRhbXBpbmcgOiAwLjAxOwogICAgICB0aGlzLnR5cGUgPSBtYXNzIDw9IDAuMCA/IEJvZHkuU1RBVElDIDogQm9keS5EWU5BTUlDOwoKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLnR5cGUgPT09IHR5cGVvZiBCb2R5LlNUQVRJQykgewogICAgICAgIHRoaXMudHlwZSA9IG9wdGlvbnMudHlwZTsKICAgICAgfQoKICAgICAgdGhpcy5hbGxvd1NsZWVwID0gdHlwZW9mIG9wdGlvbnMuYWxsb3dTbGVlcCAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmFsbG93U2xlZXAgOiB0cnVlOwogICAgICB0aGlzLnNsZWVwU3RhdGUgPSBCb2R5LkFXQUtFOwogICAgICB0aGlzLnNsZWVwU3BlZWRMaW1pdCA9IHR5cGVvZiBvcHRpb25zLnNsZWVwU3BlZWRMaW1pdCAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLnNsZWVwU3BlZWRMaW1pdCA6IDAuMTsKICAgICAgdGhpcy5zbGVlcFRpbWVMaW1pdCA9IHR5cGVvZiBvcHRpb25zLnNsZWVwVGltZUxpbWl0ICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuc2xlZXBUaW1lTGltaXQgOiAxOwogICAgICB0aGlzLnRpbWVMYXN0U2xlZXB5ID0gMDsKICAgICAgdGhpcy53YWtlVXBBZnRlck5hcnJvd3BoYXNlID0gZmFsc2U7CiAgICAgIHRoaXMudG9ycXVlID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5xdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgdGhpcy5pbml0UXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHRoaXMucHJldmlvdXNRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgdGhpcy5pbnRlcnBvbGF0ZWRRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKCiAgICAgIGlmIChvcHRpb25zLnF1YXRlcm5pb24pIHsKICAgICAgICB0aGlzLnF1YXRlcm5pb24uY29weShvcHRpb25zLnF1YXRlcm5pb24pOwogICAgICAgIHRoaXMuaW5pdFF1YXRlcm5pb24uY29weShvcHRpb25zLnF1YXRlcm5pb24pOwogICAgICAgIHRoaXMucHJldmlvdXNRdWF0ZXJuaW9uLmNvcHkob3B0aW9ucy5xdWF0ZXJuaW9uKTsKICAgICAgICB0aGlzLmludGVycG9sYXRlZFF1YXRlcm5pb24uY29weShvcHRpb25zLnF1YXRlcm5pb24pOwogICAgICB9CgogICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBWZWMzKCk7CgogICAgICBpZiAob3B0aW9ucy5hbmd1bGFyVmVsb2NpdHkpIHsKICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5jb3B5KG9wdGlvbnMuYW5ndWxhclZlbG9jaXR5KTsKICAgICAgfQoKICAgICAgdGhpcy5pbml0QW5ndWxhclZlbG9jaXR5ID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5zaGFwZXMgPSBbXTsKICAgICAgdGhpcy5zaGFwZU9mZnNldHMgPSBbXTsKICAgICAgdGhpcy5zaGFwZU9yaWVudGF0aW9ucyA9IFtdOwogICAgICB0aGlzLmluZXJ0aWEgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmludkluZXJ0aWEgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmludkluZXJ0aWFXb3JsZCA9IG5ldyBNYXQzKCk7CiAgICAgIHRoaXMuaW52TWFzc1NvbHZlID0gMDsKICAgICAgdGhpcy5pbnZJbmVydGlhU29sdmUgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmludkluZXJ0aWFXb3JsZFNvbHZlID0gbmV3IE1hdDMoKTsKICAgICAgdGhpcy5maXhlZFJvdGF0aW9uID0gdHlwZW9mIG9wdGlvbnMuZml4ZWRSb3RhdGlvbiAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmZpeGVkUm90YXRpb24gOiBmYWxzZTsKICAgICAgdGhpcy5hbmd1bGFyRGFtcGluZyA9IHR5cGVvZiBvcHRpb25zLmFuZ3VsYXJEYW1waW5nICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuYW5ndWxhckRhbXBpbmcgOiAwLjAxOwogICAgICB0aGlzLmxpbmVhckZhY3RvciA9IG5ldyBWZWMzKDEsIDEsIDEpOwoKICAgICAgaWYgKG9wdGlvbnMubGluZWFyRmFjdG9yKSB7CiAgICAgICAgdGhpcy5saW5lYXJGYWN0b3IuY29weShvcHRpb25zLmxpbmVhckZhY3Rvcik7CiAgICAgIH0KCiAgICAgIHRoaXMuYW5ndWxhckZhY3RvciA9IG5ldyBWZWMzKDEsIDEsIDEpOwoKICAgICAgaWYgKG9wdGlvbnMuYW5ndWxhckZhY3RvcikgewogICAgICAgIHRoaXMuYW5ndWxhckZhY3Rvci5jb3B5KG9wdGlvbnMuYW5ndWxhckZhY3Rvcik7CiAgICAgIH0KCiAgICAgIHRoaXMuYWFiYiA9IG5ldyBBQUJCKCk7CiAgICAgIHRoaXMuYWFiYk5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgdGhpcy5ib3VuZGluZ1JhZGl1cyA9IDA7CiAgICAgIHRoaXMud2xhbWJkYSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaXNUcmlnZ2VyID0gQm9vbGVhbihvcHRpb25zLmlzVHJpZ2dlcik7CgogICAgICBpZiAob3B0aW9ucy5zaGFwZSkgewogICAgICAgIHRoaXMuYWRkU2hhcGUob3B0aW9ucy5zaGFwZSk7CiAgICAgIH0KCiAgICAgIHRoaXMudXBkYXRlTWFzc1Byb3BlcnRpZXMoKTsKICAgIH0KICAgIC8qKgogICAgICogV2FrZSB0aGUgYm9keSB1cC4KICAgICAqLwoKCiAgICB3YWtlVXAoKSB7CiAgICAgIGNvbnN0IHByZXZTdGF0ZSA9IHRoaXMuc2xlZXBTdGF0ZTsKICAgICAgdGhpcy5zbGVlcFN0YXRlID0gQm9keS5BV0FLRTsKICAgICAgdGhpcy53YWtlVXBBZnRlck5hcnJvd3BoYXNlID0gZmFsc2U7CgogICAgICBpZiAocHJldlN0YXRlID09PSBCb2R5LlNMRUVQSU5HKSB7CiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KEJvZHkud2FrZXVwRXZlbnQpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEZvcmNlIGJvZHkgc2xlZXAKICAgICAqLwoKCiAgICBzbGVlcCgpIHsKICAgICAgdGhpcy5zbGVlcFN0YXRlID0gQm9keS5TTEVFUElORzsKICAgICAgdGhpcy52ZWxvY2l0eS5zZXQoMCwgMCwgMCk7CiAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgdGhpcy53YWtlVXBBZnRlck5hcnJvd3BoYXNlID0gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIENhbGxlZCBldmVyeSB0aW1lc3RlcCB0byB1cGRhdGUgaW50ZXJuYWwgc2xlZXAgdGltZXIgYW5kIGNoYW5nZSBzbGVlcCBzdGF0ZSBpZiBuZWVkZWQuCiAgICAgKiBAcGFyYW0gdGltZSBUaGUgd29ybGQgdGltZSBpbiBzZWNvbmRzCiAgICAgKi8KCgogICAgc2xlZXBUaWNrKHRpbWUpIHsKICAgICAgaWYgKHRoaXMuYWxsb3dTbGVlcCkgewogICAgICAgIGNvbnN0IHNsZWVwU3RhdGUgPSB0aGlzLnNsZWVwU3RhdGU7CiAgICAgICAgY29uc3Qgc3BlZWRTcXVhcmVkID0gdGhpcy52ZWxvY2l0eS5sZW5ndGhTcXVhcmVkKCkgKyB0aGlzLmFuZ3VsYXJWZWxvY2l0eS5sZW5ndGhTcXVhcmVkKCk7CiAgICAgICAgY29uc3Qgc3BlZWRMaW1pdFNxdWFyZWQgPSB0aGlzLnNsZWVwU3BlZWRMaW1pdCAqKiAyOwoKICAgICAgICBpZiAoc2xlZXBTdGF0ZSA9PT0gQm9keS5BV0FLRSAmJiBzcGVlZFNxdWFyZWQgPCBzcGVlZExpbWl0U3F1YXJlZCkgewogICAgICAgICAgdGhpcy5zbGVlcFN0YXRlID0gQm9keS5TTEVFUFk7IC8vIFNsZWVweQoKICAgICAgICAgIHRoaXMudGltZUxhc3RTbGVlcHkgPSB0aW1lOwogICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KEJvZHkuc2xlZXB5RXZlbnQpOwogICAgICAgIH0gZWxzZSBpZiAoc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUFkgJiYgc3BlZWRTcXVhcmVkID4gc3BlZWRMaW1pdFNxdWFyZWQpIHsKICAgICAgICAgIHRoaXMud2FrZVVwKCk7IC8vIFdha2UgdXAKICAgICAgICB9IGVsc2UgaWYgKHNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBZICYmIHRpbWUgLSB0aGlzLnRpbWVMYXN0U2xlZXB5ID4gdGhpcy5zbGVlcFRpbWVMaW1pdCkgewogICAgICAgICAgdGhpcy5zbGVlcCgpOyAvLyBTbGVlcGluZwoKICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChCb2R5LnNsZWVwRXZlbnQpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBJZiB0aGUgYm9keSBpcyBzbGVlcGluZywgaXQgc2hvdWxkIGJlIGltbW92YWJsZSAvIGhhdmUgaW5maW5pdGUgbWFzcyBkdXJpbmcgc29sdmUuIFdlIHNvbHZlIGl0IGJ5IGhhdmluZyBhIHNlcGFyYXRlICJzb2x2ZSBtYXNzIi4KICAgICAqLwoKCiAgICB1cGRhdGVTb2x2ZU1hc3NQcm9wZXJ0aWVzKCkgewogICAgICBpZiAodGhpcy5zbGVlcFN0YXRlID09PSBCb2R5LlNMRUVQSU5HIHx8IHRoaXMudHlwZSA9PT0gQm9keS5LSU5FTUFUSUMpIHsKICAgICAgICB0aGlzLmludk1hc3NTb2x2ZSA9IDA7CiAgICAgICAgdGhpcy5pbnZJbmVydGlhU29sdmUuc2V0WmVybygpOwogICAgICAgIHRoaXMuaW52SW5lcnRpYVdvcmxkU29sdmUuc2V0WmVybygpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuaW52TWFzc1NvbHZlID0gdGhpcy5pbnZNYXNzOwogICAgICAgIHRoaXMuaW52SW5lcnRpYVNvbHZlLmNvcHkodGhpcy5pbnZJbmVydGlhKTsKICAgICAgICB0aGlzLmludkluZXJ0aWFXb3JsZFNvbHZlLmNvcHkodGhpcy5pbnZJbmVydGlhV29ybGQpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnQgYSB3b3JsZCBwb2ludCB0byBsb2NhbCBib2R5IGZyYW1lLgogICAgICovCgoKICAgIHBvaW50VG9Mb2NhbEZyYW1lKHdvcmxkUG9pbnQsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB3b3JsZFBvaW50LnZzdWIodGhpcy5wb3NpdGlvbiwgcmVzdWx0KTsKICAgICAgdGhpcy5xdWF0ZXJuaW9uLmNvbmp1Z2F0ZSgpLnZtdWx0KHJlc3VsdCwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydCBhIHdvcmxkIHZlY3RvciB0byBsb2NhbCBib2R5IGZyYW1lLgogICAgICovCgoKICAgIHZlY3RvclRvTG9jYWxGcmFtZSh3b3JsZFZlY3RvciwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHRoaXMucXVhdGVybmlvbi5jb25qdWdhdGUoKS52bXVsdCh3b3JsZFZlY3RvciwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydCBhIGxvY2FsIGJvZHkgcG9pbnQgdG8gd29ybGQgZnJhbWUuCiAgICAgKi8KCgogICAgcG9pbnRUb1dvcmxkRnJhbWUobG9jYWxQb2ludCwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHRoaXMucXVhdGVybmlvbi52bXVsdChsb2NhbFBvaW50LCByZXN1bHQpOwogICAgICByZXN1bHQudmFkZCh0aGlzLnBvc2l0aW9uLCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0IGEgbG9jYWwgYm9keSBwb2ludCB0byB3b3JsZCBmcmFtZS4KICAgICAqLwoKCiAgICB2ZWN0b3JUb1dvcmxkRnJhbWUobG9jYWxWZWN0b3IsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0aGlzLnF1YXRlcm5pb24udm11bHQobG9jYWxWZWN0b3IsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIEFkZCBhIHNoYXBlIHRvIHRoZSBib2R5IHdpdGggYSBsb2NhbCBvZmZzZXQgYW5kIG9yaWVudGF0aW9uLgogICAgICogQHJldHVybiBUaGUgYm9keSBvYmplY3QsIGZvciBjaGFpbmFiaWxpdHkuCiAgICAgKi8KCgogICAgYWRkU2hhcGUoc2hhcGUsIF9vZmZzZXQsIF9vcmllbnRhdGlvbikgewogICAgICBjb25zdCBvZmZzZXQgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBvcmllbnRhdGlvbiA9IG5ldyBRdWF0ZXJuaW9uKCk7CgogICAgICBpZiAoX29mZnNldCkgewogICAgICAgIG9mZnNldC5jb3B5KF9vZmZzZXQpOwogICAgICB9CgogICAgICBpZiAoX29yaWVudGF0aW9uKSB7CiAgICAgICAgb3JpZW50YXRpb24uY29weShfb3JpZW50YXRpb24pOwogICAgICB9CgogICAgICB0aGlzLnNoYXBlcy5wdXNoKHNoYXBlKTsKICAgICAgdGhpcy5zaGFwZU9mZnNldHMucHVzaChvZmZzZXQpOwogICAgICB0aGlzLnNoYXBlT3JpZW50YXRpb25zLnB1c2gob3JpZW50YXRpb24pOwogICAgICB0aGlzLnVwZGF0ZU1hc3NQcm9wZXJ0aWVzKCk7CiAgICAgIHRoaXMudXBkYXRlQm91bmRpbmdSYWRpdXMoKTsKICAgICAgdGhpcy5hYWJiTmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICBzaGFwZS5ib2R5ID0gdGhpczsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIFJlbW92ZSBhIHNoYXBlIGZyb20gdGhlIGJvZHkuCiAgICAgKiBAcmV0dXJuIFRoZSBib2R5IG9iamVjdCwgZm9yIGNoYWluYWJpbGl0eS4KICAgICAqLwoKCiAgICByZW1vdmVTaGFwZShzaGFwZSkgewogICAgICBjb25zdCBpbmRleCA9IHRoaXMuc2hhcGVzLmluZGV4T2Yoc2hhcGUpOwoKICAgICAgaWYgKGluZGV4ID09PSAtMSkgewogICAgICAgIGNvbnNvbGUud2FybignU2hhcGUgZG9lcyBub3QgYmVsb25nIHRvIHRoZSBib2R5Jyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIHRoaXMuc2hhcGVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIHRoaXMuc2hhcGVPZmZzZXRzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIHRoaXMuc2hhcGVPcmllbnRhdGlvbnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgdGhpcy51cGRhdGVNYXNzUHJvcGVydGllcygpOwogICAgICB0aGlzLnVwZGF0ZUJvdW5kaW5nUmFkaXVzKCk7CiAgICAgIHRoaXMuYWFiYk5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgc2hhcGUuYm9keSA9IG51bGw7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGUgdGhlIGJvdW5kaW5nIHJhZGl1cyBvZiB0aGUgYm9keS4gU2hvdWxkIGJlIGRvbmUgaWYgYW55IG9mIHRoZSBzaGFwZXMgYXJlIGNoYW5nZWQuCiAgICAgKi8KCgogICAgdXBkYXRlQm91bmRpbmdSYWRpdXMoKSB7CiAgICAgIGNvbnN0IHNoYXBlcyA9IHRoaXMuc2hhcGVzOwogICAgICBjb25zdCBzaGFwZU9mZnNldHMgPSB0aGlzLnNoYXBlT2Zmc2V0czsKICAgICAgY29uc3QgTiA9IHNoYXBlcy5sZW5ndGg7CiAgICAgIGxldCByYWRpdXMgPSAwOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IHNoYXBlID0gc2hhcGVzW2ldOwogICAgICAgIHNoYXBlLnVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCk7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gc2hhcGVPZmZzZXRzW2ldLmxlbmd0aCgpOwogICAgICAgIGNvbnN0IHIgPSBzaGFwZS5ib3VuZGluZ1NwaGVyZVJhZGl1czsKCiAgICAgICAgaWYgKG9mZnNldCArIHIgPiByYWRpdXMpIHsKICAgICAgICAgIHJhZGl1cyA9IG9mZnNldCArIHI7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmJvdW5kaW5nUmFkaXVzID0gcmFkaXVzOwogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGVzIHRoZSAuYWFiYgogICAgICovCgoKICAgIHVwZGF0ZUFBQkIoKSB7CiAgICAgIGNvbnN0IHNoYXBlcyA9IHRoaXMuc2hhcGVzOwogICAgICBjb25zdCBzaGFwZU9mZnNldHMgPSB0aGlzLnNoYXBlT2Zmc2V0czsKICAgICAgY29uc3Qgc2hhcGVPcmllbnRhdGlvbnMgPSB0aGlzLnNoYXBlT3JpZW50YXRpb25zOwogICAgICBjb25zdCBOID0gc2hhcGVzLmxlbmd0aDsKICAgICAgY29uc3Qgb2Zmc2V0ID0gdG1wVmVjOwogICAgICBjb25zdCBvcmllbnRhdGlvbiA9IHRtcFF1YXQ7CiAgICAgIGNvbnN0IGJvZHlRdWF0ID0gdGhpcy5xdWF0ZXJuaW9uOwogICAgICBjb25zdCBhYWJiID0gdGhpcy5hYWJiOwogICAgICBjb25zdCBzaGFwZUFBQkIgPSB1cGRhdGVBQUJCX3NoYXBlQUFCQjsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBjb25zdCBzaGFwZSA9IHNoYXBlc1tpXTsgLy8gR2V0IHNoYXBlIHdvcmxkIHBvc2l0aW9uCgogICAgICAgIGJvZHlRdWF0LnZtdWx0KHNoYXBlT2Zmc2V0c1tpXSwgb2Zmc2V0KTsKICAgICAgICBvZmZzZXQudmFkZCh0aGlzLnBvc2l0aW9uLCBvZmZzZXQpOyAvLyBHZXQgc2hhcGUgd29ybGQgcXVhdGVybmlvbgoKICAgICAgICBib2R5UXVhdC5tdWx0KHNoYXBlT3JpZW50YXRpb25zW2ldLCBvcmllbnRhdGlvbik7IC8vIEdldCBzaGFwZSBBQUJCCgogICAgICAgIHNoYXBlLmNhbGN1bGF0ZVdvcmxkQUFCQihvZmZzZXQsIG9yaWVudGF0aW9uLCBzaGFwZUFBQkIubG93ZXJCb3VuZCwgc2hhcGVBQUJCLnVwcGVyQm91bmQpOwoKICAgICAgICBpZiAoaSA9PT0gMCkgewogICAgICAgICAgYWFiYi5jb3B5KHNoYXBlQUFCQik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFhYmIuZXh0ZW5kKHNoYXBlQUFCQik7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmFhYmJOZWVkc1VwZGF0ZSA9IGZhbHNlOwogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGUgYC5pbmVydGlhV29ybGRgIGFuZCBgLmludkluZXJ0aWFXb3JsZGAKICAgICAqLwoKCiAgICB1cGRhdGVJbmVydGlhV29ybGQoZm9yY2UpIHsKICAgICAgY29uc3QgSSA9IHRoaXMuaW52SW5lcnRpYTsKCiAgICAgIGlmIChJLnggPT09IEkueSAmJiBJLnkgPT09IEkueiAmJiAhZm9yY2UpIDsgZWxzZSB7CiAgICAgICAgY29uc3QgbTEgPSB1aXdfbTE7CiAgICAgICAgY29uc3QgbTIgPSB1aXdfbTI7CiAgICAgICAgbTEuc2V0Um90YXRpb25Gcm9tUXVhdGVybmlvbih0aGlzLnF1YXRlcm5pb24pOwogICAgICAgIG0xLnRyYW5zcG9zZShtMik7CiAgICAgICAgbTEuc2NhbGUoSSwgbTEpOwogICAgICAgIG0xLm1tdWx0KG0yLCB0aGlzLmludkluZXJ0aWFXb3JsZCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQXBwbHkgZm9yY2UgdG8gYSBwb2ludCBvZiB0aGUgYm9keS4gVGhpcyBjb3VsZCBmb3IgZXhhbXBsZSBiZSBhIHBvaW50IG9uIHRoZSBCb2R5IHN1cmZhY2UuCiAgICAgKiBBcHBseWluZyBmb3JjZSB0aGlzIHdheSB3aWxsIGFkZCB0byBCb2R5LmZvcmNlIGFuZCBCb2R5LnRvcnF1ZS4KICAgICAqIEBwYXJhbSBmb3JjZSBUaGUgYW1vdW50IG9mIGZvcmNlIHRvIGFkZC4KICAgICAqIEBwYXJhbSByZWxhdGl2ZVBvaW50IEEgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIGNlbnRlciBvZiBtYXNzIHRvIGFwcGx5IHRoZSBmb3JjZSBvbi4KICAgICAqLwoKCiAgICBhcHBseUZvcmNlKGZvcmNlLCByZWxhdGl2ZVBvaW50KSB7CiAgICAgIGlmIChyZWxhdGl2ZVBvaW50ID09PSB2b2lkIDApIHsKICAgICAgICByZWxhdGl2ZVBvaW50ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgLy8gTmVlZGVkPwogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpIHsKICAgICAgICB0aGlzLndha2VVcCgpOwogICAgICB9IC8vIENvbXB1dGUgcHJvZHVjZWQgcm90YXRpb25hbCBmb3JjZQoKCiAgICAgIGNvbnN0IHJvdEZvcmNlID0gQm9keV9hcHBseUZvcmNlX3JvdEZvcmNlOwogICAgICByZWxhdGl2ZVBvaW50LmNyb3NzKGZvcmNlLCByb3RGb3JjZSk7IC8vIEFkZCBsaW5lYXIgZm9yY2UKCiAgICAgIHRoaXMuZm9yY2UudmFkZChmb3JjZSwgdGhpcy5mb3JjZSk7IC8vIEFkZCByb3RhdGlvbmFsIGZvcmNlCgogICAgICB0aGlzLnRvcnF1ZS52YWRkKHJvdEZvcmNlLCB0aGlzLnRvcnF1ZSk7CiAgICB9CiAgICAvKioKICAgICAqIEFwcGx5IGZvcmNlIHRvIGEgbG9jYWwgcG9pbnQgaW4gdGhlIGJvZHkuCiAgICAgKiBAcGFyYW0gZm9yY2UgVGhlIGZvcmNlIHZlY3RvciB0byBhcHBseSwgZGVmaW5lZCBsb2NhbGx5IGluIHRoZSBib2R5IGZyYW1lLgogICAgICogQHBhcmFtIGxvY2FsUG9pbnQgQSBsb2NhbCBwb2ludCBpbiB0aGUgYm9keSB0byBhcHBseSB0aGUgZm9yY2Ugb24uCiAgICAgKi8KCgogICAgYXBwbHlMb2NhbEZvcmNlKGxvY2FsRm9yY2UsIGxvY2FsUG9pbnQpIHsKICAgICAgaWYgKGxvY2FsUG9pbnQgPT09IHZvaWQgMCkgewogICAgICAgIGxvY2FsUG9pbnQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IHdvcmxkRm9yY2UgPSBCb2R5X2FwcGx5TG9jYWxGb3JjZV93b3JsZEZvcmNlOwogICAgICBjb25zdCByZWxhdGl2ZVBvaW50V29ybGQgPSBCb2R5X2FwcGx5TG9jYWxGb3JjZV9yZWxhdGl2ZVBvaW50V29ybGQ7IC8vIFRyYW5zZm9ybSB0aGUgZm9yY2UgdmVjdG9yIHRvIHdvcmxkIHNwYWNlCgogICAgICB0aGlzLnZlY3RvclRvV29ybGRGcmFtZShsb2NhbEZvcmNlLCB3b3JsZEZvcmNlKTsKICAgICAgdGhpcy52ZWN0b3JUb1dvcmxkRnJhbWUobG9jYWxQb2ludCwgcmVsYXRpdmVQb2ludFdvcmxkKTsKICAgICAgdGhpcy5hcHBseUZvcmNlKHdvcmxkRm9yY2UsIHJlbGF0aXZlUG9pbnRXb3JsZCk7CiAgICB9CiAgICAvKioKICAgICAqIEFwcGx5IHRvcnF1ZSB0byB0aGUgYm9keS4KICAgICAqIEBwYXJhbSB0b3JxdWUgVGhlIGFtb3VudCBvZiB0b3JxdWUgdG8gYWRkLgogICAgICovCgoKICAgIGFwcGx5VG9ycXVlKHRvcnF1ZSkgewogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpIHsKICAgICAgICB0aGlzLndha2VVcCgpOwogICAgICB9IC8vIEFkZCByb3RhdGlvbmFsIGZvcmNlCgoKICAgICAgdGhpcy50b3JxdWUudmFkZCh0b3JxdWUsIHRoaXMudG9ycXVlKTsKICAgIH0KICAgIC8qKgogICAgICogQXBwbHkgaW1wdWxzZSB0byBhIHBvaW50IG9mIHRoZSBib2R5LiBUaGlzIGNvdWxkIGZvciBleGFtcGxlIGJlIGEgcG9pbnQgb24gdGhlIEJvZHkgc3VyZmFjZS4KICAgICAqIEFuIGltcHVsc2UgaXMgYSBmb3JjZSBhZGRlZCB0byBhIGJvZHkgZHVyaW5nIGEgc2hvcnQgcGVyaW9kIG9mIHRpbWUgKGltcHVsc2UgPSBmb3JjZSAqIHRpbWUpLgogICAgICogSW1wdWxzZXMgd2lsbCBiZSBhZGRlZCB0byBCb2R5LnZlbG9jaXR5IGFuZCBCb2R5LmFuZ3VsYXJWZWxvY2l0eS4KICAgICAqIEBwYXJhbSBpbXB1bHNlIFRoZSBhbW91bnQgb2YgaW1wdWxzZSB0byBhZGQuCiAgICAgKiBAcGFyYW0gcmVsYXRpdmVQb2ludCBBIHBvaW50IHJlbGF0aXZlIHRvIHRoZSBjZW50ZXIgb2YgbWFzcyB0byBhcHBseSB0aGUgZm9yY2Ugb24uCiAgICAgKi8KCgogICAgYXBwbHlJbXB1bHNlKGltcHVsc2UsIHJlbGF0aXZlUG9pbnQpIHsKICAgICAgaWYgKHJlbGF0aXZlUG9pbnQgPT09IHZvaWQgMCkgewogICAgICAgIHJlbGF0aXZlUG9pbnQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpIHsKICAgICAgICB0aGlzLndha2VVcCgpOwogICAgICB9IC8vIENvbXB1dGUgcG9pbnQgcG9zaXRpb24gcmVsYXRpdmUgdG8gdGhlIGJvZHkgY2VudGVyCgoKICAgICAgY29uc3QgciA9IHJlbGF0aXZlUG9pbnQ7IC8vIENvbXB1dGUgcHJvZHVjZWQgY2VudHJhbCBpbXB1bHNlIHZlbG9jaXR5CgogICAgICBjb25zdCB2ZWxvID0gQm9keV9hcHBseUltcHVsc2VfdmVsbzsKICAgICAgdmVsby5jb3B5KGltcHVsc2UpOwogICAgICB2ZWxvLnNjYWxlKHRoaXMuaW52TWFzcywgdmVsbyk7IC8vIEFkZCBsaW5lYXIgaW1wdWxzZQoKICAgICAgdGhpcy52ZWxvY2l0eS52YWRkKHZlbG8sIHRoaXMudmVsb2NpdHkpOyAvLyBDb21wdXRlIHByb2R1Y2VkIHJvdGF0aW9uYWwgaW1wdWxzZSB2ZWxvY2l0eQoKICAgICAgY29uc3Qgcm90VmVsbyA9IEJvZHlfYXBwbHlJbXB1bHNlX3JvdFZlbG87CiAgICAgIHIuY3Jvc3MoaW1wdWxzZSwgcm90VmVsbyk7CiAgICAgIC8qCiAgICAgICByb3RWZWxvLnggKj0gdGhpcy5pbnZJbmVydGlhLng7CiAgICAgICByb3RWZWxvLnkgKj0gdGhpcy5pbnZJbmVydGlhLnk7CiAgICAgICByb3RWZWxvLnogKj0gdGhpcy5pbnZJbmVydGlhLno7CiAgICAgICAqLwoKICAgICAgdGhpcy5pbnZJbmVydGlhV29ybGQudm11bHQocm90VmVsbywgcm90VmVsbyk7IC8vIEFkZCByb3RhdGlvbmFsIEltcHVsc2UKCiAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnZhZGQocm90VmVsbywgdGhpcy5hbmd1bGFyVmVsb2NpdHkpOwogICAgfQogICAgLyoqCiAgICAgKiBBcHBseSBsb2NhbGx5LWRlZmluZWQgaW1wdWxzZSB0byBhIGxvY2FsIHBvaW50IGluIHRoZSBib2R5LgogICAgICogQHBhcmFtIGZvcmNlIFRoZSBmb3JjZSB2ZWN0b3IgdG8gYXBwbHksIGRlZmluZWQgbG9jYWxseSBpbiB0aGUgYm9keSBmcmFtZS4KICAgICAqIEBwYXJhbSBsb2NhbFBvaW50IEEgbG9jYWwgcG9pbnQgaW4gdGhlIGJvZHkgdG8gYXBwbHkgdGhlIGZvcmNlIG9uLgogICAgICovCgoKICAgIGFwcGx5TG9jYWxJbXB1bHNlKGxvY2FsSW1wdWxzZSwgbG9jYWxQb2ludCkgewogICAgICBpZiAobG9jYWxQb2ludCA9PT0gdm9pZCAwKSB7CiAgICAgICAgbG9jYWxQb2ludCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnR5cGUgIT09IEJvZHkuRFlOQU1JQykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3Qgd29ybGRJbXB1bHNlID0gQm9keV9hcHBseUxvY2FsSW1wdWxzZV93b3JsZEltcHVsc2U7CiAgICAgIGNvbnN0IHJlbGF0aXZlUG9pbnRXb3JsZCA9IEJvZHlfYXBwbHlMb2NhbEltcHVsc2VfcmVsYXRpdmVQb2ludDsgLy8gVHJhbnNmb3JtIHRoZSBmb3JjZSB2ZWN0b3IgdG8gd29ybGQgc3BhY2UKCiAgICAgIHRoaXMudmVjdG9yVG9Xb3JsZEZyYW1lKGxvY2FsSW1wdWxzZSwgd29ybGRJbXB1bHNlKTsKICAgICAgdGhpcy52ZWN0b3JUb1dvcmxkRnJhbWUobG9jYWxQb2ludCwgcmVsYXRpdmVQb2ludFdvcmxkKTsKICAgICAgdGhpcy5hcHBseUltcHVsc2Uod29ybGRJbXB1bHNlLCByZWxhdGl2ZVBvaW50V29ybGQpOwogICAgfQogICAgLyoqCiAgICAgKiBTaG91bGQgYmUgY2FsbGVkIHdoZW5ldmVyIHlvdSBjaGFuZ2UgdGhlIGJvZHkgc2hhcGUgb3IgbWFzcy4KICAgICAqLwoKCiAgICB1cGRhdGVNYXNzUHJvcGVydGllcygpIHsKICAgICAgY29uc3QgaGFsZkV4dGVudHMgPSBCb2R5X3VwZGF0ZU1hc3NQcm9wZXJ0aWVzX2hhbGZFeHRlbnRzOwogICAgICB0aGlzLmludk1hc3MgPSB0aGlzLm1hc3MgPiAwID8gMS4wIC8gdGhpcy5tYXNzIDogMDsKICAgICAgY29uc3QgSSA9IHRoaXMuaW5lcnRpYTsKICAgICAgY29uc3QgZml4ZWQgPSB0aGlzLmZpeGVkUm90YXRpb247IC8vIEFwcHJveGltYXRlIHdpdGggQUFCQiBib3gKCiAgICAgIHRoaXMudXBkYXRlQUFCQigpOwogICAgICBoYWxmRXh0ZW50cy5zZXQoKHRoaXMuYWFiYi51cHBlckJvdW5kLnggLSB0aGlzLmFhYmIubG93ZXJCb3VuZC54KSAvIDIsICh0aGlzLmFhYmIudXBwZXJCb3VuZC55IC0gdGhpcy5hYWJiLmxvd2VyQm91bmQueSkgLyAyLCAodGhpcy5hYWJiLnVwcGVyQm91bmQueiAtIHRoaXMuYWFiYi5sb3dlckJvdW5kLnopIC8gMik7CiAgICAgIEJveC5jYWxjdWxhdGVJbmVydGlhKGhhbGZFeHRlbnRzLCB0aGlzLm1hc3MsIEkpOwogICAgICB0aGlzLmludkluZXJ0aWEuc2V0KEkueCA+IDAgJiYgIWZpeGVkID8gMS4wIC8gSS54IDogMCwgSS55ID4gMCAmJiAhZml4ZWQgPyAxLjAgLyBJLnkgOiAwLCBJLnogPiAwICYmICFmaXhlZCA/IDEuMCAvIEkueiA6IDApOwogICAgICB0aGlzLnVwZGF0ZUluZXJ0aWFXb3JsZCh0cnVlKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHdvcmxkIHZlbG9jaXR5IG9mIGEgcG9pbnQgaW4gdGhlIGJvZHkuCiAgICAgKiBAcGFyYW0gd29ybGRQb2ludAogICAgICogQHBhcmFtIHJlc3VsdAogICAgICogQHJldHVybiBUaGUgcmVzdWx0IHZlY3Rvci4KICAgICAqLwoKCiAgICBnZXRWZWxvY2l0eUF0V29ybGRQb2ludCh3b3JsZFBvaW50LCByZXN1bHQpIHsKICAgICAgY29uc3QgciA9IG5ldyBWZWMzKCk7CiAgICAgIHdvcmxkUG9pbnQudnN1Yih0aGlzLnBvc2l0aW9uLCByKTsKICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY3Jvc3MociwgcmVzdWx0KTsKICAgICAgdGhpcy52ZWxvY2l0eS52YWRkKHJlc3VsdCwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogTW92ZSB0aGUgYm9keSBmb3J3YXJkIGluIHRpbWUuCiAgICAgKiBAcGFyYW0gZHQgVGltZSBzdGVwCiAgICAgKiBAcGFyYW0gcXVhdE5vcm1hbGl6ZSBTZXQgdG8gdHJ1ZSB0byBub3JtYWxpemUgdGhlIGJvZHkgcXVhdGVybmlvbgogICAgICogQHBhcmFtIHF1YXROb3JtYWxpemVGYXN0IElmIHRoZSBxdWF0ZXJuaW9uIHNob3VsZCBiZSBub3JtYWxpemVkIHVzaW5nICJmYXN0IiBxdWF0ZXJuaW9uIG5vcm1hbGl6YXRpb24KICAgICAqLwoKCiAgICBpbnRlZ3JhdGUoZHQsIHF1YXROb3JtYWxpemUsIHF1YXROb3JtYWxpemVGYXN0KSB7CiAgICAgIC8vIFNhdmUgcHJldmlvdXMgcG9zaXRpb24KICAgICAgdGhpcy5wcmV2aW91c1Bvc2l0aW9uLmNvcHkodGhpcy5wb3NpdGlvbik7CiAgICAgIHRoaXMucHJldmlvdXNRdWF0ZXJuaW9uLmNvcHkodGhpcy5xdWF0ZXJuaW9uKTsKCiAgICAgIGlmICghKHRoaXMudHlwZSA9PT0gQm9keS5EWU5BTUlDIHx8IHRoaXMudHlwZSA9PT0gQm9keS5LSU5FTUFUSUMpIHx8IHRoaXMuc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUElORykgewogICAgICAgIC8vIE9ubHkgZm9yIGR5bmFtaWMKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IHZlbG8gPSB0aGlzLnZlbG9jaXR5OwogICAgICBjb25zdCBhbmd1bGFyVmVsbyA9IHRoaXMuYW5ndWxhclZlbG9jaXR5OwogICAgICBjb25zdCBwb3MgPSB0aGlzLnBvc2l0aW9uOwogICAgICBjb25zdCBmb3JjZSA9IHRoaXMuZm9yY2U7CiAgICAgIGNvbnN0IHRvcnF1ZSA9IHRoaXMudG9ycXVlOwogICAgICBjb25zdCBxdWF0ID0gdGhpcy5xdWF0ZXJuaW9uOwogICAgICBjb25zdCBpbnZNYXNzID0gdGhpcy5pbnZNYXNzOwogICAgICBjb25zdCBpbnZJbmVydGlhID0gdGhpcy5pbnZJbmVydGlhV29ybGQ7CiAgICAgIGNvbnN0IGxpbmVhckZhY3RvciA9IHRoaXMubGluZWFyRmFjdG9yOwogICAgICBjb25zdCBpTWR0ID0gaW52TWFzcyAqIGR0OwogICAgICB2ZWxvLnggKz0gZm9yY2UueCAqIGlNZHQgKiBsaW5lYXJGYWN0b3IueDsKICAgICAgdmVsby55ICs9IGZvcmNlLnkgKiBpTWR0ICogbGluZWFyRmFjdG9yLnk7CiAgICAgIHZlbG8ueiArPSBmb3JjZS56ICogaU1kdCAqIGxpbmVhckZhY3Rvci56OwogICAgICBjb25zdCBlID0gaW52SW5lcnRpYS5lbGVtZW50czsKICAgICAgY29uc3QgYW5ndWxhckZhY3RvciA9IHRoaXMuYW5ndWxhckZhY3RvcjsKICAgICAgY29uc3QgdHggPSB0b3JxdWUueCAqIGFuZ3VsYXJGYWN0b3IueDsKICAgICAgY29uc3QgdHkgPSB0b3JxdWUueSAqIGFuZ3VsYXJGYWN0b3IueTsKICAgICAgY29uc3QgdHogPSB0b3JxdWUueiAqIGFuZ3VsYXJGYWN0b3IuejsKICAgICAgYW5ndWxhclZlbG8ueCArPSBkdCAqIChlWzBdICogdHggKyBlWzFdICogdHkgKyBlWzJdICogdHopOwogICAgICBhbmd1bGFyVmVsby55ICs9IGR0ICogKGVbM10gKiB0eCArIGVbNF0gKiB0eSArIGVbNV0gKiB0eik7CiAgICAgIGFuZ3VsYXJWZWxvLnogKz0gZHQgKiAoZVs2XSAqIHR4ICsgZVs3XSAqIHR5ICsgZVs4XSAqIHR6KTsgLy8gVXNlIG5ldyB2ZWxvY2l0eSAgLSBsZWFwIGZyb2cKCiAgICAgIHBvcy54ICs9IHZlbG8ueCAqIGR0OwogICAgICBwb3MueSArPSB2ZWxvLnkgKiBkdDsKICAgICAgcG9zLnogKz0gdmVsby56ICogZHQ7CiAgICAgIHF1YXQuaW50ZWdyYXRlKHRoaXMuYW5ndWxhclZlbG9jaXR5LCBkdCwgdGhpcy5hbmd1bGFyRmFjdG9yLCBxdWF0KTsKCiAgICAgIGlmIChxdWF0Tm9ybWFsaXplKSB7CiAgICAgICAgaWYgKHF1YXROb3JtYWxpemVGYXN0KSB7CiAgICAgICAgICBxdWF0Lm5vcm1hbGl6ZUZhc3QoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcXVhdC5ub3JtYWxpemUoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuYWFiYk5lZWRzVXBkYXRlID0gdHJ1ZTsgLy8gVXBkYXRlIHdvcmxkIGluZXJ0aWEKCiAgICAgIHRoaXMudXBkYXRlSW5lcnRpYVdvcmxkKCk7CiAgICB9CgogIH0KICBCb2R5LmlkQ291bnRlciA9IDA7CiAgQm9keS5DT0xMSURFX0VWRU5UX05BTUUgPSAnY29sbGlkZSc7CiAgQm9keS5EWU5BTUlDID0gQk9EWV9UWVBFUy5EWU5BTUlDOwogIEJvZHkuU1RBVElDID0gQk9EWV9UWVBFUy5TVEFUSUM7CiAgQm9keS5LSU5FTUFUSUMgPSBCT0RZX1RZUEVTLktJTkVNQVRJQzsKICBCb2R5LkFXQUtFID0gQk9EWV9TTEVFUF9TVEFURVMuQVdBS0U7CiAgQm9keS5TTEVFUFkgPSBCT0RZX1NMRUVQX1NUQVRFUy5TTEVFUFk7CiAgQm9keS5TTEVFUElORyA9IEJPRFlfU0xFRVBfU1RBVEVTLlNMRUVQSU5HOwogIEJvZHkud2FrZXVwRXZlbnQgPSB7CiAgICB0eXBlOiAnd2FrZXVwJwogIH07CiAgQm9keS5zbGVlcHlFdmVudCA9IHsKICAgIHR5cGU6ICdzbGVlcHknCiAgfTsKICBCb2R5LnNsZWVwRXZlbnQgPSB7CiAgICB0eXBlOiAnc2xlZXAnCiAgfTsKICBjb25zdCB0bXBWZWMgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFF1YXQgPSBuZXcgUXVhdGVybmlvbigpOwogIGNvbnN0IHVwZGF0ZUFBQkJfc2hhcGVBQUJCID0gbmV3IEFBQkIoKTsKICBjb25zdCB1aXdfbTEgPSBuZXcgTWF0MygpOwogIGNvbnN0IHVpd19tMiA9IG5ldyBNYXQzKCk7CiAgbmV3IE1hdDMoKTsKICBjb25zdCBCb2R5X2FwcGx5Rm9yY2Vfcm90Rm9yY2UgPSBuZXcgVmVjMygpOwogIGNvbnN0IEJvZHlfYXBwbHlMb2NhbEZvcmNlX3dvcmxkRm9yY2UgPSBuZXcgVmVjMygpOwogIGNvbnN0IEJvZHlfYXBwbHlMb2NhbEZvcmNlX3JlbGF0aXZlUG9pbnRXb3JsZCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQm9keV9hcHBseUltcHVsc2VfdmVsbyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQm9keV9hcHBseUltcHVsc2Vfcm90VmVsbyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQm9keV9hcHBseUxvY2FsSW1wdWxzZV93b3JsZEltcHVsc2UgPSBuZXcgVmVjMygpOwogIGNvbnN0IEJvZHlfYXBwbHlMb2NhbEltcHVsc2VfcmVsYXRpdmVQb2ludCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQm9keV91cGRhdGVNYXNzUHJvcGVydGllc19oYWxmRXh0ZW50cyA9IG5ldyBWZWMzKCk7CgogIC8qKgogICAqIEJhc2UgY2xhc3MgZm9yIGJyb2FkcGhhc2UgaW1wbGVtZW50YXRpb25zCiAgICogQGF1dGhvciBzY2h0ZXBwZQogICAqLwogIGNsYXNzIEJyb2FkcGhhc2UgewogICAgLyoqCiAgICAgKiBUaGUgd29ybGQgdG8gc2VhcmNoIGZvciBjb2xsaXNpb25zIGluLgogICAgICovCgogICAgLyoqCiAgICAgKiBJZiBzZXQgdG8gdHJ1ZSwgdGhlIGJyb2FkcGhhc2UgdXNlcyBib3VuZGluZyBib3hlcyBmb3IgaW50ZXJzZWN0aW9uIHRlc3RzLCBlbHNlIGl0IHVzZXMgYm91bmRpbmcgc3BoZXJlcy4KICAgICAqLwoKICAgIC8qKgogICAgICogU2V0IHRvIHRydWUgaWYgdGhlIG9iamVjdHMgaW4gdGhlIHdvcmxkIG1vdmVkLgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy53b3JsZCA9IG51bGw7CiAgICAgIHRoaXMudXNlQm91bmRpbmdCb3hlcyA9IGZhbHNlOwogICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBjb2xsaXNpb24gcGFpcnMgZnJvbSB0aGUgd29ybGQKICAgICAqIEBwYXJhbSB3b3JsZCBUaGUgd29ybGQgdG8gc2VhcmNoIGluCiAgICAgKiBAcGFyYW0gcDEgRW1wdHkgYXJyYXkgdG8gYmUgZmlsbGVkIHdpdGggYm9keSBvYmplY3RzCiAgICAgKiBAcGFyYW0gcDIgRW1wdHkgYXJyYXkgdG8gYmUgZmlsbGVkIHdpdGggYm9keSBvYmplY3RzCiAgICAgKi8KCgogICAgY29sbGlzaW9uUGFpcnMod29ybGQsIHAxLCBwMikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvbGxpc2lvblBhaXJzIG5vdCBpbXBsZW1lbnRlZCBmb3IgdGhpcyBCcm9hZFBoYXNlIGNsYXNzIScpOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVjayBpZiBhIGJvZHkgcGFpciBuZWVkcyB0byBiZSBpbnRlcnNlY3Rpb24gdGVzdGVkIGF0IGFsbC4KICAgICAqLwoKCiAgICBuZWVkQnJvYWRwaGFzZUNvbGxpc2lvbihib2R5QSwgYm9keUIpIHsKICAgICAgLy8gQ2hlY2sgY29sbGlzaW9uIGZpbHRlciBtYXNrcwogICAgICBpZiAoKGJvZHlBLmNvbGxpc2lvbkZpbHRlckdyb3VwICYgYm9keUIuY29sbGlzaW9uRmlsdGVyTWFzaykgPT09IDAgfHwgKGJvZHlCLmNvbGxpc2lvbkZpbHRlckdyb3VwICYgYm9keUEuY29sbGlzaW9uRmlsdGVyTWFzaykgPT09IDApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy8gQ2hlY2sgdHlwZXMKCgogICAgICBpZiAoKChib2R5QS50eXBlICYgQm9keS5TVEFUSUMpICE9PSAwIHx8IGJvZHlBLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpICYmICgoYm9keUIudHlwZSAmIEJvZHkuU1RBVElDKSAhPT0gMCB8fCBib2R5Qi5zbGVlcFN0YXRlID09PSBCb2R5LlNMRUVQSU5HKSkgewogICAgICAgIC8vIEJvdGggYm9kaWVzIGFyZSBzdGF0aWMgb3Igc2xlZXBpbmcuIFNraXAuCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIGJvdW5kaW5nIHZvbHVtZXMgb2YgdHdvIGJvZGllcyBpbnRlcnNlY3QuCiAgICAgKi8KCgogICAgaW50ZXJzZWN0aW9uVGVzdChib2R5QSwgYm9keUIsIHBhaXJzMSwgcGFpcnMyKSB7CiAgICAgIGlmICh0aGlzLnVzZUJvdW5kaW5nQm94ZXMpIHsKICAgICAgICB0aGlzLmRvQm91bmRpbmdCb3hCcm9hZHBoYXNlKGJvZHlBLCBib2R5QiwgcGFpcnMxLCBwYWlyczIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZG9Cb3VuZGluZ1NwaGVyZUJyb2FkcGhhc2UoYm9keUEsIGJvZHlCLCBwYWlyczEsIHBhaXJzMik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIGJvdW5kaW5nIHNwaGVyZXMgb2YgdHdvIGJvZGllcyBhcmUgaW50ZXJzZWN0aW5nLgogICAgICogQHBhcmFtIHBhaXJzMSBib2R5QSBpcyBhcHBlbmRlZCB0byB0aGlzIGFycmF5IGlmIGludGVyc2VjdGlvbgogICAgICogQHBhcmFtIHBhaXJzMiBib2R5QiBpcyBhcHBlbmRlZCB0byB0aGlzIGFycmF5IGlmIGludGVyc2VjdGlvbgogICAgICovCgoKICAgIGRvQm91bmRpbmdTcGhlcmVCcm9hZHBoYXNlKGJvZHlBLCBib2R5QiwgcGFpcnMxLCBwYWlyczIpIHsKICAgICAgY29uc3QgciA9IEJyb2FkcGhhc2VfY29sbGlzaW9uUGFpcnNfcjsKICAgICAgYm9keUIucG9zaXRpb24udnN1Yihib2R5QS5wb3NpdGlvbiwgcik7CiAgICAgIGNvbnN0IGJvdW5kaW5nUmFkaXVzU3VtMiA9IChib2R5QS5ib3VuZGluZ1JhZGl1cyArIGJvZHlCLmJvdW5kaW5nUmFkaXVzKSAqKiAyOwogICAgICBjb25zdCBub3JtMiA9IHIubGVuZ3RoU3F1YXJlZCgpOwoKICAgICAgaWYgKG5vcm0yIDwgYm91bmRpbmdSYWRpdXNTdW0yKSB7CiAgICAgICAgcGFpcnMxLnB1c2goYm9keUEpOwogICAgICAgIHBhaXJzMi5wdXNoKGJvZHlCKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgYm91bmRpbmcgYm94ZXMgb2YgdHdvIGJvZGllcyBhcmUgaW50ZXJzZWN0aW5nLgogICAgICovCgoKICAgIGRvQm91bmRpbmdCb3hCcm9hZHBoYXNlKGJvZHlBLCBib2R5QiwgcGFpcnMxLCBwYWlyczIpIHsKICAgICAgaWYgKGJvZHlBLmFhYmJOZWVkc1VwZGF0ZSkgewogICAgICAgIGJvZHlBLnVwZGF0ZUFBQkIoKTsKICAgICAgfQoKICAgICAgaWYgKGJvZHlCLmFhYmJOZWVkc1VwZGF0ZSkgewogICAgICAgIGJvZHlCLnVwZGF0ZUFBQkIoKTsKICAgICAgfSAvLyBDaGVjayBBQUJCIC8gQUFCQgoKCiAgICAgIGlmIChib2R5QS5hYWJiLm92ZXJsYXBzKGJvZHlCLmFhYmIpKSB7CiAgICAgICAgcGFpcnMxLnB1c2goYm9keUEpOwogICAgICAgIHBhaXJzMi5wdXNoKGJvZHlCKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmVzIGR1cGxpY2F0ZSBwYWlycyBmcm9tIHRoZSBwYWlyIGFycmF5cy4KICAgICAqLwoKCiAgICBtYWtlUGFpcnNVbmlxdWUocGFpcnMxLCBwYWlyczIpIHsKICAgICAgY29uc3QgdCA9IEJyb2FkcGhhc2VfbWFrZVBhaXJzVW5pcXVlX3RlbXA7CiAgICAgIGNvbnN0IHAxID0gQnJvYWRwaGFzZV9tYWtlUGFpcnNVbmlxdWVfcDE7CiAgICAgIGNvbnN0IHAyID0gQnJvYWRwaGFzZV9tYWtlUGFpcnNVbmlxdWVfcDI7CiAgICAgIGNvbnN0IE4gPSBwYWlyczEubGVuZ3RoOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIHAxW2ldID0gcGFpcnMxW2ldOwogICAgICAgIHAyW2ldID0gcGFpcnMyW2ldOwogICAgICB9CgogICAgICBwYWlyczEubGVuZ3RoID0gMDsKICAgICAgcGFpcnMyLmxlbmd0aCA9IDA7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgY29uc3QgaWQxID0gcDFbaV0uaWQ7CiAgICAgICAgY29uc3QgaWQyID0gcDJbaV0uaWQ7CiAgICAgICAgY29uc3Qga2V5ID0gaWQxIDwgaWQyID8gYCR7aWQxfSwke2lkMn1gIDogYCR7aWQyfSwke2lkMX1gOwogICAgICAgIHRba2V5XSA9IGk7CiAgICAgICAgdC5rZXlzLnB1c2goa2V5KTsKICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IHQua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGtleSA9IHQua2V5cy5wb3AoKTsKICAgICAgICBjb25zdCBwYWlySW5kZXggPSB0W2tleV07CiAgICAgICAgcGFpcnMxLnB1c2gocDFbcGFpckluZGV4XSk7CiAgICAgICAgcGFpcnMyLnB1c2gocDJbcGFpckluZGV4XSk7CiAgICAgICAgZGVsZXRlIHRba2V5XTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBUbyBiZSBpbXBsZW1lbnRlZCBieSBzdWJjYXNzZXMKICAgICAqLwoKCiAgICBzZXRXb3JsZCh3b3JsZCkge30KICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIGJvdW5kaW5nIHNwaGVyZXMgb2YgdHdvIGJvZGllcyBvdmVybGFwLgogICAgICovCgoKICAgIHN0YXRpYyBib3VuZGluZ1NwaGVyZUNoZWNrKGJvZHlBLCBib2R5QikgewogICAgICBjb25zdCBkaXN0ID0gbmV3IFZlYzMoKTsgLy8gYnNjX2Rpc3Q7CgogICAgICBib2R5QS5wb3NpdGlvbi52c3ViKGJvZHlCLnBvc2l0aW9uLCBkaXN0KTsKICAgICAgY29uc3Qgc2EgPSBib2R5QS5zaGFwZXNbMF07CiAgICAgIGNvbnN0IHNiID0gYm9keUIuc2hhcGVzWzBdOwogICAgICByZXR1cm4gTWF0aC5wb3coc2EuYm91bmRpbmdTcGhlcmVSYWRpdXMgKyBzYi5ib3VuZGluZ1NwaGVyZVJhZGl1cywgMikgPiBkaXN0Lmxlbmd0aFNxdWFyZWQoKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhbGwgdGhlIGJvZGllcyB3aXRoaW4gdGhlIEFBQkIuCiAgICAgKi8KCgogICAgYWFiYlF1ZXJ5KHdvcmxkLCBhYWJiLCByZXN1bHQpIHsKICAgICAgY29uc29sZS53YXJuKCcuYWFiYlF1ZXJ5IGlzIG5vdCBpbXBsZW1lbnRlZCBpbiB0aGlzIEJyb2FkcGhhc2Ugc3ViY2xhc3MuJyk7CiAgICAgIHJldHVybiBbXTsKICAgIH0KCiAgfSAvLyBUZW1wIG9iamVjdHMKCiAgY29uc3QgQnJvYWRwaGFzZV9jb2xsaXNpb25QYWlyc19yID0gbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIG5ldyBRdWF0ZXJuaW9uKCk7CiAgbmV3IFZlYzMoKTsKICBjb25zdCBCcm9hZHBoYXNlX21ha2VQYWlyc1VuaXF1ZV90ZW1wID0gewogICAga2V5czogW10KICB9OwogIGNvbnN0IEJyb2FkcGhhc2VfbWFrZVBhaXJzVW5pcXVlX3AxID0gW107CiAgY29uc3QgQnJvYWRwaGFzZV9tYWtlUGFpcnNVbmlxdWVfcDIgPSBbXTsKICBuZXcgVmVjMygpOwogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogTmFpdmUgYnJvYWRwaGFzZSBpbXBsZW1lbnRhdGlvbiwgdXNlZCBpbiBsYWNrIG9mIGJldHRlciBvbmVzLgogICAqCiAgICogVGhlIG5haXZlIGJyb2FkcGhhc2UgbG9va3MgYXQgYWxsIHBvc3NpYmxlIHBhaXJzIHdpdGhvdXQgcmVzdHJpY3Rpb24sIHRoZXJlZm9yZSBpdCBoYXMgY29tcGxleGl0eSBOXjIgXyh3aGljaCBpcyBiYWQpXwogICAqLwogIGNsYXNzIE5haXZlQnJvYWRwaGFzZSBleHRlbmRzIEJyb2FkcGhhc2UgewogICAgLyoqCiAgICAgKiBAdG9kbyBSZW1vdmUgdXNlbGVzcyBjb25zdHJ1Y3RvcgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgc3VwZXIoKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGFsbCB0aGUgY29sbGlzaW9uIHBhaXJzIGluIHRoZSBwaHlzaWNzIHdvcmxkCiAgICAgKi8KCgogICAgY29sbGlzaW9uUGFpcnMod29ybGQsIHBhaXJzMSwgcGFpcnMyKSB7CiAgICAgIGNvbnN0IGJvZGllcyA9IHdvcmxkLmJvZGllczsKICAgICAgY29uc3QgbiA9IGJvZGllcy5sZW5ndGg7CiAgICAgIGxldCBiaTsKICAgICAgbGV0IGJqOyAvLyBOYWl2ZSBOXjIgZnR3IQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IG47IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSBpOyBqKyspIHsKICAgICAgICAgIGJpID0gYm9kaWVzW2ldOwogICAgICAgICAgYmogPSBib2RpZXNbal07CgogICAgICAgICAgaWYgKCF0aGlzLm5lZWRCcm9hZHBoYXNlQ29sbGlzaW9uKGJpLCBiaikpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5pbnRlcnNlY3Rpb25UZXN0KGJpLCBiaiwgcGFpcnMxLCBwYWlyczIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGFsbCB0aGUgYm9kaWVzIHdpdGhpbiBhbiBBQUJCLgogICAgICogQHBhcmFtIHJlc3VsdCBBbiBhcnJheSB0byBzdG9yZSByZXN1bHRpbmcgYm9kaWVzIGluLgogICAgICovCgoKICAgIGFhYmJRdWVyeSh3b3JsZCwgYWFiYiwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IFtdOwogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdvcmxkLmJvZGllcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGIgPSB3b3JsZC5ib2RpZXNbaV07CgogICAgICAgIGlmIChiLmFhYmJOZWVkc1VwZGF0ZSkgewogICAgICAgICAgYi51cGRhdGVBQUJCKCk7CiAgICAgICAgfSAvLyBVZ2x5IGhhY2sgdW50aWwgQm9keSBnZXRzIGFhYmIKCgogICAgICAgIGlmIChiLmFhYmIub3ZlcmxhcHMoYWFiYikpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKGIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgfQoKICAvKioKICAgKiBTdG9yYWdlIGZvciBSYXkgY2FzdGluZyBkYXRhCiAgICovCiAgY2xhc3MgUmF5Y2FzdFJlc3VsdCB7CiAgICAvKioKICAgICAqIHJheUZyb21Xb3JsZAogICAgICovCgogICAgLyoqCiAgICAgKiByYXlUb1dvcmxkCiAgICAgKi8KCiAgICAvKioKICAgICAqIGhpdE5vcm1hbFdvcmxkCiAgICAgKi8KCiAgICAvKioKICAgICAqIGhpdFBvaW50V29ybGQKICAgICAqLwoKICAgIC8qKgogICAgICogaGFzSGl0CiAgICAgKi8KCiAgICAvKioKICAgICAqIHNoYXBlCiAgICAgKi8KCiAgICAvKioKICAgICAqIGJvZHkKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGluZGV4IG9mIHRoZSBoaXQgdHJpYW5nbGUsIGlmIHRoZSBoaXQgc2hhcGUgd2FzIGEgdHJpbWVzaAogICAgICovCgogICAgLyoqCiAgICAgKiBEaXN0YW5jZSB0byB0aGUgaGl0LiBXaWxsIGJlIHNldCB0byAtMSBpZiB0aGVyZSB3YXMgbm8gaGl0CiAgICAgKi8KCiAgICAvKioKICAgICAqIElmIHRoZSByYXkgc2hvdWxkIHN0b3AgdHJhdmVyc2luZyB0aGUgYm9kaWVzCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKCkgewogICAgICB0aGlzLnJheUZyb21Xb3JsZCA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMucmF5VG9Xb3JsZCA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaGl0Tm9ybWFsV29ybGQgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmhpdFBvaW50V29ybGQgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmhhc0hpdCA9IGZhbHNlOwogICAgICB0aGlzLnNoYXBlID0gbnVsbDsKICAgICAgdGhpcy5ib2R5ID0gbnVsbDsKICAgICAgdGhpcy5oaXRGYWNlSW5kZXggPSAtMTsKICAgICAgdGhpcy5kaXN0YW5jZSA9IC0xOwogICAgICB0aGlzLnNob3VsZFN0b3AgPSBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogUmVzZXQgYWxsIHJlc3VsdCBkYXRhLgogICAgICovCgoKICAgIHJlc2V0KCkgewogICAgICB0aGlzLnJheUZyb21Xb3JsZC5zZXRaZXJvKCk7CiAgICAgIHRoaXMucmF5VG9Xb3JsZC5zZXRaZXJvKCk7CiAgICAgIHRoaXMuaGl0Tm9ybWFsV29ybGQuc2V0WmVybygpOwogICAgICB0aGlzLmhpdFBvaW50V29ybGQuc2V0WmVybygpOwogICAgICB0aGlzLmhhc0hpdCA9IGZhbHNlOwogICAgICB0aGlzLnNoYXBlID0gbnVsbDsKICAgICAgdGhpcy5ib2R5ID0gbnVsbDsKICAgICAgdGhpcy5oaXRGYWNlSW5kZXggPSAtMTsKICAgICAgdGhpcy5kaXN0YW5jZSA9IC0xOwogICAgICB0aGlzLnNob3VsZFN0b3AgPSBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogYWJvcnQKICAgICAqLwoKCiAgICBhYm9ydCgpIHsKICAgICAgdGhpcy5zaG91bGRTdG9wID0gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHJlc3VsdCBkYXRhLgogICAgICovCgoKICAgIHNldChyYXlGcm9tV29ybGQsIHJheVRvV29ybGQsIGhpdE5vcm1hbFdvcmxkLCBoaXRQb2ludFdvcmxkLCBzaGFwZSwgYm9keSwgZGlzdGFuY2UpIHsKICAgICAgdGhpcy5yYXlGcm9tV29ybGQuY29weShyYXlGcm9tV29ybGQpOwogICAgICB0aGlzLnJheVRvV29ybGQuY29weShyYXlUb1dvcmxkKTsKICAgICAgdGhpcy5oaXROb3JtYWxXb3JsZC5jb3B5KGhpdE5vcm1hbFdvcmxkKTsKICAgICAgdGhpcy5oaXRQb2ludFdvcmxkLmNvcHkoaGl0UG9pbnRXb3JsZCk7CiAgICAgIHRoaXMuc2hhcGUgPSBzaGFwZTsKICAgICAgdGhpcy5ib2R5ID0gYm9keTsKICAgICAgdGhpcy5kaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgfQoKICB9CgogIGxldCBfU2hhcGUkdHlwZXMkU1BIRVJFLCBfU2hhcGUkdHlwZXMkUExBTkUsIF9TaGFwZSR0eXBlcyRCT1gsIF9TaGFwZSR0eXBlcyRDWUxJTkRFUiwgX1NoYXBlJHR5cGVzJENPTlZFWFBPLCBfU2hhcGUkdHlwZXMkSEVJR0hURkksIF9TaGFwZSR0eXBlcyRUUklNRVNIOwoKICAvKioKICAgKiBSQVlfTU9ERVMKICAgKi8KICBjb25zdCBSQVlfTU9ERVMgPSB7CiAgICAvKiogQ0xPU0VTVCAqLwogICAgQ0xPU0VTVDogMSwKCiAgICAvKiogQU5ZICovCiAgICBBTlk6IDIsCgogICAgLyoqIEFMTCAqLwogICAgQUxMOiA0CiAgfTsKICAvKioKICAgKiBSYXlNb2RlCiAgICovCgogIF9TaGFwZSR0eXBlcyRTUEhFUkUgPSBTaGFwZS50eXBlcy5TUEhFUkU7CiAgX1NoYXBlJHR5cGVzJFBMQU5FID0gU2hhcGUudHlwZXMuUExBTkU7CiAgX1NoYXBlJHR5cGVzJEJPWCA9IFNoYXBlLnR5cGVzLkJPWDsKICBfU2hhcGUkdHlwZXMkQ1lMSU5ERVIgPSBTaGFwZS50eXBlcy5DWUxJTkRFUjsKICBfU2hhcGUkdHlwZXMkQ09OVkVYUE8gPSBTaGFwZS50eXBlcy5DT05WRVhQT0xZSEVEUk9OOwogIF9TaGFwZSR0eXBlcyRIRUlHSFRGSSA9IFNoYXBlLnR5cGVzLkhFSUdIVEZJRUxEOwogIF9TaGFwZSR0eXBlcyRUUklNRVNIID0gU2hhcGUudHlwZXMuVFJJTUVTSDsKCiAgLyoqCiAgICogQSBsaW5lIGluIDNEIHNwYWNlIHRoYXQgaW50ZXJzZWN0cyBib2RpZXMgYW5kIHJldHVybiBwb2ludHMuCiAgICovCiAgY2xhc3MgUmF5IHsKICAgIC8qKgogICAgICogZnJvbQogICAgICovCgogICAgLyoqCiAgICAgKiB0bwogICAgICovCgogICAgLyoqCiAgICAgKiBkaXJlY3Rpb24KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIHByZWNpc2lvbiBvZiB0aGUgcmF5LiBVc2VkIHdoZW4gY2hlY2tpbmcgcGFyYWxsZWxpdHkgZXRjLgogICAgICogQGRlZmF1bHQgMC4wMDAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNldCB0byBgZmFsc2VgIGlmIHlvdSBkb24ndCB3YW50IHRoZSBSYXkgdG8gdGFrZSBgY29sbGlzaW9uUmVzcG9uc2VgIGZsYWdzIGludG8gYWNjb3VudCBvbiBib2RpZXMgYW5kIHNoYXBlcy4KICAgICAqIEBkZWZhdWx0IHRydWUKICAgICAqLwoKICAgIC8qKgogICAgICogSWYgc2V0IHRvIGB0cnVlYCwgdGhlIHJheSBza2lwcyBhbnkgaGl0cyB3aXRoIG5vcm1hbC5kb3QocmF5RGlyZWN0aW9uKSA8IDAuCiAgICAgKiBAZGVmYXVsdCBmYWxzZQogICAgICovCgogICAgLyoqCiAgICAgKiBjb2xsaXNpb25GaWx0ZXJNYXNrCiAgICAgKiBAZGVmYXVsdCAtMQogICAgICovCgogICAgLyoqCiAgICAgKiBjb2xsaXNpb25GaWx0ZXJHcm91cAogICAgICogQGRlZmF1bHQgLTEKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGludGVyc2VjdGlvbiBtb2RlLiBTaG91bGQgYmUgUmF5LkFOWSwgUmF5LkFMTCBvciBSYXkuQ0xPU0VTVC4KICAgICAqIEBkZWZhdWx0IFJBWS5BTlkKICAgICAqLwoKICAgIC8qKgogICAgICogQ3VycmVudCByZXN1bHQgb2JqZWN0LgogICAgICovCgogICAgLyoqCiAgICAgKiBXaWxsIGJlIHNldCB0byBgdHJ1ZWAgZHVyaW5nIGludGVyc2VjdFdvcmxkKCkgaWYgdGhlIHJheSBoaXQgYW55dGhpbmcuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFVzZXItcHJvdmlkZWQgcmVzdWx0IGNhbGxiYWNrLiBXaWxsIGJlIHVzZWQgaWYgbW9kZSBpcyBSYXkuQUxMLgogICAgICovCgogICAgLyoqCiAgICAgKiBDTE9TRVNUCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFOWQogICAgICovCgogICAgLyoqCiAgICAgKiBBTEwKICAgICAqLwogICAgZ2V0IFtfU2hhcGUkdHlwZXMkU1BIRVJFXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVyc2VjdFNwaGVyZTsKICAgIH0KCiAgICBnZXQgW19TaGFwZSR0eXBlcyRQTEFORV0oKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3RQbGFuZTsKICAgIH0KCiAgICBnZXQgW19TaGFwZSR0eXBlcyRCT1hdKCkgewogICAgICByZXR1cm4gdGhpcy5faW50ZXJzZWN0Qm94OwogICAgfQoKICAgIGdldCBbX1NoYXBlJHR5cGVzJENZTElOREVSXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVyc2VjdENvbnZleDsKICAgIH0KCiAgICBnZXQgW19TaGFwZSR0eXBlcyRDT05WRVhQT10oKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3RDb252ZXg7CiAgICB9CgogICAgZ2V0IFtfU2hhcGUkdHlwZXMkSEVJR0hURkldKCkgewogICAgICByZXR1cm4gdGhpcy5faW50ZXJzZWN0SGVpZ2h0ZmllbGQ7CiAgICB9CgogICAgZ2V0IFtfU2hhcGUkdHlwZXMkVFJJTUVTSF0oKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3RUcmltZXNoOwogICAgfQoKICAgIGNvbnN0cnVjdG9yKGZyb20sIHRvKSB7CiAgICAgIGlmIChmcm9tID09PSB2b2lkIDApIHsKICAgICAgICBmcm9tID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgaWYgKHRvID09PSB2b2lkIDApIHsKICAgICAgICB0byA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHRoaXMuZnJvbSA9IGZyb20uY2xvbmUoKTsKICAgICAgdGhpcy50byA9IHRvLmNsb25lKCk7CiAgICAgIHRoaXMuZGlyZWN0aW9uID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5wcmVjaXNpb24gPSAwLjAwMDE7CiAgICAgIHRoaXMuY2hlY2tDb2xsaXNpb25SZXNwb25zZSA9IHRydWU7CiAgICAgIHRoaXMuc2tpcEJhY2tmYWNlcyA9IGZhbHNlOwogICAgICB0aGlzLmNvbGxpc2lvbkZpbHRlck1hc2sgPSAtMTsKICAgICAgdGhpcy5jb2xsaXNpb25GaWx0ZXJHcm91cCA9IC0xOwogICAgICB0aGlzLm1vZGUgPSBSYXkuQU5ZOwogICAgICB0aGlzLnJlc3VsdCA9IG5ldyBSYXljYXN0UmVzdWx0KCk7CiAgICAgIHRoaXMuaGFzSGl0ID0gZmFsc2U7CgogICAgICB0aGlzLmNhbGxiYWNrID0gcmVzdWx0ID0+IHt9OwogICAgfQogICAgLyoqCiAgICAgKiBEbyBpdGVyc2VjdGlvbiBhZ2FpbnN0IGFsbCBib2RpZXMgaW4gdGhlIGdpdmVuIFdvcmxkLgogICAgICogQHJldHVybiBUcnVlIGlmIHRoZSByYXkgaGl0IGFueXRoaW5nLCBvdGhlcndpc2UgZmFsc2UuCiAgICAgKi8KCgogICAgaW50ZXJzZWN0V29ybGQod29ybGQsIG9wdGlvbnMpIHsKICAgICAgdGhpcy5tb2RlID0gb3B0aW9ucy5tb2RlIHx8IFJheS5BTlk7CiAgICAgIHRoaXMucmVzdWx0ID0gb3B0aW9ucy5yZXN1bHQgfHwgbmV3IFJheWNhc3RSZXN1bHQoKTsKICAgICAgdGhpcy5za2lwQmFja2ZhY2VzID0gISFvcHRpb25zLnNraXBCYWNrZmFjZXM7CiAgICAgIHRoaXMuY29sbGlzaW9uRmlsdGVyTWFzayA9IHR5cGVvZiBvcHRpb25zLmNvbGxpc2lvbkZpbHRlck1hc2sgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5jb2xsaXNpb25GaWx0ZXJNYXNrIDogLTE7CiAgICAgIHRoaXMuY29sbGlzaW9uRmlsdGVyR3JvdXAgPSB0eXBlb2Ygb3B0aW9ucy5jb2xsaXNpb25GaWx0ZXJHcm91cCAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwIDogLTE7CiAgICAgIHRoaXMuY2hlY2tDb2xsaXNpb25SZXNwb25zZSA9IHR5cGVvZiBvcHRpb25zLmNoZWNrQ29sbGlzaW9uUmVzcG9uc2UgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5jaGVja0NvbGxpc2lvblJlc3BvbnNlIDogdHJ1ZTsKCiAgICAgIGlmIChvcHRpb25zLmZyb20pIHsKICAgICAgICB0aGlzLmZyb20uY29weShvcHRpb25zLmZyb20pOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy50bykgewogICAgICAgIHRoaXMudG8uY29weShvcHRpb25zLnRvKTsKICAgICAgfQoKICAgICAgdGhpcy5jYWxsYmFjayA9IG9wdGlvbnMuY2FsbGJhY2sgfHwgKCgpID0+IHt9KTsKCiAgICAgIHRoaXMuaGFzSGl0ID0gZmFsc2U7CiAgICAgIHRoaXMucmVzdWx0LnJlc2V0KCk7CiAgICAgIHRoaXMudXBkYXRlRGlyZWN0aW9uKCk7CiAgICAgIHRoaXMuZ2V0QUFCQih0bXBBQUJCJDEpOwogICAgICB0bXBBcnJheS5sZW5ndGggPSAwOwogICAgICB3b3JsZC5icm9hZHBoYXNlLmFhYmJRdWVyeSh3b3JsZCwgdG1wQUFCQiQxLCB0bXBBcnJheSk7CiAgICAgIHRoaXMuaW50ZXJzZWN0Qm9kaWVzKHRtcEFycmF5KTsKICAgICAgcmV0dXJuIHRoaXMuaGFzSGl0OwogICAgfQogICAgLyoqCiAgICAgKiBTaG9vdCBhIHJheSBhdCBhIGJvZHksIGdldCBiYWNrIGluZm9ybWF0aW9uIGFib3V0IHRoZSBoaXQuCiAgICAgKiBAZGVwcmVjYXRlZCBAcGFyYW0gcmVzdWx0IHNldCB0aGUgcmVzdWx0IHByb3BlcnR5IG9mIHRoZSBSYXkgaW5zdGVhZC4KICAgICAqLwoKCiAgICBpbnRlcnNlY3RCb2R5KGJvZHksIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgdGhpcy5yZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgdGhpcy51cGRhdGVEaXJlY3Rpb24oKTsKICAgICAgfQoKICAgICAgY29uc3QgY2hlY2tDb2xsaXNpb25SZXNwb25zZSA9IHRoaXMuY2hlY2tDb2xsaXNpb25SZXNwb25zZTsKCiAgICAgIGlmIChjaGVja0NvbGxpc2lvblJlc3BvbnNlICYmICFib2R5LmNvbGxpc2lvblJlc3BvbnNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoKHRoaXMuY29sbGlzaW9uRmlsdGVyR3JvdXAgJiBib2R5LmNvbGxpc2lvbkZpbHRlck1hc2spID09PSAwIHx8IChib2R5LmNvbGxpc2lvbkZpbHRlckdyb3VwICYgdGhpcy5jb2xsaXNpb25GaWx0ZXJNYXNrKSA9PT0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgeGkgPSBpbnRlcnNlY3RCb2R5X3hpOwogICAgICBjb25zdCBxaSA9IGludGVyc2VjdEJvZHlfcWk7CgogICAgICBmb3IgKGxldCBpID0gMCwgTiA9IGJvZHkuc2hhcGVzLmxlbmd0aDsgaSA8IE47IGkrKykgewogICAgICAgIGNvbnN0IHNoYXBlID0gYm9keS5zaGFwZXNbaV07CgogICAgICAgIGlmIChjaGVja0NvbGxpc2lvblJlc3BvbnNlICYmICFzaGFwZS5jb2xsaXNpb25SZXNwb25zZSkgewogICAgICAgICAgY29udGludWU7IC8vIFNraXAKICAgICAgICB9CgogICAgICAgIGJvZHkucXVhdGVybmlvbi5tdWx0KGJvZHkuc2hhcGVPcmllbnRhdGlvbnNbaV0sIHFpKTsKICAgICAgICBib2R5LnF1YXRlcm5pb24udm11bHQoYm9keS5zaGFwZU9mZnNldHNbaV0sIHhpKTsKICAgICAgICB4aS52YWRkKGJvZHkucG9zaXRpb24sIHhpKTsKICAgICAgICB0aGlzLmludGVyc2VjdFNoYXBlKHNoYXBlLCBxaSwgeGksIGJvZHkpOwoKICAgICAgICBpZiAodGhpcy5yZXN1bHQuc2hvdWxkU3RvcCkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFNob290IGEgcmF5IGF0IGFuIGFycmF5IGJvZGllcywgZ2V0IGJhY2sgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGhpdC4KICAgICAqIEBwYXJhbSBib2RpZXMgQW4gYXJyYXkgb2YgQm9keSBvYmplY3RzLgogICAgICogQGRlcHJlY2F0ZWQgQHBhcmFtIHJlc3VsdCBzZXQgdGhlIHJlc3VsdCBwcm9wZXJ0eSBvZiB0aGUgUmF5IGluc3RlYWQuCiAgICAgKgogICAgICovCgoKICAgIGludGVyc2VjdEJvZGllcyhib2RpZXMsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgdGhpcy5yZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgdGhpcy51cGRhdGVEaXJlY3Rpb24oKTsKICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBib2RpZXMubGVuZ3RoOyAhdGhpcy5yZXN1bHQuc2hvdWxkU3RvcCAmJiBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5pbnRlcnNlY3RCb2R5KGJvZGllc1tpXSk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlcyB0aGUgZGlyZWN0aW9uIHZlY3Rvci4KICAgICAqLwoKCiAgICB1cGRhdGVEaXJlY3Rpb24oKSB7CiAgICAgIHRoaXMudG8udnN1Yih0aGlzLmZyb20sIHRoaXMuZGlyZWN0aW9uKTsKICAgICAgdGhpcy5kaXJlY3Rpb24ubm9ybWFsaXplKCk7CiAgICB9CgogICAgaW50ZXJzZWN0U2hhcGUoc2hhcGUsIHF1YXQsIHBvc2l0aW9uLCBib2R5KSB7CiAgICAgIGNvbnN0IGZyb20gPSB0aGlzLmZyb207IC8vIENoZWNraW5nIGJvdW5kaW5nU3BoZXJlCgogICAgICBjb25zdCBkaXN0YW5jZSA9IGRpc3RhbmNlRnJvbUludGVyc2VjdGlvbihmcm9tLCB0aGlzLmRpcmVjdGlvbiwgcG9zaXRpb24pOwoKICAgICAgaWYgKGRpc3RhbmNlID4gc2hhcGUuYm91bmRpbmdTcGhlcmVSYWRpdXMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IGludGVyc2VjdE1ldGhvZCA9IHRoaXNbc2hhcGUudHlwZV07CgogICAgICBpZiAoaW50ZXJzZWN0TWV0aG9kKSB7CiAgICAgICAgaW50ZXJzZWN0TWV0aG9kLmNhbGwodGhpcywgc2hhcGUsIHF1YXQsIHBvc2l0aW9uLCBib2R5LCBzaGFwZSk7CiAgICAgIH0KICAgIH0KCiAgICBfaW50ZXJzZWN0Qm94KGJveCwgcXVhdCwgcG9zaXRpb24sIGJvZHksIHJlcG9ydGVkU2hhcGUpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVyc2VjdENvbnZleChib3guY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLCBxdWF0LCBwb3NpdGlvbiwgYm9keSwgcmVwb3J0ZWRTaGFwZSk7CiAgICB9CgogICAgX2ludGVyc2VjdFBsYW5lKHNoYXBlLCBxdWF0LCBwb3NpdGlvbiwgYm9keSwgcmVwb3J0ZWRTaGFwZSkgewogICAgICBjb25zdCBmcm9tID0gdGhpcy5mcm9tOwogICAgICBjb25zdCB0byA9IHRoaXMudG87CiAgICAgIGNvbnN0IGRpcmVjdGlvbiA9IHRoaXMuZGlyZWN0aW9uOyAvLyBHZXQgcGxhbmUgbm9ybWFsCgogICAgICBjb25zdCB3b3JsZE5vcm1hbCA9IG5ldyBWZWMzKDAsIDAsIDEpOwogICAgICBxdWF0LnZtdWx0KHdvcmxkTm9ybWFsLCB3b3JsZE5vcm1hbCk7CiAgICAgIGNvbnN0IGxlbiA9IG5ldyBWZWMzKCk7CiAgICAgIGZyb20udnN1Yihwb3NpdGlvbiwgbGVuKTsKICAgICAgY29uc3QgcGxhbmVUb0Zyb20gPSBsZW4uZG90KHdvcmxkTm9ybWFsKTsKICAgICAgdG8udnN1Yihwb3NpdGlvbiwgbGVuKTsKICAgICAgY29uc3QgcGxhbmVUb1RvID0gbGVuLmRvdCh3b3JsZE5vcm1hbCk7CgogICAgICBpZiAocGxhbmVUb0Zyb20gKiBwbGFuZVRvVG8gPiAwKSB7CiAgICAgICAgLy8gImZyb20iIGFuZCAidG8iIGFyZSBvbiB0aGUgc2FtZSBzaWRlIG9mIHRoZSBwbGFuZS4uLiBiYWlsIG91dAogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGZyb20uZGlzdGFuY2VUbyh0bykgPCBwbGFuZVRvRnJvbSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3Qgbl9kb3RfZGlyID0gd29ybGROb3JtYWwuZG90KGRpcmVjdGlvbik7CgogICAgICBpZiAoTWF0aC5hYnMobl9kb3RfZGlyKSA8IHRoaXMucHJlY2lzaW9uKSB7CiAgICAgICAgLy8gTm8gaW50ZXJzZWN0aW9uCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBwbGFuZVBvaW50VG9Gcm9tID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgZGlyX3NjYWxlZF93aXRoX3QgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBoaXRQb2ludFdvcmxkID0gbmV3IFZlYzMoKTsKICAgICAgZnJvbS52c3ViKHBvc2l0aW9uLCBwbGFuZVBvaW50VG9Gcm9tKTsKICAgICAgY29uc3QgdCA9IC13b3JsZE5vcm1hbC5kb3QocGxhbmVQb2ludFRvRnJvbSkgLyBuX2RvdF9kaXI7CiAgICAgIGRpcmVjdGlvbi5zY2FsZSh0LCBkaXJfc2NhbGVkX3dpdGhfdCk7CiAgICAgIGZyb20udmFkZChkaXJfc2NhbGVkX3dpdGhfdCwgaGl0UG9pbnRXb3JsZCk7CiAgICAgIHRoaXMucmVwb3J0SW50ZXJzZWN0aW9uKHdvcmxkTm9ybWFsLCBoaXRQb2ludFdvcmxkLCByZXBvcnRlZFNoYXBlLCBib2R5LCAtMSk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgd29ybGQgQUFCQiBvZiB0aGUgcmF5LgogICAgICovCgoKICAgIGdldEFBQkIoYWFiYikgewogICAgICBjb25zdCB7CiAgICAgICAgbG93ZXJCb3VuZCwKICAgICAgICB1cHBlckJvdW5kCiAgICAgIH0gPSBhYWJiOwogICAgICBjb25zdCB0byA9IHRoaXMudG87CiAgICAgIGNvbnN0IGZyb20gPSB0aGlzLmZyb207CiAgICAgIGxvd2VyQm91bmQueCA9IE1hdGgubWluKHRvLngsIGZyb20ueCk7CiAgICAgIGxvd2VyQm91bmQueSA9IE1hdGgubWluKHRvLnksIGZyb20ueSk7CiAgICAgIGxvd2VyQm91bmQueiA9IE1hdGgubWluKHRvLnosIGZyb20ueik7CiAgICAgIHVwcGVyQm91bmQueCA9IE1hdGgubWF4KHRvLngsIGZyb20ueCk7CiAgICAgIHVwcGVyQm91bmQueSA9IE1hdGgubWF4KHRvLnksIGZyb20ueSk7CiAgICAgIHVwcGVyQm91bmQueiA9IE1hdGgubWF4KHRvLnosIGZyb20ueik7CiAgICB9CgogICAgX2ludGVyc2VjdEhlaWdodGZpZWxkKHNoYXBlLCBxdWF0LCBwb3NpdGlvbiwgYm9keSwgcmVwb3J0ZWRTaGFwZSkgewogICAgICBzaGFwZS5kYXRhOwogICAgICBzaGFwZS5lbGVtZW50U2l6ZTsgLy8gQ29udmVydCB0aGUgcmF5IHRvIGxvY2FsIGhlaWdodGZpZWxkIGNvb3JkaW5hdGVzCgogICAgICBjb25zdCBsb2NhbFJheSA9IGludGVyc2VjdEhlaWdodGZpZWxkX2xvY2FsUmF5OyAvL25ldyBSYXkodGhpcy5mcm9tLCB0aGlzLnRvKTsKCiAgICAgIGxvY2FsUmF5LmZyb20uY29weSh0aGlzLmZyb20pOwogICAgICBsb2NhbFJheS50by5jb3B5KHRoaXMudG8pOwogICAgICBUcmFuc2Zvcm0ucG9pbnRUb0xvY2FsRnJhbWUocG9zaXRpb24sIHF1YXQsIGxvY2FsUmF5LmZyb20sIGxvY2FsUmF5LmZyb20pOwogICAgICBUcmFuc2Zvcm0ucG9pbnRUb0xvY2FsRnJhbWUocG9zaXRpb24sIHF1YXQsIGxvY2FsUmF5LnRvLCBsb2NhbFJheS50byk7CiAgICAgIGxvY2FsUmF5LnVwZGF0ZURpcmVjdGlvbigpOyAvLyBHZXQgdGhlIGluZGV4IG9mIHRoZSBkYXRhIHBvaW50cyB0byB0ZXN0IGFnYWluc3QKCiAgICAgIGNvbnN0IGluZGV4ID0gaW50ZXJzZWN0SGVpZ2h0ZmllbGRfaW5kZXg7CiAgICAgIGxldCBpTWluWDsKICAgICAgbGV0IGlNaW5ZOwogICAgICBsZXQgaU1heFg7CiAgICAgIGxldCBpTWF4WTsgLy8gU2V0IHRvIG1heAoKICAgICAgaU1pblggPSBpTWluWSA9IDA7CiAgICAgIGlNYXhYID0gaU1heFkgPSBzaGFwZS5kYXRhLmxlbmd0aCAtIDE7CiAgICAgIGNvbnN0IGFhYmIgPSBuZXcgQUFCQigpOwogICAgICBsb2NhbFJheS5nZXRBQUJCKGFhYmIpOwogICAgICBzaGFwZS5nZXRJbmRleE9mUG9zaXRpb24oYWFiYi5sb3dlckJvdW5kLngsIGFhYmIubG93ZXJCb3VuZC55LCBpbmRleCwgdHJ1ZSk7CiAgICAgIGlNaW5YID0gTWF0aC5tYXgoaU1pblgsIGluZGV4WzBdKTsKICAgICAgaU1pblkgPSBNYXRoLm1heChpTWluWSwgaW5kZXhbMV0pOwogICAgICBzaGFwZS5nZXRJbmRleE9mUG9zaXRpb24oYWFiYi51cHBlckJvdW5kLngsIGFhYmIudXBwZXJCb3VuZC55LCBpbmRleCwgdHJ1ZSk7CiAgICAgIGlNYXhYID0gTWF0aC5taW4oaU1heFgsIGluZGV4WzBdICsgMSk7CiAgICAgIGlNYXhZID0gTWF0aC5taW4oaU1heFksIGluZGV4WzFdICsgMSk7CgogICAgICBmb3IgKGxldCBpID0gaU1pblg7IGkgPCBpTWF4WDsgaSsrKSB7CiAgICAgICAgZm9yIChsZXQgaiA9IGlNaW5ZOyBqIDwgaU1heFk7IGorKykgewogICAgICAgICAgaWYgKHRoaXMucmVzdWx0LnNob3VsZFN0b3ApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHNoYXBlLmdldEFhYmJBdEluZGV4KGksIGosIGFhYmIpOwoKICAgICAgICAgIGlmICghYWFiYi5vdmVybGFwc1JheShsb2NhbFJheSkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IC8vIExvd2VyIHRyaWFuZ2xlCgoKICAgICAgICAgIHNoYXBlLmdldENvbnZleFRyaWFuZ2xlUGlsbGFyKGksIGosIGZhbHNlKTsKICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZShwb3NpdGlvbiwgcXVhdCwgc2hhcGUucGlsbGFyT2Zmc2V0LCB3b3JsZFBpbGxhck9mZnNldCk7CgogICAgICAgICAgdGhpcy5faW50ZXJzZWN0Q29udmV4KHNoYXBlLnBpbGxhckNvbnZleCwgcXVhdCwgd29ybGRQaWxsYXJPZmZzZXQsIGJvZHksIHJlcG9ydGVkU2hhcGUsIGludGVyc2VjdENvbnZleE9wdGlvbnMpOwoKICAgICAgICAgIGlmICh0aGlzLnJlc3VsdC5zaG91bGRTdG9wKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gLy8gVXBwZXIgdHJpYW5nbGUKCgogICAgICAgICAgc2hhcGUuZ2V0Q29udmV4VHJpYW5nbGVQaWxsYXIoaSwgaiwgdHJ1ZSk7CiAgICAgICAgICBUcmFuc2Zvcm0ucG9pbnRUb1dvcmxkRnJhbWUocG9zaXRpb24sIHF1YXQsIHNoYXBlLnBpbGxhck9mZnNldCwgd29ybGRQaWxsYXJPZmZzZXQpOwoKICAgICAgICAgIHRoaXMuX2ludGVyc2VjdENvbnZleChzaGFwZS5waWxsYXJDb252ZXgsIHF1YXQsIHdvcmxkUGlsbGFyT2Zmc2V0LCBib2R5LCByZXBvcnRlZFNoYXBlLCBpbnRlcnNlY3RDb252ZXhPcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBfaW50ZXJzZWN0U3BoZXJlKHNwaGVyZSwgcXVhdCwgcG9zaXRpb24sIGJvZHksIHJlcG9ydGVkU2hhcGUpIHsKICAgICAgY29uc3QgZnJvbSA9IHRoaXMuZnJvbTsKICAgICAgY29uc3QgdG8gPSB0aGlzLnRvOwogICAgICBjb25zdCByID0gc3BoZXJlLnJhZGl1czsKICAgICAgY29uc3QgYSA9ICh0by54IC0gZnJvbS54KSAqKiAyICsgKHRvLnkgLSBmcm9tLnkpICoqIDIgKyAodG8ueiAtIGZyb20ueikgKiogMjsKICAgICAgY29uc3QgYiA9IDIgKiAoKHRvLnggLSBmcm9tLngpICogKGZyb20ueCAtIHBvc2l0aW9uLngpICsgKHRvLnkgLSBmcm9tLnkpICogKGZyb20ueSAtIHBvc2l0aW9uLnkpICsgKHRvLnogLSBmcm9tLnopICogKGZyb20ueiAtIHBvc2l0aW9uLnopKTsKICAgICAgY29uc3QgYyA9IChmcm9tLnggLSBwb3NpdGlvbi54KSAqKiAyICsgKGZyb20ueSAtIHBvc2l0aW9uLnkpICoqIDIgKyAoZnJvbS56IC0gcG9zaXRpb24ueikgKiogMiAtIHIgKiogMjsKICAgICAgY29uc3QgZGVsdGEgPSBiICoqIDIgLSA0ICogYSAqIGM7CiAgICAgIGNvbnN0IGludGVyc2VjdGlvblBvaW50ID0gUmF5X2ludGVyc2VjdFNwaGVyZV9pbnRlcnNlY3Rpb25Qb2ludDsKICAgICAgY29uc3Qgbm9ybWFsID0gUmF5X2ludGVyc2VjdFNwaGVyZV9ub3JtYWw7CgogICAgICBpZiAoZGVsdGEgPCAwKSB7CiAgICAgICAgLy8gTm8gaW50ZXJzZWN0aW9uCiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKGRlbHRhID09PSAwKSB7CiAgICAgICAgLy8gc2luZ2xlIGludGVyc2VjdGlvbiBwb2ludAogICAgICAgIGZyb20ubGVycCh0bywgZGVsdGEsIGludGVyc2VjdGlvblBvaW50KTsKICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludC52c3ViKHBvc2l0aW9uLCBub3JtYWwpOwogICAgICAgIG5vcm1hbC5ub3JtYWxpemUoKTsKICAgICAgICB0aGlzLnJlcG9ydEludGVyc2VjdGlvbihub3JtYWwsIGludGVyc2VjdGlvblBvaW50LCByZXBvcnRlZFNoYXBlLCBib2R5LCAtMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgZDEgPSAoLWIgLSBNYXRoLnNxcnQoZGVsdGEpKSAvICgyICogYSk7CiAgICAgICAgY29uc3QgZDIgPSAoLWIgKyBNYXRoLnNxcnQoZGVsdGEpKSAvICgyICogYSk7CgogICAgICAgIGlmIChkMSA+PSAwICYmIGQxIDw9IDEpIHsKICAgICAgICAgIGZyb20ubGVycCh0bywgZDEsIGludGVyc2VjdGlvblBvaW50KTsKICAgICAgICAgIGludGVyc2VjdGlvblBvaW50LnZzdWIocG9zaXRpb24sIG5vcm1hbCk7CiAgICAgICAgICBub3JtYWwubm9ybWFsaXplKCk7CiAgICAgICAgICB0aGlzLnJlcG9ydEludGVyc2VjdGlvbihub3JtYWwsIGludGVyc2VjdGlvblBvaW50LCByZXBvcnRlZFNoYXBlLCBib2R5LCAtMSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5yZXN1bHQuc2hvdWxkU3RvcCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGQyID49IDAgJiYgZDIgPD0gMSkgewogICAgICAgICAgZnJvbS5sZXJwKHRvLCBkMiwgaW50ZXJzZWN0aW9uUG9pbnQpOwogICAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQudnN1Yihwb3NpdGlvbiwgbm9ybWFsKTsKICAgICAgICAgIG5vcm1hbC5ub3JtYWxpemUoKTsKICAgICAgICAgIHRoaXMucmVwb3J0SW50ZXJzZWN0aW9uKG5vcm1hbCwgaW50ZXJzZWN0aW9uUG9pbnQsIHJlcG9ydGVkU2hhcGUsIGJvZHksIC0xKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBfaW50ZXJzZWN0Q29udmV4KHNoYXBlLCBxdWF0LCBwb3NpdGlvbiwgYm9keSwgcmVwb3J0ZWRTaGFwZSwgb3B0aW9ucykgewogICAgICBjb25zdCBub3JtYWwgPSBpbnRlcnNlY3RDb252ZXhfbm9ybWFsOwogICAgICBjb25zdCB2ZWN0b3IgPSBpbnRlcnNlY3RDb252ZXhfdmVjdG9yOwogICAgICBjb25zdCBmYWNlTGlzdCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5mYWNlTGlzdCB8fCBudWxsOyAvLyBDaGVja2luZyBmYWNlcwoKICAgICAgY29uc3QgZmFjZXMgPSBzaGFwZS5mYWNlczsKICAgICAgY29uc3QgdmVydGljZXMgPSBzaGFwZS52ZXJ0aWNlczsKICAgICAgY29uc3Qgbm9ybWFscyA9IHNoYXBlLmZhY2VOb3JtYWxzOwogICAgICBjb25zdCBkaXJlY3Rpb24gPSB0aGlzLmRpcmVjdGlvbjsKICAgICAgY29uc3QgZnJvbSA9IHRoaXMuZnJvbTsKICAgICAgY29uc3QgdG8gPSB0aGlzLnRvOwogICAgICBjb25zdCBmcm9tVG9EaXN0YW5jZSA9IGZyb20uZGlzdGFuY2VUbyh0byk7CiAgICAgIGNvbnN0IE5mYWNlcyA9IGZhY2VMaXN0ID8gZmFjZUxpc3QubGVuZ3RoIDogZmFjZXMubGVuZ3RoOwogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnJlc3VsdDsKCiAgICAgIGZvciAobGV0IGogPSAwOyAhcmVzdWx0LnNob3VsZFN0b3AgJiYgaiA8IE5mYWNlczsgaisrKSB7CiAgICAgICAgY29uc3QgZmkgPSBmYWNlTGlzdCA/IGZhY2VMaXN0W2pdIDogajsKICAgICAgICBjb25zdCBmYWNlID0gZmFjZXNbZmldOwogICAgICAgIGNvbnN0IGZhY2VOb3JtYWwgPSBub3JtYWxzW2ZpXTsKICAgICAgICBjb25zdCBxID0gcXVhdDsKICAgICAgICBjb25zdCB4ID0gcG9zaXRpb247IC8vIGRldGVybWluZSBpZiByYXkgaW50ZXJzZWN0cyB0aGUgcGxhbmUgb2YgdGhlIGZhY2UKICAgICAgICAvLyBub3RlOiB0aGlzIHdvcmtzIHJlZ2FyZGxlc3Mgb2YgdGhlIGRpcmVjdGlvbiBvZiB0aGUgZmFjZSBub3JtYWwKICAgICAgICAvLyBHZXQgcGxhbmUgcG9pbnQgaW4gd29ybGQgY29vcmRpbmF0ZXMuLi4KCiAgICAgICAgdmVjdG9yLmNvcHkodmVydGljZXNbZmFjZVswXV0pOwogICAgICAgIHEudm11bHQodmVjdG9yLCB2ZWN0b3IpOwogICAgICAgIHZlY3Rvci52YWRkKHgsIHZlY3Rvcik7IC8vIC4uLmJ1dCBtYWtlIGl0IHJlbGF0aXZlIHRvIHRoZSByYXkgZnJvbS4gV2UnbGwgZml4IHRoaXMgbGF0ZXIuCgogICAgICAgIHZlY3Rvci52c3ViKGZyb20sIHZlY3Rvcik7IC8vIEdldCBwbGFuZSBub3JtYWwKCiAgICAgICAgcS52bXVsdChmYWNlTm9ybWFsLCBub3JtYWwpOyAvLyBJZiB0aGlzIGRvdCBwcm9kdWN0IGlzIG5lZ2F0aXZlLCB3ZSBoYXZlIHNvbWV0aGluZyBpbnRlcmVzdGluZwoKICAgICAgICBjb25zdCBkb3QgPSBkaXJlY3Rpb24uZG90KG5vcm1hbCk7IC8vIEJhaWwgb3V0IGlmIHJheSBhbmQgcGxhbmUgYXJlIHBhcmFsbGVsCgogICAgICAgIGlmIChNYXRoLmFicyhkb3QpIDwgdGhpcy5wcmVjaXNpb24pIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0gLy8gY2FsYyBkaXN0YW5jZSB0byBwbGFuZQoKCiAgICAgICAgY29uc3Qgc2NhbGFyID0gbm9ybWFsLmRvdCh2ZWN0b3IpIC8gZG90OyAvLyBpZiBuZWdhdGl2ZSBkaXN0YW5jZSwgdGhlbiBwbGFuZSBpcyBiZWhpbmQgcmF5CgogICAgICAgIGlmIChzY2FsYXIgPCAwKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9IC8vIGlmIChkb3QgPCAwKSB7CiAgICAgICAgLy8gSW50ZXJzZWN0aW9uIHBvaW50IGlzIGZyb20gKyBkaXJlY3Rpb24gKiBzY2FsYXIKCgogICAgICAgIGRpcmVjdGlvbi5zY2FsZShzY2FsYXIsIGludGVyc2VjdFBvaW50KTsKICAgICAgICBpbnRlcnNlY3RQb2ludC52YWRkKGZyb20sIGludGVyc2VjdFBvaW50KTsgLy8gYSBpcyB0aGUgcG9pbnQgd2UgY29tcGFyZSBwb2ludHMgYiBhbmQgYyB3aXRoLgoKICAgICAgICBhLmNvcHkodmVydGljZXNbZmFjZVswXV0pOwogICAgICAgIHEudm11bHQoYSwgYSk7CiAgICAgICAgeC52YWRkKGEsIGEpOwoKICAgICAgICBmb3IgKGxldCBpID0gMTsgIXJlc3VsdC5zaG91bGRTdG9wICYmIGkgPCBmYWNlLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgLy8gVHJhbnNmb3JtIDMgdmVydGljZXMgdG8gd29ybGQgY29vcmRzCiAgICAgICAgICBiLmNvcHkodmVydGljZXNbZmFjZVtpXV0pOwogICAgICAgICAgYy5jb3B5KHZlcnRpY2VzW2ZhY2VbaSArIDFdXSk7CiAgICAgICAgICBxLnZtdWx0KGIsIGIpOwogICAgICAgICAgcS52bXVsdChjLCBjKTsKICAgICAgICAgIHgudmFkZChiLCBiKTsKICAgICAgICAgIHgudmFkZChjLCBjKTsKICAgICAgICAgIGNvbnN0IGRpc3RhbmNlID0gaW50ZXJzZWN0UG9pbnQuZGlzdGFuY2VUbyhmcm9tKTsKCiAgICAgICAgICBpZiAoIShSYXkucG9pbnRJblRyaWFuZ2xlKGludGVyc2VjdFBvaW50LCBhLCBiLCBjKSB8fCBSYXkucG9pbnRJblRyaWFuZ2xlKGludGVyc2VjdFBvaW50LCBiLCBhLCBjKSkgfHwgZGlzdGFuY2UgPiBmcm9tVG9EaXN0YW5jZSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLnJlcG9ydEludGVyc2VjdGlvbihub3JtYWwsIGludGVyc2VjdFBvaW50LCByZXBvcnRlZFNoYXBlLCBib2R5LCBmaSk7CiAgICAgICAgfSAvLyB9CgogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEB0b2RvIE9wdGltaXplIGJ5IHRyYW5zZm9ybWluZyB0aGUgd29ybGQgdG8gbG9jYWwgc3BhY2UgZmlyc3QuCiAgICAgKiBAdG9kbyBVc2UgT2N0cmVlIGxvb2t1cAogICAgICovCgoKICAgIF9pbnRlcnNlY3RUcmltZXNoKG1lc2gsIHF1YXQsIHBvc2l0aW9uLCBib2R5LCByZXBvcnRlZFNoYXBlLCBvcHRpb25zKSB7CiAgICAgIGNvbnN0IG5vcm1hbCA9IGludGVyc2VjdFRyaW1lc2hfbm9ybWFsOwogICAgICBjb25zdCB0cmlhbmdsZXMgPSBpbnRlcnNlY3RUcmltZXNoX3RyaWFuZ2xlczsKICAgICAgY29uc3QgdHJlZVRyYW5zZm9ybSA9IGludGVyc2VjdFRyaW1lc2hfdHJlZVRyYW5zZm9ybTsKICAgICAgY29uc3QgdmVjdG9yID0gaW50ZXJzZWN0Q29udmV4X3ZlY3RvcjsKICAgICAgY29uc3QgbG9jYWxEaXJlY3Rpb24gPSBpbnRlcnNlY3RUcmltZXNoX2xvY2FsRGlyZWN0aW9uOwogICAgICBjb25zdCBsb2NhbEZyb20gPSBpbnRlcnNlY3RUcmltZXNoX2xvY2FsRnJvbTsKICAgICAgY29uc3QgbG9jYWxUbyA9IGludGVyc2VjdFRyaW1lc2hfbG9jYWxUbzsKICAgICAgY29uc3Qgd29ybGRJbnRlcnNlY3RQb2ludCA9IGludGVyc2VjdFRyaW1lc2hfd29ybGRJbnRlcnNlY3RQb2ludDsKICAgICAgY29uc3Qgd29ybGROb3JtYWwgPSBpbnRlcnNlY3RUcmltZXNoX3dvcmxkTm9ybWFsOyAvLyBDaGVja2luZyBmYWNlcwoKICAgICAgY29uc3QgaW5kaWNlcyA9IG1lc2guaW5kaWNlczsKICAgICAgbWVzaC52ZXJ0aWNlczsgLy8gY29uc3Qgbm9ybWFscyA9IG1lc2guZmFjZU5vcm1hbHMKCiAgICAgIGNvbnN0IGZyb20gPSB0aGlzLmZyb207CiAgICAgIGNvbnN0IHRvID0gdGhpcy50bzsKICAgICAgY29uc3QgZGlyZWN0aW9uID0gdGhpcy5kaXJlY3Rpb247CiAgICAgIHRyZWVUcmFuc2Zvcm0ucG9zaXRpb24uY29weShwb3NpdGlvbik7CiAgICAgIHRyZWVUcmFuc2Zvcm0ucXVhdGVybmlvbi5jb3B5KHF1YXQpOyAvLyBUcmFuc2Zvcm0gcmF5IHRvIGxvY2FsIHNwYWNlIQoKICAgICAgVHJhbnNmb3JtLnZlY3RvclRvTG9jYWxGcmFtZShwb3NpdGlvbiwgcXVhdCwgZGlyZWN0aW9uLCBsb2NhbERpcmVjdGlvbik7CiAgICAgIFRyYW5zZm9ybS5wb2ludFRvTG9jYWxGcmFtZShwb3NpdGlvbiwgcXVhdCwgZnJvbSwgbG9jYWxGcm9tKTsKICAgICAgVHJhbnNmb3JtLnBvaW50VG9Mb2NhbEZyYW1lKHBvc2l0aW9uLCBxdWF0LCB0bywgbG9jYWxUbyk7CiAgICAgIGxvY2FsVG8ueCAqPSBtZXNoLnNjYWxlLng7CiAgICAgIGxvY2FsVG8ueSAqPSBtZXNoLnNjYWxlLnk7CiAgICAgIGxvY2FsVG8ueiAqPSBtZXNoLnNjYWxlLno7CiAgICAgIGxvY2FsRnJvbS54ICo9IG1lc2guc2NhbGUueDsKICAgICAgbG9jYWxGcm9tLnkgKj0gbWVzaC5zY2FsZS55OwogICAgICBsb2NhbEZyb20ueiAqPSBtZXNoLnNjYWxlLno7CiAgICAgIGxvY2FsVG8udnN1Yihsb2NhbEZyb20sIGxvY2FsRGlyZWN0aW9uKTsKICAgICAgbG9jYWxEaXJlY3Rpb24ubm9ybWFsaXplKCk7CiAgICAgIGNvbnN0IGZyb21Ub0Rpc3RhbmNlU3F1YXJlZCA9IGxvY2FsRnJvbS5kaXN0YW5jZVNxdWFyZWQobG9jYWxUbyk7CiAgICAgIG1lc2gudHJlZS5yYXlRdWVyeSh0aGlzLCB0cmVlVHJhbnNmb3JtLCB0cmlhbmdsZXMpOwoKICAgICAgZm9yIChsZXQgaSA9IDAsIE4gPSB0cmlhbmdsZXMubGVuZ3RoOyAhdGhpcy5yZXN1bHQuc2hvdWxkU3RvcCAmJiBpICE9PSBOOyBpKyspIHsKICAgICAgICBjb25zdCB0cmlhbmdsZXNJbmRleCA9IHRyaWFuZ2xlc1tpXTsKICAgICAgICBtZXNoLmdldE5vcm1hbCh0cmlhbmdsZXNJbmRleCwgbm9ybWFsKTsgLy8gZGV0ZXJtaW5lIGlmIHJheSBpbnRlcnNlY3RzIHRoZSBwbGFuZSBvZiB0aGUgZmFjZQogICAgICAgIC8vIG5vdGU6IHRoaXMgd29ya3MgcmVnYXJkbGVzcyBvZiB0aGUgZGlyZWN0aW9uIG9mIHRoZSBmYWNlIG5vcm1hbAogICAgICAgIC8vIEdldCBwbGFuZSBwb2ludCBpbiB3b3JsZCBjb29yZGluYXRlcy4uLgoKICAgICAgICBtZXNoLmdldFZlcnRleChpbmRpY2VzW3RyaWFuZ2xlc0luZGV4ICogM10sIGEpOyAvLyAuLi5idXQgbWFrZSBpdCByZWxhdGl2ZSB0byB0aGUgcmF5IGZyb20uIFdlJ2xsIGZpeCB0aGlzIGxhdGVyLgoKICAgICAgICBhLnZzdWIobG9jYWxGcm9tLCB2ZWN0b3IpOyAvLyBJZiB0aGlzIGRvdCBwcm9kdWN0IGlzIG5lZ2F0aXZlLCB3ZSBoYXZlIHNvbWV0aGluZyBpbnRlcmVzdGluZwoKICAgICAgICBjb25zdCBkb3QgPSBsb2NhbERpcmVjdGlvbi5kb3Qobm9ybWFsKTsgLy8gQmFpbCBvdXQgaWYgcmF5IGFuZCBwbGFuZSBhcmUgcGFyYWxsZWwKICAgICAgICAvLyBpZiAoTWF0aC5hYnMoIGRvdCApIDwgdGhpcy5wcmVjaXNpb24pewogICAgICAgIC8vICAgICBjb250aW51ZTsKICAgICAgICAvLyB9CiAgICAgICAgLy8gY2FsYyBkaXN0YW5jZSB0byBwbGFuZQoKICAgICAgICBjb25zdCBzY2FsYXIgPSBub3JtYWwuZG90KHZlY3RvcikgLyBkb3Q7IC8vIGlmIG5lZ2F0aXZlIGRpc3RhbmNlLCB0aGVuIHBsYW5lIGlzIGJlaGluZCByYXkKCiAgICAgICAgaWYgKHNjYWxhciA8IDApIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0gLy8gSW50ZXJzZWN0aW9uIHBvaW50IGlzIGZyb20gKyBkaXJlY3Rpb24gKiBzY2FsYXIKCgogICAgICAgIGxvY2FsRGlyZWN0aW9uLnNjYWxlKHNjYWxhciwgaW50ZXJzZWN0UG9pbnQpOwogICAgICAgIGludGVyc2VjdFBvaW50LnZhZGQobG9jYWxGcm9tLCBpbnRlcnNlY3RQb2ludCk7IC8vIEdldCB0cmlhbmdsZSB2ZXJ0aWNlcwoKICAgICAgICBtZXNoLmdldFZlcnRleChpbmRpY2VzW3RyaWFuZ2xlc0luZGV4ICogMyArIDFdLCBiKTsKICAgICAgICBtZXNoLmdldFZlcnRleChpbmRpY2VzW3RyaWFuZ2xlc0luZGV4ICogMyArIDJdLCBjKTsKICAgICAgICBjb25zdCBzcXVhcmVkRGlzdGFuY2UgPSBpbnRlcnNlY3RQb2ludC5kaXN0YW5jZVNxdWFyZWQobG9jYWxGcm9tKTsKCiAgICAgICAgaWYgKCEoUmF5LnBvaW50SW5UcmlhbmdsZShpbnRlcnNlY3RQb2ludCwgYiwgYSwgYykgfHwgUmF5LnBvaW50SW5UcmlhbmdsZShpbnRlcnNlY3RQb2ludCwgYSwgYiwgYykpIHx8IHNxdWFyZWREaXN0YW5jZSA+IGZyb21Ub0Rpc3RhbmNlU3F1YXJlZCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfSAvLyB0cmFuc2Zvcm0gaW50ZXJzZWN0cG9pbnQgYW5kIG5vcm1hbCB0byB3b3JsZAoKCiAgICAgICAgVHJhbnNmb3JtLnZlY3RvclRvV29ybGRGcmFtZShxdWF0LCBub3JtYWwsIHdvcmxkTm9ybWFsKTsKICAgICAgICBUcmFuc2Zvcm0ucG9pbnRUb1dvcmxkRnJhbWUocG9zaXRpb24sIHF1YXQsIGludGVyc2VjdFBvaW50LCB3b3JsZEludGVyc2VjdFBvaW50KTsKICAgICAgICB0aGlzLnJlcG9ydEludGVyc2VjdGlvbih3b3JsZE5vcm1hbCwgd29ybGRJbnRlcnNlY3RQb2ludCwgcmVwb3J0ZWRTaGFwZSwgYm9keSwgdHJpYW5nbGVzSW5kZXgpOwogICAgICB9CgogICAgICB0cmlhbmdsZXMubGVuZ3RoID0gMDsKICAgIH0KICAgIC8qKgogICAgICogQHJldHVybiBUcnVlIGlmIHRoZSBpbnRlcnNlY3Rpb25zIHNob3VsZCBjb250aW51ZQogICAgICovCgoKICAgIHJlcG9ydEludGVyc2VjdGlvbihub3JtYWwsIGhpdFBvaW50V29ybGQsIHNoYXBlLCBib2R5LCBoaXRGYWNlSW5kZXgpIHsKICAgICAgY29uc3QgZnJvbSA9IHRoaXMuZnJvbTsKICAgICAgY29uc3QgdG8gPSB0aGlzLnRvOwogICAgICBjb25zdCBkaXN0YW5jZSA9IGZyb20uZGlzdGFuY2VUbyhoaXRQb2ludFdvcmxkKTsKICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5yZXN1bHQ7IC8vIFNraXAgYmFjayBmYWNlcz8KCiAgICAgIGlmICh0aGlzLnNraXBCYWNrZmFjZXMgJiYgbm9ybWFsLmRvdCh0aGlzLmRpcmVjdGlvbikgPiAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICByZXN1bHQuaGl0RmFjZUluZGV4ID0gdHlwZW9mIGhpdEZhY2VJbmRleCAhPT0gJ3VuZGVmaW5lZCcgPyBoaXRGYWNlSW5kZXggOiAtMTsKCiAgICAgIHN3aXRjaCAodGhpcy5tb2RlKSB7CiAgICAgICAgY2FzZSBSYXkuQUxMOgogICAgICAgICAgdGhpcy5oYXNIaXQgPSB0cnVlOwogICAgICAgICAgcmVzdWx0LnNldChmcm9tLCB0bywgbm9ybWFsLCBoaXRQb2ludFdvcmxkLCBzaGFwZSwgYm9keSwgZGlzdGFuY2UpOwogICAgICAgICAgcmVzdWx0Lmhhc0hpdCA9IHRydWU7CiAgICAgICAgICB0aGlzLmNhbGxiYWNrKHJlc3VsdCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBSYXkuQ0xPU0VTVDoKICAgICAgICAgIC8vIFN0b3JlIGlmIGNsb3NlciB0aGFuIGN1cnJlbnQgY2xvc2VzdAogICAgICAgICAgaWYgKGRpc3RhbmNlIDwgcmVzdWx0LmRpc3RhbmNlIHx8ICFyZXN1bHQuaGFzSGl0KSB7CiAgICAgICAgICAgIHRoaXMuaGFzSGl0ID0gdHJ1ZTsKICAgICAgICAgICAgcmVzdWx0Lmhhc0hpdCA9IHRydWU7CiAgICAgICAgICAgIHJlc3VsdC5zZXQoZnJvbSwgdG8sIG5vcm1hbCwgaGl0UG9pbnRXb3JsZCwgc2hhcGUsIGJvZHksIGRpc3RhbmNlKTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBSYXkuQU5ZOgogICAgICAgICAgLy8gUmVwb3J0IGFuZCBzdG9wLgogICAgICAgICAgdGhpcy5oYXNIaXQgPSB0cnVlOwogICAgICAgICAgcmVzdWx0Lmhhc0hpdCA9IHRydWU7CiAgICAgICAgICByZXN1bHQuc2V0KGZyb20sIHRvLCBub3JtYWwsIGhpdFBvaW50V29ybGQsIHNoYXBlLCBib2R5LCBkaXN0YW5jZSk7CiAgICAgICAgICByZXN1bHQuc2hvdWxkU3RvcCA9IHRydWU7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBBcyBwZXIgIkJhcnljZW50cmljIFRlY2huaXF1ZSIgYXMgbmFtZWQKICAgICAqIHtAbGluayBodHRwczovL3d3dy5ibGFja3Bhd24uY29tL3RleHRzL3BvaW50aW5wb2x5L2RlZmF1bHQuaHRtbCBoZXJlfSBidXQgd2l0aG91dCB0aGUgZGl2aXNpb24KICAgICAqLwoKCiAgICBzdGF0aWMgcG9pbnRJblRyaWFuZ2xlKHAsIGEsIGIsIGMpIHsKICAgICAgYy52c3ViKGEsIHYwKTsKICAgICAgYi52c3ViKGEsIHYxKTsKICAgICAgcC52c3ViKGEsIHYyKTsKICAgICAgY29uc3QgZG90MDAgPSB2MC5kb3QodjApOwogICAgICBjb25zdCBkb3QwMSA9IHYwLmRvdCh2MSk7CiAgICAgIGNvbnN0IGRvdDAyID0gdjAuZG90KHYyKTsKICAgICAgY29uc3QgZG90MTEgPSB2MS5kb3QodjEpOwogICAgICBjb25zdCBkb3QxMiA9IHYxLmRvdCh2Mik7CiAgICAgIGxldCB1OwogICAgICBsZXQgdjsKICAgICAgcmV0dXJuICh1ID0gZG90MTEgKiBkb3QwMiAtIGRvdDAxICogZG90MTIpID49IDAgJiYgKHYgPSBkb3QwMCAqIGRvdDEyIC0gZG90MDEgKiBkb3QwMikgPj0gMCAmJiB1ICsgdiA8IGRvdDAwICogZG90MTEgLSBkb3QwMSAqIGRvdDAxOwogICAgfQoKICB9CiAgUmF5LkNMT1NFU1QgPSBSQVlfTU9ERVMuQ0xPU0VTVDsKICBSYXkuQU5ZID0gUkFZX01PREVTLkFOWTsKICBSYXkuQUxMID0gUkFZX01PREVTLkFMTDsKICBjb25zdCB0bXBBQUJCJDEgPSBuZXcgQUFCQigpOwogIGNvbnN0IHRtcEFycmF5ID0gW107CiAgY29uc3QgdjEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHYyID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RCb2R5X3hpID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RCb2R5X3FpID0gbmV3IFF1YXRlcm5pb24oKTsKICBjb25zdCBpbnRlcnNlY3RQb2ludCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYyA9IG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgUmF5Y2FzdFJlc3VsdCgpOwogIGNvbnN0IGludGVyc2VjdENvbnZleE9wdGlvbnMgPSB7CiAgICBmYWNlTGlzdDogWzBdCiAgfTsKICBjb25zdCB3b3JsZFBpbGxhck9mZnNldCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW50ZXJzZWN0SGVpZ2h0ZmllbGRfbG9jYWxSYXkgPSBuZXcgUmF5KCk7CiAgY29uc3QgaW50ZXJzZWN0SGVpZ2h0ZmllbGRfaW5kZXggPSBbXTsKICBjb25zdCBSYXlfaW50ZXJzZWN0U3BoZXJlX2ludGVyc2VjdGlvblBvaW50ID0gbmV3IFZlYzMoKTsKICBjb25zdCBSYXlfaW50ZXJzZWN0U3BoZXJlX25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW50ZXJzZWN0Q29udmV4X25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIGNvbnN0IGludGVyc2VjdENvbnZleF92ZWN0b3IgPSBuZXcgVmVjMygpOwogIGNvbnN0IGludGVyc2VjdFRyaW1lc2hfbm9ybWFsID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RUcmltZXNoX2xvY2FsRGlyZWN0aW9uID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RUcmltZXNoX2xvY2FsRnJvbSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW50ZXJzZWN0VHJpbWVzaF9sb2NhbFRvID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RUcmltZXNoX3dvcmxkTm9ybWFsID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RUcmltZXNoX3dvcmxkSW50ZXJzZWN0UG9pbnQgPSBuZXcgVmVjMygpOwogIG5ldyBBQUJCKCk7CiAgY29uc3QgaW50ZXJzZWN0VHJpbWVzaF90cmlhbmdsZXMgPSBbXTsKICBjb25zdCBpbnRlcnNlY3RUcmltZXNoX3RyZWVUcmFuc2Zvcm0gPSBuZXcgVHJhbnNmb3JtKCk7CiAgY29uc3QgdjAgPSBuZXcgVmVjMygpOwogIGNvbnN0IGludGVyc2VjdCA9IG5ldyBWZWMzKCk7CgogIGZ1bmN0aW9uIGRpc3RhbmNlRnJvbUludGVyc2VjdGlvbihmcm9tLCBkaXJlY3Rpb24sIHBvc2l0aW9uKSB7CiAgICAvLyB2MCBpcyB2ZWN0b3IgZnJvbSBmcm9tIHRvIHBvc2l0aW9uCiAgICBwb3NpdGlvbi52c3ViKGZyb20sIHYwKTsKICAgIGNvbnN0IGRvdCA9IHYwLmRvdChkaXJlY3Rpb24pOyAvLyBpbnRlcnNlY3QgPSBkaXJlY3Rpb24qZG90ICsgZnJvbQoKICAgIGRpcmVjdGlvbi5zY2FsZShkb3QsIGludGVyc2VjdCk7CiAgICBpbnRlcnNlY3QudmFkZChmcm9tLCBpbnRlcnNlY3QpOwogICAgY29uc3QgZGlzdGFuY2UgPSBwb3NpdGlvbi5kaXN0YW5jZVRvKGludGVyc2VjdCk7CiAgICByZXR1cm4gZGlzdGFuY2U7CiAgfQoKICAvKioKICAgKiBTd2VlcCBhbmQgcHJ1bmUgYnJvYWRwaGFzZSBhbG9uZyBvbmUgYXhpcy4KICAgKi8KICBjbGFzcyBTQVBCcm9hZHBoYXNlIGV4dGVuZHMgQnJvYWRwaGFzZSB7CiAgICAvKioKICAgICAqIExpc3Qgb2YgYm9kaWVzIGN1cnJlbnRseSBpbiB0aGUgYnJvYWRwaGFzZS4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIHdvcmxkIHRvIHNlYXJjaCBpbi4KICAgICAqLwoKICAgIC8qKgogICAgICogQXhpcyB0byBzb3J0IHRoZSBib2RpZXMgYWxvbmcuCiAgICAgKiBTZXQgdG8gMCBmb3IgeCBheGlzLCBhbmQgMSBmb3IgeSBheGlzLgogICAgICogRm9yIGJlc3QgcGVyZm9ybWFuY2UsIHBpY2sgdGhlIGF4aXMgd2hlcmUgYm9kaWVzIGFyZSBtb3N0IGRpc3RyaWJ1dGVkLgogICAgICovCgogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgYm91bmRzIG9mIHR3byBib2RpZXMgb3ZlcmxhcCwgYWxvbmcgdGhlIGdpdmVuIFNBUCBheGlzLgogICAgICovCiAgICBzdGF0aWMgY2hlY2tCb3VuZHMoYmksIGJqLCBheGlzSW5kZXgpIHsKICAgICAgbGV0IGJpUG9zOwogICAgICBsZXQgYmpQb3M7CgogICAgICBpZiAoYXhpc0luZGV4ID09PSAwKSB7CiAgICAgICAgYmlQb3MgPSBiaS5wb3NpdGlvbi54OwogICAgICAgIGJqUG9zID0gYmoucG9zaXRpb24ueDsKICAgICAgfSBlbHNlIGlmIChheGlzSW5kZXggPT09IDEpIHsKICAgICAgICBiaVBvcyA9IGJpLnBvc2l0aW9uLnk7CiAgICAgICAgYmpQb3MgPSBiai5wb3NpdGlvbi55OwogICAgICB9IGVsc2UgaWYgKGF4aXNJbmRleCA9PT0gMikgewogICAgICAgIGJpUG9zID0gYmkucG9zaXRpb24uejsKICAgICAgICBialBvcyA9IGJqLnBvc2l0aW9uLno7CiAgICAgIH0KCiAgICAgIGNvbnN0IHJpID0gYmkuYm91bmRpbmdSYWRpdXMsCiAgICAgICAgICAgIHJqID0gYmouYm91bmRpbmdSYWRpdXMsCiAgICAgICAgICAgIGJvdW5kQTIgPSBiaVBvcyArIHJpLAogICAgICAgICAgICBib3VuZEIxID0gYmpQb3MgLSByajsKICAgICAgcmV0dXJuIGJvdW5kQjEgPCBib3VuZEEyOwogICAgfSAvLyBOb3RlOiB0aGVzZSBhcmUgaWRlbnRpY2FsLCBzYXZlIGZvciB4L3kveiBsb3dlcmJvdW5kCgogICAgLyoqCiAgICAgKiBpbnNlcnRpb25Tb3J0WAogICAgICovCgoKICAgIHN0YXRpYyBpbnNlcnRpb25Tb3J0WChhKSB7CiAgICAgIGZvciAobGV0IGkgPSAxLCBsID0gYS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBjb25zdCB2ID0gYVtpXTsKICAgICAgICBsZXQgajsKCiAgICAgICAgZm9yIChqID0gaSAtIDE7IGogPj0gMDsgai0tKSB7CiAgICAgICAgICBpZiAoYVtqXS5hYWJiLmxvd2VyQm91bmQueCA8PSB2LmFhYmIubG93ZXJCb3VuZC54KSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICAgIGFbaiArIDFdID0gYVtqXTsKICAgICAgICB9CgogICAgICAgIGFbaiArIDFdID0gdjsKICAgICAgfQoKICAgICAgcmV0dXJuIGE7CiAgICB9CiAgICAvKioKICAgICAqIGluc2VydGlvblNvcnRZCiAgICAgKi8KCgogICAgc3RhdGljIGluc2VydGlvblNvcnRZKGEpIHsKICAgICAgZm9yIChsZXQgaSA9IDEsIGwgPSBhLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGNvbnN0IHYgPSBhW2ldOwogICAgICAgIGxldCBqOwoKICAgICAgICBmb3IgKGogPSBpIC0gMTsgaiA+PSAwOyBqLS0pIHsKICAgICAgICAgIGlmIChhW2pdLmFhYmIubG93ZXJCb3VuZC55IDw9IHYuYWFiYi5sb3dlckJvdW5kLnkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgYVtqICsgMV0gPSBhW2pdOwogICAgICAgIH0KCiAgICAgICAgYVtqICsgMV0gPSB2OwogICAgICB9CgogICAgICByZXR1cm4gYTsKICAgIH0KICAgIC8qKgogICAgICogaW5zZXJ0aW9uU29ydFoKICAgICAqLwoKCiAgICBzdGF0aWMgaW5zZXJ0aW9uU29ydFooYSkgewogICAgICBmb3IgKGxldCBpID0gMSwgbCA9IGEubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgY29uc3QgdiA9IGFbaV07CiAgICAgICAgbGV0IGo7CgogICAgICAgIGZvciAoaiA9IGkgLSAxOyBqID49IDA7IGotLSkgewogICAgICAgICAgaWYgKGFbal0uYWFiYi5sb3dlckJvdW5kLnogPD0gdi5hYWJiLmxvd2VyQm91bmQueikgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICBhW2ogKyAxXSA9IGFbal07CiAgICAgICAgfQoKICAgICAgICBhW2ogKyAxXSA9IHY7CiAgICAgIH0KCiAgICAgIHJldHVybiBhOwogICAgfQoKICAgIGNvbnN0cnVjdG9yKHdvcmxkKSB7CiAgICAgIHN1cGVyKCk7CiAgICAgIHRoaXMuYXhpc0xpc3QgPSBbXTsKICAgICAgdGhpcy53b3JsZCA9IG51bGw7CiAgICAgIHRoaXMuYXhpc0luZGV4ID0gMDsKICAgICAgY29uc3QgYXhpc0xpc3QgPSB0aGlzLmF4aXNMaXN0OwoKICAgICAgdGhpcy5fYWRkQm9keUhhbmRsZXIgPSBldmVudCA9PiB7CiAgICAgICAgYXhpc0xpc3QucHVzaChldmVudC5ib2R5KTsKICAgICAgfTsKCiAgICAgIHRoaXMuX3JlbW92ZUJvZHlIYW5kbGVyID0gZXZlbnQgPT4gewogICAgICAgIGNvbnN0IGlkeCA9IGF4aXNMaXN0LmluZGV4T2YoZXZlbnQuYm9keSk7CgogICAgICAgIGlmIChpZHggIT09IC0xKSB7CiAgICAgICAgICBheGlzTGlzdC5zcGxpY2UoaWR4LCAxKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAod29ybGQpIHsKICAgICAgICB0aGlzLnNldFdvcmxkKHdvcmxkKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDaGFuZ2UgdGhlIHdvcmxkCiAgICAgKi8KCgogICAgc2V0V29ybGQod29ybGQpIHsKICAgICAgLy8gQ2xlYXIgdGhlIG9sZCBheGlzIGFycmF5CiAgICAgIHRoaXMuYXhpc0xpc3QubGVuZ3RoID0gMDsgLy8gQWRkIGFsbCBib2RpZXMgZnJvbSB0aGUgbmV3IHdvcmxkCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdvcmxkLmJvZGllcy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuYXhpc0xpc3QucHVzaCh3b3JsZC5ib2RpZXNbaV0pOwogICAgICB9IC8vIFJlbW92ZSBvbGQgaGFuZGxlcnMsIGlmIGFueQoKCiAgICAgIHdvcmxkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2FkZEJvZHknLCB0aGlzLl9hZGRCb2R5SGFuZGxlcik7CiAgICAgIHdvcmxkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3JlbW92ZUJvZHknLCB0aGlzLl9yZW1vdmVCb2R5SGFuZGxlcik7IC8vIEFkZCBoYW5kbGVycyB0byB1cGRhdGUgdGhlIGxpc3Qgb2YgYm9kaWVzLgoKICAgICAgd29ybGQuYWRkRXZlbnRMaXN0ZW5lcignYWRkQm9keScsIHRoaXMuX2FkZEJvZHlIYW5kbGVyKTsKICAgICAgd29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncmVtb3ZlQm9keScsIHRoaXMuX3JlbW92ZUJvZHlIYW5kbGVyKTsKICAgICAgdGhpcy53b3JsZCA9IHdvcmxkOwogICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogQ29sbGVjdCBhbGwgY29sbGlzaW9uIHBhaXJzCiAgICAgKi8KCgogICAgY29sbGlzaW9uUGFpcnMod29ybGQsIHAxLCBwMikgewogICAgICBjb25zdCBib2RpZXMgPSB0aGlzLmF4aXNMaXN0OwogICAgICBjb25zdCBOID0gYm9kaWVzLmxlbmd0aDsKICAgICAgY29uc3QgYXhpc0luZGV4ID0gdGhpcy5heGlzSW5kZXg7CiAgICAgIGxldCBpOwogICAgICBsZXQgajsKCiAgICAgIGlmICh0aGlzLmRpcnR5KSB7CiAgICAgICAgdGhpcy5zb3J0TGlzdCgpOwogICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgfSAvLyBMb29rIHRocm91Z2ggdGhlIGxpc3QKCgogICAgICBmb3IgKGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBjb25zdCBiaSA9IGJvZGllc1tpXTsKCiAgICAgICAgZm9yIChqID0gaSArIDE7IGogPCBOOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGJqID0gYm9kaWVzW2pdOwoKICAgICAgICAgIGlmICghdGhpcy5uZWVkQnJvYWRwaGFzZUNvbGxpc2lvbihiaSwgYmopKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghU0FQQnJvYWRwaGFzZS5jaGVja0JvdW5kcyhiaSwgYmosIGF4aXNJbmRleCkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5pbnRlcnNlY3Rpb25UZXN0KGJpLCBiaiwgcDEsIHAyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBzb3J0TGlzdCgpIHsKICAgICAgY29uc3QgYXhpc0xpc3QgPSB0aGlzLmF4aXNMaXN0OwogICAgICBjb25zdCBheGlzSW5kZXggPSB0aGlzLmF4aXNJbmRleDsKICAgICAgY29uc3QgTiA9IGF4aXNMaXN0Lmxlbmd0aDsgLy8gVXBkYXRlIEFBQkJzCgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgY29uc3QgYmkgPSBheGlzTGlzdFtpXTsKCiAgICAgICAgaWYgKGJpLmFhYmJOZWVkc1VwZGF0ZSkgewogICAgICAgICAgYmkudXBkYXRlQUFCQigpOwogICAgICAgIH0KICAgICAgfSAvLyBTb3J0IHRoZSBsaXN0CgoKICAgICAgaWYgKGF4aXNJbmRleCA9PT0gMCkgewogICAgICAgIFNBUEJyb2FkcGhhc2UuaW5zZXJ0aW9uU29ydFgoYXhpc0xpc3QpOwogICAgICB9IGVsc2UgaWYgKGF4aXNJbmRleCA9PT0gMSkgewogICAgICAgIFNBUEJyb2FkcGhhc2UuaW5zZXJ0aW9uU29ydFkoYXhpc0xpc3QpOwogICAgICB9IGVsc2UgaWYgKGF4aXNJbmRleCA9PT0gMikgewogICAgICAgIFNBUEJyb2FkcGhhc2UuaW5zZXJ0aW9uU29ydFooYXhpc0xpc3QpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGVzIHRoZSB2YXJpYW5jZSBvZiB0aGUgYm9keSBwb3NpdGlvbnMgYW5kIGVzdGltYXRlcyB0aGUgYmVzdCBheGlzIHRvIHVzZS4KICAgICAqIFdpbGwgYXV0b21hdGljYWxseSBzZXQgcHJvcGVydHkgYGF4aXNJbmRleGAuCiAgICAgKi8KCgogICAgYXV0b0RldGVjdEF4aXMoKSB7CiAgICAgIGxldCBzdW1YID0gMDsKICAgICAgbGV0IHN1bVgyID0gMDsKICAgICAgbGV0IHN1bVkgPSAwOwogICAgICBsZXQgc3VtWTIgPSAwOwogICAgICBsZXQgc3VtWiA9IDA7CiAgICAgIGxldCBzdW1aMiA9IDA7CiAgICAgIGNvbnN0IGJvZGllcyA9IHRoaXMuYXhpc0xpc3Q7CiAgICAgIGNvbnN0IE4gPSBib2RpZXMubGVuZ3RoOwogICAgICBjb25zdCBpbnZOID0gMSAvIE47CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgY29uc3QgYiA9IGJvZGllc1tpXTsKICAgICAgICBjb25zdCBjZW50ZXJYID0gYi5wb3NpdGlvbi54OwogICAgICAgIHN1bVggKz0gY2VudGVyWDsKICAgICAgICBzdW1YMiArPSBjZW50ZXJYICogY2VudGVyWDsKICAgICAgICBjb25zdCBjZW50ZXJZID0gYi5wb3NpdGlvbi55OwogICAgICAgIHN1bVkgKz0gY2VudGVyWTsKICAgICAgICBzdW1ZMiArPSBjZW50ZXJZICogY2VudGVyWTsKICAgICAgICBjb25zdCBjZW50ZXJaID0gYi5wb3NpdGlvbi56OwogICAgICAgIHN1bVogKz0gY2VudGVyWjsKICAgICAgICBzdW1aMiArPSBjZW50ZXJaICogY2VudGVyWjsKICAgICAgfQoKICAgICAgY29uc3QgdmFyaWFuY2VYID0gc3VtWDIgLSBzdW1YICogc3VtWCAqIGludk47CiAgICAgIGNvbnN0IHZhcmlhbmNlWSA9IHN1bVkyIC0gc3VtWSAqIHN1bVkgKiBpbnZOOwogICAgICBjb25zdCB2YXJpYW5jZVogPSBzdW1aMiAtIHN1bVogKiBzdW1aICogaW52TjsKCiAgICAgIGlmICh2YXJpYW5jZVggPiB2YXJpYW5jZVkpIHsKICAgICAgICBpZiAodmFyaWFuY2VYID4gdmFyaWFuY2VaKSB7CiAgICAgICAgICB0aGlzLmF4aXNJbmRleCA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuYXhpc0luZGV4ID0gMjsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAodmFyaWFuY2VZID4gdmFyaWFuY2VaKSB7CiAgICAgICAgdGhpcy5heGlzSW5kZXggPSAxOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYXhpc0luZGV4ID0gMjsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGFsbCB0aGUgYm9kaWVzIHdpdGhpbiBhbiBBQUJCLgogICAgICogQHBhcmFtIHJlc3VsdCBBbiBhcnJheSB0byBzdG9yZSByZXN1bHRpbmcgYm9kaWVzIGluLgogICAgICovCgoKICAgIGFhYmJRdWVyeSh3b3JsZCwgYWFiYiwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IFtdOwogICAgICB9CgogICAgICBpZiAodGhpcy5kaXJ0eSkgewogICAgICAgIHRoaXMuc29ydExpc3QoKTsKICAgICAgICB0aGlzLmRpcnR5ID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIGNvbnN0IGF4aXNJbmRleCA9IHRoaXMuYXhpc0luZGV4OwogICAgICBsZXQgYXhpcyA9ICd4JzsKCiAgICAgIGlmIChheGlzSW5kZXggPT09IDEpIHsKICAgICAgICBheGlzID0gJ3knOwogICAgICB9CgogICAgICBpZiAoYXhpc0luZGV4ID09PSAyKSB7CiAgICAgICAgYXhpcyA9ICd6JzsKICAgICAgfQoKICAgICAgY29uc3QgYXhpc0xpc3QgPSB0aGlzLmF4aXNMaXN0OwogICAgICBhYWJiLmxvd2VyQm91bmRbYXhpc107CiAgICAgIGFhYmIudXBwZXJCb3VuZFtheGlzXTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXhpc0xpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBiID0gYXhpc0xpc3RbaV07CgogICAgICAgIGlmIChiLmFhYmJOZWVkc1VwZGF0ZSkgewogICAgICAgICAgYi51cGRhdGVBQUJCKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoYi5hYWJiLm92ZXJsYXBzKGFhYmIpKSB7CiAgICAgICAgICByZXN1bHQucHVzaChiKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogIH0KCiAgY2xhc3MgVXRpbHMgewogICAgLyoqCiAgICAgKiBFeHRlbmQgYW4gb3B0aW9ucyBvYmplY3Qgd2l0aCBkZWZhdWx0IHZhbHVlcy4KICAgICAqIEBwYXJhbSBvcHRpb25zIFRoZSBvcHRpb25zIG9iamVjdC4gTWF5IGJlIGZhbHN5OiBpbiB0aGlzIGNhc2UsIGEgbmV3IG9iamVjdCBpcyBjcmVhdGVkIGFuZCByZXR1cm5lZC4KICAgICAqIEBwYXJhbSBkZWZhdWx0cyBBbiBvYmplY3QgY29udGFpbmluZyBkZWZhdWx0IHZhbHVlcy4KICAgICAqIEByZXR1cm4gVGhlIG1vZGlmaWVkIG9wdGlvbnMgb2JqZWN0LgogICAgICovCiAgICBzdGF0aWMgZGVmYXVsdHMob3B0aW9ucywgZGVmYXVsdHMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgZm9yIChsZXQga2V5IGluIGRlZmF1bHRzKSB7CiAgICAgICAgaWYgKCEoa2V5IGluIG9wdGlvbnMpKSB7CiAgICAgICAgICBvcHRpb25zW2tleV0gPSBkZWZhdWx0c1trZXldOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG9wdGlvbnM7CiAgICB9CgogIH0KCiAgLyoqCiAgICogQ29uc3RyYWludCBiYXNlIGNsYXNzCiAgICovCiAgY2xhc3MgQ29uc3RyYWludCB7CiAgICAvKioKICAgICAqIEVxdWF0aW9ucyB0byBiZSBzb2x2ZWQgaW4gdGhpcyBjb25zdHJhaW50LgogICAgICovCgogICAgLyoqCiAgICAgKiBCb2R5IEEuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEJvZHkgQi4KICAgICAqLwoKICAgIC8qKgogICAgICogU2V0IHRvIGZhbHNlIGlmIHlvdSBkb24ndCB3YW50IHRoZSBib2RpZXMgdG8gY29sbGlkZSB3aGVuIHRoZXkgYXJlIGNvbm5lY3RlZC4KICAgICAqLwogICAgY29uc3RydWN0b3IoYm9keUEsIGJvZHlCLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBVdGlscy5kZWZhdWx0cyhvcHRpb25zLCB7CiAgICAgICAgY29sbGlkZUNvbm5lY3RlZDogdHJ1ZSwKICAgICAgICB3YWtlVXBCb2RpZXM6IHRydWUKICAgICAgfSk7CiAgICAgIHRoaXMuZXF1YXRpb25zID0gW107CiAgICAgIHRoaXMuYm9keUEgPSBib2R5QTsKICAgICAgdGhpcy5ib2R5QiA9IGJvZHlCOwogICAgICB0aGlzLmlkID0gQ29uc3RyYWludC5pZENvdW50ZXIrKzsKICAgICAgdGhpcy5jb2xsaWRlQ29ubmVjdGVkID0gb3B0aW9ucy5jb2xsaWRlQ29ubmVjdGVkOwoKICAgICAgaWYgKG9wdGlvbnMud2FrZVVwQm9kaWVzKSB7CiAgICAgICAgaWYgKGJvZHlBKSB7CiAgICAgICAgICBib2R5QS53YWtlVXAoKTsKICAgICAgICB9CgogICAgICAgIGlmIChib2R5QikgewogICAgICAgICAgYm9keUIud2FrZVVwKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZSBhbGwgdGhlIGVxdWF0aW9ucyB3aXRoIGRhdGEuCiAgICAgKi8KCgogICAgdXBkYXRlKCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ21ldGhvZCB1cGRhdGUoKSBub3QgaW1wbG1lbWVudGVkIGluIHRoaXMgQ29uc3RyYWludCBzdWJjbGFzcyEnKTsKICAgIH0KICAgIC8qKgogICAgICogRW5hYmxlcyBhbGwgZXF1YXRpb25zIGluIHRoZSBjb25zdHJhaW50LgogICAgICovCgoKICAgIGVuYWJsZSgpIHsKICAgICAgY29uc3QgZXFzID0gdGhpcy5lcXVhdGlvbnM7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVxcy5sZW5ndGg7IGkrKykgewogICAgICAgIGVxc1tpXS5lbmFibGVkID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBEaXNhYmxlcyBhbGwgZXF1YXRpb25zIGluIHRoZSBjb25zdHJhaW50LgogICAgICovCgoKICAgIGRpc2FibGUoKSB7CiAgICAgIGNvbnN0IGVxcyA9IHRoaXMuZXF1YXRpb25zOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlcXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBlcXNbaV0uZW5hYmxlZCA9IGZhbHNlOwogICAgICB9CiAgICB9CgogIH0KICBDb25zdHJhaW50LmlkQ291bnRlciA9IDA7CgogIC8qKgogICAqIEFuIGVsZW1lbnQgY29udGFpbmluZyA2IGVudHJpZXMsIDMgc3BhdGlhbCBhbmQgMyByb3RhdGlvbmFsIGRlZ3JlZXMgb2YgZnJlZWRvbS4KICAgKi8KCiAgY2xhc3MgSmFjb2JpYW5FbGVtZW50IHsKICAgIC8qKgogICAgICogc3BhdGlhbAogICAgICovCgogICAgLyoqCiAgICAgKiByb3RhdGlvbmFsCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKCkgewogICAgICB0aGlzLnNwYXRpYWwgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnJvdGF0aW9uYWwgPSBuZXcgVmVjMygpOwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSB3aXRoIG90aGVyIEphY29iaWFuRWxlbWVudAogICAgICovCgoKICAgIG11bHRpcGx5RWxlbWVudChlbGVtZW50KSB7CiAgICAgIHJldHVybiBlbGVtZW50LnNwYXRpYWwuZG90KHRoaXMuc3BhdGlhbCkgKyBlbGVtZW50LnJvdGF0aW9uYWwuZG90KHRoaXMucm90YXRpb25hbCk7CiAgICB9CiAgICAvKioKICAgICAqIE11bHRpcGx5IHdpdGggdHdvIHZlY3RvcnMKICAgICAqLwoKCiAgICBtdWx0aXBseVZlY3RvcnMoc3BhdGlhbCwgcm90YXRpb25hbCkgewogICAgICByZXR1cm4gc3BhdGlhbC5kb3QodGhpcy5zcGF0aWFsKSArIHJvdGF0aW9uYWwuZG90KHRoaXMucm90YXRpb25hbCk7CiAgICB9CgogIH0KCiAgLyoqCiAgICogRXF1YXRpb24gYmFzZSBjbGFzcy4KICAgKgogICAqIGBhYCwgYGJgIGFuZCBgZXBzYCBhcmUge0BsaW5rIGh0dHBzOi8vd3d3OC5jcy51bXUuc2Uva3Vyc2VyLzVEVjA1OC9WVDE1L2xlY3R1cmVzL1NQT09LbGFibm90ZXMucGRmIFNQT09LfSBwYXJhbWV0ZXJzIHRoYXQgZGVmYXVsdCB0byBgMC4wYC4gU2VlIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vc2NodGVwcGUvY2Fubm9uLmpzL2lzc3Vlcy8yMzgjaXNzdWVjb21tZW50LTE0NzE3MjMyNyB0aGlzIGV4Y2hhbmdlfSBmb3IgbW9yZSBkZXRhaWxzIG9uIENhbm5vbidzIHBoeXNpY3MgaW1wbGVtZW50YXRpb24uCiAgICovCiAgY2xhc3MgRXF1YXRpb24gewogICAgLyoqCiAgICAgKiBNaW5pbXVtIChyZWFkOiBuZWdhdGl2ZSBtYXgpIGZvcmNlIHRvIGJlIGFwcGxpZWQgYnkgdGhlIGNvbnN0cmFpbnQuCiAgICAgKi8KCiAgICAvKioKICAgICAqIE1heGltdW0gKHJlYWQ6IHBvc2l0aXZlIG1heCkgZm9yY2UgdG8gYmUgYXBwbGllZCBieSB0aGUgY29uc3RyYWludC4KICAgICAqLwoKICAgIC8qKgogICAgICogU1BPT0sgcGFyYW1ldGVyCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNQT09LIHBhcmFtZXRlcgogICAgICovCgogICAgLyoqCiAgICAgKiBTUE9PSyBwYXJhbWV0ZXIKICAgICAqLwoKICAgIC8qKgogICAgICogQSBudW1iZXIsIHByb3BvcnRpb25hbCB0byB0aGUgZm9yY2UgYWRkZWQgdG8gdGhlIGJvZGllcy4KICAgICAqLwogICAgY29uc3RydWN0b3IoYmksIGJqLCBtaW5Gb3JjZSwgbWF4Rm9yY2UpIHsKICAgICAgaWYgKG1pbkZvcmNlID09PSB2b2lkIDApIHsKICAgICAgICBtaW5Gb3JjZSA9IC0xZTY7CiAgICAgIH0KCiAgICAgIGlmIChtYXhGb3JjZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgbWF4Rm9yY2UgPSAxZTY7CiAgICAgIH0KCiAgICAgIHRoaXMuaWQgPSBFcXVhdGlvbi5pZENvdW50ZXIrKzsKICAgICAgdGhpcy5taW5Gb3JjZSA9IG1pbkZvcmNlOwogICAgICB0aGlzLm1heEZvcmNlID0gbWF4Rm9yY2U7CiAgICAgIHRoaXMuYmkgPSBiaTsKICAgICAgdGhpcy5iaiA9IGJqOwogICAgICB0aGlzLmEgPSAwLjA7IC8vIFNQT09LIHBhcmFtZXRlcgoKICAgICAgdGhpcy5iID0gMC4wOyAvLyBTUE9PSyBwYXJhbWV0ZXIKCiAgICAgIHRoaXMuZXBzID0gMC4wOyAvLyBTUE9PSyBwYXJhbWV0ZXIKCiAgICAgIHRoaXMuamFjb2JpYW5FbGVtZW50QSA9IG5ldyBKYWNvYmlhbkVsZW1lbnQoKTsKICAgICAgdGhpcy5qYWNvYmlhbkVsZW1lbnRCID0gbmV3IEphY29iaWFuRWxlbWVudCgpOwogICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwogICAgICB0aGlzLm11bHRpcGxpZXIgPSAwOwogICAgICB0aGlzLnNldFNwb29rUGFyYW1zKDFlNywgNCwgMSAvIDYwKTsgLy8gU2V0IHR5cGljYWwgc3Bvb2sgcGFyYW1zCiAgICB9CiAgICAvKioKICAgICAqIFJlY2FsY3VsYXRlcyBhLCBiLCBhbmQgZXBzLgogICAgICoKICAgICAqIFRoZSBFcXVhdGlvbiBjb25zdHJ1Y3RvciBzZXRzIHR5cGljYWwgU1BPT0sgcGFyYW1ldGVycyBhcyBzdWNoOgogICAgICogKiBgc3RpZmZuZXNzYCA9IDFlNwogICAgICogKiBgcmVsYXhhdGlvbmAgPSA0CiAgICAgKiAqIGB0aW1lU3RlcGA9IDEgLyA2MCwgX25vdGUgdGhlIGhhcmRjb2RlZCByZWZyZXNoIHJhdGUuXwogICAgICovCgoKICAgIHNldFNwb29rUGFyYW1zKHN0aWZmbmVzcywgcmVsYXhhdGlvbiwgdGltZVN0ZXApIHsKICAgICAgY29uc3QgZCA9IHJlbGF4YXRpb247CiAgICAgIGNvbnN0IGsgPSBzdGlmZm5lc3M7CiAgICAgIGNvbnN0IGggPSB0aW1lU3RlcDsKICAgICAgdGhpcy5hID0gNC4wIC8gKGggKiAoMSArIDQgKiBkKSk7CiAgICAgIHRoaXMuYiA9IDQuMCAqIGQgLyAoMSArIDQgKiBkKTsKICAgICAgdGhpcy5lcHMgPSA0LjAgLyAoaCAqIGggKiBrICogKDEgKyA0ICogZCkpOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyB0aGUgcmlnaHQgaGFuZCBzaWRlIG9mIHRoZSBTUE9PSyBlcXVhdGlvbgogICAgICovCgoKICAgIGNvbXB1dGVCKGEsIGIsIGgpIHsKICAgICAgY29uc3QgR1cgPSB0aGlzLmNvbXB1dGVHVygpOwogICAgICBjb25zdCBHcSA9IHRoaXMuY29tcHV0ZUdxKCk7CiAgICAgIGNvbnN0IEdpTWYgPSB0aGlzLmNvbXB1dGVHaU1mKCk7CiAgICAgIHJldHVybiAtR3EgKiBhIC0gR1cgKiBiIC0gR2lNZiAqIGg7CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGVzIEcqcSwgd2hlcmUgcSBhcmUgdGhlIGdlbmVyYWxpemVkIGJvZHkgY29vcmRpbmF0ZXMKICAgICAqLwoKCiAgICBjb21wdXRlR3EoKSB7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsKICAgICAgY29uc3QgYmkgPSB0aGlzLmJpOwogICAgICBjb25zdCBiaiA9IHRoaXMuYmo7CiAgICAgIGNvbnN0IHhpID0gYmkucG9zaXRpb247CiAgICAgIGNvbnN0IHhqID0gYmoucG9zaXRpb247CiAgICAgIHJldHVybiBHQS5zcGF0aWFsLmRvdCh4aSkgKyBHQi5zcGF0aWFsLmRvdCh4aik7CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGVzIEcqVywgd2hlcmUgVyBhcmUgdGhlIGJvZHkgdmVsb2NpdGllcwogICAgICovCgoKICAgIGNvbXB1dGVHVygpIHsKICAgICAgY29uc3QgR0EgPSB0aGlzLmphY29iaWFuRWxlbWVudEE7CiAgICAgIGNvbnN0IEdCID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRCOwogICAgICBjb25zdCBiaSA9IHRoaXMuYmk7CiAgICAgIGNvbnN0IGJqID0gdGhpcy5iajsKICAgICAgY29uc3QgdmkgPSBiaS52ZWxvY2l0eTsKICAgICAgY29uc3QgdmogPSBiai52ZWxvY2l0eTsKICAgICAgY29uc3Qgd2kgPSBiaS5hbmd1bGFyVmVsb2NpdHk7CiAgICAgIGNvbnN0IHdqID0gYmouYW5ndWxhclZlbG9jaXR5OwogICAgICByZXR1cm4gR0EubXVsdGlwbHlWZWN0b3JzKHZpLCB3aSkgKyBHQi5tdWx0aXBseVZlY3RvcnModmosIHdqKTsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZXMgRypXbGFtYmRhLCB3aGVyZSBXIGFyZSB0aGUgYm9keSB2ZWxvY2l0aWVzCiAgICAgKi8KCgogICAgY29tcHV0ZUdXbGFtYmRhKCkgewogICAgICBjb25zdCBHQSA9IHRoaXMuamFjb2JpYW5FbGVtZW50QTsKICAgICAgY29uc3QgR0IgPSB0aGlzLmphY29iaWFuRWxlbWVudEI7CiAgICAgIGNvbnN0IGJpID0gdGhpcy5iaTsKICAgICAgY29uc3QgYmogPSB0aGlzLmJqOwogICAgICBjb25zdCB2aSA9IGJpLnZsYW1iZGE7CiAgICAgIGNvbnN0IHZqID0gYmoudmxhbWJkYTsKICAgICAgY29uc3Qgd2kgPSBiaS53bGFtYmRhOwogICAgICBjb25zdCB3aiA9IGJqLndsYW1iZGE7CiAgICAgIHJldHVybiBHQS5tdWx0aXBseVZlY3RvcnModmksIHdpKSArIEdCLm11bHRpcGx5VmVjdG9ycyh2aiwgd2opOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyBHKmludihNKSpmLCB3aGVyZSBNIGlzIHRoZSBtYXNzIG1hdHJpeCB3aXRoIGRpYWdvbmFsIGJsb2NrcyBmb3IgZWFjaCBib2R5LCBhbmQgZiBhcmUgdGhlIGZvcmNlcyBvbiB0aGUgYm9kaWVzLgogICAgICovCgoKICAgIGNvbXB1dGVHaU1mKCkgewogICAgICBjb25zdCBHQSA9IHRoaXMuamFjb2JpYW5FbGVtZW50QTsKICAgICAgY29uc3QgR0IgPSB0aGlzLmphY29iaWFuRWxlbWVudEI7CiAgICAgIGNvbnN0IGJpID0gdGhpcy5iaTsKICAgICAgY29uc3QgYmogPSB0aGlzLmJqOwogICAgICBjb25zdCBmaSA9IGJpLmZvcmNlOwogICAgICBjb25zdCB0aSA9IGJpLnRvcnF1ZTsKICAgICAgY29uc3QgZmogPSBiai5mb3JjZTsKICAgICAgY29uc3QgdGogPSBiai50b3JxdWU7CiAgICAgIGNvbnN0IGludk1hc3NpID0gYmkuaW52TWFzc1NvbHZlOwogICAgICBjb25zdCBpbnZNYXNzaiA9IGJqLmludk1hc3NTb2x2ZTsKICAgICAgZmkuc2NhbGUoaW52TWFzc2ksIGlNZmkpOwogICAgICBmai5zY2FsZShpbnZNYXNzaiwgaU1maik7CiAgICAgIGJpLmludkluZXJ0aWFXb3JsZFNvbHZlLnZtdWx0KHRpLCBpbnZJaV92bXVsdF90YXVpKTsKICAgICAgYmouaW52SW5lcnRpYVdvcmxkU29sdmUudm11bHQodGosIGludklqX3ZtdWx0X3RhdWopOwogICAgICByZXR1cm4gR0EubXVsdGlwbHlWZWN0b3JzKGlNZmksIGludklpX3ZtdWx0X3RhdWkpICsgR0IubXVsdGlwbHlWZWN0b3JzKGlNZmosIGludklqX3ZtdWx0X3RhdWopOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyBHKmludihNKSpHJwogICAgICovCgoKICAgIGNvbXB1dGVHaU1HdCgpIHsKICAgICAgY29uc3QgR0EgPSB0aGlzLmphY29iaWFuRWxlbWVudEE7CiAgICAgIGNvbnN0IEdCID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRCOwogICAgICBjb25zdCBiaSA9IHRoaXMuYmk7CiAgICAgIGNvbnN0IGJqID0gdGhpcy5iajsKICAgICAgY29uc3QgaW52TWFzc2kgPSBiaS5pbnZNYXNzU29sdmU7CiAgICAgIGNvbnN0IGludk1hc3NqID0gYmouaW52TWFzc1NvbHZlOwogICAgICBjb25zdCBpbnZJaSA9IGJpLmludkluZXJ0aWFXb3JsZFNvbHZlOwogICAgICBjb25zdCBpbnZJaiA9IGJqLmludkluZXJ0aWFXb3JsZFNvbHZlOwogICAgICBsZXQgcmVzdWx0ID0gaW52TWFzc2kgKyBpbnZNYXNzajsKICAgICAgaW52SWkudm11bHQoR0Eucm90YXRpb25hbCwgdG1wKTsKICAgICAgcmVzdWx0ICs9IHRtcC5kb3QoR0Eucm90YXRpb25hbCk7CiAgICAgIGludklqLnZtdWx0KEdCLnJvdGF0aW9uYWwsIHRtcCk7CiAgICAgIHJlc3VsdCArPSB0bXAuZG90KEdCLnJvdGF0aW9uYWwpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgY29uc3RyYWludCB2ZWxvY2l0eSB0byB0aGUgYm9kaWVzLgogICAgICovCgoKICAgIGFkZFRvV2xhbWJkYShkZWx0YWxhbWJkYSkgewogICAgICBjb25zdCBHQSA9IHRoaXMuamFjb2JpYW5FbGVtZW50QTsKICAgICAgY29uc3QgR0IgPSB0aGlzLmphY29iaWFuRWxlbWVudEI7CiAgICAgIGNvbnN0IGJpID0gdGhpcy5iaTsKICAgICAgY29uc3QgYmogPSB0aGlzLmJqOwogICAgICBjb25zdCB0ZW1wID0gYWRkVG9XbGFtYmRhX3RlbXA7IC8vIEFkZCB0byBsaW5lYXIgdmVsb2NpdHkKICAgICAgLy8gdl9sYW1iZGEgKz0gaW52KE0pICogZGVsdGFfbGFtYmEgKiBHCgogICAgICBiaS52bGFtYmRhLmFkZFNjYWxlZFZlY3RvcihiaS5pbnZNYXNzU29sdmUgKiBkZWx0YWxhbWJkYSwgR0Euc3BhdGlhbCwgYmkudmxhbWJkYSk7CiAgICAgIGJqLnZsYW1iZGEuYWRkU2NhbGVkVmVjdG9yKGJqLmludk1hc3NTb2x2ZSAqIGRlbHRhbGFtYmRhLCBHQi5zcGF0aWFsLCBiai52bGFtYmRhKTsgLy8gQWRkIHRvIGFuZ3VsYXIgdmVsb2NpdHkKCiAgICAgIGJpLmludkluZXJ0aWFXb3JsZFNvbHZlLnZtdWx0KEdBLnJvdGF0aW9uYWwsIHRlbXApOwogICAgICBiaS53bGFtYmRhLmFkZFNjYWxlZFZlY3RvcihkZWx0YWxhbWJkYSwgdGVtcCwgYmkud2xhbWJkYSk7CiAgICAgIGJqLmludkluZXJ0aWFXb3JsZFNvbHZlLnZtdWx0KEdCLnJvdGF0aW9uYWwsIHRlbXApOwogICAgICBiai53bGFtYmRhLmFkZFNjYWxlZFZlY3RvcihkZWx0YWxhbWJkYSwgdGVtcCwgYmoud2xhbWJkYSk7CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGUgdGhlIGRlbm9taW5hdG9yIHBhcnQgb2YgdGhlIFNQT09LIGVxdWF0aW9uOiBDID0gRyppbnYoTSkqRycgKyBlcHMKICAgICAqLwoKCiAgICBjb21wdXRlQygpIHsKICAgICAgcmV0dXJuIHRoaXMuY29tcHV0ZUdpTUd0KCkgKyB0aGlzLmVwczsKICAgIH0KCiAgfQogIEVxdWF0aW9uLmlkQ291bnRlciA9IDA7CiAgY29uc3QgaU1maSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaU1maiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW52SWlfdm11bHRfdGF1aSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW52SWpfdm11bHRfdGF1aiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wID0gbmV3IFZlYzMoKTsKICBjb25zdCBhZGRUb1dsYW1iZGFfdGVtcCA9IG5ldyBWZWMzKCk7CgogIC8qKgogICAqIENvbnRhY3Qvbm9uLXBlbmV0cmF0aW9uIGNvbnN0cmFpbnQgZXF1YXRpb24KICAgKi8KICBjbGFzcyBDb250YWN0RXF1YXRpb24gZXh0ZW5kcyBFcXVhdGlvbiB7CiAgICAvKioKICAgICAqICJib3VuY2luZXNzIjogdTEgPSAtZSp1MAogICAgICovCgogICAgLyoqCiAgICAgKiBXb3JsZC1vcmllbnRlZCB2ZWN0b3IgdGhhdCBnb2VzIGZyb20gdGhlIGNlbnRlciBvZiBiaSB0byB0aGUgY29udGFjdCBwb2ludC4KICAgICAqLwoKICAgIC8qKgogICAgICogV29ybGQtb3JpZW50ZWQgdmVjdG9yIHRoYXQgc3RhcnRzIGluIGJvZHkgaiBwb3NpdGlvbiBhbmQgZ29lcyB0byB0aGUgY29udGFjdCBwb2ludC4KICAgICAqLwoKICAgIC8qKgogICAgICogQ29udGFjdCBub3JtYWwsIHBvaW50aW5nIG91dCBvZiBib2R5IGkuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5QiwgbWF4Rm9yY2UpIHsKICAgICAgaWYgKG1heEZvcmNlID09PSB2b2lkIDApIHsKICAgICAgICBtYXhGb3JjZSA9IDFlNjsKICAgICAgfQoKICAgICAgc3VwZXIoYm9keUEsIGJvZHlCLCAwLCBtYXhGb3JjZSk7CiAgICAgIHRoaXMucmVzdGl0dXRpb24gPSAwLjA7CiAgICAgIHRoaXMucmkgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnJqID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5uaSA9IG5ldyBWZWMzKCk7CiAgICB9CgogICAgY29tcHV0ZUIoaCkgewogICAgICBjb25zdCBhID0gdGhpcy5hOwogICAgICBjb25zdCBiID0gdGhpcy5iOwogICAgICBjb25zdCBiaSA9IHRoaXMuYmk7CiAgICAgIGNvbnN0IGJqID0gdGhpcy5iajsKICAgICAgY29uc3QgcmkgPSB0aGlzLnJpOwogICAgICBjb25zdCByaiA9IHRoaXMucmo7CiAgICAgIGNvbnN0IHJpeG4gPSBDb250YWN0RXF1YXRpb25fY29tcHV0ZUJfdGVtcDE7CiAgICAgIGNvbnN0IHJqeG4gPSBDb250YWN0RXF1YXRpb25fY29tcHV0ZUJfdGVtcDI7CiAgICAgIGNvbnN0IHZpID0gYmkudmVsb2NpdHk7CiAgICAgIGNvbnN0IHdpID0gYmkuYW5ndWxhclZlbG9jaXR5OwogICAgICBiaS5mb3JjZTsKICAgICAgYmkudG9ycXVlOwogICAgICBjb25zdCB2aiA9IGJqLnZlbG9jaXR5OwogICAgICBjb25zdCB3aiA9IGJqLmFuZ3VsYXJWZWxvY2l0eTsKICAgICAgYmouZm9yY2U7CiAgICAgIGJqLnRvcnF1ZTsKICAgICAgY29uc3QgcGVuZXRyYXRpb25WZWMgPSBDb250YWN0RXF1YXRpb25fY29tcHV0ZUJfdGVtcDM7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsKICAgICAgY29uc3QgbiA9IHRoaXMubmk7IC8vIENhbHVjbGF0ZSBjcm9zcyBwcm9kdWN0cwoKICAgICAgcmkuY3Jvc3Mobiwgcml4bik7CiAgICAgIHJqLmNyb3NzKG4sIHJqeG4pOyAvLyBnID0geGorcmogLSh4aStyaSkKICAgICAgLy8gRyA9IFsgLW5pICAtcml4biAgbmkgIHJqeG4gXQoKICAgICAgbi5uZWdhdGUoR0Euc3BhdGlhbCk7CiAgICAgIHJpeG4ubmVnYXRlKEdBLnJvdGF0aW9uYWwpOwogICAgICBHQi5zcGF0aWFsLmNvcHkobik7CiAgICAgIEdCLnJvdGF0aW9uYWwuY29weShyanhuKTsgLy8gQ2FsY3VsYXRlIHRoZSBwZW5ldHJhdGlvbiB2ZWN0b3IKCiAgICAgIHBlbmV0cmF0aW9uVmVjLmNvcHkoYmoucG9zaXRpb24pOwogICAgICBwZW5ldHJhdGlvblZlYy52YWRkKHJqLCBwZW5ldHJhdGlvblZlYyk7CiAgICAgIHBlbmV0cmF0aW9uVmVjLnZzdWIoYmkucG9zaXRpb24sIHBlbmV0cmF0aW9uVmVjKTsKICAgICAgcGVuZXRyYXRpb25WZWMudnN1YihyaSwgcGVuZXRyYXRpb25WZWMpOwogICAgICBjb25zdCBnID0gbi5kb3QocGVuZXRyYXRpb25WZWMpOyAvLyBDb21wdXRlIGl0ZXJhdGlvbgoKICAgICAgY29uc3QgZVBsdXNPbmUgPSB0aGlzLnJlc3RpdHV0aW9uICsgMTsKICAgICAgY29uc3QgR1cgPSBlUGx1c09uZSAqIHZqLmRvdChuKSAtIGVQbHVzT25lICogdmkuZG90KG4pICsgd2ouZG90KHJqeG4pIC0gd2kuZG90KHJpeG4pOwogICAgICBjb25zdCBHaU1mID0gdGhpcy5jb21wdXRlR2lNZigpOwogICAgICBjb25zdCBCID0gLWcgKiBhIC0gR1cgKiBiIC0gaCAqIEdpTWY7CiAgICAgIHJldHVybiBCOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIGN1cnJlbnQgcmVsYXRpdmUgdmVsb2NpdHkgaW4gdGhlIGNvbnRhY3QgcG9pbnQuCiAgICAgKi8KCgogICAgZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbCgpIHsKICAgICAgY29uc3QgdmkgPSBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF92aTsKICAgICAgY29uc3QgdmogPSBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF92ajsKICAgICAgY29uc3QgeGkgPSBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF94aTsKICAgICAgY29uc3QgeGogPSBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF94ajsKICAgICAgY29uc3QgcmVsVmVsID0gQ29udGFjdEVxdWF0aW9uX2dldEltcGFjdFZlbG9jaXR5QWxvbmdOb3JtYWxfcmVsVmVsOwogICAgICB0aGlzLmJpLnBvc2l0aW9uLnZhZGQodGhpcy5yaSwgeGkpOwogICAgICB0aGlzLmJqLnBvc2l0aW9uLnZhZGQodGhpcy5yaiwgeGopOwogICAgICB0aGlzLmJpLmdldFZlbG9jaXR5QXRXb3JsZFBvaW50KHhpLCB2aSk7CiAgICAgIHRoaXMuYmouZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQoeGosIHZqKTsKICAgICAgdmkudnN1Yih2aiwgcmVsVmVsKTsKICAgICAgcmV0dXJuIHRoaXMubmkuZG90KHJlbFZlbCk7CiAgICB9CgogIH0KICBjb25zdCBDb250YWN0RXF1YXRpb25fY29tcHV0ZUJfdGVtcDEgPSBuZXcgVmVjMygpOyAvLyBUZW1wIHZlY3RvcnMKCiAgY29uc3QgQ29udGFjdEVxdWF0aW9uX2NvbXB1dGVCX3RlbXAyID0gbmV3IFZlYzMoKTsKICBjb25zdCBDb250YWN0RXF1YXRpb25fY29tcHV0ZUJfdGVtcDMgPSBuZXcgVmVjMygpOwogIGNvbnN0IENvbnRhY3RFcXVhdGlvbl9nZXRJbXBhY3RWZWxvY2l0eUFsb25nTm9ybWFsX3ZpID0gbmV3IFZlYzMoKTsKICBjb25zdCBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF92aiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQ29udGFjdEVxdWF0aW9uX2dldEltcGFjdFZlbG9jaXR5QWxvbmdOb3JtYWxfeGkgPSBuZXcgVmVjMygpOwogIGNvbnN0IENvbnRhY3RFcXVhdGlvbl9nZXRJbXBhY3RWZWxvY2l0eUFsb25nTm9ybWFsX3hqID0gbmV3IFZlYzMoKTsKICBjb25zdCBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF9yZWxWZWwgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBDb25uZWN0cyB0d28gYm9kaWVzIGF0IGdpdmVuIG9mZnNldCBwb2ludHMuCiAgICogQGV4YW1wbGUKICAgKiAgICAgY29uc3QgYm9keUEgPSBuZXcgQm9keSh7IG1hc3M6IDEgfSkKICAgKiAgICAgY29uc3QgYm9keUIgPSBuZXcgQm9keSh7IG1hc3M6IDEgfSkKICAgKiAgICAgYm9keUEucG9zaXRpb24uc2V0KC0xLCAwLCAwKQogICAqICAgICBib2R5Qi5wb3NpdGlvbi5zZXQoMSwgMCwgMCkKICAgKiAgICAgYm9keUEuYWRkU2hhcGUoc2hhcGVBKQogICAqICAgICBib2R5Qi5hZGRTaGFwZShzaGFwZUIpCiAgICogICAgIHdvcmxkLmFkZEJvZHkoYm9keUEpCiAgICogICAgIHdvcmxkLmFkZEJvZHkoYm9keUIpCiAgICogICAgIGNvbnN0IGxvY2FsUGl2b3RBID0gbmV3IFZlYzMoMSwgMCwgMCkKICAgKiAgICAgY29uc3QgbG9jYWxQaXZvdEIgPSBuZXcgVmVjMygtMSwgMCwgMCkKICAgKiAgICAgY29uc3QgY29uc3RyYWludCA9IG5ldyBQb2ludFRvUG9pbnRDb25zdHJhaW50KGJvZHlBLCBsb2NhbFBpdm90QSwgYm9keUIsIGxvY2FsUGl2b3RCKQogICAqICAgICB3b3JsZC5hZGRDb25zdHJhaW50KGNvbnN0cmFpbnQpCiAgICovCiAgY2xhc3MgUG9pbnRUb1BvaW50Q29uc3RyYWludCBleHRlbmRzIENvbnN0cmFpbnQgewogICAgLyoqCiAgICAgKiBQaXZvdCwgZGVmaW5lZCBsb2NhbGx5IGluIGJvZHlBLgogICAgICovCgogICAgLyoqCiAgICAgKiBQaXZvdCwgZGVmaW5lZCBsb2NhbGx5IGluIGJvZHlCLgogICAgICovCgogICAgLyoqCiAgICAgKiBAcGFyYW0gcGl2b3RBIFRoZSBwb2ludCByZWxhdGl2ZSB0byB0aGUgY2VudGVyIG9mIG1hc3Mgb2YgYm9keUEgd2hpY2ggYm9keUEgaXMgY29uc3RyYWluZWQgdG8uCiAgICAgKiBAcGFyYW0gYm9keUIgQm9keSB0aGF0IHdpbGwgYmUgY29uc3RyYWluZWQgaW4gYSBzaW1pbGFyIHdheSB0byB0aGUgc2FtZSBwb2ludCBhcyBib2R5QS4gV2Ugd2lsbCB0aGVyZWZvcmUgZ2V0IGEgbGluayBiZXR3ZWVuIGJvZHlBIGFuZCBib2R5Qi4gSWYgbm90IHNwZWNpZmllZCwgYm9keUEgd2lsbCBiZSBjb25zdHJhaW5lZCB0byBhIHN0YXRpYyBwb2ludC4KICAgICAqIEBwYXJhbSBwaXZvdEIgVGhlIHBvaW50IHJlbGF0aXZlIHRvIHRoZSBjZW50ZXIgb2YgbWFzcyBvZiBib2R5QiB3aGljaCBib2R5QiBpcyBjb25zdHJhaW5lZCB0by4KICAgICAqIEBwYXJhbSBtYXhGb3JjZSBUaGUgbWF4aW11bSBmb3JjZSB0aGF0IHNob3VsZCBiZSBhcHBsaWVkIHRvIGNvbnN0cmFpbiB0aGUgYm9kaWVzLgogICAgICovCiAgICBjb25zdHJ1Y3Rvcihib2R5QSwgcGl2b3RBLCBib2R5QiwgcGl2b3RCLCBtYXhGb3JjZSkgewogICAgICBpZiAocGl2b3RBID09PSB2b2lkIDApIHsKICAgICAgICBwaXZvdEEgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBpZiAocGl2b3RCID09PSB2b2lkIDApIHsKICAgICAgICBwaXZvdEIgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBpZiAobWF4Rm9yY2UgPT09IHZvaWQgMCkgewogICAgICAgIG1heEZvcmNlID0gMWU2OwogICAgICB9CgogICAgICBzdXBlcihib2R5QSwgYm9keUIpOwogICAgICB0aGlzLnBpdm90QSA9IHBpdm90QS5jbG9uZSgpOwogICAgICB0aGlzLnBpdm90QiA9IHBpdm90Qi5jbG9uZSgpOwogICAgICBjb25zdCB4ID0gdGhpcy5lcXVhdGlvblggPSBuZXcgQ29udGFjdEVxdWF0aW9uKGJvZHlBLCBib2R5Qik7CiAgICAgIGNvbnN0IHkgPSB0aGlzLmVxdWF0aW9uWSA9IG5ldyBDb250YWN0RXF1YXRpb24oYm9keUEsIGJvZHlCKTsKICAgICAgY29uc3QgeiA9IHRoaXMuZXF1YXRpb25aID0gbmV3IENvbnRhY3RFcXVhdGlvbihib2R5QSwgYm9keUIpOyAvLyBFcXVhdGlvbnMgdG8gYmUgZmVkIHRvIHRoZSBzb2x2ZXIKCiAgICAgIHRoaXMuZXF1YXRpb25zLnB1c2goeCwgeSwgeik7IC8vIE1ha2UgdGhlIGVxdWF0aW9ucyBiaWRpcmVjdGlvbmFsCgogICAgICB4Lm1pbkZvcmNlID0geS5taW5Gb3JjZSA9IHoubWluRm9yY2UgPSAtbWF4Rm9yY2U7CiAgICAgIHgubWF4Rm9yY2UgPSB5Lm1heEZvcmNlID0gei5tYXhGb3JjZSA9IG1heEZvcmNlOwogICAgICB4Lm5pLnNldCgxLCAwLCAwKTsKICAgICAgeS5uaS5zZXQoMCwgMSwgMCk7CiAgICAgIHoubmkuc2V0KDAsIDAsIDEpOwogICAgfQoKICAgIHVwZGF0ZSgpIHsKICAgICAgY29uc3QgYm9keUEgPSB0aGlzLmJvZHlBOwogICAgICBjb25zdCBib2R5QiA9IHRoaXMuYm9keUI7CiAgICAgIGNvbnN0IHggPSB0aGlzLmVxdWF0aW9uWDsKICAgICAgY29uc3QgeSA9IHRoaXMuZXF1YXRpb25ZOwogICAgICBjb25zdCB6ID0gdGhpcy5lcXVhdGlvblo7IC8vIFJvdGF0ZSB0aGUgcGl2b3RzIHRvIHdvcmxkIHNwYWNlCgogICAgICBib2R5QS5xdWF0ZXJuaW9uLnZtdWx0KHRoaXMucGl2b3RBLCB4LnJpKTsKICAgICAgYm9keUIucXVhdGVybmlvbi52bXVsdCh0aGlzLnBpdm90QiwgeC5yaik7CiAgICAgIHkucmkuY29weSh4LnJpKTsKICAgICAgeS5yai5jb3B5KHgucmopOwogICAgICB6LnJpLmNvcHkoeC5yaSk7CiAgICAgIHoucmouY29weSh4LnJqKTsKICAgIH0KCiAgfQoKICAvKioKICAgKiBDb25lIGVxdWF0aW9uLiBXb3JrcyB0byBrZWVwIHRoZSBnaXZlbiBib2R5IHdvcmxkIHZlY3RvcnMgYWxpZ25lZCwgb3IgdGlsdGVkIHdpdGhpbiBhIGdpdmVuIGFuZ2xlIGZyb20gZWFjaCBvdGhlci4KICAgKi8KICBjbGFzcyBDb25lRXF1YXRpb24gZXh0ZW5kcyBFcXVhdGlvbiB7CiAgICAvKioKICAgICAqIExvY2FsIGF4aXMgaW4gQQogICAgICovCgogICAgLyoqCiAgICAgKiBMb2NhbCBheGlzIGluIEIKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlICJjb25lIGFuZ2xlIiB0byBrZWVwCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBjb25zdCBtYXhGb3JjZSA9IHR5cGVvZiBvcHRpb25zLm1heEZvcmNlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMubWF4Rm9yY2UgOiAxZTY7CiAgICAgIHN1cGVyKGJvZHlBLCBib2R5QiwgLW1heEZvcmNlLCBtYXhGb3JjZSk7CiAgICAgIHRoaXMuYXhpc0EgPSBvcHRpb25zLmF4aXNBID8gb3B0aW9ucy5heGlzQS5jbG9uZSgpIDogbmV3IFZlYzMoMSwgMCwgMCk7CiAgICAgIHRoaXMuYXhpc0IgPSBvcHRpb25zLmF4aXNCID8gb3B0aW9ucy5heGlzQi5jbG9uZSgpIDogbmV3IFZlYzMoMCwgMSwgMCk7CiAgICAgIHRoaXMuYW5nbGUgPSB0eXBlb2Ygb3B0aW9ucy5hbmdsZSAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmFuZ2xlIDogMDsKICAgIH0KCiAgICBjb21wdXRlQihoKSB7CiAgICAgIGNvbnN0IGEgPSB0aGlzLmE7CiAgICAgIGNvbnN0IGIgPSB0aGlzLmI7CiAgICAgIGNvbnN0IG5pID0gdGhpcy5heGlzQTsKICAgICAgY29uc3QgbmogPSB0aGlzLmF4aXNCOwogICAgICBjb25zdCBuaXhuaiA9IHRtcFZlYzEkMjsKICAgICAgY29uc3Qgbmp4bmkgPSB0bXBWZWMyJDI7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsgLy8gQ2FsdWNsYXRlIGNyb3NzIHByb2R1Y3RzCgogICAgICBuaS5jcm9zcyhuaiwgbml4bmopOwogICAgICBuai5jcm9zcyhuaSwgbmp4bmkpOyAvLyBUaGUgYW5nbGUgYmV0d2VlbiB0d28gdmVjdG9yIGlzOgogICAgICAvLyBjb3ModGhldGEpID0gYSAqIGIgLyAobGVuZ3RoKGEpICogbGVuZ3RoKGIpID0geyBsZW4oYSkgPSBsZW4oYikgPSAxIH0gPSBhICogYgogICAgICAvLyBnID0gYSAqIGIKICAgICAgLy8gZ2RvdCA9IChiIHggYSkgKiB3aSArIChhIHggYikgKiB3agogICAgICAvLyBHID0gWzAgYnhhIDAgYXhiXQogICAgICAvLyBXID0gW3ZpIHdpIHZqIHdqXQoKICAgICAgR0Eucm90YXRpb25hbC5jb3B5KG5qeG5pKTsKICAgICAgR0Iucm90YXRpb25hbC5jb3B5KG5peG5qKTsKICAgICAgY29uc3QgZyA9IE1hdGguY29zKHRoaXMuYW5nbGUpIC0gbmkuZG90KG5qKTsKICAgICAgY29uc3QgR1cgPSB0aGlzLmNvbXB1dGVHVygpOwogICAgICBjb25zdCBHaU1mID0gdGhpcy5jb21wdXRlR2lNZigpOwogICAgICBjb25zdCBCID0gLWcgKiBhIC0gR1cgKiBiIC0gaCAqIEdpTWY7CiAgICAgIHJldHVybiBCOwogICAgfQoKICB9CiAgY29uc3QgdG1wVmVjMSQyID0gbmV3IFZlYzMoKTsKICBjb25zdCB0bXBWZWMyJDIgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBSb3RhdGlvbmFsIGNvbnN0cmFpbnQuIFdvcmtzIHRvIGtlZXAgdGhlIGxvY2FsIHZlY3RvcnMgb3J0aG9nb25hbCB0byBlYWNoIG90aGVyIGluIHdvcmxkIHNwYWNlLgogICAqLwogIGNsYXNzIFJvdGF0aW9uYWxFcXVhdGlvbiBleHRlbmRzIEVxdWF0aW9uIHsKICAgIC8qKgogICAgICogV29ybGQgb3JpZW50ZWQgcm90YXRpb25hbCBheGlzLgogICAgICovCgogICAgLyoqCiAgICAgKiBXb3JsZCBvcmllbnRlZCByb3RhdGlvbmFsIGF4aXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIG1heEFuZ2xlCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBjb25zdCBtYXhGb3JjZSA9IHR5cGVvZiBvcHRpb25zLm1heEZvcmNlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMubWF4Rm9yY2UgOiAxZTY7CiAgICAgIHN1cGVyKGJvZHlBLCBib2R5QiwgLW1heEZvcmNlLCBtYXhGb3JjZSk7CiAgICAgIHRoaXMuYXhpc0EgPSBvcHRpb25zLmF4aXNBID8gb3B0aW9ucy5heGlzQS5jbG9uZSgpIDogbmV3IFZlYzMoMSwgMCwgMCk7CiAgICAgIHRoaXMuYXhpc0IgPSBvcHRpb25zLmF4aXNCID8gb3B0aW9ucy5heGlzQi5jbG9uZSgpIDogbmV3IFZlYzMoMCwgMSwgMCk7CiAgICAgIHRoaXMubWF4QW5nbGUgPSBNYXRoLlBJIC8gMjsKICAgIH0KCiAgICBjb21wdXRlQihoKSB7CiAgICAgIGNvbnN0IGEgPSB0aGlzLmE7CiAgICAgIGNvbnN0IGIgPSB0aGlzLmI7CiAgICAgIGNvbnN0IG5pID0gdGhpcy5heGlzQTsKICAgICAgY29uc3QgbmogPSB0aGlzLmF4aXNCOwogICAgICBjb25zdCBuaXhuaiA9IHRtcFZlYzEkMTsKICAgICAgY29uc3Qgbmp4bmkgPSB0bXBWZWMyJDE7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsgLy8gQ2FsdWNsYXRlIGNyb3NzIHByb2R1Y3RzCgogICAgICBuaS5jcm9zcyhuaiwgbml4bmopOwogICAgICBuai5jcm9zcyhuaSwgbmp4bmkpOyAvLyBnID0gbmkgKiBuagogICAgICAvLyBnZG90ID0gKG5qIHggbmkpICogd2kgKyAobmkgeCBuaikgKiB3agogICAgICAvLyBHID0gWzAgbmp4bmkgMCBuaXhual0KICAgICAgLy8gVyA9IFt2aSB3aSB2aiB3al0KCiAgICAgIEdBLnJvdGF0aW9uYWwuY29weShuanhuaSk7CiAgICAgIEdCLnJvdGF0aW9uYWwuY29weShuaXhuaik7CiAgICAgIGNvbnN0IGcgPSBNYXRoLmNvcyh0aGlzLm1heEFuZ2xlKSAtIG5pLmRvdChuaik7CiAgICAgIGNvbnN0IEdXID0gdGhpcy5jb21wdXRlR1coKTsKICAgICAgY29uc3QgR2lNZiA9IHRoaXMuY29tcHV0ZUdpTWYoKTsKICAgICAgY29uc3QgQiA9IC1nICogYSAtIEdXICogYiAtIGggKiBHaU1mOwogICAgICByZXR1cm4gQjsKICAgIH0KCiAgfQogIGNvbnN0IHRtcFZlYzEkMSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wVmVjMiQxID0gbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogQSBDb25lIFR3aXN0IGNvbnN0cmFpbnQsIHVzZWZ1bCBmb3IgcmFnZG9sbHMuCiAgICovCiAgY2xhc3MgQ29uZVR3aXN0Q29uc3RyYWludCBleHRlbmRzIFBvaW50VG9Qb2ludENvbnN0cmFpbnQgewogICAgLyoqCiAgICAgKiBUaGUgYXhpcyBkaXJlY3Rpb24gZm9yIHRoZSBjb25zdHJhaW50IG9mIHRoZSBib2R5IEEuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBheGlzIGRpcmVjdGlvbiBmb3IgdGhlIGNvbnN0cmFpbnQgb2YgdGhlIGJvZHkgQi4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGFwZXJ0dXJlIGFuZ2xlIG9mIHRoZSBjb25lLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgdHdpc3QgYW5nbGUgb2YgdGhlIGpvaW50LgogICAgICovCiAgICBjb25zdHJ1Y3Rvcihib2R5QSwgYm9keUIsIG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgY29uc3QgbWF4Rm9yY2UgPSB0eXBlb2Ygb3B0aW9ucy5tYXhGb3JjZSAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLm1heEZvcmNlIDogMWU2OyAvLyBTZXQgcGl2b3QgcG9pbnQgaW4gYmV0d2VlbgoKICAgICAgY29uc3QgcGl2b3RBID0gb3B0aW9ucy5waXZvdEEgPyBvcHRpb25zLnBpdm90QS5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgY29uc3QgcGl2b3RCID0gb3B0aW9ucy5waXZvdEIgPyBvcHRpb25zLnBpdm90Qi5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgc3VwZXIoYm9keUEsIHBpdm90QSwgYm9keUIsIHBpdm90QiwgbWF4Rm9yY2UpOwogICAgICB0aGlzLmF4aXNBID0gb3B0aW9ucy5heGlzQSA/IG9wdGlvbnMuYXhpc0EuY2xvbmUoKSA6IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuYXhpc0IgPSBvcHRpb25zLmF4aXNCID8gb3B0aW9ucy5heGlzQi5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgdGhpcy5jb2xsaWRlQ29ubmVjdGVkID0gISFvcHRpb25zLmNvbGxpZGVDb25uZWN0ZWQ7CiAgICAgIHRoaXMuYW5nbGUgPSB0eXBlb2Ygb3B0aW9ucy5hbmdsZSAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmFuZ2xlIDogMDsKICAgICAgY29uc3QgYyA9IHRoaXMuY29uZUVxdWF0aW9uID0gbmV3IENvbmVFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICBjb25zdCB0ID0gdGhpcy50d2lzdEVxdWF0aW9uID0gbmV3IFJvdGF0aW9uYWxFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICB0aGlzLnR3aXN0QW5nbGUgPSB0eXBlb2Ygb3B0aW9ucy50d2lzdEFuZ2xlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMudHdpc3RBbmdsZSA6IDA7IC8vIE1ha2UgdGhlIGNvbmUgZXF1YXRpb24gcHVzaCB0aGUgYm9kaWVzIHRvd2FyZCB0aGUgY29uZSBheGlzLCBub3Qgb3V0d2FyZAoKICAgICAgYy5tYXhGb3JjZSA9IDA7CiAgICAgIGMubWluRm9yY2UgPSAtbWF4Rm9yY2U7IC8vIE1ha2UgdGhlIHR3aXN0IGVxdWF0aW9uIGFkZCB0b3JxdWUgdG93YXJkIHRoZSBpbml0aWFsIHBvc2l0aW9uCgogICAgICB0Lm1heEZvcmNlID0gMDsKICAgICAgdC5taW5Gb3JjZSA9IC1tYXhGb3JjZTsKICAgICAgdGhpcy5lcXVhdGlvbnMucHVzaChjLCB0KTsKICAgIH0KCiAgICB1cGRhdGUoKSB7CiAgICAgIGNvbnN0IGJvZHlBID0gdGhpcy5ib2R5QTsKICAgICAgY29uc3QgYm9keUIgPSB0aGlzLmJvZHlCOwogICAgICBjb25zdCBjb25lID0gdGhpcy5jb25lRXF1YXRpb247CiAgICAgIGNvbnN0IHR3aXN0ID0gdGhpcy50d2lzdEVxdWF0aW9uOwogICAgICBzdXBlci51cGRhdGUoKTsgLy8gVXBkYXRlIHRoZSBheGVzIHRvIHRoZSBjb25lIGNvbnN0cmFpbnQKCiAgICAgIGJvZHlBLnZlY3RvclRvV29ybGRGcmFtZSh0aGlzLmF4aXNBLCBjb25lLmF4aXNBKTsKICAgICAgYm9keUIudmVjdG9yVG9Xb3JsZEZyYW1lKHRoaXMuYXhpc0IsIGNvbmUuYXhpc0IpOyAvLyBVcGRhdGUgdGhlIHdvcmxkIGF4ZXMgaW4gdGhlIHR3aXN0IGNvbnN0cmFpbnQKCiAgICAgIHRoaXMuYXhpc0EudGFuZ2VudHModHdpc3QuYXhpc0EsIHR3aXN0LmF4aXNBKTsKICAgICAgYm9keUEudmVjdG9yVG9Xb3JsZEZyYW1lKHR3aXN0LmF4aXNBLCB0d2lzdC5heGlzQSk7CiAgICAgIHRoaXMuYXhpc0IudGFuZ2VudHModHdpc3QuYXhpc0IsIHR3aXN0LmF4aXNCKTsKICAgICAgYm9keUIudmVjdG9yVG9Xb3JsZEZyYW1lKHR3aXN0LmF4aXNCLCB0d2lzdC5heGlzQik7CiAgICAgIGNvbmUuYW5nbGUgPSB0aGlzLmFuZ2xlOwogICAgICB0d2lzdC5tYXhBbmdsZSA9IHRoaXMudHdpc3RBbmdsZTsKICAgIH0KCiAgfQogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogQ29uc3RyYWlucyB0d28gYm9kaWVzIHRvIGJlIGF0IGEgY29uc3RhbnQgZGlzdGFuY2UgZnJvbSBlYWNoIG90aGVycyBjZW50ZXIgb2YgbWFzcy4KICAgKi8KICBjbGFzcyBEaXN0YW5jZUNvbnN0cmFpbnQgZXh0ZW5kcyBDb25zdHJhaW50IHsKICAgIC8qKgogICAgICogVGhlIGRpc3RhbmNlIHRvIGtlZXAuIElmIHVuZGVmaW5lZCwgaXQgd2lsbCBiZSBzZXQgdG8gdGhlIGN1cnJlbnQgZGlzdGFuY2UgYmV0d2VlbiBib2R5QSBhbmQgYm9keUIKICAgICAqLwoKICAgIC8qKgogICAgICogQHBhcmFtIGRpc3RhbmNlIFRoZSBkaXN0YW5jZSB0byBrZWVwLiBJZiB1bmRlZmluZWQsIGl0IHdpbGwgYmUgc2V0IHRvIHRoZSBjdXJyZW50IGRpc3RhbmNlIGJldHdlZW4gYm9keUEgYW5kIGJvZHlCLgogICAgICogQHBhcmFtIG1heEZvcmNlIFRoZSBtYXhpbXVtIGZvcmNlIHRoYXQgc2hvdWxkIGJlIGFwcGxpZWQgdG8gY29uc3RyYWluIHRoZSBib2RpZXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5QiwgZGlzdGFuY2UsIG1heEZvcmNlKSB7CiAgICAgIGlmIChtYXhGb3JjZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgbWF4Rm9yY2UgPSAxZTY7CiAgICAgIH0KCiAgICAgIHN1cGVyKGJvZHlBLCBib2R5Qik7CgogICAgICBpZiAodHlwZW9mIGRpc3RhbmNlID09PSAndW5kZWZpbmVkJykgewogICAgICAgIGRpc3RhbmNlID0gYm9keUEucG9zaXRpb24uZGlzdGFuY2VUbyhib2R5Qi5wb3NpdGlvbik7CiAgICAgIH0KCiAgICAgIHRoaXMuZGlzdGFuY2UgPSBkaXN0YW5jZTsKICAgICAgY29uc3QgZXEgPSB0aGlzLmRpc3RhbmNlRXF1YXRpb24gPSBuZXcgQ29udGFjdEVxdWF0aW9uKGJvZHlBLCBib2R5Qik7CiAgICAgIHRoaXMuZXF1YXRpb25zLnB1c2goZXEpOyAvLyBNYWtlIGl0IGJpZGlyZWN0aW9uYWwKCiAgICAgIGVxLm1pbkZvcmNlID0gLW1heEZvcmNlOwogICAgICBlcS5tYXhGb3JjZSA9IG1heEZvcmNlOwogICAgfQogICAgLyoqCiAgICAgKiB1cGRhdGUKICAgICAqLwoKCiAgICB1cGRhdGUoKSB7CiAgICAgIGNvbnN0IGJvZHlBID0gdGhpcy5ib2R5QTsKICAgICAgY29uc3QgYm9keUIgPSB0aGlzLmJvZHlCOwogICAgICBjb25zdCBlcSA9IHRoaXMuZGlzdGFuY2VFcXVhdGlvbjsKICAgICAgY29uc3QgaGFsZkRpc3QgPSB0aGlzLmRpc3RhbmNlICogMC41OwogICAgICBjb25zdCBub3JtYWwgPSBlcS5uaTsKICAgICAgYm9keUIucG9zaXRpb24udnN1Yihib2R5QS5wb3NpdGlvbiwgbm9ybWFsKTsKICAgICAgbm9ybWFsLm5vcm1hbGl6ZSgpOwogICAgICBub3JtYWwuc2NhbGUoaGFsZkRpc3QsIGVxLnJpKTsKICAgICAgbm9ybWFsLnNjYWxlKC1oYWxmRGlzdCwgZXEucmopOwogICAgfQoKICB9CgogIC8qKgogICAqIExvY2sgY29uc3RyYWludC4gV2lsbCByZW1vdmUgYWxsIGRlZ3JlZXMgb2YgZnJlZWRvbSBiZXR3ZWVuIHRoZSBib2RpZXMuCiAgICovCiAgY2xhc3MgTG9ja0NvbnN0cmFpbnQgZXh0ZW5kcyBQb2ludFRvUG9pbnRDb25zdHJhaW50IHsKICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBjb25zdCBtYXhGb3JjZSA9IHR5cGVvZiBvcHRpb25zLm1heEZvcmNlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMubWF4Rm9yY2UgOiAxZTY7IC8vIFNldCBwaXZvdCBwb2ludCBpbiBiZXR3ZWVuCgogICAgICBjb25zdCBwaXZvdEEgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBwaXZvdEIgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBoYWxmV2F5ID0gbmV3IFZlYzMoKTsKICAgICAgYm9keUEucG9zaXRpb24udmFkZChib2R5Qi5wb3NpdGlvbiwgaGFsZldheSk7CiAgICAgIGhhbGZXYXkuc2NhbGUoMC41LCBoYWxmV2F5KTsKICAgICAgYm9keUIucG9pbnRUb0xvY2FsRnJhbWUoaGFsZldheSwgcGl2b3RCKTsKICAgICAgYm9keUEucG9pbnRUb0xvY2FsRnJhbWUoaGFsZldheSwgcGl2b3RBKTsgLy8gVGhlIHBvaW50LXRvLXBvaW50IGNvbnN0cmFpbnQgd2lsbCBrZWVwIGEgcG9pbnQgc2hhcmVkIGJldHdlZW4gdGhlIGJvZGllcwoKICAgICAgc3VwZXIoYm9keUEsIHBpdm90QSwgYm9keUIsIHBpdm90QiwgbWF4Rm9yY2UpOyAvLyBTdG9yZSBpbml0aWFsIHJvdGF0aW9uIG9mIHRoZSBib2RpZXMgYXMgdW5pdCB2ZWN0b3JzIGluIHRoZSBsb2NhbCBib2R5IHNwYWNlcwoKICAgICAgdGhpcy54QSA9IGJvZHlBLnZlY3RvclRvTG9jYWxGcmFtZShWZWMzLlVOSVRfWCk7CiAgICAgIHRoaXMueEIgPSBib2R5Qi52ZWN0b3JUb0xvY2FsRnJhbWUoVmVjMy5VTklUX1gpOwogICAgICB0aGlzLnlBID0gYm9keUEudmVjdG9yVG9Mb2NhbEZyYW1lKFZlYzMuVU5JVF9ZKTsKICAgICAgdGhpcy55QiA9IGJvZHlCLnZlY3RvclRvTG9jYWxGcmFtZShWZWMzLlVOSVRfWSk7CiAgICAgIHRoaXMuekEgPSBib2R5QS52ZWN0b3JUb0xvY2FsRnJhbWUoVmVjMy5VTklUX1opOwogICAgICB0aGlzLnpCID0gYm9keUIudmVjdG9yVG9Mb2NhbEZyYW1lKFZlYzMuVU5JVF9aKTsgLy8gLi4uYW5kIHRoZSBmb2xsb3dpbmcgcm90YXRpb25hbCBlcXVhdGlvbnMgd2lsbCBrZWVwIGFsbCByb3RhdGlvbmFsIERPRidzIGluIHBsYWNlCgogICAgICBjb25zdCByMSA9IHRoaXMucm90YXRpb25hbEVxdWF0aW9uMSA9IG5ldyBSb3RhdGlvbmFsRXF1YXRpb24oYm9keUEsIGJvZHlCLCBvcHRpb25zKTsKICAgICAgY29uc3QgcjIgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjIgPSBuZXcgUm90YXRpb25hbEVxdWF0aW9uKGJvZHlBLCBib2R5Qiwgb3B0aW9ucyk7CiAgICAgIGNvbnN0IHIzID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24zID0gbmV3IFJvdGF0aW9uYWxFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICB0aGlzLmVxdWF0aW9ucy5wdXNoKHIxLCByMiwgcjMpOwogICAgfQogICAgLyoqCiAgICAgKiB1cGRhdGUKICAgICAqLwoKCiAgICB1cGRhdGUoKSB7CiAgICAgIGNvbnN0IGJvZHlBID0gdGhpcy5ib2R5QTsKICAgICAgY29uc3QgYm9keUIgPSB0aGlzLmJvZHlCOwogICAgICB0aGlzLm1vdG9yRXF1YXRpb247CiAgICAgIGNvbnN0IHIxID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24xOwogICAgICBjb25zdCByMiA9IHRoaXMucm90YXRpb25hbEVxdWF0aW9uMjsKICAgICAgY29uc3QgcjMgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjM7CiAgICAgIHN1cGVyLnVwZGF0ZSgpOyAvLyBUaGVzZSB2ZWN0b3IgcGFpcnMgbXVzdCBiZSBvcnRob2dvbmFsCgogICAgICBib2R5QS52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy54QSwgcjEuYXhpc0EpOwogICAgICBib2R5Qi52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy55QiwgcjEuYXhpc0IpOwogICAgICBib2R5QS52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy55QSwgcjIuYXhpc0EpOwogICAgICBib2R5Qi52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy56QiwgcjIuYXhpc0IpOwogICAgICBib2R5QS52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy56QSwgcjMuYXhpc0EpOwogICAgICBib2R5Qi52ZWN0b3JUb1dvcmxkRnJhbWUodGhpcy54QiwgcjMuYXhpc0IpOwogICAgfQoKICB9CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwoKICAvKioKICAgKiBSb3RhdGlvbmFsIG1vdG9yIGNvbnN0cmFpbnQuIFRyaWVzIHRvIGtlZXAgdGhlIHJlbGF0aXZlIGFuZ3VsYXIgdmVsb2NpdHkgb2YgdGhlIGJvZGllcyB0byBhIGdpdmVuIHZhbHVlLgogICAqLwogIGNsYXNzIFJvdGF0aW9uYWxNb3RvckVxdWF0aW9uIGV4dGVuZHMgRXF1YXRpb24gewogICAgLyoqCiAgICAgKiBXb3JsZCBvcmllbnRlZCByb3RhdGlvbmFsIGF4aXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFdvcmxkIG9yaWVudGVkIHJvdGF0aW9uYWwgYXhpcy4KICAgICAqLwoKICAgIC8qKgogICAgICogTW90b3IgdmVsb2NpdHkuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5QiwgbWF4Rm9yY2UpIHsKICAgICAgaWYgKG1heEZvcmNlID09PSB2b2lkIDApIHsKICAgICAgICBtYXhGb3JjZSA9IDFlNjsKICAgICAgfQoKICAgICAgc3VwZXIoYm9keUEsIGJvZHlCLCAtbWF4Rm9yY2UsIG1heEZvcmNlKTsKICAgICAgdGhpcy5heGlzQSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuYXhpc0IgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnRhcmdldFZlbG9jaXR5ID0gMDsKICAgIH0KCiAgICBjb21wdXRlQihoKSB7CiAgICAgIHRoaXMuYTsKICAgICAgY29uc3QgYiA9IHRoaXMuYjsKICAgICAgdGhpcy5iaTsKICAgICAgdGhpcy5iajsKICAgICAgY29uc3QgYXhpc0EgPSB0aGlzLmF4aXNBOwogICAgICBjb25zdCBheGlzQiA9IHRoaXMuYXhpc0I7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsgLy8gZyA9IDAKICAgICAgLy8gZ2RvdCA9IGF4aXNBICogd2kgLSBheGlzQiAqIHdqCiAgICAgIC8vIGdkb3QgPSBHICogVyA9IEcgKiBbdmkgd2kgdmogd2pdCiAgICAgIC8vID0+CiAgICAgIC8vIEcgPSBbMCBheGlzQSAwIC1heGlzQl0KCiAgICAgIEdBLnJvdGF0aW9uYWwuY29weShheGlzQSk7CiAgICAgIGF4aXNCLm5lZ2F0ZShHQi5yb3RhdGlvbmFsKTsKICAgICAgY29uc3QgR1cgPSB0aGlzLmNvbXB1dGVHVygpIC0gdGhpcy50YXJnZXRWZWxvY2l0eTsKICAgICAgY29uc3QgR2lNZiA9IHRoaXMuY29tcHV0ZUdpTWYoKTsKICAgICAgY29uc3QgQiA9IC1HVyAqIGIgLSBoICogR2lNZjsKICAgICAgcmV0dXJuIEI7CiAgICB9CgogIH0KCiAgLyoqCiAgICogSGluZ2UgY29uc3RyYWludC4gVGhpbmsgb2YgaXQgYXMgYSBkb29yIGhpbmdlLiBJdCB0cmllcyB0byBrZWVwIHRoZSBkb29yIGluIHRoZSBjb3JyZWN0IHBsYWNlIGFuZCB3aXRoIHRoZSBjb3JyZWN0IG9yaWVudGF0aW9uLgogICAqLwogIGNsYXNzIEhpbmdlQ29uc3RyYWludCBleHRlbmRzIFBvaW50VG9Qb2ludENvbnN0cmFpbnQgewogICAgLyoqCiAgICAgKiBSb3RhdGlvbiBheGlzLCBkZWZpbmVkIGxvY2FsbHkgaW4gYm9keUEuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFJvdGF0aW9uIGF4aXMsIGRlZmluZWQgbG9jYWxseSBpbiBib2R5Qi4KICAgICAqLwogICAgY29uc3RydWN0b3IoYm9keUEsIGJvZHlCLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIGNvbnN0IG1heEZvcmNlID0gdHlwZW9mIG9wdGlvbnMubWF4Rm9yY2UgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5tYXhGb3JjZSA6IDFlNjsKICAgICAgY29uc3QgcGl2b3RBID0gb3B0aW9ucy5waXZvdEEgPyBvcHRpb25zLnBpdm90QS5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgY29uc3QgcGl2b3RCID0gb3B0aW9ucy5waXZvdEIgPyBvcHRpb25zLnBpdm90Qi5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgc3VwZXIoYm9keUEsIHBpdm90QSwgYm9keUIsIHBpdm90QiwgbWF4Rm9yY2UpOwogICAgICBjb25zdCBheGlzQSA9IHRoaXMuYXhpc0EgPSBvcHRpb25zLmF4aXNBID8gb3B0aW9ucy5heGlzQS5jbG9uZSgpIDogbmV3IFZlYzMoMSwgMCwgMCk7CiAgICAgIGF4aXNBLm5vcm1hbGl6ZSgpOwogICAgICBjb25zdCBheGlzQiA9IHRoaXMuYXhpc0IgPSBvcHRpb25zLmF4aXNCID8gb3B0aW9ucy5heGlzQi5jbG9uZSgpIDogbmV3IFZlYzMoMSwgMCwgMCk7CiAgICAgIGF4aXNCLm5vcm1hbGl6ZSgpOwogICAgICB0aGlzLmNvbGxpZGVDb25uZWN0ZWQgPSAhIW9wdGlvbnMuY29sbGlkZUNvbm5lY3RlZDsKICAgICAgY29uc3Qgcm90YXRpb25hbDEgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjEgPSBuZXcgUm90YXRpb25hbEVxdWF0aW9uKGJvZHlBLCBib2R5Qiwgb3B0aW9ucyk7CiAgICAgIGNvbnN0IHJvdGF0aW9uYWwyID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24yID0gbmV3IFJvdGF0aW9uYWxFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICBjb25zdCBtb3RvciA9IHRoaXMubW90b3JFcXVhdGlvbiA9IG5ldyBSb3RhdGlvbmFsTW90b3JFcXVhdGlvbihib2R5QSwgYm9keUIsIG1heEZvcmNlKTsKICAgICAgbW90b3IuZW5hYmxlZCA9IGZhbHNlOyAvLyBOb3QgZW5hYmxlZCBieSBkZWZhdWx0CiAgICAgIC8vIEVxdWF0aW9ucyB0byBiZSBmZWQgdG8gdGhlIHNvbHZlcgoKICAgICAgdGhpcy5lcXVhdGlvbnMucHVzaChyb3RhdGlvbmFsMSwgcm90YXRpb25hbDIsIG1vdG9yKTsKICAgIH0KICAgIC8qKgogICAgICogZW5hYmxlTW90b3IKICAgICAqLwoKCiAgICBlbmFibGVNb3RvcigpIHsKICAgICAgdGhpcy5tb3RvckVxdWF0aW9uLmVuYWJsZWQgPSB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBkaXNhYmxlTW90b3IKICAgICAqLwoKCiAgICBkaXNhYmxlTW90b3IoKSB7CiAgICAgIHRoaXMubW90b3JFcXVhdGlvbi5lbmFibGVkID0gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIHNldE1vdG9yU3BlZWQKICAgICAqLwoKCiAgICBzZXRNb3RvclNwZWVkKHNwZWVkKSB7CiAgICAgIHRoaXMubW90b3JFcXVhdGlvbi50YXJnZXRWZWxvY2l0eSA9IHNwZWVkOwogICAgfQogICAgLyoqCiAgICAgKiBzZXRNb3Rvck1heEZvcmNlCiAgICAgKi8KCgogICAgc2V0TW90b3JNYXhGb3JjZShtYXhGb3JjZSkgewogICAgICB0aGlzLm1vdG9yRXF1YXRpb24ubWF4Rm9yY2UgPSBtYXhGb3JjZTsKICAgICAgdGhpcy5tb3RvckVxdWF0aW9uLm1pbkZvcmNlID0gLW1heEZvcmNlOwogICAgfQogICAgLyoqCiAgICAgKiB1cGRhdGUKICAgICAqLwoKCiAgICB1cGRhdGUoKSB7CiAgICAgIGNvbnN0IGJvZHlBID0gdGhpcy5ib2R5QTsKICAgICAgY29uc3QgYm9keUIgPSB0aGlzLmJvZHlCOwogICAgICBjb25zdCBtb3RvciA9IHRoaXMubW90b3JFcXVhdGlvbjsKICAgICAgY29uc3QgcjEgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjE7CiAgICAgIGNvbnN0IHIyID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24yOwogICAgICBjb25zdCB3b3JsZEF4aXNBID0gSGluZ2VDb25zdHJhaW50X3VwZGF0ZV90bXBWZWMxOwogICAgICBjb25zdCB3b3JsZEF4aXNCID0gSGluZ2VDb25zdHJhaW50X3VwZGF0ZV90bXBWZWMyOwogICAgICBjb25zdCBheGlzQSA9IHRoaXMuYXhpc0E7CiAgICAgIGNvbnN0IGF4aXNCID0gdGhpcy5heGlzQjsKICAgICAgc3VwZXIudXBkYXRlKCk7IC8vIEdldCB3b3JsZCBheGVzCgogICAgICBib2R5QS5xdWF0ZXJuaW9uLnZtdWx0KGF4aXNBLCB3b3JsZEF4aXNBKTsKICAgICAgYm9keUIucXVhdGVybmlvbi52bXVsdChheGlzQiwgd29ybGRBeGlzQik7CiAgICAgIHdvcmxkQXhpc0EudGFuZ2VudHMocjEuYXhpc0EsIHIyLmF4aXNBKTsKICAgICAgcjEuYXhpc0IuY29weSh3b3JsZEF4aXNCKTsKICAgICAgcjIuYXhpc0IuY29weSh3b3JsZEF4aXNCKTsKCiAgICAgIGlmICh0aGlzLm1vdG9yRXF1YXRpb24uZW5hYmxlZCkgewogICAgICAgIGJvZHlBLnF1YXRlcm5pb24udm11bHQodGhpcy5heGlzQSwgbW90b3IuYXhpc0EpOwogICAgICAgIGJvZHlCLnF1YXRlcm5pb24udm11bHQodGhpcy5heGlzQiwgbW90b3IuYXhpc0IpOwogICAgICB9CiAgICB9CgogIH0KICBjb25zdCBIaW5nZUNvbnN0cmFpbnRfdXBkYXRlX3RtcFZlYzEgPSBuZXcgVmVjMygpOwogIGNvbnN0IEhpbmdlQ29uc3RyYWludF91cGRhdGVfdG1wVmVjMiA9IG5ldyBWZWMzKCk7CgogIC8qKgogICAqIENvbnN0cmFpbnMgdGhlIHNsaXBwaW5nIGluIGEgY29udGFjdCBhbG9uZyBhIHRhbmdlbnQKICAgKi8KICBjbGFzcyBGcmljdGlvbkVxdWF0aW9uIGV4dGVuZHMgRXF1YXRpb24gewogICAgLy8gVGFuZ2VudAoKICAgIC8qKgogICAgICogQHBhcmFtIHNsaXBGb3JjZSBzaG91bGQgYmUgKy1GX2ZyaWN0aW9uID0gKy1tdSAqIEZfbm9ybWFsID0gKy1tdSAqIG0gKiBnCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgc2xpcEZvcmNlKSB7CiAgICAgIHN1cGVyKGJvZHlBLCBib2R5QiwgLXNsaXBGb3JjZSwgc2xpcEZvcmNlKTsKICAgICAgdGhpcy5yaSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMucmogPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnQgPSBuZXcgVmVjMygpOwogICAgfQoKICAgIGNvbXB1dGVCKGgpIHsKICAgICAgdGhpcy5hOwogICAgICBjb25zdCBiID0gdGhpcy5iOwogICAgICB0aGlzLmJpOwogICAgICB0aGlzLmJqOwogICAgICBjb25zdCByaSA9IHRoaXMucmk7CiAgICAgIGNvbnN0IHJqID0gdGhpcy5yajsKICAgICAgY29uc3Qgcml4dCA9IEZyaWN0aW9uRXF1YXRpb25fY29tcHV0ZUJfdGVtcDE7CiAgICAgIGNvbnN0IHJqeHQgPSBGcmljdGlvbkVxdWF0aW9uX2NvbXB1dGVCX3RlbXAyOwogICAgICBjb25zdCB0ID0gdGhpcy50OyAvLyBDYWx1Y2xhdGUgY3Jvc3MgcHJvZHVjdHMKCiAgICAgIHJpLmNyb3NzKHQsIHJpeHQpOwogICAgICByai5jcm9zcyh0LCByanh0KTsgLy8gRyA9IFstdCAtcml4dCB0IHJqeHRdCiAgICAgIC8vIEFuZCByZW1lbWJlciwgdGhpcyBpcyBhIHB1cmUgdmVsb2NpdHkgY29uc3RyYWludCwgZyBpcyBhbHdheXMgemVybyEKCiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsKICAgICAgdC5uZWdhdGUoR0Euc3BhdGlhbCk7CiAgICAgIHJpeHQubmVnYXRlKEdBLnJvdGF0aW9uYWwpOwogICAgICBHQi5zcGF0aWFsLmNvcHkodCk7CiAgICAgIEdCLnJvdGF0aW9uYWwuY29weShyanh0KTsKICAgICAgY29uc3QgR1cgPSB0aGlzLmNvbXB1dGVHVygpOwogICAgICBjb25zdCBHaU1mID0gdGhpcy5jb21wdXRlR2lNZigpOwogICAgICBjb25zdCBCID0gLUdXICogYiAtIGggKiBHaU1mOwogICAgICByZXR1cm4gQjsKICAgIH0KCiAgfQogIGNvbnN0IEZyaWN0aW9uRXF1YXRpb25fY29tcHV0ZUJfdGVtcDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IEZyaWN0aW9uRXF1YXRpb25fY29tcHV0ZUJfdGVtcDIgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBEZWZpbmVzIHdoYXQgaGFwcGVucyB3aGVuIHR3byBtYXRlcmlhbHMgbWVldC4KICAgKiBAdG9kbyBSZWZhY3RvciBtYXRlcmlhbHMgdG8gbWF0ZXJpYWxBIGFuZCBtYXRlcmlhbEIKICAgKi8KICBjbGFzcyBDb250YWN0TWF0ZXJpYWwgewogICAgLyoqCiAgICAgKiBJZGVudGlmaWVyIG9mIHRoaXMgbWF0ZXJpYWwuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFBhcnRpY2lwYXRpbmcgbWF0ZXJpYWxzLgogICAgICovCgogICAgLyoqCiAgICAgKiBGcmljdGlvbiBjb2VmZmljaWVudC4KICAgICAqIEBkZWZhdWx0IDAuMwogICAgICovCgogICAgLyoqCiAgICAgKiBSZXN0aXR1dGlvbiBjb2VmZmljaWVudC4KICAgICAqIEBkZWZhdWx0IDAuMwogICAgICovCgogICAgLyoqCiAgICAgKiBTdGlmZm5lc3Mgb2YgdGhlIHByb2R1Y2VkIGNvbnRhY3QgZXF1YXRpb25zLgogICAgICogQGRlZmF1bHQgMWU3CiAgICAgKi8KCiAgICAvKioKICAgICAqIFJlbGF4YXRpb24gdGltZSBvZiB0aGUgcHJvZHVjZWQgY29udGFjdCBlcXVhdGlvbnMuCiAgICAgKiBAZGVmYXVsdCAzCiAgICAgKi8KCiAgICAvKioKICAgICAqIFN0aWZmbmVzcyBvZiB0aGUgcHJvZHVjZWQgZnJpY3Rpb24gZXF1YXRpb25zLgogICAgICogQGRlZmF1bHQgMWU3CiAgICAgKi8KCiAgICAvKioKICAgICAqIFJlbGF4YXRpb24gdGltZSBvZiB0aGUgcHJvZHVjZWQgZnJpY3Rpb24gZXF1YXRpb25zCiAgICAgKiBAZGVmYXVsdCAzCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG0xLCBtMiwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gVXRpbHMuZGVmYXVsdHMob3B0aW9ucywgewogICAgICAgIGZyaWN0aW9uOiAwLjMsCiAgICAgICAgcmVzdGl0dXRpb246IDAuMywKICAgICAgICBjb250YWN0RXF1YXRpb25TdGlmZm5lc3M6IDFlNywKICAgICAgICBjb250YWN0RXF1YXRpb25SZWxheGF0aW9uOiAzLAogICAgICAgIGZyaWN0aW9uRXF1YXRpb25TdGlmZm5lc3M6IDFlNywKICAgICAgICBmcmljdGlvbkVxdWF0aW9uUmVsYXhhdGlvbjogMwogICAgICB9KTsKICAgICAgdGhpcy5pZCA9IENvbnRhY3RNYXRlcmlhbC5pZENvdW50ZXIrKzsKICAgICAgdGhpcy5tYXRlcmlhbHMgPSBbbTEsIG0yXTsKICAgICAgdGhpcy5mcmljdGlvbiA9IG9wdGlvbnMuZnJpY3Rpb247CiAgICAgIHRoaXMucmVzdGl0dXRpb24gPSBvcHRpb25zLnJlc3RpdHV0aW9uOwogICAgICB0aGlzLmNvbnRhY3RFcXVhdGlvblN0aWZmbmVzcyA9IG9wdGlvbnMuY29udGFjdEVxdWF0aW9uU3RpZmZuZXNzOwogICAgICB0aGlzLmNvbnRhY3RFcXVhdGlvblJlbGF4YXRpb24gPSBvcHRpb25zLmNvbnRhY3RFcXVhdGlvblJlbGF4YXRpb247CiAgICAgIHRoaXMuZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcyA9IG9wdGlvbnMuZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzczsKICAgICAgdGhpcy5mcmljdGlvbkVxdWF0aW9uUmVsYXhhdGlvbiA9IG9wdGlvbnMuZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb247CiAgICB9CgogIH0KICBDb250YWN0TWF0ZXJpYWwuaWRDb3VudGVyID0gMDsKCiAgLyoqCiAgICogRGVmaW5lcyBhIHBoeXNpY3MgbWF0ZXJpYWwuCiAgICovCiAgY2xhc3MgTWF0ZXJpYWwgewogICAgLyoqCiAgICAgKiBNYXRlcmlhbCBuYW1lLgogICAgICogSWYgb3B0aW9ucyBpcyBhIHN0cmluZywgbmFtZSB3aWxsIGJlIHNldCB0byB0aGF0IHN0cmluZy4KICAgICAqIEB0b2RvIERlcHJlY2F0ZSB0aGlzCiAgICAgKi8KCiAgICAvKiogTWF0ZXJpYWwgaWQuICovCgogICAgLyoqCiAgICAgKiBGcmljdGlvbiBmb3IgdGhpcyBtYXRlcmlhbC4KICAgICAqIElmIG5vbi1uZWdhdGl2ZSwgaXQgd2lsbCBiZSB1c2VkIGluc3RlYWQgb2YgdGhlIGZyaWN0aW9uIGdpdmVuIGJ5IENvbnRhY3RNYXRlcmlhbHMuIElmIHRoZXJlJ3Mgbm8gbWF0Y2hpbmcgQ29udGFjdE1hdGVyaWFsLCB0aGUgdmFsdWUgZnJvbSBgZGVmYXVsdENvbnRhY3RNYXRlcmlhbGAgaW4gdGhlIFdvcmxkIHdpbGwgYmUgdXNlZC4KICAgICAqLwoKICAgIC8qKgogICAgICogUmVzdGl0dXRpb24gZm9yIHRoaXMgbWF0ZXJpYWwuCiAgICAgKiBJZiBub24tbmVnYXRpdmUsIGl0IHdpbGwgYmUgdXNlZCBpbnN0ZWFkIG9mIHRoZSByZXN0aXR1dGlvbiBnaXZlbiBieSBDb250YWN0TWF0ZXJpYWxzLiBJZiB0aGVyZSdzIG5vIG1hdGNoaW5nIENvbnRhY3RNYXRlcmlhbCwgdGhlIHZhbHVlIGZyb20gYGRlZmF1bHRDb250YWN0TWF0ZXJpYWxgIGluIHRoZSBXb3JsZCB3aWxsIGJlIHVzZWQuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgbGV0IG5hbWUgPSAnJzsgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgZml4CgogICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgLy9jb25zb2xlLndhcm4oYFBhc3NpbmcgYSBzdHJpbmcgdG8gTWF0ZXJpYWxPcHRpb25zIGlzIGRlcHJlY2F0ZWQsIGFuZCBoYXMgbm8gZWZmZWN0YCkKICAgICAgICBuYW1lID0gb3B0aW9uczsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuaWQgPSBNYXRlcmlhbC5pZENvdW50ZXIrKzsKICAgICAgdGhpcy5mcmljdGlvbiA9IHR5cGVvZiBvcHRpb25zLmZyaWN0aW9uICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuZnJpY3Rpb24gOiAtMTsKICAgICAgdGhpcy5yZXN0aXR1dGlvbiA9IHR5cGVvZiBvcHRpb25zLnJlc3RpdHV0aW9uICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMucmVzdGl0dXRpb24gOiAtMTsKICAgIH0KCiAgfQogIE1hdGVyaWFsLmlkQ291bnRlciA9IDA7CgogIC8qKgogICAqIEEgc3ByaW5nLCBjb25uZWN0aW5nIHR3byBib2RpZXMuCiAgICogQGV4YW1wbGUKICAgKiAgICAgY29uc3Qgc3ByaW5nID0gbmV3IFNwcmluZyhib3hCb2R5LCBzcGhlcmVCb2R5LCB7CiAgICogICAgICAgcmVzdExlbmd0aDogMCwKICAgKiAgICAgICBzdGlmZm5lc3M6IDUwLAogICAqICAgICAgIGRhbXBpbmc6IDEsCiAgICogICAgIH0pCiAgICoKICAgKiAgICAgLy8gQ29tcHV0ZSB0aGUgZm9yY2UgYWZ0ZXIgZWFjaCBzdGVwCiAgICogICAgIHdvcmxkLmFkZEV2ZW50TGlzdGVuZXIoJ3Bvc3RTdGVwJywgKGV2ZW50KSA9PiB7CiAgICogICAgICAgc3ByaW5nLmFwcGx5Rm9yY2UoKQogICAqICAgICB9KQogICAqLwogIGNsYXNzIFNwcmluZyB7CiAgICAvKioKICAgICAqIFJlc3QgbGVuZ3RoIG9mIHRoZSBzcHJpbmcuIEEgbnVtYmVyID4gMC4KICAgICAqIEBkZWZhdWx0IDEKICAgICAqLwoKICAgIC8qKgogICAgICogU3RpZmZuZXNzIG9mIHRoZSBzcHJpbmcuIEEgbnVtYmVyID49IDAuCiAgICAgKiBAZGVmYXVsdCAxMDAKICAgICAqLwoKICAgIC8qKgogICAgICogRGFtcGluZyBvZiB0aGUgc3ByaW5nLiBBIG51bWJlciA+PSAwLgogICAgICogQGRlZmF1bHQgMQogICAgICovCgogICAgLyoqCiAgICAgKiBGaXJzdCBjb25uZWN0ZWQgYm9keS4KICAgICAqLwoKICAgIC8qKgogICAgICogU2Vjb25kIGNvbm5lY3RlZCBib2R5LgogICAgICovCgogICAgLyoqCiAgICAgKiBBbmNob3IgZm9yIGJvZHlBIGluIGxvY2FsIGJvZHlBIGNvb3JkaW5hdGVzLgogICAgICogV2hlcmUgdG8gaG9vayB0aGUgc3ByaW5nIHRvIGJvZHkgQSwgaW4gbG9jYWwgYm9keSBjb29yZGluYXRlcy4KICAgICAqIEBkZWZhdWx0IG5ldyBWZWMzKCkKICAgICAqLwoKICAgIC8qKgogICAgICogQW5jaG9yIGZvciBib2R5QiBpbiBsb2NhbCBib2R5QiBjb29yZGluYXRlcy4KICAgICAqIFdoZXJlIHRvIGhvb2sgdGhlIHNwcmluZyB0byBib2R5IEIsIGluIGxvY2FsIGJvZHkgY29vcmRpbmF0ZXMuCiAgICAgKiBAZGVmYXVsdCBuZXcgVmVjMygpCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLnJlc3RMZW5ndGggPSB0eXBlb2Ygb3B0aW9ucy5yZXN0TGVuZ3RoID09PSAnbnVtYmVyJyA/IG9wdGlvbnMucmVzdExlbmd0aCA6IDE7CiAgICAgIHRoaXMuc3RpZmZuZXNzID0gb3B0aW9ucy5zdGlmZm5lc3MgfHwgMTAwOwogICAgICB0aGlzLmRhbXBpbmcgPSBvcHRpb25zLmRhbXBpbmcgfHwgMTsKICAgICAgdGhpcy5ib2R5QSA9IGJvZHlBOwogICAgICB0aGlzLmJvZHlCID0gYm9keUI7CiAgICAgIHRoaXMubG9jYWxBbmNob3JBID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5sb2NhbEFuY2hvckIgPSBuZXcgVmVjMygpOwoKICAgICAgaWYgKG9wdGlvbnMubG9jYWxBbmNob3JBKSB7CiAgICAgICAgdGhpcy5sb2NhbEFuY2hvckEuY29weShvcHRpb25zLmxvY2FsQW5jaG9yQSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLmxvY2FsQW5jaG9yQikgewogICAgICAgIHRoaXMubG9jYWxBbmNob3JCLmNvcHkob3B0aW9ucy5sb2NhbEFuY2hvckIpOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy53b3JsZEFuY2hvckEpIHsKICAgICAgICB0aGlzLnNldFdvcmxkQW5jaG9yQShvcHRpb25zLndvcmxkQW5jaG9yQSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLndvcmxkQW5jaG9yQikgewogICAgICAgIHRoaXMuc2V0V29ybGRBbmNob3JCKG9wdGlvbnMud29ybGRBbmNob3JCKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIGFuY2hvciBwb2ludCBvbiBib2R5IEEsIHVzaW5nIHdvcmxkIGNvb3JkaW5hdGVzLgogICAgICovCgoKICAgIHNldFdvcmxkQW5jaG9yQSh3b3JsZEFuY2hvckEpIHsKICAgICAgdGhpcy5ib2R5QS5wb2ludFRvTG9jYWxGcmFtZSh3b3JsZEFuY2hvckEsIHRoaXMubG9jYWxBbmNob3JBKTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBhbmNob3IgcG9pbnQgb24gYm9keSBCLCB1c2luZyB3b3JsZCBjb29yZGluYXRlcy4KICAgICAqLwoKCiAgICBzZXRXb3JsZEFuY2hvckIod29ybGRBbmNob3JCKSB7CiAgICAgIHRoaXMuYm9keUIucG9pbnRUb0xvY2FsRnJhbWUod29ybGRBbmNob3JCLCB0aGlzLmxvY2FsQW5jaG9yQik7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgYW5jaG9yIHBvaW50IG9uIGJvZHkgQSwgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiAgICAgKiBAcGFyYW0gcmVzdWx0IFRoZSB2ZWN0b3IgdG8gc3RvcmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBnZXRXb3JsZEFuY2hvckEocmVzdWx0KSB7CiAgICAgIHRoaXMuYm9keUEucG9pbnRUb1dvcmxkRnJhbWUodGhpcy5sb2NhbEFuY2hvckEsIHJlc3VsdCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgYW5jaG9yIHBvaW50IG9uIGJvZHkgQiwgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiAgICAgKiBAcGFyYW0gcmVzdWx0IFRoZSB2ZWN0b3IgdG8gc3RvcmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBnZXRXb3JsZEFuY2hvckIocmVzdWx0KSB7CiAgICAgIHRoaXMuYm9keUIucG9pbnRUb1dvcmxkRnJhbWUodGhpcy5sb2NhbEFuY2hvckIsIHJlc3VsdCk7CiAgICB9CiAgICAvKioKICAgICAqIEFwcGx5IHRoZSBzcHJpbmcgZm9yY2UgdG8gdGhlIGNvbm5lY3RlZCBib2RpZXMuCiAgICAgKi8KCgogICAgYXBwbHlGb3JjZSgpIHsKICAgICAgY29uc3QgayA9IHRoaXMuc3RpZmZuZXNzOwogICAgICBjb25zdCBkID0gdGhpcy5kYW1waW5nOwogICAgICBjb25zdCBsID0gdGhpcy5yZXN0TGVuZ3RoOwogICAgICBjb25zdCBib2R5QSA9IHRoaXMuYm9keUE7CiAgICAgIGNvbnN0IGJvZHlCID0gdGhpcy5ib2R5QjsKICAgICAgY29uc3QgciA9IGFwcGx5Rm9yY2VfcjsKICAgICAgY29uc3Qgcl91bml0ID0gYXBwbHlGb3JjZV9yX3VuaXQ7CiAgICAgIGNvbnN0IHUgPSBhcHBseUZvcmNlX3U7CiAgICAgIGNvbnN0IGYgPSBhcHBseUZvcmNlX2Y7CiAgICAgIGNvbnN0IHRtcCA9IGFwcGx5Rm9yY2VfdG1wOwogICAgICBjb25zdCB3b3JsZEFuY2hvckEgPSBhcHBseUZvcmNlX3dvcmxkQW5jaG9yQTsKICAgICAgY29uc3Qgd29ybGRBbmNob3JCID0gYXBwbHlGb3JjZV93b3JsZEFuY2hvckI7CiAgICAgIGNvbnN0IHJpID0gYXBwbHlGb3JjZV9yaTsKICAgICAgY29uc3QgcmogPSBhcHBseUZvcmNlX3JqOwogICAgICBjb25zdCByaV94X2YgPSBhcHBseUZvcmNlX3JpX3hfZjsKICAgICAgY29uc3QgcmpfeF9mID0gYXBwbHlGb3JjZV9yal94X2Y7IC8vIEdldCB3b3JsZCBhbmNob3JzCgogICAgICB0aGlzLmdldFdvcmxkQW5jaG9yQSh3b3JsZEFuY2hvckEpOwogICAgICB0aGlzLmdldFdvcmxkQW5jaG9yQih3b3JsZEFuY2hvckIpOyAvLyBHZXQgb2Zmc2V0IHBvaW50cwoKICAgICAgd29ybGRBbmNob3JBLnZzdWIoYm9keUEucG9zaXRpb24sIHJpKTsKICAgICAgd29ybGRBbmNob3JCLnZzdWIoYm9keUIucG9zaXRpb24sIHJqKTsgLy8gQ29tcHV0ZSBkaXN0YW5jZSB2ZWN0b3IgYmV0d2VlbiB3b3JsZCBhbmNob3IgcG9pbnRzCgogICAgICB3b3JsZEFuY2hvckIudnN1Yih3b3JsZEFuY2hvckEsIHIpOwogICAgICBjb25zdCBybGVuID0gci5sZW5ndGgoKTsKICAgICAgcl91bml0LmNvcHkocik7CiAgICAgIHJfdW5pdC5ub3JtYWxpemUoKTsgLy8gQ29tcHV0ZSByZWxhdGl2ZSB2ZWxvY2l0eSBvZiB0aGUgYW5jaG9yIHBvaW50cywgdQoKICAgICAgYm9keUIudmVsb2NpdHkudnN1Yihib2R5QS52ZWxvY2l0eSwgdSk7IC8vIEFkZCByb3RhdGlvbmFsIHZlbG9jaXR5CgogICAgICBib2R5Qi5hbmd1bGFyVmVsb2NpdHkuY3Jvc3MocmosIHRtcCk7CiAgICAgIHUudmFkZCh0bXAsIHUpOwogICAgICBib2R5QS5hbmd1bGFyVmVsb2NpdHkuY3Jvc3MocmksIHRtcCk7CiAgICAgIHUudnN1Yih0bXAsIHUpOyAvLyBGID0gLSBrICogKCB4IC0gTCApIC0gRCAqICggdSApCgogICAgICByX3VuaXQuc2NhbGUoLWsgKiAocmxlbiAtIGwpIC0gZCAqIHUuZG90KHJfdW5pdCksIGYpOyAvLyBBZGQgZm9yY2VzIHRvIGJvZGllcwoKICAgICAgYm9keUEuZm9yY2UudnN1YihmLCBib2R5QS5mb3JjZSk7CiAgICAgIGJvZHlCLmZvcmNlLnZhZGQoZiwgYm9keUIuZm9yY2UpOyAvLyBBbmd1bGFyIGZvcmNlCgogICAgICByaS5jcm9zcyhmLCByaV94X2YpOwogICAgICByai5jcm9zcyhmLCByal94X2YpOwogICAgICBib2R5QS50b3JxdWUudnN1YihyaV94X2YsIGJvZHlBLnRvcnF1ZSk7CiAgICAgIGJvZHlCLnRvcnF1ZS52YWRkKHJqX3hfZiwgYm9keUIudG9ycXVlKTsKICAgIH0KCiAgfQogIGNvbnN0IGFwcGx5Rm9yY2VfciA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYXBwbHlGb3JjZV9yX3VuaXQgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2VfdSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYXBwbHlGb3JjZV9mID0gbmV3IFZlYzMoKTsKICBjb25zdCBhcHBseUZvcmNlX3dvcmxkQW5jaG9yQSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYXBwbHlGb3JjZV93b3JsZEFuY2hvckIgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2VfcmkgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2VfcmogPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2VfcmlfeF9mID0gbmV3IFZlYzMoKTsKICBjb25zdCBhcHBseUZvcmNlX3JqX3hfZiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYXBwbHlGb3JjZV90bXAgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBXaGVlbEluZm8KICAgKi8KICBjbGFzcyBXaGVlbEluZm8gewogICAgLyoqCiAgICAgKiBNYXggdHJhdmVsIGRpc3RhbmNlIG9mIHRoZSBzdXNwZW5zaW9uLCBpbiBtZXRlcnMuCiAgICAgKiBAZGVmYXVsdCAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNwZWVkIHRvIGFwcGx5IHRvIHRoZSB3aGVlbCByb3RhdGlvbiB3aGVuIHRoZSB3aGVlbCBpcyBzbGlkaW5nLgogICAgICogQGRlZmF1bHQgLTAuMQogICAgICovCgogICAgLyoqCiAgICAgKiBJZiB0aGUgY3VzdG9tU2xpZGluZ1JvdGF0aW9uYWxTcGVlZCBzaG91bGQgYmUgdXNlZC4KICAgICAqIEBkZWZhdWx0IGZhbHNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIHNsaWRpbmcKICAgICAqLwoKICAgIC8qKgogICAgICogQ29ubmVjdGlvbiBwb2ludCwgZGVmaW5lZCBsb2NhbGx5IGluIHRoZSBjaGFzc2lzIGJvZHkgZnJhbWUuCiAgICAgKi8KCiAgICAvKioKICAgICAqIGNoYXNzaXNDb25uZWN0aW9uUG9pbnRXb3JsZAogICAgICovCgogICAgLyoqCiAgICAgKiBkaXJlY3Rpb25Mb2NhbAogICAgICovCgogICAgLyoqCiAgICAgKiBkaXJlY3Rpb25Xb3JsZAogICAgICovCgogICAgLyoqCiAgICAgKiBheGxlTG9jYWwKICAgICAqLwoKICAgIC8qKgogICAgICogYXhsZVdvcmxkCiAgICAgKi8KCiAgICAvKioKICAgICAqIHN1c3BlbnNpb25SZXN0TGVuZ3RoCiAgICAgKiBAZGVmYXVsdCAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIHN1c3BlbnNpb25NYXhMZW5ndGgKICAgICAqIEBkZWZhdWx0IDIKICAgICAqLwoKICAgIC8qKgogICAgICogcmFkaXVzCiAgICAgKiBAZGVmYXVsdCAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIHN1c3BlbnNpb25TdGlmZm5lc3MKICAgICAqIEBkZWZhdWx0IDEwMAogICAgICovCgogICAgLyoqCiAgICAgKiBkYW1waW5nQ29tcHJlc3Npb24KICAgICAqIEBkZWZhdWx0IDEwCiAgICAgKi8KCiAgICAvKioKICAgICAqIGRhbXBpbmdSZWxheGF0aW9uCiAgICAgKiBAZGVmYXVsdCAxMAogICAgICovCgogICAgLyoqCiAgICAgKiBmcmljdGlvblNsaXAKICAgICAqIEBkZWZhdWx0IDEwLjUKICAgICAqLwoKICAgIC8qKiBmb3J3YXJkQWNjZWxlcmF0aW9uICovCgogICAgLyoqIHNpZGVBY2NlbGVyYXRpb24gKi8KCiAgICAvKioKICAgICAqIHN0ZWVyaW5nCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIFJvdGF0aW9uIHZhbHVlLCBpbiByYWRpYW5zLgogICAgICogQGRlZmF1bHQgMAogICAgICovCgogICAgLyoqCiAgICAgKiBkZWx0YVJvdGF0aW9uCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIHJvbGxJbmZsdWVuY2UKICAgICAqIEBkZWZhdWx0IDAuMDEKICAgICAqLwoKICAgIC8qKgogICAgICogbWF4U3VzcGVuc2lvbkZvcmNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIGVuZ2luZUZvcmNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIGJyYWtlCiAgICAgKi8KCiAgICAvKioKICAgICAqIGlzRnJvbnRXaGVlbAogICAgICogQGRlZmF1bHQgdHJ1ZQogICAgICovCgogICAgLyoqCiAgICAgKiBjbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24KICAgICAqIEBkZWZhdWx0IDEKICAgICAqLwoKICAgIC8qKgogICAgICogc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHkKICAgICAqIEBkZWZhdWx0IDAKICAgICAqLwoKICAgIC8qKgogICAgICogc3VzcGVuc2lvbkZvcmNlCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIHNsaXBJbmZvCiAgICAgKi8KCiAgICAvKioKICAgICAqIHNraWRJbmZvCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIHN1c3BlbnNpb25MZW5ndGgKICAgICAqIEBkZWZhdWx0IDAKICAgICAqLwoKICAgIC8qKgogICAgICogc2lkZUltcHVsc2UKICAgICAqLwoKICAgIC8qKgogICAgICogZm9yd2FyZEltcHVsc2UKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIHJlc3VsdCBmcm9tIHJheWNhc3RpbmcuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFdoZWVsIHdvcmxkIHRyYW5zZm9ybS4KICAgICAqLwoKICAgIC8qKgogICAgICogaXNJbkNvbnRhY3QKICAgICAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBvcHRpb25zID0gVXRpbHMuZGVmYXVsdHMob3B0aW9ucywgewogICAgICAgIGNoYXNzaXNDb25uZWN0aW9uUG9pbnRMb2NhbDogbmV3IFZlYzMoKSwKICAgICAgICBjaGFzc2lzQ29ubmVjdGlvblBvaW50V29ybGQ6IG5ldyBWZWMzKCksCiAgICAgICAgZGlyZWN0aW9uTG9jYWw6IG5ldyBWZWMzKCksCiAgICAgICAgZGlyZWN0aW9uV29ybGQ6IG5ldyBWZWMzKCksCiAgICAgICAgYXhsZUxvY2FsOiBuZXcgVmVjMygpLAogICAgICAgIGF4bGVXb3JsZDogbmV3IFZlYzMoKSwKICAgICAgICBzdXNwZW5zaW9uUmVzdExlbmd0aDogMSwKICAgICAgICBzdXNwZW5zaW9uTWF4TGVuZ3RoOiAyLAogICAgICAgIHJhZGl1czogMSwKICAgICAgICBzdXNwZW5zaW9uU3RpZmZuZXNzOiAxMDAsCiAgICAgICAgZGFtcGluZ0NvbXByZXNzaW9uOiAxMCwKICAgICAgICBkYW1waW5nUmVsYXhhdGlvbjogMTAsCiAgICAgICAgZnJpY3Rpb25TbGlwOiAxMC41LAogICAgICAgIGZvcndhcmRBY2NlbGVyYXRpb246IDEsCiAgICAgICAgc2lkZUFjY2VsZXJhdGlvbjogMSwKICAgICAgICBzdGVlcmluZzogMCwKICAgICAgICByb3RhdGlvbjogMCwKICAgICAgICBkZWx0YVJvdGF0aW9uOiAwLAogICAgICAgIHJvbGxJbmZsdWVuY2U6IDAuMDEsCiAgICAgICAgbWF4U3VzcGVuc2lvbkZvcmNlOiBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgIGlzRnJvbnRXaGVlbDogdHJ1ZSwKICAgICAgICBjbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb246IDEsCiAgICAgICAgc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHk6IDAsCiAgICAgICAgc3VzcGVuc2lvbkZvcmNlOiAwLAogICAgICAgIHNsaXBJbmZvOiAwLAogICAgICAgIHNraWRJbmZvOiAwLAogICAgICAgIHN1c3BlbnNpb25MZW5ndGg6IDAsCiAgICAgICAgbWF4U3VzcGVuc2lvblRyYXZlbDogMSwKICAgICAgICB1c2VDdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkOiBmYWxzZSwKICAgICAgICBjdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkOiAtMC4xCiAgICAgIH0pOwogICAgICB0aGlzLm1heFN1c3BlbnNpb25UcmF2ZWwgPSBvcHRpb25zLm1heFN1c3BlbnNpb25UcmF2ZWw7CiAgICAgIHRoaXMuY3VzdG9tU2xpZGluZ1JvdGF0aW9uYWxTcGVlZCA9IG9wdGlvbnMuY3VzdG9tU2xpZGluZ1JvdGF0aW9uYWxTcGVlZDsKICAgICAgdGhpcy51c2VDdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkID0gb3B0aW9ucy51c2VDdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkOwogICAgICB0aGlzLnNsaWRpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5jaGFzc2lzQ29ubmVjdGlvblBvaW50TG9jYWwgPSBvcHRpb25zLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRMb2NhbC5jbG9uZSgpOwogICAgICB0aGlzLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRXb3JsZCA9IG9wdGlvbnMuY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludFdvcmxkLmNsb25lKCk7CiAgICAgIHRoaXMuZGlyZWN0aW9uTG9jYWwgPSBvcHRpb25zLmRpcmVjdGlvbkxvY2FsLmNsb25lKCk7CiAgICAgIHRoaXMuZGlyZWN0aW9uV29ybGQgPSBvcHRpb25zLmRpcmVjdGlvbldvcmxkLmNsb25lKCk7CiAgICAgIHRoaXMuYXhsZUxvY2FsID0gb3B0aW9ucy5heGxlTG9jYWwuY2xvbmUoKTsKICAgICAgdGhpcy5heGxlV29ybGQgPSBvcHRpb25zLmF4bGVXb3JsZC5jbG9uZSgpOwogICAgICB0aGlzLnN1c3BlbnNpb25SZXN0TGVuZ3RoID0gb3B0aW9ucy5zdXNwZW5zaW9uUmVzdExlbmd0aDsKICAgICAgdGhpcy5zdXNwZW5zaW9uTWF4TGVuZ3RoID0gb3B0aW9ucy5zdXNwZW5zaW9uTWF4TGVuZ3RoOwogICAgICB0aGlzLnJhZGl1cyA9IG9wdGlvbnMucmFkaXVzOwogICAgICB0aGlzLnN1c3BlbnNpb25TdGlmZm5lc3MgPSBvcHRpb25zLnN1c3BlbnNpb25TdGlmZm5lc3M7CiAgICAgIHRoaXMuZGFtcGluZ0NvbXByZXNzaW9uID0gb3B0aW9ucy5kYW1waW5nQ29tcHJlc3Npb247CiAgICAgIHRoaXMuZGFtcGluZ1JlbGF4YXRpb24gPSBvcHRpb25zLmRhbXBpbmdSZWxheGF0aW9uOwogICAgICB0aGlzLmZyaWN0aW9uU2xpcCA9IG9wdGlvbnMuZnJpY3Rpb25TbGlwOwogICAgICB0aGlzLmZvcndhcmRBY2NlbGVyYXRpb24gPSBvcHRpb25zLmZvcndhcmRBY2NlbGVyYXRpb247CiAgICAgIHRoaXMuc2lkZUFjY2VsZXJhdGlvbiA9IG9wdGlvbnMuc2lkZUFjY2VsZXJhdGlvbjsKICAgICAgdGhpcy5zdGVlcmluZyA9IDA7CiAgICAgIHRoaXMucm90YXRpb24gPSAwOwogICAgICB0aGlzLmRlbHRhUm90YXRpb24gPSAwOwogICAgICB0aGlzLnJvbGxJbmZsdWVuY2UgPSBvcHRpb25zLnJvbGxJbmZsdWVuY2U7CiAgICAgIHRoaXMubWF4U3VzcGVuc2lvbkZvcmNlID0gb3B0aW9ucy5tYXhTdXNwZW5zaW9uRm9yY2U7CiAgICAgIHRoaXMuZW5naW5lRm9yY2UgPSAwOwogICAgICB0aGlzLmJyYWtlID0gMDsKICAgICAgdGhpcy5pc0Zyb250V2hlZWwgPSBvcHRpb25zLmlzRnJvbnRXaGVlbDsKICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxOwogICAgICB0aGlzLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5ID0gMDsKICAgICAgdGhpcy5zdXNwZW5zaW9uRm9yY2UgPSAwOwogICAgICB0aGlzLnNsaXBJbmZvID0gMDsKICAgICAgdGhpcy5za2lkSW5mbyA9IDA7CiAgICAgIHRoaXMuc3VzcGVuc2lvbkxlbmd0aCA9IDA7CiAgICAgIHRoaXMuc2lkZUltcHVsc2UgPSAwOwogICAgICB0aGlzLmZvcndhcmRJbXB1bHNlID0gMDsKICAgICAgdGhpcy5yYXljYXN0UmVzdWx0ID0gbmV3IFJheWNhc3RSZXN1bHQoKTsKICAgICAgdGhpcy53b3JsZFRyYW5zZm9ybSA9IG5ldyBUcmFuc2Zvcm0oKTsKICAgICAgdGhpcy5pc0luQ29udGFjdCA9IGZhbHNlOwogICAgfQoKICAgIHVwZGF0ZVdoZWVsKGNoYXNzaXMpIHsKICAgICAgY29uc3QgcmF5Y2FzdFJlc3VsdCA9IHRoaXMucmF5Y2FzdFJlc3VsdDsKCiAgICAgIGlmICh0aGlzLmlzSW5Db250YWN0KSB7CiAgICAgICAgY29uc3QgcHJvamVjdCA9IHJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQuZG90KHJheWNhc3RSZXN1bHQuZGlyZWN0aW9uV29ybGQpOwogICAgICAgIHJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZC52c3ViKGNoYXNzaXMucG9zaXRpb24sIHJlbHBvcyk7CiAgICAgICAgY2hhc3Npcy5nZXRWZWxvY2l0eUF0V29ybGRQb2ludChyZWxwb3MsIGNoYXNzaXNfdmVsb2NpdHlfYXRfY29udGFjdFBvaW50KTsKICAgICAgICBjb25zdCBwcm9qVmVsID0gcmF5Y2FzdFJlc3VsdC5oaXROb3JtYWxXb3JsZC5kb3QoY2hhc3Npc192ZWxvY2l0eV9hdF9jb250YWN0UG9pbnQpOwoKICAgICAgICBpZiAocHJvamVjdCA+PSAtMC4xKSB7CiAgICAgICAgICB0aGlzLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5ID0gMC4wOwogICAgICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxLjAgLyAwLjE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGludiA9IC0xIC8gcHJvamVjdDsKICAgICAgICAgIHRoaXMuc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHkgPSBwcm9qVmVsICogaW52OwogICAgICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSBpbnY7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIE5vdCBpbiBjb250YWN0IDogcG9zaXRpb24gd2hlZWwgaW4gYSBuaWNlIChyZXN0IGxlbmd0aCkgcG9zaXRpb24KICAgICAgICByYXljYXN0UmVzdWx0LnN1c3BlbnNpb25MZW5ndGggPSB0aGlzLnN1c3BlbnNpb25SZXN0TGVuZ3RoOwogICAgICAgIHRoaXMuc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHkgPSAwLjA7CiAgICAgICAgcmF5Y2FzdFJlc3VsdC5kaXJlY3Rpb25Xb3JsZC5zY2FsZSgtMSwgcmF5Y2FzdFJlc3VsdC5oaXROb3JtYWxXb3JsZCk7CiAgICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxLjA7CiAgICAgIH0KICAgIH0KCiAgfQogIGNvbnN0IGNoYXNzaXNfdmVsb2NpdHlfYXRfY29udGFjdFBvaW50ID0gbmV3IFZlYzMoKTsKICBjb25zdCByZWxwb3MgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBWZWhpY2xlIGhlbHBlciBjbGFzcyB0aGF0IGNhc3RzIHJheXMgZnJvbSB0aGUgd2hlZWwgcG9zaXRpb25zIHRvd2FyZHMgdGhlIGdyb3VuZCBhbmQgYXBwbGllcyBmb3JjZXMuCiAgICovCiAgY2xhc3MgUmF5Y2FzdFZlaGljbGUgewogICAgLyoqIFRoZSBjYXIgY2hhc3NpcyBib2R5LiAqLwoKICAgIC8qKiBUaGUgd2hlZWxzLiAqLwoKICAgIC8qKiBXaWxsIGJlIHNldCB0byB0cnVlIGlmIHRoZSBjYXIgaXMgc2xpZGluZy4gKi8KCiAgICAvKiogSW5kZXggb2YgdGhlIHJpZ2h0IGF4aXMuIHg9MCwgeT0xLCB6PTIgKi8KCiAgICAvKiogSW5kZXggb2YgdGhlIGZvcndhcmQgYXhpcy4geD0wLCB5PTEsIHo9MiAqLwoKICAgIC8qKiBJbmRleCBvZiB0aGUgdXAgYXhpcy4geD0wLCB5PTEsIHo9MiAqLwoKICAgIC8qKiBUaGUgY29uc3RyYWludHMuICovCgogICAgLyoqIE9wdGlvbmFsIHByZS1zdGVwIGNhbGxiYWNrLiAqLwoKICAgIC8qKiBOdW1iZXIgb2Ygd2hlZWxzIG9uIHRoZSBncm91bmQuICovCiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICAgIHRoaXMuY2hhc3Npc0JvZHkgPSBvcHRpb25zLmNoYXNzaXNCb2R5OwogICAgICB0aGlzLndoZWVsSW5mb3MgPSBbXTsKICAgICAgdGhpcy5zbGlkaW5nID0gZmFsc2U7CiAgICAgIHRoaXMud29ybGQgPSBudWxsOwogICAgICB0aGlzLmluZGV4UmlnaHRBeGlzID0gdHlwZW9mIG9wdGlvbnMuaW5kZXhSaWdodEF4aXMgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5pbmRleFJpZ2h0QXhpcyA6IDI7CiAgICAgIHRoaXMuaW5kZXhGb3J3YXJkQXhpcyA9IHR5cGVvZiBvcHRpb25zLmluZGV4Rm9yd2FyZEF4aXMgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5pbmRleEZvcndhcmRBeGlzIDogMDsKICAgICAgdGhpcy5pbmRleFVwQXhpcyA9IHR5cGVvZiBvcHRpb25zLmluZGV4VXBBeGlzICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuaW5kZXhVcEF4aXMgOiAxOwogICAgICB0aGlzLmNvbnN0cmFpbnRzID0gW107CgogICAgICB0aGlzLnByZVN0ZXBDYWxsYmFjayA9ICgpID0+IHt9OwoKICAgICAgdGhpcy5jdXJyZW50VmVoaWNsZVNwZWVkS21Ib3VyID0gMDsKICAgICAgdGhpcy5udW1XaGVlbHNPbkdyb3VuZCA9IDA7CiAgICB9CiAgICAvKioKICAgICAqIEFkZCBhIHdoZWVsLiBGb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIG9wdGlvbnMsIHNlZSBgV2hlZWxJbmZvYC4KICAgICAqLwoKCiAgICBhZGRXaGVlbChvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIGNvbnN0IGluZm8gPSBuZXcgV2hlZWxJbmZvKG9wdGlvbnMpOwogICAgICBjb25zdCBpbmRleCA9IHRoaXMud2hlZWxJbmZvcy5sZW5ndGg7CiAgICAgIHRoaXMud2hlZWxJbmZvcy5wdXNoKGluZm8pOwogICAgICByZXR1cm4gaW5kZXg7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgc3RlZXJpbmcgdmFsdWUgb2YgYSB3aGVlbC4KICAgICAqLwoKCiAgICBzZXRTdGVlcmluZ1ZhbHVlKHZhbHVlLCB3aGVlbEluZGV4KSB7CiAgICAgIGNvbnN0IHdoZWVsID0gdGhpcy53aGVlbEluZm9zW3doZWVsSW5kZXhdOwogICAgICB3aGVlbC5zdGVlcmluZyA9IHZhbHVlOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHdoZWVsIGZvcmNlIHRvIGFwcGx5IG9uIG9uZSBvZiB0aGUgd2hlZWxzIGVhY2ggdGltZSBzdGVwCiAgICAgKi8KCgogICAgYXBwbHlFbmdpbmVGb3JjZSh2YWx1ZSwgd2hlZWxJbmRleCkgewogICAgICB0aGlzLndoZWVsSW5mb3Nbd2hlZWxJbmRleF0uZW5naW5lRm9yY2UgPSB2YWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBicmFraW5nIGZvcmNlIG9mIGEgd2hlZWwKICAgICAqLwoKCiAgICBzZXRCcmFrZShicmFrZSwgd2hlZWxJbmRleCkgewogICAgICB0aGlzLndoZWVsSW5mb3Nbd2hlZWxJbmRleF0uYnJha2UgPSBicmFrZTsKICAgIH0KICAgIC8qKgogICAgICogQWRkIHRoZSB2ZWhpY2xlIGluY2x1ZGluZyBpdHMgY29uc3RyYWludHMgdG8gdGhlIHdvcmxkLgogICAgICovCgoKICAgIGFkZFRvV29ybGQod29ybGQpIHsKICAgICAgd29ybGQuYWRkQm9keSh0aGlzLmNoYXNzaXNCb2R5KTsKICAgICAgY29uc3QgdGhhdCA9IHRoaXM7CgogICAgICB0aGlzLnByZVN0ZXBDYWxsYmFjayA9ICgpID0+IHsKICAgICAgICB0aGF0LnVwZGF0ZVZlaGljbGUod29ybGQuZHQpOwogICAgICB9OwoKICAgICAgd29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncHJlU3RlcCcsIHRoaXMucHJlU3RlcENhbGxiYWNrKTsKICAgICAgdGhpcy53b3JsZCA9IHdvcmxkOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgb25lIG9mIHRoZSB3aGVlbCBheGxlcywgd29ybGQtb3JpZW50ZWQuCiAgICAgKi8KCgogICAgZ2V0VmVoaWNsZUF4aXNXb3JsZChheGlzSW5kZXgsIHJlc3VsdCkgewogICAgICByZXN1bHQuc2V0KGF4aXNJbmRleCA9PT0gMCA/IDEgOiAwLCBheGlzSW5kZXggPT09IDEgPyAxIDogMCwgYXhpc0luZGV4ID09PSAyID8gMSA6IDApOwogICAgICB0aGlzLmNoYXNzaXNCb2R5LnZlY3RvclRvV29ybGRGcmFtZShyZXN1bHQsIHJlc3VsdCk7CiAgICB9CgogICAgdXBkYXRlVmVoaWNsZSh0aW1lU3RlcCkgewogICAgICBjb25zdCB3aGVlbEluZm9zID0gdGhpcy53aGVlbEluZm9zOwogICAgICBjb25zdCBudW1XaGVlbHMgPSB3aGVlbEluZm9zLmxlbmd0aDsKICAgICAgY29uc3QgY2hhc3Npc0JvZHkgPSB0aGlzLmNoYXNzaXNCb2R5OwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1XaGVlbHM7IGkrKykgewogICAgICAgIHRoaXMudXBkYXRlV2hlZWxUcmFuc2Zvcm0oaSk7CiAgICAgIH0KCiAgICAgIHRoaXMuY3VycmVudFZlaGljbGVTcGVlZEttSG91ciA9IDMuNiAqIGNoYXNzaXNCb2R5LnZlbG9jaXR5Lmxlbmd0aCgpOwogICAgICBjb25zdCBmb3J3YXJkV29ybGQgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmdldFZlaGljbGVBeGlzV29ybGQodGhpcy5pbmRleEZvcndhcmRBeGlzLCBmb3J3YXJkV29ybGQpOwoKICAgICAgaWYgKGZvcndhcmRXb3JsZC5kb3QoY2hhc3Npc0JvZHkudmVsb2NpdHkpIDwgMCkgewogICAgICAgIHRoaXMuY3VycmVudFZlaGljbGVTcGVlZEttSG91ciAqPSAtMTsKICAgICAgfSAvLyBzaW11bGF0ZSBzdXNwZW5zaW9uCgoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1XaGVlbHM7IGkrKykgewogICAgICAgIHRoaXMuY2FzdFJheSh3aGVlbEluZm9zW2ldKTsKICAgICAgfQoKICAgICAgdGhpcy51cGRhdGVTdXNwZW5zaW9uKHRpbWVTdGVwKTsKICAgICAgY29uc3QgaW1wdWxzZSA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHJlbHBvcyA9IG5ldyBWZWMzKCk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVdoZWVsczsgaSsrKSB7CiAgICAgICAgLy9hcHBseSBzdXNwZW5zaW9uIGZvcmNlCiAgICAgICAgY29uc3Qgd2hlZWwgPSB3aGVlbEluZm9zW2ldOwogICAgICAgIGxldCBzdXNwZW5zaW9uRm9yY2UgPSB3aGVlbC5zdXNwZW5zaW9uRm9yY2U7CgogICAgICAgIGlmIChzdXNwZW5zaW9uRm9yY2UgPiB3aGVlbC5tYXhTdXNwZW5zaW9uRm9yY2UpIHsKICAgICAgICAgIHN1c3BlbnNpb25Gb3JjZSA9IHdoZWVsLm1heFN1c3BlbnNpb25Gb3JjZTsKICAgICAgICB9CgogICAgICAgIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQuc2NhbGUoc3VzcGVuc2lvbkZvcmNlICogdGltZVN0ZXAsIGltcHVsc2UpOwogICAgICAgIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZC52c3ViKGNoYXNzaXNCb2R5LnBvc2l0aW9uLCByZWxwb3MpOwogICAgICAgIGNoYXNzaXNCb2R5LmFwcGx5SW1wdWxzZShpbXB1bHNlLCByZWxwb3MpOwogICAgICB9CgogICAgICB0aGlzLnVwZGF0ZUZyaWN0aW9uKHRpbWVTdGVwKTsKICAgICAgY29uc3QgaGl0Tm9ybWFsV29ybGRTY2FsZWRXaXRoUHJvaiA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGZ3ZCA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHZlbCA9IG5ldyBWZWMzKCk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVdoZWVsczsgaSsrKSB7CiAgICAgICAgY29uc3Qgd2hlZWwgPSB3aGVlbEluZm9zW2ldOyAvL2NvbnN0IHJlbHBvcyA9IG5ldyBWZWMzKCk7CiAgICAgICAgLy93aGVlbC5jaGFzc2lzQ29ubmVjdGlvblBvaW50V29ybGQudnN1YihjaGFzc2lzQm9keS5wb3NpdGlvbiwgcmVscG9zKTsKCiAgICAgICAgY2hhc3Npc0JvZHkuZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQod2hlZWwuY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludFdvcmxkLCB2ZWwpOyAvLyBIYWNrIHRvIGdldCB0aGUgcm90YXRpb24gaW4gdGhlIGNvcnJlY3QgZGlyZWN0aW9uCgogICAgICAgIGxldCBtID0gMTsKCiAgICAgICAgc3dpdGNoICh0aGlzLmluZGV4VXBBeGlzKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIG0gPSAtMTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBpZiAod2hlZWwuaXNJbkNvbnRhY3QpIHsKICAgICAgICAgIHRoaXMuZ2V0VmVoaWNsZUF4aXNXb3JsZCh0aGlzLmluZGV4Rm9yd2FyZEF4aXMsIGZ3ZCk7CiAgICAgICAgICBjb25zdCBwcm9qID0gZndkLmRvdCh3aGVlbC5yYXljYXN0UmVzdWx0LmhpdE5vcm1hbFdvcmxkKTsKICAgICAgICAgIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQuc2NhbGUocHJvaiwgaGl0Tm9ybWFsV29ybGRTY2FsZWRXaXRoUHJvaik7CiAgICAgICAgICBmd2QudnN1YihoaXROb3JtYWxXb3JsZFNjYWxlZFdpdGhQcm9qLCBmd2QpOwogICAgICAgICAgY29uc3QgcHJvajIgPSBmd2QuZG90KHZlbCk7CiAgICAgICAgICB3aGVlbC5kZWx0YVJvdGF0aW9uID0gbSAqIHByb2oyICogdGltZVN0ZXAgLyB3aGVlbC5yYWRpdXM7CiAgICAgICAgfQoKICAgICAgICBpZiAoKHdoZWVsLnNsaWRpbmcgfHwgIXdoZWVsLmlzSW5Db250YWN0KSAmJiB3aGVlbC5lbmdpbmVGb3JjZSAhPT0gMCAmJiB3aGVlbC51c2VDdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkKSB7CiAgICAgICAgICAvLyBBcHBseSBjdXN0b20gcm90YXRpb24gd2hlbiBhY2NlbGVyYXRpbmcgYW5kIHNsaWRpbmcKICAgICAgICAgIHdoZWVsLmRlbHRhUm90YXRpb24gPSAod2hlZWwuZW5naW5lRm9yY2UgPiAwID8gMSA6IC0xKSAqIHdoZWVsLmN1c3RvbVNsaWRpbmdSb3RhdGlvbmFsU3BlZWQgKiB0aW1lU3RlcDsKICAgICAgICB9IC8vIExvY2sgd2hlZWxzCgoKICAgICAgICBpZiAoTWF0aC5hYnMod2hlZWwuYnJha2UpID4gTWF0aC5hYnMod2hlZWwuZW5naW5lRm9yY2UpKSB7CiAgICAgICAgICB3aGVlbC5kZWx0YVJvdGF0aW9uID0gMDsKICAgICAgICB9CgogICAgICAgIHdoZWVsLnJvdGF0aW9uICs9IHdoZWVsLmRlbHRhUm90YXRpb247IC8vIFVzZSB0aGUgb2xkIHZhbHVlCgogICAgICAgIHdoZWVsLmRlbHRhUm90YXRpb24gKj0gMC45OTsgLy8gZGFtcGluZyBvZiByb3RhdGlvbiB3aGVuIG5vdCBpbiBjb250YWN0CiAgICAgIH0KICAgIH0KCiAgICB1cGRhdGVTdXNwZW5zaW9uKGRlbHRhVGltZSkgewogICAgICBjb25zdCBjaGFzc2lzQm9keSA9IHRoaXMuY2hhc3Npc0JvZHk7CiAgICAgIGNvbnN0IGNoYXNzaXNNYXNzID0gY2hhc3Npc0JvZHkubWFzczsKICAgICAgY29uc3Qgd2hlZWxJbmZvcyA9IHRoaXMud2hlZWxJbmZvczsKICAgICAgY29uc3QgbnVtV2hlZWxzID0gd2hlZWxJbmZvcy5sZW5ndGg7CgogICAgICBmb3IgKGxldCB3X2l0ID0gMDsgd19pdCA8IG51bVdoZWVsczsgd19pdCsrKSB7CiAgICAgICAgY29uc3Qgd2hlZWwgPSB3aGVlbEluZm9zW3dfaXRdOwoKICAgICAgICBpZiAod2hlZWwuaXNJbkNvbnRhY3QpIHsKICAgICAgICAgIGxldCBmb3JjZTsgLy8gU3ByaW5nCgogICAgICAgICAgY29uc3Qgc3VzcF9sZW5ndGggPSB3aGVlbC5zdXNwZW5zaW9uUmVzdExlbmd0aDsKICAgICAgICAgIGNvbnN0IGN1cnJlbnRfbGVuZ3RoID0gd2hlZWwuc3VzcGVuc2lvbkxlbmd0aDsKICAgICAgICAgIGNvbnN0IGxlbmd0aF9kaWZmID0gc3VzcF9sZW5ndGggLSBjdXJyZW50X2xlbmd0aDsKICAgICAgICAgIGZvcmNlID0gd2hlZWwuc3VzcGVuc2lvblN0aWZmbmVzcyAqIGxlbmd0aF9kaWZmICogd2hlZWwuY2xpcHBlZEludkNvbnRhY3REb3RTdXNwZW5zaW9uOyAvLyBEYW1wZXIKCiAgICAgICAgICBjb25zdCBwcm9qZWN0ZWRfcmVsX3ZlbCA9IHdoZWVsLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5OwogICAgICAgICAgbGV0IHN1c3BfZGFtcGluZzsKCiAgICAgICAgICBpZiAocHJvamVjdGVkX3JlbF92ZWwgPCAwKSB7CiAgICAgICAgICAgIHN1c3BfZGFtcGluZyA9IHdoZWVsLmRhbXBpbmdDb21wcmVzc2lvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1c3BfZGFtcGluZyA9IHdoZWVsLmRhbXBpbmdSZWxheGF0aW9uOwogICAgICAgICAgfQoKICAgICAgICAgIGZvcmNlIC09IHN1c3BfZGFtcGluZyAqIHByb2plY3RlZF9yZWxfdmVsOwogICAgICAgICAgd2hlZWwuc3VzcGVuc2lvbkZvcmNlID0gZm9yY2UgKiBjaGFzc2lzTWFzczsKCiAgICAgICAgICBpZiAod2hlZWwuc3VzcGVuc2lvbkZvcmNlIDwgMCkgewogICAgICAgICAgICB3aGVlbC5zdXNwZW5zaW9uRm9yY2UgPSAwOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3aGVlbC5zdXNwZW5zaW9uRm9yY2UgPSAwOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmUgdGhlIHZlaGljbGUgaW5jbHVkaW5nIGl0cyBjb25zdHJhaW50cyBmcm9tIHRoZSB3b3JsZC4KICAgICAqLwoKCiAgICByZW1vdmVGcm9tV29ybGQod29ybGQpIHsKICAgICAgdGhpcy5jb25zdHJhaW50czsKICAgICAgd29ybGQucmVtb3ZlQm9keSh0aGlzLmNoYXNzaXNCb2R5KTsKICAgICAgd29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncHJlU3RlcCcsIHRoaXMucHJlU3RlcENhbGxiYWNrKTsKICAgICAgdGhpcy53b3JsZCA9IG51bGw7CiAgICB9CgogICAgY2FzdFJheSh3aGVlbCkgewogICAgICBjb25zdCByYXl2ZWN0b3IgPSBjYXN0UmF5X3JheXZlY3RvcjsKICAgICAgY29uc3QgdGFyZ2V0ID0gY2FzdFJheV90YXJnZXQ7CiAgICAgIHRoaXMudXBkYXRlV2hlZWxUcmFuc2Zvcm1Xb3JsZCh3aGVlbCk7CiAgICAgIGNvbnN0IGNoYXNzaXNCb2R5ID0gdGhpcy5jaGFzc2lzQm9keTsKICAgICAgbGV0IGRlcHRoID0gLTE7CiAgICAgIGNvbnN0IHJheWxlbiA9IHdoZWVsLnN1c3BlbnNpb25SZXN0TGVuZ3RoICsgd2hlZWwucmFkaXVzOwogICAgICB3aGVlbC5kaXJlY3Rpb25Xb3JsZC5zY2FsZShyYXlsZW4sIHJheXZlY3Rvcik7CiAgICAgIGNvbnN0IHNvdXJjZSA9IHdoZWVsLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRXb3JsZDsKICAgICAgc291cmNlLnZhZGQocmF5dmVjdG9yLCB0YXJnZXQpOwogICAgICBjb25zdCByYXljYXN0UmVzdWx0ID0gd2hlZWwucmF5Y2FzdFJlc3VsdDsKICAgICAgcmF5Y2FzdFJlc3VsdC5yZXNldCgpOyAvLyBUdXJuIG9mZiByYXkgY29sbGlzaW9uIHdpdGggdGhlIGNoYXNzaXMgdGVtcG9yYXJpbHkKCiAgICAgIGNvbnN0IG9sZFN0YXRlID0gY2hhc3Npc0JvZHkuY29sbGlzaW9uUmVzcG9uc2U7CiAgICAgIGNoYXNzaXNCb2R5LmNvbGxpc2lvblJlc3BvbnNlID0gZmFsc2U7IC8vIENhc3QgcmF5IGFnYWluc3Qgd29ybGQKCiAgICAgIHRoaXMud29ybGQucmF5VGVzdChzb3VyY2UsIHRhcmdldCwgcmF5Y2FzdFJlc3VsdCk7CiAgICAgIGNoYXNzaXNCb2R5LmNvbGxpc2lvblJlc3BvbnNlID0gb2xkU3RhdGU7CiAgICAgIGNvbnN0IG9iamVjdCA9IHJheWNhc3RSZXN1bHQuYm9keTsKICAgICAgd2hlZWwucmF5Y2FzdFJlc3VsdC5ncm91bmRPYmplY3QgPSAwOwoKICAgICAgaWYgKG9iamVjdCkgewogICAgICAgIGRlcHRoID0gcmF5Y2FzdFJlc3VsdC5kaXN0YW5jZTsKICAgICAgICB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdE5vcm1hbFdvcmxkID0gcmF5Y2FzdFJlc3VsdC5oaXROb3JtYWxXb3JsZDsKICAgICAgICB3aGVlbC5pc0luQ29udGFjdCA9IHRydWU7CiAgICAgICAgY29uc3QgaGl0RGlzdGFuY2UgPSByYXljYXN0UmVzdWx0LmRpc3RhbmNlOwogICAgICAgIHdoZWVsLnN1c3BlbnNpb25MZW5ndGggPSBoaXREaXN0YW5jZSAtIHdoZWVsLnJhZGl1czsgLy8gY2xhbXAgb24gbWF4IHN1c3BlbnNpb24gdHJhdmVsCgogICAgICAgIGNvbnN0IG1pblN1c3BlbnNpb25MZW5ndGggPSB3aGVlbC5zdXNwZW5zaW9uUmVzdExlbmd0aCAtIHdoZWVsLm1heFN1c3BlbnNpb25UcmF2ZWw7CiAgICAgICAgY29uc3QgbWF4U3VzcGVuc2lvbkxlbmd0aCA9IHdoZWVsLnN1c3BlbnNpb25SZXN0TGVuZ3RoICsgd2hlZWwubWF4U3VzcGVuc2lvblRyYXZlbDsKCiAgICAgICAgaWYgKHdoZWVsLnN1c3BlbnNpb25MZW5ndGggPCBtaW5TdXNwZW5zaW9uTGVuZ3RoKSB7CiAgICAgICAgICB3aGVlbC5zdXNwZW5zaW9uTGVuZ3RoID0gbWluU3VzcGVuc2lvbkxlbmd0aDsKICAgICAgICB9CgogICAgICAgIGlmICh3aGVlbC5zdXNwZW5zaW9uTGVuZ3RoID4gbWF4U3VzcGVuc2lvbkxlbmd0aCkgewogICAgICAgICAgd2hlZWwuc3VzcGVuc2lvbkxlbmd0aCA9IG1heFN1c3BlbnNpb25MZW5ndGg7CiAgICAgICAgICB3aGVlbC5yYXljYXN0UmVzdWx0LnJlc2V0KCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBkZW5vbWluYXRvciA9IHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQuZG90KHdoZWVsLmRpcmVjdGlvbldvcmxkKTsKICAgICAgICBjb25zdCBjaGFzc2lzX3ZlbG9jaXR5X2F0X2NvbnRhY3RQb2ludCA9IG5ldyBWZWMzKCk7CiAgICAgICAgY2hhc3Npc0JvZHkuZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQod2hlZWwucmF5Y2FzdFJlc3VsdC5oaXRQb2ludFdvcmxkLCBjaGFzc2lzX3ZlbG9jaXR5X2F0X2NvbnRhY3RQb2ludCk7CiAgICAgICAgY29uc3QgcHJvalZlbCA9IHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQuZG90KGNoYXNzaXNfdmVsb2NpdHlfYXRfY29udGFjdFBvaW50KTsKCiAgICAgICAgaWYgKGRlbm9taW5hdG9yID49IC0wLjEpIHsKICAgICAgICAgIHdoZWVsLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5ID0gMDsKICAgICAgICAgIHdoZWVsLmNsaXBwZWRJbnZDb250YWN0RG90U3VzcGVuc2lvbiA9IDEgLyAwLjE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGludiA9IC0xIC8gZGVub21pbmF0b3I7CiAgICAgICAgICB3aGVlbC5zdXNwZW5zaW9uUmVsYXRpdmVWZWxvY2l0eSA9IHByb2pWZWwgKiBpbnY7CiAgICAgICAgICB3aGVlbC5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSBpbnY7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vcHV0IHdoZWVsIGluZm8gYXMgaW4gcmVzdCBwb3NpdGlvbgogICAgICAgIHdoZWVsLnN1c3BlbnNpb25MZW5ndGggPSB3aGVlbC5zdXNwZW5zaW9uUmVzdExlbmd0aCArIDAgKiB3aGVlbC5tYXhTdXNwZW5zaW9uVHJhdmVsOwogICAgICAgIHdoZWVsLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5ID0gMC4wOwogICAgICAgIHdoZWVsLmRpcmVjdGlvbldvcmxkLnNjYWxlKC0xLCB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdE5vcm1hbFdvcmxkKTsKICAgICAgICB3aGVlbC5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxLjA7CiAgICAgIH0KCiAgICAgIHJldHVybiBkZXB0aDsKICAgIH0KCiAgICB1cGRhdGVXaGVlbFRyYW5zZm9ybVdvcmxkKHdoZWVsKSB7CiAgICAgIHdoZWVsLmlzSW5Db250YWN0ID0gZmFsc2U7CiAgICAgIGNvbnN0IGNoYXNzaXNCb2R5ID0gdGhpcy5jaGFzc2lzQm9keTsKICAgICAgY2hhc3Npc0JvZHkucG9pbnRUb1dvcmxkRnJhbWUod2hlZWwuY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludExvY2FsLCB3aGVlbC5jaGFzc2lzQ29ubmVjdGlvblBvaW50V29ybGQpOwogICAgICBjaGFzc2lzQm9keS52ZWN0b3JUb1dvcmxkRnJhbWUod2hlZWwuZGlyZWN0aW9uTG9jYWwsIHdoZWVsLmRpcmVjdGlvbldvcmxkKTsKICAgICAgY2hhc3Npc0JvZHkudmVjdG9yVG9Xb3JsZEZyYW1lKHdoZWVsLmF4bGVMb2NhbCwgd2hlZWwuYXhsZVdvcmxkKTsKICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlIG9uZSBvZiB0aGUgd2hlZWwgdHJhbnNmb3JtLgogICAgICogTm90ZSB3aGVuIHJlbmRlcmluZyB3aGVlbHM6IGR1cmluZyBlYWNoIHN0ZXAsIHdoZWVsIHRyYW5zZm9ybXMgYXJlIHVwZGF0ZWQgQkVGT1JFIHRoZSBjaGFzc2lzOyBpZS4gdGhlaXIgcG9zaXRpb24gYmVjb21lcyBpbnZhbGlkIGFmdGVyIHRoZSBzdGVwLiBUaHVzIHdoZW4geW91IHJlbmRlciB3aGVlbHMsIHlvdSBtdXN0IHVwZGF0ZSB3aGVlbCB0cmFuc2Zvcm1zIGJlZm9yZSByZW5kZXJpbmcgdGhlbS4gU2VlIHJheWNhc3RWZWhpY2xlIGRlbW8gZm9yIGFuIGV4YW1wbGUuCiAgICAgKiBAcGFyYW0gd2hlZWxJbmRleCBUaGUgd2hlZWwgaW5kZXggdG8gdXBkYXRlLgogICAgICovCgoKICAgIHVwZGF0ZVdoZWVsVHJhbnNmb3JtKHdoZWVsSW5kZXgpIHsKICAgICAgY29uc3QgdXAgPSB0bXBWZWM0OwogICAgICBjb25zdCByaWdodCA9IHRtcFZlYzU7CiAgICAgIGNvbnN0IGZ3ZCA9IHRtcFZlYzY7CiAgICAgIGNvbnN0IHdoZWVsID0gdGhpcy53aGVlbEluZm9zW3doZWVsSW5kZXhdOwogICAgICB0aGlzLnVwZGF0ZVdoZWVsVHJhbnNmb3JtV29ybGQod2hlZWwpOwogICAgICB3aGVlbC5kaXJlY3Rpb25Mb2NhbC5zY2FsZSgtMSwgdXApOwogICAgICByaWdodC5jb3B5KHdoZWVsLmF4bGVMb2NhbCk7CiAgICAgIHVwLmNyb3NzKHJpZ2h0LCBmd2QpOwogICAgICBmd2Qubm9ybWFsaXplKCk7CiAgICAgIHJpZ2h0Lm5vcm1hbGl6ZSgpOyAvLyBSb3RhdGUgYXJvdW5kIHN0ZWVyaW5nIG92ZXIgdGhlIHdoZWVsQXhsZQoKICAgICAgY29uc3Qgc3RlZXJpbmcgPSB3aGVlbC5zdGVlcmluZzsKICAgICAgY29uc3Qgc3RlZXJpbmdPcm4gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzdGVlcmluZ09ybi5zZXRGcm9tQXhpc0FuZ2xlKHVwLCBzdGVlcmluZyk7CiAgICAgIGNvbnN0IHJvdGF0aW5nT3JuID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgcm90YXRpbmdPcm4uc2V0RnJvbUF4aXNBbmdsZShyaWdodCwgd2hlZWwucm90YXRpb24pOyAvLyBXb3JsZCByb3RhdGlvbiBvZiB0aGUgd2hlZWwKCiAgICAgIGNvbnN0IHEgPSB3aGVlbC53b3JsZFRyYW5zZm9ybS5xdWF0ZXJuaW9uOwogICAgICB0aGlzLmNoYXNzaXNCb2R5LnF1YXRlcm5pb24ubXVsdChzdGVlcmluZ09ybiwgcSk7CiAgICAgIHEubXVsdChyb3RhdGluZ09ybiwgcSk7CiAgICAgIHEubm9ybWFsaXplKCk7IC8vIHdvcmxkIHBvc2l0aW9uIG9mIHRoZSB3aGVlbAoKICAgICAgY29uc3QgcCA9IHdoZWVsLndvcmxkVHJhbnNmb3JtLnBvc2l0aW9uOwogICAgICBwLmNvcHkod2hlZWwuZGlyZWN0aW9uV29ybGQpOwogICAgICBwLnNjYWxlKHdoZWVsLnN1c3BlbnNpb25MZW5ndGgsIHApOwogICAgICBwLnZhZGQod2hlZWwuY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludFdvcmxkLCBwKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSB3b3JsZCB0cmFuc2Zvcm0gb2Ygb25lIG9mIHRoZSB3aGVlbHMKICAgICAqLwoKCiAgICBnZXRXaGVlbFRyYW5zZm9ybVdvcmxkKHdoZWVsSW5kZXgpIHsKICAgICAgcmV0dXJuIHRoaXMud2hlZWxJbmZvc1t3aGVlbEluZGV4XS53b3JsZFRyYW5zZm9ybTsKICAgIH0KCiAgICB1cGRhdGVGcmljdGlvbih0aW1lU3RlcCkgewogICAgICBjb25zdCBzdXJmTm9ybWFsV1Nfc2NhbGVkX3Byb2ogPSB1cGRhdGVGcmljdGlvbl9zdXJmTm9ybWFsV1Nfc2NhbGVkX3Byb2o7IC8vY2FsY3VsYXRlIHRoZSBpbXB1bHNlLCBzbyB0aGF0IHRoZSB3aGVlbHMgZG9uJ3QgbW92ZSBzaWRld2FyZHMKCiAgICAgIGNvbnN0IHdoZWVsSW5mb3MgPSB0aGlzLndoZWVsSW5mb3M7CiAgICAgIGNvbnN0IG51bVdoZWVscyA9IHdoZWVsSW5mb3MubGVuZ3RoOwogICAgICBjb25zdCBjaGFzc2lzQm9keSA9IHRoaXMuY2hhc3Npc0JvZHk7CiAgICAgIGNvbnN0IGZvcndhcmRXUyA9IHVwZGF0ZUZyaWN0aW9uX2ZvcndhcmRXUzsKICAgICAgY29uc3QgYXhsZSA9IHVwZGF0ZUZyaWN0aW9uX2F4bGU7CiAgICAgIHRoaXMubnVtV2hlZWxzT25Hcm91bmQgPSAwOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1XaGVlbHM7IGkrKykgewogICAgICAgIGNvbnN0IHdoZWVsID0gd2hlZWxJbmZvc1tpXTsKICAgICAgICBjb25zdCBncm91bmRPYmplY3QgPSB3aGVlbC5yYXljYXN0UmVzdWx0LmJvZHk7CgogICAgICAgIGlmIChncm91bmRPYmplY3QpIHsKICAgICAgICAgIHRoaXMubnVtV2hlZWxzT25Hcm91bmQrKzsKICAgICAgICB9CgogICAgICAgIHdoZWVsLnNpZGVJbXB1bHNlID0gMDsKICAgICAgICB3aGVlbC5mb3J3YXJkSW1wdWxzZSA9IDA7CgogICAgICAgIGlmICghZm9yd2FyZFdTW2ldKSB7CiAgICAgICAgICBmb3J3YXJkV1NbaV0gPSBuZXcgVmVjMygpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFheGxlW2ldKSB7CiAgICAgICAgICBheGxlW2ldID0gbmV3IFZlYzMoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtV2hlZWxzOyBpKyspIHsKICAgICAgICBjb25zdCB3aGVlbCA9IHdoZWVsSW5mb3NbaV07CiAgICAgICAgY29uc3QgZ3JvdW5kT2JqZWN0ID0gd2hlZWwucmF5Y2FzdFJlc3VsdC5ib2R5OwoKICAgICAgICBpZiAoZ3JvdW5kT2JqZWN0KSB7CiAgICAgICAgICBjb25zdCBheGxlaSA9IGF4bGVbaV07CiAgICAgICAgICBjb25zdCB3aGVlbFRyYW5zID0gdGhpcy5nZXRXaGVlbFRyYW5zZm9ybVdvcmxkKGkpOyAvLyBHZXQgd29ybGQgYXhsZQoKICAgICAgICAgIHdoZWVsVHJhbnMudmVjdG9yVG9Xb3JsZEZyYW1lKGRpcmVjdGlvbnNbdGhpcy5pbmRleFJpZ2h0QXhpc10sIGF4bGVpKTsKICAgICAgICAgIGNvbnN0IHN1cmZOb3JtYWxXUyA9IHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQ7CiAgICAgICAgICBjb25zdCBwcm9qID0gYXhsZWkuZG90KHN1cmZOb3JtYWxXUyk7CiAgICAgICAgICBzdXJmTm9ybWFsV1Muc2NhbGUocHJvaiwgc3VyZk5vcm1hbFdTX3NjYWxlZF9wcm9qKTsKICAgICAgICAgIGF4bGVpLnZzdWIoc3VyZk5vcm1hbFdTX3NjYWxlZF9wcm9qLCBheGxlaSk7CiAgICAgICAgICBheGxlaS5ub3JtYWxpemUoKTsKICAgICAgICAgIHN1cmZOb3JtYWxXUy5jcm9zcyhheGxlaSwgZm9yd2FyZFdTW2ldKTsKICAgICAgICAgIGZvcndhcmRXU1tpXS5ub3JtYWxpemUoKTsKICAgICAgICAgIHdoZWVsLnNpZGVJbXB1bHNlID0gcmVzb2x2ZVNpbmdsZUJpbGF0ZXJhbChjaGFzc2lzQm9keSwgd2hlZWwucmF5Y2FzdFJlc3VsdC5oaXRQb2ludFdvcmxkLCBncm91bmRPYmplY3QsIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZCwgYXhsZWkpOwogICAgICAgICAgd2hlZWwuc2lkZUltcHVsc2UgKj0gc2lkZUZyaWN0aW9uU3RpZmZuZXNzMjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IHNpZGVGYWN0b3IgPSAxOwogICAgICBjb25zdCBmd2RGYWN0b3IgPSAwLjU7CiAgICAgIHRoaXMuc2xpZGluZyA9IGZhbHNlOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1XaGVlbHM7IGkrKykgewogICAgICAgIGNvbnN0IHdoZWVsID0gd2hlZWxJbmZvc1tpXTsKICAgICAgICBjb25zdCBncm91bmRPYmplY3QgPSB3aGVlbC5yYXljYXN0UmVzdWx0LmJvZHk7CiAgICAgICAgbGV0IHJvbGxpbmdGcmljdGlvbiA9IDA7CiAgICAgICAgd2hlZWwuc2xpcEluZm8gPSAxOwoKICAgICAgICBpZiAoZ3JvdW5kT2JqZWN0KSB7CiAgICAgICAgICBjb25zdCBkZWZhdWx0Um9sbGluZ0ZyaWN0aW9uSW1wdWxzZSA9IDA7CiAgICAgICAgICBjb25zdCBtYXhJbXB1bHNlID0gd2hlZWwuYnJha2UgPyB3aGVlbC5icmFrZSA6IGRlZmF1bHRSb2xsaW5nRnJpY3Rpb25JbXB1bHNlOyAvLyBidFdoZWVsQ29udGFjdFBvaW50IGNvbnRhY3RQdChjaGFzc2lzQm9keSxncm91bmRPYmplY3Qsd2hlZWxJbmZyYXljYXN0SW5mby5oaXRQb2ludFdvcmxkLGZvcndhcmRXU1t3aGVlbF0sbWF4SW1wdWxzZSk7CiAgICAgICAgICAvLyByb2xsaW5nRnJpY3Rpb24gPSBjYWxjUm9sbGluZ0ZyaWN0aW9uKGNvbnRhY3RQdCk7CgogICAgICAgICAgcm9sbGluZ0ZyaWN0aW9uID0gY2FsY1JvbGxpbmdGcmljdGlvbihjaGFzc2lzQm9keSwgZ3JvdW5kT2JqZWN0LCB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdFBvaW50V29ybGQsIGZvcndhcmRXU1tpXSwgbWF4SW1wdWxzZSk7CiAgICAgICAgICByb2xsaW5nRnJpY3Rpb24gKz0gd2hlZWwuZW5naW5lRm9yY2UgKiB0aW1lU3RlcDsgLy8gcm9sbGluZ0ZyaWN0aW9uID0gMDsKCiAgICAgICAgICBjb25zdCBmYWN0b3IgPSBtYXhJbXB1bHNlIC8gcm9sbGluZ0ZyaWN0aW9uOwogICAgICAgICAgd2hlZWwuc2xpcEluZm8gKj0gZmFjdG9yOwogICAgICAgIH0gLy9zd2l0Y2ggYmV0d2VlbiBhY3RpdmUgcm9sbGluZyAodGhyb3R0bGUpLCBicmFraW5nIGFuZCBub24tYWN0aXZlIHJvbGxpbmcgZnJpY3Rpb24gKG50aHJvdHRsZS9icmVhaykKCgogICAgICAgIHdoZWVsLmZvcndhcmRJbXB1bHNlID0gMDsKICAgICAgICB3aGVlbC5za2lkSW5mbyA9IDE7CgogICAgICAgIGlmIChncm91bmRPYmplY3QpIHsKICAgICAgICAgIHdoZWVsLnNraWRJbmZvID0gMTsKICAgICAgICAgIGNvbnN0IG1heGltcCA9IHdoZWVsLnN1c3BlbnNpb25Gb3JjZSAqIHRpbWVTdGVwICogd2hlZWwuZnJpY3Rpb25TbGlwOwogICAgICAgICAgY29uc3QgbWF4aW1wU2lkZSA9IG1heGltcDsKICAgICAgICAgIGNvbnN0IG1heGltcFNxdWFyZWQgPSBtYXhpbXAgKiBtYXhpbXBTaWRlOwogICAgICAgICAgd2hlZWwuZm9yd2FyZEltcHVsc2UgPSByb2xsaW5nRnJpY3Rpb247IC8vd2hlZWxJbmZvLmVuZ2luZUZvcmNlKiB0aW1lU3RlcDsKCiAgICAgICAgICBjb25zdCB4ID0gd2hlZWwuZm9yd2FyZEltcHVsc2UgKiBmd2RGYWN0b3IgLyB3aGVlbC5mb3J3YXJkQWNjZWxlcmF0aW9uOwogICAgICAgICAgY29uc3QgeSA9IHdoZWVsLnNpZGVJbXB1bHNlICogc2lkZUZhY3RvciAvIHdoZWVsLnNpZGVBY2NlbGVyYXRpb247CiAgICAgICAgICBjb25zdCBpbXB1bHNlU3F1YXJlZCA9IHggKiB4ICsgeSAqIHk7CiAgICAgICAgICB3aGVlbC5zbGlkaW5nID0gZmFsc2U7CgogICAgICAgICAgaWYgKGltcHVsc2VTcXVhcmVkID4gbWF4aW1wU3F1YXJlZCkgewogICAgICAgICAgICB0aGlzLnNsaWRpbmcgPSB0cnVlOwogICAgICAgICAgICB3aGVlbC5zbGlkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgZmFjdG9yID0gbWF4aW1wIC8gTWF0aC5zcXJ0KGltcHVsc2VTcXVhcmVkKTsKICAgICAgICAgICAgd2hlZWwuc2tpZEluZm8gKj0gZmFjdG9yOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuc2xpZGluZykgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtV2hlZWxzOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHdoZWVsID0gd2hlZWxJbmZvc1tpXTsKCiAgICAgICAgICBpZiAod2hlZWwuc2lkZUltcHVsc2UgIT09IDApIHsKICAgICAgICAgICAgaWYgKHdoZWVsLnNraWRJbmZvIDwgMSkgewogICAgICAgICAgICAgIHdoZWVsLmZvcndhcmRJbXB1bHNlICo9IHdoZWVsLnNraWRJbmZvOwogICAgICAgICAgICAgIHdoZWVsLnNpZGVJbXB1bHNlICo9IHdoZWVsLnNraWRJbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIGFwcGx5IHRoZSBpbXB1bHNlcwoKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtV2hlZWxzOyBpKyspIHsKICAgICAgICBjb25zdCB3aGVlbCA9IHdoZWVsSW5mb3NbaV07CiAgICAgICAgY29uc3QgcmVsX3BvcyA9IG5ldyBWZWMzKCk7CiAgICAgICAgd2hlZWwucmF5Y2FzdFJlc3VsdC5oaXRQb2ludFdvcmxkLnZzdWIoY2hhc3Npc0JvZHkucG9zaXRpb24sIHJlbF9wb3MpOyAvLyBjYW5ub25zIGFwcGx5aW1wdWxzZSBpcyB1c2luZyB3b3JsZCBjb29yZCBmb3IgdGhlIHBvc2l0aW9uCiAgICAgICAgLy9yZWxfcG9zLmNvcHkod2hlZWwucmF5Y2FzdFJlc3VsdC5oaXRQb2ludFdvcmxkKTsKCiAgICAgICAgaWYgKHdoZWVsLmZvcndhcmRJbXB1bHNlICE9PSAwKSB7CiAgICAgICAgICBjb25zdCBpbXB1bHNlID0gbmV3IFZlYzMoKTsKICAgICAgICAgIGZvcndhcmRXU1tpXS5zY2FsZSh3aGVlbC5mb3J3YXJkSW1wdWxzZSwgaW1wdWxzZSk7CiAgICAgICAgICBjaGFzc2lzQm9keS5hcHBseUltcHVsc2UoaW1wdWxzZSwgcmVsX3Bvcyk7CiAgICAgICAgfQoKICAgICAgICBpZiAod2hlZWwuc2lkZUltcHVsc2UgIT09IDApIHsKICAgICAgICAgIGNvbnN0IGdyb3VuZE9iamVjdCA9IHdoZWVsLnJheWNhc3RSZXN1bHQuYm9keTsKICAgICAgICAgIGNvbnN0IHJlbF9wb3MyID0gbmV3IFZlYzMoKTsKICAgICAgICAgIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZC52c3ViKGdyb3VuZE9iamVjdC5wb3NpdGlvbiwgcmVsX3BvczIpOyAvL3JlbF9wb3MyLmNvcHkod2hlZWwucmF5Y2FzdFJlc3VsdC5oaXRQb2ludFdvcmxkKTsKCiAgICAgICAgICBjb25zdCBzaWRlSW1wID0gbmV3IFZlYzMoKTsKICAgICAgICAgIGF4bGVbaV0uc2NhbGUod2hlZWwuc2lkZUltcHVsc2UsIHNpZGVJbXApOyAvLyBTY2FsZSB0aGUgcmVsYXRpdmUgcG9zaXRpb24gaW4gdGhlIHVwIGRpcmVjdGlvbiB3aXRoIHJvbGxJbmZsdWVuY2UuCiAgICAgICAgICAvLyBJZiByb2xsSW5mbHVlbmNlIGlzIDEsIHRoZSBpbXB1bHNlIHdpbGwgYmUgYXBwbGllZCBvbiB0aGUgaGl0UG9pbnQgKGVhc3kgdG8gcm9sbCBvdmVyKSwgaWYgaXQgaXMgemVybyBpdCB3aWxsIGJlIGFwcGxpZWQgaW4gdGhlIHNhbWUgcGxhbmUgYXMgdGhlIGNlbnRlciBvZiBtYXNzIChub3QgZWFzeSB0byByb2xsIG92ZXIpLgoKICAgICAgICAgIGNoYXNzaXNCb2R5LnZlY3RvclRvTG9jYWxGcmFtZShyZWxfcG9zLCByZWxfcG9zKTsKICAgICAgICAgIHJlbF9wb3NbJ3h5eidbdGhpcy5pbmRleFVwQXhpc11dICo9IHdoZWVsLnJvbGxJbmZsdWVuY2U7CiAgICAgICAgICBjaGFzc2lzQm9keS52ZWN0b3JUb1dvcmxkRnJhbWUocmVsX3BvcywgcmVsX3Bvcyk7CiAgICAgICAgICBjaGFzc2lzQm9keS5hcHBseUltcHVsc2Uoc2lkZUltcCwgcmVsX3Bvcyk7IC8vYXBwbHkgZnJpY3Rpb24gaW1wdWxzZSBvbiB0aGUgZ3JvdW5kCgogICAgICAgICAgc2lkZUltcC5zY2FsZSgtMSwgc2lkZUltcCk7CiAgICAgICAgICBncm91bmRPYmplY3QuYXBwbHlJbXB1bHNlKHNpZGVJbXAsIHJlbF9wb3MyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgfQogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFZlYzQgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFZlYzUgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFZlYzYgPSBuZXcgVmVjMygpOwogIG5ldyBSYXkoKTsKICBuZXcgVmVjMygpOwogIGNvbnN0IGNhc3RSYXlfcmF5dmVjdG9yID0gbmV3IFZlYzMoKTsKICBjb25zdCBjYXN0UmF5X3RhcmdldCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgZGlyZWN0aW9ucyA9IFtuZXcgVmVjMygxLCAwLCAwKSwgbmV3IFZlYzMoMCwgMSwgMCksIG5ldyBWZWMzKDAsIDAsIDEpXTsKICBjb25zdCB1cGRhdGVGcmljdGlvbl9zdXJmTm9ybWFsV1Nfc2NhbGVkX3Byb2ogPSBuZXcgVmVjMygpOwogIGNvbnN0IHVwZGF0ZUZyaWN0aW9uX2F4bGUgPSBbXTsKICBjb25zdCB1cGRhdGVGcmljdGlvbl9mb3J3YXJkV1MgPSBbXTsKICBjb25zdCBzaWRlRnJpY3Rpb25TdGlmZm5lc3MyID0gMTsKICBjb25zdCBjYWxjUm9sbGluZ0ZyaWN0aW9uX3ZlbDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNhbGNSb2xsaW5nRnJpY3Rpb25fdmVsMiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgY2FsY1JvbGxpbmdGcmljdGlvbl92ZWwgPSBuZXcgVmVjMygpOwoKICBmdW5jdGlvbiBjYWxjUm9sbGluZ0ZyaWN0aW9uKGJvZHkwLCBib2R5MSwgZnJpY3Rpb25Qb3NXb3JsZCwgZnJpY3Rpb25EaXJlY3Rpb25Xb3JsZCwgbWF4SW1wdWxzZSkgewogICAgbGV0IGoxID0gMDsKICAgIGNvbnN0IGNvbnRhY3RQb3NXb3JsZCA9IGZyaWN0aW9uUG9zV29ybGQ7IC8vIGNvbnN0IHJlbF9wb3MxID0gbmV3IFZlYzMoKTsKICAgIC8vIGNvbnN0IHJlbF9wb3MyID0gbmV3IFZlYzMoKTsKCiAgICBjb25zdCB2ZWwxID0gY2FsY1JvbGxpbmdGcmljdGlvbl92ZWwxOwogICAgY29uc3QgdmVsMiA9IGNhbGNSb2xsaW5nRnJpY3Rpb25fdmVsMjsKICAgIGNvbnN0IHZlbCA9IGNhbGNSb2xsaW5nRnJpY3Rpb25fdmVsOyAvLyBjb250YWN0UG9zV29ybGQudnN1Yihib2R5MC5wb3NpdGlvbiwgcmVsX3BvczEpOwogICAgLy8gY29udGFjdFBvc1dvcmxkLnZzdWIoYm9keTEucG9zaXRpb24sIHJlbF9wb3MyKTsKCiAgICBib2R5MC5nZXRWZWxvY2l0eUF0V29ybGRQb2ludChjb250YWN0UG9zV29ybGQsIHZlbDEpOwogICAgYm9keTEuZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQoY29udGFjdFBvc1dvcmxkLCB2ZWwyKTsKICAgIHZlbDEudnN1Yih2ZWwyLCB2ZWwpOwogICAgY29uc3QgdnJlbCA9IGZyaWN0aW9uRGlyZWN0aW9uV29ybGQuZG90KHZlbCk7CiAgICBjb25zdCBkZW5vbTAgPSBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yKGJvZHkwLCBmcmljdGlvblBvc1dvcmxkLCBmcmljdGlvbkRpcmVjdGlvbldvcmxkKTsKICAgIGNvbnN0IGRlbm9tMSA9IGNvbXB1dGVJbXB1bHNlRGVub21pbmF0b3IoYm9keTEsIGZyaWN0aW9uUG9zV29ybGQsIGZyaWN0aW9uRGlyZWN0aW9uV29ybGQpOwogICAgY29uc3QgcmVsYXhhdGlvbiA9IDE7CiAgICBjb25zdCBqYWNEaWFnQUJJbnYgPSByZWxheGF0aW9uIC8gKGRlbm9tMCArIGRlbm9tMSk7IC8vIGNhbGN1bGF0ZSBqIHRoYXQgbW92ZXMgdXMgdG8gemVybyByZWxhdGl2ZSB2ZWxvY2l0eQoKICAgIGoxID0gLXZyZWwgKiBqYWNEaWFnQUJJbnY7CgogICAgaWYgKG1heEltcHVsc2UgPCBqMSkgewogICAgICBqMSA9IG1heEltcHVsc2U7CiAgICB9CgogICAgaWYgKGoxIDwgLW1heEltcHVsc2UpIHsKICAgICAgajEgPSAtbWF4SW1wdWxzZTsKICAgIH0KCiAgICByZXR1cm4gajE7CiAgfQoKICBjb25zdCBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX3IwID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX2MwID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX3ZlYyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcl9tID0gbmV3IFZlYzMoKTsKCiAgZnVuY3Rpb24gY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcihib2R5LCBwb3MsIG5vcm1hbCkgewogICAgY29uc3QgcjAgPSBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX3IwOwogICAgY29uc3QgYzAgPSBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX2MwOwogICAgY29uc3QgdmVjID0gY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcl92ZWM7CiAgICBjb25zdCBtID0gY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcl9tOwogICAgcG9zLnZzdWIoYm9keS5wb3NpdGlvbiwgcjApOwogICAgcjAuY3Jvc3Mobm9ybWFsLCBjMCk7CiAgICBib2R5LmludkluZXJ0aWFXb3JsZC52bXVsdChjMCwgbSk7CiAgICBtLmNyb3NzKHIwLCB2ZWMpOwogICAgcmV0dXJuIGJvZHkuaW52TWFzcyArIG5vcm1hbC5kb3QodmVjKTsKICB9CgogIGNvbnN0IHJlc29sdmVTaW5nbGVCaWxhdGVyYWxfdmVsMSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcmVzb2x2ZVNpbmdsZUJpbGF0ZXJhbF92ZWwyID0gbmV3IFZlYzMoKTsKICBjb25zdCByZXNvbHZlU2luZ2xlQmlsYXRlcmFsX3ZlbCA9IG5ldyBWZWMzKCk7IC8vIGJpbGF0ZXJhbCBjb25zdHJhaW50IGJldHdlZW4gdHdvIGR5bmFtaWMgb2JqZWN0cwoKICBmdW5jdGlvbiByZXNvbHZlU2luZ2xlQmlsYXRlcmFsKGJvZHkxLCBwb3MxLCBib2R5MiwgcG9zMiwgbm9ybWFsKSB7CiAgICBjb25zdCBub3JtYWxMZW5TcXIgPSBub3JtYWwubGVuZ3RoU3F1YXJlZCgpOwoKICAgIGlmIChub3JtYWxMZW5TcXIgPiAxLjEpIHsKICAgICAgcmV0dXJuIDA7IC8vIG5vIGltcHVsc2UKICAgIH0gLy8gY29uc3QgcmVsX3BvczEgPSBuZXcgVmVjMygpOwogICAgLy8gY29uc3QgcmVsX3BvczIgPSBuZXcgVmVjMygpOwogICAgLy8gcG9zMS52c3ViKGJvZHkxLnBvc2l0aW9uLCByZWxfcG9zMSk7CiAgICAvLyBwb3MyLnZzdWIoYm9keTIucG9zaXRpb24sIHJlbF9wb3MyKTsKCgogICAgY29uc3QgdmVsMSA9IHJlc29sdmVTaW5nbGVCaWxhdGVyYWxfdmVsMTsKICAgIGNvbnN0IHZlbDIgPSByZXNvbHZlU2luZ2xlQmlsYXRlcmFsX3ZlbDI7CiAgICBjb25zdCB2ZWwgPSByZXNvbHZlU2luZ2xlQmlsYXRlcmFsX3ZlbDsKICAgIGJvZHkxLmdldFZlbG9jaXR5QXRXb3JsZFBvaW50KHBvczEsIHZlbDEpOwogICAgYm9keTIuZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQocG9zMiwgdmVsMik7CiAgICB2ZWwxLnZzdWIodmVsMiwgdmVsKTsKICAgIGNvbnN0IHJlbF92ZWwgPSBub3JtYWwuZG90KHZlbCk7CiAgICBjb25zdCBjb250YWN0RGFtcGluZyA9IDAuMjsKICAgIGNvbnN0IG1hc3NUZXJtID0gMSAvIChib2R5MS5pbnZNYXNzICsgYm9keTIuaW52TWFzcyk7CiAgICBjb25zdCBpbXB1bHNlID0gLWNvbnRhY3REYW1waW5nICogcmVsX3ZlbCAqIG1hc3NUZXJtOwogICAgcmV0dXJuIGltcHVsc2U7CiAgfQoKICAvKioKICAgKiBTcGhlcmljYWwgc2hhcGUKICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCByYWRpdXMgPSAxCiAgICogICAgIGNvbnN0IHNwaGVyZVNoYXBlID0gbmV3IENBTk5PTi5TcGhlcmUocmFkaXVzKQogICAqICAgICBjb25zdCBzcGhlcmVCb2R5ID0gbmV3IENBTk5PTi5Cb2R5KHsgbWFzczogMSwgc2hhcGU6IHNwaGVyZVNoYXBlIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkoc3BoZXJlQm9keSkKICAgKi8KICBjbGFzcyBTcGhlcmUgZXh0ZW5kcyBTaGFwZSB7CiAgICAvKioKICAgICAqIFRoZSByYWRpdXMgb2YgdGhlIHNwaGVyZS4KICAgICAqLwoKICAgIC8qKgogICAgICoKICAgICAqIEBwYXJhbSByYWRpdXMgVGhlIHJhZGl1cyBvZiB0aGUgc3BoZXJlLCBhIG5vbi1uZWdhdGl2ZSBudW1iZXIuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKHJhZGl1cykgewogICAgICBzdXBlcih7CiAgICAgICAgdHlwZTogU2hhcGUudHlwZXMuU1BIRVJFCiAgICAgIH0pOwogICAgICB0aGlzLnJhZGl1cyA9IHJhZGl1cyAhPT0gdW5kZWZpbmVkID8gcmFkaXVzIDogMS4wOwoKICAgICAgaWYgKHRoaXMucmFkaXVzIDwgMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIHNwaGVyZSByYWRpdXMgY2Fubm90IGJlIG5lZ2F0aXZlLicpOwogICAgICB9CgogICAgICB0aGlzLnVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCk7CiAgICB9CiAgICAvKiogY2FsY3VsYXRlTG9jYWxJbmVydGlhICovCgoKICAgIGNhbGN1bGF0ZUxvY2FsSW5lcnRpYShtYXNzLCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgY29uc3QgSSA9IDIuMCAqIG1hc3MgKiB0aGlzLnJhZGl1cyAqIHRoaXMucmFkaXVzIC8gNS4wOwogICAgICB0YXJnZXQueCA9IEk7CiAgICAgIHRhcmdldC55ID0gSTsKICAgICAgdGFyZ2V0LnogPSBJOwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqIHZvbHVtZSAqLwoKCiAgICB2b2x1bWUoKSB7CiAgICAgIHJldHVybiA0LjAgKiBNYXRoLlBJICogTWF0aC5wb3codGhpcy5yYWRpdXMsIDMpIC8gMy4wOwogICAgfQoKICAgIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCkgewogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlUmFkaXVzID0gdGhpcy5yYWRpdXM7CiAgICB9CgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgY29uc3QgciA9IHRoaXMucmFkaXVzOwogICAgICBjb25zdCBheGVzID0gWyd4JywgJ3knLCAneiddOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBheGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgYXggPSBheGVzW2ldOwogICAgICAgIG1pbltheF0gPSBwb3NbYXhdIC0gcjsKICAgICAgICBtYXhbYXhdID0gcG9zW2F4XSArIHI7CiAgICAgIH0KICAgIH0KCiAgfQogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOyAvLyBUZW1wIHZlY3RvcnMgZm9yIGNhbGN1bGF0aW9uCgogIG5ldyBWZWMzKCk7IC8vIFJlbGF0aXZlIHZlbG9jaXR5CgogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKCiAgLyoqCiAgICogQ3lsaW5kZXIgY2xhc3MuCiAgICogQGV4YW1wbGUKICAgKiAgICAgY29uc3QgcmFkaXVzVG9wID0gMC41CiAgICogICAgIGNvbnN0IHJhZGl1c0JvdHRvbSA9IDAuNQogICAqICAgICBjb25zdCBoZWlnaHQgPSAyCiAgICogICAgIGNvbnN0IG51bVNlZ21lbnRzID0gMTIKICAgKiAgICAgY29uc3QgY3lsaW5kZXJTaGFwZSA9IG5ldyBDQU5OT04uQ3lsaW5kZXIocmFkaXVzVG9wLCByYWRpdXNCb3R0b20sIGhlaWdodCwgbnVtU2VnbWVudHMpCiAgICogICAgIGNvbnN0IGN5bGluZGVyQm9keSA9IG5ldyBDQU5OT04uQm9keSh7IG1hc3M6IDEsIHNoYXBlOiBjeWxpbmRlclNoYXBlIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkoY3lsaW5kZXJCb2R5KQogICAqLwoKICBjbGFzcyBDeWxpbmRlciBleHRlbmRzIENvbnZleFBvbHloZWRyb24gewogICAgLyoqIFRoZSByYWRpdXMgb2YgdGhlIHRvcCBvZiB0aGUgQ3lsaW5kZXIuICovCgogICAgLyoqIFRoZSByYWRpdXMgb2YgdGhlIGJvdHRvbSBvZiB0aGUgQ3lsaW5kZXIuICovCgogICAgLyoqIFRoZSBoZWlnaHQgb2YgdGhlIEN5bGluZGVyLiAqLwoKICAgIC8qKiBUaGUgbnVtYmVyIG9mIHNlZ21lbnRzIHRvIGJ1aWxkIHRoZSBjeWxpbmRlciBvdXQgb2YuICovCgogICAgLyoqCiAgICAgKiBAcGFyYW0gcmFkaXVzVG9wIFRoZSByYWRpdXMgb2YgdGhlIHRvcCBvZiB0aGUgQ3lsaW5kZXIuCiAgICAgKiBAcGFyYW0gcmFkaXVzQm90dG9tIFRoZSByYWRpdXMgb2YgdGhlIGJvdHRvbSBvZiB0aGUgQ3lsaW5kZXIuCiAgICAgKiBAcGFyYW0gaGVpZ2h0IFRoZSBoZWlnaHQgb2YgdGhlIEN5bGluZGVyLgogICAgICogQHBhcmFtIG51bVNlZ21lbnRzIFRoZSBudW1iZXIgb2Ygc2VnbWVudHMgdG8gYnVpbGQgdGhlIGN5bGluZGVyIG91dCBvZi4KICAgICAqLwogICAgY29uc3RydWN0b3IocmFkaXVzVG9wLCByYWRpdXNCb3R0b20sIGhlaWdodCwgbnVtU2VnbWVudHMpIHsKICAgICAgaWYgKHJhZGl1c1RvcCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmFkaXVzVG9wID0gMTsKICAgICAgfQoKICAgICAgaWYgKHJhZGl1c0JvdHRvbSA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmFkaXVzQm90dG9tID0gMTsKICAgICAgfQoKICAgICAgaWYgKGhlaWdodCA9PT0gdm9pZCAwKSB7CiAgICAgICAgaGVpZ2h0ID0gMTsKICAgICAgfQoKICAgICAgaWYgKG51bVNlZ21lbnRzID09PSB2b2lkIDApIHsKICAgICAgICBudW1TZWdtZW50cyA9IDg7CiAgICAgIH0KCiAgICAgIGlmIChyYWRpdXNUb3AgPCAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgY3lsaW5kZXIgcmFkaXVzVG9wIGNhbm5vdCBiZSBuZWdhdGl2ZS4nKTsKICAgICAgfQoKICAgICAgaWYgKHJhZGl1c0JvdHRvbSA8IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBjeWxpbmRlciByYWRpdXNCb3R0b20gY2Fubm90IGJlIG5lZ2F0aXZlLicpOwogICAgICB9CgogICAgICBjb25zdCBOID0gbnVtU2VnbWVudHM7CiAgICAgIGNvbnN0IHZlcnRpY2VzID0gW107CiAgICAgIGNvbnN0IGF4ZXMgPSBbXTsKICAgICAgY29uc3QgZmFjZXMgPSBbXTsKICAgICAgY29uc3QgYm90dG9tZmFjZSA9IFtdOwogICAgICBjb25zdCB0b3BmYWNlID0gW107CiAgICAgIGNvbnN0IGNvcyA9IE1hdGguY29zOwogICAgICBjb25zdCBzaW4gPSBNYXRoLnNpbjsgLy8gRmlyc3QgYm90dG9tIHBvaW50CgogICAgICB2ZXJ0aWNlcy5wdXNoKG5ldyBWZWMzKC1yYWRpdXNCb3R0b20gKiBzaW4oMCksIC1oZWlnaHQgKiAwLjUsIHJhZGl1c0JvdHRvbSAqIGNvcygwKSkpOwogICAgICBib3R0b21mYWNlLnB1c2goMCk7IC8vIEZpcnN0IHRvcCBwb2ludAoKICAgICAgdmVydGljZXMucHVzaChuZXcgVmVjMygtcmFkaXVzVG9wICogc2luKDApLCBoZWlnaHQgKiAwLjUsIHJhZGl1c1RvcCAqIGNvcygwKSkpOwogICAgICB0b3BmYWNlLnB1c2goMSk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE47IGkrKykgewogICAgICAgIGNvbnN0IHRoZXRhID0gMiAqIE1hdGguUEkgLyBOICogKGkgKyAxKTsKICAgICAgICBjb25zdCB0aGV0YU4gPSAyICogTWF0aC5QSSAvIE4gKiAoaSArIDAuNSk7CgogICAgICAgIGlmIChpIDwgTiAtIDEpIHsKICAgICAgICAgIC8vIEJvdHRvbQogICAgICAgICAgdmVydGljZXMucHVzaChuZXcgVmVjMygtcmFkaXVzQm90dG9tICogc2luKHRoZXRhKSwgLWhlaWdodCAqIDAuNSwgcmFkaXVzQm90dG9tICogY29zKHRoZXRhKSkpOwogICAgICAgICAgYm90dG9tZmFjZS5wdXNoKDIgKiBpICsgMik7IC8vIFRvcAoKICAgICAgICAgIHZlcnRpY2VzLnB1c2gobmV3IFZlYzMoLXJhZGl1c1RvcCAqIHNpbih0aGV0YSksIGhlaWdodCAqIDAuNSwgcmFkaXVzVG9wICogY29zKHRoZXRhKSkpOwogICAgICAgICAgdG9wZmFjZS5wdXNoKDIgKiBpICsgMyk7IC8vIEZhY2UKCiAgICAgICAgICBmYWNlcy5wdXNoKFsyICogaSwgMiAqIGkgKyAxLCAyICogaSArIDMsIDIgKiBpICsgMl0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmYWNlcy5wdXNoKFsyICogaSwgMiAqIGkgKyAxLCAxLCAwXSk7IC8vIENvbm5lY3QKICAgICAgICB9IC8vIEF4aXM6IHdlIGNhbiBjdXQgb2ZmIGhhbGYgb2YgdGhlbSBpZiB3ZSBoYXZlIGV2ZW4gbnVtYmVyIG9mIHNlZ21lbnRzCgoKICAgICAgICBpZiAoTiAlIDIgPT09IDEgfHwgaSA8IE4gLyAyKSB7CiAgICAgICAgICBheGVzLnB1c2gobmV3IFZlYzMoLXNpbih0aGV0YU4pLCAwLCBjb3ModGhldGFOKSkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZmFjZXMucHVzaChib3R0b21mYWNlKTsKICAgICAgYXhlcy5wdXNoKG5ldyBWZWMzKDAsIDEsIDApKTsgLy8gUmVvcmRlciB0b3AgZmFjZQoKICAgICAgY29uc3QgdGVtcCA9IFtdOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b3BmYWNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGVtcC5wdXNoKHRvcGZhY2VbdG9wZmFjZS5sZW5ndGggLSBpIC0gMV0pOwogICAgICB9CgogICAgICBmYWNlcy5wdXNoKHRlbXApOwogICAgICBzdXBlcih7CiAgICAgICAgdmVydGljZXMsCiAgICAgICAgZmFjZXMsCiAgICAgICAgYXhlcwogICAgICB9KTsKICAgICAgdGhpcy50eXBlID0gU2hhcGUudHlwZXMuQ1lMSU5ERVI7CiAgICAgIHRoaXMucmFkaXVzVG9wID0gcmFkaXVzVG9wOwogICAgICB0aGlzLnJhZGl1c0JvdHRvbSA9IHJhZGl1c0JvdHRvbTsKICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIHRoaXMubnVtU2VnbWVudHMgPSBudW1TZWdtZW50czsKICAgIH0KCiAgfQoKICAvKioKICAgKiBQYXJ0aWNsZSBzaGFwZS4KICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCBwYXJ0aWNsZVNoYXBlID0gbmV3IENBTk5PTi5QYXJ0aWNsZSgpCiAgICogICAgIGNvbnN0IHBhcnRpY2xlQm9keSA9IG5ldyBDQU5OT04uQm9keSh7IG1hc3M6IDEsIHNoYXBlOiBwYXJ0aWNsZVNoYXBlIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkocGFydGljbGVCb2R5KQogICAqLwogIGNsYXNzIFBhcnRpY2xlIGV4dGVuZHMgU2hhcGUgewogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHN1cGVyKHsKICAgICAgICB0eXBlOiBTaGFwZS50eXBlcy5QQVJUSUNMRQogICAgICB9KTsKICAgIH0KICAgIC8qKgogICAgICogY2FsY3VsYXRlTG9jYWxJbmVydGlhCiAgICAgKi8KCgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0YXJnZXQuc2V0KDAsIDAsIDApOwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQoKICAgIHZvbHVtZSgpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgdXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKSB7CiAgICAgIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgPSAwOwogICAgfQoKICAgIGNhbGN1bGF0ZVdvcmxkQUFCQihwb3MsIHF1YXQsIG1pbiwgbWF4KSB7CiAgICAgIC8vIEdldCBlYWNoIGF4aXMgbWF4CiAgICAgIG1pbi5jb3B5KHBvcyk7CiAgICAgIG1heC5jb3B5KHBvcyk7CiAgICB9CgogIH0KCiAgLyoqCiAgICogQSBwbGFuZSwgZmFjaW5nIGluIHRoZSBaIGRpcmVjdGlvbi4gVGhlIHBsYW5lIGhhcyBpdHMgc3VyZmFjZSBhdCB6PTAgYW5kIGV2ZXJ5dGhpbmcgYmVsb3cgej0wIGlzIGFzc3VtZWQgdG8gYmUgc29saWQgcGxhbmUuIFRvIG1ha2UgdGhlIHBsYW5lIGZhY2UgaW4gc29tZSBvdGhlciBkaXJlY3Rpb24gdGhhbiB6LCB5b3UgbXVzdCBwdXQgaXQgaW5zaWRlIGEgQm9keSBhbmQgcm90YXRlIHRoYXQgYm9keS4gU2VlIHRoZSBkZW1vcy4KICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCBwbGFuZVNoYXBlID0gbmV3IENBTk5PTi5QbGFuZSgpCiAgICogICAgIGNvbnN0IHBsYW5lQm9keSA9IG5ldyBDQU5OT04uQm9keSh7IG1hc3M6IDAsIHNoYXBlOiAgcGxhbmVTaGFwZSB9KQogICAqICAgICBwbGFuZUJvZHkucXVhdGVybmlvbi5zZXRGcm9tRXVsZXIoLU1hdGguUEkgLyAyLCAwLCAwKSAvLyBtYWtlIGl0IGZhY2UgdXAKICAgKiAgICAgd29ybGQuYWRkQm9keShwbGFuZUJvZHkpCiAgICovCiAgY2xhc3MgUGxhbmUgZXh0ZW5kcyBTaGFwZSB7CiAgICAvKiogd29ybGROb3JtYWwgKi8KCiAgICAvKiogd29ybGROb3JtYWxOZWVkc1VwZGF0ZSAqLwogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHN1cGVyKHsKICAgICAgICB0eXBlOiBTaGFwZS50eXBlcy5QTEFORQogICAgICB9KTsgLy8gV29ybGQgb3JpZW50ZWQgbm9ybWFsCgogICAgICB0aGlzLndvcmxkTm9ybWFsID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy53b3JsZE5vcm1hbE5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyA9IE51bWJlci5NQVhfVkFMVUU7CiAgICB9CiAgICAvKiogY29tcHV0ZVdvcmxkTm9ybWFsICovCgoKICAgIGNvbXB1dGVXb3JsZE5vcm1hbChxdWF0KSB7CiAgICAgIGNvbnN0IG4gPSB0aGlzLndvcmxkTm9ybWFsOwogICAgICBuLnNldCgwLCAwLCAxKTsKICAgICAgcXVhdC52bXVsdChuLCBuKTsKICAgICAgdGhpcy53b3JsZE5vcm1hbE5lZWRzVXBkYXRlID0gZmFsc2U7CiAgICB9CgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQoKICAgIHZvbHVtZSgpIHsKICAgICAgcmV0dXJuICgvLyBUaGUgcGxhbmUgaXMgaW5maW5pdGUuLi4KICAgICAgICBOdW1iZXIuTUFYX1ZBTFVFCiAgICAgICk7CiAgICB9CgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgLy8gVGhlIHBsYW5lIEFBQkIgaXMgaW5maW5pdGUsIGV4Y2VwdCBpZiB0aGUgbm9ybWFsIGlzIHBvaW50aW5nIGFsb25nIGFueSBheGlzCiAgICAgIHRlbXBOb3JtYWwuc2V0KDAsIDAsIDEpOyAvLyBEZWZhdWx0IHBsYW5lIG5vcm1hbCBpcyB6CgogICAgICBxdWF0LnZtdWx0KHRlbXBOb3JtYWwsIHRlbXBOb3JtYWwpOwogICAgICBjb25zdCBtYXhWYWwgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICBtaW4uc2V0KC1tYXhWYWwsIC1tYXhWYWwsIC1tYXhWYWwpOwogICAgICBtYXguc2V0KG1heFZhbCwgbWF4VmFsLCBtYXhWYWwpOwoKICAgICAgaWYgKHRlbXBOb3JtYWwueCA9PT0gMSkgewogICAgICAgIG1heC54ID0gcG9zLng7CiAgICAgIH0gZWxzZSBpZiAodGVtcE5vcm1hbC54ID09PSAtMSkgewogICAgICAgIG1pbi54ID0gcG9zLng7CiAgICAgIH0KCiAgICAgIGlmICh0ZW1wTm9ybWFsLnkgPT09IDEpIHsKICAgICAgICBtYXgueSA9IHBvcy55OwogICAgICB9IGVsc2UgaWYgKHRlbXBOb3JtYWwueSA9PT0gLTEpIHsKICAgICAgICBtaW4ueSA9IHBvcy55OwogICAgICB9CgogICAgICBpZiAodGVtcE5vcm1hbC56ID09PSAxKSB7CiAgICAgICAgbWF4LnogPSBwb3MuejsKICAgICAgfSBlbHNlIGlmICh0ZW1wTm9ybWFsLnogPT09IC0xKSB7CiAgICAgICAgbWluLnogPSBwb3MuejsKICAgICAgfQogICAgfQoKICAgIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCkgewogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlUmFkaXVzID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgIH0KCiAgfQogIGNvbnN0IHRlbXBOb3JtYWwgPSBuZXcgVmVjMygpOwoKICAvKioKICAgKiBIZWlnaHRmaWVsZCBzaGFwZSBjbGFzcy4gSGVpZ2h0IGRhdGEgaXMgZ2l2ZW4gYXMgYW4gYXJyYXkuIFRoZXNlIGRhdGEgcG9pbnRzIGFyZSBzcHJlYWQgb3V0IGV2ZW5seSB3aXRoIGEgZ2l2ZW4gZGlzdGFuY2UuCiAgICogQHRvZG8gU2hvdWxkIGJlIHBvc3NpYmxlIHRvIHVzZSBhbG9uZyBhbGwgYXhlcywgbm90IGp1c3QgeQogICAqIEB0b2RvIHNob3VsZCBiZSBwb3NzaWJsZSB0byBzY2FsZSBhbG9uZyBhbGwgYXhlcwogICAqIEB0b2RvIFJlZmFjdG9yIGVsZW1lbnRTaXplIHRvIGVsZW1lbnRTaXplWCBhbmQgZWxlbWVudFNpemVZCiAgICoKICAgKiBAZXhhbXBsZQogICAqICAgICAvLyBHZW5lcmF0ZSBzb21lIGhlaWdodCBkYXRhICh5LXZhbHVlcykuCiAgICogICAgIGNvbnN0IGRhdGEgPSBbXQogICAqICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwMDA7IGkrKykgewogICAqICAgICAgICAgY29uc3QgeSA9IDAuNSAqIE1hdGguY29zKDAuMiAqIGkpCiAgICogICAgICAgICBkYXRhLnB1c2goeSkKICAgKiAgICAgfQogICAqCiAgICogICAgIC8vIENyZWF0ZSB0aGUgaGVpZ2h0ZmllbGQgc2hhcGUKICAgKiAgICAgY29uc3QgaGVpZ2h0ZmllbGRTaGFwZSA9IG5ldyBDQU5OT04uSGVpZ2h0ZmllbGQoZGF0YSwgewogICAqICAgICAgICAgZWxlbWVudFNpemU6IDEgLy8gRGlzdGFuY2UgYmV0d2VlbiB0aGUgZGF0YSBwb2ludHMgaW4gWCBhbmQgWSBkaXJlY3Rpb25zCiAgICogICAgIH0pCiAgICogICAgIGNvbnN0IGhlaWdodGZpZWxkQm9keSA9IG5ldyBDQU5OT04uQm9keSh7IHNoYXBlOiBoZWlnaHRmaWVsZFNoYXBlIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkoaGVpZ2h0ZmllbGRCb2R5KQogICAqLwogIGNsYXNzIEhlaWdodGZpZWxkIGV4dGVuZHMgU2hhcGUgewogICAgLyoqCiAgICAgKiBBbiBhcnJheSBvZiBudW1iZXJzLCBvciBoZWlnaHQgdmFsdWVzLCB0aGF0IGFyZSBzcHJlYWQgb3V0IGFsb25nIHRoZSB4IGF4aXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIE1heCB2YWx1ZSBvZiB0aGUgZGF0YSBwb2ludHMgaW4gdGhlIGRhdGEgYXJyYXkuCiAgICAgKi8KCiAgICAvKioKICAgICAqIE1pbmltdW0gdmFsdWUgb2YgdGhlIGRhdGEgcG9pbnRzIGluIHRoZSBkYXRhIGFycmF5LgogICAgICovCgogICAgLyoqCiAgICAgKiBXb3JsZCBzcGFjaW5nIGJldHdlZW4gdGhlIGRhdGEgcG9pbnRzIGluIFggYW5kIFkgZGlyZWN0aW9uLgogICAgICogQHRvZG8gZWxlbWVudFNpemVYIGFuZCBZCiAgICAgKiBAZGVmYXVsdCAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBkZWZhdWx0IHRydWUKICAgICAqLwoKICAgIC8qKgogICAgICogQHBhcmFtIGRhdGEgQW4gYXJyYXkgb2YgbnVtYmVycywgb3IgaGVpZ2h0IHZhbHVlcywgdGhhdCBhcmUgc3ByZWFkIG91dCBhbG9uZyB0aGUgeCBheGlzLgogICAgICovCiAgICBjb25zdHJ1Y3RvcihkYXRhLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBVdGlscy5kZWZhdWx0cyhvcHRpb25zLCB7CiAgICAgICAgbWF4VmFsdWU6IG51bGwsCiAgICAgICAgbWluVmFsdWU6IG51bGwsCiAgICAgICAgZWxlbWVudFNpemU6IDEKICAgICAgfSk7CiAgICAgIHN1cGVyKHsKICAgICAgICB0eXBlOiBTaGFwZS50eXBlcy5IRUlHSFRGSUVMRAogICAgICB9KTsKICAgICAgdGhpcy5kYXRhID0gZGF0YTsKICAgICAgdGhpcy5tYXhWYWx1ZSA9IG9wdGlvbnMubWF4VmFsdWU7CiAgICAgIHRoaXMubWluVmFsdWUgPSBvcHRpb25zLm1pblZhbHVlOwogICAgICB0aGlzLmVsZW1lbnRTaXplID0gb3B0aW9ucy5lbGVtZW50U2l6ZTsKCiAgICAgIGlmIChvcHRpb25zLm1pblZhbHVlID09PSBudWxsKSB7CiAgICAgICAgdGhpcy51cGRhdGVNaW5WYWx1ZSgpOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5tYXhWYWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHRoaXMudXBkYXRlTWF4VmFsdWUoKTsKICAgICAgfQoKICAgICAgdGhpcy5jYWNoZUVuYWJsZWQgPSB0cnVlOwogICAgICB0aGlzLnBpbGxhckNvbnZleCA9IG5ldyBDb252ZXhQb2x5aGVkcm9uKCk7CiAgICAgIHRoaXMucGlsbGFyT2Zmc2V0ID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy51cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpOyAvLyAiaV9qX2lzVXBwZXIiID0+IHsgY29udmV4OiAuLi4sIG9mZnNldDogLi4uIH0KICAgICAgLy8gZm9yIGV4YW1wbGU6CiAgICAgIC8vIF9jYWNoZWRQaWxsYXJzWyIwXzJfMSJdCgogICAgICB0aGlzLl9jYWNoZWRQaWxsYXJzID0ge307CiAgICB9CiAgICAvKioKICAgICAqIENhbGwgd2hlbmV2ZXIgeW91IGNoYW5nZSB0aGUgZGF0YSBhcnJheS4KICAgICAqLwoKCiAgICB1cGRhdGUoKSB7CiAgICAgIHRoaXMuX2NhY2hlZFBpbGxhcnMgPSB7fTsKICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlIHRoZSBgbWluVmFsdWVgIHByb3BlcnR5CiAgICAgKi8KCgogICAgdXBkYXRlTWluVmFsdWUoKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGxldCBtaW5WYWx1ZSA9IGRhdGFbMF1bMF07CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSBkYXRhW2ldLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCB2ID0gZGF0YVtpXVtqXTsKCiAgICAgICAgICBpZiAodiA8IG1pblZhbHVlKSB7CiAgICAgICAgICAgIG1pblZhbHVlID0gdjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMubWluVmFsdWUgPSBtaW5WYWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlIHRoZSBgbWF4VmFsdWVgIHByb3BlcnR5CiAgICAgKi8KCgogICAgdXBkYXRlTWF4VmFsdWUoKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGxldCBtYXhWYWx1ZSA9IGRhdGFbMF1bMF07CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSBkYXRhW2ldLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCB2ID0gZGF0YVtpXVtqXTsKCiAgICAgICAgICBpZiAodiA+IG1heFZhbHVlKSB7CiAgICAgICAgICAgIG1heFZhbHVlID0gdjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMubWF4VmFsdWUgPSBtYXhWYWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBoZWlnaHQgdmFsdWUgYXQgYW4gaW5kZXguIERvbid0IGZvcmdldCB0byB1cGRhdGUgbWF4VmFsdWUgYW5kIG1pblZhbHVlIGFmdGVyIHlvdSdyZSBkb25lLgogICAgICovCgoKICAgIHNldEhlaWdodFZhbHVlQXRJbmRleCh4aSwgeWksIHZhbHVlKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGRhdGFbeGldW3lpXSA9IHZhbHVlOyAvLyBJbnZhbGlkYXRlIGNhY2hlCgogICAgICB0aGlzLmNsZWFyQ2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGksIHlpLCBmYWxzZSk7CgogICAgICBpZiAoeGkgPiAwKSB7CiAgICAgICAgdGhpcy5jbGVhckNhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpIC0gMSwgeWksIHRydWUpOwogICAgICAgIHRoaXMuY2xlYXJDYWNoZWRDb252ZXhUcmlhbmdsZVBpbGxhcih4aSAtIDEsIHlpLCBmYWxzZSk7CiAgICAgIH0KCiAgICAgIGlmICh5aSA+IDApIHsKICAgICAgICB0aGlzLmNsZWFyQ2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGksIHlpIC0gMSwgdHJ1ZSk7CiAgICAgICAgdGhpcy5jbGVhckNhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpLCB5aSAtIDEsIGZhbHNlKTsKICAgICAgfQoKICAgICAgaWYgKHlpID4gMCAmJiB4aSA+IDApIHsKICAgICAgICB0aGlzLmNsZWFyQ2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGkgLSAxLCB5aSAtIDEsIHRydWUpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCBtYXgvbWluIGluIGEgcmVjdGFuZ2xlIGluIHRoZSBtYXRyaXggZGF0YQogICAgICogQHBhcmFtIHJlc3VsdCBBbiBhcnJheSB0byBzdG9yZSB0aGUgcmVzdWx0cyBpbi4KICAgICAqIEByZXR1cm4gVGhlIHJlc3VsdCBhcnJheSwgaWYgaXQgd2FzIHBhc3NlZCBpbi4gTWluaW11bSB3aWxsIGJlIGF0IHBvc2l0aW9uIDAgYW5kIG1heCBhdCAxLgogICAgICovCgoKICAgIGdldFJlY3RNaW5NYXgoaU1pblgsIGlNaW5ZLCBpTWF4WCwgaU1heFksIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgfQoKICAgICAgLy8gR2V0IG1heCBhbmQgbWluIG9mIHRoZSBkYXRhCiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7IC8vIFNldCBmaXJzdCB2YWx1ZQoKICAgICAgbGV0IG1heCA9IHRoaXMubWluVmFsdWU7CgogICAgICBmb3IgKGxldCBpID0gaU1pblg7IGkgPD0gaU1heFg7IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSBpTWluWTsgaiA8PSBpTWF4WTsgaisrKSB7CiAgICAgICAgICBjb25zdCBoZWlnaHQgPSBkYXRhW2ldW2pdOwoKICAgICAgICAgIGlmIChoZWlnaHQgPiBtYXgpIHsKICAgICAgICAgICAgbWF4ID0gaGVpZ2h0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmVzdWx0WzBdID0gdGhpcy5taW5WYWx1ZTsKICAgICAgcmVzdWx0WzFdID0gbWF4OwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIGluZGV4IG9mIGEgbG9jYWwgcG9zaXRpb24gb24gdGhlIGhlaWdodGZpZWxkLiBUaGUgaW5kZXhlcyBpbmRpY2F0ZSB0aGUgcmVjdGFuZ2xlcywgc28gaWYgeW91ciB0ZXJyYWluIGlzIG1hZGUgb2YgTiB4IE4gaGVpZ2h0IGRhdGEgcG9pbnRzLCB5b3Ugd2lsbCBoYXZlIHJlY3RhbmdsZSBpbmRleGVzIHJhbmdpbmcgZnJvbSAwIHRvIE4tMS4KICAgICAqIEBwYXJhbSByZXN1bHQgVHdvLWVsZW1lbnQgYXJyYXkKICAgICAqIEBwYXJhbSBjbGFtcCBJZiB0aGUgcG9zaXRpb24gc2hvdWxkIGJlIGNsYW1wZWQgdG8gdGhlIGhlaWdodGZpZWxkIGVkZ2UuCiAgICAgKi8KCgogICAgZ2V0SW5kZXhPZlBvc2l0aW9uKHgsIHksIHJlc3VsdCwgY2xhbXApIHsKICAgICAgLy8gR2V0IHRoZSBpbmRleCBvZiB0aGUgZGF0YSBwb2ludHMgdG8gdGVzdCBhZ2FpbnN0CiAgICAgIGNvbnN0IHcgPSB0aGlzLmVsZW1lbnRTaXplOwogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgICBsZXQgeGkgPSBNYXRoLmZsb29yKHggLyB3KTsKICAgICAgbGV0IHlpID0gTWF0aC5mbG9vcih5IC8gdyk7CiAgICAgIHJlc3VsdFswXSA9IHhpOwogICAgICByZXN1bHRbMV0gPSB5aTsKCiAgICAgIGlmIChjbGFtcCkgewogICAgICAgIC8vIENsYW1wIGluZGV4IHRvIGVkZ2VzCiAgICAgICAgaWYgKHhpIDwgMCkgewogICAgICAgICAgeGkgPSAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKHlpIDwgMCkgewogICAgICAgICAgeWkgPSAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKHhpID49IGRhdGEubGVuZ3RoIC0gMSkgewogICAgICAgICAgeGkgPSBkYXRhLmxlbmd0aCAtIDE7CiAgICAgICAgfQoKICAgICAgICBpZiAoeWkgPj0gZGF0YVswXS5sZW5ndGggLSAxKSB7CiAgICAgICAgICB5aSA9IGRhdGFbMF0ubGVuZ3RoIC0gMTsKICAgICAgICB9CiAgICAgIH0gLy8gQmFpbCBvdXQgaWYgd2UgYXJlIG91dCBvZiB0aGUgdGVycmFpbgoKCiAgICAgIGlmICh4aSA8IDAgfHwgeWkgPCAwIHx8IHhpID49IGRhdGEubGVuZ3RoIC0gMSB8fCB5aSA+PSBkYXRhWzBdLmxlbmd0aCAtIDEpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGdldFRyaWFuZ2xlQXQoeCwgeSwgZWRnZUNsYW1wLCBhLCBiLCBjKSB7CiAgICAgIGNvbnN0IGlkeCA9IGdldEhlaWdodEF0X2lkeDsKICAgICAgdGhpcy5nZXRJbmRleE9mUG9zaXRpb24oeCwgeSwgaWR4LCBlZGdlQ2xhbXApOwogICAgICBsZXQgeGkgPSBpZHhbMF07CiAgICAgIGxldCB5aSA9IGlkeFsxXTsKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTsKCiAgICAgIGlmIChlZGdlQ2xhbXApIHsKICAgICAgICB4aSA9IE1hdGgubWluKGRhdGEubGVuZ3RoIC0gMiwgTWF0aC5tYXgoMCwgeGkpKTsKICAgICAgICB5aSA9IE1hdGgubWluKGRhdGFbMF0ubGVuZ3RoIC0gMiwgTWF0aC5tYXgoMCwgeWkpKTsKICAgICAgfQoKICAgICAgY29uc3QgZWxlbWVudFNpemUgPSB0aGlzLmVsZW1lbnRTaXplOwogICAgICBjb25zdCBsb3dlckRpc3QyID0gKHggLyBlbGVtZW50U2l6ZSAtIHhpKSAqKiAyICsgKHkgLyBlbGVtZW50U2l6ZSAtIHlpKSAqKiAyOwogICAgICBjb25zdCB1cHBlckRpc3QyID0gKHggLyBlbGVtZW50U2l6ZSAtICh4aSArIDEpKSAqKiAyICsgKHkgLyBlbGVtZW50U2l6ZSAtICh5aSArIDEpKSAqKiAyOwogICAgICBjb25zdCB1cHBlciA9IGxvd2VyRGlzdDIgPiB1cHBlckRpc3QyOwogICAgICB0aGlzLmdldFRyaWFuZ2xlKHhpLCB5aSwgdXBwZXIsIGEsIGIsIGMpOwogICAgICByZXR1cm4gdXBwZXI7CiAgICB9CgogICAgZ2V0Tm9ybWFsQXQoeCwgeSwgZWRnZUNsYW1wLCByZXN1bHQpIHsKICAgICAgY29uc3QgYSA9IGdldE5vcm1hbEF0X2E7CiAgICAgIGNvbnN0IGIgPSBnZXROb3JtYWxBdF9iOwogICAgICBjb25zdCBjID0gZ2V0Tm9ybWFsQXRfYzsKICAgICAgY29uc3QgZTAgPSBnZXROb3JtYWxBdF9lMDsKICAgICAgY29uc3QgZTEgPSBnZXROb3JtYWxBdF9lMTsKICAgICAgdGhpcy5nZXRUcmlhbmdsZUF0KHgsIHksIGVkZ2VDbGFtcCwgYSwgYiwgYyk7CiAgICAgIGIudnN1YihhLCBlMCk7CiAgICAgIGMudnN1YihhLCBlMSk7CiAgICAgIGUwLmNyb3NzKGUxLCByZXN1bHQpOwogICAgICByZXN1bHQubm9ybWFsaXplKCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbiBBQUJCIG9mIGEgc3F1YXJlIGluIHRoZSBoZWlnaHRmaWVsZAogICAgICogQHBhcmFtIHhpCiAgICAgKiBAcGFyYW0geWkKICAgICAqIEBwYXJhbSByZXN1bHQKICAgICAqLwoKCiAgICBnZXRBYWJiQXRJbmRleCh4aSwgeWksIF9yZWYpIHsKICAgICAgbGV0IHsKICAgICAgICBsb3dlckJvdW5kLAogICAgICAgIHVwcGVyQm91bmQKICAgICAgfSA9IF9yZWY7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGNvbnN0IGVsZW1lbnRTaXplID0gdGhpcy5lbGVtZW50U2l6ZTsKICAgICAgbG93ZXJCb3VuZC5zZXQoeGkgKiBlbGVtZW50U2l6ZSwgeWkgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aV1beWldKTsKICAgICAgdXBwZXJCb3VuZC5zZXQoKHhpICsgMSkgKiBlbGVtZW50U2l6ZSwgKHlpICsgMSkgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aSArIDFdW3lpICsgMV0pOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIGhlaWdodCBpbiB0aGUgaGVpZ2h0ZmllbGQgYXQgYSBnaXZlbiBwb3NpdGlvbgogICAgICovCgoKICAgIGdldEhlaWdodEF0KHgsIHksIGVkZ2VDbGFtcCkgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgICBjb25zdCBhID0gZ2V0SGVpZ2h0QXRfYTsKICAgICAgY29uc3QgYiA9IGdldEhlaWdodEF0X2I7CiAgICAgIGNvbnN0IGMgPSBnZXRIZWlnaHRBdF9jOwogICAgICBjb25zdCBpZHggPSBnZXRIZWlnaHRBdF9pZHg7CiAgICAgIHRoaXMuZ2V0SW5kZXhPZlBvc2l0aW9uKHgsIHksIGlkeCwgZWRnZUNsYW1wKTsKICAgICAgbGV0IHhpID0gaWR4WzBdOwogICAgICBsZXQgeWkgPSBpZHhbMV07CgogICAgICBpZiAoZWRnZUNsYW1wKSB7CiAgICAgICAgeGkgPSBNYXRoLm1pbihkYXRhLmxlbmd0aCAtIDIsIE1hdGgubWF4KDAsIHhpKSk7CiAgICAgICAgeWkgPSBNYXRoLm1pbihkYXRhWzBdLmxlbmd0aCAtIDIsIE1hdGgubWF4KDAsIHlpKSk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHVwcGVyID0gdGhpcy5nZXRUcmlhbmdsZUF0KHgsIHksIGVkZ2VDbGFtcCwgYSwgYiwgYyk7CiAgICAgIGJhcnljZW50cmljV2VpZ2h0cyh4LCB5LCBhLngsIGEueSwgYi54LCBiLnksIGMueCwgYy55LCBnZXRIZWlnaHRBdF93ZWlnaHRzKTsKICAgICAgY29uc3QgdyA9IGdldEhlaWdodEF0X3dlaWdodHM7CgogICAgICBpZiAodXBwZXIpIHsKICAgICAgICAvLyBUb3AgdHJpYW5nbGUgdmVydHMKICAgICAgICByZXR1cm4gZGF0YVt4aSArIDFdW3lpICsgMV0gKiB3LnggKyBkYXRhW3hpXVt5aSArIDFdICogdy55ICsgZGF0YVt4aSArIDFdW3lpXSAqIHcuejsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBUb3AgdHJpYW5nbGUgdmVydHMKICAgICAgICByZXR1cm4gZGF0YVt4aV1beWldICogdy54ICsgZGF0YVt4aSArIDFdW3lpXSAqIHcueSArIGRhdGFbeGldW3lpICsgMV0gKiB3Lno7CiAgICAgIH0KICAgIH0KCiAgICBnZXRDYWNoZUNvbnZleFRyaWFuZ2xlUGlsbGFyS2V5KHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSkgewogICAgICByZXR1cm4gYCR7eGl9XyR7eWl9XyR7Z2V0VXBwZXJUcmlhbmdsZSA/IDEgOiAwfWA7CiAgICB9CgogICAgZ2V0Q2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGksIHlpLCBnZXRVcHBlclRyaWFuZ2xlKSB7CiAgICAgIHJldHVybiB0aGlzLl9jYWNoZWRQaWxsYXJzW3RoaXMuZ2V0Q2FjaGVDb252ZXhUcmlhbmdsZVBpbGxhcktleSh4aSwgeWksIGdldFVwcGVyVHJpYW5nbGUpXTsKICAgIH0KCiAgICBzZXRDYWNoZWRDb252ZXhUcmlhbmdsZVBpbGxhcih4aSwgeWksIGdldFVwcGVyVHJpYW5nbGUsIGNvbnZleCwgb2Zmc2V0KSB7CiAgICAgIHRoaXMuX2NhY2hlZFBpbGxhcnNbdGhpcy5nZXRDYWNoZUNvbnZleFRyaWFuZ2xlUGlsbGFyS2V5KHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSldID0gewogICAgICAgIGNvbnZleCwKICAgICAgICBvZmZzZXQKICAgICAgfTsKICAgIH0KCiAgICBjbGVhckNhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSkgewogICAgICBkZWxldGUgdGhpcy5fY2FjaGVkUGlsbGFyc1t0aGlzLmdldENhY2hlQ29udmV4VHJpYW5nbGVQaWxsYXJLZXkoeGksIHlpLCBnZXRVcHBlclRyaWFuZ2xlKV07CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhIHRyaWFuZ2xlIGZyb20gdGhlIGhlaWdodGZpZWxkCiAgICAgKi8KCgogICAgZ2V0VHJpYW5nbGUoeGksIHlpLCB1cHBlciwgYSwgYiwgYykgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgICBjb25zdCBlbGVtZW50U2l6ZSA9IHRoaXMuZWxlbWVudFNpemU7CgogICAgICBpZiAodXBwZXIpIHsKICAgICAgICAvLyBUb3AgdHJpYW5nbGUgdmVydHMKICAgICAgICBhLnNldCgoeGkgKyAxKSAqIGVsZW1lbnRTaXplLCAoeWkgKyAxKSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpICsgMV1beWkgKyAxXSk7CiAgICAgICAgYi5zZXQoeGkgKiBlbGVtZW50U2l6ZSwgKHlpICsgMSkgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aV1beWkgKyAxXSk7CiAgICAgICAgYy5zZXQoKHhpICsgMSkgKiBlbGVtZW50U2l6ZSwgeWkgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aSArIDFdW3lpXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVG9wIHRyaWFuZ2xlIHZlcnRzCiAgICAgICAgYS5zZXQoeGkgKiBlbGVtZW50U2l6ZSwgeWkgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aV1beWldKTsKICAgICAgICBiLnNldCgoeGkgKyAxKSAqIGVsZW1lbnRTaXplLCB5aSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpICsgMV1beWldKTsKICAgICAgICBjLnNldCh4aSAqIGVsZW1lbnRTaXplLCAoeWkgKyAxKSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpXVt5aSArIDFdKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBHZXQgYSB0cmlhbmdsZSBpbiB0aGUgdGVycmFpbiBpbiB0aGUgZm9ybSBvZiBhIHRyaWFuZ3VsYXIgY29udmV4IHNoYXBlLgogICAgICovCgoKICAgIGdldENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSkgewogICAgICBsZXQgcmVzdWx0ID0gdGhpcy5waWxsYXJDb252ZXg7CiAgICAgIGxldCBvZmZzZXRSZXN1bHQgPSB0aGlzLnBpbGxhck9mZnNldDsKCiAgICAgIGlmICh0aGlzLmNhY2hlRW5hYmxlZCkgewogICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmdldENhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSk7CgogICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICB0aGlzLnBpbGxhckNvbnZleCA9IGRhdGEuY29udmV4OwogICAgICAgICAgdGhpcy5waWxsYXJPZmZzZXQgPSBkYXRhLm9mZnNldDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHJlc3VsdCA9IG5ldyBDb252ZXhQb2x5aGVkcm9uKCk7CiAgICAgICAgb2Zmc2V0UmVzdWx0ID0gbmV3IFZlYzMoKTsKICAgICAgICB0aGlzLnBpbGxhckNvbnZleCA9IHJlc3VsdDsKICAgICAgICB0aGlzLnBpbGxhck9mZnNldCA9IG9mZnNldFJlc3VsdDsKICAgICAgfQoKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTsKICAgICAgY29uc3QgZWxlbWVudFNpemUgPSB0aGlzLmVsZW1lbnRTaXplOwogICAgICBjb25zdCBmYWNlcyA9IHJlc3VsdC5mYWNlczsgLy8gUmV1c2UgdmVydHMgaWYgcG9zc2libGUKCiAgICAgIHJlc3VsdC52ZXJ0aWNlcy5sZW5ndGggPSA2OwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpKyspIHsKICAgICAgICBpZiAoIXJlc3VsdC52ZXJ0aWNlc1tpXSkgewogICAgICAgICAgcmVzdWx0LnZlcnRpY2VzW2ldID0gbmV3IFZlYzMoKTsKICAgICAgICB9CiAgICAgIH0gLy8gUmV1c2UgZmFjZXMgaWYgcG9zc2libGUKCgogICAgICBmYWNlcy5sZW5ndGggPSA1OwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1OyBpKyspIHsKICAgICAgICBpZiAoIWZhY2VzW2ldKSB7CiAgICAgICAgICBmYWNlc1tpXSA9IFtdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgdmVydHMgPSByZXN1bHQudmVydGljZXM7CiAgICAgIGNvbnN0IGggPSAoTWF0aC5taW4oZGF0YVt4aV1beWldLCBkYXRhW3hpICsgMV1beWldLCBkYXRhW3hpXVt5aSArIDFdLCBkYXRhW3hpICsgMV1beWkgKyAxXSkgLSB0aGlzLm1pblZhbHVlKSAvIDIgKyB0aGlzLm1pblZhbHVlOwoKICAgICAgaWYgKCFnZXRVcHBlclRyaWFuZ2xlKSB7CiAgICAgICAgLy8gQ2VudGVyIG9mIHRoZSB0cmlhbmdsZSBwaWxsYXIgLSBhbGwgcG9seWdvbnMgYXJlIGdpdmVuIHJlbGF0aXZlIHRvIHRoaXMgb25lCiAgICAgICAgb2Zmc2V0UmVzdWx0LnNldCgoeGkgKyAwLjI1KSAqIGVsZW1lbnRTaXplLCAvLyBzb3J0IG9mIGNlbnRlciBvZiBhIHRyaWFuZ2xlCiAgICAgICAgKHlpICsgMC4yNSkgKiBlbGVtZW50U2l6ZSwgaCAvLyB2ZXJ0aWNhbCBjZW50ZXIKICAgICAgICApOyAvLyBUb3AgdHJpYW5nbGUgdmVydHMKCiAgICAgICAgdmVydHNbMF0uc2V0KC0wLjI1ICogZWxlbWVudFNpemUsIC0wLjI1ICogZWxlbWVudFNpemUsIGRhdGFbeGldW3lpXSAtIGgpOwogICAgICAgIHZlcnRzWzFdLnNldCgwLjc1ICogZWxlbWVudFNpemUsIC0wLjI1ICogZWxlbWVudFNpemUsIGRhdGFbeGkgKyAxXVt5aV0gLSBoKTsKICAgICAgICB2ZXJ0c1syXS5zZXQoLTAuMjUgKiBlbGVtZW50U2l6ZSwgMC43NSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpXVt5aSArIDFdIC0gaCk7IC8vIGJvdHRvbSB0cmlhbmdsZSB2ZXJ0cwoKICAgICAgICB2ZXJ0c1szXS5zZXQoLTAuMjUgKiBlbGVtZW50U2l6ZSwgLTAuMjUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7CiAgICAgICAgdmVydHNbNF0uc2V0KDAuNzUgKiBlbGVtZW50U2l6ZSwgLTAuMjUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7CiAgICAgICAgdmVydHNbNV0uc2V0KC0wLjI1ICogZWxlbWVudFNpemUsIDAuNzUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7IC8vIHRvcCB0cmlhbmdsZQoKICAgICAgICBmYWNlc1swXVswXSA9IDA7CiAgICAgICAgZmFjZXNbMF1bMV0gPSAxOwogICAgICAgIGZhY2VzWzBdWzJdID0gMjsgLy8gYm90dG9tIHRyaWFuZ2xlCgogICAgICAgIGZhY2VzWzFdWzBdID0gNTsKICAgICAgICBmYWNlc1sxXVsxXSA9IDQ7CiAgICAgICAgZmFjZXNbMV1bMl0gPSAzOyAvLyAteCBmYWNpbmcgcXVhZAoKICAgICAgICBmYWNlc1syXVswXSA9IDA7CiAgICAgICAgZmFjZXNbMl1bMV0gPSAyOwogICAgICAgIGZhY2VzWzJdWzJdID0gNTsKICAgICAgICBmYWNlc1syXVszXSA9IDM7IC8vIC15IGZhY2luZyBxdWFkCgogICAgICAgIGZhY2VzWzNdWzBdID0gMTsKICAgICAgICBmYWNlc1szXVsxXSA9IDA7CiAgICAgICAgZmFjZXNbM11bMl0gPSAzOwogICAgICAgIGZhY2VzWzNdWzNdID0gNDsgLy8gK3h5IGZhY2luZyBxdWFkCgogICAgICAgIGZhY2VzWzRdWzBdID0gNDsKICAgICAgICBmYWNlc1s0XVsxXSA9IDU7CiAgICAgICAgZmFjZXNbNF1bMl0gPSAyOwogICAgICAgIGZhY2VzWzRdWzNdID0gMTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBDZW50ZXIgb2YgdGhlIHRyaWFuZ2xlIHBpbGxhciAtIGFsbCBwb2x5Z29ucyBhcmUgZ2l2ZW4gcmVsYXRpdmUgdG8gdGhpcyBvbmUKICAgICAgICBvZmZzZXRSZXN1bHQuc2V0KCh4aSArIDAuNzUpICogZWxlbWVudFNpemUsIC8vIHNvcnQgb2YgY2VudGVyIG9mIGEgdHJpYW5nbGUKICAgICAgICAoeWkgKyAwLjc1KSAqIGVsZW1lbnRTaXplLCBoIC8vIHZlcnRpY2FsIGNlbnRlcgogICAgICAgICk7IC8vIFRvcCB0cmlhbmdsZSB2ZXJ0cwoKICAgICAgICB2ZXJ0c1swXS5zZXQoMC4yNSAqIGVsZW1lbnRTaXplLCAwLjI1ICogZWxlbWVudFNpemUsIGRhdGFbeGkgKyAxXVt5aSArIDFdIC0gaCk7CiAgICAgICAgdmVydHNbMV0uc2V0KC0wLjc1ICogZWxlbWVudFNpemUsIDAuMjUgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aV1beWkgKyAxXSAtIGgpOwogICAgICAgIHZlcnRzWzJdLnNldCgwLjI1ICogZWxlbWVudFNpemUsIC0wLjc1ICogZWxlbWVudFNpemUsIGRhdGFbeGkgKyAxXVt5aV0gLSBoKTsgLy8gYm90dG9tIHRyaWFuZ2xlIHZlcnRzCgogICAgICAgIHZlcnRzWzNdLnNldCgwLjI1ICogZWxlbWVudFNpemUsIDAuMjUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7CiAgICAgICAgdmVydHNbNF0uc2V0KC0wLjc1ICogZWxlbWVudFNpemUsIDAuMjUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7CiAgICAgICAgdmVydHNbNV0uc2V0KDAuMjUgKiBlbGVtZW50U2l6ZSwgLTAuNzUgKiBlbGVtZW50U2l6ZSwgLU1hdGguYWJzKGgpIC0gMSk7IC8vIFRvcCB0cmlhbmdsZQoKICAgICAgICBmYWNlc1swXVswXSA9IDA7CiAgICAgICAgZmFjZXNbMF1bMV0gPSAxOwogICAgICAgIGZhY2VzWzBdWzJdID0gMjsgLy8gYm90dG9tIHRyaWFuZ2xlCgogICAgICAgIGZhY2VzWzFdWzBdID0gNTsKICAgICAgICBmYWNlc1sxXVsxXSA9IDQ7CiAgICAgICAgZmFjZXNbMV1bMl0gPSAzOyAvLyAreCBmYWNpbmcgcXVhZAoKICAgICAgICBmYWNlc1syXVswXSA9IDI7CiAgICAgICAgZmFjZXNbMl1bMV0gPSA1OwogICAgICAgIGZhY2VzWzJdWzJdID0gMzsKICAgICAgICBmYWNlc1syXVszXSA9IDA7IC8vICt5IGZhY2luZyBxdWFkCgogICAgICAgIGZhY2VzWzNdWzBdID0gMzsKICAgICAgICBmYWNlc1szXVsxXSA9IDQ7CiAgICAgICAgZmFjZXNbM11bMl0gPSAxOwogICAgICAgIGZhY2VzWzNdWzNdID0gMDsgLy8gLXh5IGZhY2luZyBxdWFkCgogICAgICAgIGZhY2VzWzRdWzBdID0gMTsKICAgICAgICBmYWNlc1s0XVsxXSA9IDQ7CiAgICAgICAgZmFjZXNbNF1bMl0gPSA1OwogICAgICAgIGZhY2VzWzRdWzNdID0gMjsKICAgICAgfQoKICAgICAgcmVzdWx0LmNvbXB1dGVOb3JtYWxzKCk7CiAgICAgIHJlc3VsdC5jb21wdXRlRWRnZXMoKTsKICAgICAgcmVzdWx0LnVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCk7CiAgICAgIHRoaXMuc2V0Q2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGksIHlpLCBnZXRVcHBlclRyaWFuZ2xlLCByZXN1bHQsIG9mZnNldFJlc3VsdCk7CiAgICB9CgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0YXJnZXQuc2V0KDAsIDAsIDApOwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQoKICAgIHZvbHVtZSgpIHsKICAgICAgcmV0dXJuICgvLyBUaGUgdGVycmFpbiBpcyBpbmZpbml0ZQogICAgICAgIE51bWJlci5NQVhfVkFMVUUKICAgICAgKTsKICAgIH0KCiAgICBjYWxjdWxhdGVXb3JsZEFBQkIocG9zLCBxdWF0LCBtaW4sIG1heCkgewogICAgICAvKiogQFRPRE8gZG8gaXQgcHJvcGVybHkgKi8KICAgICAgbWluLnNldCgtTnVtYmVyLk1BWF9WQUxVRSwgLU51bWJlci5NQVhfVkFMVUUsIC1OdW1iZXIuTUFYX1ZBTFVFKTsKICAgICAgbWF4LnNldChOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFKTsKICAgIH0KCiAgICB1cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpIHsKICAgICAgLy8gVXNlIHRoZSBib3VuZGluZyBib3ggb2YgdGhlIG1pbi9tYXggdmFsdWVzCiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGNvbnN0IHMgPSB0aGlzLmVsZW1lbnRTaXplOwogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlUmFkaXVzID0gbmV3IFZlYzMoZGF0YS5sZW5ndGggKiBzLCBkYXRhWzBdLmxlbmd0aCAqIHMsIE1hdGgubWF4KE1hdGguYWJzKHRoaXMubWF4VmFsdWUpLCBNYXRoLmFicyh0aGlzLm1pblZhbHVlKSkpLmxlbmd0aCgpOwogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBoZWlnaHQgdmFsdWVzIGZyb20gYW4gaW1hZ2UuIEN1cnJlbnRseSBvbmx5IHN1cHBvcnRlZCBpbiBicm93c2VyLgogICAgICovCgoKICAgIHNldEhlaWdodHNGcm9tSW1hZ2UoaW1hZ2UsIHNjYWxlKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICB4LAogICAgICAgIHosCiAgICAgICAgeQogICAgICB9ID0gc2NhbGU7CiAgICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICBjYW52YXMud2lkdGggPSBpbWFnZS53aWR0aDsKICAgICAgY2FudmFzLmhlaWdodCA9IGltYWdlLmhlaWdodDsKICAgICAgY29uc3QgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwogICAgICBjb250ZXh0LmRyYXdJbWFnZShpbWFnZSwgMCwgMCk7CiAgICAgIGNvbnN0IGltYWdlRGF0YSA9IGNvbnRleHQuZ2V0SW1hZ2VEYXRhKDAsIDAsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQpOwogICAgICBjb25zdCBtYXRyaXggPSB0aGlzLmRhdGE7CiAgICAgIG1hdHJpeC5sZW5ndGggPSAwOwogICAgICB0aGlzLmVsZW1lbnRTaXplID0gTWF0aC5hYnMoeCkgLyBpbWFnZURhdGEud2lkdGg7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGltYWdlRGF0YS5oZWlnaHQ7IGkrKykgewogICAgICAgIGNvbnN0IHJvdyA9IFtdOwoKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGltYWdlRGF0YS53aWR0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBhID0gaW1hZ2VEYXRhLmRhdGFbKGkgKiBpbWFnZURhdGEuaGVpZ2h0ICsgaikgKiA0XTsKICAgICAgICAgIGNvbnN0IGIgPSBpbWFnZURhdGEuZGF0YVsoaSAqIGltYWdlRGF0YS5oZWlnaHQgKyBqKSAqIDQgKyAxXTsKICAgICAgICAgIGNvbnN0IGMgPSBpbWFnZURhdGEuZGF0YVsoaSAqIGltYWdlRGF0YS5oZWlnaHQgKyBqKSAqIDQgKyAyXTsKICAgICAgICAgIGNvbnN0IGhlaWdodCA9IChhICsgYiArIGMpIC8gNCAvIDI1NSAqIHo7CgogICAgICAgICAgaWYgKHggPCAwKSB7CiAgICAgICAgICAgIHJvdy5wdXNoKGhlaWdodCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb3cudW5zaGlmdChoZWlnaHQpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHkgPCAwKSB7CiAgICAgICAgICBtYXRyaXgudW5zaGlmdChyb3cpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtYXRyaXgucHVzaChyb3cpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy51cGRhdGVNYXhWYWx1ZSgpOwogICAgICB0aGlzLnVwZGF0ZU1pblZhbHVlKCk7CiAgICAgIHRoaXMudXBkYXRlKCk7CiAgICB9CgogIH0KICBjb25zdCBnZXRIZWlnaHRBdF9pZHggPSBbXTsKICBjb25zdCBnZXRIZWlnaHRBdF93ZWlnaHRzID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXRIZWlnaHRBdF9hID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXRIZWlnaHRBdF9iID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXRIZWlnaHRBdF9jID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9hID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9iID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9jID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9lMCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgZ2V0Tm9ybWFsQXRfZTEgPSBuZXcgVmVjMygpOyAvLyBmcm9tIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0JhcnljZW50cmljX2Nvb3JkaW5hdGVfc3lzdGVtCgogIGZ1bmN0aW9uIGJhcnljZW50cmljV2VpZ2h0cyh4LCB5LCBheCwgYXksIGJ4LCBieSwgY3gsIGN5LCByZXN1bHQpIHsKICAgIHJlc3VsdC54ID0gKChieSAtIGN5KSAqICh4IC0gY3gpICsgKGN4IC0gYngpICogKHkgLSBjeSkpIC8gKChieSAtIGN5KSAqIChheCAtIGN4KSArIChjeCAtIGJ4KSAqIChheSAtIGN5KSk7CiAgICByZXN1bHQueSA9ICgoY3kgLSBheSkgKiAoeCAtIGN4KSArIChheCAtIGN4KSAqICh5IC0gY3kpKSAvICgoYnkgLSBjeSkgKiAoYXggLSBjeCkgKyAoY3ggLSBieCkgKiAoYXkgLSBjeSkpOwogICAgcmVzdWx0LnogPSAxIC0gcmVzdWx0LnggLSByZXN1bHQueTsKICB9CgogIC8qKgogICAqIE9jdHJlZU5vZGUKICAgKi8KICBjbGFzcyBPY3RyZWVOb2RlIHsKICAgIC8qKiBUaGUgcm9vdCBub2RlICovCgogICAgLyoqIEJvdW5kYXJ5IG9mIHRoaXMgbm9kZSAqLwoKICAgIC8qKiBDb250YWluZWQgZGF0YSBhdCB0aGUgY3VycmVudCBub2RlIGxldmVsICovCgogICAgLyoqIENoaWxkcmVuIHRvIHRoaXMgbm9kZSAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLnJvb3QgPSBvcHRpb25zLnJvb3QgfHwgbnVsbDsKICAgICAgdGhpcy5hYWJiID0gb3B0aW9ucy5hYWJiID8gb3B0aW9ucy5hYWJiLmNsb25lKCkgOiBuZXcgQUFCQigpOwogICAgICB0aGlzLmRhdGEgPSBbXTsKICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgfQogICAgLyoqCiAgICAgKiByZXNldAogICAgICovCgoKICAgIHJlc2V0KCkgewogICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCA9IHRoaXMuZGF0YS5sZW5ndGggPSAwOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnQgZGF0YSBpbnRvIHRoaXMgbm9kZQogICAgICogQHJldHVybiBUcnVlIGlmIHN1Y2Nlc3NmdWwsIG90aGVyd2lzZSBmYWxzZQogICAgICovCgoKICAgIGluc2VydChhYWJiLCBlbGVtZW50RGF0YSwgbGV2ZWwpIHsKICAgICAgaWYgKGxldmVsID09PSB2b2lkIDApIHsKICAgICAgICBsZXZlbCA9IDA7CiAgICAgIH0KCiAgICAgIGNvbnN0IG5vZGVEYXRhID0gdGhpcy5kYXRhOyAvLyBJZ25vcmUgb2JqZWN0cyB0aGF0IGRvIG5vdCBiZWxvbmcgaW4gdGhpcyBub2RlCgogICAgICBpZiAoIXRoaXMuYWFiYi5jb250YWlucyhhYWJiKSkgewogICAgICAgIHJldHVybiBmYWxzZTsgLy8gb2JqZWN0IGNhbm5vdCBiZSBhZGRlZAogICAgICB9CgogICAgICBjb25zdCBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW47CiAgICAgIGNvbnN0IG1heERlcHRoID0gdGhpcy5tYXhEZXB0aCB8fCB0aGlzLnJvb3QubWF4RGVwdGg7CgogICAgICBpZiAobGV2ZWwgPCBtYXhEZXB0aCkgewogICAgICAgIC8vIFN1YmRpdmlkZSBpZiB0aGVyZSBhcmUgbm8gY2hpbGRyZW4geWV0CiAgICAgICAgbGV0IHN1YmRpdmlkZWQgPSBmYWxzZTsKCiAgICAgICAgaWYgKCFjaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMuc3ViZGl2aWRlKCk7CiAgICAgICAgICBzdWJkaXZpZGVkID0gdHJ1ZTsKICAgICAgICB9IC8vIGFkZCB0byB3aGljaGV2ZXIgbm9kZSB3aWxsIGFjY2VwdCBpdAoKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IDg7IGkrKykgewogICAgICAgICAgaWYgKGNoaWxkcmVuW2ldLmluc2VydChhYWJiLCBlbGVtZW50RGF0YSwgbGV2ZWwgKyAxKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChzdWJkaXZpZGVkKSB7CiAgICAgICAgICAvLyBObyBjaGlsZHJlbiBhY2NlcHRlZCEgTWlnaHQgYXMgd2VsbCBqdXN0IHJlbW92ZSBlbSBzaW5jZSB0aGV5IGNvbnRhaW4gbm9uZQogICAgICAgICAgY2hpbGRyZW4ubGVuZ3RoID0gMDsKICAgICAgICB9CiAgICAgIH0gLy8gVG9vIGRlZXAsIG9yIGNoaWxkcmVuIGRpZG50IHdhbnQgaXQuIGFkZCBpdCBpbiBjdXJyZW50IG5vZGUKCgogICAgICBub2RlRGF0YS5wdXNoKGVsZW1lbnREYXRhKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIENyZWF0ZSA4IGVxdWFsbHkgc2l6ZWQgY2hpbGRyZW4gbm9kZXMgYW5kIHB1dCB0aGVtIGluIHRoZSBgY2hpbGRyZW5gIGFycmF5LgogICAgICovCgoKICAgIHN1YmRpdmlkZSgpIHsKICAgICAgY29uc3QgYWFiYiA9IHRoaXMuYWFiYjsKICAgICAgY29uc3QgbCA9IGFhYmIubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdSA9IGFhYmIudXBwZXJCb3VuZDsKICAgICAgY29uc3QgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgICBjaGlsZHJlbi5wdXNoKG5ldyBPY3RyZWVOb2RlKHsKICAgICAgICBhYWJiOiBuZXcgQUFCQih7CiAgICAgICAgICBsb3dlckJvdW5kOiBuZXcgVmVjMygwLCAwLCAwKQogICAgICAgIH0pCiAgICAgIH0pLCBuZXcgT2N0cmVlTm9kZSh7CiAgICAgICAgYWFiYjogbmV3IEFBQkIoewogICAgICAgICAgbG93ZXJCb3VuZDogbmV3IFZlYzMoMSwgMCwgMCkKICAgICAgICB9KQogICAgICB9KSwgbmV3IE9jdHJlZU5vZGUoewogICAgICAgIGFhYmI6IG5ldyBBQUJCKHsKICAgICAgICAgIGxvd2VyQm91bmQ6IG5ldyBWZWMzKDEsIDEsIDApCiAgICAgICAgfSkKICAgICAgfSksIG5ldyBPY3RyZWVOb2RlKHsKICAgICAgICBhYWJiOiBuZXcgQUFCQih7CiAgICAgICAgICBsb3dlckJvdW5kOiBuZXcgVmVjMygxLCAxLCAxKQogICAgICAgIH0pCiAgICAgIH0pLCBuZXcgT2N0cmVlTm9kZSh7CiAgICAgICAgYWFiYjogbmV3IEFBQkIoewogICAgICAgICAgbG93ZXJCb3VuZDogbmV3IFZlYzMoMCwgMSwgMSkKICAgICAgICB9KQogICAgICB9KSwgbmV3IE9jdHJlZU5vZGUoewogICAgICAgIGFhYmI6IG5ldyBBQUJCKHsKICAgICAgICAgIGxvd2VyQm91bmQ6IG5ldyBWZWMzKDAsIDAsIDEpCiAgICAgICAgfSkKICAgICAgfSksIG5ldyBPY3RyZWVOb2RlKHsKICAgICAgICBhYWJiOiBuZXcgQUFCQih7CiAgICAgICAgICBsb3dlckJvdW5kOiBuZXcgVmVjMygxLCAwLCAxKQogICAgICAgIH0pCiAgICAgIH0pLCBuZXcgT2N0cmVlTm9kZSh7CiAgICAgICAgYWFiYjogbmV3IEFBQkIoewogICAgICAgICAgbG93ZXJCb3VuZDogbmV3IFZlYzMoMCwgMSwgMCkKICAgICAgICB9KQogICAgICB9KSk7CiAgICAgIHUudnN1YihsLCBoYWxmRGlhZ29uYWwpOwogICAgICBoYWxmRGlhZ29uYWwuc2NhbGUoMC41LCBoYWxmRGlhZ29uYWwpOwogICAgICBjb25zdCByb290ID0gdGhpcy5yb290IHx8IHRoaXM7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gODsgaSsrKSB7CiAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsgLy8gU2V0IGN1cnJlbnQgbm9kZSBhcyByb290CgogICAgICAgIGNoaWxkLnJvb3QgPSByb290OyAvLyBDb21wdXRlIGJvdW5kcwoKICAgICAgICBjb25zdCBsb3dlckJvdW5kID0gY2hpbGQuYWFiYi5sb3dlckJvdW5kOwogICAgICAgIGxvd2VyQm91bmQueCAqPSBoYWxmRGlhZ29uYWwueDsKICAgICAgICBsb3dlckJvdW5kLnkgKj0gaGFsZkRpYWdvbmFsLnk7CiAgICAgICAgbG93ZXJCb3VuZC56ICo9IGhhbGZEaWFnb25hbC56OwogICAgICAgIGxvd2VyQm91bmQudmFkZChsLCBsb3dlckJvdW5kKTsgLy8gVXBwZXIgYm91bmQgaXMgYWx3YXlzIGxvd2VyIGJvdW5kICsgaGFsZkRpYWdvbmFsCgogICAgICAgIGxvd2VyQm91bmQudmFkZChoYWxmRGlhZ29uYWwsIGNoaWxkLmFhYmIudXBwZXJCb3VuZCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogR2V0IGFsbCBkYXRhLCBwb3RlbnRpYWxseSB3aXRoaW4gYW4gQUFCQgogICAgICogQHJldHVybiBUaGUgInJlc3VsdCIgb2JqZWN0CiAgICAgKi8KCgogICAgYWFiYlF1ZXJ5KGFhYmIsIHJlc3VsdCkgewogICAgICB0aGlzLmRhdGE7IC8vIGFib3J0IGlmIHRoZSByYW5nZSBkb2VzIG5vdCBpbnRlcnNlY3QgdGhpcyBub2RlCiAgICAgIC8vIGlmICghdGhpcy5hYWJiLm92ZXJsYXBzKGFhYmIpKXsKICAgICAgLy8gICAgIHJldHVybiByZXN1bHQ7CiAgICAgIC8vIH0KICAgICAgLy8gQWRkIG9iamVjdHMgYXQgdGhpcyBsZXZlbAogICAgICAvLyBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShyZXN1bHQsIG5vZGVEYXRhKTsKICAgICAgLy8gQWRkIGNoaWxkIGRhdGEKICAgICAgLy8gQHRvZG8gdW53cmFwIHJlY3Vyc2lvbiBpbnRvIGEgcXVldWUgLyBsb29wLCB0aGF0J3MgZmFzdGVyIGluIEpTCgogICAgICB0aGlzLmNoaWxkcmVuOyAvLyBmb3IgKGxldCBpID0gMCwgTiA9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpICE9PSBOOyBpKyspIHsKICAgICAgLy8gICAgIGNoaWxkcmVuW2ldLmFhYmJRdWVyeShhYWJiLCByZXN1bHQpOwogICAgICAvLyB9CgogICAgICBjb25zdCBxdWV1ZSA9IFt0aGlzXTsKCiAgICAgIHdoaWxlIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgICBjb25zdCBub2RlID0gcXVldWUucG9wKCk7CgogICAgICAgIGlmIChub2RlLmFhYmIub3ZlcmxhcHMoYWFiYikpIHsKICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHJlc3VsdCwgbm9kZS5kYXRhKTsKICAgICAgICB9CgogICAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHF1ZXVlLCBub2RlLmNoaWxkcmVuKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGFsbCBkYXRhLCBwb3RlbnRpYWxseSBpbnRlcnNlY3RlZCBieSBhIHJheS4KICAgICAqIEByZXR1cm4gVGhlICJyZXN1bHQiIG9iamVjdAogICAgICovCgoKICAgIHJheVF1ZXJ5KHJheSwgdHJlZVRyYW5zZm9ybSwgcmVzdWx0KSB7CiAgICAgIC8vIFVzZSBhYWJiIHF1ZXJ5IGZvciBub3cuCgogICAgICAvKiogQHRvZG8gaW1wbGVtZW50IHJlYWwgcmF5IHF1ZXJ5IHdoaWNoIG5lZWRzIGxlc3MgbG9va3VwcyAqLwogICAgICByYXkuZ2V0QUFCQih0bXBBQUJCKTsKICAgICAgdG1wQUFCQi50b0xvY2FsRnJhbWUodHJlZVRyYW5zZm9ybSwgdG1wQUFCQik7CiAgICAgIHRoaXMuYWFiYlF1ZXJ5KHRtcEFBQkIsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIHJlbW92ZUVtcHR5Tm9kZXMKICAgICAqLwoKCiAgICByZW1vdmVFbXB0eU5vZGVzKCkgewogICAgICBmb3IgKGxldCBpID0gdGhpcy5jaGlsZHJlbi5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIHRoaXMuY2hpbGRyZW5baV0ucmVtb3ZlRW1wdHlOb2RlcygpOwoKICAgICAgICBpZiAoIXRoaXMuY2hpbGRyZW5baV0uY2hpbGRyZW4ubGVuZ3RoICYmICF0aGlzLmNoaWxkcmVuW2ldLmRhdGEubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpLCAxKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgfQogIC8qKgogICAqIE9jdHJlZQogICAqLwoKCiAgY2xhc3MgT2N0cmVlIGV4dGVuZHMgT2N0cmVlTm9kZSB7CiAgICAvKioKICAgICAqIE1heGltdW0gc3ViZGl2aXNpb24gZGVwdGgKICAgICAqIEBkZWZhdWx0IDgKICAgICAqLwoKICAgIC8qKgogICAgICogQHBhcmFtIGFhYmIgVGhlIHRvdGFsIEFBQkIgb2YgdGhlIHRyZWUKICAgICAqLwogICAgY29uc3RydWN0b3IoYWFiYiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBzdXBlcih7CiAgICAgICAgcm9vdDogbnVsbCwKICAgICAgICBhYWJiCiAgICAgIH0pOwogICAgICB0aGlzLm1heERlcHRoID0gdHlwZW9mIG9wdGlvbnMubWF4RGVwdGggIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5tYXhEZXB0aCA6IDg7CiAgICB9CgogIH0KICBjb25zdCBoYWxmRGlhZ29uYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcEFBQkIgPSBuZXcgQUFCQigpOwoKICAvKioKICAgKiBUcmltZXNoLgogICAqIEBleGFtcGxlCiAgICogICAgIC8vIEhvdyB0byBtYWtlIGEgbWVzaCB3aXRoIGEgc2luZ2xlIHRyaWFuZ2xlCiAgICogICAgIGNvbnN0IHZlcnRpY2VzID0gWwogICAqICAgICAgICAgMCwgMCwgMCwgLy8gdmVydGV4IDAKICAgKiAgICAgICAgIDEsIDAsIDAsIC8vIHZlcnRleCAxCiAgICogICAgICAgICAwLCAxLCAwICAvLyB2ZXJ0ZXggMgogICAqICAgICBdCiAgICogICAgIGNvbnN0IGluZGljZXMgPSBbCiAgICogICAgICAgICAwLCAxLCAyICAvLyB0cmlhbmdsZSAwCiAgICogICAgIF0KICAgKiAgICAgY29uc3QgdHJpbWVzaFNoYXBlID0gbmV3IENBTk5PTi5UcmltZXNoKHZlcnRpY2VzLCBpbmRpY2VzKQogICAqLwogIGNsYXNzIFRyaW1lc2ggZXh0ZW5kcyBTaGFwZSB7CiAgICAvKioKICAgICAqIHZlcnRpY2VzCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFycmF5IG9mIGludGVnZXJzLCBpbmRpY2F0aW5nIHdoaWNoIHZlcnRpY2VzIGVhY2ggdHJpYW5nbGUgY29uc2lzdHMgb2YuIFRoZSBsZW5ndGggb2YgdGhpcyBhcnJheSBpcyB0aHVzIDMgdGltZXMgdGhlIG51bWJlciBvZiB0cmlhbmdsZXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBub3JtYWxzIGRhdGEuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBsb2NhbCBBQUJCIG9mIHRoZSBtZXNoLgogICAgICovCgogICAgLyoqCiAgICAgKiBSZWZlcmVuY2VzIHRvIHZlcnRleCBwYWlycywgbWFraW5nIHVwIGFsbCB1bmlxdWUgZWRnZXMgaW4gdGhlIHRyaW1lc2guCiAgICAgKi8KCiAgICAvKioKICAgICAqIExvY2FsIHNjYWxpbmcgb2YgdGhlIG1lc2guIFVzZSAuc2V0U2NhbGUoKSB0byBzZXQgaXQuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBpbmRleGVkIHRyaWFuZ2xlcy4gVXNlIC51cGRhdGVUcmVlKCkgdG8gdXBkYXRlIGl0LgogICAgICovCiAgICBjb25zdHJ1Y3Rvcih2ZXJ0aWNlcywgaW5kaWNlcykgewogICAgICBzdXBlcih7CiAgICAgICAgdHlwZTogU2hhcGUudHlwZXMuVFJJTUVTSAogICAgICB9KTsKICAgICAgdGhpcy52ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkodmVydGljZXMpOwogICAgICB0aGlzLmluZGljZXMgPSBuZXcgSW50MTZBcnJheShpbmRpY2VzKTsKICAgICAgdGhpcy5ub3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheShpbmRpY2VzLmxlbmd0aCk7CiAgICAgIHRoaXMuYWFiYiA9IG5ldyBBQUJCKCk7CiAgICAgIHRoaXMuZWRnZXMgPSBudWxsOwogICAgICB0aGlzLnNjYWxlID0gbmV3IFZlYzMoMSwgMSwgMSk7CiAgICAgIHRoaXMudHJlZSA9IG5ldyBPY3RyZWUoKTsKICAgICAgdGhpcy51cGRhdGVFZGdlcygpOwogICAgICB0aGlzLnVwZGF0ZU5vcm1hbHMoKTsKICAgICAgdGhpcy51cGRhdGVBQUJCKCk7CiAgICAgIHRoaXMudXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKTsKICAgICAgdGhpcy51cGRhdGVUcmVlKCk7CiAgICB9CiAgICAvKioKICAgICAqIHVwZGF0ZVRyZWUKICAgICAqLwoKCiAgICB1cGRhdGVUcmVlKCkgewogICAgICBjb25zdCB0cmVlID0gdGhpcy50cmVlOwogICAgICB0cmVlLnJlc2V0KCk7CiAgICAgIHRyZWUuYWFiYi5jb3B5KHRoaXMuYWFiYik7CiAgICAgIGNvbnN0IHNjYWxlID0gdGhpcy5zY2FsZTsgLy8gVGhlIGxvY2FsIG1lc2ggQUFCQiBpcyBzY2FsZWQsIGJ1dCB0aGUgb2N0cmVlIEFBQkIgc2hvdWxkIGJlIHVuc2NhbGVkCgogICAgICB0cmVlLmFhYmIubG93ZXJCb3VuZC54ICo9IDEgLyBzY2FsZS54OwogICAgICB0cmVlLmFhYmIubG93ZXJCb3VuZC55ICo9IDEgLyBzY2FsZS55OwogICAgICB0cmVlLmFhYmIubG93ZXJCb3VuZC56ICo9IDEgLyBzY2FsZS56OwogICAgICB0cmVlLmFhYmIudXBwZXJCb3VuZC54ICo9IDEgLyBzY2FsZS54OwogICAgICB0cmVlLmFhYmIudXBwZXJCb3VuZC55ICo9IDEgLyBzY2FsZS55OwogICAgICB0cmVlLmFhYmIudXBwZXJCb3VuZC56ICo9IDEgLyBzY2FsZS56OyAvLyBJbnNlcnQgYWxsIHRyaWFuZ2xlcwoKICAgICAgY29uc3QgdHJpYW5nbGVBQUJCID0gbmV3IEFBQkIoKTsKICAgICAgY29uc3QgYSA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGIgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBjID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgcG9pbnRzID0gW2EsIGIsIGNdOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAgICAgLy90aGlzLmdldFRyaWFuZ2xlVmVydGljZXMoaSwgYSwgYiwgYyk7CiAgICAgICAgLy8gR2V0IHVuc2NhbGVkIHRyaWFuZ2xlIHZlcnRzCiAgICAgICAgY29uc3QgaTMgPSBpICogMzsKCiAgICAgICAgdGhpcy5fZ2V0VW5zY2FsZWRWZXJ0ZXgodGhpcy5pbmRpY2VzW2kzXSwgYSk7CgogICAgICAgIHRoaXMuX2dldFVuc2NhbGVkVmVydGV4KHRoaXMuaW5kaWNlc1tpMyArIDFdLCBiKTsKCiAgICAgICAgdGhpcy5fZ2V0VW5zY2FsZWRWZXJ0ZXgodGhpcy5pbmRpY2VzW2kzICsgMl0sIGMpOwoKICAgICAgICB0cmlhbmdsZUFBQkIuc2V0RnJvbVBvaW50cyhwb2ludHMpOwogICAgICAgIHRyZWUuaW5zZXJ0KHRyaWFuZ2xlQUFCQiwgaSk7CiAgICAgIH0KCiAgICAgIHRyZWUucmVtb3ZlRW1wdHlOb2RlcygpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdHJpYW5nbGVzIGluIGEgbG9jYWwgQUFCQiBmcm9tIHRoZSB0cmltZXNoLgogICAgICogQHBhcmFtIHJlc3VsdCBBbiBhcnJheSBvZiBpbnRlZ2VycywgcmVmZXJlbmNpbmcgdGhlIHF1ZXJpZWQgdHJpYW5nbGVzLgogICAgICovCgoKICAgIGdldFRyaWFuZ2xlc0luQUFCQihhYWJiLCByZXN1bHQpIHsKICAgICAgdW5zY2FsZWRBQUJCLmNvcHkoYWFiYik7IC8vIFNjYWxlIGl0IHRvIGxvY2FsCgogICAgICBjb25zdCBzY2FsZSA9IHRoaXMuc2NhbGU7CiAgICAgIGNvbnN0IGlzeCA9IHNjYWxlLng7CiAgICAgIGNvbnN0IGlzeSA9IHNjYWxlLnk7CiAgICAgIGNvbnN0IGlzeiA9IHNjYWxlLno7CiAgICAgIGNvbnN0IGwgPSB1bnNjYWxlZEFBQkIubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdSA9IHVuc2NhbGVkQUFCQi51cHBlckJvdW5kOwogICAgICBsLnggLz0gaXN4OwogICAgICBsLnkgLz0gaXN5OwogICAgICBsLnogLz0gaXN6OwogICAgICB1LnggLz0gaXN4OwogICAgICB1LnkgLz0gaXN5OwogICAgICB1LnogLz0gaXN6OwogICAgICByZXR1cm4gdGhpcy50cmVlLmFhYmJRdWVyeSh1bnNjYWxlZEFBQkIsIHJlc3VsdCk7CiAgICB9CiAgICAvKioKICAgICAqIHNldFNjYWxlCiAgICAgKi8KCgogICAgc2V0U2NhbGUoc2NhbGUpIHsKICAgICAgY29uc3Qgd2FzVW5pZm9ybSA9IHRoaXMuc2NhbGUueCA9PT0gdGhpcy5zY2FsZS55ICYmIHRoaXMuc2NhbGUueSA9PT0gdGhpcy5zY2FsZS56OwogICAgICBjb25zdCBpc1VuaWZvcm0gPSBzY2FsZS54ID09PSBzY2FsZS55ICYmIHNjYWxlLnkgPT09IHNjYWxlLno7CgogICAgICBpZiAoISh3YXNVbmlmb3JtICYmIGlzVW5pZm9ybSkpIHsKICAgICAgICAvLyBOb24tdW5pZm9ybSBzY2FsaW5nLiBOZWVkIHRvIHVwZGF0ZSBub3JtYWxzLgogICAgICAgIHRoaXMudXBkYXRlTm9ybWFscygpOwogICAgICB9CgogICAgICB0aGlzLnNjYWxlLmNvcHkoc2NhbGUpOwogICAgICB0aGlzLnVwZGF0ZUFBQkIoKTsKICAgICAgdGhpcy51cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlIHRoZSBub3JtYWxzIG9mIHRoZSBmYWNlcy4gV2lsbCBzYXZlIGluIHRoZSBgLm5vcm1hbHNgIGFycmF5LgogICAgICovCgoKICAgIHVwZGF0ZU5vcm1hbHMoKSB7CiAgICAgIGNvbnN0IG4gPSBjb21wdXRlTm9ybWFsc19uOyAvLyBHZW5lcmF0ZSBub3JtYWxzCgogICAgICBjb25zdCBub3JtYWxzID0gdGhpcy5ub3JtYWxzOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgICBjb25zdCBhID0gdGhpcy5pbmRpY2VzW2kzXTsKICAgICAgICBjb25zdCBiID0gdGhpcy5pbmRpY2VzW2kzICsgMV07CiAgICAgICAgY29uc3QgYyA9IHRoaXMuaW5kaWNlc1tpMyArIDJdOwogICAgICAgIHRoaXMuZ2V0VmVydGV4KGEsIHZhKTsKICAgICAgICB0aGlzLmdldFZlcnRleChiLCB2Yik7CiAgICAgICAgdGhpcy5nZXRWZXJ0ZXgoYywgdmMpOwogICAgICAgIFRyaW1lc2guY29tcHV0ZU5vcm1hbCh2YiwgdmEsIHZjLCBuKTsKICAgICAgICBub3JtYWxzW2kzXSA9IG4ueDsKICAgICAgICBub3JtYWxzW2kzICsgMV0gPSBuLnk7CiAgICAgICAgbm9ybWFsc1tpMyArIDJdID0gbi56OwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZSB0aGUgYC5lZGdlc2AgcHJvcGVydHkKICAgICAqLwoKCiAgICB1cGRhdGVFZGdlcygpIHsKICAgICAgY29uc3QgZWRnZXMgPSB7fTsKCiAgICAgIGNvbnN0IGFkZCA9IChhLCBiKSA9PiB7CiAgICAgICAgY29uc3Qga2V5ID0gYSA8IGIgPyBgJHthfV8ke2J9YCA6IGAke2J9XyR7YX1gOwogICAgICAgIGVkZ2VzW2tleV0gPSB0cnVlOwogICAgICB9OwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgICBjb25zdCBhID0gdGhpcy5pbmRpY2VzW2kzXTsKICAgICAgICBjb25zdCBiID0gdGhpcy5pbmRpY2VzW2kzICsgMV07CiAgICAgICAgY29uc3QgYyA9IHRoaXMuaW5kaWNlc1tpMyArIDJdOwogICAgICAgIGFkZChhLCBiKTsKICAgICAgICBhZGQoYiwgYyk7CiAgICAgICAgYWRkKGMsIGEpOwogICAgICB9CgogICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZWRnZXMpOwogICAgICB0aGlzLmVkZ2VzID0gbmV3IEludDE2QXJyYXkoa2V5cy5sZW5ndGggKiAyKTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGluZGljZXMgPSBrZXlzW2ldLnNwbGl0KCdfJyk7CiAgICAgICAgdGhpcy5lZGdlc1syICogaV0gPSBwYXJzZUludChpbmRpY2VzWzBdLCAxMCk7CiAgICAgICAgdGhpcy5lZGdlc1syICogaSArIDFdID0gcGFyc2VJbnQoaW5kaWNlc1sxXSwgMTApOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbiBlZGdlIHZlcnRleAogICAgICogQHBhcmFtIGZpcnN0T3JTZWNvbmQgMCBvciAxLCBkZXBlbmRpbmcgb24gd2hpY2ggb25lIG9mIHRoZSB2ZXJ0aWNlcyB5b3UgbmVlZC4KICAgICAqIEBwYXJhbSB2ZXJ0ZXhTdG9yZSBXaGVyZSB0byBzdG9yZSB0aGUgcmVzdWx0CiAgICAgKi8KCgogICAgZ2V0RWRnZVZlcnRleChlZGdlSW5kZXgsIGZpcnN0T3JTZWNvbmQsIHZlcnRleFN0b3JlKSB7CiAgICAgIGNvbnN0IHZlcnRleEluZGV4ID0gdGhpcy5lZGdlc1tlZGdlSW5kZXggKiAyICsgKGZpcnN0T3JTZWNvbmQgPyAxIDogMCldOwogICAgICB0aGlzLmdldFZlcnRleCh2ZXJ0ZXhJbmRleCwgdmVydGV4U3RvcmUpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgYSB2ZWN0b3IgYWxvbmcgYW4gZWRnZS4KICAgICAqLwoKCiAgICBnZXRFZGdlVmVjdG9yKGVkZ2VJbmRleCwgdmVjdG9yU3RvcmUpIHsKICAgICAgY29uc3QgdmEgPSBnZXRFZGdlVmVjdG9yX3ZhOwogICAgICBjb25zdCB2YiA9IGdldEVkZ2VWZWN0b3JfdmI7CiAgICAgIHRoaXMuZ2V0RWRnZVZlcnRleChlZGdlSW5kZXgsIDAsIHZhKTsKICAgICAgdGhpcy5nZXRFZGdlVmVydGV4KGVkZ2VJbmRleCwgMSwgdmIpOwogICAgICB2Yi52c3ViKHZhLCB2ZWN0b3JTdG9yZSk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBmYWNlIG5vcm1hbCBnaXZlbiAzIHZlcnRpY2VzCiAgICAgKi8KCgogICAgc3RhdGljIGNvbXB1dGVOb3JtYWwodmEsIHZiLCB2YywgdGFyZ2V0KSB7CiAgICAgIHZiLnZzdWIodmEsIGFiKTsKICAgICAgdmMudnN1Yih2YiwgY2IpOwogICAgICBjYi5jcm9zcyhhYiwgdGFyZ2V0KTsKCiAgICAgIGlmICghdGFyZ2V0LmlzWmVybygpKSB7CiAgICAgICAgdGFyZ2V0Lm5vcm1hbGl6ZSgpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCB2ZXJ0ZXggaS4KICAgICAqIEByZXR1cm4gVGhlICJvdXQiIHZlY3RvciBvYmplY3QKICAgICAqLwoKCiAgICBnZXRWZXJ0ZXgoaSwgb3V0KSB7CiAgICAgIGNvbnN0IHNjYWxlID0gdGhpcy5zY2FsZTsKCiAgICAgIHRoaXMuX2dldFVuc2NhbGVkVmVydGV4KGksIG91dCk7CgogICAgICBvdXQueCAqPSBzY2FsZS54OwogICAgICBvdXQueSAqPSBzY2FsZS55OwogICAgICBvdXQueiAqPSBzY2FsZS56OwogICAgICByZXR1cm4gb3V0OwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgcmF3IHZlcnRleCBpCiAgICAgKiBAcmV0dXJuIFRoZSAib3V0IiB2ZWN0b3Igb2JqZWN0CiAgICAgKi8KCgogICAgX2dldFVuc2NhbGVkVmVydGV4KGksIG91dCkgewogICAgICBjb25zdCBpMyA9IGkgKiAzOwogICAgICBjb25zdCB2ZXJ0aWNlcyA9IHRoaXMudmVydGljZXM7CiAgICAgIHJldHVybiBvdXQuc2V0KHZlcnRpY2VzW2kzXSwgdmVydGljZXNbaTMgKyAxXSwgdmVydGljZXNbaTMgKyAyXSk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhIHZlcnRleCBmcm9tIHRoZSB0cmltZXNoLHRyYW5zZm9ybWVkIGJ5IHRoZSBnaXZlbiBwb3NpdGlvbiBhbmQgcXVhdGVybmlvbi4KICAgICAqIEByZXR1cm4gVGhlICJvdXQiIHZlY3RvciBvYmplY3QKICAgICAqLwoKCiAgICBnZXRXb3JsZFZlcnRleChpLCBwb3MsIHF1YXQsIG91dCkgewogICAgICB0aGlzLmdldFZlcnRleChpLCBvdXQpOwogICAgICBUcmFuc2Zvcm0ucG9pbnRUb1dvcmxkRnJhbWUocG9zLCBxdWF0LCBvdXQsIG91dCk7CiAgICAgIHJldHVybiBvdXQ7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgdGhyZWUgdmVydGljZXMgZm9yIHRyaWFuZ2xlIGkuCiAgICAgKi8KCgogICAgZ2V0VHJpYW5nbGVWZXJ0aWNlcyhpLCBhLCBiLCBjKSB7CiAgICAgIGNvbnN0IGkzID0gaSAqIDM7CiAgICAgIHRoaXMuZ2V0VmVydGV4KHRoaXMuaW5kaWNlc1tpM10sIGEpOwogICAgICB0aGlzLmdldFZlcnRleCh0aGlzLmluZGljZXNbaTMgKyAxXSwgYik7CiAgICAgIHRoaXMuZ2V0VmVydGV4KHRoaXMuaW5kaWNlc1tpMyArIDJdLCBjKTsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZSB0aGUgbm9ybWFsIG9mIHRyaWFuZ2xlIGkuCiAgICAgKiBAcmV0dXJuIFRoZSAidGFyZ2V0IiB2ZWN0b3Igb2JqZWN0CiAgICAgKi8KCgogICAgZ2V0Tm9ybWFsKGksIHRhcmdldCkgewogICAgICBjb25zdCBpMyA9IGkgKiAzOwogICAgICByZXR1cm4gdGFyZ2V0LnNldCh0aGlzLm5vcm1hbHNbaTNdLCB0aGlzLm5vcm1hbHNbaTMgKyAxXSwgdGhpcy5ub3JtYWxzW2kzICsgMl0pOwogICAgfQogICAgLyoqCiAgICAgKiBAcmV0dXJuIFRoZSAidGFyZ2V0IiB2ZWN0b3Igb2JqZWN0CiAgICAgKi8KCgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICAvLyBBcHByb3hpbWF0ZSB3aXRoIGJveCBpbmVydGlhCiAgICAgIC8vIEV4YWN0IGluZXJ0aWEgY2FsY3VsYXRpb24gaXMgb3ZlcmtpbGwsIGJ1dCBzZWUgaHR0cDovL2dlb21ldHJpY3Rvb2xzLmNvbS9Eb2N1bWVudGF0aW9uL1BvbHloZWRyYWxNYXNzUHJvcGVydGllcy5wZGYgZm9yIHRoZSBjb3JyZWN0IHdheSB0byBkbyBpdAogICAgICB0aGlzLmNvbXB1dGVMb2NhbEFBQkIoY2xpX2FhYmIpOwogICAgICBjb25zdCB4ID0gY2xpX2FhYmIudXBwZXJCb3VuZC54IC0gY2xpX2FhYmIubG93ZXJCb3VuZC54OwogICAgICBjb25zdCB5ID0gY2xpX2FhYmIudXBwZXJCb3VuZC55IC0gY2xpX2FhYmIubG93ZXJCb3VuZC55OwogICAgICBjb25zdCB6ID0gY2xpX2FhYmIudXBwZXJCb3VuZC56IC0gY2xpX2FhYmIubG93ZXJCb3VuZC56OwogICAgICByZXR1cm4gdGFyZ2V0LnNldCgxLjAgLyAxMi4wICogbWFzcyAqICgyICogeSAqIDIgKiB5ICsgMiAqIHogKiAyICogeiksIDEuMCAvIDEyLjAgKiBtYXNzICogKDIgKiB4ICogMiAqIHggKyAyICogeiAqIDIgKiB6KSwgMS4wIC8gMTIuMCAqIG1hc3MgKiAoMiAqIHkgKiAyICogeSArIDIgKiB4ICogMiAqIHgpKTsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZSB0aGUgbG9jYWwgQUFCQiBmb3IgdGhlIHRyaW1lc2gKICAgICAqLwoKCiAgICBjb21wdXRlTG9jYWxBQUJCKGFhYmIpIHsKICAgICAgY29uc3QgbCA9IGFhYmIubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdSA9IGFhYmIudXBwZXJCb3VuZDsKICAgICAgY29uc3QgbiA9IHRoaXMudmVydGljZXMubGVuZ3RoOwogICAgICB0aGlzLnZlcnRpY2VzOwogICAgICBjb25zdCB2ID0gY29tcHV0ZUxvY2FsQUFCQl93b3JsZFZlcnQ7CiAgICAgIHRoaXMuZ2V0VmVydGV4KDAsIHYpOwogICAgICBsLmNvcHkodik7CiAgICAgIHUuY29weSh2KTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBuOyBpKyspIHsKICAgICAgICB0aGlzLmdldFZlcnRleChpLCB2KTsKCiAgICAgICAgaWYgKHYueCA8IGwueCkgewogICAgICAgICAgbC54ID0gdi54OwogICAgICAgIH0gZWxzZSBpZiAodi54ID4gdS54KSB7CiAgICAgICAgICB1LnggPSB2Lng7CiAgICAgICAgfQoKICAgICAgICBpZiAodi55IDwgbC55KSB7CiAgICAgICAgICBsLnkgPSB2Lnk7CiAgICAgICAgfSBlbHNlIGlmICh2LnkgPiB1LnkpIHsKICAgICAgICAgIHUueSA9IHYueTsKICAgICAgICB9CgogICAgICAgIGlmICh2LnogPCBsLnopIHsKICAgICAgICAgIGwueiA9IHYuejsKICAgICAgICB9IGVsc2UgaWYgKHYueiA+IHUueikgewogICAgICAgICAgdS56ID0gdi56OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGUgdGhlIGAuYWFiYmAgcHJvcGVydHkKICAgICAqLwoKCiAgICB1cGRhdGVBQUJCKCkgewogICAgICB0aGlzLmNvbXB1dGVMb2NhbEFBQkIodGhpcy5hYWJiKTsKICAgIH0KICAgIC8qKgogICAgICogV2lsbCB1cGRhdGUgdGhlIGAuYm91bmRpbmdTcGhlcmVSYWRpdXNgIHByb3BlcnR5CiAgICAgKi8KCgogICAgdXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKSB7CiAgICAgIC8vIEFzc3VtZSBwb2ludHMgYXJlIGRpc3RyaWJ1dGVkIHdpdGggbG9jYWwgKDAsMCwwKSBhcyBjZW50ZXIKICAgICAgbGV0IG1heDIgPSAwOwogICAgICBjb25zdCB2ZXJ0aWNlcyA9IHRoaXMudmVydGljZXM7CiAgICAgIGNvbnN0IHYgPSBuZXcgVmVjMygpOwoKICAgICAgZm9yIChsZXQgaSA9IDAsIE4gPSB2ZXJ0aWNlcy5sZW5ndGggLyAzOyBpICE9PSBOOyBpKyspIHsKICAgICAgICB0aGlzLmdldFZlcnRleChpLCB2KTsKICAgICAgICBjb25zdCBub3JtMiA9IHYubGVuZ3RoU3F1YXJlZCgpOwoKICAgICAgICBpZiAobm9ybTIgPiBtYXgyKSB7CiAgICAgICAgICBtYXgyID0gbm9ybTI7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlUmFkaXVzID0gTWF0aC5zcXJ0KG1heDIpOwogICAgfQogICAgLyoqCiAgICAgKiBjYWxjdWxhdGVXb3JsZEFBQkIKICAgICAqLwoKCiAgICBjYWxjdWxhdGVXb3JsZEFBQkIocG9zLCBxdWF0LCBtaW4sIG1heCkgewogICAgICAvKgogICAgICAgICAgY29uc3QgbiA9IHRoaXMudmVydGljZXMubGVuZ3RoIC8gMywKICAgICAgICAgICAgICB2ZXJ0cyA9IHRoaXMudmVydGljZXM7CiAgICAgICAgICBjb25zdCBtaW54LG1pbnksbWlueixtYXh4LG1heHksbWF4ejsKICAgICAgICAgICBjb25zdCB2ID0gdGVtcFdvcmxkVmVydGV4OwogICAgICAgICAgZm9yKGxldCBpPTA7IGk8bjsgaSsrKXsKICAgICAgICAgICAgICB0aGlzLmdldFZlcnRleChpLCB2KTsKICAgICAgICAgICAgICBxdWF0LnZtdWx0KHYsIHYpOwogICAgICAgICAgICAgIHBvcy52YWRkKHYsIHYpOwogICAgICAgICAgICAgIGlmICh2LnggPCBtaW54IHx8IG1pbng9PT11bmRlZmluZWQpewogICAgICAgICAgICAgICAgICBtaW54ID0gdi54OwogICAgICAgICAgICAgIH0gZWxzZSBpZih2LnggPiBtYXh4IHx8IG1heHg9PT11bmRlZmluZWQpewogICAgICAgICAgICAgICAgICBtYXh4ID0gdi54OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgaWYgKHYueSA8IG1pbnkgfHwgbWlueT09PXVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgIG1pbnkgPSB2Lnk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmKHYueSA+IG1heHkgfHwgbWF4eT09PXVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgIG1heHkgPSB2Lnk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICBpZiAodi56IDwgbWlueiB8fCBtaW56PT09dW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgbWlueiA9IHYuejsKICAgICAgICAgICAgICB9IGVsc2UgaWYodi56ID4gbWF4eiB8fCBtYXh6PT09dW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgbWF4eiA9IHYuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtaW4uc2V0KG1pbngsbWlueSxtaW56KTsKICAgICAgICAgIG1heC5zZXQobWF4eCxtYXh5LG1heHopOwogICAgICAgICAgKi8KICAgICAgLy8gRmFzdGVyIGFwcHJveGltYXRpb24gdXNpbmcgbG9jYWwgQUFCQgogICAgICBjb25zdCBmcmFtZSA9IGNhbGN1bGF0ZVdvcmxkQUFCQl9mcmFtZTsKICAgICAgY29uc3QgcmVzdWx0ID0gY2FsY3VsYXRlV29ybGRBQUJCX2FhYmI7CiAgICAgIGZyYW1lLnBvc2l0aW9uID0gcG9zOwogICAgICBmcmFtZS5xdWF0ZXJuaW9uID0gcXVhdDsKICAgICAgdGhpcy5hYWJiLnRvV29ybGRGcmFtZShmcmFtZSwgcmVzdWx0KTsKICAgICAgbWluLmNvcHkocmVzdWx0Lmxvd2VyQm91bmQpOwogICAgICBtYXguY29weShyZXN1bHQudXBwZXJCb3VuZCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhcHByb3hpbWF0ZSB2b2x1bWUKICAgICAqLwoKCiAgICB2b2x1bWUoKSB7CiAgICAgIHJldHVybiA0LjAgKiBNYXRoLlBJICogdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyAvIDMuMDsKICAgIH0KICAgIC8qKgogICAgICogQ3JlYXRlIGEgVHJpbWVzaCBpbnN0YW5jZSwgc2hhcGVkIGFzIGEgdG9ydXMuCiAgICAgKi8KCgogICAgc3RhdGljIGNyZWF0ZVRvcnVzKHJhZGl1cywgdHViZSwgcmFkaWFsU2VnbWVudHMsIHR1YnVsYXJTZWdtZW50cywgYXJjKSB7CiAgICAgIGlmIChyYWRpdXMgPT09IHZvaWQgMCkgewogICAgICAgIHJhZGl1cyA9IDE7CiAgICAgIH0KCiAgICAgIGlmICh0dWJlID09PSB2b2lkIDApIHsKICAgICAgICB0dWJlID0gMC41OwogICAgICB9CgogICAgICBpZiAocmFkaWFsU2VnbWVudHMgPT09IHZvaWQgMCkgewogICAgICAgIHJhZGlhbFNlZ21lbnRzID0gODsKICAgICAgfQoKICAgICAgaWYgKHR1YnVsYXJTZWdtZW50cyA9PT0gdm9pZCAwKSB7CiAgICAgICAgdHVidWxhclNlZ21lbnRzID0gNjsKICAgICAgfQoKICAgICAgaWYgKGFyYyA9PT0gdm9pZCAwKSB7CiAgICAgICAgYXJjID0gTWF0aC5QSSAqIDI7CiAgICAgIH0KCiAgICAgIGNvbnN0IHZlcnRpY2VzID0gW107CiAgICAgIGNvbnN0IGluZGljZXMgPSBbXTsKCiAgICAgIGZvciAobGV0IGogPSAwOyBqIDw9IHJhZGlhbFNlZ21lbnRzOyBqKyspIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSB0dWJ1bGFyU2VnbWVudHM7IGkrKykgewogICAgICAgICAgY29uc3QgdSA9IGkgLyB0dWJ1bGFyU2VnbWVudHMgKiBhcmM7CiAgICAgICAgICBjb25zdCB2ID0gaiAvIHJhZGlhbFNlZ21lbnRzICogTWF0aC5QSSAqIDI7CiAgICAgICAgICBjb25zdCB4ID0gKHJhZGl1cyArIHR1YmUgKiBNYXRoLmNvcyh2KSkgKiBNYXRoLmNvcyh1KTsKICAgICAgICAgIGNvbnN0IHkgPSAocmFkaXVzICsgdHViZSAqIE1hdGguY29zKHYpKSAqIE1hdGguc2luKHUpOwogICAgICAgICAgY29uc3QgeiA9IHR1YmUgKiBNYXRoLnNpbih2KTsKICAgICAgICAgIHZlcnRpY2VzLnB1c2goeCwgeSwgeik7CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKGxldCBqID0gMTsgaiA8PSByYWRpYWxTZWdtZW50czsgaisrKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gdHVidWxhclNlZ21lbnRzOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGEgPSAodHVidWxhclNlZ21lbnRzICsgMSkgKiBqICsgaSAtIDE7CiAgICAgICAgICBjb25zdCBiID0gKHR1YnVsYXJTZWdtZW50cyArIDEpICogKGogLSAxKSArIGkgLSAxOwogICAgICAgICAgY29uc3QgYyA9ICh0dWJ1bGFyU2VnbWVudHMgKyAxKSAqIChqIC0gMSkgKyBpOwogICAgICAgICAgY29uc3QgZCA9ICh0dWJ1bGFyU2VnbWVudHMgKyAxKSAqIGogKyBpOwogICAgICAgICAgaW5kaWNlcy5wdXNoKGEsIGIsIGQpOwogICAgICAgICAgaW5kaWNlcy5wdXNoKGIsIGMsIGQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBUcmltZXNoKHZlcnRpY2VzLCBpbmRpY2VzKTsKICAgIH0KCiAgfQogIGNvbnN0IGNvbXB1dGVOb3JtYWxzX24gPSBuZXcgVmVjMygpOwogIGNvbnN0IHVuc2NhbGVkQUFCQiA9IG5ldyBBQUJCKCk7CiAgY29uc3QgZ2V0RWRnZVZlY3Rvcl92YSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgZ2V0RWRnZVZlY3Rvcl92YiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgY2IgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFiID0gbmV3IFZlYzMoKTsKICBjb25zdCB2YSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdmIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHZjID0gbmV3IFZlYzMoKTsKICBjb25zdCBjbGlfYWFiYiA9IG5ldyBBQUJCKCk7CiAgY29uc3QgY29tcHV0ZUxvY2FsQUFCQl93b3JsZFZlcnQgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNhbGN1bGF0ZVdvcmxkQUFCQl9mcmFtZSA9IG5ldyBUcmFuc2Zvcm0oKTsKICBjb25zdCBjYWxjdWxhdGVXb3JsZEFBQkJfYWFiYiA9IG5ldyBBQUJCKCk7CgogIC8qKgogICAqIENvbnN0cmFpbnQgZXF1YXRpb24gc29sdmVyIGJhc2UgY2xhc3MuCiAgICovCiAgY2xhc3MgU29sdmVyIHsKICAgIC8qKgogICAgICogQWxsIGVxdWF0aW9ucyB0byBiZSBzb2x2ZWQKICAgICAqLwoKICAgIC8qKgogICAgICogQHRvZG8gcmVtb3ZlIHVzZWxlc3MgY29uc3RydWN0b3IKICAgICAqLwogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHRoaXMuZXF1YXRpb25zID0gW107CiAgICB9CiAgICAvKioKICAgICAqIFNob3VsZCBiZSBpbXBsZW1lbnRlZCBpbiBzdWJjbGFzc2VzIQogICAgICogQHRvZG8gdXNlIGFic3RyYWN0CiAgICAgKiBAcmV0dXJuIG51bWJlciBvZiBpdGVyYXRpb25zIHBlcmZvcm1lZAogICAgICovCgoKICAgIHNvbHZlKGR0LCB3b3JsZCkgewogICAgICByZXR1cm4gKC8vIFNob3VsZCByZXR1cm4gdGhlIG51bWJlciBvZiBpdGVyYXRpb25zIGRvbmUhCiAgICAgICAgMAogICAgICApOwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgYW4gZXF1YXRpb24KICAgICAqLwoKCiAgICBhZGRFcXVhdGlvbihlcSkgewogICAgICBpZiAoZXEuZW5hYmxlZCAmJiAhZXEuYmkuaXNUcmlnZ2VyICYmICFlcS5iai5pc1RyaWdnZXIpIHsKICAgICAgICB0aGlzLmVxdWF0aW9ucy5wdXNoKGVxKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmUgYW4gZXF1YXRpb24KICAgICAqLwoKCiAgICByZW1vdmVFcXVhdGlvbihlcSkgewogICAgICBjb25zdCBlcXMgPSB0aGlzLmVxdWF0aW9uczsKICAgICAgY29uc3QgaSA9IGVxcy5pbmRleE9mKGVxKTsKCiAgICAgIGlmIChpICE9PSAtMSkgewogICAgICAgIGVxcy5zcGxpY2UoaSwgMSk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQWRkIGFsbCBlcXVhdGlvbnMKICAgICAqLwoKCiAgICByZW1vdmVBbGxFcXVhdGlvbnMoKSB7CiAgICAgIHRoaXMuZXF1YXRpb25zLmxlbmd0aCA9IDA7CiAgICB9CgogIH0KCiAgLyoqCiAgICogQ29uc3RyYWludCBlcXVhdGlvbiBHYXVzcy1TZWlkZWwgc29sdmVyLgogICAqIEB0b2RvIFRoZSBzcG9vayBwYXJhbWV0ZXJzIHNob3VsZCBiZSBzcGVjaWZpZWQgZm9yIGVhY2ggY29uc3RyYWludCwgbm90IGdsb2JhbGx5LgogICAqIEBzZWUgaHR0cHM6Ly93d3c4LmNzLnVtdS5zZS9rdXJzZXIvNURWMDU4L1ZUMDkvbGVjdHVyZXMvc3Bvb2tub3Rlcy5wZGYKICAgKi8KICBjbGFzcyBHU1NvbHZlciBleHRlbmRzIFNvbHZlciB7CiAgICAvKioKICAgICAqIFRoZSBudW1iZXIgb2Ygc29sdmVyIGl0ZXJhdGlvbnMgZGV0ZXJtaW5lcyBxdWFsaXR5IG9mIHRoZSBjb25zdHJhaW50cyBpbiB0aGUgd29ybGQuCiAgICAgKiBUaGUgbW9yZSBpdGVyYXRpb25zLCB0aGUgbW9yZSBjb3JyZWN0IHNpbXVsYXRpb24uIE1vcmUgaXRlcmF0aW9ucyBuZWVkIG1vcmUgY29tcHV0YXRpb25zIHRob3VnaC4gSWYgeW91IGhhdmUgYSBsYXJnZSBncmF2aXR5IGZvcmNlIGluIHlvdXIgd29ybGQsIHlvdSB3aWxsIG5lZWQgbW9yZSBpdGVyYXRpb25zLgogICAgICovCgogICAgLyoqCiAgICAgKiBXaGVuIHRvbGVyYW5jZSBpcyByZWFjaGVkLCB0aGUgc3lzdGVtIGlzIGFzc3VtZWQgdG8gYmUgY29udmVyZ2VkLgogICAgICovCgogICAgLyoqCiAgICAgKiBAdG9kbyByZW1vdmUgdXNlbGVzcyBjb25zdHJ1Y3RvcgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5pdGVyYXRpb25zID0gMTA7CiAgICAgIHRoaXMudG9sZXJhbmNlID0gMWUtNzsKICAgIH0KICAgIC8qKgogICAgICogU29sdmUKICAgICAqIEByZXR1cm4gbnVtYmVyIG9mIGl0ZXJhdGlvbnMgcGVyZm9ybWVkCiAgICAgKi8KCgogICAgc29sdmUoZHQsIHdvcmxkKSB7CiAgICAgIGxldCBpdGVyID0gMDsKICAgICAgY29uc3QgbWF4SXRlciA9IHRoaXMuaXRlcmF0aW9uczsKICAgICAgY29uc3QgdG9sU3F1YXJlZCA9IHRoaXMudG9sZXJhbmNlICogdGhpcy50b2xlcmFuY2U7CiAgICAgIGNvbnN0IGVxdWF0aW9ucyA9IHRoaXMuZXF1YXRpb25zOwogICAgICBjb25zdCBOZXEgPSBlcXVhdGlvbnMubGVuZ3RoOwogICAgICBjb25zdCBib2RpZXMgPSB3b3JsZC5ib2RpZXM7CiAgICAgIGNvbnN0IE5ib2RpZXMgPSBib2RpZXMubGVuZ3RoOwogICAgICBjb25zdCBoID0gZHQ7CiAgICAgIGxldCBCOwogICAgICBsZXQgaW52QzsKICAgICAgbGV0IGRlbHRhbGFtYmRhOwogICAgICBsZXQgZGVsdGFsYW1iZGFUb3Q7CiAgICAgIGxldCBHV2xhbWJkYTsKICAgICAgbGV0IGxhbWJkYWo7IC8vIFVwZGF0ZSBzb2x2ZSBtYXNzCgogICAgICBpZiAoTmVxICE9PSAwKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5ib2RpZXM7IGkrKykgewogICAgICAgICAgYm9kaWVzW2ldLnVwZGF0ZVNvbHZlTWFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB9CiAgICAgIH0gLy8gVGhpbmdzIHRoYXQgZG8gbm90IGNoYW5nZSBkdXJpbmcgaXRlcmF0aW9uIGNhbiBiZSBjb21wdXRlZCBvbmNlCgoKICAgICAgY29uc3QgaW52Q3MgPSBHU1NvbHZlcl9zb2x2ZV9pbnZDczsKICAgICAgY29uc3QgQnMgPSBHU1NvbHZlcl9zb2x2ZV9CczsKICAgICAgY29uc3QgbGFtYmRhID0gR1NTb2x2ZXJfc29sdmVfbGFtYmRhOwogICAgICBpbnZDcy5sZW5ndGggPSBOZXE7CiAgICAgIEJzLmxlbmd0aCA9IE5lcTsKICAgICAgbGFtYmRhLmxlbmd0aCA9IE5lcTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBOZXE7IGkrKykgewogICAgICAgIGNvbnN0IGMgPSBlcXVhdGlvbnNbaV07CiAgICAgICAgbGFtYmRhW2ldID0gMC4wOwogICAgICAgIEJzW2ldID0gYy5jb21wdXRlQihoKTsKICAgICAgICBpbnZDc1tpXSA9IDEuMCAvIGMuY29tcHV0ZUMoKTsKICAgICAgfQoKICAgICAgaWYgKE5lcSAhPT0gMCkgewogICAgICAgIC8vIFJlc2V0IHZsYW1iZGEKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTmJvZGllczsgaSsrKSB7CiAgICAgICAgICBjb25zdCBiID0gYm9kaWVzW2ldOwogICAgICAgICAgY29uc3QgdmxhbWJkYSA9IGIudmxhbWJkYTsKICAgICAgICAgIGNvbnN0IHdsYW1iZGEgPSBiLndsYW1iZGE7CiAgICAgICAgICB2bGFtYmRhLnNldCgwLCAwLCAwKTsKICAgICAgICAgIHdsYW1iZGEuc2V0KDAsIDAsIDApOwogICAgICAgIH0gLy8gSXRlcmF0ZSBvdmVyIGVxdWF0aW9ucwoKCiAgICAgICAgZm9yIChpdGVyID0gMDsgaXRlciAhPT0gbWF4SXRlcjsgaXRlcisrKSB7CiAgICAgICAgICAvLyBBY2N1bXVsYXRlIHRoZSB0b3RhbCBlcnJvciBmb3IgZWFjaCBpdGVyYXRpb24uCiAgICAgICAgICBkZWx0YWxhbWJkYVRvdCA9IDAuMDsKCiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiAhPT0gTmVxOyBqKyspIHsKICAgICAgICAgICAgY29uc3QgYyA9IGVxdWF0aW9uc1tqXTsgLy8gQ29tcHV0ZSBpdGVyYXRpb24KCiAgICAgICAgICAgIEIgPSBCc1tqXTsKICAgICAgICAgICAgaW52QyA9IGludkNzW2pdOwogICAgICAgICAgICBsYW1iZGFqID0gbGFtYmRhW2pdOwogICAgICAgICAgICBHV2xhbWJkYSA9IGMuY29tcHV0ZUdXbGFtYmRhKCk7CiAgICAgICAgICAgIGRlbHRhbGFtYmRhID0gaW52QyAqIChCIC0gR1dsYW1iZGEgLSBjLmVwcyAqIGxhbWJkYWopOyAvLyBDbGFtcCBpZiB3ZSBhcmUgbm90IHdpdGhpbiB0aGUgbWluL21heCBpbnRlcnZhbAoKICAgICAgICAgICAgaWYgKGxhbWJkYWogKyBkZWx0YWxhbWJkYSA8IGMubWluRm9yY2UpIHsKICAgICAgICAgICAgICBkZWx0YWxhbWJkYSA9IGMubWluRm9yY2UgLSBsYW1iZGFqOwogICAgICAgICAgICB9IGVsc2UgaWYgKGxhbWJkYWogKyBkZWx0YWxhbWJkYSA+IGMubWF4Rm9yY2UpIHsKICAgICAgICAgICAgICBkZWx0YWxhbWJkYSA9IGMubWF4Rm9yY2UgLSBsYW1iZGFqOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsYW1iZGFbal0gKz0gZGVsdGFsYW1iZGE7CiAgICAgICAgICAgIGRlbHRhbGFtYmRhVG90ICs9IGRlbHRhbGFtYmRhID4gMC4wID8gZGVsdGFsYW1iZGEgOiAtZGVsdGFsYW1iZGE7IC8vIGFicyhkZWx0YWxhbWJkYSkKCiAgICAgICAgICAgIGMuYWRkVG9XbGFtYmRhKGRlbHRhbGFtYmRhKTsKICAgICAgICAgIH0gLy8gSWYgdGhlIHRvdGFsIGVycm9yIGlzIHNtYWxsIGVub3VnaCAtIHN0b3AgaXRlcmF0ZQoKCiAgICAgICAgICBpZiAoZGVsdGFsYW1iZGFUb3QgKiBkZWx0YWxhbWJkYVRvdCA8IHRvbFNxdWFyZWQpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBBZGQgcmVzdWx0IHRvIHZlbG9jaXR5CgoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTmJvZGllczsgaSsrKSB7CiAgICAgICAgICBjb25zdCBiID0gYm9kaWVzW2ldOwogICAgICAgICAgY29uc3QgdiA9IGIudmVsb2NpdHk7CiAgICAgICAgICBjb25zdCB3ID0gYi5hbmd1bGFyVmVsb2NpdHk7CiAgICAgICAgICBiLnZsYW1iZGEudm11bChiLmxpbmVhckZhY3RvciwgYi52bGFtYmRhKTsKICAgICAgICAgIHYudmFkZChiLnZsYW1iZGEsIHYpOwogICAgICAgICAgYi53bGFtYmRhLnZtdWwoYi5hbmd1bGFyRmFjdG9yLCBiLndsYW1iZGEpOwogICAgICAgICAgdy52YWRkKGIud2xhbWJkYSwgdyk7CiAgICAgICAgfSAvLyBTZXQgdGhlIGAubXVsdGlwbGllcmAgcHJvcGVydHkgb2YgZWFjaCBlcXVhdGlvbgoKCiAgICAgICAgbGV0IGwgPSBlcXVhdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGludkR0ID0gMSAvIGg7CgogICAgICAgIHdoaWxlIChsLS0pIHsKICAgICAgICAgIGVxdWF0aW9uc1tsXS5tdWx0aXBsaWVyID0gbGFtYmRhW2xdICogaW52RHQ7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaXRlcjsKICAgIH0KCiAgfSAvLyBKdXN0IHRlbXBvcmFyeSBudW1iZXIgaG9sZGVycyB0aGF0IHdlIHdhbnQgdG8gcmV1c2UgZWFjaCBpdGVyYXRpb24uCgogIGNvbnN0IEdTU29sdmVyX3NvbHZlX2xhbWJkYSA9IFtdOwogIGNvbnN0IEdTU29sdmVyX3NvbHZlX2ludkNzID0gW107CiAgY29uc3QgR1NTb2x2ZXJfc29sdmVfQnMgPSBbXTsKCiAgLyoqCiAgICogU3BsaXRzIHRoZSBlcXVhdGlvbnMgaW50byBpc2xhbmRzIGFuZCBzb2x2ZXMgdGhlbSBpbmRlcGVuZGVudGx5LiBDYW4gaW1wcm92ZSBwZXJmb3JtYW5jZS4KICAgKi8KICBjbGFzcyBTcGxpdFNvbHZlciBleHRlbmRzIFNvbHZlciB7CiAgICAvKioKICAgICAqIFRoZSBudW1iZXIgb2Ygc29sdmVyIGl0ZXJhdGlvbnMgZGV0ZXJtaW5lcyBxdWFsaXR5IG9mIHRoZSBjb25zdHJhaW50cyBpbiB0aGUgd29ybGQuIFRoZSBtb3JlIGl0ZXJhdGlvbnMsIHRoZSBtb3JlIGNvcnJlY3Qgc2ltdWxhdGlvbi4gTW9yZSBpdGVyYXRpb25zIG5lZWQgbW9yZSBjb21wdXRhdGlvbnMgdGhvdWdoLiBJZiB5b3UgaGF2ZSBhIGxhcmdlIGdyYXZpdHkgZm9yY2UgaW4geW91ciB3b3JsZCwgeW91IHdpbGwgbmVlZCBtb3JlIGl0ZXJhdGlvbnMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFdoZW4gdG9sZXJhbmNlIGlzIHJlYWNoZWQsIHRoZSBzeXN0ZW0gaXMgYXNzdW1lZCB0byBiZSBjb252ZXJnZWQuCiAgICAgKi8KCiAgICAvKiogc3Vic29sdmVyICovCiAgICBjb25zdHJ1Y3RvcihzdWJzb2x2ZXIpIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5pdGVyYXRpb25zID0gMTA7CiAgICAgIHRoaXMudG9sZXJhbmNlID0gMWUtNzsKICAgICAgdGhpcy5zdWJzb2x2ZXIgPSBzdWJzb2x2ZXI7CiAgICAgIHRoaXMubm9kZXMgPSBbXTsKICAgICAgdGhpcy5ub2RlUG9vbCA9IFtdOyAvLyBDcmVhdGUgbmVlZGVkIG5vZGVzLCByZXVzZSBpZiBwb3NzaWJsZQoKICAgICAgd2hpbGUgKHRoaXMubm9kZVBvb2wubGVuZ3RoIDwgMTI4KSB7CiAgICAgICAgdGhpcy5ub2RlUG9vbC5wdXNoKHRoaXMuY3JlYXRlTm9kZSgpKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBjcmVhdGVOb2RlCiAgICAgKi8KCgogICAgY3JlYXRlTm9kZSgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBib2R5OiBudWxsLAogICAgICAgIGNoaWxkcmVuOiBbXSwKICAgICAgICBlcXM6IFtdLAogICAgICAgIHZpc2l0ZWQ6IGZhbHNlCiAgICAgIH07CiAgICB9CiAgICAvKioKICAgICAqIFNvbHZlIHRoZSBzdWJzeXN0ZW1zCiAgICAgKiBAcmV0dXJuIG51bWJlciBvZiBpdGVyYXRpb25zIHBlcmZvcm1lZAogICAgICovCgoKICAgIHNvbHZlKGR0LCB3b3JsZCkgewogICAgICBjb25zdCBub2RlcyA9IFNwbGl0U29sdmVyX3NvbHZlX25vZGVzOwogICAgICBjb25zdCBub2RlUG9vbCA9IHRoaXMubm9kZVBvb2w7CiAgICAgIGNvbnN0IGJvZGllcyA9IHdvcmxkLmJvZGllczsKICAgICAgY29uc3QgZXF1YXRpb25zID0gdGhpcy5lcXVhdGlvbnM7CiAgICAgIGNvbnN0IE5lcSA9IGVxdWF0aW9ucy5sZW5ndGg7CiAgICAgIGNvbnN0IE5ib2RpZXMgPSBib2RpZXMubGVuZ3RoOwogICAgICBjb25zdCBzdWJzb2x2ZXIgPSB0aGlzLnN1YnNvbHZlcjsgLy8gQ3JlYXRlIG5lZWRlZCBub2RlcywgcmV1c2UgaWYgcG9zc2libGUKCiAgICAgIHdoaWxlIChub2RlUG9vbC5sZW5ndGggPCBOYm9kaWVzKSB7CiAgICAgICAgbm9kZVBvb2wucHVzaCh0aGlzLmNyZWF0ZU5vZGUoKSk7CiAgICAgIH0KCiAgICAgIG5vZGVzLmxlbmd0aCA9IE5ib2RpZXM7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE5ib2RpZXM7IGkrKykgewogICAgICAgIG5vZGVzW2ldID0gbm9kZVBvb2xbaV07CiAgICAgIH0gLy8gUmVzZXQgbm9kZSB2YWx1ZXMKCgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTmJvZGllczsgaSsrKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldOwogICAgICAgIG5vZGUuYm9keSA9IGJvZGllc1tpXTsKICAgICAgICBub2RlLmNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgICAgICAgbm9kZS5lcXMubGVuZ3RoID0gMDsKICAgICAgICBub2RlLnZpc2l0ZWQgPSBmYWxzZTsKICAgICAgfQoKICAgICAgZm9yIChsZXQgayA9IDA7IGsgIT09IE5lcTsgaysrKSB7CiAgICAgICAgY29uc3QgZXEgPSBlcXVhdGlvbnNba107CiAgICAgICAgY29uc3QgaSA9IGJvZGllcy5pbmRleE9mKGVxLmJpKTsKICAgICAgICBjb25zdCBqID0gYm9kaWVzLmluZGV4T2YoZXEuYmopOwogICAgICAgIGNvbnN0IG5pID0gbm9kZXNbaV07CiAgICAgICAgY29uc3QgbmogPSBub2Rlc1tqXTsKICAgICAgICBuaS5jaGlsZHJlbi5wdXNoKG5qKTsKICAgICAgICBuaS5lcXMucHVzaChlcSk7CiAgICAgICAgbmouY2hpbGRyZW4ucHVzaChuaSk7CiAgICAgICAgbmouZXFzLnB1c2goZXEpOwogICAgICB9CgogICAgICBsZXQgY2hpbGQ7CiAgICAgIGxldCBuID0gMDsKICAgICAgbGV0IGVxcyA9IFNwbGl0U29sdmVyX3NvbHZlX2VxczsKICAgICAgc3Vic29sdmVyLnRvbGVyYW5jZSA9IHRoaXMudG9sZXJhbmNlOwogICAgICBzdWJzb2x2ZXIuaXRlcmF0aW9ucyA9IHRoaXMuaXRlcmF0aW9uczsKICAgICAgY29uc3QgZHVtbXlXb3JsZCA9IFNwbGl0U29sdmVyX3NvbHZlX2R1bW15V29ybGQ7CgogICAgICB3aGlsZSAoY2hpbGQgPSBnZXRVbnZpc2l0ZWROb2RlKG5vZGVzKSkgewogICAgICAgIGVxcy5sZW5ndGggPSAwOwogICAgICAgIGR1bW15V29ybGQuYm9kaWVzLmxlbmd0aCA9IDA7CiAgICAgICAgYmZzKGNoaWxkLCB2aXNpdEZ1bmMsIGR1bW15V29ybGQuYm9kaWVzLCBlcXMpOwogICAgICAgIGNvbnN0IE5lcXMgPSBlcXMubGVuZ3RoOwogICAgICAgIGVxcyA9IGVxcy5zb3J0KHNvcnRCeUlkKTsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5lcXM7IGkrKykgewogICAgICAgICAgc3Vic29sdmVyLmFkZEVxdWF0aW9uKGVxc1tpXSk7CiAgICAgICAgfQoKICAgICAgICBzdWJzb2x2ZXIuc29sdmUoZHQsIGR1bW15V29ybGQpOwogICAgICAgIHN1YnNvbHZlci5yZW1vdmVBbGxFcXVhdGlvbnMoKTsKICAgICAgICBuKys7CiAgICAgIH0KCiAgICAgIHJldHVybiBuOwogICAgfQoKICB9IC8vIFJldHVybnMgdGhlIG51bWJlciBvZiBzdWJzeXN0ZW1zCgogIGNvbnN0IFNwbGl0U29sdmVyX3NvbHZlX25vZGVzID0gW107IC8vIEFsbCBhbGxvY2F0ZWQgbm9kZSBvYmplY3RzCgogIGNvbnN0IFNwbGl0U29sdmVyX3NvbHZlX2VxcyA9IFtdOyAvLyBUZW1wIGFycmF5CgogIGNvbnN0IFNwbGl0U29sdmVyX3NvbHZlX2R1bW15V29ybGQgPSB7CiAgICBib2RpZXM6IFtdCiAgfTsgLy8gVGVtcCBvYmplY3QKCiAgY29uc3QgU1RBVElDID0gQm9keS5TVEFUSUM7CgogIGZ1bmN0aW9uIGdldFVudmlzaXRlZE5vZGUobm9kZXMpIHsKICAgIGNvbnN0IE5ub2RlcyA9IG5vZGVzLmxlbmd0aDsKCiAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTm5vZGVzOyBpKyspIHsKICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldOwoKICAgICAgaWYgKCFub2RlLnZpc2l0ZWQgJiYgIShub2RlLmJvZHkudHlwZSAmIFNUQVRJQykpIHsKICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGNvbnN0IHF1ZXVlID0gW107CgogIGZ1bmN0aW9uIGJmcyhyb290LCB2aXNpdEZ1bmMsIGJkcywgZXFzKSB7CiAgICBxdWV1ZS5wdXNoKHJvb3QpOwogICAgcm9vdC52aXNpdGVkID0gdHJ1ZTsKICAgIHZpc2l0RnVuYyhyb290LCBiZHMsIGVxcyk7CgogICAgd2hpbGUgKHF1ZXVlLmxlbmd0aCkgewogICAgICBjb25zdCBub2RlID0gcXVldWUucG9wKCk7IC8vIExvb3Agb3ZlciB1bnZpc2l0ZWQgY2hpbGQgbm9kZXMKCiAgICAgIGxldCBjaGlsZDsKCiAgICAgIHdoaWxlIChjaGlsZCA9IGdldFVudmlzaXRlZE5vZGUobm9kZS5jaGlsZHJlbikpIHsKICAgICAgICBjaGlsZC52aXNpdGVkID0gdHJ1ZTsKICAgICAgICB2aXNpdEZ1bmMoY2hpbGQsIGJkcywgZXFzKTsKICAgICAgICBxdWV1ZS5wdXNoKGNoaWxkKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gdmlzaXRGdW5jKG5vZGUsIGJkcywgZXFzKSB7CiAgICBiZHMucHVzaChub2RlLmJvZHkpOwogICAgY29uc3QgTmVxcyA9IG5vZGUuZXFzLmxlbmd0aDsKCiAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTmVxczsgaSsrKSB7CiAgICAgIGNvbnN0IGVxID0gbm9kZS5lcXNbaV07CgogICAgICBpZiAoIWVxcy5pbmNsdWRlcyhlcSkpIHsKICAgICAgICBlcXMucHVzaChlcSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHNvcnRCeUlkKGEsIGIpIHsKICAgIHJldHVybiBiLmlkIC0gYS5pZDsKICB9CgogIC8qKgogICAqIEZvciBwb29saW5nIG9iamVjdHMgdGhhdCBjYW4gYmUgcmV1c2VkLgogICAqLwogIGNsYXNzIFBvb2wgewogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHRoaXMub2JqZWN0cyA9IFtdOwogICAgICB0aGlzLnR5cGUgPSBPYmplY3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZWxlYXNlIGFuIG9iamVjdCBhZnRlciB1c2UKICAgICAqLwogICAgcmVsZWFzZSgpIHsKICAgICAgY29uc3QgTmFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5hcmdzOyBpKyspIHsKICAgICAgICB0aGlzLm9iamVjdHMucHVzaChpIDwgMCB8fCBhcmd1bWVudHMubGVuZ3RoIDw9IGkgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbaV0pOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGFuIG9iamVjdAogICAgICovCgoKICAgIGdldCgpIHsKICAgICAgaWYgKHRoaXMub2JqZWN0cy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3RPYmplY3QoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5vYmplY3RzLnBvcCgpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENvbnN0cnVjdCBhbiBvYmplY3QuIFNob3VsZCBiZSBpbXBsZW1lbnRlZCBpbiBlYWNoIHN1YmNsYXNzLgogICAgICovCgoKICAgIGNvbnN0cnVjdE9iamVjdCgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdjb25zdHJ1Y3RPYmplY3QoKSBub3QgaW1wbGVtZW50ZWQgaW4gdGhpcyBQb29sIHN1YmNsYXNzIHlldCEnKTsKICAgIH0KICAgIC8qKgogICAgICogQHJldHVybiBTZWxmLCBmb3IgY2hhaW5pbmcKICAgICAqLwoKCiAgICByZXNpemUoc2l6ZSkgewogICAgICBjb25zdCBvYmplY3RzID0gdGhpcy5vYmplY3RzOwoKICAgICAgd2hpbGUgKG9iamVjdHMubGVuZ3RoID4gc2l6ZSkgewogICAgICAgIG9iamVjdHMucG9wKCk7CiAgICAgIH0KCiAgICAgIHdoaWxlIChvYmplY3RzLmxlbmd0aCA8IHNpemUpIHsKICAgICAgICBvYmplY3RzLnB1c2godGhpcy5jb25zdHJ1Y3RPYmplY3QoKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICB9CgogIC8qKgogICAqIFZlYzNQb29sCiAgICovCgogIGNsYXNzIFZlYzNQb29sIGV4dGVuZHMgUG9vbCB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgdGhpcy50eXBlID0gVmVjMzsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnN0cnVjdCBhIHZlY3RvcgogICAgICovCiAgICBjb25zdHJ1Y3RPYmplY3QoKSB7CiAgICAgIHJldHVybiBuZXcgVmVjMygpOwogICAgfQoKICB9CgogIC8vIE5hbWluZyBydWxlOiBiYXNlZCBvZiB0aGUgb3JkZXIgaW4gU0hBUEVfVFlQRVMsCiAgLy8gdGhlIGZpcnN0IHBhcnQgb2YgdGhlIG1ldGhvZCBpcyBmb3JtZWQgYnkgdGhlCiAgLy8gc2hhcGUgdHlwZSB0aGF0IGNvbWVzIGJlZm9yZSwgaW4gdGhlIHNlY29uZCBwYXJ0CiAgLy8gdGhlcmUgaXMgdGhlIHNoYXBlIHR5cGUgdGhhdCBjb21lcyBhZnRlciBpbiB0aGUgU0hBUEVfVFlQRVMgbGlzdAogIGNvbnN0IENPTExJU0lPTl9UWVBFUyA9IHsKICAgIHNwaGVyZVNwaGVyZTogU2hhcGUudHlwZXMuU1BIRVJFLAogICAgc3BoZXJlUGxhbmU6IFNoYXBlLnR5cGVzLlNQSEVSRSB8IFNoYXBlLnR5cGVzLlBMQU5FLAogICAgYm94Qm94OiBTaGFwZS50eXBlcy5CT1ggfCBTaGFwZS50eXBlcy5CT1gsCiAgICBzcGhlcmVCb3g6IFNoYXBlLnR5cGVzLlNQSEVSRSB8IFNoYXBlLnR5cGVzLkJPWCwKICAgIHBsYW5lQm94OiBTaGFwZS50eXBlcy5QTEFORSB8IFNoYXBlLnR5cGVzLkJPWCwKICAgIGNvbnZleENvbnZleDogU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiwKICAgIHNwaGVyZUNvbnZleDogU2hhcGUudHlwZXMuU1BIRVJFIHwgU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiwKICAgIHBsYW5lQ29udmV4OiBTaGFwZS50eXBlcy5QTEFORSB8IFNoYXBlLnR5cGVzLkNPTlZFWFBPTFlIRURST04sCiAgICBib3hDb252ZXg6IFNoYXBlLnR5cGVzLkJPWCB8IFNoYXBlLnR5cGVzLkNPTlZFWFBPTFlIRURST04sCiAgICBzcGhlcmVIZWlnaHRmaWVsZDogU2hhcGUudHlwZXMuU1BIRVJFIHwgU2hhcGUudHlwZXMuSEVJR0hURklFTEQsCiAgICBib3hIZWlnaHRmaWVsZDogU2hhcGUudHlwZXMuQk9YIHwgU2hhcGUudHlwZXMuSEVJR0hURklFTEQsCiAgICBjb252ZXhIZWlnaHRmaWVsZDogU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiB8IFNoYXBlLnR5cGVzLkhFSUdIVEZJRUxELAogICAgc3BoZXJlUGFydGljbGU6IFNoYXBlLnR5cGVzLlBBUlRJQ0xFIHwgU2hhcGUudHlwZXMuU1BIRVJFLAogICAgcGxhbmVQYXJ0aWNsZTogU2hhcGUudHlwZXMuUExBTkUgfCBTaGFwZS50eXBlcy5QQVJUSUNMRSwKICAgIGJveFBhcnRpY2xlOiBTaGFwZS50eXBlcy5CT1ggfCBTaGFwZS50eXBlcy5QQVJUSUNMRSwKICAgIGNvbnZleFBhcnRpY2xlOiBTaGFwZS50eXBlcy5QQVJUSUNMRSB8IFNoYXBlLnR5cGVzLkNPTlZFWFBPTFlIRURST04sCiAgICBjeWxpbmRlckN5bGluZGVyOiBTaGFwZS50eXBlcy5DWUxJTkRFUiwKICAgIHNwaGVyZUN5bGluZGVyOiBTaGFwZS50eXBlcy5TUEhFUkUgfCBTaGFwZS50eXBlcy5DWUxJTkRFUiwKICAgIHBsYW5lQ3lsaW5kZXI6IFNoYXBlLnR5cGVzLlBMQU5FIHwgU2hhcGUudHlwZXMuQ1lMSU5ERVIsCiAgICBib3hDeWxpbmRlcjogU2hhcGUudHlwZXMuQk9YIHwgU2hhcGUudHlwZXMuQ1lMSU5ERVIsCiAgICBjb252ZXhDeWxpbmRlcjogU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiB8IFNoYXBlLnR5cGVzLkNZTElOREVSLAogICAgaGVpZ2h0ZmllbGRDeWxpbmRlcjogU2hhcGUudHlwZXMuSEVJR0hURklFTEQgfCBTaGFwZS50eXBlcy5DWUxJTkRFUiwKICAgIHBhcnRpY2xlQ3lsaW5kZXI6IFNoYXBlLnR5cGVzLlBBUlRJQ0xFIHwgU2hhcGUudHlwZXMuQ1lMSU5ERVIsCiAgICBzcGhlcmVUcmltZXNoOiBTaGFwZS50eXBlcy5TUEhFUkUgfCBTaGFwZS50eXBlcy5UUklNRVNILAogICAgcGxhbmVUcmltZXNoOiBTaGFwZS50eXBlcy5QTEFORSB8IFNoYXBlLnR5cGVzLlRSSU1FU0gKICB9OwoKICAvKioKICAgKiBIZWxwZXIgY2xhc3MgZm9yIHRoZSBXb3JsZC4gR2VuZXJhdGVzIENvbnRhY3RFcXVhdGlvbnMuCiAgICogQHRvZG8gU3BoZXJlLUNvbnZleFBvbHloZWRyb24gY29udGFjdHMKICAgKiBAdG9kbyBDb250YWN0IHJlZHVjdGlvbgogICAqIEB0b2RvIHNob3VsZCBtb3ZlIG1ldGhvZHMgdG8gcHJvdG90eXBlCiAgICovCiAgY2xhc3MgTmFycm93cGhhc2UgewogICAgLyoqCiAgICAgKiBJbnRlcm5hbCBzdG9yYWdlIG9mIHBvb2xlZCBjb250YWN0IHBvaW50cy4KICAgICAqLwoKICAgIC8qKgogICAgICogUG9vbGVkIHZlY3RvcnMuCiAgICAgKi8KICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnNwaGVyZVNwaGVyZV0oKSB7CiAgICAgIHJldHVybiB0aGlzLnNwaGVyZVNwaGVyZTsKICAgIH0KCiAgICBnZXQgW0NPTExJU0lPTl9UWVBFUy5zcGhlcmVQbGFuZV0oKSB7CiAgICAgIHJldHVybiB0aGlzLnNwaGVyZVBsYW5lOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLmJveEJveF0oKSB7CiAgICAgIHJldHVybiB0aGlzLmJveEJveDsKICAgIH0KCiAgICBnZXQgW0NPTExJU0lPTl9UWVBFUy5zcGhlcmVCb3hdKCkgewogICAgICByZXR1cm4gdGhpcy5zcGhlcmVCb3g7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMucGxhbmVCb3hdKCkgewogICAgICByZXR1cm4gdGhpcy5wbGFuZUJveDsKICAgIH0KCiAgICBnZXQgW0NPTExJU0lPTl9UWVBFUy5jb252ZXhDb252ZXhdKCkgewogICAgICByZXR1cm4gdGhpcy5jb252ZXhDb252ZXg7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMuc3BoZXJlQ29udmV4XSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3BoZXJlQ29udmV4OwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnBsYW5lQ29udmV4XSgpIHsKICAgICAgcmV0dXJuIHRoaXMucGxhbmVDb252ZXg7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMuYm94Q29udmV4XSgpIHsKICAgICAgcmV0dXJuIHRoaXMuYm94Q29udmV4OwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnNwaGVyZUhlaWdodGZpZWxkXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3BoZXJlSGVpZ2h0ZmllbGQ7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMuYm94SGVpZ2h0ZmllbGRdKCkgewogICAgICByZXR1cm4gdGhpcy5ib3hIZWlnaHRmaWVsZDsKICAgIH0KCiAgICBnZXQgW0NPTExJU0lPTl9UWVBFUy5jb252ZXhIZWlnaHRmaWVsZF0oKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbnZleEhlaWdodGZpZWxkOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnNwaGVyZVBhcnRpY2xlXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3BoZXJlUGFydGljbGU7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMucGxhbmVQYXJ0aWNsZV0oKSB7CiAgICAgIHJldHVybiB0aGlzLnBsYW5lUGFydGljbGU7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMuYm94UGFydGljbGVdKCkgewogICAgICByZXR1cm4gdGhpcy5ib3hQYXJ0aWNsZTsKICAgIH0KCiAgICBnZXQgW0NPTExJU0lPTl9UWVBFUy5jb252ZXhQYXJ0aWNsZV0oKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbnZleFBhcnRpY2xlOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLmN5bGluZGVyQ3lsaW5kZXJdKCkgewogICAgICByZXR1cm4gdGhpcy5jb252ZXhDb252ZXg7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMuc3BoZXJlQ3lsaW5kZXJdKCkgewogICAgICByZXR1cm4gdGhpcy5zcGhlcmVDb252ZXg7CiAgICB9CgogICAgZ2V0IFtDT0xMSVNJT05fVFlQRVMucGxhbmVDeWxpbmRlcl0oKSB7CiAgICAgIHJldHVybiB0aGlzLnBsYW5lQ29udmV4OwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLmJveEN5bGluZGVyXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuYm94Q29udmV4OwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLmNvbnZleEN5bGluZGVyXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuY29udmV4Q29udmV4OwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLmhlaWdodGZpZWxkQ3lsaW5kZXJdKCkgewogICAgICByZXR1cm4gdGhpcy5oZWlnaHRmaWVsZEN5bGluZGVyOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnBhcnRpY2xlQ3lsaW5kZXJdKCkgewogICAgICByZXR1cm4gdGhpcy5wYXJ0aWNsZUN5bGluZGVyOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnNwaGVyZVRyaW1lc2hdKCkgewogICAgICByZXR1cm4gdGhpcy5zcGhlcmVUcmltZXNoOwogICAgfQoKICAgIGdldCBbQ09MTElTSU9OX1RZUEVTLnBsYW5lVHJpbWVzaF0oKSB7CiAgICAgIHJldHVybiB0aGlzLnBsYW5lVHJpbWVzaDsKICAgIH0gLy8gZ2V0IFtDT0xMSVNJT05fVFlQRVMuY29udmV4VHJpbWVzaF0oKSB7CiAgICAvLyAgIHJldHVybiB0aGlzLmNvbnZleFRyaW1lc2gKICAgIC8vIH0KCgogICAgY29uc3RydWN0b3Iod29ybGQpIHsKICAgICAgdGhpcy5jb250YWN0UG9pbnRQb29sID0gW107CiAgICAgIHRoaXMuZnJpY3Rpb25FcXVhdGlvblBvb2wgPSBbXTsKICAgICAgdGhpcy5yZXN1bHQgPSBbXTsKICAgICAgdGhpcy5mcmljdGlvblJlc3VsdCA9IFtdOwogICAgICB0aGlzLnYzcG9vbCA9IG5ldyBWZWMzUG9vbCgpOwogICAgICB0aGlzLndvcmxkID0gd29ybGQ7CiAgICAgIHRoaXMuY3VycmVudENvbnRhY3RNYXRlcmlhbCA9IHdvcmxkLmRlZmF1bHRDb250YWN0TWF0ZXJpYWw7CiAgICAgIHRoaXMuZW5hYmxlRnJpY3Rpb25SZWR1Y3Rpb24gPSBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogTWFrZSBhIGNvbnRhY3Qgb2JqZWN0LCBieSB1c2luZyB0aGUgaW50ZXJuYWwgcG9vbCBvciBjcmVhdGluZyBhIG5ldyBvbmUuCiAgICAgKi8KCgogICAgY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCBvdmVycmlkZVNoYXBlQSwgb3ZlcnJpZGVTaGFwZUIpIHsKICAgICAgbGV0IGM7CgogICAgICBpZiAodGhpcy5jb250YWN0UG9pbnRQb29sLmxlbmd0aCkgewogICAgICAgIGMgPSB0aGlzLmNvbnRhY3RQb2ludFBvb2wucG9wKCk7CiAgICAgICAgYy5iaSA9IGJpOwogICAgICAgIGMuYmogPSBiajsKICAgICAgfSBlbHNlIHsKICAgICAgICBjID0gbmV3IENvbnRhY3RFcXVhdGlvbihiaSwgYmopOwogICAgICB9CgogICAgICBjLmVuYWJsZWQgPSBiaS5jb2xsaXNpb25SZXNwb25zZSAmJiBiai5jb2xsaXNpb25SZXNwb25zZSAmJiBzaS5jb2xsaXNpb25SZXNwb25zZSAmJiBzai5jb2xsaXNpb25SZXNwb25zZTsKICAgICAgY29uc3QgY20gPSB0aGlzLmN1cnJlbnRDb250YWN0TWF0ZXJpYWw7CiAgICAgIGMucmVzdGl0dXRpb24gPSBjbS5yZXN0aXR1dGlvbjsKICAgICAgYy5zZXRTcG9va1BhcmFtcyhjbS5jb250YWN0RXF1YXRpb25TdGlmZm5lc3MsIGNtLmNvbnRhY3RFcXVhdGlvblJlbGF4YXRpb24sIHRoaXMud29ybGQuZHQpOwogICAgICBjb25zdCBtYXRBID0gc2kubWF0ZXJpYWwgfHwgYmkubWF0ZXJpYWw7CiAgICAgIGNvbnN0IG1hdEIgPSBzai5tYXRlcmlhbCB8fCBiai5tYXRlcmlhbDsKCiAgICAgIGlmIChtYXRBICYmIG1hdEIgJiYgbWF0QS5yZXN0aXR1dGlvbiA+PSAwICYmIG1hdEIucmVzdGl0dXRpb24gPj0gMCkgewogICAgICAgIGMucmVzdGl0dXRpb24gPSBtYXRBLnJlc3RpdHV0aW9uICogbWF0Qi5yZXN0aXR1dGlvbjsKICAgICAgfQoKICAgICAgYy5zaSA9IG92ZXJyaWRlU2hhcGVBIHx8IHNpOwogICAgICBjLnNqID0gb3ZlcnJpZGVTaGFwZUIgfHwgc2o7CiAgICAgIHJldHVybiBjOwogICAgfQoKICAgIGNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QoY29udGFjdEVxdWF0aW9uLCBvdXRBcnJheSkgewogICAgICBjb25zdCBib2R5QSA9IGNvbnRhY3RFcXVhdGlvbi5iaTsKICAgICAgY29uc3QgYm9keUIgPSBjb250YWN0RXF1YXRpb24uYmo7CiAgICAgIGNvbnN0IHNoYXBlQSA9IGNvbnRhY3RFcXVhdGlvbi5zaTsKICAgICAgY29uc3Qgc2hhcGVCID0gY29udGFjdEVxdWF0aW9uLnNqOwogICAgICBjb25zdCB3b3JsZCA9IHRoaXMud29ybGQ7CiAgICAgIGNvbnN0IGNtID0gdGhpcy5jdXJyZW50Q29udGFjdE1hdGVyaWFsOyAvLyBJZiBmcmljdGlvbiBvciByZXN0aXR1dGlvbiB3ZXJlIHNwZWNpZmllZCBpbiB0aGUgbWF0ZXJpYWwsIHVzZSB0aGVtCgogICAgICBsZXQgZnJpY3Rpb24gPSBjbS5mcmljdGlvbjsKICAgICAgY29uc3QgbWF0QSA9IHNoYXBlQS5tYXRlcmlhbCB8fCBib2R5QS5tYXRlcmlhbDsKICAgICAgY29uc3QgbWF0QiA9IHNoYXBlQi5tYXRlcmlhbCB8fCBib2R5Qi5tYXRlcmlhbDsKCiAgICAgIGlmIChtYXRBICYmIG1hdEIgJiYgbWF0QS5mcmljdGlvbiA+PSAwICYmIG1hdEIuZnJpY3Rpb24gPj0gMCkgewogICAgICAgIGZyaWN0aW9uID0gbWF0QS5mcmljdGlvbiAqIG1hdEIuZnJpY3Rpb247CiAgICAgIH0KCiAgICAgIGlmIChmcmljdGlvbiA+IDApIHsKICAgICAgICAvLyBDcmVhdGUgMiB0YW5nZW50IGVxdWF0aW9ucwogICAgICAgIC8vIFVzZXJzIG1heSBwcm92aWRlIGEgZm9yY2UgZGlmZmVyZW50IGZyb20gZ2xvYmFsIGdyYXZpdHkgdG8gdXNlIHdoZW4gY29tcHV0aW5nIGNvbnRhY3QgZnJpY3Rpb24uCiAgICAgICAgY29uc3QgbXVnID0gZnJpY3Rpb24gKiAod29ybGQuZnJpY3Rpb25HcmF2aXR5IHx8IHdvcmxkLmdyYXZpdHkpLmxlbmd0aCgpOwogICAgICAgIGxldCByZWR1Y2VkTWFzcyA9IGJvZHlBLmludk1hc3MgKyBib2R5Qi5pbnZNYXNzOwoKICAgICAgICBpZiAocmVkdWNlZE1hc3MgPiAwKSB7CiAgICAgICAgICByZWR1Y2VkTWFzcyA9IDEgLyByZWR1Y2VkTWFzczsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHBvb2wgPSB0aGlzLmZyaWN0aW9uRXF1YXRpb25Qb29sOwogICAgICAgIGNvbnN0IGMxID0gcG9vbC5sZW5ndGggPyBwb29sLnBvcCgpIDogbmV3IEZyaWN0aW9uRXF1YXRpb24oYm9keUEsIGJvZHlCLCBtdWcgKiByZWR1Y2VkTWFzcyk7CiAgICAgICAgY29uc3QgYzIgPSBwb29sLmxlbmd0aCA/IHBvb2wucG9wKCkgOiBuZXcgRnJpY3Rpb25FcXVhdGlvbihib2R5QSwgYm9keUIsIG11ZyAqIHJlZHVjZWRNYXNzKTsKICAgICAgICBjMS5iaSA9IGMyLmJpID0gYm9keUE7CiAgICAgICAgYzEuYmogPSBjMi5iaiA9IGJvZHlCOwogICAgICAgIGMxLm1pbkZvcmNlID0gYzIubWluRm9yY2UgPSAtbXVnICogcmVkdWNlZE1hc3M7CiAgICAgICAgYzEubWF4Rm9yY2UgPSBjMi5tYXhGb3JjZSA9IG11ZyAqIHJlZHVjZWRNYXNzOyAvLyBDb3B5IG92ZXIgdGhlIHJlbGF0aXZlIHZlY3RvcnMKCiAgICAgICAgYzEucmkuY29weShjb250YWN0RXF1YXRpb24ucmkpOwogICAgICAgIGMxLnJqLmNvcHkoY29udGFjdEVxdWF0aW9uLnJqKTsKICAgICAgICBjMi5yaS5jb3B5KGNvbnRhY3RFcXVhdGlvbi5yaSk7CiAgICAgICAgYzIucmouY29weShjb250YWN0RXF1YXRpb24ucmopOyAvLyBDb25zdHJ1Y3QgdGFuZ2VudHMKCiAgICAgICAgY29udGFjdEVxdWF0aW9uLm5pLnRhbmdlbnRzKGMxLnQsIGMyLnQpOyAvLyBTZXQgc3Bvb2sgcGFyYW1zCgogICAgICAgIGMxLnNldFNwb29rUGFyYW1zKGNtLmZyaWN0aW9uRXF1YXRpb25TdGlmZm5lc3MsIGNtLmZyaWN0aW9uRXF1YXRpb25SZWxheGF0aW9uLCB3b3JsZC5kdCk7CiAgICAgICAgYzIuc2V0U3Bvb2tQYXJhbXMoY20uZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcywgY20uZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb24sIHdvcmxkLmR0KTsKICAgICAgICBjMS5lbmFibGVkID0gYzIuZW5hYmxlZCA9IGNvbnRhY3RFcXVhdGlvbi5lbmFibGVkOwogICAgICAgIG91dEFycmF5LnB1c2goYzEsIGMyKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLyoqCiAgICAgKiBUYWtlIHRoZSBhdmVyYWdlIE4gbGF0ZXN0IGNvbnRhY3QgcG9pbnQgb24gdGhlIHBsYW5lLgogICAgICovCgoKICAgIGNyZWF0ZUZyaWN0aW9uRnJvbUF2ZXJhZ2UobnVtQ29udGFjdHMpIHsKICAgICAgLy8gVGhlIGxhc3QgY29udGFjdEVxdWF0aW9uCiAgICAgIGxldCBjID0gdGhpcy5yZXN1bHRbdGhpcy5yZXN1bHQubGVuZ3RoIC0gMV07IC8vIENyZWF0ZSB0aGUgcmVzdWx0OiB0d28gImF2ZXJhZ2UiIGZyaWN0aW9uIGVxdWF0aW9ucwoKICAgICAgaWYgKCF0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QoYywgdGhpcy5mcmljdGlvblJlc3VsdCkgfHwgbnVtQ29udGFjdHMgPT09IDEpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IGYxID0gdGhpcy5mcmljdGlvblJlc3VsdFt0aGlzLmZyaWN0aW9uUmVzdWx0Lmxlbmd0aCAtIDJdOwogICAgICBjb25zdCBmMiA9IHRoaXMuZnJpY3Rpb25SZXN1bHRbdGhpcy5mcmljdGlvblJlc3VsdC5sZW5ndGggLSAxXTsKICAgICAgYXZlcmFnZU5vcm1hbC5zZXRaZXJvKCk7CiAgICAgIGF2ZXJhZ2VDb250YWN0UG9pbnRBLnNldFplcm8oKTsKICAgICAgYXZlcmFnZUNvbnRhY3RQb2ludEIuc2V0WmVybygpOwogICAgICBjb25zdCBib2R5QSA9IGMuYmk7CiAgICAgIGMuYmo7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gbnVtQ29udGFjdHM7IGkrKykgewogICAgICAgIGMgPSB0aGlzLnJlc3VsdFt0aGlzLnJlc3VsdC5sZW5ndGggLSAxIC0gaV07CgogICAgICAgIGlmIChjLmJpICE9PSBib2R5QSkgewogICAgICAgICAgYXZlcmFnZU5vcm1hbC52YWRkKGMubmksIGF2ZXJhZ2VOb3JtYWwpOwogICAgICAgICAgYXZlcmFnZUNvbnRhY3RQb2ludEEudmFkZChjLnJpLCBhdmVyYWdlQ29udGFjdFBvaW50QSk7CiAgICAgICAgICBhdmVyYWdlQ29udGFjdFBvaW50Qi52YWRkKGMucmosIGF2ZXJhZ2VDb250YWN0UG9pbnRCKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXZlcmFnZU5vcm1hbC52c3ViKGMubmksIGF2ZXJhZ2VOb3JtYWwpOwogICAgICAgICAgYXZlcmFnZUNvbnRhY3RQb2ludEEudmFkZChjLnJqLCBhdmVyYWdlQ29udGFjdFBvaW50QSk7CiAgICAgICAgICBhdmVyYWdlQ29udGFjdFBvaW50Qi52YWRkKGMucmksIGF2ZXJhZ2VDb250YWN0UG9pbnRCKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGludk51bUNvbnRhY3RzID0gMSAvIG51bUNvbnRhY3RzOwogICAgICBhdmVyYWdlQ29udGFjdFBvaW50QS5zY2FsZShpbnZOdW1Db250YWN0cywgZjEucmkpOwogICAgICBhdmVyYWdlQ29udGFjdFBvaW50Qi5zY2FsZShpbnZOdW1Db250YWN0cywgZjEucmopOwogICAgICBmMi5yaS5jb3B5KGYxLnJpKTsgLy8gU2hvdWxkIGJlIHRoZSBzYW1lCgogICAgICBmMi5yai5jb3B5KGYxLnJqKTsKICAgICAgYXZlcmFnZU5vcm1hbC5ub3JtYWxpemUoKTsKICAgICAgYXZlcmFnZU5vcm1hbC50YW5nZW50cyhmMS50LCBmMi50KTsgLy8gcmV0dXJuIGVxOwogICAgfQogICAgLyoqCiAgICAgKiBHZW5lcmF0ZSBhbGwgY29udGFjdHMgYmV0d2VlbiBhIGxpc3Qgb2YgYm9keSBwYWlycwogICAgICogQHBhcmFtIHAxIEFycmF5IG9mIGJvZHkgaW5kaWNlcwogICAgICogQHBhcmFtIHAyIEFycmF5IG9mIGJvZHkgaW5kaWNlcwogICAgICogQHBhcmFtIHJlc3VsdCBBcnJheSB0byBzdG9yZSBnZW5lcmF0ZWQgY29udGFjdHMKICAgICAqIEBwYXJhbSBvbGRjb250YWN0cyBPcHRpb25hbC4gQXJyYXkgb2YgcmV1c2FibGUgY29udGFjdCBvYmplY3RzCiAgICAgKi8KCgogICAgZ2V0Q29udGFjdHMocDEsIHAyLCB3b3JsZCwgcmVzdWx0LCBvbGRjb250YWN0cywgZnJpY3Rpb25SZXN1bHQsIGZyaWN0aW9uUG9vbCkgewogICAgICAvLyBTYXZlIG9sZCBjb250YWN0IG9iamVjdHMKICAgICAgdGhpcy5jb250YWN0UG9pbnRQb29sID0gb2xkY29udGFjdHM7CiAgICAgIHRoaXMuZnJpY3Rpb25FcXVhdGlvblBvb2wgPSBmcmljdGlvblBvb2w7CiAgICAgIHRoaXMucmVzdWx0ID0gcmVzdWx0OwogICAgICB0aGlzLmZyaWN0aW9uUmVzdWx0ID0gZnJpY3Rpb25SZXN1bHQ7CiAgICAgIGNvbnN0IHFpID0gdG1wUXVhdDE7CiAgICAgIGNvbnN0IHFqID0gdG1wUXVhdDI7CiAgICAgIGNvbnN0IHhpID0gdG1wVmVjMTsKICAgICAgY29uc3QgeGogPSB0bXBWZWMyOwoKICAgICAgZm9yIChsZXQgayA9IDAsIE4gPSBwMS5sZW5ndGg7IGsgIT09IE47IGsrKykgewogICAgICAgIC8vIEdldCBjdXJyZW50IGNvbGxpc2lvbiBib2RpZXMKICAgICAgICBjb25zdCBiaSA9IHAxW2tdOwogICAgICAgIGNvbnN0IGJqID0gcDJba107IC8vIEdldCBjb250YWN0IG1hdGVyaWFsCgogICAgICAgIGxldCBib2R5Q29udGFjdE1hdGVyaWFsID0gbnVsbDsKCiAgICAgICAgaWYgKGJpLm1hdGVyaWFsICYmIGJqLm1hdGVyaWFsKSB7CiAgICAgICAgICBib2R5Q29udGFjdE1hdGVyaWFsID0gd29ybGQuZ2V0Q29udGFjdE1hdGVyaWFsKGJpLm1hdGVyaWFsLCBiai5tYXRlcmlhbCkgfHwgbnVsbDsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGp1c3RUZXN0ID0gYmkudHlwZSAmIEJvZHkuS0lORU1BVElDICYmIGJqLnR5cGUgJiBCb2R5LlNUQVRJQyB8fCBiaS50eXBlICYgQm9keS5TVEFUSUMgJiYgYmoudHlwZSAmIEJvZHkuS0lORU1BVElDIHx8IGJpLnR5cGUgJiBCb2R5LktJTkVNQVRJQyAmJiBiai50eXBlICYgQm9keS5LSU5FTUFUSUM7CgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmkuc2hhcGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBiaS5xdWF0ZXJuaW9uLm11bHQoYmkuc2hhcGVPcmllbnRhdGlvbnNbaV0sIHFpKTsKICAgICAgICAgIGJpLnF1YXRlcm5pb24udm11bHQoYmkuc2hhcGVPZmZzZXRzW2ldLCB4aSk7CiAgICAgICAgICB4aS52YWRkKGJpLnBvc2l0aW9uLCB4aSk7CiAgICAgICAgICBjb25zdCBzaSA9IGJpLnNoYXBlc1tpXTsKCiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGJqLnNoYXBlcy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAvLyBDb21wdXRlIHdvcmxkIHRyYW5zZm9ybSBvZiBzaGFwZXMKICAgICAgICAgICAgYmoucXVhdGVybmlvbi5tdWx0KGJqLnNoYXBlT3JpZW50YXRpb25zW2pdLCBxaik7CiAgICAgICAgICAgIGJqLnF1YXRlcm5pb24udm11bHQoYmouc2hhcGVPZmZzZXRzW2pdLCB4aik7CiAgICAgICAgICAgIHhqLnZhZGQoYmoucG9zaXRpb24sIHhqKTsKICAgICAgICAgICAgY29uc3Qgc2ogPSBiai5zaGFwZXNbal07CgogICAgICAgICAgICBpZiAoIShzaS5jb2xsaXNpb25GaWx0ZXJNYXNrICYgc2ouY29sbGlzaW9uRmlsdGVyR3JvdXAgJiYgc2ouY29sbGlzaW9uRmlsdGVyTWFzayAmIHNpLmNvbGxpc2lvbkZpbHRlckdyb3VwKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoeGkuZGlzdGFuY2VUbyh4aikgPiBzaS5ib3VuZGluZ1NwaGVyZVJhZGl1cyArIHNqLmJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gLy8gR2V0IGNvbGxpc2lvbiBtYXRlcmlhbAoKCiAgICAgICAgICAgIGxldCBzaGFwZUNvbnRhY3RNYXRlcmlhbCA9IG51bGw7CgogICAgICAgICAgICBpZiAoc2kubWF0ZXJpYWwgJiYgc2oubWF0ZXJpYWwpIHsKICAgICAgICAgICAgICBzaGFwZUNvbnRhY3RNYXRlcmlhbCA9IHdvcmxkLmdldENvbnRhY3RNYXRlcmlhbChzaS5tYXRlcmlhbCwgc2oubWF0ZXJpYWwpIHx8IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuY3VycmVudENvbnRhY3RNYXRlcmlhbCA9IHNoYXBlQ29udGFjdE1hdGVyaWFsIHx8IGJvZHlDb250YWN0TWF0ZXJpYWwgfHwgd29ybGQuZGVmYXVsdENvbnRhY3RNYXRlcmlhbDsgLy8gR2V0IGNvbnRhY3RzCgogICAgICAgICAgICBjb25zdCByZXNvbHZlckluZGV4ID0gc2kudHlwZSB8IHNqLnR5cGU7CiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVyID0gdGhpc1tyZXNvbHZlckluZGV4XTsKCiAgICAgICAgICAgIGlmIChyZXNvbHZlcikgewogICAgICAgICAgICAgIGxldCByZXR2YWwgPSBmYWxzZTsgLy8gVE8gRE86IGludmVzdGlnYXRlIHdoeSBzcGhlcmVQYXJ0aWNsZSBhbmQgY29udmV4UGFydGljbGUKICAgICAgICAgICAgICAvLyByZXNvbHZlcnMgZXhwZWN0IHNpIGFuZCBzaiBzaGFwZXMgdG8gYmUgaW4gcmV2ZXJzZSBvcmRlcgogICAgICAgICAgICAgIC8vIChpLmUuIGxhcmdlciBpbnRlZ2VyIHZhbHVlIHR5cGUgZmlyc3QgaW5zdGVhZCBvZiBzbWFsbGVyIGZpcnN0KQoKICAgICAgICAgICAgICBpZiAoc2kudHlwZSA8IHNqLnR5cGUpIHsKICAgICAgICAgICAgICAgIHJldHZhbCA9IHJlc29sdmVyLmNhbGwodGhpcywgc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCBzaSwgc2osIGp1c3RUZXN0KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dmFsID0gcmVzb2x2ZXIuY2FsbCh0aGlzLCBzaiwgc2ksIHhqLCB4aSwgcWosIHFpLCBiaiwgYmksIHNpLCBzaiwganVzdFRlc3QpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKHJldHZhbCAmJiBqdXN0VGVzdCkgewogICAgICAgICAgICAgICAgLy8gUmVnaXN0ZXIgb3ZlcmxhcAogICAgICAgICAgICAgICAgd29ybGQuc2hhcGVPdmVybGFwS2VlcGVyLnNldChzaS5pZCwgc2ouaWQpOwogICAgICAgICAgICAgICAgd29ybGQuYm9keU92ZXJsYXBLZWVwZXIuc2V0KGJpLmlkLCBiai5pZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgc3BoZXJlU3BoZXJlKHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgIHJldHVybiB4aS5kaXN0YW5jZVNxdWFyZWQoeGopIDwgKHNpLnJhZGl1cyArIHNqLnJhZGl1cykgKiogMjsKICAgICAgfSAvLyBXZSB3aWxsIGhhdmUgb25seSBvbmUgY29udGFjdCBpbiB0aGlzIGNhc2UKCgogICAgICBjb25zdCBjb250YWN0RXEgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOyAvLyBDb250YWN0IG5vcm1hbAoKICAgICAgeGoudnN1Yih4aSwgY29udGFjdEVxLm5pKTsKICAgICAgY29udGFjdEVxLm5pLm5vcm1hbGl6ZSgpOyAvLyBDb250YWN0IHBvaW50IGxvY2F0aW9ucwoKICAgICAgY29udGFjdEVxLnJpLmNvcHkoY29udGFjdEVxLm5pKTsKICAgICAgY29udGFjdEVxLnJqLmNvcHkoY29udGFjdEVxLm5pKTsKICAgICAgY29udGFjdEVxLnJpLnNjYWxlKHNpLnJhZGl1cywgY29udGFjdEVxLnJpKTsKICAgICAgY29udGFjdEVxLnJqLnNjYWxlKC1zai5yYWRpdXMsIGNvbnRhY3RFcS5yaik7CiAgICAgIGNvbnRhY3RFcS5yaS52YWRkKHhpLCBjb250YWN0RXEucmkpOwogICAgICBjb250YWN0RXEucmkudnN1YihiaS5wb3NpdGlvbiwgY29udGFjdEVxLnJpKTsKICAgICAgY29udGFjdEVxLnJqLnZhZGQoeGosIGNvbnRhY3RFcS5yaik7CiAgICAgIGNvbnRhY3RFcS5yai52c3ViKGJqLnBvc2l0aW9uLCBjb250YWN0RXEucmopOwogICAgICB0aGlzLnJlc3VsdC5wdXNoKGNvbnRhY3RFcSk7CiAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChjb250YWN0RXEsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgfQoKICAgIHNwaGVyZVBsYW5lKHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIC8vIFdlIHdpbGwgaGF2ZSBvbmUgY29udGFjdCBpbiB0aGlzIGNhc2UKICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7IC8vIENvbnRhY3Qgbm9ybWFsCgogICAgICByLm5pLnNldCgwLCAwLCAxKTsKICAgICAgcWoudm11bHQoci5uaSwgci5uaSk7CiAgICAgIHIubmkubmVnYXRlKHIubmkpOyAvLyBib2R5IGkgaXMgdGhlIHNwaGVyZSwgZmxpcCBub3JtYWwKCiAgICAgIHIubmkubm9ybWFsaXplKCk7IC8vIE5lZWRlZD8KICAgICAgLy8gVmVjdG9yIGZyb20gc3BoZXJlIGNlbnRlciB0byBjb250YWN0IHBvaW50CgogICAgICByLm5pLnNjYWxlKHNpLnJhZGl1cywgci5yaSk7IC8vIFByb2plY3QgZG93biBzcGhlcmUgb24gcGxhbmUKCiAgICAgIHhpLnZzdWIoeGosIHBvaW50X29uX3BsYW5lX3RvX3NwaGVyZSk7CiAgICAgIHIubmkuc2NhbGUoci5uaS5kb3QocG9pbnRfb25fcGxhbmVfdG9fc3BoZXJlKSwgcGxhbmVfdG9fc3BoZXJlX29ydGhvKTsKICAgICAgcG9pbnRfb25fcGxhbmVfdG9fc3BoZXJlLnZzdWIocGxhbmVfdG9fc3BoZXJlX29ydGhvLCByLnJqKTsgLy8gVGhlIHNwaGVyZSBwb3NpdGlvbiBwcm9qZWN0ZWQgdG8gcGxhbmUKCiAgICAgIGlmICgtcG9pbnRfb25fcGxhbmVfdG9fc3BoZXJlLmRvdChyLm5pKSA8PSBzaS5yYWRpdXMpIHsKICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gLy8gTWFrZSBpdCByZWxhdGl2ZSB0byB0aGUgYm9keQoKCiAgICAgICAgY29uc3QgcmkgPSByLnJpOwogICAgICAgIGNvbnN0IHJqID0gci5yajsKICAgICAgICByaS52YWRkKHhpLCByaSk7CiAgICAgICAgcmkudnN1YihiaS5wb3NpdGlvbiwgcmkpOwogICAgICAgIHJqLnZhZGQoeGosIHJqKTsKICAgICAgICByai52c3ViKGJqLnBvc2l0aW9uLCByaik7CiAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICAgIH0KICAgIH0KCiAgICBib3hCb3goc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLm1hdGVyaWFsID0gc2kubWF0ZXJpYWw7CiAgICAgIHNqLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5tYXRlcmlhbCA9IHNqLm1hdGVyaWFsOwogICAgICBzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24uY29sbGlzaW9uUmVzcG9uc2UgPSBzaS5jb2xsaXNpb25SZXNwb25zZTsKICAgICAgc2ouY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLmNvbGxpc2lvblJlc3BvbnNlID0gc2ouY29sbGlzaW9uUmVzcG9uc2U7CiAgICAgIHJldHVybiB0aGlzLmNvbnZleENvbnZleChzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24sIHNqLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgc2ksIHNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgc3BoZXJlQm94KHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIGNvbnN0IHYzcG9vbCA9IHRoaXMudjNwb29sOyAvLyB3ZSByZWZlciB0byB0aGUgYm94IGFzIGJvZHkgagoKICAgICAgY29uc3Qgc2lkZXMgPSBzcGhlcmVCb3hfc2lkZXM7CiAgICAgIHhpLnZzdWIoeGosIGJveF90b19zcGhlcmUpOwogICAgICBzai5nZXRTaWRlTm9ybWFscyhzaWRlcywgcWopOwogICAgICBjb25zdCBSID0gc2kucmFkaXVzOwoKICAgICAgbGV0IGZvdW5kID0gZmFsc2U7IC8vIFN0b3JlIHRoZSByZXN1bHRpbmcgc2lkZSBwZW5ldHJhdGlvbiBpbmZvCgogICAgICBjb25zdCBzaWRlX25zID0gc3BoZXJlQm94X3NpZGVfbnM7CiAgICAgIGNvbnN0IHNpZGVfbnMxID0gc3BoZXJlQm94X3NpZGVfbnMxOwogICAgICBjb25zdCBzaWRlX25zMiA9IHNwaGVyZUJveF9zaWRlX25zMjsKICAgICAgbGV0IHNpZGVfaCA9IG51bGw7CiAgICAgIGxldCBzaWRlX3BlbmV0cmF0aW9ucyA9IDA7CiAgICAgIGxldCBzaWRlX2RvdDEgPSAwOwogICAgICBsZXQgc2lkZV9kb3QyID0gMDsKICAgICAgbGV0IHNpZGVfZGlzdGFuY2UgPSBudWxsOwoKICAgICAgZm9yIChsZXQgaWR4ID0gMCwgbnNpZGVzID0gc2lkZXMubGVuZ3RoOyBpZHggIT09IG5zaWRlcyAmJiBmb3VuZCA9PT0gZmFsc2U7IGlkeCsrKSB7CiAgICAgICAgLy8gR2V0IHRoZSBwbGFuZSBzaWRlIG5vcm1hbCAobnMpCiAgICAgICAgY29uc3QgbnMgPSBzcGhlcmVCb3hfbnM7CiAgICAgICAgbnMuY29weShzaWRlc1tpZHhdKTsKICAgICAgICBjb25zdCBoID0gbnMubGVuZ3RoKCk7CiAgICAgICAgbnMubm9ybWFsaXplKCk7IC8vIFRoZSBub3JtYWwvZGlzdGFuY2UgZG90IHByb2R1Y3QgdGVsbHMgd2hpY2ggc2lkZSBvZiB0aGUgcGxhbmUgd2UgYXJlCgogICAgICAgIGNvbnN0IGRvdCA9IGJveF90b19zcGhlcmUuZG90KG5zKTsKCiAgICAgICAgaWYgKGRvdCA8IGggKyBSICYmIGRvdCA+IDApIHsKICAgICAgICAgIC8vIEludGVyc2VjdHMgcGxhbmUuIE5vdyBjaGVjayB0aGUgb3RoZXIgdHdvIGRpbWVuc2lvbnMKICAgICAgICAgIGNvbnN0IG5zMSA9IHNwaGVyZUJveF9uczE7CiAgICAgICAgICBjb25zdCBuczIgPSBzcGhlcmVCb3hfbnMyOwogICAgICAgICAgbnMxLmNvcHkoc2lkZXNbKGlkeCArIDEpICUgM10pOwogICAgICAgICAgbnMyLmNvcHkoc2lkZXNbKGlkeCArIDIpICUgM10pOwogICAgICAgICAgY29uc3QgaDEgPSBuczEubGVuZ3RoKCk7CiAgICAgICAgICBjb25zdCBoMiA9IG5zMi5sZW5ndGgoKTsKICAgICAgICAgIG5zMS5ub3JtYWxpemUoKTsKICAgICAgICAgIG5zMi5ub3JtYWxpemUoKTsKICAgICAgICAgIGNvbnN0IGRvdDEgPSBib3hfdG9fc3BoZXJlLmRvdChuczEpOwogICAgICAgICAgY29uc3QgZG90MiA9IGJveF90b19zcGhlcmUuZG90KG5zMik7CgogICAgICAgICAgaWYgKGRvdDEgPCBoMSAmJiBkb3QxID4gLWgxICYmIGRvdDIgPCBoMiAmJiBkb3QyID4gLWgyKSB7CiAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLmFicyhkb3QgLSBoIC0gUik7CgogICAgICAgICAgICBpZiAoc2lkZV9kaXN0YW5jZSA9PT0gbnVsbCB8fCBkaXN0IDwgc2lkZV9kaXN0YW5jZSkgewogICAgICAgICAgICAgIHNpZGVfZGlzdGFuY2UgPSBkaXN0OwogICAgICAgICAgICAgIHNpZGVfZG90MSA9IGRvdDE7CiAgICAgICAgICAgICAgc2lkZV9kb3QyID0gZG90MjsKICAgICAgICAgICAgICBzaWRlX2ggPSBoOwogICAgICAgICAgICAgIHNpZGVfbnMuY29weShucyk7CiAgICAgICAgICAgICAgc2lkZV9uczEuY29weShuczEpOwogICAgICAgICAgICAgIHNpZGVfbnMyLmNvcHkobnMyKTsKICAgICAgICAgICAgICBzaWRlX3BlbmV0cmF0aW9ucysrOwoKICAgICAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHNpZGVfcGVuZXRyYXRpb25zKSB7CiAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgIHNpZGVfbnMuc2NhbGUoLVIsIHIucmkpOyAvLyBTcGhlcmUgcgoKICAgICAgICByLm5pLmNvcHkoc2lkZV9ucyk7CiAgICAgICAgci5uaS5uZWdhdGUoci5uaSk7IC8vIE5vcm1hbCBzaG91bGQgYmUgb3V0IG9mIHNwaGVyZQoKICAgICAgICBzaWRlX25zLnNjYWxlKHNpZGVfaCwgc2lkZV9ucyk7CiAgICAgICAgc2lkZV9uczEuc2NhbGUoc2lkZV9kb3QxLCBzaWRlX25zMSk7CiAgICAgICAgc2lkZV9ucy52YWRkKHNpZGVfbnMxLCBzaWRlX25zKTsKICAgICAgICBzaWRlX25zMi5zY2FsZShzaWRlX2RvdDIsIHNpZGVfbnMyKTsKICAgICAgICBzaWRlX25zLnZhZGQoc2lkZV9uczIsIHIucmopOyAvLyBNYWtlIHJlbGF0aXZlIHRvIGJvZGllcwoKICAgICAgICByLnJpLnZhZGQoeGksIHIucmkpOwogICAgICAgIHIucmkudnN1YihiaS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgci5yai52YWRkKHhqLCByLnJqKTsKICAgICAgICByLnJqLnZzdWIoYmoucG9zaXRpb24sIHIucmopOwogICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICB9IC8vIENoZWNrIGNvcm5lcnMKCgogICAgICBsZXQgcmogPSB2M3Bvb2wuZ2V0KCk7CiAgICAgIGNvbnN0IHNwaGVyZV90b19jb3JuZXIgPSBzcGhlcmVCb3hfc3BoZXJlX3RvX2Nvcm5lcjsKCiAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSAyICYmICFmb3VuZDsgaisrKSB7CiAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgIT09IDIgJiYgIWZvdW5kOyBrKyspIHsKICAgICAgICAgIGZvciAobGV0IGwgPSAwOyBsICE9PSAyICYmICFmb3VuZDsgbCsrKSB7CiAgICAgICAgICAgIHJqLnNldCgwLCAwLCAwKTsKCiAgICAgICAgICAgIGlmIChqKSB7CiAgICAgICAgICAgICAgcmoudmFkZChzaWRlc1swXSwgcmopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJqLnZzdWIoc2lkZXNbMF0sIHJqKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGspIHsKICAgICAgICAgICAgICByai52YWRkKHNpZGVzWzFdLCByaik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmoudnN1YihzaWRlc1sxXSwgcmopOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobCkgewogICAgICAgICAgICAgIHJqLnZhZGQoc2lkZXNbMl0sIHJqKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByai52c3ViKHNpZGVzWzJdLCByaik7CiAgICAgICAgICAgIH0gLy8gV29ybGQgcG9zaXRpb24gb2YgY29ybmVyCgoKICAgICAgICAgICAgeGoudmFkZChyaiwgc3BoZXJlX3RvX2Nvcm5lcik7CiAgICAgICAgICAgIHNwaGVyZV90b19jb3JuZXIudnN1Yih4aSwgc3BoZXJlX3RvX2Nvcm5lcik7CgogICAgICAgICAgICBpZiAoc3BoZXJlX3RvX2Nvcm5lci5sZW5ndGhTcXVhcmVkKCkgPCBSICogUikgewogICAgICAgICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7CiAgICAgICAgICAgICAgci5yaS5jb3B5KHNwaGVyZV90b19jb3JuZXIpOwogICAgICAgICAgICAgIHIucmkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgci5uaS5jb3B5KHIucmkpOwogICAgICAgICAgICAgIHIucmkuc2NhbGUoUiwgci5yaSk7CiAgICAgICAgICAgICAgci5yai5jb3B5KHJqKTsgLy8gTWFrZSByZWxhdGl2ZSB0byBib2RpZXMKCiAgICAgICAgICAgICAgci5yaS52YWRkKHhpLCByLnJpKTsKICAgICAgICAgICAgICByLnJpLnZzdWIoYmkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgICAgIHIucmoudmFkZCh4aiwgci5yaik7CiAgICAgICAgICAgICAgci5yai52c3ViKGJqLnBvc2l0aW9uLCByLnJqKTsKICAgICAgICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgdjNwb29sLnJlbGVhc2UocmopOwogICAgICByaiA9IG51bGw7IC8vIENoZWNrIGVkZ2VzCgogICAgICBjb25zdCBlZGdlVGFuZ2VudCA9IHYzcG9vbC5nZXQoKTsKICAgICAgY29uc3QgZWRnZUNlbnRlciA9IHYzcG9vbC5nZXQoKTsKICAgICAgY29uc3QgciA9IHYzcG9vbC5nZXQoKTsgLy8gciA9IGVkZ2UgY2VudGVyIHRvIHNwaGVyZSBjZW50ZXIKCiAgICAgIGNvbnN0IG9ydGhvZ29uYWwgPSB2M3Bvb2wuZ2V0KCk7CiAgICAgIGNvbnN0IGRpc3QgPSB2M3Bvb2wuZ2V0KCk7CiAgICAgIGNvbnN0IE5zaWRlcyA9IHNpZGVzLmxlbmd0aDsKCiAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSBOc2lkZXMgJiYgIWZvdW5kOyBqKyspIHsKICAgICAgICBmb3IgKGxldCBrID0gMDsgayAhPT0gTnNpZGVzICYmICFmb3VuZDsgaysrKSB7CiAgICAgICAgICBpZiAoaiAlIDMgIT09IGsgJSAzKSB7CiAgICAgICAgICAgIC8vIEdldCBlZGdlIHRhbmdlbnQKICAgICAgICAgICAgc2lkZXNba10uY3Jvc3Moc2lkZXNbal0sIGVkZ2VUYW5nZW50KTsKICAgICAgICAgICAgZWRnZVRhbmdlbnQubm9ybWFsaXplKCk7CiAgICAgICAgICAgIHNpZGVzW2pdLnZhZGQoc2lkZXNba10sIGVkZ2VDZW50ZXIpOwogICAgICAgICAgICByLmNvcHkoeGkpOwogICAgICAgICAgICByLnZzdWIoZWRnZUNlbnRlciwgcik7CiAgICAgICAgICAgIHIudnN1Yih4aiwgcik7CiAgICAgICAgICAgIGNvbnN0IG9ydGhvbm9ybSA9IHIuZG90KGVkZ2VUYW5nZW50KTsgLy8gZGlzdGFuY2UgZnJvbSBlZGdlIGNlbnRlciB0byBzcGhlcmUgY2VudGVyIGluIHRoZSB0YW5nZW50IGRpcmVjdGlvbgoKICAgICAgICAgICAgZWRnZVRhbmdlbnQuc2NhbGUob3J0aG9ub3JtLCBvcnRob2dvbmFsKTsgLy8gVmVjdG9yIGZyb20gZWRnZSBjZW50ZXIgdG8gc3BoZXJlIGNlbnRlciBpbiB0aGUgdGFuZ2VudCBkaXJlY3Rpb24KICAgICAgICAgICAgLy8gRmluZCB0aGUgdGhpcmQgc2lkZSBvcnRob2dvbmFsIHRvIHRoaXMgb25lCgogICAgICAgICAgICBsZXQgbCA9IDA7CgogICAgICAgICAgICB3aGlsZSAobCA9PT0gaiAlIDMgfHwgbCA9PT0gayAlIDMpIHsKICAgICAgICAgICAgICBsKys7CiAgICAgICAgICAgIH0gLy8gdmVjIGZyb20gZWRnZSBjZW50ZXIgdG8gc3BoZXJlIHByb2plY3RlZCB0byB0aGUgcGxhbmUgb3J0aG9nb25hbCB0byB0aGUgZWRnZSB0YW5nZW50CgoKICAgICAgICAgICAgZGlzdC5jb3B5KHhpKTsKICAgICAgICAgICAgZGlzdC52c3ViKG9ydGhvZ29uYWwsIGRpc3QpOwogICAgICAgICAgICBkaXN0LnZzdWIoZWRnZUNlbnRlciwgZGlzdCk7CiAgICAgICAgICAgIGRpc3QudnN1Yih4aiwgZGlzdCk7IC8vIERpc3RhbmNlcyBpbiB0YW5nZW50IGRpcmVjdGlvbiBhbmQgZGlzdGFuY2UgaW4gdGhlIHBsYW5lIG9ydGhvZ29uYWwgdG8gaXQKCiAgICAgICAgICAgIGNvbnN0IHRkaXN0ID0gTWF0aC5hYnMob3J0aG9ub3JtKTsKICAgICAgICAgICAgY29uc3QgbmRpc3QgPSBkaXN0Lmxlbmd0aCgpOwoKICAgICAgICAgICAgaWYgKHRkaXN0IDwgc2lkZXNbbF0ubGVuZ3RoKCkgJiYgbmRpc3QgPCBSKSB7CiAgICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICBjb25zdCByZXMgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgICAgICAgIGVkZ2VDZW50ZXIudmFkZChvcnRob2dvbmFsLCByZXMucmopOyAvLyBib3ggcmoKCiAgICAgICAgICAgICAgcmVzLnJqLmNvcHkocmVzLnJqKTsKICAgICAgICAgICAgICBkaXN0Lm5lZ2F0ZShyZXMubmkpOwogICAgICAgICAgICAgIHJlcy5uaS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICByZXMucmkuY29weShyZXMucmopOwogICAgICAgICAgICAgIHJlcy5yaS52YWRkKHhqLCByZXMucmkpOwogICAgICAgICAgICAgIHJlcy5yaS52c3ViKHhpLCByZXMucmkpOwogICAgICAgICAgICAgIHJlcy5yaS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICByZXMucmkuc2NhbGUoUiwgcmVzLnJpKTsgLy8gTWFrZSByZWxhdGl2ZSB0byBib2RpZXMKCiAgICAgICAgICAgICAgcmVzLnJpLnZhZGQoeGksIHJlcy5yaSk7CiAgICAgICAgICAgICAgcmVzLnJpLnZzdWIoYmkucG9zaXRpb24sIHJlcy5yaSk7CiAgICAgICAgICAgICAgcmVzLnJqLnZhZGQoeGosIHJlcy5yaik7CiAgICAgICAgICAgICAgcmVzLnJqLnZzdWIoYmoucG9zaXRpb24sIHJlcy5yaik7CiAgICAgICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyZXMpOwogICAgICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyZXMsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB2M3Bvb2wucmVsZWFzZShlZGdlVGFuZ2VudCwgZWRnZUNlbnRlciwgciwgb3J0aG9nb25hbCwgZGlzdCk7CiAgICB9CgogICAgcGxhbmVCb3goc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgc2ouY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLm1hdGVyaWFsID0gc2oubWF0ZXJpYWw7CiAgICAgIHNqLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5jb2xsaXNpb25SZXNwb25zZSA9IHNqLmNvbGxpc2lvblJlc3BvbnNlOwogICAgICBzai5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24uaWQgPSBzai5pZDsKICAgICAgcmV0dXJuIHRoaXMucGxhbmVDb252ZXgoc2ksIHNqLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgc2ksIHNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgY29udmV4Q29udmV4KHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0LCBmYWNlTGlzdEEsIGZhY2VMaXN0QikgewogICAgICBjb25zdCBzZXBBeGlzID0gY29udmV4Q29udmV4X3NlcEF4aXM7CgogICAgICBpZiAoeGkuZGlzdGFuY2VUbyh4aikgPiBzaS5ib3VuZGluZ1NwaGVyZVJhZGl1cyArIHNqLmJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoc2kuZmluZFNlcGFyYXRpbmdBeGlzKHNqLCB4aSwgcWksIHhqLCBxaiwgc2VwQXhpcywgZmFjZUxpc3RBLCBmYWNlTGlzdEIpKSB7CiAgICAgICAgY29uc3QgcmVzID0gW107CiAgICAgICAgY29uc3QgcSA9IGNvbnZleENvbnZleF9xOwogICAgICAgIHNpLmNsaXBBZ2FpbnN0SHVsbCh4aSwgcWksIHNqLCB4aiwgcWosIHNlcEF4aXMsIC0xMDAsIDEwMCwgcmVzKTsKICAgICAgICBsZXQgbnVtQ29udGFjdHMgPSAwOwoKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiAhPT0gcmVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7CiAgICAgICAgICBjb25zdCByaSA9IHIucmk7CiAgICAgICAgICBjb25zdCByaiA9IHIucmo7CiAgICAgICAgICBzZXBBeGlzLm5lZ2F0ZShyLm5pKTsKICAgICAgICAgIHJlc1tqXS5ub3JtYWwubmVnYXRlKHEpOwogICAgICAgICAgcS5zY2FsZShyZXNbal0uZGVwdGgsIHEpOwogICAgICAgICAgcmVzW2pdLnBvaW50LnZhZGQocSwgcmkpOwogICAgICAgICAgcmouY29weShyZXNbal0ucG9pbnQpOyAvLyBDb250YWN0IHBvaW50cyBhcmUgaW4gd29ybGQgY29vcmRpbmF0ZXMuIFRyYW5zZm9ybSBiYWNrIHRvIHJlbGF0aXZlCgogICAgICAgICAgcmkudnN1Yih4aSwgcmkpOwogICAgICAgICAgcmoudnN1Yih4aiwgcmopOyAvLyBNYWtlIHJlbGF0aXZlIHRvIGJvZGllcwoKICAgICAgICAgIHJpLnZhZGQoeGksIHJpKTsKICAgICAgICAgIHJpLnZzdWIoYmkucG9zaXRpb24sIHJpKTsKICAgICAgICAgIHJqLnZhZGQoeGosIHJqKTsKICAgICAgICAgIHJqLnZzdWIoYmoucG9zaXRpb24sIHJqKTsKICAgICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgICBudW1Db250YWN0cysrOwoKICAgICAgICAgIGlmICghdGhpcy5lbmFibGVGcmljdGlvblJlZHVjdGlvbikgewogICAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5lbmFibGVGcmljdGlvblJlZHVjdGlvbiAmJiBudW1Db250YWN0cykgewogICAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkZyb21BdmVyYWdlKG51bUNvbnRhY3RzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBzcGhlcmVDb252ZXgoc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgY29uc3QgdjNwb29sID0gdGhpcy52M3Bvb2w7CiAgICAgIHhpLnZzdWIoeGosIGNvbnZleF90b19zcGhlcmUpOwogICAgICBjb25zdCBub3JtYWxzID0gc2ouZmFjZU5vcm1hbHM7CiAgICAgIGNvbnN0IGZhY2VzID0gc2ouZmFjZXM7CiAgICAgIGNvbnN0IHZlcnRzID0gc2oudmVydGljZXM7CiAgICAgIGNvbnN0IFIgPSBzaS5yYWRpdXM7CiAgICAgIC8vICAgICByZXR1cm47CiAgICAgIC8vIH0KCiAgICAgIGxldCBmb3VuZCA9IGZhbHNlOyAvLyBDaGVjayBjb3JuZXJzCgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gdmVydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB2ID0gdmVydHNbaV07IC8vIFdvcmxkIHBvc2l0aW9uIG9mIGNvcm5lcgoKICAgICAgICBjb25zdCB3b3JsZENvcm5lciA9IHNwaGVyZUNvbnZleF93b3JsZENvcm5lcjsKICAgICAgICBxai52bXVsdCh2LCB3b3JsZENvcm5lcik7CiAgICAgICAgeGoudmFkZCh3b3JsZENvcm5lciwgd29ybGRDb3JuZXIpOwogICAgICAgIGNvbnN0IHNwaGVyZV90b19jb3JuZXIgPSBzcGhlcmVDb252ZXhfc3BoZXJlVG9Db3JuZXI7CiAgICAgICAgd29ybGRDb3JuZXIudnN1Yih4aSwgc3BoZXJlX3RvX2Nvcm5lcik7CgogICAgICAgIGlmIChzcGhlcmVfdG9fY29ybmVyLmxlbmd0aFNxdWFyZWQoKSA8IFIgKiBSKSB7CiAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7CiAgICAgICAgICByLnJpLmNvcHkoc3BoZXJlX3RvX2Nvcm5lcik7CiAgICAgICAgICByLnJpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgci5uaS5jb3B5KHIucmkpOwogICAgICAgICAgci5yaS5zY2FsZShSLCByLnJpKTsKICAgICAgICAgIHdvcmxkQ29ybmVyLnZzdWIoeGosIHIucmopOyAvLyBTaG91bGQgYmUgcmVsYXRpdmUgdG8gdGhlIGJvZHkuCgogICAgICAgICAgci5yaS52YWRkKHhpLCByLnJpKTsKICAgICAgICAgIHIucmkudnN1YihiaS5wb3NpdGlvbiwgci5yaSk7IC8vIFNob3VsZCBiZSByZWxhdGl2ZSB0byB0aGUgYm9keS4KCiAgICAgICAgICByLnJqLnZhZGQoeGosIHIucmopOwogICAgICAgICAgci5yai52c3ViKGJqLnBvc2l0aW9uLCByLnJqKTsKICAgICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9IC8vIENoZWNrIHNpZGUgKHBsYW5lKSBpbnRlcnNlY3Rpb25zCgoKICAgICAgZm9yIChsZXQgaSA9IDAsIG5mYWNlcyA9IGZhY2VzLmxlbmd0aDsgaSAhPT0gbmZhY2VzICYmIGZvdW5kID09PSBmYWxzZTsgaSsrKSB7CiAgICAgICAgY29uc3Qgbm9ybWFsID0gbm9ybWFsc1tpXTsKICAgICAgICBjb25zdCBmYWNlID0gZmFjZXNbaV07IC8vIEdldCB3b3JsZC10cmFuc2Zvcm1lZCBub3JtYWwgb2YgdGhlIGZhY2UKCiAgICAgICAgY29uc3Qgd29ybGROb3JtYWwgPSBzcGhlcmVDb252ZXhfd29ybGROb3JtYWw7CiAgICAgICAgcWoudm11bHQobm9ybWFsLCB3b3JsZE5vcm1hbCk7IC8vIEdldCBhIHdvcmxkIHZlcnRleCBmcm9tIHRoZSBmYWNlCgogICAgICAgIGNvbnN0IHdvcmxkUG9pbnQgPSBzcGhlcmVDb252ZXhfd29ybGRQb2ludDsKICAgICAgICBxai52bXVsdCh2ZXJ0c1tmYWNlWzBdXSwgd29ybGRQb2ludCk7CiAgICAgICAgd29ybGRQb2ludC52YWRkKHhqLCB3b3JsZFBvaW50KTsgLy8gR2V0IGEgcG9pbnQgb24gdGhlIHNwaGVyZSwgY2xvc2VzdCB0byB0aGUgZmFjZSBub3JtYWwKCiAgICAgICAgY29uc3Qgd29ybGRTcGhlcmVQb2ludENsb3Nlc3RUb1BsYW5lID0gc3BoZXJlQ29udmV4X3dvcmxkU3BoZXJlUG9pbnRDbG9zZXN0VG9QbGFuZTsKICAgICAgICB3b3JsZE5vcm1hbC5zY2FsZSgtUiwgd29ybGRTcGhlcmVQb2ludENsb3Nlc3RUb1BsYW5lKTsKICAgICAgICB4aS52YWRkKHdvcmxkU3BoZXJlUG9pbnRDbG9zZXN0VG9QbGFuZSwgd29ybGRTcGhlcmVQb2ludENsb3Nlc3RUb1BsYW5lKTsgLy8gVmVjdG9yIGZyb20gYSBmYWNlIHBvaW50IHRvIHRoZSBjbG9zZXN0IHBvaW50IG9uIHRoZSBzcGhlcmUKCiAgICAgICAgY29uc3QgcGVuZXRyYXRpb25WZWMgPSBzcGhlcmVDb252ZXhfcGVuZXRyYXRpb25WZWM7CiAgICAgICAgd29ybGRTcGhlcmVQb2ludENsb3Nlc3RUb1BsYW5lLnZzdWIod29ybGRQb2ludCwgcGVuZXRyYXRpb25WZWMpOyAvLyBUaGUgcGVuZXRyYXRpb24uIE5lZ2F0aXZlIHZhbHVlIG1lYW5zIG92ZXJsYXAuCgogICAgICAgIGNvbnN0IHBlbmV0cmF0aW9uID0gcGVuZXRyYXRpb25WZWMuZG90KHdvcmxkTm9ybWFsKTsKICAgICAgICBjb25zdCB3b3JsZFBvaW50VG9TcGhlcmUgPSBzcGhlcmVDb252ZXhfc3BoZXJlVG9Xb3JsZFBvaW50OwogICAgICAgIHhpLnZzdWIod29ybGRQb2ludCwgd29ybGRQb2ludFRvU3BoZXJlKTsKCiAgICAgICAgaWYgKHBlbmV0cmF0aW9uIDwgMCAmJiB3b3JsZFBvaW50VG9TcGhlcmUuZG90KHdvcmxkTm9ybWFsKSA+IDApIHsKICAgICAgICAgIC8vIEludGVyc2VjdHMgcGxhbmUuIE5vdyBjaGVjayBpZiB0aGUgc3BoZXJlIGlzIGluc2lkZSB0aGUgZmFjZSBwb2x5Z29uCiAgICAgICAgICBjb25zdCBmYWNlVmVydHMgPSBbXTsgLy8gRmFjZSB2ZXJ0aWNlcywgaW4gd29ybGQgY29vcmRzCgogICAgICAgICAgZm9yIChsZXQgaiA9IDAsIE52ZXJ0cyA9IGZhY2UubGVuZ3RoOyBqICE9PSBOdmVydHM7IGorKykgewogICAgICAgICAgICBjb25zdCB3b3JsZFZlcnRleCA9IHYzcG9vbC5nZXQoKTsKICAgICAgICAgICAgcWoudm11bHQodmVydHNbZmFjZVtqXV0sIHdvcmxkVmVydGV4KTsKICAgICAgICAgICAgeGoudmFkZCh3b3JsZFZlcnRleCwgd29ybGRWZXJ0ZXgpOwogICAgICAgICAgICBmYWNlVmVydHMucHVzaCh3b3JsZFZlcnRleCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHBvaW50SW5Qb2x5Z29uKGZhY2VWZXJ0cywgd29ybGROb3JtYWwsIHhpKSkgewogICAgICAgICAgICAvLyBJcyB0aGUgc3BoZXJlIGNlbnRlciBpbiB0aGUgZmFjZSBwb2x5Z29uPwogICAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oYmksIGJqLCBzaSwgc2osIHJzaSwgcnNqKTsKICAgICAgICAgICAgd29ybGROb3JtYWwuc2NhbGUoLVIsIHIucmkpOyAvLyBDb250YWN0IG9mZnNldCwgZnJvbSBzcGhlcmUgY2VudGVyIHRvIGNvbnRhY3QKCiAgICAgICAgICAgIHdvcmxkTm9ybWFsLm5lZ2F0ZShyLm5pKTsgLy8gTm9ybWFsIHBvaW50aW5nIG91dCBvZiBzcGhlcmUKCiAgICAgICAgICAgIGNvbnN0IHBlbmV0cmF0aW9uVmVjMiA9IHYzcG9vbC5nZXQoKTsKICAgICAgICAgICAgd29ybGROb3JtYWwuc2NhbGUoLXBlbmV0cmF0aW9uLCBwZW5ldHJhdGlvblZlYzIpOwogICAgICAgICAgICBjb25zdCBwZW5ldHJhdGlvblNwaGVyZVBvaW50ID0gdjNwb29sLmdldCgpOwogICAgICAgICAgICB3b3JsZE5vcm1hbC5zY2FsZSgtUiwgcGVuZXRyYXRpb25TcGhlcmVQb2ludCk7IC8veGkudnN1Yih4aikudmFkZChwZW5ldHJhdGlvblNwaGVyZVBvaW50KS52YWRkKHBlbmV0cmF0aW9uVmVjMiAsIHIucmopOwoKICAgICAgICAgICAgeGkudnN1Yih4aiwgci5yaik7CiAgICAgICAgICAgIHIucmoudmFkZChwZW5ldHJhdGlvblNwaGVyZVBvaW50LCByLnJqKTsKICAgICAgICAgICAgci5yai52YWRkKHBlbmV0cmF0aW9uVmVjMiwgci5yaik7IC8vIFNob3VsZCBiZSByZWxhdGl2ZSB0byB0aGUgYm9keS4KCiAgICAgICAgICAgIHIucmoudmFkZCh4aiwgci5yaik7CiAgICAgICAgICAgIHIucmoudnN1Yihiai5wb3NpdGlvbiwgci5yaik7IC8vIFNob3VsZCBiZSByZWxhdGl2ZSB0byB0aGUgYm9keS4KCiAgICAgICAgICAgIHIucmkudmFkZCh4aSwgci5yaSk7CiAgICAgICAgICAgIHIucmkudnN1YihiaS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHBlbmV0cmF0aW9uVmVjMik7CiAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHBlbmV0cmF0aW9uU3BoZXJlUG9pbnQpOwogICAgICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7IC8vIFJlbGVhc2Ugd29ybGQgdmVydGljZXMKCiAgICAgICAgICAgIGZvciAobGV0IGogPSAwLCBOZmFjZXZlcnRzID0gZmFjZVZlcnRzLmxlbmd0aDsgaiAhPT0gTmZhY2V2ZXJ0czsgaisrKSB7CiAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UoZmFjZVZlcnRzW2pdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuOyAvLyBXZSBvbmx5IGV4cGVjdCAqb25lKiBmYWNlIGNvbnRhY3QKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIEVkZ2U/CiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSBmYWNlLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgLy8gR2V0IHR3byB3b3JsZCB0cmFuc2Zvcm1lZCB2ZXJ0aWNlcwogICAgICAgICAgICAgIGNvbnN0IHYxID0gdjNwb29sLmdldCgpOwogICAgICAgICAgICAgIGNvbnN0IHYyID0gdjNwb29sLmdldCgpOwogICAgICAgICAgICAgIHFqLnZtdWx0KHZlcnRzW2ZhY2VbKGogKyAxKSAlIGZhY2UubGVuZ3RoXV0sIHYxKTsKICAgICAgICAgICAgICBxai52bXVsdCh2ZXJ0c1tmYWNlWyhqICsgMikgJSBmYWNlLmxlbmd0aF1dLCB2Mik7CiAgICAgICAgICAgICAgeGoudmFkZCh2MSwgdjEpOwogICAgICAgICAgICAgIHhqLnZhZGQodjIsIHYyKTsgLy8gQ29uc3RydWN0IGVkZ2UgdmVjdG9yCgogICAgICAgICAgICAgIGNvbnN0IGVkZ2UgPSBzcGhlcmVDb252ZXhfZWRnZTsKICAgICAgICAgICAgICB2Mi52c3ViKHYxLCBlZGdlKTsgLy8gQ29uc3RydWN0IHRoZSBzYW1lIHZlY3RvciwgYnV0IG5vcm1hbGl6ZWQKCiAgICAgICAgICAgICAgY29uc3QgZWRnZVVuaXQgPSBzcGhlcmVDb252ZXhfZWRnZVVuaXQ7CiAgICAgICAgICAgICAgZWRnZS51bml0KGVkZ2VVbml0KTsgLy8gcCBpcyB4aSBwcm9qZWN0ZWQgb250byB0aGUgZWRnZQoKICAgICAgICAgICAgICBjb25zdCBwID0gdjNwb29sLmdldCgpOwogICAgICAgICAgICAgIGNvbnN0IHYxX3RvX3hpID0gdjNwb29sLmdldCgpOwogICAgICAgICAgICAgIHhpLnZzdWIodjEsIHYxX3RvX3hpKTsKICAgICAgICAgICAgICBjb25zdCBkb3QgPSB2MV90b194aS5kb3QoZWRnZVVuaXQpOwogICAgICAgICAgICAgIGVkZ2VVbml0LnNjYWxlKGRvdCwgcCk7CiAgICAgICAgICAgICAgcC52YWRkKHYxLCBwKTsgLy8gQ29tcHV0ZSBhIHZlY3RvciBmcm9tIHAgdG8gdGhlIGNlbnRlciBvZiB0aGUgc3BoZXJlCgogICAgICAgICAgICAgIGNvbnN0IHhpX3RvX3AgPSB2M3Bvb2wuZ2V0KCk7CiAgICAgICAgICAgICAgcC52c3ViKHhpLCB4aV90b19wKTsgLy8gQ29sbGlzaW9uIGlmIHRoZSBlZGdlLXNwaGVyZSBkaXN0YW5jZSBpcyBsZXNzIHRoYW4gdGhlIHJhZGl1cwogICAgICAgICAgICAgIC8vIEFORCBpZiBwIGlzIGluIGJldHdlZW4gdjEgYW5kIHYyCgogICAgICAgICAgICAgIGlmIChkb3QgPiAwICYmIGRvdCAqIGRvdCA8IGVkZ2UubGVuZ3RoU3F1YXJlZCgpICYmIHhpX3RvX3AubGVuZ3RoU3F1YXJlZCgpIDwgUiAqIFIpIHsKICAgICAgICAgICAgICAgIC8vIENvbGxpc2lvbiBpZiB0aGUgZWRnZS1zcGhlcmUgZGlzdGFuY2UgaXMgbGVzcyB0aGFuIHRoZSByYWRpdXMKICAgICAgICAgICAgICAgIC8vIEVkZ2UgY29udGFjdCEKICAgICAgICAgICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oYmksIGJqLCBzaSwgc2osIHJzaSwgcnNqKTsKICAgICAgICAgICAgICAgIHAudnN1Yih4aiwgci5yaik7CiAgICAgICAgICAgICAgICBwLnZzdWIoeGksIHIubmkpOwogICAgICAgICAgICAgICAgci5uaS5ub3JtYWxpemUoKTsKICAgICAgICAgICAgICAgIHIubmkuc2NhbGUoUiwgci5yaSk7IC8vIFNob3VsZCBiZSByZWxhdGl2ZSB0byB0aGUgYm9keS4KCiAgICAgICAgICAgICAgICByLnJqLnZhZGQoeGosIHIucmopOwogICAgICAgICAgICAgICAgci5yai52c3ViKGJqLnBvc2l0aW9uLCByLnJqKTsgLy8gU2hvdWxkIGJlIHJlbGF0aXZlIHRvIHRoZSBib2R5LgoKICAgICAgICAgICAgICAgIHIucmkudmFkZCh4aSwgci5yaSk7CiAgICAgICAgICAgICAgICByLnJpLnZzdWIoYmkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsgLy8gUmVsZWFzZSB3b3JsZCB2ZXJ0aWNlcwoKICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwLCBOZmFjZXZlcnRzID0gZmFjZVZlcnRzLmxlbmd0aDsgaiAhPT0gTmZhY2V2ZXJ0czsgaisrKSB7CiAgICAgICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKGZhY2VWZXJ0c1tqXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UodjEpOwogICAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UodjIpOwogICAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UocCk7CiAgICAgICAgICAgICAgICB2M3Bvb2wucmVsZWFzZSh4aV90b19wKTsKICAgICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHYxX3RvX3hpKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHYxKTsKICAgICAgICAgICAgICB2M3Bvb2wucmVsZWFzZSh2Mik7CiAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UocCk7CiAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UoeGlfdG9fcCk7CiAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UodjFfdG9feGkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IC8vIFJlbGVhc2Ugd29ybGQgdmVydGljZXMKCgogICAgICAgICAgZm9yIChsZXQgaiA9IDAsIE5mYWNldmVydHMgPSBmYWNlVmVydHMubGVuZ3RoOyBqICE9PSBOZmFjZXZlcnRzOyBqKyspIHsKICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UoZmFjZVZlcnRzW2pdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBwbGFuZUNvbnZleChwbGFuZVNoYXBlLCBjb252ZXhTaGFwZSwgcGxhbmVQb3NpdGlvbiwgY29udmV4UG9zaXRpb24sIHBsYW5lUXVhdCwgY29udmV4UXVhdCwgcGxhbmVCb2R5LCBjb252ZXhCb2R5LCBzaSwgc2osIGp1c3RUZXN0KSB7CiAgICAgIC8vIFNpbXBseSByZXR1cm4gdGhlIHBvaW50cyBiZWhpbmQgdGhlIHBsYW5lLgogICAgICBjb25zdCB3b3JsZFZlcnRleCA9IHBsYW5lQ29udmV4X3Y7CiAgICAgIGNvbnN0IHdvcmxkTm9ybWFsID0gcGxhbmVDb252ZXhfbm9ybWFsOwogICAgICB3b3JsZE5vcm1hbC5zZXQoMCwgMCwgMSk7CiAgICAgIHBsYW5lUXVhdC52bXVsdCh3b3JsZE5vcm1hbCwgd29ybGROb3JtYWwpOyAvLyBUdXJuIG5vcm1hbCBhY2NvcmRpbmcgdG8gcGxhbmUgb3JpZW50YXRpb24KCiAgICAgIGxldCBudW1Db250YWN0cyA9IDA7CiAgICAgIGNvbnN0IHJlbHBvcyA9IHBsYW5lQ29udmV4X3JlbHBvczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBjb252ZXhTaGFwZS52ZXJ0aWNlcy5sZW5ndGg7IGkrKykgewogICAgICAgIC8vIEdldCB3b3JsZCBjb252ZXggdmVydGV4CiAgICAgICAgd29ybGRWZXJ0ZXguY29weShjb252ZXhTaGFwZS52ZXJ0aWNlc1tpXSk7CiAgICAgICAgY29udmV4UXVhdC52bXVsdCh3b3JsZFZlcnRleCwgd29ybGRWZXJ0ZXgpOwogICAgICAgIGNvbnZleFBvc2l0aW9uLnZhZGQod29ybGRWZXJ0ZXgsIHdvcmxkVmVydGV4KTsKICAgICAgICB3b3JsZFZlcnRleC52c3ViKHBsYW5lUG9zaXRpb24sIHJlbHBvcyk7CiAgICAgICAgY29uc3QgZG90ID0gd29ybGROb3JtYWwuZG90KHJlbHBvcyk7CgogICAgICAgIGlmIChkb3QgPD0gMC4wKSB7CiAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKHBsYW5lQm9keSwgY29udmV4Qm9keSwgcGxhbmVTaGFwZSwgY29udmV4U2hhcGUsIHNpLCBzaik7IC8vIEdldCB2ZXJ0ZXggcG9zaXRpb24gcHJvamVjdGVkIG9uIHBsYW5lCgogICAgICAgICAgY29uc3QgcHJvamVjdGVkID0gcGxhbmVDb252ZXhfcHJvamVjdGVkOwogICAgICAgICAgd29ybGROb3JtYWwuc2NhbGUod29ybGROb3JtYWwuZG90KHJlbHBvcyksIHByb2plY3RlZCk7CiAgICAgICAgICB3b3JsZFZlcnRleC52c3ViKHByb2plY3RlZCwgcHJvamVjdGVkKTsKICAgICAgICAgIHByb2plY3RlZC52c3ViKHBsYW5lUG9zaXRpb24sIHIucmkpOyAvLyBGcm9tIHBsYW5lIHRvIHZlcnRleCBwcm9qZWN0ZWQgb24gcGxhbmUKCiAgICAgICAgICByLm5pLmNvcHkod29ybGROb3JtYWwpOyAvLyBDb250YWN0IG5vcm1hbCBpcyB0aGUgcGxhbmUgbm9ybWFsIG91dCBmcm9tIHBsYW5lCiAgICAgICAgICAvLyByaiBpcyBub3cganVzdCB0aGUgdmVjdG9yIGZyb20gdGhlIGNvbnZleCBjZW50ZXIgdG8gdGhlIHZlcnRleAoKICAgICAgICAgIHdvcmxkVmVydGV4LnZzdWIoY29udmV4UG9zaXRpb24sIHIucmopOyAvLyBNYWtlIGl0IHJlbGF0aXZlIHRvIHRoZSBib2R5CgogICAgICAgICAgci5yaS52YWRkKHBsYW5lUG9zaXRpb24sIHIucmkpOwogICAgICAgICAgci5yaS52c3ViKHBsYW5lQm9keS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgICByLnJqLnZhZGQoY29udmV4UG9zaXRpb24sIHIucmopOwogICAgICAgICAgci5yai52c3ViKGNvbnZleEJvZHkucG9zaXRpb24sIHIucmopOwogICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgIG51bUNvbnRhY3RzKys7CgogICAgICAgICAgaWYgKCF0aGlzLmVuYWJsZUZyaWN0aW9uUmVkdWN0aW9uKSB7CiAgICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmVuYWJsZUZyaWN0aW9uUmVkdWN0aW9uICYmIG51bUNvbnRhY3RzKSB7CiAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkZyb21BdmVyYWdlKG51bUNvbnRhY3RzKTsKICAgICAgfQogICAgfQoKICAgIGJveENvbnZleChzaSwgc2osIHhpLCB4aiwgcWksIHFqLCBiaSwgYmosIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICBzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24ubWF0ZXJpYWwgPSBzaS5tYXRlcmlhbDsKICAgICAgc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLmNvbGxpc2lvblJlc3BvbnNlID0gc2kuY29sbGlzaW9uUmVzcG9uc2U7CiAgICAgIHJldHVybiB0aGlzLmNvbnZleENvbnZleChzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24sIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCBzaSwgc2osIGp1c3RUZXN0KTsKICAgIH0KCiAgICBzcGhlcmVIZWlnaHRmaWVsZChzcGhlcmVTaGFwZSwgaGZTaGFwZSwgc3BoZXJlUG9zLCBoZlBvcywgc3BoZXJlUXVhdCwgaGZRdWF0LCBzcGhlcmVCb2R5LCBoZkJvZHksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICBjb25zdCBkYXRhID0gaGZTaGFwZS5kYXRhOwogICAgICBjb25zdCByYWRpdXMgPSBzcGhlcmVTaGFwZS5yYWRpdXM7CiAgICAgIGNvbnN0IHcgPSBoZlNoYXBlLmVsZW1lbnRTaXplOwogICAgICBjb25zdCB3b3JsZFBpbGxhck9mZnNldCA9IHNwaGVyZUhlaWdodGZpZWxkX3RtcDI7IC8vIEdldCBzcGhlcmUgcG9zaXRpb24gdG8gaGVpZ2h0ZmllbGQgbG9jYWwhCgogICAgICBjb25zdCBsb2NhbFNwaGVyZVBvcyA9IHNwaGVyZUhlaWdodGZpZWxkX3RtcDE7CiAgICAgIFRyYW5zZm9ybS5wb2ludFRvTG9jYWxGcmFtZShoZlBvcywgaGZRdWF0LCBzcGhlcmVQb3MsIGxvY2FsU3BoZXJlUG9zKTsgLy8gR2V0IHRoZSBpbmRleCBvZiB0aGUgZGF0YSBwb2ludHMgdG8gdGVzdCBhZ2FpbnN0CgogICAgICBsZXQgaU1pblggPSBNYXRoLmZsb29yKChsb2NhbFNwaGVyZVBvcy54IC0gcmFkaXVzKSAvIHcpIC0gMTsKICAgICAgbGV0IGlNYXhYID0gTWF0aC5jZWlsKChsb2NhbFNwaGVyZVBvcy54ICsgcmFkaXVzKSAvIHcpICsgMTsKICAgICAgbGV0IGlNaW5ZID0gTWF0aC5mbG9vcigobG9jYWxTcGhlcmVQb3MueSAtIHJhZGl1cykgLyB3KSAtIDE7CiAgICAgIGxldCBpTWF4WSA9IE1hdGguY2VpbCgobG9jYWxTcGhlcmVQb3MueSArIHJhZGl1cykgLyB3KSArIDE7IC8vIEJhaWwgb3V0IGlmIHdlIGFyZSBvdXQgb2YgdGhlIHRlcnJhaW4KCiAgICAgIGlmIChpTWF4WCA8IDAgfHwgaU1heFkgPCAwIHx8IGlNaW5YID4gZGF0YS5sZW5ndGggfHwgaU1pblkgPiBkYXRhWzBdLmxlbmd0aCkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBDbGFtcCBpbmRleCB0byBlZGdlcwoKCiAgICAgIGlmIChpTWluWCA8IDApIHsKICAgICAgICBpTWluWCA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWF4WCA8IDApIHsKICAgICAgICBpTWF4WCA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWluWSA8IDApIHsKICAgICAgICBpTWluWSA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWF4WSA8IDApIHsKICAgICAgICBpTWF4WSA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWluWCA+PSBkYXRhLmxlbmd0aCkgewogICAgICAgIGlNaW5YID0gZGF0YS5sZW5ndGggLSAxOwogICAgICB9CgogICAgICBpZiAoaU1heFggPj0gZGF0YS5sZW5ndGgpIHsKICAgICAgICBpTWF4WCA9IGRhdGEubGVuZ3RoIC0gMTsKICAgICAgfQoKICAgICAgaWYgKGlNYXhZID49IGRhdGFbMF0ubGVuZ3RoKSB7CiAgICAgICAgaU1heFkgPSBkYXRhWzBdLmxlbmd0aCAtIDE7CiAgICAgIH0KCiAgICAgIGlmIChpTWluWSA+PSBkYXRhWzBdLmxlbmd0aCkgewogICAgICAgIGlNaW5ZID0gZGF0YVswXS5sZW5ndGggLSAxOwogICAgICB9CgogICAgICBjb25zdCBtaW5NYXggPSBbXTsKICAgICAgaGZTaGFwZS5nZXRSZWN0TWluTWF4KGlNaW5YLCBpTWluWSwgaU1heFgsIGlNYXhZLCBtaW5NYXgpOwogICAgICBjb25zdCBtaW4gPSBtaW5NYXhbMF07CiAgICAgIGNvbnN0IG1heCA9IG1pbk1heFsxXTsgLy8gQmFpbCBvdXQgaWYgd2UgY2FuJ3QgdG91Y2ggdGhlIGJvdW5kaW5nIGhlaWdodCBib3gKCiAgICAgIGlmIChsb2NhbFNwaGVyZVBvcy56IC0gcmFkaXVzID4gbWF4IHx8IGxvY2FsU3BoZXJlUG9zLnogKyByYWRpdXMgPCBtaW4pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucmVzdWx0OwoKICAgICAgZm9yIChsZXQgaSA9IGlNaW5YOyBpIDwgaU1heFg7IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSBpTWluWTsgaiA8IGlNYXhZOyBqKyspIHsKICAgICAgICAgIGNvbnN0IG51bUNvbnRhY3RzQmVmb3JlID0gcmVzdWx0Lmxlbmd0aDsKICAgICAgICAgIGxldCBpbnRlcnNlY3RpbmcgPSBmYWxzZTsgLy8gTG93ZXIgdHJpYW5nbGUKCiAgICAgICAgICBoZlNoYXBlLmdldENvbnZleFRyaWFuZ2xlUGlsbGFyKGksIGosIGZhbHNlKTsKICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZShoZlBvcywgaGZRdWF0LCBoZlNoYXBlLnBpbGxhck9mZnNldCwgd29ybGRQaWxsYXJPZmZzZXQpOwoKICAgICAgICAgIGlmIChzcGhlcmVQb3MuZGlzdGFuY2VUbyh3b3JsZFBpbGxhck9mZnNldCkgPCBoZlNoYXBlLnBpbGxhckNvbnZleC5ib3VuZGluZ1NwaGVyZVJhZGl1cyArIHNwaGVyZVNoYXBlLmJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgICAgIGludGVyc2VjdGluZyA9IHRoaXMuc3BoZXJlQ29udmV4KHNwaGVyZVNoYXBlLCBoZlNoYXBlLnBpbGxhckNvbnZleCwgc3BoZXJlUG9zLCB3b3JsZFBpbGxhck9mZnNldCwgc3BoZXJlUXVhdCwgaGZRdWF0LCBzcGhlcmVCb2R5LCBoZkJvZHksIHNwaGVyZVNoYXBlLCBoZlNoYXBlLCBqdXN0VGVzdCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGp1c3RUZXN0ICYmIGludGVyc2VjdGluZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gLy8gVXBwZXIgdHJpYW5nbGUKCgogICAgICAgICAgaGZTaGFwZS5nZXRDb252ZXhUcmlhbmdsZVBpbGxhcihpLCBqLCB0cnVlKTsKICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZShoZlBvcywgaGZRdWF0LCBoZlNoYXBlLnBpbGxhck9mZnNldCwgd29ybGRQaWxsYXJPZmZzZXQpOwoKICAgICAgICAgIGlmIChzcGhlcmVQb3MuZGlzdGFuY2VUbyh3b3JsZFBpbGxhck9mZnNldCkgPCBoZlNoYXBlLnBpbGxhckNvbnZleC5ib3VuZGluZ1NwaGVyZVJhZGl1cyArIHNwaGVyZVNoYXBlLmJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgICAgIGludGVyc2VjdGluZyA9IHRoaXMuc3BoZXJlQ29udmV4KHNwaGVyZVNoYXBlLCBoZlNoYXBlLnBpbGxhckNvbnZleCwgc3BoZXJlUG9zLCB3b3JsZFBpbGxhck9mZnNldCwgc3BoZXJlUXVhdCwgaGZRdWF0LCBzcGhlcmVCb2R5LCBoZkJvZHksIHNwaGVyZVNoYXBlLCBoZlNoYXBlLCBqdXN0VGVzdCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGp1c3RUZXN0ICYmIGludGVyc2VjdGluZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zdCBudW1Db250YWN0cyA9IHJlc3VsdC5sZW5ndGggLSBudW1Db250YWN0c0JlZm9yZTsKCiAgICAgICAgICBpZiAobnVtQ29udGFjdHMgPiAyKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIC8qCiAgICAgICAgICAgIC8vIFNraXAgYWxsIGJ1dCAxCiAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbnVtQ29udGFjdHMgLSAxOyBrKyspIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5wb3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgKi8KCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgYm94SGVpZ2h0ZmllbGQoc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLm1hdGVyaWFsID0gc2kubWF0ZXJpYWw7CiAgICAgIHNpLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5jb2xsaXNpb25SZXNwb25zZSA9IHNpLmNvbGxpc2lvblJlc3BvbnNlOwogICAgICByZXR1cm4gdGhpcy5jb252ZXhIZWlnaHRmaWVsZChzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24sIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCBzaSwgc2osIGp1c3RUZXN0KTsKICAgIH0KCiAgICBjb252ZXhIZWlnaHRmaWVsZChjb252ZXhTaGFwZSwgaGZTaGFwZSwgY29udmV4UG9zLCBoZlBvcywgY29udmV4UXVhdCwgaGZRdWF0LCBjb252ZXhCb2R5LCBoZkJvZHksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICBjb25zdCBkYXRhID0gaGZTaGFwZS5kYXRhOwogICAgICBjb25zdCB3ID0gaGZTaGFwZS5lbGVtZW50U2l6ZTsKICAgICAgY29uc3QgcmFkaXVzID0gY29udmV4U2hhcGUuYm91bmRpbmdTcGhlcmVSYWRpdXM7CiAgICAgIGNvbnN0IHdvcmxkUGlsbGFyT2Zmc2V0ID0gY29udmV4SGVpZ2h0ZmllbGRfdG1wMjsKICAgICAgY29uc3QgZmFjZUxpc3QgPSBjb252ZXhIZWlnaHRmaWVsZF9mYWNlTGlzdDsgLy8gR2V0IHNwaGVyZSBwb3NpdGlvbiB0byBoZWlnaHRmaWVsZCBsb2NhbCEKCiAgICAgIGNvbnN0IGxvY2FsQ29udmV4UG9zID0gY29udmV4SGVpZ2h0ZmllbGRfdG1wMTsKICAgICAgVHJhbnNmb3JtLnBvaW50VG9Mb2NhbEZyYW1lKGhmUG9zLCBoZlF1YXQsIGNvbnZleFBvcywgbG9jYWxDb252ZXhQb3MpOyAvLyBHZXQgdGhlIGluZGV4IG9mIHRoZSBkYXRhIHBvaW50cyB0byB0ZXN0IGFnYWluc3QKCiAgICAgIGxldCBpTWluWCA9IE1hdGguZmxvb3IoKGxvY2FsQ29udmV4UG9zLnggLSByYWRpdXMpIC8gdykgLSAxOwogICAgICBsZXQgaU1heFggPSBNYXRoLmNlaWwoKGxvY2FsQ29udmV4UG9zLnggKyByYWRpdXMpIC8gdykgKyAxOwogICAgICBsZXQgaU1pblkgPSBNYXRoLmZsb29yKChsb2NhbENvbnZleFBvcy55IC0gcmFkaXVzKSAvIHcpIC0gMTsKICAgICAgbGV0IGlNYXhZID0gTWF0aC5jZWlsKChsb2NhbENvbnZleFBvcy55ICsgcmFkaXVzKSAvIHcpICsgMTsgLy8gQmFpbCBvdXQgaWYgd2UgYXJlIG91dCBvZiB0aGUgdGVycmFpbgoKICAgICAgaWYgKGlNYXhYIDwgMCB8fCBpTWF4WSA8IDAgfHwgaU1pblggPiBkYXRhLmxlbmd0aCB8fCBpTWluWSA+IGRhdGFbMF0ubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIENsYW1wIGluZGV4IHRvIGVkZ2VzCgoKICAgICAgaWYgKGlNaW5YIDwgMCkgewogICAgICAgIGlNaW5YID0gMDsKICAgICAgfQoKICAgICAgaWYgKGlNYXhYIDwgMCkgewogICAgICAgIGlNYXhYID0gMDsKICAgICAgfQoKICAgICAgaWYgKGlNaW5ZIDwgMCkgewogICAgICAgIGlNaW5ZID0gMDsKICAgICAgfQoKICAgICAgaWYgKGlNYXhZIDwgMCkgewogICAgICAgIGlNYXhZID0gMDsKICAgICAgfQoKICAgICAgaWYgKGlNaW5YID49IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgaU1pblggPSBkYXRhLmxlbmd0aCAtIDE7CiAgICAgIH0KCiAgICAgIGlmIChpTWF4WCA+PSBkYXRhLmxlbmd0aCkgewogICAgICAgIGlNYXhYID0gZGF0YS5sZW5ndGggLSAxOwogICAgICB9CgogICAgICBpZiAoaU1heFkgPj0gZGF0YVswXS5sZW5ndGgpIHsKICAgICAgICBpTWF4WSA9IGRhdGFbMF0ubGVuZ3RoIC0gMTsKICAgICAgfQoKICAgICAgaWYgKGlNaW5ZID49IGRhdGFbMF0ubGVuZ3RoKSB7CiAgICAgICAgaU1pblkgPSBkYXRhWzBdLmxlbmd0aCAtIDE7CiAgICAgIH0KCiAgICAgIGNvbnN0IG1pbk1heCA9IFtdOwogICAgICBoZlNoYXBlLmdldFJlY3RNaW5NYXgoaU1pblgsIGlNaW5ZLCBpTWF4WCwgaU1heFksIG1pbk1heCk7CiAgICAgIGNvbnN0IG1pbiA9IG1pbk1heFswXTsKICAgICAgY29uc3QgbWF4ID0gbWluTWF4WzFdOyAvLyBCYWlsIG91dCBpZiB3ZSdyZSBjYW50IHRvdWNoIHRoZSBib3VuZGluZyBoZWlnaHQgYm94CgogICAgICBpZiAobG9jYWxDb252ZXhQb3MueiAtIHJhZGl1cyA+IG1heCB8fCBsb2NhbENvbnZleFBvcy56ICsgcmFkaXVzIDwgbWluKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gaU1pblg7IGkgPCBpTWF4WDsgaSsrKSB7CiAgICAgICAgZm9yIChsZXQgaiA9IGlNaW5ZOyBqIDwgaU1heFk7IGorKykgewogICAgICAgICAgbGV0IGludGVyc2VjdGluZyA9IGZhbHNlOyAvLyBMb3dlciB0cmlhbmdsZQoKICAgICAgICAgIGhmU2hhcGUuZ2V0Q29udmV4VHJpYW5nbGVQaWxsYXIoaSwgaiwgZmFsc2UpOwogICAgICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKGhmUG9zLCBoZlF1YXQsIGhmU2hhcGUucGlsbGFyT2Zmc2V0LCB3b3JsZFBpbGxhck9mZnNldCk7CgogICAgICAgICAgaWYgKGNvbnZleFBvcy5kaXN0YW5jZVRvKHdvcmxkUGlsbGFyT2Zmc2V0KSA8IGhmU2hhcGUucGlsbGFyQ29udmV4LmJvdW5kaW5nU3BoZXJlUmFkaXVzICsgY29udmV4U2hhcGUuYm91bmRpbmdTcGhlcmVSYWRpdXMpIHsKICAgICAgICAgICAgaW50ZXJzZWN0aW5nID0gdGhpcy5jb252ZXhDb252ZXgoY29udmV4U2hhcGUsIGhmU2hhcGUucGlsbGFyQ29udmV4LCBjb252ZXhQb3MsIHdvcmxkUGlsbGFyT2Zmc2V0LCBjb252ZXhRdWF0LCBoZlF1YXQsIGNvbnZleEJvZHksIGhmQm9keSwgbnVsbCwgbnVsbCwganVzdFRlc3QsIGZhY2VMaXN0LCBudWxsKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoanVzdFRlc3QgJiYgaW50ZXJzZWN0aW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSAvLyBVcHBlciB0cmlhbmdsZQoKCiAgICAgICAgICBoZlNoYXBlLmdldENvbnZleFRyaWFuZ2xlUGlsbGFyKGksIGosIHRydWUpOwogICAgICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKGhmUG9zLCBoZlF1YXQsIGhmU2hhcGUucGlsbGFyT2Zmc2V0LCB3b3JsZFBpbGxhck9mZnNldCk7CgogICAgICAgICAgaWYgKGNvbnZleFBvcy5kaXN0YW5jZVRvKHdvcmxkUGlsbGFyT2Zmc2V0KSA8IGhmU2hhcGUucGlsbGFyQ29udmV4LmJvdW5kaW5nU3BoZXJlUmFkaXVzICsgY29udmV4U2hhcGUuYm91bmRpbmdTcGhlcmVSYWRpdXMpIHsKICAgICAgICAgICAgaW50ZXJzZWN0aW5nID0gdGhpcy5jb252ZXhDb252ZXgoY29udmV4U2hhcGUsIGhmU2hhcGUucGlsbGFyQ29udmV4LCBjb252ZXhQb3MsIHdvcmxkUGlsbGFyT2Zmc2V0LCBjb252ZXhRdWF0LCBoZlF1YXQsIGNvbnZleEJvZHksIGhmQm9keSwgbnVsbCwgbnVsbCwganVzdFRlc3QsIGZhY2VMaXN0LCBudWxsKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoanVzdFRlc3QgJiYgaW50ZXJzZWN0aW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHNwaGVyZVBhcnRpY2xlKHNqLCBzaSwgeGosIHhpLCBxaiwgcWksIGJqLCBiaSwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIC8vIFRoZSBub3JtYWwgaXMgdGhlIHVuaXQgdmVjdG9yIGZyb20gc3BoZXJlIGNlbnRlciB0byBwYXJ0aWNsZSBjZW50ZXIKICAgICAgY29uc3Qgbm9ybWFsID0gcGFydGljbGVTcGhlcmVfbm9ybWFsOwogICAgICBub3JtYWwuc2V0KDAsIDAsIDEpOwogICAgICB4aS52c3ViKHhqLCBub3JtYWwpOwogICAgICBjb25zdCBsZW5ndGhTcXVhcmVkID0gbm9ybWFsLmxlbmd0aFNxdWFyZWQoKTsKCiAgICAgIGlmIChsZW5ndGhTcXVhcmVkIDw9IHNqLnJhZGl1cyAqIHNqLnJhZGl1cykgewogICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oYmksIGJqLCBzaSwgc2osIHJzaSwgcnNqKTsKICAgICAgICBub3JtYWwubm9ybWFsaXplKCk7CiAgICAgICAgci5yai5jb3B5KG5vcm1hbCk7CiAgICAgICAgci5yai5zY2FsZShzai5yYWRpdXMsIHIucmopOwogICAgICAgIHIubmkuY29weShub3JtYWwpOyAvLyBDb250YWN0IG5vcm1hbAoKICAgICAgICByLm5pLm5lZ2F0ZShyLm5pKTsKICAgICAgICByLnJpLnNldCgwLCAwLCAwKTsgLy8gQ2VudGVyIG9mIHBhcnRpY2xlCgogICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICB9CiAgICB9CgogICAgcGxhbmVQYXJ0aWNsZShzaiwgc2ksIHhqLCB4aSwgcWosIHFpLCBiaiwgYmksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICBjb25zdCBub3JtYWwgPSBwYXJ0aWNsZVBsYW5lX25vcm1hbDsKICAgICAgbm9ybWFsLnNldCgwLCAwLCAxKTsKICAgICAgYmoucXVhdGVybmlvbi52bXVsdChub3JtYWwsIG5vcm1hbCk7IC8vIFR1cm4gbm9ybWFsIGFjY29yZGluZyB0byBwbGFuZSBvcmllbnRhdGlvbgoKICAgICAgY29uc3QgcmVscG9zID0gcGFydGljbGVQbGFuZV9yZWxwb3M7CiAgICAgIHhpLnZzdWIoYmoucG9zaXRpb24sIHJlbHBvcyk7CiAgICAgIGNvbnN0IGRvdCA9IG5vcm1hbC5kb3QocmVscG9zKTsKCiAgICAgIGlmIChkb3QgPD0gMC4wKSB7CiAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgIHIubmkuY29weShub3JtYWwpOyAvLyBDb250YWN0IG5vcm1hbCBpcyB0aGUgcGxhbmUgbm9ybWFsCgogICAgICAgIHIubmkubmVnYXRlKHIubmkpOwogICAgICAgIHIucmkuc2V0KDAsIDAsIDApOyAvLyBDZW50ZXIgb2YgcGFydGljbGUKICAgICAgICAvLyBHZXQgcGFydGljbGUgcG9zaXRpb24gcHJvamVjdGVkIG9uIHBsYW5lCgogICAgICAgIGNvbnN0IHByb2plY3RlZCA9IHBhcnRpY2xlUGxhbmVfcHJvamVjdGVkOwogICAgICAgIG5vcm1hbC5zY2FsZShub3JtYWwuZG90KHhpKSwgcHJvamVjdGVkKTsKICAgICAgICB4aS52c3ViKHByb2plY3RlZCwgcHJvamVjdGVkKTsgLy9wcm9qZWN0ZWQudmFkZChiai5wb3NpdGlvbixwcm9qZWN0ZWQpOwogICAgICAgIC8vIHJqIGlzIG5vdyB0aGUgcHJvamVjdGVkIHdvcmxkIHBvc2l0aW9uIG1pbnVzIHBsYW5lIHBvc2l0aW9uCgogICAgICAgIHIucmouY29weShwcm9qZWN0ZWQpOwogICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICB9CiAgICB9CgogICAgYm94UGFydGljbGUoc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLm1hdGVyaWFsID0gc2kubWF0ZXJpYWw7CiAgICAgIHNpLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5jb2xsaXNpb25SZXNwb25zZSA9IHNpLmNvbGxpc2lvblJlc3BvbnNlOwogICAgICByZXR1cm4gdGhpcy5jb252ZXhQYXJ0aWNsZShzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24sIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCBzaSwgc2osIGp1c3RUZXN0KTsKICAgIH0KCiAgICBjb252ZXhQYXJ0aWNsZShzaiwgc2ksIHhqLCB4aSwgcWosIHFpLCBiaiwgYmksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICBsZXQgcGVuZXRyYXRlZEZhY2VJbmRleCA9IC0xOwogICAgICBjb25zdCBwZW5ldHJhdGVkRmFjZU5vcm1hbCA9IGNvbnZleFBhcnRpY2xlX3BlbmV0cmF0ZWRGYWNlTm9ybWFsOwogICAgICBjb25zdCB3b3JsZFBlbmV0cmF0aW9uVmVjID0gY29udmV4UGFydGljbGVfd29ybGRQZW5ldHJhdGlvblZlYzsKICAgICAgbGV0IG1pblBlbmV0cmF0aW9uID0gbnVsbDsKCiAgICAgIGNvbnN0IGxvY2FsID0gY29udmV4UGFydGljbGVfbG9jYWw7CiAgICAgIGxvY2FsLmNvcHkoeGkpOwogICAgICBsb2NhbC52c3ViKHhqLCBsb2NhbCk7IC8vIENvbnZlcnQgcG9zaXRpb24gdG8gcmVsYXRpdmUgdGhlIGNvbnZleCBvcmlnaW4KCiAgICAgIHFqLmNvbmp1Z2F0ZShjcWopOwogICAgICBjcWoudm11bHQobG9jYWwsIGxvY2FsKTsKCiAgICAgIGlmIChzai5wb2ludElzSW5zaWRlKGxvY2FsKSkgewogICAgICAgIGlmIChzai53b3JsZFZlcnRpY2VzTmVlZHNVcGRhdGUpIHsKICAgICAgICAgIHNqLmNvbXB1dGVXb3JsZFZlcnRpY2VzKHhqLCBxaik7CiAgICAgICAgfQoKICAgICAgICBpZiAoc2oud29ybGRGYWNlTm9ybWFsc05lZWRzVXBkYXRlKSB7CiAgICAgICAgICBzai5jb21wdXRlV29ybGRGYWNlTm9ybWFscyhxaik7CiAgICAgICAgfSAvLyBGb3IgZWFjaCB3b3JsZCBwb2x5Z29uIGluIHRoZSBwb2x5aGVkcmEKCgogICAgICAgIGZvciAobGV0IGkgPSAwLCBuZmFjZXMgPSBzai5mYWNlcy5sZW5ndGg7IGkgIT09IG5mYWNlczsgaSsrKSB7CiAgICAgICAgICAvLyBDb25zdHJ1Y3Qgd29ybGQgZmFjZSB2ZXJ0aWNlcwogICAgICAgICAgY29uc3QgdmVydHMgPSBbc2oud29ybGRWZXJ0aWNlc1tzai5mYWNlc1tpXVswXV1dOwogICAgICAgICAgY29uc3Qgbm9ybWFsID0gc2oud29ybGRGYWNlTm9ybWFsc1tpXTsgLy8gQ2hlY2sgaG93IG11Y2ggdGhlIHBhcnRpY2xlIHBlbmV0cmF0ZXMgdGhlIHBvbHlnb24gcGxhbmUuCgogICAgICAgICAgeGkudnN1Yih2ZXJ0c1swXSwgY29udmV4UGFydGljbGVfdmVydGV4VG9QYXJ0aWNsZSk7CiAgICAgICAgICBjb25zdCBwZW5ldHJhdGlvbiA9IC1ub3JtYWwuZG90KGNvbnZleFBhcnRpY2xlX3ZlcnRleFRvUGFydGljbGUpOwoKICAgICAgICAgIGlmIChtaW5QZW5ldHJhdGlvbiA9PT0gbnVsbCB8fCBNYXRoLmFicyhwZW5ldHJhdGlvbikgPCBNYXRoLmFicyhtaW5QZW5ldHJhdGlvbikpIHsKICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1pblBlbmV0cmF0aW9uID0gcGVuZXRyYXRpb247CiAgICAgICAgICAgIHBlbmV0cmF0ZWRGYWNlSW5kZXggPSBpOwogICAgICAgICAgICBwZW5ldHJhdGVkRmFjZU5vcm1hbC5jb3B5KG5vcm1hbCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAocGVuZXRyYXRlZEZhY2VJbmRleCAhPT0gLTEpIHsKICAgICAgICAgIC8vIFNldHVwIGNvbnRhY3QKICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgICAgcGVuZXRyYXRlZEZhY2VOb3JtYWwuc2NhbGUobWluUGVuZXRyYXRpb24sIHdvcmxkUGVuZXRyYXRpb25WZWMpOyAvLyByaiBpcyB0aGUgcGFydGljbGUgcG9zaXRpb24gcHJvamVjdGVkIHRvIHRoZSBmYWNlCgogICAgICAgICAgd29ybGRQZW5ldHJhdGlvblZlYy52YWRkKHhpLCB3b3JsZFBlbmV0cmF0aW9uVmVjKTsKICAgICAgICAgIHdvcmxkUGVuZXRyYXRpb25WZWMudnN1Yih4aiwgd29ybGRQZW5ldHJhdGlvblZlYyk7CiAgICAgICAgICByLnJqLmNvcHkod29ybGRQZW5ldHJhdGlvblZlYyk7IC8vY29uc3QgcHJvamVjdGVkVG9GYWNlID0geGkudnN1Yih4aikudmFkZCh3b3JsZFBlbmV0cmF0aW9uVmVjKTsKICAgICAgICAgIC8vcHJvamVjdGVkVG9GYWNlLmNvcHkoci5yaik7CiAgICAgICAgICAvL3FqLnZtdWx0KHIucmosci5yaik7CgogICAgICAgICAgcGVuZXRyYXRlZEZhY2VOb3JtYWwubmVnYXRlKHIubmkpOyAvLyBDb250YWN0IG5vcm1hbAoKICAgICAgICAgIHIucmkuc2V0KDAsIDAsIDApOyAvLyBDZW50ZXIgb2YgcGFydGljbGUKCiAgICAgICAgICBjb25zdCByaSA9IHIucmk7CiAgICAgICAgICBjb25zdCByaiA9IHIucmo7IC8vIE1ha2UgcmVsYXRpdmUgdG8gYm9kaWVzCgogICAgICAgICAgcmkudmFkZCh4aSwgcmkpOwogICAgICAgICAgcmkudnN1YihiaS5wb3NpdGlvbiwgcmkpOwogICAgICAgICAgcmoudmFkZCh4aiwgcmopOwogICAgICAgICAgcmoudnN1Yihiai5wb3NpdGlvbiwgcmopOwogICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS53YXJuKCdQb2ludCBmb3VuZCBpbnNpZGUgY29udmV4LCBidXQgZGlkIG5vdCBmaW5kIHBlbmV0cmF0aW5nIGZhY2UhJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaGVpZ2h0ZmllbGRDeWxpbmRlcihoZlNoYXBlLCBjb252ZXhTaGFwZSwgaGZQb3MsIGNvbnZleFBvcywgaGZRdWF0LCBjb252ZXhRdWF0LCBoZkJvZHksIGNvbnZleEJvZHksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICByZXR1cm4gdGhpcy5jb252ZXhIZWlnaHRmaWVsZChjb252ZXhTaGFwZSwgaGZTaGFwZSwgY29udmV4UG9zLCBoZlBvcywgY29udmV4UXVhdCwgaGZRdWF0LCBjb252ZXhCb2R5LCBoZkJvZHksIHJzaSwgcnNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgcGFydGljbGVDeWxpbmRlcihzaSwgc2osIHhpLCB4aiwgcWksIHFqLCBiaSwgYmosIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICByZXR1cm4gdGhpcy5jb252ZXhQYXJ0aWNsZShzaiwgc2ksIHhqLCB4aSwgcWosIHFpLCBiaiwgYmksIHJzaSwgcnNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgc3BoZXJlVHJpbWVzaChzcGhlcmVTaGFwZSwgdHJpbWVzaFNoYXBlLCBzcGhlcmVQb3MsIHRyaW1lc2hQb3MsIHNwaGVyZVF1YXQsIHRyaW1lc2hRdWF0LCBzcGhlcmVCb2R5LCB0cmltZXNoQm9keSwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIGNvbnN0IGVkZ2VWZXJ0ZXhBID0gc3BoZXJlVHJpbWVzaF9lZGdlVmVydGV4QTsKICAgICAgY29uc3QgZWRnZVZlcnRleEIgPSBzcGhlcmVUcmltZXNoX2VkZ2VWZXJ0ZXhCOwogICAgICBjb25zdCBlZGdlVmVjdG9yID0gc3BoZXJlVHJpbWVzaF9lZGdlVmVjdG9yOwogICAgICBjb25zdCBlZGdlVmVjdG9yVW5pdCA9IHNwaGVyZVRyaW1lc2hfZWRnZVZlY3RvclVuaXQ7CiAgICAgIGNvbnN0IGxvY2FsU3BoZXJlUG9zID0gc3BoZXJlVHJpbWVzaF9sb2NhbFNwaGVyZVBvczsKICAgICAgY29uc3QgdG1wID0gc3BoZXJlVHJpbWVzaF90bXA7CiAgICAgIGNvbnN0IGxvY2FsU3BoZXJlQUFCQiA9IHNwaGVyZVRyaW1lc2hfbG9jYWxTcGhlcmVBQUJCOwogICAgICBjb25zdCB2MiA9IHNwaGVyZVRyaW1lc2hfdjI7CiAgICAgIGNvbnN0IHJlbHBvcyA9IHNwaGVyZVRyaW1lc2hfcmVscG9zOwogICAgICBjb25zdCB0cmlhbmdsZXMgPSBzcGhlcmVUcmltZXNoX3RyaWFuZ2xlczsgLy8gQ29udmVydCBzcGhlcmUgcG9zaXRpb24gdG8gbG9jYWwgaW4gdGhlIHRyaW1lc2gKCiAgICAgIFRyYW5zZm9ybS5wb2ludFRvTG9jYWxGcmFtZSh0cmltZXNoUG9zLCB0cmltZXNoUXVhdCwgc3BoZXJlUG9zLCBsb2NhbFNwaGVyZVBvcyk7IC8vIEdldCB0aGUgYWFiYiBvZiB0aGUgc3BoZXJlIGxvY2FsbHkgaW4gdGhlIHRyaW1lc2gKCiAgICAgIGNvbnN0IHNwaGVyZVJhZGl1cyA9IHNwaGVyZVNoYXBlLnJhZGl1czsKICAgICAgbG9jYWxTcGhlcmVBQUJCLmxvd2VyQm91bmQuc2V0KGxvY2FsU3BoZXJlUG9zLnggLSBzcGhlcmVSYWRpdXMsIGxvY2FsU3BoZXJlUG9zLnkgLSBzcGhlcmVSYWRpdXMsIGxvY2FsU3BoZXJlUG9zLnogLSBzcGhlcmVSYWRpdXMpOwogICAgICBsb2NhbFNwaGVyZUFBQkIudXBwZXJCb3VuZC5zZXQobG9jYWxTcGhlcmVQb3MueCArIHNwaGVyZVJhZGl1cywgbG9jYWxTcGhlcmVQb3MueSArIHNwaGVyZVJhZGl1cywgbG9jYWxTcGhlcmVQb3MueiArIHNwaGVyZVJhZGl1cyk7CiAgICAgIHRyaW1lc2hTaGFwZS5nZXRUcmlhbmdsZXNJbkFBQkIobG9jYWxTcGhlcmVBQUJCLCB0cmlhbmdsZXMpOyAvL2ZvciAobGV0IGkgPSAwOyBpIDwgdHJpbWVzaFNoYXBlLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB0cmlhbmdsZXMucHVzaChpKTsgLy8gQWxsCiAgICAgIC8vIFZlcnRpY2VzCgogICAgICBjb25zdCB2ID0gc3BoZXJlVHJpbWVzaF92OwogICAgICBjb25zdCByYWRpdXNTcXVhcmVkID0gc3BoZXJlU2hhcGUucmFkaXVzICogc3BoZXJlU2hhcGUucmFkaXVzOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0cmlhbmdsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDM7IGorKykgewogICAgICAgICAgdHJpbWVzaFNoYXBlLmdldFZlcnRleCh0cmltZXNoU2hhcGUuaW5kaWNlc1t0cmlhbmdsZXNbaV0gKiAzICsgal0sIHYpOyAvLyBDaGVjayB2ZXJ0ZXggb3ZlcmxhcCBpbiBzcGhlcmUKCiAgICAgICAgICB2LnZzdWIobG9jYWxTcGhlcmVQb3MsIHJlbHBvcyk7CgogICAgICAgICAgaWYgKHJlbHBvcy5sZW5ndGhTcXVhcmVkKCkgPD0gcmFkaXVzU3F1YXJlZCkgewogICAgICAgICAgICAvLyBTYWZlIHVwCiAgICAgICAgICAgIHYyLmNvcHkodik7CiAgICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZSh0cmltZXNoUG9zLCB0cmltZXNoUXVhdCwgdjIsIHYpOwogICAgICAgICAgICB2LnZzdWIoc3BoZXJlUG9zLCByZWxwb3MpOwoKICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oc3BoZXJlQm9keSwgdHJpbWVzaEJvZHksIHNwaGVyZVNoYXBlLCB0cmltZXNoU2hhcGUsIHJzaSwgcnNqKTsKICAgICAgICAgICAgci5uaS5jb3B5KHJlbHBvcyk7CiAgICAgICAgICAgIHIubmkubm9ybWFsaXplKCk7IC8vIHJpIGlzIHRoZSB2ZWN0b3IgZnJvbSBzcGhlcmUgY2VudGVyIHRvIHRoZSBzcGhlcmUgc3VyZmFjZQoKICAgICAgICAgICAgci5yaS5jb3B5KHIubmkpOwogICAgICAgICAgICByLnJpLnNjYWxlKHNwaGVyZVNoYXBlLnJhZGl1cywgci5yaSk7CiAgICAgICAgICAgIHIucmkudmFkZChzcGhlcmVQb3MsIHIucmkpOwogICAgICAgICAgICByLnJpLnZzdWIoc3BoZXJlQm9keS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgICAgIHIucmouY29weSh2KTsKICAgICAgICAgICAgci5yai52c3ViKHRyaW1lc2hCb2R5LnBvc2l0aW9uLCByLnJqKTsgLy8gU3RvcmUgcmVzdWx0CgogICAgICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIENoZWNrIGFsbCBlZGdlcwoKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdHJpYW5nbGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCAzOyBqKyspIHsKICAgICAgICAgIHRyaW1lc2hTaGFwZS5nZXRWZXJ0ZXgodHJpbWVzaFNoYXBlLmluZGljZXNbdHJpYW5nbGVzW2ldICogMyArIGpdLCBlZGdlVmVydGV4QSk7CiAgICAgICAgICB0cmltZXNoU2hhcGUuZ2V0VmVydGV4KHRyaW1lc2hTaGFwZS5pbmRpY2VzW3RyaWFuZ2xlc1tpXSAqIDMgKyAoaiArIDEpICUgM10sIGVkZ2VWZXJ0ZXhCKTsKICAgICAgICAgIGVkZ2VWZXJ0ZXhCLnZzdWIoZWRnZVZlcnRleEEsIGVkZ2VWZWN0b3IpOyAvLyBQcm9qZWN0IHNwaGVyZSBwb3NpdGlvbiB0byB0aGUgZWRnZQoKICAgICAgICAgIGxvY2FsU3BoZXJlUG9zLnZzdWIoZWRnZVZlcnRleEIsIHRtcCk7CiAgICAgICAgICBjb25zdCBwb3NpdGlvbkFsb25nRWRnZUIgPSB0bXAuZG90KGVkZ2VWZWN0b3IpOwogICAgICAgICAgbG9jYWxTcGhlcmVQb3MudnN1YihlZGdlVmVydGV4QSwgdG1wKTsKICAgICAgICAgIGxldCBwb3NpdGlvbkFsb25nRWRnZUEgPSB0bXAuZG90KGVkZ2VWZWN0b3IpOwoKICAgICAgICAgIGlmIChwb3NpdGlvbkFsb25nRWRnZUEgPiAwICYmIHBvc2l0aW9uQWxvbmdFZGdlQiA8IDApIHsKICAgICAgICAgICAgLy8gTm93IGNoZWNrIHRoZSBvcnRob2dvbmFsIGRpc3RhbmNlIGZyb20gZWRnZSB0byBzcGhlcmUgY2VudGVyCiAgICAgICAgICAgIGxvY2FsU3BoZXJlUG9zLnZzdWIoZWRnZVZlcnRleEEsIHRtcCk7CiAgICAgICAgICAgIGVkZ2VWZWN0b3JVbml0LmNvcHkoZWRnZVZlY3Rvcik7CiAgICAgICAgICAgIGVkZ2VWZWN0b3JVbml0Lm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBwb3NpdGlvbkFsb25nRWRnZUEgPSB0bXAuZG90KGVkZ2VWZWN0b3JVbml0KTsKICAgICAgICAgICAgZWRnZVZlY3RvclVuaXQuc2NhbGUocG9zaXRpb25BbG9uZ0VkZ2VBLCB0bXApOwogICAgICAgICAgICB0bXAudmFkZChlZGdlVmVydGV4QSwgdG1wKTsgLy8gdG1wIGlzIG5vdyB0aGUgc3BoZXJlIGNlbnRlciBwb3NpdGlvbiBwcm9qZWN0ZWQgdG8gdGhlIGVkZ2UsIGRlZmluZWQgbG9jYWxseSBpbiB0aGUgdHJpbWVzaCBmcmFtZQoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRtcC5kaXN0YW5jZVRvKGxvY2FsU3BoZXJlUG9zKTsKCiAgICAgICAgICAgIGlmIChkaXN0IDwgc3BoZXJlU2hhcGUucmFkaXVzKSB7CiAgICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihzcGhlcmVCb2R5LCB0cmltZXNoQm9keSwgc3BoZXJlU2hhcGUsIHRyaW1lc2hTaGFwZSwgcnNpLCByc2opOwogICAgICAgICAgICAgIHRtcC52c3ViKGxvY2FsU3BoZXJlUG9zLCByLm5pKTsKICAgICAgICAgICAgICByLm5pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgIHIubmkuc2NhbGUoc3BoZXJlU2hhcGUucmFkaXVzLCByLnJpKTsKICAgICAgICAgICAgICByLnJpLnZhZGQoc3BoZXJlUG9zLCByLnJpKTsKICAgICAgICAgICAgICByLnJpLnZzdWIoc3BoZXJlQm9keS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKHRyaW1lc2hQb3MsIHRyaW1lc2hRdWF0LCB0bXAsIHRtcCk7CiAgICAgICAgICAgICAgdG1wLnZzdWIodHJpbWVzaEJvZHkucG9zaXRpb24sIHIucmopOwogICAgICAgICAgICAgIFRyYW5zZm9ybS52ZWN0b3JUb1dvcmxkRnJhbWUodHJpbWVzaFF1YXQsIHIubmksIHIubmkpOwogICAgICAgICAgICAgIFRyYW5zZm9ybS52ZWN0b3JUb1dvcmxkRnJhbWUodHJpbWVzaFF1YXQsIHIucmksIHIucmkpOwogICAgICAgICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIFRyaWFuZ2xlIGZhY2VzCgoKICAgICAgY29uc3QgdmEgPSBzcGhlcmVUcmltZXNoX3ZhOwogICAgICBjb25zdCB2YiA9IHNwaGVyZVRyaW1lc2hfdmI7CiAgICAgIGNvbnN0IHZjID0gc3BoZXJlVHJpbWVzaF92YzsKICAgICAgY29uc3Qgbm9ybWFsID0gc3BoZXJlVHJpbWVzaF9ub3JtYWw7CgogICAgICBmb3IgKGxldCBpID0gMCwgTiA9IHRyaWFuZ2xlcy5sZW5ndGg7IGkgIT09IE47IGkrKykgewogICAgICAgIHRyaW1lc2hTaGFwZS5nZXRUcmlhbmdsZVZlcnRpY2VzKHRyaWFuZ2xlc1tpXSwgdmEsIHZiLCB2Yyk7CiAgICAgICAgdHJpbWVzaFNoYXBlLmdldE5vcm1hbCh0cmlhbmdsZXNbaV0sIG5vcm1hbCk7CiAgICAgICAgbG9jYWxTcGhlcmVQb3MudnN1Yih2YSwgdG1wKTsKICAgICAgICBsZXQgZGlzdCA9IHRtcC5kb3Qobm9ybWFsKTsKICAgICAgICBub3JtYWwuc2NhbGUoZGlzdCwgdG1wKTsKICAgICAgICBsb2NhbFNwaGVyZVBvcy52c3ViKHRtcCwgdG1wKTsgLy8gdG1wIGlzIG5vdyB0aGUgc3BoZXJlIHBvc2l0aW9uIHByb2plY3RlZCB0byB0aGUgdHJpYW5nbGUgcGxhbmUKCiAgICAgICAgZGlzdCA9IHRtcC5kaXN0YW5jZVRvKGxvY2FsU3BoZXJlUG9zKTsKCiAgICAgICAgaWYgKFJheS5wb2ludEluVHJpYW5nbGUodG1wLCB2YSwgdmIsIHZjKSAmJiBkaXN0IDwgc3BoZXJlU2hhcGUucmFkaXVzKSB7CiAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgbGV0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihzcGhlcmVCb2R5LCB0cmltZXNoQm9keSwgc3BoZXJlU2hhcGUsIHRyaW1lc2hTaGFwZSwgcnNpLCByc2opOwogICAgICAgICAgdG1wLnZzdWIobG9jYWxTcGhlcmVQb3MsIHIubmkpOwogICAgICAgICAgci5uaS5ub3JtYWxpemUoKTsKICAgICAgICAgIHIubmkuc2NhbGUoc3BoZXJlU2hhcGUucmFkaXVzLCByLnJpKTsKICAgICAgICAgIHIucmkudmFkZChzcGhlcmVQb3MsIHIucmkpOwogICAgICAgICAgci5yaS52c3ViKHNwaGVyZUJvZHkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKHRyaW1lc2hQb3MsIHRyaW1lc2hRdWF0LCB0bXAsIHRtcCk7CiAgICAgICAgICB0bXAudnN1Yih0cmltZXNoQm9keS5wb3NpdGlvbiwgci5yaik7CiAgICAgICAgICBUcmFuc2Zvcm0udmVjdG9yVG9Xb3JsZEZyYW1lKHRyaW1lc2hRdWF0LCByLm5pLCByLm5pKTsKICAgICAgICAgIFRyYW5zZm9ybS52ZWN0b3JUb1dvcmxkRnJhbWUodHJpbWVzaFF1YXQsIHIucmksIHIucmkpOwogICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRyaWFuZ2xlcy5sZW5ndGggPSAwOwogICAgfQoKICAgIHBsYW5lVHJpbWVzaChwbGFuZVNoYXBlLCB0cmltZXNoU2hhcGUsIHBsYW5lUG9zLCB0cmltZXNoUG9zLCBwbGFuZVF1YXQsIHRyaW1lc2hRdWF0LCBwbGFuZUJvZHksIHRyaW1lc2hCb2R5LCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgLy8gTWFrZSBjb250YWN0cyEKICAgICAgY29uc3QgdiA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IG5vcm1hbCA9IHBsYW5lVHJpbWVzaF9ub3JtYWw7CiAgICAgIG5vcm1hbC5zZXQoMCwgMCwgMSk7CiAgICAgIHBsYW5lUXVhdC52bXVsdChub3JtYWwsIG5vcm1hbCk7IC8vIFR1cm4gbm9ybWFsIGFjY29yZGluZyB0byBwbGFuZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0cmltZXNoU2hhcGUudmVydGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAgICAgLy8gR2V0IHdvcmxkIHZlcnRleCBmcm9tIHRyaW1lc2gKICAgICAgICB0cmltZXNoU2hhcGUuZ2V0VmVydGV4KGksIHYpOyAvLyBTYWZlIHVwCgogICAgICAgIGNvbnN0IHYyID0gbmV3IFZlYzMoKTsKICAgICAgICB2Mi5jb3B5KHYpOwogICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZSh0cmltZXNoUG9zLCB0cmltZXNoUXVhdCwgdjIsIHYpOyAvLyBDaGVjayBwbGFuZSBzaWRlCgogICAgICAgIGNvbnN0IHJlbHBvcyA9IHBsYW5lVHJpbWVzaF9yZWxwb3M7CiAgICAgICAgdi52c3ViKHBsYW5lUG9zLCByZWxwb3MpOwogICAgICAgIGNvbnN0IGRvdCA9IG5vcm1hbC5kb3QocmVscG9zKTsKCiAgICAgICAgaWYgKGRvdCA8PSAwLjApIHsKICAgICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24ocGxhbmVCb2R5LCB0cmltZXNoQm9keSwgcGxhbmVTaGFwZSwgdHJpbWVzaFNoYXBlLCByc2ksIHJzaik7CiAgICAgICAgICByLm5pLmNvcHkobm9ybWFsKTsgLy8gQ29udGFjdCBub3JtYWwgaXMgdGhlIHBsYW5lIG5vcm1hbAogICAgICAgICAgLy8gR2V0IHZlcnRleCBwb3NpdGlvbiBwcm9qZWN0ZWQgb24gcGxhbmUKCiAgICAgICAgICBjb25zdCBwcm9qZWN0ZWQgPSBwbGFuZVRyaW1lc2hfcHJvamVjdGVkOwogICAgICAgICAgbm9ybWFsLnNjYWxlKHJlbHBvcy5kb3Qobm9ybWFsKSwgcHJvamVjdGVkKTsKICAgICAgICAgIHYudnN1Yihwcm9qZWN0ZWQsIHByb2plY3RlZCk7IC8vIHJpIGlzIHRoZSBwcm9qZWN0ZWQgd29ybGQgcG9zaXRpb24gbWludXMgcGxhbmUgcG9zaXRpb24KCiAgICAgICAgICByLnJpLmNvcHkocHJvamVjdGVkKTsKICAgICAgICAgIHIucmkudnN1YihwbGFuZUJvZHkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgci5yai5jb3B5KHYpOwogICAgICAgICAgci5yai52c3ViKHRyaW1lc2hCb2R5LnBvc2l0aW9uLCByLnJqKTsgLy8gU3RvcmUgcmVzdWx0CgogICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gLy8gY29udmV4VHJpbWVzaCgKICAgIC8vICAgc2k6IENvbnZleFBvbHloZWRyb24sIHNqOiBUcmltZXNoLCB4aTogVmVjMywgeGo6IFZlYzMsIHFpOiBRdWF0ZXJuaW9uLCBxajogUXVhdGVybmlvbiwKICAgIC8vICAgYmk6IEJvZHksIGJqOiBCb2R5LCByc2k/OiBTaGFwZSB8IG51bGwsIHJzaj86IFNoYXBlIHwgbnVsbCwKICAgIC8vICAgZmFjZUxpc3RBPzogbnVtYmVyW10gfCBudWxsLCBmYWNlTGlzdEI/OiBudW1iZXJbXSB8IG51bGwsCiAgICAvLyApIHsKICAgIC8vICAgY29uc3Qgc2VwQXhpcyA9IGNvbnZleENvbnZleF9zZXBBeGlzOwogICAgLy8gICBpZih4aS5kaXN0YW5jZVRvKHhqKSA+IHNpLmJvdW5kaW5nU3BoZXJlUmFkaXVzICsgc2ouYm91bmRpbmdTcGhlcmVSYWRpdXMpewogICAgLy8gICAgICAgcmV0dXJuOwogICAgLy8gICB9CiAgICAvLyAgIC8vIENvbnN0cnVjdCBhIHRlbXAgaHVsbCBmb3IgZWFjaCB0cmlhbmdsZQogICAgLy8gICBjb25zdCBodWxsQiA9IG5ldyBDb252ZXhQb2x5aGVkcm9uKCk7CiAgICAvLyAgIGh1bGxCLmZhY2VzID0gW1swLDEsMl1dOwogICAgLy8gICBjb25zdCB2YSA9IG5ldyBWZWMzKCk7CiAgICAvLyAgIGNvbnN0IHZiID0gbmV3IFZlYzMoKTsKICAgIC8vICAgY29uc3QgdmMgPSBuZXcgVmVjMygpOwogICAgLy8gICBodWxsQi52ZXJ0aWNlcyA9IFsKICAgIC8vICAgICAgIHZhLAogICAgLy8gICAgICAgdmIsCiAgICAvLyAgICAgICB2YwogICAgLy8gICBdOwogICAgLy8gICBmb3IgKGxldCBpID0gMDsgaSA8IHNqLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAvLyAgICAgICBjb25zdCB0cmlhbmdsZU5vcm1hbCA9IG5ldyBWZWMzKCk7CiAgICAvLyAgICAgICBzai5nZXROb3JtYWwoaSwgdHJpYW5nbGVOb3JtYWwpOwogICAgLy8gICAgICAgaHVsbEIuZmFjZU5vcm1hbHMgPSBbdHJpYW5nbGVOb3JtYWxdOwogICAgLy8gICAgICAgc2ouZ2V0VHJpYW5nbGVWZXJ0aWNlcyhpLCB2YSwgdmIsIHZjKTsKICAgIC8vICAgICAgIGxldCBkID0gc2kudGVzdFNlcEF4aXModHJpYW5nbGVOb3JtYWwsIGh1bGxCLCB4aSwgcWksIHhqLCBxaik7CiAgICAvLyAgICAgICBpZighZCl7CiAgICAvLyAgICAgICAgICAgdHJpYW5nbGVOb3JtYWwuc2NhbGUoLTEsIHRyaWFuZ2xlTm9ybWFsKTsKICAgIC8vICAgICAgICAgICBkID0gc2kudGVzdFNlcEF4aXModHJpYW5nbGVOb3JtYWwsIGh1bGxCLCB4aSwgcWksIHhqLCBxaik7CiAgICAvLyAgICAgICAgICAgaWYoIWQpewogICAgLy8gICAgICAgICAgICAgICBjb250aW51ZTsKICAgIC8vICAgICAgICAgICB9CiAgICAvLyAgICAgICB9CiAgICAvLyAgICAgICBjb25zdCByZXM6IENvbnZleFBvbHloZWRyb25Db250YWN0UG9pbnRbXSA9IFtdOwogICAgLy8gICAgICAgY29uc3QgcSA9IGNvbnZleENvbnZleF9xOwogICAgLy8gICAgICAgc2kuY2xpcEFnYWluc3RIdWxsKHhpLHFpLGh1bGxCLHhqLHFqLHRyaWFuZ2xlTm9ybWFsLC0xMDAsMTAwLHJlcyk7CiAgICAvLyAgICAgICBmb3IobGV0IGogPSAwOyBqICE9PSByZXMubGVuZ3RoOyBqKyspewogICAgLy8gICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSxiaixzaSxzaixyc2kscnNqKSwKICAgIC8vICAgICAgICAgICAgICAgcmkgPSByLnJpLAogICAgLy8gICAgICAgICAgICAgICByaiA9IHIucmo7CiAgICAvLyAgICAgICAgICAgci5uaS5jb3B5KHRyaWFuZ2xlTm9ybWFsKTsKICAgIC8vICAgICAgICAgICByLm5pLm5lZ2F0ZShyLm5pKTsKICAgIC8vICAgICAgICAgICByZXNbal0ubm9ybWFsLm5lZ2F0ZShxKTsKICAgIC8vICAgICAgICAgICBxLm11bHQocmVzW2pdLmRlcHRoLCBxKTsKICAgIC8vICAgICAgICAgICByZXNbal0ucG9pbnQudmFkZChxLCByaSk7CiAgICAvLyAgICAgICAgICAgcmouY29weShyZXNbal0ucG9pbnQpOwogICAgLy8gICAgICAgICAgIC8vIENvbnRhY3QgcG9pbnRzIGFyZSBpbiB3b3JsZCBjb29yZGluYXRlcy4gVHJhbnNmb3JtIGJhY2sgdG8gcmVsYXRpdmUKICAgIC8vICAgICAgICAgICByaS52c3ViKHhpLHJpKTsKICAgIC8vICAgICAgICAgICByai52c3ViKHhqLHJqKTsKICAgIC8vICAgICAgICAgICAvLyBNYWtlIHJlbGF0aXZlIHRvIGJvZGllcwogICAgLy8gICAgICAgICAgIHJpLnZhZGQoeGksIHJpKTsKICAgIC8vICAgICAgICAgICByaS52c3ViKGJpLnBvc2l0aW9uLCByaSk7CiAgICAvLyAgICAgICAgICAgcmoudmFkZCh4aiwgcmopOwogICAgLy8gICAgICAgICAgIHJqLnZzdWIoYmoucG9zaXRpb24sIHJqKTsKICAgIC8vICAgICAgICAgICByZXN1bHQucHVzaChyKTsKICAgIC8vICAgICAgIH0KICAgIC8vICAgfQogICAgLy8gfQoKCiAgfQogIGNvbnN0IGF2ZXJhZ2VOb3JtYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IGF2ZXJhZ2VDb250YWN0UG9pbnRBID0gbmV3IFZlYzMoKTsKICBjb25zdCBhdmVyYWdlQ29udGFjdFBvaW50QiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wVmVjMSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wVmVjMiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wUXVhdDEgPSBuZXcgUXVhdGVybmlvbigpOwogIGNvbnN0IHRtcFF1YXQyID0gbmV3IFF1YXRlcm5pb24oKTsKCiAgY29uc3QgcGxhbmVUcmltZXNoX25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGxhbmVUcmltZXNoX3JlbHBvcyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGxhbmVUcmltZXNoX3Byb2plY3RlZCA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9ub3JtYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfcmVscG9zID0gbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfdiA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF92MiA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9lZGdlVmVydGV4QSA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9lZGdlVmVydGV4QiA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9lZGdlVmVjdG9yID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVUcmltZXNoX2VkZ2VWZWN0b3JVbml0ID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVUcmltZXNoX2xvY2FsU3BoZXJlUG9zID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVUcmltZXNoX3RtcCA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF92YSA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF92YiA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF92YyA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9sb2NhbFNwaGVyZUFBQkIgPSBuZXcgQUFCQigpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfdHJpYW5nbGVzID0gW107CiAgY29uc3QgcG9pbnRfb25fcGxhbmVfdG9fc3BoZXJlID0gbmV3IFZlYzMoKTsKICBjb25zdCBwbGFuZV90b19zcGhlcmVfb3J0aG8gPSBuZXcgVmVjMygpOyAvLyBTZWUgaHR0cDovL2J1bGxldHBoeXNpY3MuY29tL0J1bGxldC9CdWxsZXRGdWxsL1NwaGVyZVRyaWFuZ2xlRGV0ZWN0b3JfOGNwcF9zb3VyY2UuaHRtbAoKICBjb25zdCBwb2ludEluUG9seWdvbl9lZGdlID0gbmV3IFZlYzMoKTsKICBjb25zdCBwb2ludEluUG9seWdvbl9lZGdlX3hfbm9ybWFsID0gbmV3IFZlYzMoKTsKICBjb25zdCBwb2ludEluUG9seWdvbl92dHAgPSBuZXcgVmVjMygpOwoKICBmdW5jdGlvbiBwb2ludEluUG9seWdvbih2ZXJ0cywgbm9ybWFsLCBwKSB7CiAgICBsZXQgcG9zaXRpdmVSZXN1bHQgPSBudWxsOwogICAgY29uc3QgTiA9IHZlcnRzLmxlbmd0aDsKCiAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgIGNvbnN0IHYgPSB2ZXJ0c1tpXTsgLy8gR2V0IGVkZ2UgdG8gdGhlIG5leHQgdmVydGV4CgogICAgICBjb25zdCBlZGdlID0gcG9pbnRJblBvbHlnb25fZWRnZTsKICAgICAgdmVydHNbKGkgKyAxKSAlIE5dLnZzdWIodiwgZWRnZSk7IC8vIEdldCBjcm9zcyBwcm9kdWN0IGJldHdlZW4gcG9seWdvbiBub3JtYWwgYW5kIHRoZSBlZGdlCgogICAgICBjb25zdCBlZGdlX3hfbm9ybWFsID0gcG9pbnRJblBvbHlnb25fZWRnZV94X25vcm1hbDsgLy9jb25zdCBlZGdlX3hfbm9ybWFsID0gbmV3IFZlYzMoKTsKCiAgICAgIGVkZ2UuY3Jvc3Mobm9ybWFsLCBlZGdlX3hfbm9ybWFsKTsgLy8gR2V0IHZlY3RvciBiZXR3ZWVuIHBvaW50IGFuZCBjdXJyZW50IHZlcnRleAoKICAgICAgY29uc3QgdmVydGV4X3RvX3AgPSBwb2ludEluUG9seWdvbl92dHA7CiAgICAgIHAudnN1Yih2LCB2ZXJ0ZXhfdG9fcCk7IC8vIFRoaXMgZG90IHByb2R1Y3QgZGV0ZXJtaW5lcyB3aGljaCBzaWRlIG9mIHRoZSBlZGdlIHRoZSBwb2ludCBpcwoKICAgICAgY29uc3QgciA9IGVkZ2VfeF9ub3JtYWwuZG90KHZlcnRleF90b19wKTsgLy8gSWYgYWxsIHN1Y2ggZG90IHByb2R1Y3RzIGhhdmUgc2FtZSBzaWduLCB3ZSBhcmUgaW5zaWRlIHRoZSBwb2x5Z29uLgoKICAgICAgaWYgKHBvc2l0aXZlUmVzdWx0ID09PSBudWxsIHx8IHIgPiAwICYmIHBvc2l0aXZlUmVzdWx0ID09PSB0cnVlIHx8IHIgPD0gMCAmJiBwb3NpdGl2ZVJlc3VsdCA9PT0gZmFsc2UpIHsKICAgICAgICBpZiAocG9zaXRpdmVSZXN1bHQgPT09IG51bGwpIHsKICAgICAgICAgIHBvc2l0aXZlUmVzdWx0ID0gciA+IDA7CiAgICAgICAgfQoKICAgICAgICBjb250aW51ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7IC8vIEVuY291bnRlcmVkIHNvbWUgb3RoZXIgc2lnbi4gRXhpdC4KICAgICAgfQogICAgfSAvLyBJZiB3ZSBnb3QgaGVyZSwgYWxsIGRvdCBwcm9kdWN0cyB3ZXJlIG9mIHRoZSBzYW1lIHNpZ24uCgoKICAgIHJldHVybiB0cnVlOwogIH0KCiAgY29uc3QgYm94X3RvX3NwaGVyZSA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQm94X25zID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVCb3hfbnMxID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVCb3hfbnMyID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVCb3hfc2lkZXMgPSBbbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKV07CiAgY29uc3Qgc3BoZXJlQm94X3NwaGVyZV90b19jb3JuZXIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUJveF9zaWRlX25zID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVCb3hfc2lkZV9uczEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUJveF9zaWRlX25zMiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgY29udmV4X3RvX3NwaGVyZSA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQ29udmV4X2VkZ2UgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF9lZGdlVW5pdCA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQ29udmV4X3NwaGVyZVRvQ29ybmVyID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVDb252ZXhfd29ybGRDb3JuZXIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF93b3JsZE5vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQ29udmV4X3dvcmxkUG9pbnQgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF93b3JsZFNwaGVyZVBvaW50Q2xvc2VzdFRvUGxhbmUgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF9wZW5ldHJhdGlvblZlYyA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQ29udmV4X3NwaGVyZVRvV29ybGRQb2ludCA9IG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIGNvbnN0IHBsYW5lQ29udmV4X3YgPSBuZXcgVmVjMygpOwogIGNvbnN0IHBsYW5lQ29udmV4X25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGxhbmVDb252ZXhfcmVscG9zID0gbmV3IFZlYzMoKTsKICBjb25zdCBwbGFuZUNvbnZleF9wcm9qZWN0ZWQgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleENvbnZleF9zZXBBeGlzID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb252ZXhDb252ZXhfcSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGFydGljbGVQbGFuZV9ub3JtYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IHBhcnRpY2xlUGxhbmVfcmVscG9zID0gbmV3IFZlYzMoKTsKICBjb25zdCBwYXJ0aWNsZVBsYW5lX3Byb2plY3RlZCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGFydGljbGVTcGhlcmVfbm9ybWFsID0gbmV3IFZlYzMoKTsgLy8gV0lQCgogIGNvbnN0IGNxaiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgY29uc3QgY29udmV4UGFydGljbGVfbG9jYWwgPSBuZXcgVmVjMygpOwogIG5ldyBWZWMzKCk7CiAgY29uc3QgY29udmV4UGFydGljbGVfcGVuZXRyYXRlZEZhY2VOb3JtYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleFBhcnRpY2xlX3ZlcnRleFRvUGFydGljbGUgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleFBhcnRpY2xlX3dvcmxkUGVuZXRyYXRpb25WZWMgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleEhlaWdodGZpZWxkX3RtcDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleEhlaWdodGZpZWxkX3RtcDIgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleEhlaWdodGZpZWxkX2ZhY2VMaXN0ID0gWzBdOwogIGNvbnN0IHNwaGVyZUhlaWdodGZpZWxkX3RtcDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUhlaWdodGZpZWxkX3RtcDIgPSBuZXcgVmVjMygpOwoKICBjbGFzcyBPdmVybGFwS2VlcGVyIHsKICAgIC8qKgogICAgICogQHRvZG8gUmVtb3ZlIHVzZWxlc3MgY29uc3RydWN0b3IKICAgICAqLwogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHRoaXMuY3VycmVudCA9IFtdOwogICAgICB0aGlzLnByZXZpb3VzID0gW107CiAgICB9CiAgICAvKioKICAgICAqIGdldEtleQogICAgICovCgoKICAgIGdldEtleShpLCBqKSB7CiAgICAgIGlmIChqIDwgaSkgewogICAgICAgIGNvbnN0IHRlbXAgPSBqOwogICAgICAgIGogPSBpOwogICAgICAgIGkgPSB0ZW1wOwogICAgICB9CgogICAgICByZXR1cm4gaSA8PCAxNiB8IGo7CiAgICB9CiAgICAvKioKICAgICAqIHNldAogICAgICovCgoKICAgIHNldChpLCBqKSB7CiAgICAgIC8vIEluc2VydGlvbiBzb3J0LiBUaGlzIHdheSB0aGUgZGlmZiB3aWxsIGhhdmUgbGluZWFyIGNvbXBsZXhpdHkuCiAgICAgIGNvbnN0IGtleSA9IHRoaXMuZ2V0S2V5KGksIGopOwogICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5jdXJyZW50OwogICAgICBsZXQgaW5kZXggPSAwOwoKICAgICAgd2hpbGUgKGtleSA+IGN1cnJlbnRbaW5kZXhdKSB7CiAgICAgICAgaW5kZXgrKzsKICAgICAgfQoKICAgICAgaWYgKGtleSA9PT0gY3VycmVudFtpbmRleF0pIHsKICAgICAgICByZXR1cm47IC8vIFBhaXIgd2FzIGFscmVhZHkgYWRkZWQKICAgICAgfQoKICAgICAgZm9yIChsZXQgaiA9IGN1cnJlbnQubGVuZ3RoIC0gMTsgaiA+PSBpbmRleDsgai0tKSB7CiAgICAgICAgY3VycmVudFtqICsgMV0gPSBjdXJyZW50W2pdOwogICAgICB9CgogICAgICBjdXJyZW50W2luZGV4XSA9IGtleTsKICAgIH0KICAgIC8qKgogICAgICogdGljawogICAgICovCgoKICAgIHRpY2soKSB7CiAgICAgIGNvbnN0IHRtcCA9IHRoaXMuY3VycmVudDsKICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5wcmV2aW91czsKICAgICAgdGhpcy5wcmV2aW91cyA9IHRtcDsKICAgICAgdGhpcy5jdXJyZW50Lmxlbmd0aCA9IDA7CiAgICB9CiAgICAvKioKICAgICAqIGdldERpZmYKICAgICAqLwoKCiAgICBnZXREaWZmKGFkZGl0aW9ucywgcmVtb3ZhbHMpIHsKICAgICAgY29uc3QgYSA9IHRoaXMuY3VycmVudDsKICAgICAgY29uc3QgYiA9IHRoaXMucHJldmlvdXM7CiAgICAgIGNvbnN0IGFsID0gYS5sZW5ndGg7CiAgICAgIGNvbnN0IGJsID0gYi5sZW5ndGg7CiAgICAgIGxldCBqID0gMDsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYWw7IGkrKykgewogICAgICAgIGxldCBmb3VuZCA9IGZhbHNlOwogICAgICAgIGNvbnN0IGtleUEgPSBhW2ldOwoKICAgICAgICB3aGlsZSAoa2V5QSA+IGJbal0pIHsKICAgICAgICAgIGorKzsKICAgICAgICB9CgogICAgICAgIGZvdW5kID0ga2V5QSA9PT0gYltqXTsKCiAgICAgICAgaWYgKCFmb3VuZCkgewogICAgICAgICAgdW5wYWNrQW5kUHVzaChhZGRpdGlvbnMsIGtleUEpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaiA9IDA7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsOyBpKyspIHsKICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTsKICAgICAgICBjb25zdCBrZXlCID0gYltpXTsKCiAgICAgICAgd2hpbGUgKGtleUIgPiBhW2pdKSB7CiAgICAgICAgICBqKys7CiAgICAgICAgfQoKICAgICAgICBmb3VuZCA9IGFbal0gPT09IGtleUI7CgogICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgIHVucGFja0FuZFB1c2gocmVtb3ZhbHMsIGtleUIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICB9CgogIGZ1bmN0aW9uIHVucGFja0FuZFB1c2goYXJyYXksIGtleSkgewogICAgYXJyYXkucHVzaCgoa2V5ICYgMHhmZmZmMDAwMCkgPj4gMTYsIGtleSAmIDB4MDAwMGZmZmYpOwogIH0KCiAgY29uc3QgZ2V0S2V5ID0gKGksIGopID0+IGkgPCBqID8gYCR7aX0tJHtqfWAgOiBgJHtqfS0ke2l9YDsKICAvKioKICAgKiBUdXBsZURpY3Rpb25hcnkKICAgKi8KCgogIGNsYXNzIFR1cGxlRGljdGlvbmFyeSB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5kYXRhID0gewogICAgICAgIGtleXM6IFtdCiAgICAgIH07CiAgICB9CgogICAgLyoqIGdldCAqLwogICAgZ2V0KGksIGopIHsKICAgICAgY29uc3Qga2V5ID0gZ2V0S2V5KGksIGopOwogICAgICByZXR1cm4gdGhpcy5kYXRhW2tleV07CiAgICB9CiAgICAvKiogc2V0ICovCgoKICAgIHNldChpLCBqLCB2YWx1ZSkgewogICAgICBjb25zdCBrZXkgPSBnZXRLZXkoaSwgaik7IC8vIENoZWNrIGlmIGtleSBhbHJlYWR5IGV4aXN0cwoKICAgICAgaWYgKCF0aGlzLmdldChpLCBqKSkgewogICAgICAgIHRoaXMuZGF0YS5rZXlzLnB1c2goa2V5KTsKICAgICAgfQoKICAgICAgdGhpcy5kYXRhW2tleV0gPSB2YWx1ZTsKICAgIH0KICAgIC8qKiBkZWxldGUgKi8KCgogICAgZGVsZXRlKGksIGopIHsKICAgICAgY29uc3Qga2V5ID0gZ2V0S2V5KGksIGopOwogICAgICBjb25zdCBpbmRleCA9IHRoaXMuZGF0YS5rZXlzLmluZGV4T2Yoa2V5KTsKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICB0aGlzLmRhdGEua2V5cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CgogICAgICBkZWxldGUgdGhpcy5kYXRhW2tleV07CiAgICB9CiAgICAvKiogcmVzZXQgKi8KCgogICAgcmVzZXQoKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGNvbnN0IGtleXMgPSBkYXRhLmtleXM7CgogICAgICB3aGlsZSAoa2V5cy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3Qga2V5ID0ga2V5cy5wb3AoKTsKICAgICAgICBkZWxldGUgZGF0YVtrZXldOwogICAgICB9CiAgICB9CgogIH0KCiAgLyoqCiAgICogVGhlIHBoeXNpY3Mgd29ybGQKICAgKi8KICBjbGFzcyBXb3JsZCBleHRlbmRzIEV2ZW50VGFyZ2V0IHsKICAgIC8qKgogICAgICogQ3VycmVudGx5IC8gbGFzdCB1c2VkIHRpbWVzdGVwLiBJcyBzZXQgdG8gLTEgaWYgbm90IGF2YWlsYWJsZS4gVGhpcyB2YWx1ZSBpcyB1cGRhdGVkIGJlZm9yZSBlYWNoIGludGVybmFsIHN0ZXAsIHdoaWNoIG1lYW5zIHRoYXQgaXQgaXMgImZyZXNoIiBpbnNpZGUgZXZlbnQgY2FsbGJhY2tzLgogICAgICovCgogICAgLyoqCiAgICAgKiBNYWtlcyBib2RpZXMgZ28gdG8gc2xlZXAgd2hlbiB0aGV5J3ZlIGJlZW4gaW5hY3RpdmUuCiAgICAgKiBAZGVmYXVsdCBmYWxzZQogICAgICovCgogICAgLyoqCiAgICAgKiBBbGwgdGhlIGN1cnJlbnQgY29udGFjdHMgKGluc3RhbmNlcyBvZiBDb250YWN0RXF1YXRpb24pIGluIHRoZSB3b3JsZC4KICAgICAqLwoKICAgIC8qKgogICAgICogSG93IG9mdGVuIHRvIG5vcm1hbGl6ZSBxdWF0ZXJuaW9ucy4gU2V0IHRvIDAgZm9yIGV2ZXJ5IHN0ZXAsIDEgZm9yIGV2ZXJ5IHNlY29uZCBldGMuLiBBIGxhcmdlciB2YWx1ZSBpbmNyZWFzZXMgcGVyZm9ybWFuY2UuIElmIGJvZGllcyB0ZW5kIHRvIGV4cGxvZGUsIHNldCB0byBhIHNtYWxsZXIgdmFsdWUgKHplcm8gdG8gYmUgc3VyZSBub3RoaW5nIGNhbiBnbyB3cm9uZykuCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNldCB0byB0cnVlIHRvIHVzZSBmYXN0IHF1YXRlcm5pb24gbm9ybWFsaXphdGlvbi4gSXQgaXMgb2Z0ZW4gZW5vdWdoIGFjY3VyYXRlIHRvIHVzZS4KICAgICAqIElmIGJvZGllcyB0ZW5kIHRvIGV4cGxvZGUsIHNldCB0byBmYWxzZS4KICAgICAqIEBkZWZhdWx0IGZhbHNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSB3YWxsLWNsb2NrIHRpbWUgc2luY2Ugc2ltdWxhdGlvbiBzdGFydC4KICAgICAqLwoKICAgIC8qKgogICAgICogTnVtYmVyIG9mIHRpbWVzdGVwcyB0YWtlbiBzaW5jZSBzdGFydC4KICAgICAqLwoKICAgIC8qKgogICAgICogRGVmYXVsdCBhbmQgbGFzdCB0aW1lc3RlcCBzaXplcy4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGdyYXZpdHkgb2YgdGhlIHdvcmxkLgogICAgICovCgogICAgLyoqCiAgICAgKiBHcmF2aXR5IHRvIHVzZSB3aGVuIGFwcHJveGltYXRpbmcgdGhlIGZyaWN0aW9uIG1heCBmb3JjZSAobXUqbWFzcypncmF2aXR5KS4KICAgICAqIElmIHVuZGVmaW5lZCwgZ2xvYmFsIGdyYXZpdHkgd2lsbCBiZSB1c2VkLgogICAgICogVXNlIHRvIGVuYWJsZSBmcmljdGlvbiBpbiBhIFdvcmxkIHdpdGggYSBudWxsIGdyYXZpdHkgdmVjdG9yIChubyBncmF2aXR5KS4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGJyb2FkcGhhc2UgYWxnb3JpdGhtIHRvIHVzZS4KICAgICAqIEBkZWZhdWx0IE5haXZlQnJvYWRwaGFzZQogICAgICovCgogICAgLyoqCiAgICAgKiBBbGwgYm9kaWVzIGluIHRoaXMgd29ybGQKICAgICAqLwoKICAgIC8qKgogICAgICogVHJ1ZSBpZiBhbnkgYm9kaWVzIGFyZSBub3Qgc2xlZXBpbmcsIGZhbHNlIGlmIGV2ZXJ5IGJvZHkgaXMgc2xlZXBpbmcuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBzb2x2ZXIgYWxnb3JpdGhtIHRvIHVzZS4KICAgICAqIEBkZWZhdWx0IEdTU29sdmVyCiAgICAgKi8KCiAgICAvKioKICAgICAqIGNvbGxpc2lvbk1hdHJpeAogICAgICovCgogICAgLyoqCiAgICAgKiBDb2xsaXNpb25NYXRyaXggZnJvbSB0aGUgcHJldmlvdXMgc3RlcC4KICAgICAqLwoKICAgIC8qKgogICAgICogQWxsIGFkZGVkIGNvbnRhY3RtYXRlcmlhbHMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFVzZWQgdG8gbG9vayB1cCBhIENvbnRhY3RNYXRlcmlhbCBnaXZlbiB0d28gaW5zdGFuY2VzIG9mIE1hdGVyaWFsLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgZGVmYXVsdCBtYXRlcmlhbCBvZiB0aGUgYm9kaWVzLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGlzIGNvbnRhY3QgbWF0ZXJpYWwgaXMgdXNlZCBpZiBubyBzdWl0YWJsZSBjb250YWN0bWF0ZXJpYWwgaXMgZm91bmQgZm9yIGEgY29udGFjdC4KICAgICAqLwoKICAgIC8qKgogICAgICogVGltZSBhY2N1bXVsYXRvciBmb3IgaW50ZXJwb2xhdGlvbi4KICAgICAqIEBzZWUgaHR0cHM6Ly9nYWZmZXJvbmdhbWVzLmNvbS9nYW1lLXBoeXNpY3MvZml4LXlvdXItdGltZXN0ZXAvCiAgICAgKi8KCiAgICAvKioKICAgICAqIERpc3BhdGNoZWQgYWZ0ZXIgYSBib2R5IGhhcyBiZWVuIGFkZGVkIHRvIHRoZSB3b3JsZC4KICAgICAqLwoKICAgIC8qKgogICAgICogRGlzcGF0Y2hlZCBhZnRlciBhIGJvZHkgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSB3b3JsZC4KICAgICAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBzdXBlcigpOwogICAgICB0aGlzLmR0ID0gLTE7CiAgICAgIHRoaXMuYWxsb3dTbGVlcCA9ICEhb3B0aW9ucy5hbGxvd1NsZWVwOwogICAgICB0aGlzLmNvbnRhY3RzID0gW107CiAgICAgIHRoaXMuZnJpY3Rpb25FcXVhdGlvbnMgPSBbXTsKICAgICAgdGhpcy5xdWF0Tm9ybWFsaXplU2tpcCA9IG9wdGlvbnMucXVhdE5vcm1hbGl6ZVNraXAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMucXVhdE5vcm1hbGl6ZVNraXAgOiAwOwogICAgICB0aGlzLnF1YXROb3JtYWxpemVGYXN0ID0gb3B0aW9ucy5xdWF0Tm9ybWFsaXplRmFzdCAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5xdWF0Tm9ybWFsaXplRmFzdCA6IGZhbHNlOwogICAgICB0aGlzLnRpbWUgPSAwLjA7CiAgICAgIHRoaXMuc3RlcG51bWJlciA9IDA7CiAgICAgIHRoaXMuZGVmYXVsdF9kdCA9IDEgLyA2MDsKICAgICAgdGhpcy5uZXh0SWQgPSAwOwogICAgICB0aGlzLmdyYXZpdHkgPSBuZXcgVmVjMygpOwoKICAgICAgaWYgKG9wdGlvbnMuZ3Jhdml0eSkgewogICAgICAgIHRoaXMuZ3Jhdml0eS5jb3B5KG9wdGlvbnMuZ3Jhdml0eSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLmZyaWN0aW9uR3Jhdml0eSkgewogICAgICAgIHRoaXMuZnJpY3Rpb25HcmF2aXR5ID0gbmV3IFZlYzMoKTsKICAgICAgICB0aGlzLmZyaWN0aW9uR3Jhdml0eS5jb3B5KG9wdGlvbnMuZnJpY3Rpb25HcmF2aXR5KTsKICAgICAgfQoKICAgICAgdGhpcy5icm9hZHBoYXNlID0gb3B0aW9ucy5icm9hZHBoYXNlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmJyb2FkcGhhc2UgOiBuZXcgTmFpdmVCcm9hZHBoYXNlKCk7CiAgICAgIHRoaXMuYm9kaWVzID0gW107CiAgICAgIHRoaXMuaGFzQWN0aXZlQm9kaWVzID0gZmFsc2U7CiAgICAgIHRoaXMuc29sdmVyID0gb3B0aW9ucy5zb2x2ZXIgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc29sdmVyIDogbmV3IEdTU29sdmVyKCk7CiAgICAgIHRoaXMuY29uc3RyYWludHMgPSBbXTsKICAgICAgdGhpcy5uYXJyb3dwaGFzZSA9IG5ldyBOYXJyb3dwaGFzZSh0aGlzKTsKICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXggPSBuZXcgQXJyYXlDb2xsaXNpb25NYXRyaXgoKTsKICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXhQcmV2aW91cyA9IG5ldyBBcnJheUNvbGxpc2lvbk1hdHJpeCgpOwogICAgICB0aGlzLmJvZHlPdmVybGFwS2VlcGVyID0gbmV3IE92ZXJsYXBLZWVwZXIoKTsKICAgICAgdGhpcy5zaGFwZU92ZXJsYXBLZWVwZXIgPSBuZXcgT3ZlcmxhcEtlZXBlcigpOwogICAgICB0aGlzLmNvbnRhY3RtYXRlcmlhbHMgPSBbXTsKICAgICAgdGhpcy5jb250YWN0TWF0ZXJpYWxUYWJsZSA9IG5ldyBUdXBsZURpY3Rpb25hcnkoKTsKICAgICAgdGhpcy5kZWZhdWx0TWF0ZXJpYWwgPSBuZXcgTWF0ZXJpYWwoJ2RlZmF1bHQnKTsKICAgICAgdGhpcy5kZWZhdWx0Q29udGFjdE1hdGVyaWFsID0gbmV3IENvbnRhY3RNYXRlcmlhbCh0aGlzLmRlZmF1bHRNYXRlcmlhbCwgdGhpcy5kZWZhdWx0TWF0ZXJpYWwsIHsKICAgICAgICBmcmljdGlvbjogMC4zLAogICAgICAgIHJlc3RpdHV0aW9uOiAwLjAKICAgICAgfSk7CiAgICAgIHRoaXMuZG9Qcm9maWxpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5wcm9maWxlID0gewogICAgICAgIHNvbHZlOiAwLAogICAgICAgIG1ha2VDb250YWN0Q29uc3RyYWludHM6IDAsCiAgICAgICAgYnJvYWRwaGFzZTogMCwKICAgICAgICBpbnRlZ3JhdGU6IDAsCiAgICAgICAgbmFycm93cGhhc2U6IDAKICAgICAgfTsKICAgICAgdGhpcy5hY2N1bXVsYXRvciA9IDA7CiAgICAgIHRoaXMuc3Vic3lzdGVtcyA9IFtdOwogICAgICB0aGlzLmFkZEJvZHlFdmVudCA9IHsKICAgICAgICB0eXBlOiAnYWRkQm9keScsCiAgICAgICAgYm9keTogbnVsbAogICAgICB9OwogICAgICB0aGlzLnJlbW92ZUJvZHlFdmVudCA9IHsKICAgICAgICB0eXBlOiAncmVtb3ZlQm9keScsCiAgICAgICAgYm9keTogbnVsbAogICAgICB9OwogICAgICB0aGlzLmlkVG9Cb2R5TWFwID0ge307CiAgICAgIHRoaXMuYnJvYWRwaGFzZS5zZXRXb3JsZCh0aGlzKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBjb250YWN0IG1hdGVyaWFsIGJldHdlZW4gbWF0ZXJpYWxzIG0xIGFuZCBtMgogICAgICogQHJldHVybiBUaGUgY29udGFjdCBtYXRlcmlhbCBpZiBpdCB3YXMgZm91bmQuCiAgICAgKi8KCgogICAgZ2V0Q29udGFjdE1hdGVyaWFsKG0xLCBtMikgewogICAgICByZXR1cm4gdGhpcy5jb250YWN0TWF0ZXJpYWxUYWJsZS5nZXQobTEuaWQsIG0yLmlkKTsKICAgIH0KICAgIC8qKgogICAgICogU3RvcmUgb2xkIGNvbGxpc2lvbiBzdGF0ZSBpbmZvCiAgICAgKi8KCgogICAgY29sbGlzaW9uTWF0cml4VGljaygpIHsKICAgICAgY29uc3QgdGVtcCA9IHRoaXMuY29sbGlzaW9uTWF0cml4UHJldmlvdXM7CiAgICAgIHRoaXMuY29sbGlzaW9uTWF0cml4UHJldmlvdXMgPSB0aGlzLmNvbGxpc2lvbk1hdHJpeDsKICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXggPSB0ZW1wOwogICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeC5yZXNldCgpOwogICAgICB0aGlzLmJvZHlPdmVybGFwS2VlcGVyLnRpY2soKTsKICAgICAgdGhpcy5zaGFwZU92ZXJsYXBLZWVwZXIudGljaygpOwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgYSBjb25zdHJhaW50IHRvIHRoZSBzaW11bGF0aW9uLgogICAgICovCgoKICAgIGFkZENvbnN0cmFpbnQoYykgewogICAgICB0aGlzLmNvbnN0cmFpbnRzLnB1c2goYyk7CiAgICB9CiAgICAvKioKICAgICAqIFJlbW92ZXMgYSBjb25zdHJhaW50CiAgICAgKi8KCgogICAgcmVtb3ZlQ29uc3RyYWludChjKSB7CiAgICAgIGNvbnN0IGlkeCA9IHRoaXMuY29uc3RyYWludHMuaW5kZXhPZihjKTsKCiAgICAgIGlmIChpZHggIT09IC0xKSB7CiAgICAgICAgdGhpcy5jb25zdHJhaW50cy5zcGxpY2UoaWR4LCAxKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSYXljYXN0IHRlc3QKICAgICAqIEBkZXByZWNhdGVkIFVzZSAucmF5Y2FzdEFsbCwgLnJheWNhc3RDbG9zZXN0IG9yIC5yYXljYXN0QW55IGluc3RlYWQuCiAgICAgKi8KCgogICAgcmF5VGVzdChmcm9tLCB0bywgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBSYXljYXN0UmVzdWx0KSB7CiAgICAgICAgLy8gRG8gcmF5Y2FzdENsb3Nlc3QKICAgICAgICB0aGlzLnJheWNhc3RDbG9zZXN0KGZyb20sIHRvLCB7CiAgICAgICAgICBza2lwQmFja2ZhY2VzOiB0cnVlCiAgICAgICAgfSwgcmVzdWx0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBEbyByYXljYXN0QWxsCiAgICAgICAgdGhpcy5yYXljYXN0QWxsKGZyb20sIHRvLCB7CiAgICAgICAgICBza2lwQmFja2ZhY2VzOiB0cnVlCiAgICAgICAgfSwgcmVzdWx0KTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSYXkgY2FzdCBhZ2FpbnN0IGFsbCBib2RpZXMuIFRoZSBwcm92aWRlZCBjYWxsYmFjayB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoIGhpdCB3aXRoIGEgUmF5Y2FzdFJlc3VsdCBhcyBzaW5nbGUgYXJndW1lbnQuCiAgICAgKiBAcmV0dXJuIFRydWUgaWYgYW55IGJvZHkgd2FzIGhpdC4KICAgICAqLwoKCiAgICByYXljYXN0QWxsKGZyb20sIHRvLCBvcHRpb25zLCBjYWxsYmFjaykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBvcHRpb25zLm1vZGUgPSBSYXkuQUxMOwogICAgICBvcHRpb25zLmZyb20gPSBmcm9tOwogICAgICBvcHRpb25zLnRvID0gdG87CiAgICAgIG9wdGlvbnMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgcmV0dXJuIHRtcFJheS5pbnRlcnNlY3RXb3JsZCh0aGlzLCBvcHRpb25zKTsKICAgIH0KICAgIC8qKgogICAgICogUmF5IGNhc3QsIGFuZCBzdG9wIGF0IHRoZSBmaXJzdCByZXN1bHQuIE5vdGUgdGhhdCB0aGUgb3JkZXIgaXMgcmFuZG9tIC0gYnV0IHRoZSBtZXRob2QgaXMgZmFzdC4KICAgICAqIEByZXR1cm4gVHJ1ZSBpZiBhbnkgYm9keSB3YXMgaGl0LgogICAgICovCgoKICAgIHJheWNhc3RBbnkoZnJvbSwgdG8sIG9wdGlvbnMsIHJlc3VsdCkgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBvcHRpb25zLm1vZGUgPSBSYXkuQU5ZOwogICAgICBvcHRpb25zLmZyb20gPSBmcm9tOwogICAgICBvcHRpb25zLnRvID0gdG87CiAgICAgIG9wdGlvbnMucmVzdWx0ID0gcmVzdWx0OwogICAgICByZXR1cm4gdG1wUmF5LmludGVyc2VjdFdvcmxkKHRoaXMsIG9wdGlvbnMpOwogICAgfQogICAgLyoqCiAgICAgKiBSYXkgY2FzdCwgYW5kIHJldHVybiBpbmZvcm1hdGlvbiBvZiB0aGUgY2xvc2VzdCBoaXQuCiAgICAgKiBAcmV0dXJuIFRydWUgaWYgYW55IGJvZHkgd2FzIGhpdC4KICAgICAqLwoKCiAgICByYXljYXN0Q2xvc2VzdChmcm9tLCB0bywgb3B0aW9ucywgcmVzdWx0KSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIG9wdGlvbnMubW9kZSA9IFJheS5DTE9TRVNUOwogICAgICBvcHRpb25zLmZyb20gPSBmcm9tOwogICAgICBvcHRpb25zLnRvID0gdG87CiAgICAgIG9wdGlvbnMucmVzdWx0ID0gcmVzdWx0OwogICAgICByZXR1cm4gdG1wUmF5LmludGVyc2VjdFdvcmxkKHRoaXMsIG9wdGlvbnMpOwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgYSByaWdpZCBib2R5IHRvIHRoZSBzaW11bGF0aW9uLgogICAgICogQHRvZG8gSWYgdGhlIHNpbXVsYXRpb24gaGFzIG5vdCB5ZXQgc3RhcnRlZCwgd2h5IHJlY3JldGUgYW5kIGNvcHkgYXJyYXlzIGZvciBlYWNoIGJvZHk/IEFjY3VtdWxhdGUgaW4gZHluYW1pYyBhcnJheXMgaW4gdGhpcyBjYXNlLgogICAgICogQHRvZG8gQWRkaW5nIGFuIGFycmF5IG9mIGJvZGllcyBzaG91bGQgYmUgcG9zc2libGUuIFRoaXMgd291bGQgc2F2ZSBzb21lIGxvb3BzIHRvbwogICAgICovCgoKICAgIGFkZEJvZHkoYm9keSkgewogICAgICBpZiAodGhpcy5ib2RpZXMuaW5jbHVkZXMoYm9keSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGJvZHkuaW5kZXggPSB0aGlzLmJvZGllcy5sZW5ndGg7CiAgICAgIHRoaXMuYm9kaWVzLnB1c2goYm9keSk7CiAgICAgIGJvZHkud29ybGQgPSB0aGlzOwogICAgICBib2R5LmluaXRQb3NpdGlvbi5jb3B5KGJvZHkucG9zaXRpb24pOwogICAgICBib2R5LmluaXRWZWxvY2l0eS5jb3B5KGJvZHkudmVsb2NpdHkpOwogICAgICBib2R5LnRpbWVMYXN0U2xlZXB5ID0gdGhpcy50aW1lOwoKICAgICAgaWYgKGJvZHkgaW5zdGFuY2VvZiBCb2R5KSB7CiAgICAgICAgYm9keS5pbml0QW5ndWxhclZlbG9jaXR5LmNvcHkoYm9keS5hbmd1bGFyVmVsb2NpdHkpOwogICAgICAgIGJvZHkuaW5pdFF1YXRlcm5pb24uY29weShib2R5LnF1YXRlcm5pb24pOwogICAgICB9CgogICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeC5zZXROdW1PYmplY3RzKHRoaXMuYm9kaWVzLmxlbmd0aCk7CiAgICAgIHRoaXMuYWRkQm9keUV2ZW50LmJvZHkgPSBib2R5OwogICAgICB0aGlzLmlkVG9Cb2R5TWFwW2JvZHkuaWRdID0gYm9keTsKICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KHRoaXMuYWRkQm9keUV2ZW50KTsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlIGEgcmlnaWQgYm9keSBmcm9tIHRoZSBzaW11bGF0aW9uLgogICAgICovCgoKICAgIHJlbW92ZUJvZHkoYm9keSkgewogICAgICBib2R5LndvcmxkID0gbnVsbDsKICAgICAgY29uc3QgbiA9IHRoaXMuYm9kaWVzLmxlbmd0aCAtIDE7CiAgICAgIGNvbnN0IGJvZGllcyA9IHRoaXMuYm9kaWVzOwogICAgICBjb25zdCBpZHggPSBib2RpZXMuaW5kZXhPZihib2R5KTsKCiAgICAgIGlmIChpZHggIT09IC0xKSB7CiAgICAgICAgYm9kaWVzLnNwbGljZShpZHgsIDEpOyAvLyBUb2RvOiBzaG91bGQgdXNlIGEgZ2FyYmFnZSBmcmVlIG1ldGhvZAogICAgICAgIC8vIFJlY29tcHV0ZSBpbmRleAoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gYm9kaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBib2RpZXNbaV0uaW5kZXggPSBpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXguc2V0TnVtT2JqZWN0cyhuKTsKICAgICAgICB0aGlzLnJlbW92ZUJvZHlFdmVudC5ib2R5ID0gYm9keTsKICAgICAgICBkZWxldGUgdGhpcy5pZFRvQm9keU1hcFtib2R5LmlkXTsKICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQodGhpcy5yZW1vdmVCb2R5RXZlbnQpOwogICAgICB9CiAgICB9CgogICAgZ2V0Qm9keUJ5SWQoaWQpIHsKICAgICAgcmV0dXJuIHRoaXMuaWRUb0JvZHlNYXBbaWRdOwogICAgfQogICAgLyoqCiAgICAgKiBAdG9kbyBNYWtlIGEgZmFzdGVyIG1hcAogICAgICovCgoKICAgIGdldFNoYXBlQnlJZChpZCkgewogICAgICBjb25zdCBib2RpZXMgPSB0aGlzLmJvZGllczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYm9kaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3Qgc2hhcGVzID0gYm9kaWVzW2ldLnNoYXBlczsKCiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzaGFwZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IHNoYXBlID0gc2hhcGVzW2pdOwoKICAgICAgICAgIGlmIChzaGFwZS5pZCA9PT0gaWQpIHsKICAgICAgICAgICAgcmV0dXJuIHNoYXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAvKioKICAgICAqIEFkZHMgYSBjb250YWN0IG1hdGVyaWFsIHRvIHRoZSBXb3JsZAogICAgICovCgoKICAgIGFkZENvbnRhY3RNYXRlcmlhbChjbWF0KSB7CiAgICAgIC8vIEFkZCBjb250YWN0IG1hdGVyaWFsCiAgICAgIHRoaXMuY29udGFjdG1hdGVyaWFscy5wdXNoKGNtYXQpOyAvLyBBZGQgY3VycmVudCBjb250YWN0IG1hdGVyaWFsIHRvIHRoZSBtYXRlcmlhbCB0YWJsZQoKICAgICAgdGhpcy5jb250YWN0TWF0ZXJpYWxUYWJsZS5zZXQoY21hdC5tYXRlcmlhbHNbMF0uaWQsIGNtYXQubWF0ZXJpYWxzWzFdLmlkLCBjbWF0KTsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlcyBhIGNvbnRhY3QgbWF0ZXJpYWwgZnJvbSB0aGUgV29ybGQuCiAgICAgKi8KCgogICAgcmVtb3ZlQ29udGFjdE1hdGVyaWFsKGNtYXQpIHsKICAgICAgY29uc3QgaWR4ID0gdGhpcy5jb250YWN0bWF0ZXJpYWxzLmluZGV4T2YoY21hdCk7CgogICAgICBpZiAoaWR4ID09PSAtMSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5jb250YWN0bWF0ZXJpYWxzLnNwbGljZShpZHgsIDEpOwogICAgICB0aGlzLmNvbnRhY3RNYXRlcmlhbFRhYmxlLmRlbGV0ZShjbWF0Lm1hdGVyaWFsc1swXS5pZCwgY21hdC5tYXRlcmlhbHNbMV0uaWQpOwogICAgfQogICAgLyoqCiAgICAgKiBTdGVwIHRoZSBzaW11bGF0aW9uIGZvcndhcmQga2VlcGluZyB0cmFjayBvZiBsYXN0IGNhbGxlZCB0aW1lCiAgICAgKiB0byBiZSBhYmxlIHRvIHN0ZXAgdGhlIHdvcmxkIGF0IGEgZml4ZWQgcmF0ZSwgaW5kZXBlbmRlbnRseSBvZiBmcmFtZXJhdGUuCiAgICAgKgogICAgICogQHBhcmFtIGR0IFRoZSBmaXhlZCB0aW1lIHN0ZXAgc2l6ZSB0byB1c2UgKGRlZmF1bHQ6IDEgLyA2MCkuCiAgICAgKiBAcGFyYW0gbWF4U3ViU3RlcHMgTWF4aW11bSBudW1iZXIgb2YgZml4ZWQgc3RlcHMgdG8gdGFrZSBwZXIgZnVuY3Rpb24gY2FsbCAoZGVmYXVsdDogMTApLgogICAgICogQHNlZSBodHRwczovL2dhZmZlcm9uZ2FtZXMuY29tL3Bvc3QvZml4X3lvdXJfdGltZXN0ZXAvCiAgICAgKiBAZXhhbXBsZQogICAgICogICAgIC8vIFJ1biB0aGUgc2ltdWxhdGlvbiBpbmRlcGVuZGVudGx5IG9mIGZyYW1lcmF0ZSBldmVyeSAxIC8gNjAgbXMKICAgICAqICAgICB3b3JsZC5maXhlZFN0ZXAoKQogICAgICovCgoKICAgIGZpeGVkU3RlcChkdCwgbWF4U3ViU3RlcHMpIHsKICAgICAgaWYgKGR0ID09PSB2b2lkIDApIHsKICAgICAgICBkdCA9IDEgLyA2MDsKICAgICAgfQoKICAgICAgaWYgKG1heFN1YlN0ZXBzID09PSB2b2lkIDApIHsKICAgICAgICBtYXhTdWJTdGVwcyA9IDEwOwogICAgICB9CgogICAgICBjb25zdCB0aW1lID0gcGVyZm9ybWFuY2Uubm93KCkgLyAxMDAwOyAvLyBzZWNvbmRzCgogICAgICBpZiAoIXRoaXMubGFzdENhbGxUaW1lKSB7CiAgICAgICAgdGhpcy5zdGVwKGR0LCB1bmRlZmluZWQsIG1heFN1YlN0ZXBzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCB0aW1lU2luY2VMYXN0Q2FsbGVkID0gdGltZSAtIHRoaXMubGFzdENhbGxUaW1lOwogICAgICAgIHRoaXMuc3RlcChkdCwgdGltZVNpbmNlTGFzdENhbGxlZCwgbWF4U3ViU3RlcHMpOwogICAgICB9CgogICAgICB0aGlzLmxhc3RDYWxsVGltZSA9IHRpbWU7CiAgICB9CiAgICAvKioKICAgICAqIFN0ZXAgdGhlIHBoeXNpY3Mgd29ybGQgZm9yd2FyZCBpbiB0aW1lLgogICAgICoKICAgICAqIFRoZXJlIGFyZSB0d28gbW9kZXMuIFRoZSBzaW1wbGUgbW9kZSBpcyBmaXhlZCB0aW1lc3RlcHBpbmcgd2l0aG91dCBpbnRlcnBvbGF0aW9uLiBJbiB0aGlzIGNhc2UgeW91IG9ubHkgdXNlIHRoZSBmaXJzdCBhcmd1bWVudC4gVGhlIHNlY29uZCBjYXNlIHVzZXMgaW50ZXJwb2xhdGlvbi4gSW4gdGhhdCB5b3UgYWxzbyBwcm92aWRlIHRoZSB0aW1lIHNpbmNlIHRoZSBmdW5jdGlvbiB3YXMgbGFzdCB1c2VkLCBhcyB3ZWxsIGFzIHRoZSBtYXhpbXVtIGZpeGVkIHRpbWVzdGVwcyB0byB0YWtlLgogICAgICoKICAgICAqIEBwYXJhbSBkdCBUaGUgZml4ZWQgdGltZSBzdGVwIHNpemUgdG8gdXNlLgogICAgICogQHBhcmFtIHRpbWVTaW5jZUxhc3RDYWxsZWQgVGhlIHRpbWUgZWxhcHNlZCBzaW5jZSB0aGUgZnVuY3Rpb24gd2FzIGxhc3QgY2FsbGVkLgogICAgICogQHBhcmFtIG1heFN1YlN0ZXBzIE1heGltdW0gbnVtYmVyIG9mIGZpeGVkIHN0ZXBzIHRvIHRha2UgcGVyIGZ1bmN0aW9uIGNhbGwgKGRlZmF1bHQ6IDEwKS4KICAgICAqIEBzZWUgaHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTgwNDI2MTU0NTMxL2h0dHA6Ly9idWxsZXRwaHlzaWNzLm9yZy9tZWRpYXdpa2ktMS41LjgvaW5kZXgucGhwL1N0ZXBwaW5nX1RoZV9Xb3JsZCNXaGF0X2RvX3RoZV9wYXJhbWV0ZXJzX3RvX2J0RHluYW1pY3NXb3JsZDo6c3RlcFNpbXVsYXRpb25fbWVhbi4zRgogICAgICogQGV4YW1wbGUKICAgICAqICAgICAvLyBmaXhlZCB0aW1lc3RlcHBpbmcgd2l0aG91dCBpbnRlcnBvbGF0aW9uCiAgICAgKiAgICAgd29ybGQuc3RlcCgxIC8gNjApCiAgICAgKi8KCgogICAgc3RlcChkdCwgdGltZVNpbmNlTGFzdENhbGxlZCwgbWF4U3ViU3RlcHMpIHsKICAgICAgaWYgKG1heFN1YlN0ZXBzID09PSB2b2lkIDApIHsKICAgICAgICBtYXhTdWJTdGVwcyA9IDEwOwogICAgICB9CgogICAgICBpZiAodGltZVNpbmNlTGFzdENhbGxlZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgLy8gRml4ZWQsIHNpbXBsZSBzdGVwcGluZwogICAgICAgIHRoaXMuaW50ZXJuYWxTdGVwKGR0KTsgLy8gSW5jcmVtZW50IHRpbWUKCiAgICAgICAgdGhpcy50aW1lICs9IGR0OwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYWNjdW11bGF0b3IgKz0gdGltZVNpbmNlTGFzdENhbGxlZDsKICAgICAgICBjb25zdCB0MCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICAgIGxldCBzdWJzdGVwcyA9IDA7CgogICAgICAgIHdoaWxlICh0aGlzLmFjY3VtdWxhdG9yID49IGR0ICYmIHN1YnN0ZXBzIDwgbWF4U3ViU3RlcHMpIHsKICAgICAgICAgIC8vIERvIGZpeGVkIHN0ZXBzIHRvIGNhdGNoIHVwCiAgICAgICAgICB0aGlzLmludGVybmFsU3RlcChkdCk7CiAgICAgICAgICB0aGlzLmFjY3VtdWxhdG9yIC09IGR0OwogICAgICAgICAgc3Vic3RlcHMrKzsKCiAgICAgICAgICBpZiAocGVyZm9ybWFuY2Uubm93KCkgLSB0MCA+IGR0ICogMTAwMCkgewogICAgICAgICAgICAvLyBUaGUgZnJhbWVyYXRlIGlzIG5vdCBpbnRlcmFjdGl2ZSBhbnltb3JlLgogICAgICAgICAgICAvLyBXZSBhcmUgYmVsb3cgdGhlIHRhcmdldCBmcmFtZXJhdGUuCiAgICAgICAgICAgIC8vIEJldHRlciBiYWlsIG91dC4KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBSZW1vdmUgdGhlIGV4Y2VzcyBhY2N1bXVsYXRvciwgc2luY2Ugd2UgbWF5IG5vdAogICAgICAgIC8vIGhhdmUgaGFkIGVub3VnaCBzdWJzdGVwcyBhdmFpbGFibGUgdG8gY2F0Y2ggdXAKCgogICAgICAgIHRoaXMuYWNjdW11bGF0b3IgPSB0aGlzLmFjY3VtdWxhdG9yICUgZHQ7CiAgICAgICAgY29uc3QgdCA9IHRoaXMuYWNjdW11bGF0b3IgLyBkdDsKCiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogIT09IHRoaXMuYm9kaWVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBiID0gdGhpcy5ib2RpZXNbal07CiAgICAgICAgICBiLnByZXZpb3VzUG9zaXRpb24ubGVycChiLnBvc2l0aW9uLCB0LCBiLmludGVycG9sYXRlZFBvc2l0aW9uKTsKICAgICAgICAgIGIucHJldmlvdXNRdWF0ZXJuaW9uLnNsZXJwKGIucXVhdGVybmlvbiwgdCwgYi5pbnRlcnBvbGF0ZWRRdWF0ZXJuaW9uKTsKICAgICAgICAgIGIucHJldmlvdXNRdWF0ZXJuaW9uLm5vcm1hbGl6ZSgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy50aW1lICs9IHRpbWVTaW5jZUxhc3RDYWxsZWQ7CiAgICAgIH0KICAgIH0KCiAgICBpbnRlcm5hbFN0ZXAoZHQpIHsKICAgICAgdGhpcy5kdCA9IGR0OwogICAgICBjb25zdCBjb250YWN0cyA9IHRoaXMuY29udGFjdHM7CiAgICAgIGNvbnN0IHAxID0gV29ybGRfc3RlcF9wMTsKICAgICAgY29uc3QgcDIgPSBXb3JsZF9zdGVwX3AyOwogICAgICBjb25zdCBOID0gdGhpcy5ib2RpZXMubGVuZ3RoOwogICAgICBjb25zdCBib2RpZXMgPSB0aGlzLmJvZGllczsKICAgICAgY29uc3Qgc29sdmVyID0gdGhpcy5zb2x2ZXI7CiAgICAgIGNvbnN0IGdyYXZpdHkgPSB0aGlzLmdyYXZpdHk7CiAgICAgIGNvbnN0IGRvUHJvZmlsaW5nID0gdGhpcy5kb1Byb2ZpbGluZzsKICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMucHJvZmlsZTsKICAgICAgY29uc3QgRFlOQU1JQyA9IEJvZHkuRFlOQU1JQzsKICAgICAgbGV0IHByb2ZpbGluZ1N0YXJ0ID0gLUluZmluaXR5OwogICAgICBjb25zdCBjb25zdHJhaW50cyA9IHRoaXMuY29uc3RyYWludHM7CiAgICAgIGNvbnN0IGZyaWN0aW9uRXF1YXRpb25Qb29sID0gV29ybGRfc3RlcF9mcmljdGlvbkVxdWF0aW9uUG9vbDsKICAgICAgZ3Jhdml0eS5sZW5ndGgoKTsKICAgICAgY29uc3QgZ3ggPSBncmF2aXR5Lng7CiAgICAgIGNvbnN0IGd5ID0gZ3Jhdml0eS55OwogICAgICBjb25zdCBneiA9IGdyYXZpdHkuejsKICAgICAgbGV0IGkgPSAwOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsaW5nU3RhcnQgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgICAgfSAvLyBBZGQgZ3Jhdml0eSB0byBhbGwgb2JqZWN0cwoKCiAgICAgIGZvciAoaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IGJpID0gYm9kaWVzW2ldOwoKICAgICAgICBpZiAoYmkudHlwZSA9PT0gRFlOQU1JQykgewogICAgICAgICAgLy8gT25seSBmb3IgZHluYW1pYyBib2RpZXMKICAgICAgICAgIGNvbnN0IGYgPSBiaS5mb3JjZTsKICAgICAgICAgIGNvbnN0IG0gPSBiaS5tYXNzOwogICAgICAgICAgZi54ICs9IG0gKiBneDsKICAgICAgICAgIGYueSArPSBtICogZ3k7CiAgICAgICAgICBmLnogKz0gbSAqIGd6OwogICAgICAgIH0KICAgICAgfSAvLyBVcGRhdGUgc3Vic3lzdGVtcwoKCiAgICAgIGZvciAobGV0IGkgPSAwLCBOc3Vic3lzdGVtcyA9IHRoaXMuc3Vic3lzdGVtcy5sZW5ndGg7IGkgIT09IE5zdWJzeXN0ZW1zOyBpKyspIHsKICAgICAgICB0aGlzLnN1YnN5c3RlbXNbaV0udXBkYXRlKCk7CiAgICAgIH0gLy8gQ29sbGlzaW9uIGRldGVjdGlvbgoKCiAgICAgIGlmIChkb1Byb2ZpbGluZykgewogICAgICAgIHByb2ZpbGluZ1N0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIH0KCiAgICAgIHAxLmxlbmd0aCA9IDA7IC8vIENsZWFuIHVwIHBhaXIgYXJyYXlzIGZyb20gbGFzdCBzdGVwCgogICAgICBwMi5sZW5ndGggPSAwOwogICAgICB0aGlzLmJyb2FkcGhhc2UuY29sbGlzaW9uUGFpcnModGhpcywgcDEsIHAyKTsKCiAgICAgIGlmIChkb1Byb2ZpbGluZykgewogICAgICAgIHByb2ZpbGUuYnJvYWRwaGFzZSA9IHBlcmZvcm1hbmNlLm5vdygpIC0gcHJvZmlsaW5nU3RhcnQ7CiAgICAgIH0gLy8gUmVtb3ZlIGNvbnN0cmFpbmVkIHBhaXJzIHdpdGggY29sbGlkZUNvbm5lY3RlZCA9PSBmYWxzZQoKCiAgICAgIGxldCBOY29uc3RyYWludHMgPSBjb25zdHJhaW50cy5sZW5ndGg7CgogICAgICBmb3IgKGkgPSAwOyBpICE9PSBOY29uc3RyYWludHM7IGkrKykgewogICAgICAgIGNvbnN0IGMgPSBjb25zdHJhaW50c1tpXTsKCiAgICAgICAgaWYgKCFjLmNvbGxpZGVDb25uZWN0ZWQpIHsKICAgICAgICAgIGZvciAobGV0IGogPSBwMS5sZW5ndGggLSAxOyBqID49IDA7IGogLT0gMSkgewogICAgICAgICAgICBpZiAoYy5ib2R5QSA9PT0gcDFbal0gJiYgYy5ib2R5QiA9PT0gcDJbal0gfHwgYy5ib2R5QiA9PT0gcDFbal0gJiYgYy5ib2R5QSA9PT0gcDJbal0pIHsKICAgICAgICAgICAgICBwMS5zcGxpY2UoaiwgMSk7CiAgICAgICAgICAgICAgcDIuc3BsaWNlKGosIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeFRpY2soKTsgLy8gR2VuZXJhdGUgY29udGFjdHMKCiAgICAgIGlmIChkb1Byb2ZpbGluZykgewogICAgICAgIHByb2ZpbGluZ1N0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IG9sZGNvbnRhY3RzID0gV29ybGRfc3RlcF9vbGRDb250YWN0czsKICAgICAgY29uc3QgTm9sZENvbnRhY3RzID0gY29udGFjdHMubGVuZ3RoOwoKICAgICAgZm9yIChpID0gMDsgaSAhPT0gTm9sZENvbnRhY3RzOyBpKyspIHsKICAgICAgICBvbGRjb250YWN0cy5wdXNoKGNvbnRhY3RzW2ldKTsKICAgICAgfQoKICAgICAgY29udGFjdHMubGVuZ3RoID0gMDsgLy8gVHJhbnNmZXIgRnJpY3Rpb25FcXVhdGlvbiBmcm9tIGN1cnJlbnQgbGlzdCB0byB0aGUgcG9vbCBmb3IgcmV1c2UKCiAgICAgIGNvbnN0IE5vbGRGcmljdGlvbkVxdWF0aW9ucyA9IHRoaXMuZnJpY3Rpb25FcXVhdGlvbnMubGVuZ3RoOwoKICAgICAgZm9yIChpID0gMDsgaSAhPT0gTm9sZEZyaWN0aW9uRXF1YXRpb25zOyBpKyspIHsKICAgICAgICBmcmljdGlvbkVxdWF0aW9uUG9vbC5wdXNoKHRoaXMuZnJpY3Rpb25FcXVhdGlvbnNbaV0pOwogICAgICB9CgogICAgICB0aGlzLmZyaWN0aW9uRXF1YXRpb25zLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubmFycm93cGhhc2UuZ2V0Q29udGFjdHMocDEsIHAyLCB0aGlzLCBjb250YWN0cywgb2xkY29udGFjdHMsIC8vIFRvIGJlIHJldXNlZAogICAgICB0aGlzLmZyaWN0aW9uRXF1YXRpb25zLCBmcmljdGlvbkVxdWF0aW9uUG9vbCk7CgogICAgICBpZiAoZG9Qcm9maWxpbmcpIHsKICAgICAgICBwcm9maWxlLm5hcnJvd3BoYXNlID0gcGVyZm9ybWFuY2Uubm93KCkgLSBwcm9maWxpbmdTdGFydDsKICAgICAgfSAvLyBMb29wIG92ZXIgYWxsIGNvbGxpc2lvbnMKCgogICAgICBpZiAoZG9Qcm9maWxpbmcpIHsKICAgICAgICBwcm9maWxpbmdTdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9IC8vIEFkZCBhbGwgZnJpY3Rpb24gZXFzCgoKICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMuZnJpY3Rpb25FcXVhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBzb2x2ZXIuYWRkRXF1YXRpb24odGhpcy5mcmljdGlvbkVxdWF0aW9uc1tpXSk7CiAgICAgIH0KCiAgICAgIGNvbnN0IG5jb250YWN0cyA9IGNvbnRhY3RzLmxlbmd0aDsKCiAgICAgIGZvciAobGV0IGsgPSAwOyBrICE9PSBuY29udGFjdHM7IGsrKykgewogICAgICAgIC8vIEN1cnJlbnQgY29udGFjdAogICAgICAgIGNvbnN0IGMgPSBjb250YWN0c1trXTsgLy8gR2V0IGN1cnJlbnQgY29sbGlzaW9uIGluZGVjZXMKCiAgICAgICAgY29uc3QgYmkgPSBjLmJpOwogICAgICAgIGNvbnN0IGJqID0gYy5iajsKICAgICAgICBjb25zdCBzaSA9IGMuc2k7CiAgICAgICAgY29uc3Qgc2ogPSBjLnNqOyAvLyBHZXQgY29sbGlzaW9uIHByb3BlcnRpZXMKCiAgICAgICAgbGV0IGNtOwoKICAgICAgICBpZiAoYmkubWF0ZXJpYWwgJiYgYmoubWF0ZXJpYWwpIHsKICAgICAgICAgIGNtID0gdGhpcy5nZXRDb250YWN0TWF0ZXJpYWwoYmkubWF0ZXJpYWwsIGJqLm1hdGVyaWFsKSB8fCB0aGlzLmRlZmF1bHRDb250YWN0TWF0ZXJpYWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNtID0gdGhpcy5kZWZhdWx0Q29udGFjdE1hdGVyaWFsOwogICAgICAgIH0gLy8gYy5lbmFibGVkID0gYmkuY29sbGlzaW9uUmVzcG9uc2UgJiYgYmouY29sbGlzaW9uUmVzcG9uc2UgJiYgc2kuY29sbGlzaW9uUmVzcG9uc2UgJiYgc2ouY29sbGlzaW9uUmVzcG9uc2U7CgoKICAgICAgICBjbS5mcmljdGlvbjsgLy8gYy5yZXN0aXR1dGlvbiA9IGNtLnJlc3RpdHV0aW9uOwogICAgICAgIC8vIElmIGZyaWN0aW9uIG9yIHJlc3RpdHV0aW9uIHdlcmUgc3BlY2lmaWVkIGluIHRoZSBtYXRlcmlhbCwgdXNlIHRoZW0KCiAgICAgICAgaWYgKGJpLm1hdGVyaWFsICYmIGJqLm1hdGVyaWFsKSB7CiAgICAgICAgICBpZiAoYmkubWF0ZXJpYWwuZnJpY3Rpb24gPj0gMCAmJiBiai5tYXRlcmlhbC5mcmljdGlvbiA+PSAwKSB7CiAgICAgICAgICAgIGJpLm1hdGVyaWFsLmZyaWN0aW9uICogYmoubWF0ZXJpYWwuZnJpY3Rpb247CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGJpLm1hdGVyaWFsLnJlc3RpdHV0aW9uID49IDAgJiYgYmoubWF0ZXJpYWwucmVzdGl0dXRpb24gPj0gMCkgewogICAgICAgICAgICBjLnJlc3RpdHV0aW9uID0gYmkubWF0ZXJpYWwucmVzdGl0dXRpb24gKiBiai5tYXRlcmlhbC5yZXN0aXR1dGlvbjsKICAgICAgICAgIH0KICAgICAgICB9IC8vIGMuc2V0U3Bvb2tQYXJhbXMoCiAgICAgICAgLy8gICAgICAgICAgIGNtLmNvbnRhY3RFcXVhdGlvblN0aWZmbmVzcywKICAgICAgICAvLyAgICAgICAgICAgY20uY29udGFjdEVxdWF0aW9uUmVsYXhhdGlvbiwKICAgICAgICAvLyAgICAgICAgICAgZHQKICAgICAgICAvLyAgICAgICApOwoKCiAgICAgICAgc29sdmVyLmFkZEVxdWF0aW9uKGMpOyAvLyAvLyBBZGQgZnJpY3Rpb24gY29uc3RyYWludCBlcXVhdGlvbgogICAgICAgIC8vIGlmKG11ID4gMCl7CiAgICAgICAgLy8gCS8vIENyZWF0ZSAyIHRhbmdlbnQgZXF1YXRpb25zCiAgICAgICAgLy8gCWNvbnN0IG11ZyA9IG11ICogZ25vcm07CiAgICAgICAgLy8gCWNvbnN0IHJlZHVjZWRNYXNzID0gKGJpLmludk1hc3MgKyBiai5pbnZNYXNzKTsKICAgICAgICAvLyAJaWYocmVkdWNlZE1hc3MgPiAwKXsKICAgICAgICAvLyAJCXJlZHVjZWRNYXNzID0gMS9yZWR1Y2VkTWFzczsKICAgICAgICAvLyAJfQogICAgICAgIC8vIAljb25zdCBwb29sID0gZnJpY3Rpb25FcXVhdGlvblBvb2w7CiAgICAgICAgLy8gCWNvbnN0IGMxID0gcG9vbC5sZW5ndGggPyBwb29sLnBvcCgpIDogbmV3IEZyaWN0aW9uRXF1YXRpb24oYmksYmosbXVnKnJlZHVjZWRNYXNzKTsKICAgICAgICAvLyAJY29uc3QgYzIgPSBwb29sLmxlbmd0aCA/IHBvb2wucG9wKCkgOiBuZXcgRnJpY3Rpb25FcXVhdGlvbihiaSxiaixtdWcqcmVkdWNlZE1hc3MpOwogICAgICAgIC8vIAl0aGlzLmZyaWN0aW9uRXF1YXRpb25zLnB1c2goYzEsIGMyKTsKICAgICAgICAvLyAJYzEuYmkgPSBjMi5iaSA9IGJpOwogICAgICAgIC8vIAljMS5iaiA9IGMyLmJqID0gYmo7CiAgICAgICAgLy8gCWMxLm1pbkZvcmNlID0gYzIubWluRm9yY2UgPSAtbXVnKnJlZHVjZWRNYXNzOwogICAgICAgIC8vIAljMS5tYXhGb3JjZSA9IGMyLm1heEZvcmNlID0gbXVnKnJlZHVjZWRNYXNzOwogICAgICAgIC8vIAkvLyBDb3B5IG92ZXIgdGhlIHJlbGF0aXZlIHZlY3RvcnMKICAgICAgICAvLyAJYzEucmkuY29weShjLnJpKTsKICAgICAgICAvLyAJYzEucmouY29weShjLnJqKTsKICAgICAgICAvLyAJYzIucmkuY29weShjLnJpKTsKICAgICAgICAvLyAJYzIucmouY29weShjLnJqKTsKICAgICAgICAvLyAJLy8gQ29uc3RydWN0IHRhbmdlbnRzCiAgICAgICAgLy8gCWMubmkudGFuZ2VudHMoYzEudCwgYzIudCk7CiAgICAgICAgLy8gICAgICAgICAgIC8vIFNldCBzcG9vayBwYXJhbXMKICAgICAgICAvLyAgICAgICAgICAgYzEuc2V0U3Bvb2tQYXJhbXMoY20uZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcywgY20uZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb24sIGR0KTsKICAgICAgICAvLyAgICAgICAgICAgYzIuc2V0U3Bvb2tQYXJhbXMoY20uZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcywgY20uZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb24sIGR0KTsKICAgICAgICAvLyAgICAgICAgICAgYzEuZW5hYmxlZCA9IGMyLmVuYWJsZWQgPSBjLmVuYWJsZWQ7CiAgICAgICAgLy8gCS8vIEFkZCBlcXVhdGlvbnMgdG8gc29sdmVyCiAgICAgICAgLy8gCXNvbHZlci5hZGRFcXVhdGlvbihjMSk7CiAgICAgICAgLy8gCXNvbHZlci5hZGRFcXVhdGlvbihjMik7CiAgICAgICAgLy8gfQoKICAgICAgICBpZiAoYmkuYWxsb3dTbGVlcCAmJiBiaS50eXBlID09PSBCb2R5LkRZTkFNSUMgJiYgYmkuc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUElORyAmJiBiai5zbGVlcFN0YXRlID09PSBCb2R5LkFXQUtFICYmIGJqLnR5cGUgIT09IEJvZHkuU1RBVElDKSB7CiAgICAgICAgICBjb25zdCBzcGVlZFNxdWFyZWRCID0gYmoudmVsb2NpdHkubGVuZ3RoU3F1YXJlZCgpICsgYmouYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxdWFyZWQoKTsKICAgICAgICAgIGNvbnN0IHNwZWVkTGltaXRTcXVhcmVkQiA9IGJqLnNsZWVwU3BlZWRMaW1pdCAqKiAyOwoKICAgICAgICAgIGlmIChzcGVlZFNxdWFyZWRCID49IHNwZWVkTGltaXRTcXVhcmVkQiAqIDIpIHsKICAgICAgICAgICAgYmkud2FrZVVwQWZ0ZXJOYXJyb3dwaGFzZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYmouYWxsb3dTbGVlcCAmJiBiai50eXBlID09PSBCb2R5LkRZTkFNSUMgJiYgYmouc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUElORyAmJiBiaS5zbGVlcFN0YXRlID09PSBCb2R5LkFXQUtFICYmIGJpLnR5cGUgIT09IEJvZHkuU1RBVElDKSB7CiAgICAgICAgICBjb25zdCBzcGVlZFNxdWFyZWRBID0gYmkudmVsb2NpdHkubGVuZ3RoU3F1YXJlZCgpICsgYmkuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxdWFyZWQoKTsKICAgICAgICAgIGNvbnN0IHNwZWVkTGltaXRTcXVhcmVkQSA9IGJpLnNsZWVwU3BlZWRMaW1pdCAqKiAyOwoKICAgICAgICAgIGlmIChzcGVlZFNxdWFyZWRBID49IHNwZWVkTGltaXRTcXVhcmVkQSAqIDIpIHsKICAgICAgICAgICAgYmoud2FrZVVwQWZ0ZXJOYXJyb3dwaGFzZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBOb3cgd2Uga25vdyB0aGF0IGkgYW5kIGogYXJlIGluIGNvbnRhY3QuIFNldCBjb2xsaXNpb24gbWF0cml4IHN0YXRlCgoKICAgICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeC5zZXQoYmksIGJqLCB0cnVlKTsKCiAgICAgICAgaWYgKCF0aGlzLmNvbGxpc2lvbk1hdHJpeFByZXZpb3VzLmdldChiaSwgYmopKSB7CiAgICAgICAgICAvLyBGaXJzdCBjb250YWN0IQogICAgICAgICAgLy8gV2UgcmV1c2UgdGhlIGNvbGxpZGVFdmVudCBvYmplY3QsIG90aGVyd2lzZSB3ZSB3aWxsIGVuZCB1cCBjcmVhdGluZyBuZXcgb2JqZWN0cyBmb3IgZWFjaCBuZXcgY29udGFjdCwgZXZlbiBpZiB0aGVyZSdzIG5vIGV2ZW50IGxpc3RlbmVyIGF0dGFjaGVkLgogICAgICAgICAgV29ybGRfc3RlcF9jb2xsaWRlRXZlbnQuYm9keSA9IGJqOwogICAgICAgICAgV29ybGRfc3RlcF9jb2xsaWRlRXZlbnQuY29udGFjdCA9IGM7CiAgICAgICAgICBiaS5kaXNwYXRjaEV2ZW50KFdvcmxkX3N0ZXBfY29sbGlkZUV2ZW50KTsKICAgICAgICAgIFdvcmxkX3N0ZXBfY29sbGlkZUV2ZW50LmJvZHkgPSBiaTsKICAgICAgICAgIGJqLmRpc3BhdGNoRXZlbnQoV29ybGRfc3RlcF9jb2xsaWRlRXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5ib2R5T3ZlcmxhcEtlZXBlci5zZXQoYmkuaWQsIGJqLmlkKTsKICAgICAgICB0aGlzLnNoYXBlT3ZlcmxhcEtlZXBlci5zZXQoc2kuaWQsIHNqLmlkKTsKICAgICAgfQoKICAgICAgdGhpcy5lbWl0Q29udGFjdEV2ZW50cygpOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsZS5tYWtlQ29udGFjdENvbnN0cmFpbnRzID0gcGVyZm9ybWFuY2Uubm93KCkgLSBwcm9maWxpbmdTdGFydDsKICAgICAgICBwcm9maWxpbmdTdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9IC8vIFdha2UgdXAgYm9kaWVzCgoKICAgICAgZm9yIChpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgY29uc3QgYmkgPSBib2RpZXNbaV07CgogICAgICAgIGlmIChiaS53YWtlVXBBZnRlck5hcnJvd3BoYXNlKSB7CiAgICAgICAgICBiaS53YWtlVXAoKTsKICAgICAgICAgIGJpLndha2VVcEFmdGVyTmFycm93cGhhc2UgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0gLy8gQWRkIHVzZXItYWRkZWQgY29uc3RyYWludHMKCgogICAgICBOY29uc3RyYWludHMgPSBjb25zdHJhaW50cy5sZW5ndGg7CgogICAgICBmb3IgKGkgPSAwOyBpICE9PSBOY29uc3RyYWludHM7IGkrKykgewogICAgICAgIGNvbnN0IGMgPSBjb25zdHJhaW50c1tpXTsKICAgICAgICBjLnVwZGF0ZSgpOwoKICAgICAgICBmb3IgKGxldCBqID0gMCwgTmVxID0gYy5lcXVhdGlvbnMubGVuZ3RoOyBqICE9PSBOZXE7IGorKykgewogICAgICAgICAgY29uc3QgZXEgPSBjLmVxdWF0aW9uc1tqXTsKICAgICAgICAgIHNvbHZlci5hZGRFcXVhdGlvbihlcSk7CiAgICAgICAgfQogICAgICB9IC8vIFNvbHZlIHRoZSBjb25zdHJhaW5lZCBzeXN0ZW0KCgogICAgICBzb2x2ZXIuc29sdmUoZHQsIHRoaXMpOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsZS5zb2x2ZSA9IHBlcmZvcm1hbmNlLm5vdygpIC0gcHJvZmlsaW5nU3RhcnQ7CiAgICAgIH0gLy8gUmVtb3ZlIGFsbCBjb250YWN0cyBmcm9tIHNvbHZlcgoKCiAgICAgIHNvbHZlci5yZW1vdmVBbGxFcXVhdGlvbnMoKTsgLy8gQXBwbHkgZGFtcGluZywgc2VlIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC9idWxsZXQvaXNzdWVzL2RldGFpbD9pZD03NCBmb3IgZGV0YWlscwoKICAgICAgY29uc3QgcG93ID0gTWF0aC5wb3c7CgogICAgICBmb3IgKGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBjb25zdCBiaSA9IGJvZGllc1tpXTsKCiAgICAgICAgaWYgKGJpLnR5cGUgJiBEWU5BTUlDKSB7CiAgICAgICAgICAvLyBPbmx5IGZvciBkeW5hbWljIGJvZGllcwogICAgICAgICAgY29uc3QgbGQgPSBwb3coMS4wIC0gYmkubGluZWFyRGFtcGluZywgZHQpOwogICAgICAgICAgY29uc3QgdiA9IGJpLnZlbG9jaXR5OwogICAgICAgICAgdi5zY2FsZShsZCwgdik7CiAgICAgICAgICBjb25zdCBhdiA9IGJpLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgICBpZiAoYXYpIHsKICAgICAgICAgICAgY29uc3QgYWQgPSBwb3coMS4wIC0gYmkuYW5ndWxhckRhbXBpbmcsIGR0KTsKICAgICAgICAgICAgYXYuc2NhbGUoYWQsIGF2KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChXb3JsZF9zdGVwX3ByZVN0ZXBFdmVudCk7IC8vIExlYXAgZnJvZwogICAgICAvLyB2bmV3ID0gdiArIGgqZi9tCiAgICAgIC8vIHhuZXcgPSB4ICsgaCp2bmV3CgogICAgICBpZiAoZG9Qcm9maWxpbmcpIHsKICAgICAgICBwcm9maWxpbmdTdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9CgogICAgICBjb25zdCBzdGVwbnVtYmVyID0gdGhpcy5zdGVwbnVtYmVyOwogICAgICBjb25zdCBxdWF0Tm9ybWFsaXplID0gc3RlcG51bWJlciAlICh0aGlzLnF1YXROb3JtYWxpemVTa2lwICsgMSkgPT09IDA7CiAgICAgIGNvbnN0IHF1YXROb3JtYWxpemVGYXN0ID0gdGhpcy5xdWF0Tm9ybWFsaXplRmFzdDsKCiAgICAgIGZvciAoaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGJvZGllc1tpXS5pbnRlZ3JhdGUoZHQsIHF1YXROb3JtYWxpemUsIHF1YXROb3JtYWxpemVGYXN0KTsKICAgICAgfQoKICAgICAgdGhpcy5jbGVhckZvcmNlcygpOwogICAgICB0aGlzLmJyb2FkcGhhc2UuZGlydHkgPSB0cnVlOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsZS5pbnRlZ3JhdGUgPSBwZXJmb3JtYW5jZS5ub3coKSAtIHByb2ZpbGluZ1N0YXJ0OwogICAgICB9IC8vIFVwZGF0ZSBzdGVwIG51bWJlcgoKCiAgICAgIHRoaXMuc3RlcG51bWJlciArPSAxOwogICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoV29ybGRfc3RlcF9wb3N0U3RlcEV2ZW50KTsgLy8gU2xlZXBpbmcgdXBkYXRlCgogICAgICBsZXQgaGFzQWN0aXZlQm9kaWVzID0gdHJ1ZTsKCiAgICAgIGlmICh0aGlzLmFsbG93U2xlZXApIHsKICAgICAgICBoYXNBY3RpdmVCb2RpZXMgPSBmYWxzZTsKCiAgICAgICAgZm9yIChpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBiaSA9IGJvZGllc1tpXTsKICAgICAgICAgIGJpLnNsZWVwVGljayh0aGlzLnRpbWUpOwoKICAgICAgICAgIGlmIChiaS5zbGVlcFN0YXRlICE9PSBCb2R5LlNMRUVQSU5HKSB7CiAgICAgICAgICAgIGhhc0FjdGl2ZUJvZGllcyA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmhhc0FjdGl2ZUJvZGllcyA9IGhhc0FjdGl2ZUJvZGllczsKICAgIH0KCiAgICBlbWl0Q29udGFjdEV2ZW50cygpIHsKICAgICAgY29uc3QgaGFzQmVnaW5Db250YWN0ID0gdGhpcy5oYXNBbnlFdmVudExpc3RlbmVyKCdiZWdpbkNvbnRhY3QnKTsKICAgICAgY29uc3QgaGFzRW5kQ29udGFjdCA9IHRoaXMuaGFzQW55RXZlbnRMaXN0ZW5lcignZW5kQ29udGFjdCcpOwoKICAgICAgaWYgKGhhc0JlZ2luQ29udGFjdCB8fCBoYXNFbmRDb250YWN0KSB7CiAgICAgICAgdGhpcy5ib2R5T3ZlcmxhcEtlZXBlci5nZXREaWZmKGFkZGl0aW9ucywgcmVtb3ZhbHMpOwogICAgICB9CgogICAgICBpZiAoaGFzQmVnaW5Db250YWN0KSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBhZGRpdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSArPSAyKSB7CiAgICAgICAgICBiZWdpbkNvbnRhY3RFdmVudC5ib2R5QSA9IHRoaXMuZ2V0Qm9keUJ5SWQoYWRkaXRpb25zW2ldKTsKICAgICAgICAgIGJlZ2luQ29udGFjdEV2ZW50LmJvZHlCID0gdGhpcy5nZXRCb2R5QnlJZChhZGRpdGlvbnNbaSArIDFdKTsKICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChiZWdpbkNvbnRhY3RFdmVudCk7CiAgICAgICAgfQoKICAgICAgICBiZWdpbkNvbnRhY3RFdmVudC5ib2R5QSA9IGJlZ2luQ29udGFjdEV2ZW50LmJvZHlCID0gbnVsbDsKICAgICAgfQoKICAgICAgaWYgKGhhc0VuZENvbnRhY3QpIHsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHJlbW92YWxzLmxlbmd0aDsgaSA8IGw7IGkgKz0gMikgewogICAgICAgICAgZW5kQ29udGFjdEV2ZW50LmJvZHlBID0gdGhpcy5nZXRCb2R5QnlJZChyZW1vdmFsc1tpXSk7CiAgICAgICAgICBlbmRDb250YWN0RXZlbnQuYm9keUIgPSB0aGlzLmdldEJvZHlCeUlkKHJlbW92YWxzW2kgKyAxXSk7CiAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoZW5kQ29udGFjdEV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGVuZENvbnRhY3RFdmVudC5ib2R5QSA9IGVuZENvbnRhY3RFdmVudC5ib2R5QiA9IG51bGw7CiAgICAgIH0KCiAgICAgIGFkZGl0aW9ucy5sZW5ndGggPSByZW1vdmFscy5sZW5ndGggPSAwOwogICAgICBjb25zdCBoYXNCZWdpblNoYXBlQ29udGFjdCA9IHRoaXMuaGFzQW55RXZlbnRMaXN0ZW5lcignYmVnaW5TaGFwZUNvbnRhY3QnKTsKICAgICAgY29uc3QgaGFzRW5kU2hhcGVDb250YWN0ID0gdGhpcy5oYXNBbnlFdmVudExpc3RlbmVyKCdlbmRTaGFwZUNvbnRhY3QnKTsKCiAgICAgIGlmIChoYXNCZWdpblNoYXBlQ29udGFjdCB8fCBoYXNFbmRTaGFwZUNvbnRhY3QpIHsKICAgICAgICB0aGlzLnNoYXBlT3ZlcmxhcEtlZXBlci5nZXREaWZmKGFkZGl0aW9ucywgcmVtb3ZhbHMpOwogICAgICB9CgogICAgICBpZiAoaGFzQmVnaW5TaGFwZUNvbnRhY3QpIHsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGFkZGl0aW9ucy5sZW5ndGg7IGkgPCBsOyBpICs9IDIpIHsKICAgICAgICAgIGNvbnN0IHNoYXBlQSA9IHRoaXMuZ2V0U2hhcGVCeUlkKGFkZGl0aW9uc1tpXSk7CiAgICAgICAgICBjb25zdCBzaGFwZUIgPSB0aGlzLmdldFNoYXBlQnlJZChhZGRpdGlvbnNbaSArIDFdKTsKICAgICAgICAgIGJlZ2luU2hhcGVDb250YWN0RXZlbnQuc2hhcGVBID0gc2hhcGVBOwogICAgICAgICAgYmVnaW5TaGFwZUNvbnRhY3RFdmVudC5zaGFwZUIgPSBzaGFwZUI7CiAgICAgICAgICBpZiAoc2hhcGVBKSBiZWdpblNoYXBlQ29udGFjdEV2ZW50LmJvZHlBID0gc2hhcGVBLmJvZHk7CiAgICAgICAgICBpZiAoc2hhcGVCKSBiZWdpblNoYXBlQ29udGFjdEV2ZW50LmJvZHlCID0gc2hhcGVCLmJvZHk7CiAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoYmVnaW5TaGFwZUNvbnRhY3RFdmVudCk7CiAgICAgICAgfQoKICAgICAgICBiZWdpblNoYXBlQ29udGFjdEV2ZW50LmJvZHlBID0gYmVnaW5TaGFwZUNvbnRhY3RFdmVudC5ib2R5QiA9IGJlZ2luU2hhcGVDb250YWN0RXZlbnQuc2hhcGVBID0gYmVnaW5TaGFwZUNvbnRhY3RFdmVudC5zaGFwZUIgPSBudWxsOwogICAgICB9CgogICAgICBpZiAoaGFzRW5kU2hhcGVDb250YWN0KSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSByZW1vdmFscy5sZW5ndGg7IGkgPCBsOyBpICs9IDIpIHsKICAgICAgICAgIGNvbnN0IHNoYXBlQSA9IHRoaXMuZ2V0U2hhcGVCeUlkKHJlbW92YWxzW2ldKTsKICAgICAgICAgIGNvbnN0IHNoYXBlQiA9IHRoaXMuZ2V0U2hhcGVCeUlkKHJlbW92YWxzW2kgKyAxXSk7CiAgICAgICAgICBlbmRTaGFwZUNvbnRhY3RFdmVudC5zaGFwZUEgPSBzaGFwZUE7CiAgICAgICAgICBlbmRTaGFwZUNvbnRhY3RFdmVudC5zaGFwZUIgPSBzaGFwZUI7CiAgICAgICAgICBpZiAoc2hhcGVBKSBlbmRTaGFwZUNvbnRhY3RFdmVudC5ib2R5QSA9IHNoYXBlQS5ib2R5OwogICAgICAgICAgaWYgKHNoYXBlQikgZW5kU2hhcGVDb250YWN0RXZlbnQuYm9keUIgPSBzaGFwZUIuYm9keTsKICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChlbmRTaGFwZUNvbnRhY3RFdmVudCk7CiAgICAgICAgfQoKICAgICAgICBlbmRTaGFwZUNvbnRhY3RFdmVudC5ib2R5QSA9IGVuZFNoYXBlQ29udGFjdEV2ZW50LmJvZHlCID0gZW5kU2hhcGVDb250YWN0RXZlbnQuc2hhcGVBID0gZW5kU2hhcGVDb250YWN0RXZlbnQuc2hhcGVCID0gbnVsbDsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIGFsbCBib2R5IGZvcmNlcyBpbiB0aGUgd29ybGQgdG8gemVyby4KICAgICAqLwoKCiAgICBjbGVhckZvcmNlcygpIHsKICAgICAgY29uc3QgYm9kaWVzID0gdGhpcy5ib2RpZXM7CiAgICAgIGNvbnN0IE4gPSBib2RpZXMubGVuZ3RoOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IGIgPSBib2RpZXNbaV07CiAgICAgICAgYi5mb3JjZTsKICAgICAgICBiLnRvcnF1ZTsKICAgICAgICBiLmZvcmNlLnNldCgwLCAwLCAwKTsKICAgICAgICBiLnRvcnF1ZS5zZXQoMCwgMCwgMCk7CiAgICAgIH0KICAgIH0KCiAgfSAvLyBUZW1wIHN0dWZmCgogIG5ldyBBQUJCKCk7CiAgY29uc3QgdG1wUmF5ID0gbmV3IFJheSgpOyAvLyBwZXJmb3JtYW5jZS5ub3coKSBmYWxsYmFjayBvbiBEYXRlLm5vdygpCgogIGNvbnN0IHBlcmZvcm1hbmNlID0gZ2xvYmFsVGhpcy5wZXJmb3JtYW5jZSB8fCB7fTsKCiAgaWYgKCFwZXJmb3JtYW5jZS5ub3cpIHsKICAgIGxldCBub3dPZmZzZXQgPSBEYXRlLm5vdygpOwoKICAgIGlmIChwZXJmb3JtYW5jZS50aW1pbmcgJiYgcGVyZm9ybWFuY2UudGltaW5nLm5hdmlnYXRpb25TdGFydCkgewogICAgICBub3dPZmZzZXQgPSBwZXJmb3JtYW5jZS50aW1pbmcubmF2aWdhdGlvblN0YXJ0OwogICAgfQoKICAgIHBlcmZvcm1hbmNlLm5vdyA9ICgpID0+IERhdGUubm93KCkgLSBub3dPZmZzZXQ7CiAgfQoKICBuZXcgVmVjMygpOyAvLyBEaXNwYXRjaGVkIGFmdGVyIHRoZSB3b3JsZCBoYXMgc3RlcHBlZCBmb3J3YXJkIGluIHRpbWUuCiAgLy8gUmV1c2FibGUgZXZlbnQgb2JqZWN0cyB0byBzYXZlIG1lbW9yeS4KCiAgY29uc3QgV29ybGRfc3RlcF9wb3N0U3RlcEV2ZW50ID0gewogICAgdHlwZTogJ3Bvc3RTdGVwJwogIH07IC8vIERpc3BhdGNoZWQgYmVmb3JlIHRoZSB3b3JsZCBzdGVwcyBmb3J3YXJkIGluIHRpbWUuCgogIGNvbnN0IFdvcmxkX3N0ZXBfcHJlU3RlcEV2ZW50ID0gewogICAgdHlwZTogJ3ByZVN0ZXAnCiAgfTsKICBjb25zdCBXb3JsZF9zdGVwX2NvbGxpZGVFdmVudCA9IHsKICAgIHR5cGU6IEJvZHkuQ09MTElERV9FVkVOVF9OQU1FLAogICAgYm9keTogbnVsbCwKICAgIGNvbnRhY3Q6IG51bGwKICB9OyAvLyBQb29scyBmb3IgdW51c2VkIG9iamVjdHMKCiAgY29uc3QgV29ybGRfc3RlcF9vbGRDb250YWN0cyA9IFtdOwogIGNvbnN0IFdvcmxkX3N0ZXBfZnJpY3Rpb25FcXVhdGlvblBvb2wgPSBbXTsgLy8gUmV1c2FibGUgYXJyYXlzIGZvciBjb2xsaXNpb24gcGFpcnMKCiAgY29uc3QgV29ybGRfc3RlcF9wMSA9IFtdOwogIGNvbnN0IFdvcmxkX3N0ZXBfcDIgPSBbXTsgLy8gU3R1ZmYgZm9yIGVtaXRDb250YWN0RXZlbnRzCgogIGNvbnN0IGFkZGl0aW9ucyA9IFtdOwogIGNvbnN0IHJlbW92YWxzID0gW107CiAgY29uc3QgYmVnaW5Db250YWN0RXZlbnQgPSB7CiAgICB0eXBlOiAnYmVnaW5Db250YWN0JywKICAgIGJvZHlBOiBudWxsLAogICAgYm9keUI6IG51bGwKICB9OwogIGNvbnN0IGVuZENvbnRhY3RFdmVudCA9IHsKICAgIHR5cGU6ICdlbmRDb250YWN0JywKICAgIGJvZHlBOiBudWxsLAogICAgYm9keUI6IG51bGwKICB9OwogIGNvbnN0IGJlZ2luU2hhcGVDb250YWN0RXZlbnQgPSB7CiAgICB0eXBlOiAnYmVnaW5TaGFwZUNvbnRhY3QnLAogICAgYm9keUE6IG51bGwsCiAgICBib2R5QjogbnVsbCwKICAgIHNoYXBlQTogbnVsbCwKICAgIHNoYXBlQjogbnVsbAogIH07CiAgY29uc3QgZW5kU2hhcGVDb250YWN0RXZlbnQgPSB7CiAgICB0eXBlOiAnZW5kU2hhcGVDb250YWN0JywKICAgIGJvZHlBOiBudWxsLAogICAgYm9keUI6IG51bGwsCiAgICBzaGFwZUE6IG51bGwsCiAgICBzaGFwZUI6IG51bGwKICB9OwoKICBjb25zdCBhZGRDb250YWN0TWF0ZXJpYWwgPSAod29ybGQsIGNyZWF0ZU1hdGVyaWFsLCBfcmVmLCB1dWlkKSA9PiB7CiAgICBsZXQgW21hdGVyaWFsQSwgbWF0ZXJpYWxCLCBvcHRpb25zXSA9IF9yZWY7CiAgICBjb25zdCBtYXRBID0gY3JlYXRlTWF0ZXJpYWwobWF0ZXJpYWxBKTsKICAgIGNvbnN0IG1hdEIgPSBjcmVhdGVNYXRlcmlhbChtYXRlcmlhbEIpOwogICAgY29uc3QgY29udGFjdE1hdGVyaWFsID0gbmV3IENvbnRhY3RNYXRlcmlhbChtYXRBLCBtYXRCLCBvcHRpb25zKTsKICAgIGNvbnRhY3RNYXRlcmlhbC51dWlkID0gdXVpZDsKICAgIHdvcmxkLmFkZENvbnRhY3RNYXRlcmlhbChjb250YWN0TWF0ZXJpYWwpOwogIH07CiAgY29uc3QgcmVtb3ZlQ29udGFjdE1hdGVyaWFsID0gKHdvcmxkLCBjbVVVSUQpID0+IHsKICAgIGNvbnN0IGluZGV4ID0gd29ybGQuY29udGFjdG1hdGVyaWFscy5maW5kSW5kZXgoX3JlZjIgPT4gewogICAgICBsZXQgewogICAgICAgIHV1aWQKICAgICAgfSA9IF9yZWYyOwogICAgICByZXR1cm4gdXVpZCA9PT0gY21VVUlEOwogICAgfSk7CiAgICBjb25zdCBbewogICAgICBpZDogaQogICAgfSwgewogICAgICBpZDogagogICAgfV0gPSB3b3JsZC5jb250YWN0bWF0ZXJpYWxzW2luZGV4XS5tYXRlcmlhbHM7CiAgICB3b3JsZC5jb250YWN0bWF0ZXJpYWxzLnNwbGljZShpbmRleCwgMSk7CiAgICBkZWxldGUgd29ybGQuY29udGFjdE1hdGVyaWFsVGFibGUuZGF0YVtpIDwgaiA/IGAke2l9LSR7an1gIDogYCR7an0tJHtpfWBdOwogIH07CgogIGxldCBtYXRlcmlhbElkID0gMDsKICBjb25zdCBjcmVhdGVNYXRlcmlhbEZhY3RvcnkgPSBtYXRlcmlhbHMgPT4gZnVuY3Rpb24gKG5hbWVPck9wdGlvbnMpIHsKICAgIGlmIChuYW1lT3JPcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgbmFtZU9yT3B0aW9ucyA9IHt9OwogICAgfQogICAgY29uc3QgbWF0ZXJpYWxPcHRpb25zID0gdHlwZW9mIG5hbWVPck9wdGlvbnMgPT09ICdzdHJpbmcnID8gewogICAgICBuYW1lOiBuYW1lT3JPcHRpb25zCiAgICB9IDogewogICAgICBuYW1lOiBTeW1ib2wuZm9yKGBNYXRlcmlhbCR7bWF0ZXJpYWxJZCsrfWApLAogICAgICAuLi5uYW1lT3JPcHRpb25zCiAgICB9OwogICAgY29uc3QgewogICAgICBuYW1lCiAgICB9ID0gbWF0ZXJpYWxPcHRpb25zOwogICAgbWF0ZXJpYWxzW25hbWVdID0gbWF0ZXJpYWxzW25hbWVdIHx8IG5ldyBNYXRlcmlhbChtYXRlcmlhbE9wdGlvbnMpOwogICAgcmV0dXJuIG1hdGVyaWFsc1tuYW1lXTsKICB9OwoKICAvKioKICAgKiBAdHlwZWRlZiB7IGltcG9ydCgnY2Fubm9uLWVzJykuTWF0ZXJpYWxPcHRpb25zIH0gTWF0ZXJpYWxPcHRpb25zCiAgICovCgogIGNvbnN0IG1ha2VWZWMzID0gX3JlZiA9PiB7CiAgICBsZXQgW3gsIHksIHpdID0gX3JlZjsKICAgIHJldHVybiBuZXcgVmVjMyh4LCB5LCB6KTsKICB9OwogIGNvbnN0IHByZXBhcmVTcGhlcmUgPSBhcmdzID0+IEFycmF5LmlzQXJyYXkoYXJncykgPyBhcmdzIDogW2FyZ3NdOwogIGNvbnN0IHByZXBhcmVDb252ZXhQb2x5aGVkcm9uID0gX3JlZjIgPT4gewogICAgbGV0IFt2LCBmYWNlcywgbiwgYSwgYm91bmRpbmdTcGhlcmVSYWRpdXNdID0gX3JlZjI7CiAgICByZXR1cm4gW3sKICAgICAgYXhlczogYSA/IGEubWFwKG1ha2VWZWMzKSA6IHVuZGVmaW5lZCwKICAgICAgYm91bmRpbmdTcGhlcmVSYWRpdXMsCiAgICAgIGZhY2VzLAogICAgICBub3JtYWxzOiBuID8gbi5tYXAobWFrZVZlYzMpIDogdW5kZWZpbmVkLAogICAgICB2ZXJ0aWNlczogdiA/IHYubWFwKG1ha2VWZWMzKSA6IHVuZGVmaW5lZAogICAgfV07CiAgfTsKICBmdW5jdGlvbiBjcmVhdGVTaGFwZSh0eXBlLCBhcmdzKSB7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSAnQm94JzoKICAgICAgICByZXR1cm4gbmV3IEJveChuZXcgVmVjMyguLi5hcmdzLm1hcCh2ID0+IHYgLyAyKSkpOwogICAgICAvLyBleHRlbnRzID0+IGhhbGZFeHRlbnRzCiAgICAgIGNhc2UgJ0NvbnZleFBvbHloZWRyb24nOgogICAgICAgIHJldHVybiBuZXcgQ29udmV4UG9seWhlZHJvbiguLi5wcmVwYXJlQ29udmV4UG9seWhlZHJvbihhcmdzKSk7CiAgICAgIGNhc2UgJ0N5bGluZGVyJzoKICAgICAgICByZXR1cm4gbmV3IEN5bGluZGVyKC4uLmFyZ3MpOwogICAgICAvLyBbIHJhZGl1c1RvcCwgcmFkaXVzQm90dG9tLCBoZWlnaHQsIG51bVNlZ21lbnRzIF0gPSBhcmdzCiAgICAgIGNhc2UgJ0hlaWdodGZpZWxkJzoKICAgICAgICByZXR1cm4gbmV3IEhlaWdodGZpZWxkKC4uLmFyZ3MpOwogICAgICAvLyBbIEFycmF5IGRhdGEsIG9wdGlvbnM6IHttaW5WYWx1ZSwgbWF4VmFsdWUsIGVsZW1lbnRTaXplfSAgXSA9IGFyZ3MKICAgICAgY2FzZSAnUGFydGljbGUnOgogICAgICAgIHJldHVybiBuZXcgUGFydGljbGUoKTsKICAgICAgLy8gbm8gYXJncwogICAgICBjYXNlICdQbGFuZSc6CiAgICAgICAgcmV0dXJuIG5ldyBQbGFuZSgpOwogICAgICAvLyBubyBhcmdzLCBpbmZpbml0ZSB4IGFuZCB5CiAgICAgIGNhc2UgJ1NwaGVyZSc6CiAgICAgICAgcmV0dXJuIG5ldyBTcGhlcmUoLi4ucHJlcGFyZVNwaGVyZShhcmdzKSk7CiAgICAgIC8vIHJhZGl1cyA9IGFyZ3MKICAgICAgY2FzZSAnVHJpbWVzaCc6CiAgICAgICAgcmV0dXJuIG5ldyBUcmltZXNoKC4uLmFyZ3MpOwogICAgICAvLyBbdmVydGljZXMsIGluZGljZXNdID0gYXJncwogICAgfQogIH0KCiAgLyoqCiAgICogQHBhcmFtIHtUSFJFRS5RdWF0ZXJuaW9ufSB0YXJnZXQKICAgKiBAcGFyYW0ge3sgcm90YXRpb24/OiBUSFJFRS5WZWN0b3IzVHVwbGUgcXVhdGVybmlvbj86IFRIUkVFLlZlY3RvcjRUdXBsZSB9fSBwcm9wcwogICAqIEByZXR1cm5zIHtUSFJFRS5RdWF0ZXJuaW9ufQogICAqLwogIGNvbnN0IHNldFF1YXRlcm5pb24gPSAodGFyZ2V0LCBfcmVmMykgPT4gewogICAgbGV0IHsKICAgICAgcXVhdGVybmlvbiwKICAgICAgcm90YXRpb24KICAgIH0gPSBfcmVmMzsKICAgIGlmIChxdWF0ZXJuaW9uKSB7CiAgICAgIHRhcmdldC5zZXQoLi4ucXVhdGVybmlvbik7CiAgICB9IGVsc2UgaWYgKHJvdGF0aW9uKSB7CiAgICAgIHRhcmdldC5zZXRGcm9tRXVsZXIoLi4ucm90YXRpb24pOwogICAgfQogICAgcmV0dXJuIHRhcmdldDsKICB9OwoKICAvKioKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLnV1aWQKICAgKiBAcGFyYW0ge0JvZHlQcm9wc30gb3B0aW9ucy5wcm9wcwogICAqIEBwYXJhbSB7Qm9keVNoYXBlVHlwZX0gb3B0aW9ucy50eXBlCiAgICogQHBhcmFtIHsobWF0ZXJpYWxPcHRpb25zOiBNYXRlcmlhbE9wdGlvbnMpID0+IE1hdGVyaWFsID19IG9wdGlvbnMuY3JlYXRlTWF0ZXJpYWwKICAgKiBAcmV0dXJucyB7Qm9keX0KICAgKi8KICBjb25zdCBwcm9wc1RvQm9keSA9IG9wdGlvbnMgPT4gewogICAgY29uc3QgewogICAgICB1dWlkLAogICAgICBwcm9wcywKICAgICAgdHlwZSwKICAgICAgY3JlYXRlTWF0ZXJpYWwgPSBtYXRlcmlhbE9wdGlvbnMgPT4gbmV3IE1hdGVyaWFsKG1hdGVyaWFsT3B0aW9ucykKICAgIH0gPSBvcHRpb25zOwogICAgY29uc3QgewogICAgICBhbmd1bGFyRmFjdG9yID0gWzEsIDEsIDFdLAogICAgICBhbmd1bGFyVmVsb2NpdHkgPSBbMCwgMCwgMF0sCiAgICAgIGFyZ3MgPSBbXSwKICAgICAgY29sbGlzaW9uUmVzcG9uc2UsCiAgICAgIGxpbmVhckZhY3RvciA9IFsxLCAxLCAxXSwKICAgICAgbWFzcywKICAgICAgbWF0ZXJpYWwsCiAgICAgIG9uQ29sbGlkZSwKICAgICAgcG9zaXRpb24gPSBbMCwgMCwgMF0sCiAgICAgIHJvdGF0aW9uLAogICAgICBxdWF0ZXJuaW9uLAogICAgICBzaGFwZXMsCiAgICAgIHR5cGU6IGJvZHlUeXBlLAogICAgICB2ZWxvY2l0eSA9IFswLCAwLCAwXSwKICAgICAgLi4uZXh0cmEKICAgIH0gPSBwcm9wczsKICAgIGNvbnN0IGJvZHkgPSBuZXcgQm9keSh7CiAgICAgIC4uLmV4dHJhLAogICAgICBtYXNzOiBib2R5VHlwZSA9PT0gJ1N0YXRpYycgPyAwIDogbWFzcywKICAgICAgbWF0ZXJpYWw6IG1hdGVyaWFsID8gY3JlYXRlTWF0ZXJpYWwobWF0ZXJpYWwpIDogdW5kZWZpbmVkLAogICAgICB0eXBlOiBib2R5VHlwZSA/IEJvZHlbYm9keVR5cGUudG9VcHBlckNhc2UoKV0gOiB1bmRlZmluZWQKICAgIH0pOwogICAgYm9keS51dWlkID0gdXVpZDsKICAgIGlmIChjb2xsaXNpb25SZXNwb25zZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGJvZHkuY29sbGlzaW9uUmVzcG9uc2UgPSBjb2xsaXNpb25SZXNwb25zZTsKICAgIH0KICAgIGlmICh0eXBlID09PSAnQ29tcG91bmQnKSB7CiAgICAgIHNoYXBlcy5mb3JFYWNoKF9yZWY0ID0+IHsKICAgICAgICBsZXQgewogICAgICAgICAgdHlwZSwKICAgICAgICAgIGFyZ3MsCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgcXVhdGVybmlvbiwKICAgICAgICAgIG1hdGVyaWFsLAogICAgICAgICAgLi4uZXh0cmEKICAgICAgICB9ID0gX3JlZjQ7CiAgICAgICAgY29uc3Qgc2hhcGVCb2R5ID0gYm9keS5hZGRTaGFwZShjcmVhdGVTaGFwZSh0eXBlLCBhcmdzKSwgcG9zaXRpb24gPyBuZXcgVmVjMyguLi5wb3NpdGlvbikgOiB1bmRlZmluZWQsIHNldFF1YXRlcm5pb24obmV3IFF1YXRlcm5pb24oMCwgMCwgMCwgMSksIHsKICAgICAgICAgIHF1YXRlcm5pb24sCiAgICAgICAgICByb3RhdGlvbgogICAgICAgIH0pKTsKICAgICAgICBpZiAobWF0ZXJpYWwpIHNoYXBlQm9keS5tYXRlcmlhbCA9IGNyZWF0ZU1hdGVyaWFsKG1hdGVyaWFsKTsKICAgICAgICBPYmplY3QuYXNzaWduKHNoYXBlQm9keSwgZXh0cmEpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGJvZHkuYWRkU2hhcGUoY3JlYXRlU2hhcGUodHlwZSwgYXJncykpOwogICAgfQogICAgYm9keS5wb3NpdGlvbi5zZXQocG9zaXRpb25bMF0sIHBvc2l0aW9uWzFdLCBwb3NpdGlvblsyXSk7CiAgICBib2R5LnZlbG9jaXR5LnNldCh2ZWxvY2l0eVswXSwgdmVsb2NpdHlbMV0sIHZlbG9jaXR5WzJdKTsKICAgIGJvZHkuYW5ndWxhclZlbG9jaXR5LnNldChhbmd1bGFyVmVsb2NpdHlbMF0sIGFuZ3VsYXJWZWxvY2l0eVsxXSwgYW5ndWxhclZlbG9jaXR5WzJdKTsKICAgIGJvZHkubGluZWFyRmFjdG9yLnNldChsaW5lYXJGYWN0b3JbMF0sIGxpbmVhckZhY3RvclsxXSwgbGluZWFyRmFjdG9yWzJdKTsKICAgIGJvZHkuYW5ndWxhckZhY3Rvci5zZXQoYW5ndWxhckZhY3RvclswXSwgYW5ndWxhckZhY3RvclsxXSwgYW5ndWxhckZhY3RvclsyXSk7CiAgICBzZXRRdWF0ZXJuaW9uKGJvZHkucXVhdGVybmlvbiwgewogICAgICBxdWF0ZXJuaW9uLAogICAgICByb3RhdGlvbgogICAgfSk7CiAgICByZXR1cm4gYm9keTsKICB9OwoKICBjb25zdCBhZGRCb2RpZXMgPSAoc3RhdGUsIGNyZWF0ZU1hdGVyaWFsLCBfcmVmKSA9PiB7CiAgICBsZXQgewogICAgICBwcm9wcywKICAgICAgdHlwZSwKICAgICAgdXVpZAogICAgfSA9IF9yZWY7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHV1aWQubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYm9keSA9IHByb3BzVG9Cb2R5KHsKICAgICAgICBjcmVhdGVNYXRlcmlhbCwKICAgICAgICBwcm9wczogcHJvcHNbaV0sCiAgICAgICAgdHlwZSwKICAgICAgICB1dWlkOiB1dWlkW2ldCiAgICAgIH0pOwogICAgICBzdGF0ZS53b3JsZC5hZGRCb2R5KGJvZHkpOwogICAgICBpZiAocHJvcHNbaV0ub25Db2xsaWRlKSBib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2NvbGxpZGUnLCBfcmVmMiA9PiB7CiAgICAgICAgbGV0IHsKICAgICAgICAgIHR5cGUsCiAgICAgICAgICBib2R5LAogICAgICAgICAgdGFyZ2V0LAogICAgICAgICAgY29udGFjdAogICAgICAgIH0gPSBfcmVmMjsKICAgICAgICBpZiAoIWJvZHkudXVpZCB8fCAhdGFyZ2V0LnV1aWQpIHJldHVybjsKICAgICAgICBjb25zdCB7CiAgICAgICAgICBuaSwKICAgICAgICAgIHJpLAogICAgICAgICAgcmosCiAgICAgICAgICBiaSwKICAgICAgICAgIGJqLAogICAgICAgICAgaWQKICAgICAgICB9ID0gY29udGFjdDsKICAgICAgICBjb25zdCBjb250YWN0UG9pbnQgPSBiaS5wb3NpdGlvbi52YWRkKHJpKTsKICAgICAgICBjb25zdCBjb250YWN0Tm9ybWFsID0gYmkgPT09IGJvZHkgPyBuaSA6IG5pLnNjYWxlKC0xKTsKICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICAgIGJvZHk6IGJvZHkudXVpZCwKICAgICAgICAgIGNvbGxpc2lvbkZpbHRlcnM6IHsKICAgICAgICAgICAgYm9keUZpbHRlckdyb3VwOiBib2R5LmNvbGxpc2lvbkZpbHRlckdyb3VwLAogICAgICAgICAgICBib2R5RmlsdGVyTWFzazogYm9keS5jb2xsaXNpb25GaWx0ZXJNYXNrLAogICAgICAgICAgICB0YXJnZXRGaWx0ZXJHcm91cDogdGFyZ2V0LmNvbGxpc2lvbkZpbHRlckdyb3VwLAogICAgICAgICAgICB0YXJnZXRGaWx0ZXJNYXNrOiB0YXJnZXQuY29sbGlzaW9uRmlsdGVyTWFzawogICAgICAgICAgfSwKICAgICAgICAgIGNvbnRhY3Q6IHsKICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBUT0RPOiB1c2UgaWQgaW5zdGVhZCBvZiB1dWlkCiAgICAgICAgICAgIGJpOiBiaS51dWlkLAogICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIFRPRE86IHVzZSBpZCBpbnN0ZWFkIG9mIHV1aWQKICAgICAgICAgICAgYmo6IGJqLnV1aWQsCiAgICAgICAgICAgIC8vIE5vcm1hbCBvZiB0aGUgY29udGFjdCwgcmVsYXRpdmUgdG8gdGhlIGNvbGxpZGluZyBib2R5CiAgICAgICAgICAgIGNvbnRhY3ROb3JtYWw6IGNvbnRhY3ROb3JtYWwudG9BcnJheSgpLAogICAgICAgICAgICAvLyBXb3JsZCBwb3NpdGlvbiBvZiB0aGUgY29udGFjdAogICAgICAgICAgICBjb250YWN0UG9pbnQ6IGNvbnRhY3RQb2ludC50b0FycmF5KCksCiAgICAgICAgICAgIGlkLAogICAgICAgICAgICBpbXBhY3RWZWxvY2l0eTogY29udGFjdC5nZXRJbXBhY3RWZWxvY2l0eUFsb25nTm9ybWFsKCksCiAgICAgICAgICAgIG5pOiBuaS50b0FycmF5KCksCiAgICAgICAgICAgIHJpOiByaS50b0FycmF5KCksCiAgICAgICAgICAgIHJqOiByai50b0FycmF5KCkKICAgICAgICAgIH0sCiAgICAgICAgICBvcDogJ2V2ZW50JywKICAgICAgICAgIHRhcmdldDogdGFyZ2V0LnV1aWQsCiAgICAgICAgICB0eXBlCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH07CgogIGNvbnN0IHRyaXBsZXRUb1ZlYzMgPSB0ID0+IHQgPyBuZXcgVmVjMyguLi50KSA6IHVuZGVmaW5lZDsKCiAgY29uc3QgYWRkQ29uc3RyYWludCA9IChzdGF0ZSwgX3JlZikgPT4gewogICAgbGV0IHsKICAgICAgcHJvcHM6IFtib2R5QSwgYm9keUIsIHsKICAgICAgICBhbmdsZSwKICAgICAgICBheGlzQSwKICAgICAgICBheGlzQiwKICAgICAgICBjb2xsaWRlQ29ubmVjdGVkLAogICAgICAgIGRpc3RhbmNlLAogICAgICAgIG1heEZvcmNlLAogICAgICAgIG1heE11bHRpcGxpZXIsCiAgICAgICAgcGl2b3RBLAogICAgICAgIHBpdm90QiwKICAgICAgICB0d2lzdEFuZ2xlLAogICAgICAgIHdha2VVcEJvZGllcwogICAgICB9XSwKICAgICAgdHlwZSwKICAgICAgdXVpZAogICAgfSA9IF9yZWY7CiAgICBsZXQgY29uc3RyYWludDsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlICdQb2ludFRvUG9pbnQnOgogICAgICAgIGNvbnN0cmFpbnQgPSBuZXcgUG9pbnRUb1BvaW50Q29uc3RyYWludChzdGF0ZS5ib2RpZXNbYm9keUFdLCB0cmlwbGV0VG9WZWMzKHBpdm90QSksIHN0YXRlLmJvZGllc1tib2R5Ql0sIHRyaXBsZXRUb1ZlYzMocGl2b3RCKSwgbWF4Rm9yY2UpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdDb25lVHdpc3QnOgogICAgICAgIGNvbnN0cmFpbnQgPSBuZXcgQ29uZVR3aXN0Q29uc3RyYWludChzdGF0ZS5ib2RpZXNbYm9keUFdLCBzdGF0ZS5ib2RpZXNbYm9keUJdLCB7CiAgICAgICAgICBhbmdsZSwKICAgICAgICAgIGF4aXNBOiB0cmlwbGV0VG9WZWMzKGF4aXNBKSwKICAgICAgICAgIGF4aXNCOiB0cmlwbGV0VG9WZWMzKGF4aXNCKSwKICAgICAgICAgIGNvbGxpZGVDb25uZWN0ZWQsCiAgICAgICAgICBtYXhGb3JjZSwKICAgICAgICAgIHBpdm90QTogdHJpcGxldFRvVmVjMyhwaXZvdEEpLAogICAgICAgICAgcGl2b3RCOiB0cmlwbGV0VG9WZWMzKHBpdm90QiksCiAgICAgICAgICB0d2lzdEFuZ2xlCiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ0hpbmdlJzoKICAgICAgICBjb25zdHJhaW50ID0gbmV3IEhpbmdlQ29uc3RyYWludChzdGF0ZS5ib2RpZXNbYm9keUFdLCBzdGF0ZS5ib2RpZXNbYm9keUJdLCB7CiAgICAgICAgICBheGlzQTogdHJpcGxldFRvVmVjMyhheGlzQSksCiAgICAgICAgICBheGlzQjogdHJpcGxldFRvVmVjMyhheGlzQiksCiAgICAgICAgICBjb2xsaWRlQ29ubmVjdGVkLAogICAgICAgICAgbWF4Rm9yY2UsCiAgICAgICAgICBwaXZvdEE6IHRyaXBsZXRUb1ZlYzMocGl2b3RBKSwKICAgICAgICAgIHBpdm90QjogdHJpcGxldFRvVmVjMyhwaXZvdEIpCiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ0Rpc3RhbmNlJzoKICAgICAgICBjb25zdHJhaW50ID0gbmV3IERpc3RhbmNlQ29uc3RyYWludChzdGF0ZS5ib2RpZXNbYm9keUFdLCBzdGF0ZS5ib2RpZXNbYm9keUJdLCBkaXN0YW5jZSwgbWF4Rm9yY2UpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdMb2NrJzoKICAgICAgICBjb25zdHJhaW50ID0gbmV3IExvY2tDb25zdHJhaW50KHN0YXRlLmJvZGllc1tib2R5QV0sIHN0YXRlLmJvZGllc1tib2R5Ql0sIHsKICAgICAgICAgIG1heEZvcmNlCiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgY29uc3RyYWludCA9IG5ldyBDb25zdHJhaW50KHN0YXRlLmJvZGllc1tib2R5QV0sIHN0YXRlLmJvZGllc1tib2R5Ql0sIHsKICAgICAgICAgIGNvbGxpZGVDb25uZWN0ZWQsCiAgICAgICAgICB3YWtlVXBCb2RpZXMKICAgICAgICB9KTsKICAgICAgICBicmVhazsKICAgIH0KICAgIGNvbnN0cmFpbnQudXVpZCA9IHV1aWQ7CiAgICBzdGF0ZS53b3JsZC5hZGRDb25zdHJhaW50KGNvbnN0cmFpbnQpOwogICAgaWYgKG1heE11bHRpcGxpZXIgIT09IHVuZGVmaW5lZCkgewogICAgICBjb25zdCBwb3N0U3RlcENvbnN0cmFpbnQgPSAoKSA9PiB7CiAgICAgICAgLy8gVGhlIG11bHRpcGxpZXIgaXMgcHJvcG9ydGlvbmFsIHRvIGhvdyBtdWNoIGZvcmNlIGlzIGFkZGVkIHRvIHRoZSBib2RpZXMgYnkgdGhlIGNvbnN0cmFpbnQuCiAgICAgICAgLy8gSWYgdGhpcyBleGNlZWRzIGEgbGltaXQgdGhlIGNvbnN0cmFpbnQgaXMgZGlzYWJsZWQuCiAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IE1hdGguYWJzKGNvbnN0cmFpbnQuZXF1YXRpb25zWzBdLm11bHRpcGxpZXIpOwogICAgICAgIGlmIChtdWx0aXBsaWVyID4gbWF4TXVsdGlwbGllcikgewogICAgICAgICAgY29uc3RyYWludC5kaXNhYmxlKCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBzdGF0ZS5jb25zdHJhaW50c1t1dWlkXSA9IHBvc3RTdGVwQ29uc3RyYWludDsKICAgICAgc3RhdGUud29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBzdGF0ZS5jb25zdHJhaW50c1t1dWlkXSk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gdG9VcHBlcmNhc2Uoc3RyKSB7CiAgICByZXR1cm4gc3RyLnRvVXBwZXJDYXNlKCk7CiAgfQogIGNvbnN0IGFkZFJheSA9IChzdGF0ZSwgX3JlZikgPT4gewogICAgbGV0IHsKICAgICAgcHJvcHM6IHsKICAgICAgICBmcm9tLAogICAgICAgIG1vZGUsCiAgICAgICAgdG8sCiAgICAgICAgLi4ucmF5T3B0aW9ucwogICAgICB9LAogICAgICB1dWlkCiAgICB9ID0gX3JlZjsKICAgIGNvbnN0IHJheSA9IG5ldyBSYXkodHJpcGxldFRvVmVjMyhmcm9tKSwgdHJpcGxldFRvVmVjMyh0bykpOwogICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgbW9kZTogUkFZX01PREVTW3RvVXBwZXJjYXNlKG1vZGUpXSwKICAgICAgcmVzdWx0OiBuZXcgUmF5Y2FzdFJlc3VsdCgpLAogICAgICAuLi5yYXlPcHRpb25zCiAgICB9OwogICAgc3RhdGUucmF5c1t1dWlkXSA9ICgpID0+IHsKICAgICAgcmF5LmludGVyc2VjdFdvcmxkKHN0YXRlLndvcmxkLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLnJlc3VsdCB8fCAhb3B0aW9ucy5yZXN1bHQuYm9keSkgcmV0dXJuOwogICAgICBjb25zdCB7CiAgICAgICAgYm9keSwKICAgICAgICBzaGFwZSwKICAgICAgICByYXlGcm9tV29ybGQsCiAgICAgICAgcmF5VG9Xb3JsZCwKICAgICAgICBoaXROb3JtYWxXb3JsZCwKICAgICAgICBoaXRQb2ludFdvcmxkLAogICAgICAgIC4uLnJlc3QKICAgICAgfSA9IG9wdGlvbnMucmVzdWx0OwogICAgICBjb25zdCBib2R5VVVJRCA9IGJvZHkudXVpZDsKICAgICAgaWYgKCFib2R5VVVJRCkgcmV0dXJuOwogICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICBib2R5OiBib2R5VVVJRCwKICAgICAgICBoaXROb3JtYWxXb3JsZDogaGl0Tm9ybWFsV29ybGQudG9BcnJheSgpLAogICAgICAgIGhpdFBvaW50V29ybGQ6IGhpdFBvaW50V29ybGQudG9BcnJheSgpLAogICAgICAgIG9wOiAnZXZlbnQnLAogICAgICAgIHJheTogewogICAgICAgICAgY29sbGlzaW9uRmlsdGVyR3JvdXA6IHJheS5jb2xsaXNpb25GaWx0ZXJHcm91cCwKICAgICAgICAgIGNvbGxpc2lvbkZpbHRlck1hc2s6IHJheS5jb2xsaXNpb25GaWx0ZXJNYXNrLAogICAgICAgICAgZGlyZWN0aW9uOiByYXkuZGlyZWN0aW9uLnRvQXJyYXkoKSwKICAgICAgICAgIGZyb20sCiAgICAgICAgICB0bywKICAgICAgICAgIHV1aWQKICAgICAgICB9LAogICAgICAgIHJheUZyb21Xb3JsZDogcmF5RnJvbVdvcmxkLnRvQXJyYXkoKSwKICAgICAgICByYXlUb1dvcmxkOiByYXlUb1dvcmxkLnRvQXJyYXkoKSwKICAgICAgICBzaGFwZTogc2hhcGUgPyB7CiAgICAgICAgICAuLi5zaGFwZSwKICAgICAgICAgIGJvZHk6IGJvZHlVVUlECiAgICAgICAgfSA6IG51bGwsCiAgICAgICAgdHlwZTogJ3JheWhpdCcsCiAgICAgICAgLi4ucmVzdAogICAgICB9KTsKICAgIH07CiAgICBzdGF0ZS53b3JsZC5hZGRFdmVudExpc3RlbmVyKCdwcmVTdGVwJywgc3RhdGUucmF5c1t1dWlkXSk7CiAgfTsKCiAgY29uc3QgYWRkUmF5Y2FzdFZlaGljbGUgPSAoc3RhdGUsIGRhdGEpID0+IHsKICAgIGNvbnN0IFtjaGFzc2lzQm9keSwgd2hlZWxzLCB3aGVlbEluZm9zLCBpbmRleEZvcndhcmRBeGlzLCBpbmRleFJpZ2h0QXhpcywgaW5kZXhVcEF4aXNdID0gZGF0YS5wcm9wczsKICAgIGNvbnN0IHZlaGljbGUgPSBuZXcgUmF5Y2FzdFZlaGljbGUoewogICAgICBjaGFzc2lzQm9keTogc3RhdGUuYm9kaWVzW2NoYXNzaXNCb2R5XSwKICAgICAgaW5kZXhGb3J3YXJkQXhpcywKICAgICAgaW5kZXhSaWdodEF4aXMsCiAgICAgIGluZGV4VXBBeGlzCiAgICB9KTsKICAgIHZlaGljbGUud29ybGQgPSBzdGF0ZS53b3JsZDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2hlZWxJbmZvcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB7CiAgICAgICAgYXhsZUxvY2FsLAogICAgICAgIGNoYXNzaXNDb25uZWN0aW9uUG9pbnRMb2NhbCwKICAgICAgICBkaXJlY3Rpb25Mb2NhbCwKICAgICAgICAuLi5yZXN0CiAgICAgIH0gPSB3aGVlbEluZm9zW2ldOwogICAgICB2ZWhpY2xlLmFkZFdoZWVsKHsKICAgICAgICBheGxlTG9jYWw6IHRyaXBsZXRUb1ZlYzMoYXhsZUxvY2FsKSwKICAgICAgICBjaGFzc2lzQ29ubmVjdGlvblBvaW50TG9jYWw6IHRyaXBsZXRUb1ZlYzMoY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludExvY2FsKSwKICAgICAgICBkaXJlY3Rpb25Mb2NhbDogdHJpcGxldFRvVmVjMyhkaXJlY3Rpb25Mb2NhbCksCiAgICAgICAgLi4ucmVzdAogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHByZVN0ZXAgPSAoKSA9PiB7CiAgICAgIHZlaGljbGUudXBkYXRlVmVoaWNsZShzdGF0ZS53b3JsZC5kdCk7CiAgICB9OwogICAgY29uc3QgcG9zdFN0ZXAgPSAoKSA9PiB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVoaWNsZS53aGVlbEluZm9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmVoaWNsZS51cGRhdGVXaGVlbFRyYW5zZm9ybShpKTsKICAgICAgICBjb25zdCB0ID0gdmVoaWNsZS53aGVlbEluZm9zW2ldLndvcmxkVHJhbnNmb3JtOwogICAgICAgIGNvbnN0IHdoZWVsQm9keSA9IHN0YXRlLmJvZGllc1t3aGVlbHNbaV1dOwogICAgICAgIHdoZWVsQm9keS5wb3NpdGlvbi5jb3B5KHQucG9zaXRpb24pOwogICAgICAgIHdoZWVsQm9keS5xdWF0ZXJuaW9uLmNvcHkodC5xdWF0ZXJuaW9uKTsKICAgICAgfQogICAgfTsKICAgIHN0YXRlLnZlaGljbGVzW2RhdGEudXVpZF0gPSB7CiAgICAgIHBvc3RTdGVwLAogICAgICBwcmVTdGVwLAogICAgICB2ZWhpY2xlCiAgICB9OwogICAgc3RhdGUud29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncHJlU3RlcCcsIHByZVN0ZXApOwogICAgc3RhdGUud29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBwb3N0U3RlcCk7CiAgfTsKCiAgY29uc3QgYWRkU3ByaW5nID0gKHN0YXRlLCBfcmVmKSA9PiB7CiAgICBsZXQgewogICAgICBwcm9wczogW2JvZHlBLCBib2R5QiwgewogICAgICAgIGRhbXBpbmcsCiAgICAgICAgbG9jYWxBbmNob3JBLAogICAgICAgIGxvY2FsQW5jaG9yQiwKICAgICAgICByZXN0TGVuZ3RoLAogICAgICAgIHN0aWZmbmVzcywKICAgICAgICB3b3JsZEFuY2hvckEsCiAgICAgICAgd29ybGRBbmNob3JCCiAgICAgIH1dLAogICAgICB1dWlkCiAgICB9ID0gX3JlZjsKICAgIGNvbnN0IHNwcmluZyA9IG5ldyBTcHJpbmcoc3RhdGUuYm9kaWVzW2JvZHlBXSwgc3RhdGUuYm9kaWVzW2JvZHlCXSwgewogICAgICBkYW1waW5nLAogICAgICBsb2NhbEFuY2hvckE6IHRyaXBsZXRUb1ZlYzMobG9jYWxBbmNob3JBKSwKICAgICAgbG9jYWxBbmNob3JCOiB0cmlwbGV0VG9WZWMzKGxvY2FsQW5jaG9yQiksCiAgICAgIHJlc3RMZW5ndGgsCiAgICAgIHN0aWZmbmVzcywKICAgICAgd29ybGRBbmNob3JBOiB0cmlwbGV0VG9WZWMzKHdvcmxkQW5jaG9yQSksCiAgICAgIHdvcmxkQW5jaG9yQjogdHJpcGxldFRvVmVjMyh3b3JsZEFuY2hvckIpCiAgICB9KTsKICAgIHNwcmluZy51dWlkID0gdXVpZDsKICAgIGNvbnN0IHBvc3RTdGVwU3ByaW5nID0gKCkgPT4gc3ByaW5nLmFwcGx5Rm9yY2UoKTsKICAgIHN0YXRlLnNwcmluZ3NbdXVpZF0gPSBwb3N0U3RlcFNwcmluZzsKICAgIHN0YXRlLnNwcmluZ0luc3RhbmNlc1t1dWlkXSA9IHNwcmluZzsKCiAgICAvLyBDb21wdXRlIHRoZSBmb3JjZSBhZnRlciBlYWNoIHN0ZXAKICAgIHN0YXRlLndvcmxkLmFkZEV2ZW50TGlzdGVuZXIoJ3Bvc3RTdGVwJywgc3RhdGUuc3ByaW5nc1t1dWlkXSk7CiAgfTsKCiAgZnVuY3Rpb24gZW1pdEJlZ2luQ29udGFjdChfcmVmKSB7CiAgICBsZXQgewogICAgICBib2R5QSwKICAgICAgYm9keUIKICAgIH0gPSBfcmVmOwogICAgaWYgKCEoYm9keUEgIT0gbnVsbCAmJiBib2R5QS51dWlkKSB8fCAhKGJvZHlCICE9IG51bGwgJiYgYm9keUIudXVpZCkpIHJldHVybjsKICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICBib2R5QTogYm9keUEudXVpZCwKICAgICAgYm9keUI6IGJvZHlCLnV1aWQsCiAgICAgIG9wOiAnZXZlbnQnLAogICAgICB0eXBlOiAnY29sbGlkZUJlZ2luJwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGVtaXRFbmRDb250YWN0KF9yZWYyKSB7CiAgICBsZXQgewogICAgICBib2R5QSwKICAgICAgYm9keUIKICAgIH0gPSBfcmVmMjsKICAgIGlmICghKGJvZHlBICE9IG51bGwgJiYgYm9keUEudXVpZCkgfHwgIShib2R5QiAhPSBudWxsICYmIGJvZHlCLnV1aWQpKSByZXR1cm47CiAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgYm9keUE6IGJvZHlBLnV1aWQsCiAgICAgIGJvZHlCOiBib2R5Qi51dWlkLAogICAgICBvcDogJ2V2ZW50JywKICAgICAgdHlwZTogJ2NvbGxpZGVFbmQnCiAgICB9KTsKICB9CiAgY29uc3QgaW5pdCA9ICh3b3JsZCwgX3JlZjMpID0+IHsKICAgIGxldCB7CiAgICAgIGFsbG93U2xlZXAsCiAgICAgIGF4aXNJbmRleCA9IDAsCiAgICAgIGJyb2FkcGhhc2UsCiAgICAgIGRlZmF1bHRDb250YWN0TWF0ZXJpYWwsCiAgICAgIGZyaWN0aW9uR3Jhdml0eSwKICAgICAgZ3Jhdml0eSwKICAgICAgaXRlcmF0aW9ucywKICAgICAgcXVhdE5vcm1hbGl6ZUZhc3QsCiAgICAgIHF1YXROb3JtYWxpemVTa2lwLAogICAgICBzb2x2ZXIsCiAgICAgIHRvbGVyYW5jZQogICAgfSA9IF9yZWYzOwogICAgd29ybGQuYWxsb3dTbGVlcCA9IGFsbG93U2xlZXA7CiAgICB3b3JsZC5ncmF2aXR5LnNldCguLi5ncmF2aXR5KTsKICAgIHdvcmxkLmZyaWN0aW9uR3Jhdml0eSA9IGZyaWN0aW9uR3Jhdml0eSA/IG5ldyBWZWMzKC4uLmZyaWN0aW9uR3Jhdml0eSkgOiB1bmRlZmluZWQ7CiAgICB3b3JsZC5xdWF0Tm9ybWFsaXplRmFzdCA9IHF1YXROb3JtYWxpemVGYXN0OwogICAgd29ybGQucXVhdE5vcm1hbGl6ZVNraXAgPSBxdWF0Tm9ybWFsaXplU2tpcDsKICAgIGlmIChzb2x2ZXIgPT09ICdTcGxpdCcpIHsKICAgICAgd29ybGQuc29sdmVyID0gbmV3IFNwbGl0U29sdmVyKG5ldyBHU1NvbHZlcigpKTsKICAgIH0KICAgIGlmICh3b3JsZC5zb2x2ZXIgaW5zdGFuY2VvZiBHU1NvbHZlcikgewogICAgICB3b3JsZC5zb2x2ZXIudG9sZXJhbmNlID0gdG9sZXJhbmNlOwogICAgICB3b3JsZC5zb2x2ZXIuaXRlcmF0aW9ucyA9IGl0ZXJhdGlvbnM7CiAgICB9CiAgICB3b3JsZC5icm9hZHBoYXNlID0gYnJvYWRwaGFzZSA9PT0gJ1NBUCcgPyBuZXcgU0FQQnJvYWRwaGFzZSh3b3JsZCkgOiBuZXcgTmFpdmVCcm9hZHBoYXNlKCk7CiAgICBpZiAod29ybGQuYnJvYWRwaGFzZSBpbnN0YW5jZW9mIFNBUEJyb2FkcGhhc2UpIHsKICAgICAgd29ybGQuYnJvYWRwaGFzZS5heGlzSW5kZXggPSBheGlzSW5kZXg7CiAgICB9CiAgICB3b3JsZC5hZGRFdmVudExpc3RlbmVyKCdiZWdpbkNvbnRhY3QnLCBlbWl0QmVnaW5Db250YWN0KTsKICAgIHdvcmxkLmFkZEV2ZW50TGlzdGVuZXIoJ2VuZENvbnRhY3QnLCBlbWl0RW5kQ29udGFjdCk7CiAgICBPYmplY3QuYXNzaWduKHdvcmxkLmRlZmF1bHRDb250YWN0TWF0ZXJpYWwsIGRlZmF1bHRDb250YWN0TWF0ZXJpYWwpOwogIH07CgogIGNvbnN0IGlzUW9yViA9IHYgPT4gdiBpbnN0YW5jZW9mIFF1YXRlcm5pb24gfHwgdiBpbnN0YW5jZW9mIFZlYzM7CiAgY29uc3Qgc3RlcCA9IChzdGF0ZSwgX3JlZikgPT4gewogICAgbGV0IHsKICAgICAgcG9zaXRpb25zLAogICAgICBwcm9wczogewogICAgICAgIG1heFN1YlN0ZXBzLAogICAgICAgIHN0ZXBTaXplLAogICAgICAgIHRpbWVTaW5jZUxhc3RDYWxsZWQKICAgICAgfSwKICAgICAgcXVhdGVybmlvbnMKICAgIH0gPSBfcmVmOwogICAgc3RhdGUud29ybGQuc3RlcChzdGVwU2l6ZSwgdGltZVNpbmNlTGFzdENhbGxlZCwgbWF4U3ViU3RlcHMpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdGF0ZS53b3JsZC5ib2RpZXMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgY29uc3QgcCA9IHN0YXRlLndvcmxkLmJvZGllc1tpXS5wb3NpdGlvbjsKICAgICAgY29uc3QgcSA9IHN0YXRlLndvcmxkLmJvZGllc1tpXS5xdWF0ZXJuaW9uOwogICAgICBwb3NpdGlvbnNbMyAqIGkgKyAwXSA9IHAueDsKICAgICAgcG9zaXRpb25zWzMgKiBpICsgMV0gPSBwLnk7CiAgICAgIHBvc2l0aW9uc1szICogaSArIDJdID0gcC56OwogICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDBdID0gcS54OwogICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDFdID0gcS55OwogICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDJdID0gcS56OwogICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDNdID0gcS53OwogICAgfQogICAgY29uc3Qgb2JzZXJ2YXRpb25zID0gW107CiAgICBmb3IgKGNvbnN0IGlkIG9mIE9iamVjdC5rZXlzKHN0YXRlLnN1YnNjcmlwdGlvbnMpKSB7CiAgICAgIGNvbnN0IFt1dWlkLCB0eXBlLCB0YXJnZXQgPSAnYm9kaWVzJ10gPSBzdGF0ZS5zdWJzY3JpcHRpb25zW2lkXTsKICAgICAgY29uc3QgewogICAgICAgIGJvZGllcywKICAgICAgICB2ZWhpY2xlcwogICAgICB9ID0gc3RhdGU7CiAgICAgIGNvbnN0IHZhbHVlID0gdGFyZ2V0ID09PSAndmVoaWNsZXMnID8KICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBUT0RPOiBEaWZmZXJlbnRpYXRlIHRoZXNlICJ0eXBlcyIKICAgICAgdmVoaWNsZXNbdXVpZF0udmVoaWNsZVt0eXBlXSA6CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgVE9ETzogRGlmZmVyZW50aWF0ZSB0aGVzZSAidHlwZXMiCiAgICAgIGJvZGllc1t1dWlkXVt0eXBlXTsKICAgICAgY29uc3Qgc2VyaWFsaXphYmxlVmFsdWUgPSBpc1FvclYodmFsdWUpID8gdmFsdWUudG9BcnJheSgpIDogdmFsdWU7CiAgICAgIG9ic2VydmF0aW9ucy5wdXNoKFtOdW1iZXIoaWQpLCBzZXJpYWxpemFibGVWYWx1ZSwKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBUT0RPOiBEaWZmZXJlbnRpYXRlIHRoZXNlICJ0eXBlcyIKICAgICAgdHlwZV0pOwogICAgfQogICAgY29uc3QgbWVzc2FnZSA9IHsKICAgICAgYWN0aXZlOiBzdGF0ZS53b3JsZC5oYXNBY3RpdmVCb2RpZXMsCiAgICAgIG9ic2VydmF0aW9ucywKICAgICAgb3A6ICdmcmFtZScsCiAgICAgIHBvc2l0aW9ucywKICAgICAgcXVhdGVybmlvbnMKICAgIH07CiAgICBpZiAoc3RhdGUuYm9kaWVzTmVlZFN5bmNpbmcpIHsKICAgICAgbWVzc2FnZS5ib2RpZXMgPSBzdGF0ZS53b3JsZC5ib2RpZXMucmVkdWNlKChib2RpZXMsIGJvZHkpID0+IHsKICAgICAgICBpZiAoYm9keS51dWlkKSBib2RpZXMucHVzaChib2R5LnV1aWQpOwogICAgICAgIHJldHVybiBib2RpZXM7CiAgICAgIH0sIFtdKTsKICAgICAgc3RhdGUuYm9kaWVzTmVlZFN5bmNpbmcgPSBmYWxzZTsKICAgIH0KICAgIHNlbGYucG9zdE1lc3NhZ2UobWVzc2FnZSwgW3Bvc2l0aW9ucy5idWZmZXIsIHF1YXRlcm5pb25zLmJ1ZmZlcl0pOwogIH07CgogIGNvbnN0IHN0YXRlID0gewogICAgYm9kaWVzOiB7fSwKICAgIGJvZGllc05lZWRTeW5jaW5nOiBmYWxzZSwKICAgIGNvbnN0cmFpbnRzOiB7fSwKICAgIG1hdGVyaWFsczoge30sCiAgICByYXlzOiB7fSwKICAgIHNwcmluZ0luc3RhbmNlczoge30sCiAgICBzcHJpbmdzOiB7fSwKICAgIHN1YnNjcmlwdGlvbnM6IHt9LAogICAgdmVoaWNsZXM6IHt9LAogICAgd29ybGQ6IG5ldyBXb3JsZCgpCiAgfTsKCiAgLy8vIDxyZWZlcmVuY2Ugbm8tZGVmYXVsdC1saWI9InRydWUiLz4KICBjb25zdCBpc0hpbmdlQ29uc3RyYWludCA9IGMgPT4gYyBpbnN0YW5jZW9mIEhpbmdlQ29uc3RyYWludDsKICBmdW5jdGlvbiBzeW5jQm9kaWVzKCkgewogICAgc3RhdGUuYm9kaWVzTmVlZFN5bmNpbmcgPSB0cnVlOwogICAgc3RhdGUuYm9kaWVzID0gc3RhdGUud29ybGQuYm9kaWVzLnJlZHVjZSgoYm9kaWVzLCBib2R5KSA9PiBib2R5LnV1aWQgPyB7CiAgICAgIC4uLmJvZGllcywKICAgICAgW2JvZHkudXVpZF06IGJvZHkKICAgIH0gOiBib2RpZXMsIHt9KTsKICB9CiAgY29uc3QgYnJvYWRwaGFzZXMgPSB7CiAgICBOYWl2ZUJyb2FkcGhhc2UsCiAgICBTQVBCcm9hZHBoYXNlCiAgfTsKICBjb25zdCBjcmVhdGVNYXRlcmlhbCA9IGNyZWF0ZU1hdGVyaWFsRmFjdG9yeShzdGF0ZS5tYXRlcmlhbHMpOwogIHNlbGYub25tZXNzYWdlID0gX3JlZiA9PiB7CiAgICBsZXQgewogICAgICBkYXRhCiAgICB9ID0gX3JlZjsKICAgIHN3aXRjaCAoZGF0YS5vcCkgewogICAgICBjYXNlICdpbml0JzoKICAgICAgICB7CiAgICAgICAgICBpbml0KHN0YXRlLndvcmxkLCBkYXRhLnByb3BzKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnc3RlcCc6CiAgICAgICAgewogICAgICAgICAgc3RlcChzdGF0ZSwgZGF0YSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ2FkZEJvZGllcyc6CiAgICAgICAgewogICAgICAgICAgYWRkQm9kaWVzKHN0YXRlLCBjcmVhdGVNYXRlcmlhbCwgZGF0YSk7CiAgICAgICAgICBzeW5jQm9kaWVzKCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3JlbW92ZUJvZGllcyc6CiAgICAgICAgewogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLnV1aWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgc3RhdGUud29ybGQucmVtb3ZlQm9keShzdGF0ZS5ib2RpZXNbZGF0YS51dWlkW2ldXSk7CiAgICAgICAgICAgIGNvbnN0IGtleSA9IE9iamVjdC5rZXlzKHN0YXRlLnN1YnNjcmlwdGlvbnMpLmZpbmQoayA9PiBzdGF0ZS5zdWJzY3JpcHRpb25zW2tdWzBdID09PSBkYXRhLnV1aWRbaV0pOwogICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnN1YnNjcmlwdGlvbnNba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3luY0JvZGllcygpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdzdWJzY3JpYmUnOgogICAgICAgIHsKICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgaWQsCiAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgdHlwZQogICAgICAgICAgfSA9IGRhdGEucHJvcHM7CiAgICAgICAgICBzdGF0ZS5zdWJzY3JpcHRpb25zW2lkXSA9IFtkYXRhLnV1aWQsIHR5cGUsIHRhcmdldF07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3Vuc3Vic2NyaWJlJzoKICAgICAgICB7CiAgICAgICAgICBkZWxldGUgc3RhdGUuc3Vic2NyaXB0aW9uc1tkYXRhLnByb3BzXTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnc2V0UG9zaXRpb24nOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLnBvc2l0aW9uLnNldChkYXRhLnByb3BzWzBdLCBkYXRhLnByb3BzWzFdLCBkYXRhLnByb3BzWzJdKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0UXVhdGVybmlvbic6CiAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0ucXVhdGVybmlvbi5zZXQoZGF0YS5wcm9wc1swXSwgZGF0YS5wcm9wc1sxXSwgZGF0YS5wcm9wc1syXSwgZGF0YS5wcm9wc1szXSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldFJvdGF0aW9uJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5xdWF0ZXJuaW9uLnNldEZyb21FdWxlcihkYXRhLnByb3BzWzBdLCBkYXRhLnByb3BzWzFdLCBkYXRhLnByb3BzWzJdKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0VmVsb2NpdHknOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLnZlbG9jaXR5LnNldChkYXRhLnByb3BzWzBdLCBkYXRhLnByb3BzWzFdLCBkYXRhLnByb3BzWzJdKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0QW5ndWxhclZlbG9jaXR5JzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5hbmd1bGFyVmVsb2NpdHkuc2V0KGRhdGEucHJvcHNbMF0sIGRhdGEucHJvcHNbMV0sIGRhdGEucHJvcHNbMl0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRMaW5lYXJGYWN0b3InOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmxpbmVhckZhY3Rvci5zZXQoZGF0YS5wcm9wc1swXSwgZGF0YS5wcm9wc1sxXSwgZGF0YS5wcm9wc1syXSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldEFuZ3VsYXJGYWN0b3InOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmFuZ3VsYXJGYWN0b3Iuc2V0KGRhdGEucHJvcHNbMF0sIGRhdGEucHJvcHNbMV0sIGRhdGEucHJvcHNbMl0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRNYXNzJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5tYXNzID0gZGF0YS5wcm9wczsKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS51cGRhdGVNYXNzUHJvcGVydGllcygpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRNYXRlcmlhbCc6CiAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0ubWF0ZXJpYWwgPSBkYXRhLnByb3BzID8gY3JlYXRlTWF0ZXJpYWwoZGF0YS5wcm9wcykgOiBudWxsOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRMaW5lYXJEYW1waW5nJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5saW5lYXJEYW1waW5nID0gZGF0YS5wcm9wczsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0QW5ndWxhckRhbXBpbmcnOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmFuZ3VsYXJEYW1waW5nID0gZGF0YS5wcm9wczsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0QWxsb3dTbGVlcCc6CiAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0uYWxsb3dTbGVlcCA9IGRhdGEucHJvcHM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldFNsZWVwU3BlZWRMaW1pdCc6CiAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0uc2xlZXBTcGVlZExpbWl0ID0gZGF0YS5wcm9wczsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0U2xlZXBUaW1lTGltaXQnOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLnNsZWVwVGltZUxpbWl0ID0gZGF0YS5wcm9wczsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0Q29sbGlzaW9uRmlsdGVyR3JvdXAnOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmNvbGxpc2lvbkZpbHRlckdyb3VwID0gZGF0YS5wcm9wczsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0Q29sbGlzaW9uRmlsdGVyTWFzayc6CiAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0uY29sbGlzaW9uRmlsdGVyTWFzayA9IGRhdGEucHJvcHM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldENvbGxpc2lvblJlc3BvbnNlJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5jb2xsaXNpb25SZXNwb25zZSA9IGRhdGEucHJvcHM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldEZpeGVkUm90YXRpb24nOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmZpeGVkUm90YXRpb24gPSBkYXRhLnByb3BzOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRGcmljdGlvbkdyYXZpdHknOgogICAgICAgIHN0YXRlLndvcmxkLmZyaWN0aW9uR3Jhdml0eSA9IGRhdGEucHJvcHMgPyBuZXcgVmVjMyguLi5kYXRhLnByb3BzKSA6IHVuZGVmaW5lZDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0SXNUcmlnZ2VyJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5pc1RyaWdnZXIgPSBkYXRhLnByb3BzOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRHcmF2aXR5JzoKICAgICAgICBzdGF0ZS53b3JsZC5ncmF2aXR5LnNldChkYXRhLnByb3BzWzBdLCBkYXRhLnByb3BzWzFdLCBkYXRhLnByb3BzWzJdKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0VG9sZXJhbmNlJzoKICAgICAgICBpZiAoc3RhdGUud29ybGQuc29sdmVyIGluc3RhbmNlb2YgR1NTb2x2ZXIpIHsKICAgICAgICAgIHN0YXRlLndvcmxkLnNvbHZlci50b2xlcmFuY2UgPSBkYXRhLnByb3BzOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0SXRlcmF0aW9ucyc6CiAgICAgICAgaWYgKHN0YXRlLndvcmxkLnNvbHZlciBpbnN0YW5jZW9mIEdTU29sdmVyKSB7CiAgICAgICAgICBzdGF0ZS53b3JsZC5zb2x2ZXIuaXRlcmF0aW9ucyA9IGRhdGEucHJvcHM7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdzZXRCcm9hZHBoYXNlJzoKICAgICAgICBzdGF0ZS53b3JsZC5icm9hZHBoYXNlID0gbmV3IChicm9hZHBoYXNlc1tgJHtkYXRhLnByb3BzfUJyb2FkcGhhc2VgXSB8fCBOYWl2ZUJyb2FkcGhhc2UpKHN0YXRlLndvcmxkKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0QXhpc0luZGV4JzoKICAgICAgICBpZiAoc3RhdGUud29ybGQuYnJvYWRwaGFzZSBpbnN0YW5jZW9mIFNBUEJyb2FkcGhhc2UpIHsKICAgICAgICAgIHN0YXRlLndvcmxkLmJyb2FkcGhhc2UuYXhpc0luZGV4ID0gZGF0YS5wcm9wcyA9PT0gdW5kZWZpbmVkIHx8IGRhdGEucHJvcHMgPT09IG51bGwgPyAwIDogZGF0YS5wcm9wczsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2FwcGx5Rm9yY2UnOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmFwcGx5Rm9yY2UobmV3IFZlYzMoLi4uZGF0YS5wcm9wc1swXSksIG5ldyBWZWMzKC4uLmRhdGEucHJvcHNbMV0pKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnYXBwbHlJbXB1bHNlJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5hcHBseUltcHVsc2UobmV3IFZlYzMoLi4uZGF0YS5wcm9wc1swXSksIG5ldyBWZWMzKC4uLmRhdGEucHJvcHNbMV0pKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnYXBwbHlMb2NhbEZvcmNlJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5hcHBseUxvY2FsRm9yY2UobmV3IFZlYzMoLi4uZGF0YS5wcm9wc1swXSksIG5ldyBWZWMzKC4uLmRhdGEucHJvcHNbMV0pKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnYXBwbHlMb2NhbEltcHVsc2UnOgogICAgICAgIHN0YXRlLmJvZGllc1tkYXRhLnV1aWRdLmFwcGx5TG9jYWxJbXB1bHNlKG5ldyBWZWMzKC4uLmRhdGEucHJvcHNbMF0pLCBuZXcgVmVjMyguLi5kYXRhLnByb3BzWzFdKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2FwcGx5VG9ycXVlJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5hcHBseVRvcnF1ZShuZXcgVmVjMyguLi5kYXRhLnByb3BzWzBdKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2FkZENvbnN0cmFpbnQnOgogICAgICAgIHsKICAgICAgICAgIGFkZENvbnN0cmFpbnQoc3RhdGUsIGRhdGEpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdyZW1vdmVDb25zdHJhaW50JzoKICAgICAgICBzdGF0ZS53b3JsZC5jb25zdHJhaW50cy5maWx0ZXIoX3JlZjIgPT4gewogICAgICAgICAgbGV0IHsKICAgICAgICAgICAgdXVpZAogICAgICAgICAgfSA9IF9yZWYyOwogICAgICAgICAgcmV0dXJuIHV1aWQgPT09IGRhdGEudXVpZDsKICAgICAgICB9KS5tYXAoYyA9PiBzdGF0ZS53b3JsZC5yZW1vdmVDb25zdHJhaW50KGMpKTsKICAgICAgICBpZiAoc3RhdGUuY29uc3RyYWludHNbZGF0YS51dWlkXSkgewogICAgICAgICAgc3RhdGUud29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBzdGF0ZS5jb25zdHJhaW50c1tkYXRhLnV1aWRdKTsKICAgICAgICAgIGRlbGV0ZSBzdGF0ZS5jb25zdHJhaW50c1tkYXRhLnV1aWRdOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAnZW5hYmxlQ29uc3RyYWludCc6CiAgICAgICAgc3RhdGUud29ybGQuY29uc3RyYWludHMuZmlsdGVyKGMgPT4gYy51dWlkID09PSBkYXRhLnV1aWQpLm1hcChjID0+IGMuZW5hYmxlKCkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdkaXNhYmxlQ29uc3RyYWludCc6CiAgICAgICAgc3RhdGUud29ybGQuY29uc3RyYWludHMuZmlsdGVyKGMgPT4gYy51dWlkID09PSBkYXRhLnV1aWQpLm1hcChjID0+IGMuZGlzYWJsZSgpKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnZW5hYmxlQ29uc3RyYWludE1vdG9yJzoKICAgICAgICBzdGF0ZS53b3JsZC5jb25zdHJhaW50cy5maWx0ZXIoYyA9PiBjLnV1aWQgPT09IGRhdGEudXVpZCkuZmlsdGVyKGlzSGluZ2VDb25zdHJhaW50KS5tYXAoYyA9PiBjLmVuYWJsZU1vdG9yKCkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdkaXNhYmxlQ29uc3RyYWludE1vdG9yJzoKICAgICAgICBzdGF0ZS53b3JsZC5jb25zdHJhaW50cy5maWx0ZXIoYyA9PiBjLnV1aWQgPT09IGRhdGEudXVpZCkuZmlsdGVyKGlzSGluZ2VDb25zdHJhaW50KS5tYXAoYyA9PiBjLmRpc2FibGVNb3RvcigpKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnc2V0Q29uc3RyYWludE1vdG9yU3BlZWQnOgogICAgICAgIHN0YXRlLndvcmxkLmNvbnN0cmFpbnRzLmZpbHRlcihjID0+IGMudXVpZCA9PT0gZGF0YS51dWlkKS5maWx0ZXIoaXNIaW5nZUNvbnN0cmFpbnQpLm1hcChjID0+IGMuc2V0TW90b3JTcGVlZChkYXRhLnByb3BzKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NldENvbnN0cmFpbnRNb3Rvck1heEZvcmNlJzoKICAgICAgICBzdGF0ZS53b3JsZC5jb25zdHJhaW50cy5maWx0ZXIoYyA9PiBjLnV1aWQgPT09IGRhdGEudXVpZCkuZmlsdGVyKGlzSGluZ2VDb25zdHJhaW50KS5tYXAoYyA9PiBjLnNldE1vdG9yTWF4Rm9yY2UoZGF0YS5wcm9wcykpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdhZGRTcHJpbmcnOgogICAgICAgIHsKICAgICAgICAgIGFkZFNwcmluZyhzdGF0ZSwgZGF0YSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3NldFNwcmluZ1N0aWZmbmVzcyc6CiAgICAgICAgewogICAgICAgICAgc3RhdGUuc3ByaW5nSW5zdGFuY2VzW2RhdGEudXVpZF0uc3RpZmZuZXNzID0gZGF0YS5wcm9wczsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnc2V0U3ByaW5nUmVzdExlbmd0aCc6CiAgICAgICAgewogICAgICAgICAgc3RhdGUuc3ByaW5nSW5zdGFuY2VzW2RhdGEudXVpZF0ucmVzdExlbmd0aCA9IGRhdGEucHJvcHM7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3NldFNwcmluZ0RhbXBpbmcnOgogICAgICAgIHsKICAgICAgICAgIHN0YXRlLnNwcmluZ0luc3RhbmNlc1tkYXRhLnV1aWRdLmRhbXBpbmcgPSBkYXRhLnByb3BzOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdyZW1vdmVTcHJpbmcnOgogICAgICAgIHsKICAgICAgICAgIHN0YXRlLndvcmxkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Bvc3RTdGVwJywgc3RhdGUuc3ByaW5nc1tkYXRhLnV1aWRdKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnYWRkUmF5JzoKICAgICAgICB7CiAgICAgICAgICBhZGRSYXkoc3RhdGUsIGRhdGEpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdyZW1vdmVSYXknOgogICAgICAgIHsKICAgICAgICAgIHN0YXRlLndvcmxkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3ByZVN0ZXAnLCBzdGF0ZS5yYXlzW2RhdGEudXVpZF0pOwogICAgICAgICAgZGVsZXRlIHN0YXRlLnJheXNbZGF0YS51dWlkXTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnYWRkUmF5Y2FzdFZlaGljbGUnOgogICAgICAgIHsKICAgICAgICAgIGFkZFJheWNhc3RWZWhpY2xlKHN0YXRlLCBkYXRhKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAncmVtb3ZlUmF5Y2FzdFZlaGljbGUnOgogICAgICAgIHsKICAgICAgICAgIHN0YXRlLndvcmxkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3ByZVN0ZXAnLCBzdGF0ZS52ZWhpY2xlc1tkYXRhLnV1aWRdLnByZVN0ZXApOwogICAgICAgICAgc3RhdGUud29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBzdGF0ZS52ZWhpY2xlc1tkYXRhLnV1aWRdLnBvc3RTdGVwKTsKICAgICAgICAgIHN0YXRlLnZlaGljbGVzW2RhdGEudXVpZF0udmVoaWNsZS53b3JsZCA9IG51bGw7CiAgICAgICAgICBkZWxldGUgc3RhdGUudmVoaWNsZXNbZGF0YS51dWlkXTsKICAgICAgICAgIGNvbnN0IGtleSA9IE9iamVjdC5rZXlzKHN0YXRlLnN1YnNjcmlwdGlvbnMpLmZpbmQoayA9PiBzdGF0ZS5zdWJzY3JpcHRpb25zW2tdWzBdID09PSBkYXRhLnV1aWQpOwogICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUuc3Vic2NyaXB0aW9uc1trZXldOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdzZXRSYXljYXN0VmVoaWNsZVN0ZWVyaW5nVmFsdWUnOgogICAgICAgIHsKICAgICAgICAgIGNvbnN0IFt2YWx1ZSwgd2hlZWxJbmRleF0gPSBkYXRhLnByb3BzOwogICAgICAgICAgc3RhdGUudmVoaWNsZXNbZGF0YS51dWlkXS52ZWhpY2xlLnNldFN0ZWVyaW5nVmFsdWUodmFsdWUsIHdoZWVsSW5kZXgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdhcHBseVJheWNhc3RWZWhpY2xlRW5naW5lRm9yY2UnOgogICAgICAgIHsKICAgICAgICAgIGNvbnN0IFt2YWx1ZSwgd2hlZWxJbmRleF0gPSBkYXRhLnByb3BzOwogICAgICAgICAgc3RhdGUudmVoaWNsZXNbZGF0YS51dWlkXS52ZWhpY2xlLmFwcGx5RW5naW5lRm9yY2UodmFsdWUsIHdoZWVsSW5kZXgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBjYXNlICdzZXRSYXljYXN0VmVoaWNsZUJyYWtlJzoKICAgICAgICB7CiAgICAgICAgICBjb25zdCBbYnJha2UsIHdoZWVsSW5kZXhdID0gZGF0YS5wcm9wczsKICAgICAgICAgIHN0YXRlLnZlaGljbGVzW2RhdGEudXVpZF0udmVoaWNsZS5zZXRCcmFrZShicmFrZSwgd2hlZWxJbmRleCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ2FkZENvbnRhY3RNYXRlcmlhbCc6CiAgICAgICAgewogICAgICAgICAgYWRkQ29udGFjdE1hdGVyaWFsKHN0YXRlLndvcmxkLCBjcmVhdGVNYXRlcmlhbCwgZGF0YS5wcm9wcywgZGF0YS51dWlkKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAncmVtb3ZlQ29udGFjdE1hdGVyaWFsJzoKICAgICAgICB7CiAgICAgICAgICByZW1vdmVDb250YWN0TWF0ZXJpYWwoc3RhdGUud29ybGQsIGRhdGEudXVpZCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3dha2VVcCc6CiAgICAgICAgewogICAgICAgICAgc3RhdGUuYm9kaWVzW2RhdGEudXVpZF0ud2FrZVVwKCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3NsZWVwJzoKICAgICAgICB7CiAgICAgICAgICBzdGF0ZS5ib2RpZXNbZGF0YS51dWlkXS5zbGVlcCgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQogIH07Cgp9KSgpOwoK",null,false),new Worker(nb,e)});class Cb extends Ib{get axisIndex(){return this.config.axisIndex}set axisIndex(e){this.config.axisIndex=e,this.postMessage({op:"setAxisIndex",props:e})}get broadphase(){return this.config.broadphase}set broadphase(e){this.config.broadphase=e,this.postMessage({op:"setBroadphase",props:e})}get frictionGravity(){return this.config.frictionGravity}set frictionGravity(e){this.config.frictionGravity=e,this.postMessage({op:"setFrictionGravity",props:e})}get gravity(){return this.config.gravity}set gravity(e){this.config.gravity=e,this.postMessage({op:"setGravity",props:e})}get iterations(){return this.config.iterations}set iterations(e){this.config.iterations=e,this.postMessage({op:"setIterations",props:e})}get tolerance(){return this.config.tolerance}set tolerance(e){this.config.tolerance=e,this.postMessage({op:"setTolerance",props:e})}messageQueue=[];worker=null;constructor(e){let{allowSleep:g=!1,axisIndex:t=0,broadphase:I="Naive",defaultContactMaterial:n={contactEquationStiffness:1e6},frictionGravity:i=null,gravity:C=[0,-9.81,0],iterations:o=5,quatNormalizeFast:a=!1,quatNormalizeSkip:s=0,size:l=1e3,solver:r="GS",tolerance:A=.001}=e;super(),this.config={allowSleep:g,axisIndex:t,broadphase:I,defaultContactMaterial:n,frictionGravity:i,gravity:C,iterations:o,quatNormalizeFast:a,quatNormalizeSkip:s,size:l,solver:r,tolerance:A},this.buffers={positions:new Float32Array(3*l),quaternions:new Float32Array(4*l)}}addBodies(e){let{props:g,type:t,uuid:I}=e;this.postMessage({op:"addBodies",props:g,type:t,uuid:I})}addConstraint(e){let{props:[g,t,I],type:n,uuid:i}=e;this.postMessage({op:"addConstraint",props:[g,t,I],type:n,uuid:i})}addContactMaterial(e){let{props:g,uuid:t}=e;this.postMessage({op:"addContactMaterial",props:g,uuid:t})}addRay(e){let{props:g,uuid:t}=e;this.postMessage({op:"addRay",props:g,uuid:t})}addRaycastVehicle(e){let{props:[g,t,I,n,i,C],uuid:o}=e;this.postMessage({op:"addRaycastVehicle",props:[g,t,I,n,i,C],uuid:o})}addSpring(e){let{props:[g,t,I],uuid:n}=e;this.postMessage({op:"addSpring",props:[g,t,I],uuid:n})}applyForce(e){let{props:g,uuid:t}=e;this.postMessage({op:"applyForce",props:g,uuid:t})}applyImpulse(e){let{props:g,uuid:t}=e;this.postMessage({op:"applyImpulse",props:g,uuid:t})}applyLocalForce(e){let{props:g,uuid:t}=e;this.postMessage({op:"applyLocalForce",props:g,uuid:t})}applyLocalImpulse(e){let{props:g,uuid:t}=e;this.postMessage({op:"applyLocalImpulse",props:g,uuid:t})}applyRaycastVehicleEngineForce(e){let{props:g,uuid:t}=e;this.postMessage({op:"applyRaycastVehicleEngineForce",props:g,uuid:t})}applyTorque(e){let{props:g,uuid:t}=e;this.postMessage({op:"applyTorque",props:g,uuid:t})}connect(){this.worker=new ib,this.worker.onmessage=e=>{if("frame"===e.data.op)return this.buffers.positions=e.data.positions,this.buffers.quaternions=e.data.quaternions,void this.emit(e.data.op,e.data);this.emit(e.data.type,e.data)};for(const e of this.messageQueue)this.worker.postMessage(e);this.messageQueue.length=0}disableConstraint(e){let{uuid:g}=e;this.postMessage({op:"disableConstraint",uuid:g})}disableConstraintMotor(e){let{uuid:g}=e;this.postMessage({op:"disableConstraintMotor",uuid:g})}disconnect(){this.worker&&(this.worker.onmessage=null)}enableConstraint(e){let{uuid:g}=e;this.postMessage({op:"enableConstraint",uuid:g})}enableConstraintMotor(e){let{uuid:g}=e;this.postMessage({op:"enableConstraintMotor",uuid:g})}init(){const{allowSleep:e,axisIndex:g,broadphase:t,defaultContactMaterial:I,frictionGravity:n,gravity:i,iterations:C,quatNormalizeFast:o,quatNormalizeSkip:a,solver:s,tolerance:l}=this.config;this.postMessage({op:"init",props:{allowSleep:e,axisIndex:g,broadphase:t,defaultContactMaterial:I,frictionGravity:n,gravity:i,iterations:C,quatNormalizeFast:o,quatNormalizeSkip:a,solver:s,tolerance:l}})}removeBodies(e){let{uuid:g}=e;this.postMessage({op:"removeBodies",uuid:g})}removeConstraint(e){let{uuid:g}=e;this.postMessage({op:"removeConstraint",uuid:g})}removeContactMaterial(e){let{uuid:g}=e;this.postMessage({op:"removeContactMaterial",uuid:g})}removeRay(e){let{uuid:g}=e;this.postMessage({op:"removeRay",uuid:g})}removeRaycastVehicle(e){let{uuid:g}=e;this.postMessage({op:"removeRaycastVehicle",uuid:g})}removeSpring(e){let{uuid:g}=e;this.postMessage({op:"removeSpring",uuid:g})}setAllowSleep(e){let{props:g,uuid:t}=e;this.postMessage({op:"setAllowSleep",props:g,uuid:t})}setAngularDamping(e){let{props:g,uuid:t}=e;this.postMessage({op:"setAngularDamping",props:g,uuid:t})}setAngularFactor(e){let{props:g,uuid:t}=e;this.postMessage({op:"setAngularFactor",props:g,uuid:t})}setAngularVelocity(e){let{props:g,uuid:t}=e;this.postMessage({op:"setAngularVelocity",props:g,uuid:t})}setCollisionFilterGroup(e){let{props:g,uuid:t}=e;this.postMessage({op:"setCollisionFilterGroup",props:g,uuid:t})}setCollisionFilterMask(e){let{props:g,uuid:t}=e;this.postMessage({op:"setCollisionFilterMask",props:g,uuid:t})}setCollisionResponse(e){let{props:g,uuid:t}=e;this.postMessage({op:"setCollisionResponse",props:g,uuid:t})}setConstraintMotorMaxForce(e){let{props:g,uuid:t}=e;this.postMessage({op:"setConstraintMotorMaxForce",props:g,uuid:t})}setConstraintMotorSpeed(e){let{props:g,uuid:t}=e;this.postMessage({op:"setConstraintMotorSpeed",props:g,uuid:t})}setFixedRotation(e){let{props:g,uuid:t}=e;this.postMessage({op:"setFixedRotation",props:g,uuid:t})}setIsTrigger(e){let{props:g,uuid:t}=e;this.postMessage({op:"setIsTrigger",props:g,uuid:t})}setLinearDamping(e){let{props:g,uuid:t}=e;this.postMessage({op:"setLinearDamping",props:g,uuid:t})}setLinearFactor(e){let{props:g,uuid:t}=e;this.postMessage({op:"setLinearFactor",props:g,uuid:t})}setMass(e){let{props:g,uuid:t}=e;this.postMessage({op:"setMass",props:g,uuid:t})}setMaterial(e){let{props:g,uuid:t}=e;this.postMessage({op:"setMaterial",props:g,uuid:t})}setPosition(e){let{props:g,uuid:t}=e;this.postMessage({op:"setPosition",props:g,uuid:t})}setQuaternion(e){let{props:[g,t,I,n],uuid:i}=e;this.postMessage({op:"setQuaternion",props:[g,t,I,n],uuid:i})}setRaycastVehicleBrake(e){let{props:g,uuid:t}=e;this.postMessage({op:"setRaycastVehicleBrake",props:g,uuid:t})}setRaycastVehicleSteeringValue(e){let{props:g,uuid:t}=e;this.postMessage({op:"setRaycastVehicleSteeringValue",props:g,uuid:t})}setRotation(e){let{props:g,uuid:t}=e;this.postMessage({op:"setRotation",props:g,uuid:t})}setSleepSpeedLimit(e){let{props:g,uuid:t}=e;this.postMessage({op:"setSleepSpeedLimit",props:g,uuid:t})}setSleepTimeLimit(e){let{props:g,uuid:t}=e;this.postMessage({op:"setSleepTimeLimit",props:g,uuid:t})}setSpringDamping(e){let{props:g,uuid:t}=e;this.postMessage({op:"setSpringDamping",props:g,uuid:t})}setSpringRestLength(e){let{props:g,uuid:t}=e;this.postMessage({op:"setSpringRestLength",props:g,uuid:t})}setSpringStiffness(e){let{props:g,uuid:t}=e;this.postMessage({op:"setSpringStiffness",props:g,uuid:t})}setUserData(e){let{props:g,uuid:t}=e;this.postMessage({op:"setUserData",props:g,uuid:t})}setVelocity(e){let{props:g,uuid:t}=e;this.postMessage({op:"setVelocity",props:g,uuid:t})}sleep(e){let{uuid:g}=e;this.postMessage({op:"sleep",uuid:g})}step(e){var g;const{buffers:{positions:t,quaternions:I}}=this;(t.byteLength||I.byteLength)&&(null==(g=this.worker)||g.postMessage({op:"step",positions:t,props:e,quaternions:I},[t.buffer,I.buffer]))}subscribe(e){let{props:{id:g,target:t,type:I},uuid:n}=e;this.postMessage({op:"subscribe",props:{id:g,target:t,type:I},uuid:n})}terminate(){var e;null==(e=this.worker)||e.terminate(),this.worker=null}unsubscribe(e){let{props:g}=e;this.postMessage({op:"unsubscribe",props:g})}wakeUp(e){let{uuid:g}=e;this.postMessage({op:"wakeUp",uuid:g})}postMessage(e){if(this.worker)return this.worker.postMessage(e);this.messageQueue.push(e)}}class ob{constructor(e){void 0===e&&(e=[0,0,0,0,0,0,0,0,0]),this.elements=e}identity(){const e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}setZero(){const e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0}setTrace(e){const g=this.elements;g[0]=e.x,g[4]=e.y,g[8]=e.z}getTrace(e){void 0===e&&(e=new sb);const g=this.elements;return e.x=g[0],e.y=g[4],e.z=g[8],e}vmult(e,g){void 0===g&&(g=new sb);const t=this.elements,I=e.x,n=e.y,i=e.z;return g.x=t[0]*I+t[1]*n+t[2]*i,g.y=t[3]*I+t[4]*n+t[5]*i,g.z=t[6]*I+t[7]*n+t[8]*i,g}smult(e){for(let g=0;g<this.elements.length;g++)this.elements[g]*=e}mmult(e,g){void 0===g&&(g=new ob);const t=this.elements,I=e.elements,n=g.elements,i=t[0],C=t[1],o=t[2],a=t[3],s=t[4],l=t[5],r=t[6],A=t[7],c=t[8],d=I[0],u=I[1],h=I[2],b=I[3],m=I[4],p=I[5],G=I[6],B=I[7],Z=I[8];return n[0]=i*d+C*b+o*G,n[1]=i*u+C*m+o*B,n[2]=i*h+C*p+o*Z,n[3]=a*d+s*b+l*G,n[4]=a*u+s*m+l*B,n[5]=a*h+s*p+l*Z,n[6]=r*d+A*b+c*G,n[7]=r*u+A*m+c*B,n[8]=r*h+A*p+c*Z,g}scale(e,g){void 0===g&&(g=new ob);const t=this.elements,I=g.elements;for(let g=0;3!==g;g++)I[3*g+0]=e.x*t[3*g+0],I[3*g+1]=e.y*t[3*g+1],I[3*g+2]=e.z*t[3*g+2];return g}solve(e,g){void 0===g&&(g=new sb);const t=[];let I,n;for(I=0;I<12;I++)t.push(0);for(I=0;I<3;I++)for(n=0;n<3;n++)t[I+4*n]=this.elements[I+3*n];t[3]=e.x,t[7]=e.y,t[11]=e.z;let i=3;const C=i;let o,a;do{if(I=C-i,0===t[I+4*I])for(n=I+1;n<C;n++)if(0!==t[I+4*n]){o=4;do{a=4-o,t[a+4*I]+=t[a+4*n]}while(--o);break}if(0!==t[I+4*I])for(n=I+1;n<C;n++){const e=t[I+4*n]/t[I+4*I];o=4;do{a=4-o,t[a+4*n]=a<=I?0:t[a+4*n]-t[a+4*I]*e}while(--o)}}while(--i);if(g.z=t[11]/t[10],g.y=(t[7]-t[6]*g.z)/t[5],g.x=(t[3]-t[2]*g.z-t[1]*g.y)/t[0],isNaN(g.x)||isNaN(g.y)||isNaN(g.z)||g.x===1/0||g.y===1/0||g.z===1/0)throw`Could not solve equation! Got x=[${g.toString()}], b=[${e.toString()}], A=[${this.toString()}]`;return g}e(e,g,t){if(void 0===t)return this.elements[g+3*e];this.elements[g+3*e]=t}copy(e){for(let g=0;g<e.elements.length;g++)this.elements[g]=e.elements[g];return this}toString(){let e="";for(let g=0;g<9;g++)e+=this.elements[g]+",";return e}reverse(e){void 0===e&&(e=new ob);const g=ab;let t,I;for(t=0;t<3;t++)for(I=0;I<3;I++)g[t+6*I]=this.elements[t+3*I];g[3]=1,g[9]=0,g[15]=0,g[4]=0,g[10]=1,g[16]=0,g[5]=0,g[11]=0,g[17]=1;let n=3;const i=n;let C,o;do{if(t=i-n,0===g[t+6*t])for(I=t+1;I<i;I++)if(0!==g[t+6*I]){C=6;do{o=6-C,g[o+6*t]+=g[o+6*I]}while(--C);break}if(0!==g[t+6*t])for(I=t+1;I<i;I++){const e=g[t+6*I]/g[t+6*t];C=6;do{o=6-C,g[o+6*I]=o<=t?0:g[o+6*I]-g[o+6*t]*e}while(--C)}}while(--n);t=2;do{I=t-1;do{const e=g[t+6*I]/g[t+6*t];C=6;do{o=6-C,g[o+6*I]=g[o+6*I]-g[o+6*t]*e}while(--C)}while(I--)}while(--t);t=2;do{const e=1/g[t+6*t];C=6;do{o=6-C,g[o+6*t]=g[o+6*t]*e}while(--C)}while(t--);t=2;do{I=2;do{if(o=g[3+I+6*t],isNaN(o)||o===1/0)throw`Could not reverse! A=[${this.toString()}]`;e.e(t,I,o)}while(I--)}while(t--);return e}setRotationFromQuaternion(e){const g=e.x,t=e.y,I=e.z,n=e.w,i=g+g,C=t+t,o=I+I,a=g*i,s=g*C,l=g*o,r=t*C,A=t*o,c=I*o,d=n*i,u=n*C,h=n*o,b=this.elements;return b[0]=1-(r+c),b[1]=s-h,b[2]=l+u,b[3]=s+h,b[4]=1-(a+c),b[5]=A-d,b[6]=l-u,b[7]=A+d,b[8]=1-(a+r),this}transpose(e){void 0===e&&(e=new ob);const g=this.elements,t=e.elements;let I;return t[0]=g[0],t[4]=g[4],t[8]=g[8],I=g[1],t[1]=g[3],t[3]=I,I=g[2],t[2]=g[6],t[6]=I,I=g[5],t[5]=g[7],t[7]=I,e}}const ab=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];class sb{constructor(e,g,t){void 0===e&&(e=0),void 0===g&&(g=0),void 0===t&&(t=0),this.x=e,this.y=g,this.z=t}cross(e,g){void 0===g&&(g=new sb);const t=e.x,I=e.y,n=e.z,i=this.x,C=this.y,o=this.z;return g.x=C*n-o*I,g.y=o*t-i*n,g.z=i*I-C*t,g}set(e,g,t){return this.x=e,this.y=g,this.z=t,this}setZero(){this.x=this.y=this.z=0}vadd(e,g){if(!g)return new sb(this.x+e.x,this.y+e.y,this.z+e.z);g.x=e.x+this.x,g.y=e.y+this.y,g.z=e.z+this.z}vsub(e,g){if(!g)return new sb(this.x-e.x,this.y-e.y,this.z-e.z);g.x=this.x-e.x,g.y=this.y-e.y,g.z=this.z-e.z}crossmat(){return new ob([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])}normalize(){const e=this.x,g=this.y,t=this.z,I=Math.sqrt(e*e+g*g+t*t);if(I>0){const e=1/I;this.x*=e,this.y*=e,this.z*=e}else this.x=0,this.y=0,this.z=0;return I}unit(e){void 0===e&&(e=new sb);const g=this.x,t=this.y,I=this.z;let n=Math.sqrt(g*g+t*t+I*I);return n>0?(n=1/n,e.x=g*n,e.y=t*n,e.z=I*n):(e.x=1,e.y=0,e.z=0),e}length(){const e=this.x,g=this.y,t=this.z;return Math.sqrt(e*e+g*g+t*t)}lengthSquared(){return this.dot(this)}distanceTo(e){const g=this.x,t=this.y,I=this.z,n=e.x,i=e.y,C=e.z;return Math.sqrt((n-g)*(n-g)+(i-t)*(i-t)+(C-I)*(C-I))}distanceSquared(e){const g=this.x,t=this.y,I=this.z,n=e.x,i=e.y,C=e.z;return(n-g)*(n-g)+(i-t)*(i-t)+(C-I)*(C-I)}scale(e,g){void 0===g&&(g=new sb);const t=this.x,I=this.y,n=this.z;return g.x=e*t,g.y=e*I,g.z=e*n,g}vmul(e,g){return void 0===g&&(g=new sb),g.x=e.x*this.x,g.y=e.y*this.y,g.z=e.z*this.z,g}addScaledVector(e,g,t){return void 0===t&&(t=new sb),t.x=this.x+e*g.x,t.y=this.y+e*g.y,t.z=this.z+e*g.z,t}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}isZero(){return 0===this.x&&0===this.y&&0===this.z}negate(e){return void 0===e&&(e=new sb),e.x=-this.x,e.y=-this.y,e.z=-this.z,e}tangents(e,g){const t=this.length();if(t>0){const I=lb,n=1/t;I.set(this.x*n,this.y*n,this.z*n);const i=rb;Math.abs(I.x)<.9?(i.set(1,0,0),I.cross(i,e)):(i.set(0,1,0),I.cross(i,e)),I.cross(e,g)}else e.set(1,0,0),g.set(0,1,0)}toString(){return`${this.x},${this.y},${this.z}`}toArray(){return[this.x,this.y,this.z]}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}lerp(e,g,t){const I=this.x,n=this.y,i=this.z;t.x=I+(e.x-I)*g,t.y=n+(e.y-n)*g,t.z=i+(e.z-i)*g}almostEquals(e,g){return void 0===g&&(g=1e-6),!(Math.abs(this.x-e.x)>g||Math.abs(this.y-e.y)>g||Math.abs(this.z-e.z)>g)}almostZero(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)}isAntiparallelTo(e,g){return this.negate(Ab),Ab.almostEquals(e,g)}clone(){return new sb(this.x,this.y,this.z)}}sb.ZERO=new sb(0,0,0),sb.UNIT_X=new sb(1,0,0),sb.UNIT_Y=new sb(0,1,0),sb.UNIT_Z=new sb(0,0,1);const lb=new sb,rb=new sb,Ab=new sb;class cb{constructor(e){void 0===e&&(e={}),this.lowerBound=new sb,this.upperBound=new sb,e.lowerBound&&this.lowerBound.copy(e.lowerBound),e.upperBound&&this.upperBound.copy(e.upperBound)}setFromPoints(e,g,t,I){const n=this.lowerBound,i=this.upperBound,C=t;n.copy(e[0]),C&&C.vmult(n,n),i.copy(n);for(let g=1;g<e.length;g++){let t=e[g];C&&(C.vmult(t,db),t=db),t.x>i.x&&(i.x=t.x),t.x<n.x&&(n.x=t.x),t.y>i.y&&(i.y=t.y),t.y<n.y&&(n.y=t.y),t.z>i.z&&(i.z=t.z),t.z<n.z&&(n.z=t.z)}return g&&(g.vadd(n,n),g.vadd(i,i)),I&&(n.x-=I,n.y-=I,n.z-=I,i.x+=I,i.y+=I,i.z+=I),this}copy(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this}clone(){return(new cb).copy(this)}extend(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)}overlaps(e){const g=this.lowerBound,t=this.upperBound,I=e.lowerBound,n=e.upperBound,i=I.x<=t.x&&t.x<=n.x||g.x<=n.x&&n.x<=t.x,C=I.y<=t.y&&t.y<=n.y||g.y<=n.y&&n.y<=t.y,o=I.z<=t.z&&t.z<=n.z||g.z<=n.z&&n.z<=t.z;return i&&C&&o}volume(){const e=this.lowerBound,g=this.upperBound;return(g.x-e.x)*(g.y-e.y)*(g.z-e.z)}contains(e){const g=this.lowerBound,t=this.upperBound,I=e.lowerBound,n=e.upperBound;return g.x<=I.x&&t.x>=n.x&&g.y<=I.y&&t.y>=n.y&&g.z<=I.z&&t.z>=n.z}getCorners(e,g,t,I,n,i,C,o){const a=this.lowerBound,s=this.upperBound;e.copy(a),g.set(s.x,a.y,a.z),t.set(s.x,s.y,a.z),I.set(a.x,s.y,s.z),n.set(s.x,a.y,s.z),i.set(a.x,s.y,a.z),C.set(a.x,a.y,s.z),o.copy(s)}toLocalFrame(e,g){const t=ub,I=t[0],n=t[1],i=t[2],C=t[3],o=t[4],a=t[5],s=t[6],l=t[7];this.getCorners(I,n,i,C,o,a,s,l);for(let g=0;8!==g;g++){const I=t[g];e.pointToLocal(I,I)}return g.setFromPoints(t)}toWorldFrame(e,g){const t=ub,I=t[0],n=t[1],i=t[2],C=t[3],o=t[4],a=t[5],s=t[6],l=t[7];this.getCorners(I,n,i,C,o,a,s,l);for(let g=0;8!==g;g++){const I=t[g];e.pointToWorld(I,I)}return g.setFromPoints(t)}overlapsRay(e){const{direction:g,from:t}=e,I=1/g.x,n=1/g.y,i=1/g.z,C=(this.lowerBound.x-t.x)*I,o=(this.upperBound.x-t.x)*I,a=(this.lowerBound.y-t.y)*n,s=(this.upperBound.y-t.y)*n,l=(this.lowerBound.z-t.z)*i,r=(this.upperBound.z-t.z)*i,A=Math.max(Math.max(Math.min(C,o),Math.min(a,s)),Math.min(l,r)),c=Math.min(Math.min(Math.max(C,o),Math.max(a,s)),Math.max(l,r));return!(c<0||A>c)}}const db=new sb,ub=[new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb];class hb{addEventListener(e,g){void 0===this._listeners&&(this._listeners={});const t=this._listeners;return void 0===t[e]&&(t[e]=[]),t[e].includes(g)||t[e].push(g),this}hasEventListener(e,g){if(void 0===this._listeners)return!1;const t=this._listeners;return!(void 0===t[e]||!t[e].includes(g))}hasAnyEventListener(e){return void 0!==this._listeners&&void 0!==this._listeners[e]}removeEventListener(e,g){if(void 0===this._listeners)return this;const t=this._listeners;if(void 0===t[e])return this;const I=t[e].indexOf(g);return-1!==I&&t[e].splice(I,1),this}dispatchEvent(e){if(void 0===this._listeners)return this;const g=this._listeners[e.type];if(void 0!==g){e.target=this;for(let t=0,I=g.length;t<I;t++)g[t].call(this,e)}return this}}class bb{constructor(e,g,t,I){void 0===e&&(e=0),void 0===g&&(g=0),void 0===t&&(t=0),void 0===I&&(I=1),this.x=e,this.y=g,this.z=t,this.w=I}set(e,g,t,I){return this.x=e,this.y=g,this.z=t,this.w=I,this}toString(){return`${this.x},${this.y},${this.z},${this.w}`}toArray(){return[this.x,this.y,this.z,this.w]}setFromAxisAngle(e,g){const t=Math.sin(.5*g);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=Math.cos(.5*g),this}toAxisAngle(e){void 0===e&&(e=new sb),this.normalize();const g=2*Math.acos(this.w),t=Math.sqrt(1-this.w*this.w);return t<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/t,e.y=this.y/t,e.z=this.z/t),[e,g]}setFromVectors(e,g){if(e.isAntiparallelTo(g)){const g=mb,t=pb;e.tangents(g,t),this.setFromAxisAngle(g,Math.PI)}else{const t=e.cross(g);this.x=t.x,this.y=t.y,this.z=t.z,this.w=Math.sqrt(e.length()**2*g.length()**2)+e.dot(g),this.normalize()}return this}mult(e,g){void 0===g&&(g=new bb);const t=this.x,I=this.y,n=this.z,i=this.w,C=e.x,o=e.y,a=e.z,s=e.w;return g.x=t*s+i*C+I*a-n*o,g.y=I*s+i*o+n*C-t*a,g.z=n*s+i*a+t*o-I*C,g.w=i*s-t*C-I*o-n*a,g}inverse(e){void 0===e&&(e=new bb);const g=this.x,t=this.y,I=this.z,n=this.w;this.conjugate(e);const i=1/(g*g+t*t+I*I+n*n);return e.x*=i,e.y*=i,e.z*=i,e.w*=i,e}conjugate(e){return void 0===e&&(e=new bb),e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e}normalize(){let e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this}normalizeFast(){const e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this}vmult(e,g){void 0===g&&(g=new sb);const t=e.x,I=e.y,n=e.z,i=this.x,C=this.y,o=this.z,a=this.w,s=a*t+C*n-o*I,l=a*I+o*t-i*n,r=a*n+i*I-C*t,A=-i*t-C*I-o*n;return g.x=s*a+A*-i+l*-o-r*-C,g.y=l*a+A*-C+r*-i-s*-o,g.z=r*a+A*-o+s*-C-l*-i,g}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}toEuler(e,g){let t,I,n;void 0===g&&(g="YZX");const i=this.x,C=this.y,o=this.z,a=this.w;if("YZX"!==g)throw new Error(`Euler order ${g} not supported yet.`);{const e=i*C+o*a;if(e>.499&&(t=2*Math.atan2(i,a),I=Math.PI/2,n=0),e<-.499&&(t=-2*Math.atan2(i,a),I=-Math.PI/2,n=0),void 0===t){const g=i*i,s=C*C,l=o*o;t=Math.atan2(2*C*a-2*i*o,1-2*s-2*l),I=Math.asin(2*e),n=Math.atan2(2*i*a-2*C*o,1-2*g-2*l)}}e.y=t,e.z=I,e.x=n}setFromEuler(e,g,t,I){void 0===I&&(I="XYZ");const n=Math.cos(e/2),i=Math.cos(g/2),C=Math.cos(t/2),o=Math.sin(e/2),a=Math.sin(g/2),s=Math.sin(t/2);return"XYZ"===I?(this.x=o*i*C+n*a*s,this.y=n*a*C-o*i*s,this.z=n*i*s+o*a*C,this.w=n*i*C-o*a*s):"YXZ"===I?(this.x=o*i*C+n*a*s,this.y=n*a*C-o*i*s,this.z=n*i*s-o*a*C,this.w=n*i*C+o*a*s):"ZXY"===I?(this.x=o*i*C-n*a*s,this.y=n*a*C+o*i*s,this.z=n*i*s+o*a*C,this.w=n*i*C-o*a*s):"ZYX"===I?(this.x=o*i*C-n*a*s,this.y=n*a*C+o*i*s,this.z=n*i*s-o*a*C,this.w=n*i*C+o*a*s):"YZX"===I?(this.x=o*i*C+n*a*s,this.y=n*a*C+o*i*s,this.z=n*i*s-o*a*C,this.w=n*i*C-o*a*s):"XZY"===I&&(this.x=o*i*C-n*a*s,this.y=n*a*C-o*i*s,this.z=n*i*s+o*a*C,this.w=n*i*C+o*a*s),this}clone(){return new bb(this.x,this.y,this.z,this.w)}slerp(e,g,t){void 0===t&&(t=new bb);const I=this.x,n=this.y,i=this.z,C=this.w;let o,a,s,l,r,A=e.x,c=e.y,d=e.z,u=e.w;return a=I*A+n*c+i*d+C*u,a<0&&(a=-a,A=-A,c=-c,d=-d,u=-u),1-a>1e-6?(o=Math.acos(a),s=Math.sin(o),l=Math.sin((1-g)*o)/s,r=Math.sin(g*o)/s):(l=1-g,r=g),t.x=l*I+r*A,t.y=l*n+r*c,t.z=l*i+r*d,t.w=l*C+r*u,t}integrate(e,g,t,I){void 0===I&&(I=new bb);const n=e.x*t.x,i=e.y*t.y,C=e.z*t.z,o=this.x,a=this.y,s=this.z,l=this.w,r=.5*g;return I.x+=r*(n*l+i*s-C*a),I.y+=r*(i*l+C*o-n*s),I.z+=r*(C*l+n*a-i*o),I.w+=r*(-n*o-i*a-C*s),I}}const mb=new sb,pb=new sb;class Gb{constructor(e){void 0===e&&(e={}),this.id=Gb.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}updateBoundingSphereRadius(){throw`computeBoundingSphereRadius() not implemented for shape type ${this.type}`}volume(){throw`volume() not implemented for shape type ${this.type}`}calculateLocalInertia(e,g){throw`calculateLocalInertia() not implemented for shape type ${this.type}`}calculateWorldAABB(e,g,t,I){throw`calculateWorldAABB() not implemented for shape type ${this.type}`}}Gb.idCounter=0,Gb.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256};class Bb{constructor(e){void 0===e&&(e={}),this.position=new sb,this.quaternion=new bb,e.position&&this.position.copy(e.position),e.quaternion&&this.quaternion.copy(e.quaternion)}pointToLocal(e,g){return Bb.pointToLocalFrame(this.position,this.quaternion,e,g)}pointToWorld(e,g){return Bb.pointToWorldFrame(this.position,this.quaternion,e,g)}vectorToWorldFrame(e,g){return void 0===g&&(g=new sb),this.quaternion.vmult(e,g),g}static pointToLocalFrame(e,g,t,I){return void 0===I&&(I=new sb),t.vsub(e,I),g.conjugate(Zb),Zb.vmult(I,I),I}static pointToWorldFrame(e,g,t,I){return void 0===I&&(I=new sb),g.vmult(t,I),I.vadd(e,I),I}static vectorToWorldFrame(e,g,t){return void 0===t&&(t=new sb),e.vmult(g,t),t}static vectorToLocalFrame(e,g,t,I){return void 0===I&&(I=new sb),g.w*=-1,g.vmult(t,I),g.w*=-1,I}}const Zb=new bb;class yb extends Gb{constructor(e){void 0===e&&(e={});const{vertices:g=[],faces:t=[],normals:I=[],axes:n,boundingSphereRadius:i}=e;super({type:Gb.types.CONVEXPOLYHEDRON}),this.vertices=g,this.faces=t,this.faceNormals=I,0===this.faceNormals.length&&this.computeNormals(),i?this.boundingSphereRadius=i:this.updateBoundingSphereRadius(),this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.worldFaceNormals=[],this.worldFaceNormalsNeedsUpdate=!0,this.uniqueAxes=n?n.slice():null,this.uniqueEdges=[],this.computeEdges()}computeEdges(){const e=this.faces,g=this.vertices,t=this.uniqueEdges;t.length=0;const I=new sb;for(let n=0;n!==e.length;n++){const i=e[n],C=i.length;for(let e=0;e!==C;e++){const n=(e+1)%C;g[i[e]].vsub(g[i[n]],I),I.normalize();let o=!1;for(let e=0;e!==t.length;e++)if(t[e].almostEquals(I)||t[e].almostEquals(I)){o=!0;break}o||t.push(I.clone())}}}computeNormals(){this.faceNormals.length=this.faces.length;for(let e=0;e<this.faces.length;e++){for(let g=0;g<this.faces[e].length;g++)if(!this.vertices[this.faces[e][g]])throw new Error(`Vertex ${this.faces[e][g]} not found!`);const g=this.faceNormals[e]||new sb;this.getFaceNormal(e,g),g.negate(g),this.faceNormals[e]=g;const t=this.vertices[this.faces[e][0]];if(g.dot(t)<0){console.error(`.faceNormals[${e}] = Vec3(${g.toString()}) looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.`);for(let g=0;g<this.faces[e].length;g++)console.warn(`.vertices[${this.faces[e][g]}] = Vec3(${this.vertices[this.faces[e][g]].toString()})`)}}}getFaceNormal(e,g){const t=this.faces[e],I=this.vertices[t[0]],n=this.vertices[t[1]],i=this.vertices[t[2]];yb.computeNormal(I,n,i,g)}static computeNormal(e,g,t,I){const n=new sb,i=new sb;g.vsub(e,i),t.vsub(g,n),n.cross(i,I),I.isZero()||I.normalize()}clipAgainstHull(e,g,t,I,n,i,C,o,a){const s=new sb;let l=-1,r=-Number.MAX_VALUE;for(let e=0;e<t.faces.length;e++){s.copy(t.faceNormals[e]),n.vmult(s,s);const g=s.dot(i);g>r&&(r=g,l=e)}const A=[];for(let e=0;e<t.faces[l].length;e++){const g=t.vertices[t.faces[l][e]],i=new sb;i.copy(g),n.vmult(i,i),I.vadd(i,i),A.push(i)}l>=0&&this.clipFaceAgainstHull(i,e,g,A,C,o,a)}findSeparatingAxis(e,g,t,I,n,i,C,o){const a=new sb,s=new sb,l=new sb,r=new sb,A=new sb,c=new sb;let d=Number.MAX_VALUE;const u=this;if(u.uniqueAxes)for(let C=0;C!==u.uniqueAxes.length;C++){t.vmult(u.uniqueAxes[C],a);const o=u.testSepAxis(a,e,g,t,I,n);if(!1===o)return!1;o<d&&(d=o,i.copy(a))}else{const o=C?C.length:u.faces.length;for(let s=0;s<o;s++){const o=C?C[s]:s;a.copy(u.faceNormals[o]),t.vmult(a,a);const l=u.testSepAxis(a,e,g,t,I,n);if(!1===l)return!1;l<d&&(d=l,i.copy(a))}}if(e.uniqueAxes)for(let C=0;C!==e.uniqueAxes.length;C++){n.vmult(e.uniqueAxes[C],s);const o=u.testSepAxis(s,e,g,t,I,n);if(!1===o)return!1;o<d&&(d=o,i.copy(s))}else{const C=o?o.length:e.faces.length;for(let a=0;a<C;a++){const C=o?o[a]:a;s.copy(e.faceNormals[C]),n.vmult(s,s);const l=u.testSepAxis(s,e,g,t,I,n);if(!1===l)return!1;l<d&&(d=l,i.copy(s))}}for(let C=0;C!==u.uniqueEdges.length;C++){t.vmult(u.uniqueEdges[C],r);for(let C=0;C!==e.uniqueEdges.length;C++)if(n.vmult(e.uniqueEdges[C],A),r.cross(A,c),!c.almostZero()){c.normalize();const C=u.testSepAxis(c,e,g,t,I,n);if(!1===C)return!1;C<d&&(d=C,i.copy(c))}}return I.vsub(g,l),l.dot(i)>0&&i.negate(i),!0}testSepAxis(e,g,t,I,n,i){yb.project(this,e,t,I,vb),yb.project(g,e,n,i,Wb);const C=vb[0],o=vb[1],a=Wb[0],s=Wb[1];if(C<s||a<o)return!1;const l=C-s,r=a-o;return l<r?l:r}calculateLocalInertia(e,g){const t=new sb,I=new sb;this.computeLocalAABB(I,t);const n=t.x-I.x,i=t.y-I.y,C=t.z-I.z;g.x=1/12*e*(2*i*2*i+2*C*2*C),g.y=1/12*e*(2*n*2*n+2*C*2*C),g.z=1/12*e*(2*i*2*i+2*n*2*n)}getPlaneConstantOfFace(e){const g=this.faces[e],t=this.faceNormals[e],I=this.vertices[g[0]];return-t.dot(I)}clipFaceAgainstHull(e,g,t,I,n,i,C){const o=new sb,a=new sb,s=new sb,l=new sb,r=new sb,A=new sb,c=new sb,d=new sb,u=this,h=I,b=[];let m=-1,p=Number.MAX_VALUE;for(let g=0;g<u.faces.length;g++){o.copy(u.faceNormals[g]),t.vmult(o,o);const I=o.dot(e);I<p&&(p=I,m=g)}if(m<0)return;const G=u.faces[m];G.connectedFaces=[];for(let e=0;e<u.faces.length;e++)for(let g=0;g<u.faces[e].length;g++)-1!==G.indexOf(u.faces[e][g])&&e!==m&&-1===G.connectedFaces.indexOf(e)&&G.connectedFaces.push(e);const B=G.length;for(let e=0;e<B;e++){const I=u.vertices[G[e]],n=u.vertices[G[(e+1)%B]];I.vsub(n,a),s.copy(a),t.vmult(s,s),g.vadd(s,s),l.copy(this.faceNormals[m]),t.vmult(l,l),g.vadd(l,l),s.cross(l,r),r.negate(r),A.copy(I),t.vmult(A,A),g.vadd(A,A);const i=G.connectedFaces[e];c.copy(this.faceNormals[i]);const C=this.getPlaneConstantOfFace(i);d.copy(c),t.vmult(d,d);const o=C-d.dot(g);for(this.clipFaceAgainstPlane(h,b,d,o);h.length;)h.shift();for(;b.length;)h.push(b.shift())}c.copy(this.faceNormals[m]);const Z=this.getPlaneConstantOfFace(m);d.copy(c),t.vmult(d,d);const y=Z-d.dot(g);for(let e=0;e<h.length;e++){let g=d.dot(h[e])+y;if(g<=n&&(console.log(`clamped: depth=${g} to minDist=${n}`),g=n),g<=i){const t=h[e];if(g<=1e-6){const e={point:t,normal:d,depth:g};C.push(e)}}}}clipFaceAgainstPlane(e,g,t,I){let n,i;const C=e.length;if(C<2)return g;let o=e[e.length-1],a=e[0];n=t.dot(o)+I;for(let s=0;s<C;s++){if(a=e[s],i=t.dot(a)+I,n<0)if(i<0){const e=new sb;e.copy(a),g.push(e)}else{const e=new sb;o.lerp(a,n/(n-i),e),g.push(e)}else if(i<0){const e=new sb;o.lerp(a,n/(n-i),e),g.push(e),g.push(a)}o=a,n=i}return g}computeWorldVertices(e,g){for(;this.worldVertices.length<this.vertices.length;)this.worldVertices.push(new sb);const t=this.vertices,I=this.worldVertices;for(let n=0;n!==this.vertices.length;n++)g.vmult(t[n],I[n]),e.vadd(I[n],I[n]);this.worldVerticesNeedsUpdate=!1}computeLocalAABB(e,g){const t=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),g.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let I=0;I<this.vertices.length;I++){const n=t[I];n.x<e.x?e.x=n.x:n.x>g.x&&(g.x=n.x),n.y<e.y?e.y=n.y:n.y>g.y&&(g.y=n.y),n.z<e.z?e.z=n.z:n.z>g.z&&(g.z=n.z)}}computeWorldFaceNormals(e){const g=this.faceNormals.length;for(;this.worldFaceNormals.length<g;)this.worldFaceNormals.push(new sb);const t=this.faceNormals,I=this.worldFaceNormals;for(let n=0;n!==g;n++)e.vmult(t[n],I[n]);this.worldFaceNormalsNeedsUpdate=!1}updateBoundingSphereRadius(){let e=0;const g=this.vertices;for(let t=0;t!==g.length;t++){const I=g[t].lengthSquared();I>e&&(e=I)}this.boundingSphereRadius=Math.sqrt(e)}calculateWorldAABB(e,g,t,I){const n=this.vertices;let i,C,o,a,s,l,r=new sb;for(let t=0;t<n.length;t++){r.copy(n[t]),g.vmult(r,r),e.vadd(r,r);const I=r;(void 0===i||I.x<i)&&(i=I.x),(void 0===a||I.x>a)&&(a=I.x),(void 0===C||I.y<C)&&(C=I.y),(void 0===s||I.y>s)&&(s=I.y),(void 0===o||I.z<o)&&(o=I.z),(void 0===l||I.z>l)&&(l=I.z)}t.set(i,C,o),I.set(a,s,l)}volume(){return 4*Math.PI*this.boundingSphereRadius/3}getAveragePointLocal(e){void 0===e&&(e=new sb);const g=this.vertices;for(let t=0;t<g.length;t++)e.vadd(g[t],e);return e.scale(1/g.length,e),e}transformAllPoints(e,g){const t=this.vertices.length,I=this.vertices;if(g){for(let e=0;e<t;e++){const t=I[e];g.vmult(t,t)}for(let e=0;e<this.faceNormals.length;e++){const t=this.faceNormals[e];g.vmult(t,t)}}if(e)for(let g=0;g<t;g++){const t=I[g];t.vadd(e,t)}}pointIsInside(e){const g=this.vertices,t=this.faces,I=this.faceNormals,n=new sb;this.getAveragePointLocal(n);for(let i=0;i<this.faces.length;i++){let C=I[i];const o=g[t[i][0]],a=new sb;e.vsub(o,a);const s=C.dot(a),l=new sb;n.vsub(o,l);const r=C.dot(l);if(s<0&&r>0||s>0&&r<0)return!1}return-1}static project(e,g,t,I,n){const i=e.vertices.length,C=fb;let o=0,a=0;const s=wb,l=e.vertices;s.setZero(),Bb.vectorToLocalFrame(t,I,g,C),Bb.pointToLocalFrame(t,I,s,s);const r=s.dot(C);a=o=l[0].dot(C);for(let e=1;e<i;e++){const g=l[e].dot(C);g>o&&(o=g),g<a&&(a=g)}if(a-=r,o-=r,a>o){const e=a;a=o,o=e}n[0]=o,n[1]=a}}const vb=[],Wb=[];new sb;const fb=new sb,wb=new sb;class Rb extends Gb{constructor(e){super({type:Gb.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}updateConvexPolyhedronRepresentation(){const e=this.halfExtents.x,g=this.halfExtents.y,t=this.halfExtents.z,I=sb,n=[new I(-e,-g,-t),new I(e,-g,-t),new I(e,g,-t),new I(-e,g,-t),new I(-e,-g,t),new I(e,-g,t),new I(e,g,t),new I(-e,g,t)],i=[new I(0,0,1),new I(0,1,0),new I(1,0,0)],C=new yb({vertices:n,faces:[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],axes:i});this.convexPolyhedronRepresentation=C,C.material=this.material}calculateLocalInertia(e,g){return void 0===g&&(g=new sb),Rb.calculateInertia(this.halfExtents,e,g),g}static calculateInertia(e,g,t){const I=e;t.x=1/12*g*(2*I.y*2*I.y+2*I.z*2*I.z),t.y=1/12*g*(2*I.x*2*I.x+2*I.z*2*I.z),t.z=1/12*g*(2*I.y*2*I.y+2*I.x*2*I.x)}getSideNormals(e,g){const t=e,I=this.halfExtents;if(t[0].set(I.x,0,0),t[1].set(0,I.y,0),t[2].set(0,0,I.z),t[3].set(-I.x,0,0),t[4].set(0,-I.y,0),t[5].set(0,0,-I.z),void 0!==g)for(let e=0;e!==t.length;e++)g.vmult(t[e],t[e]);return t}volume(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z}updateBoundingSphereRadius(){this.boundingSphereRadius=this.halfExtents.length()}forEachWorldCorner(e,g,t){const I=this.halfExtents,n=[[I.x,I.y,I.z],[-I.x,I.y,I.z],[-I.x,-I.y,I.z],[-I.x,-I.y,-I.z],[I.x,-I.y,-I.z],[I.x,I.y,-I.z],[-I.x,I.y,-I.z],[I.x,-I.y,I.z]];for(let I=0;I<n.length;I++)Vb.set(n[I][0],n[I][1],n[I][2]),g.vmult(Vb,Vb),e.vadd(Vb,Vb),t(Vb.x,Vb.y,Vb.z)}calculateWorldAABB(e,g,t,I){const n=this.halfExtents;Xb[0].set(n.x,n.y,n.z),Xb[1].set(-n.x,n.y,n.z),Xb[2].set(-n.x,-n.y,n.z),Xb[3].set(-n.x,-n.y,-n.z),Xb[4].set(n.x,-n.y,-n.z),Xb[5].set(n.x,n.y,-n.z),Xb[6].set(-n.x,n.y,-n.z),Xb[7].set(n.x,-n.y,n.z);const i=Xb[0];g.vmult(i,i),e.vadd(i,i),I.copy(i),t.copy(i);for(let n=1;n<8;n++){const i=Xb[n];g.vmult(i,i),e.vadd(i,i);const C=i.x,o=i.y,a=i.z;C>I.x&&(I.x=C),o>I.y&&(I.y=o),a>I.z&&(I.z=a),C<t.x&&(t.x=C),o<t.y&&(t.y=o),a<t.z&&(t.z=a)}}}const Vb=new sb,Xb=[new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb];class Sb extends hb{constructor(e){void 0===e&&(e={}),super(),this.id=Sb.idCounter++,this.index=-1,this.world=null,this.vlambda=new sb,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse="boolean"!=typeof e.collisionResponse||e.collisionResponse,this.position=new sb,this.previousPosition=new sb,this.interpolatedPosition=new sb,this.initPosition=new sb,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new sb,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new sb,this.force=new sb;const g="number"==typeof e.mass?e.mass:0;this.mass=g,this.invMass=g>0?1/g:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=g<=0?Sb.STATIC:Sb.DYNAMIC,typeof e.type==typeof Sb.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=Sb.AWAKE,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this.wakeUpAfterNarrowphase=!1,this.torque=new sb,this.quaternion=new bb,this.initQuaternion=new bb,this.previousQuaternion=new bb,this.interpolatedQuaternion=new bb,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new sb,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new sb,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new sb,this.invInertia=new sb,this.invInertiaWorld=new ob,this.invMassSolve=0,this.invInertiaSolve=new sb,this.invInertiaWorldSolve=new ob,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new sb(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new sb(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new cb,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new sb,this.isTrigger=Boolean(e.isTrigger),e.shape&&this.addShape(e.shape),this.updateMassProperties()}wakeUp(){const e=this.sleepState;this.sleepState=Sb.AWAKE,this.wakeUpAfterNarrowphase=!1,e===Sb.SLEEPING&&this.dispatchEvent(Sb.wakeupEvent)}sleep(){this.sleepState=Sb.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.wakeUpAfterNarrowphase=!1}sleepTick(e){if(this.allowSleep){const g=this.sleepState,t=this.velocity.lengthSquared()+this.angularVelocity.lengthSquared(),I=this.sleepSpeedLimit**2;g===Sb.AWAKE&&t<I?(this.sleepState=Sb.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(Sb.sleepyEvent)):g===Sb.SLEEPY&&t>I?this.wakeUp():g===Sb.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(Sb.sleepEvent))}}updateSolveMassProperties(){this.sleepState===Sb.SLEEPING||this.type===Sb.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))}pointToLocalFrame(e,g){return void 0===g&&(g=new sb),e.vsub(this.position,g),this.quaternion.conjugate().vmult(g,g),g}vectorToLocalFrame(e,g){return void 0===g&&(g=new sb),this.quaternion.conjugate().vmult(e,g),g}pointToWorldFrame(e,g){return void 0===g&&(g=new sb),this.quaternion.vmult(e,g),g.vadd(this.position,g),g}vectorToWorldFrame(e,g){return void 0===g&&(g=new sb),this.quaternion.vmult(e,g),g}addShape(e,g,t){const I=new sb,n=new bb;return g&&I.copy(g),t&&n.copy(t),this.shapes.push(e),this.shapeOffsets.push(I),this.shapeOrientations.push(n),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=this,this}removeShape(e){const g=this.shapes.indexOf(e);return-1===g?(console.warn("Shape does not belong to the body"),this):(this.shapes.splice(g,1),this.shapeOffsets.splice(g,1),this.shapeOrientations.splice(g,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=null,this)}updateBoundingRadius(){const e=this.shapes,g=this.shapeOffsets,t=e.length;let I=0;for(let n=0;n!==t;n++){const t=e[n];t.updateBoundingSphereRadius();const i=g[n].length(),C=t.boundingSphereRadius;i+C>I&&(I=i+C)}this.boundingRadius=I}updateAABB(){const e=this.shapes,g=this.shapeOffsets,t=this.shapeOrientations,I=e.length,n=Yb,i=Kb,C=this.quaternion,o=this.aabb,a=Hb;for(let s=0;s!==I;s++){const I=e[s];C.vmult(g[s],n),n.vadd(this.position,n),C.mult(t[s],i),I.calculateWorldAABB(n,i,a.lowerBound,a.upperBound),0===s?o.copy(a):o.extend(a)}this.aabbNeedsUpdate=!1}updateInertiaWorld(e){const g=this.invInertia;if(g.x!==g.y||g.y!==g.z||e){const e=Nb,t=Fb;e.setRotationFromQuaternion(this.quaternion),e.transpose(t),e.scale(g,e),e.mmult(t,this.invInertiaWorld)}}applyForce(e,g){if(void 0===g&&(g=new sb),this.type!==Sb.DYNAMIC)return;this.sleepState===Sb.SLEEPING&&this.wakeUp();const t=xb;g.cross(e,t),this.force.vadd(e,this.force),this.torque.vadd(t,this.torque)}applyLocalForce(e,g){if(void 0===g&&(g=new sb),this.type!==Sb.DYNAMIC)return;const t=zb,I=kb;this.vectorToWorldFrame(e,t),this.vectorToWorldFrame(g,I),this.applyForce(t,I)}applyTorque(e){this.type===Sb.DYNAMIC&&(this.sleepState===Sb.SLEEPING&&this.wakeUp(),this.torque.vadd(e,this.torque))}applyImpulse(e,g){if(void 0===g&&(g=new sb),this.type!==Sb.DYNAMIC)return;this.sleepState===Sb.SLEEPING&&this.wakeUp();const t=g,I=Mb;I.copy(e),I.scale(this.invMass,I),this.velocity.vadd(I,this.velocity);const n=Lb;t.cross(e,n),this.invInertiaWorld.vmult(n,n),this.angularVelocity.vadd(n,this.angularVelocity)}applyLocalImpulse(e,g){if(void 0===g&&(g=new sb),this.type!==Sb.DYNAMIC)return;const t=Jb,I=Eb;this.vectorToWorldFrame(e,t),this.vectorToWorldFrame(g,I),this.applyImpulse(t,I)}updateMassProperties(){const e=Tb;this.invMass=this.mass>0?1/this.mass:0;const g=this.inertia,t=this.fixedRotation;this.updateAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),Rb.calculateInertia(e,this.mass,g),this.invInertia.set(g.x>0&&!t?1/g.x:0,g.y>0&&!t?1/g.y:0,g.z>0&&!t?1/g.z:0),this.updateInertiaWorld(!0)}getVelocityAtWorldPoint(e,g){const t=new sb;return e.vsub(this.position,t),this.angularVelocity.cross(t,g),this.velocity.vadd(g,g),g}integrate(e,g,t){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),this.type!==Sb.DYNAMIC&&this.type!==Sb.KINEMATIC||this.sleepState===Sb.SLEEPING)return;const I=this.velocity,n=this.angularVelocity,i=this.position,C=this.force,o=this.torque,a=this.quaternion,s=this.invMass,l=this.invInertiaWorld,r=this.linearFactor,A=s*e;I.x+=C.x*A*r.x,I.y+=C.y*A*r.y,I.z+=C.z*A*r.z;const c=l.elements,d=this.angularFactor,u=o.x*d.x,h=o.y*d.y,b=o.z*d.z;n.x+=e*(c[0]*u+c[1]*h+c[2]*b),n.y+=e*(c[3]*u+c[4]*h+c[5]*b),n.z+=e*(c[6]*u+c[7]*h+c[8]*b),i.x+=I.x*e,i.y+=I.y*e,i.z+=I.z*e,a.integrate(this.angularVelocity,e,this.angularFactor,a),g&&(t?a.normalizeFast():a.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}}Sb.idCounter=0,Sb.COLLIDE_EVENT_NAME="collide",Sb.DYNAMIC=1,Sb.STATIC=2,Sb.KINEMATIC=4,Sb.AWAKE=0,Sb.SLEEPY=1,Sb.SLEEPING=2,Sb.wakeupEvent={type:"wakeup"},Sb.sleepyEvent={type:"sleepy"},Sb.sleepEvent={type:"sleep"};const Yb=new sb,Kb=new bb,Hb=new cb,Nb=new ob,Fb=new ob;new ob;const xb=new sb,zb=new sb,kb=new sb,Mb=new sb,Lb=new sb,Jb=new sb,Eb=new sb,Tb=new sb;new sb,new sb,new bb,new sb,new sb,new sb,new sb;class Ub{constructor(){this.rayFromWorld=new sb,this.rayToWorld=new sb,this.hitNormalWorld=new sb,this.hitPointWorld=new sb,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}reset(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}abort(){this.shouldStop=!0}set(e,g,t,I,n,i,C){this.rayFromWorld.copy(e),this.rayToWorld.copy(g),this.hitNormalWorld.copy(t),this.hitPointWorld.copy(I),this.shape=n,this.body=i,this.distance=C}}let Qb,Db,Ob,jb,Pb,_b,qb;Qb=Gb.types.SPHERE,Db=Gb.types.PLANE,Ob=Gb.types.BOX,jb=Gb.types.CYLINDER,Pb=Gb.types.CONVEXPOLYHEDRON,_b=Gb.types.HEIGHTFIELD,qb=Gb.types.TRIMESH;class $b{get[Qb](){return this._intersectSphere}get[Db](){return this._intersectPlane}get[Ob](){return this._intersectBox}get[jb](){return this._intersectConvex}get[Pb](){return this._intersectConvex}get[_b](){return this._intersectHeightfield}get[qb](){return this._intersectTrimesh}constructor(e,g){void 0===e&&(e=new sb),void 0===g&&(g=new sb),this.from=e.clone(),this.to=g.clone(),this.direction=new sb,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=$b.ANY,this.result=new Ub,this.hasHit=!1,this.callback=e=>{}}intersectWorld(e,g){return this.mode=g.mode||$b.ANY,this.result=g.result||new Ub,this.skipBackfaces=!!g.skipBackfaces,this.collisionFilterMask=void 0!==g.collisionFilterMask?g.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==g.collisionFilterGroup?g.collisionFilterGroup:-1,this.checkCollisionResponse=void 0===g.checkCollisionResponse||g.checkCollisionResponse,g.from&&this.from.copy(g.from),g.to&&this.to.copy(g.to),this.callback=g.callback||(()=>{}),this.hasHit=!1,this.result.reset(),this.updateDirection(),this.getAABB(em),gm.length=0,e.broadphase.aabbQuery(e,em,gm),this.intersectBodies(gm),this.hasHit}intersectBody(e,g){g&&(this.result=g,this.updateDirection());const t=this.checkCollisionResponse;if(t&&!e.collisionResponse)return;if(0==(this.collisionFilterGroup&e.collisionFilterMask)||0==(e.collisionFilterGroup&this.collisionFilterMask))return;const I=nm,n=im;for(let g=0,i=e.shapes.length;g<i;g++){const i=e.shapes[g];if((!t||i.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[g],n),e.quaternion.vmult(e.shapeOffsets[g],I),I.vadd(e.position,I),this.intersectShape(i,n,I,e),this.result.shouldStop))break}}intersectBodies(e,g){g&&(this.result=g,this.updateDirection());for(let g=0,t=e.length;!this.result.shouldStop&&g<t;g++)this.intersectBody(e[g])}updateDirection(){this.to.vsub(this.from,this.direction),this.direction.normalize()}intersectShape(e,g,t,I){const n=function(e,g,t){t.vsub(e,fm);const I=fm.dot(g);g.scale(I,wm),wm.vadd(e,wm);return t.distanceTo(wm)}(this.from,this.direction,t);if(n>e.boundingSphereRadius)return;const i=this[e.type];i&&i.call(this,e,g,t,I,e)}_intersectBox(e,g,t,I,n){return this._intersectConvex(e.convexPolyhedronRepresentation,g,t,I,n)}_intersectPlane(e,g,t,I,n){const i=this.from,C=this.to,o=this.direction,a=new sb(0,0,1);g.vmult(a,a);const s=new sb;i.vsub(t,s);const l=s.dot(a);if(C.vsub(t,s),l*s.dot(a)>0)return;if(i.distanceTo(C)<l)return;const r=a.dot(o);if(Math.abs(r)<this.precision)return;const A=new sb,c=new sb,d=new sb;i.vsub(t,A);const u=-a.dot(A)/r;o.scale(u,c),i.vadd(c,d),this.reportIntersection(a,d,n,I,-1)}getAABB(e){const{lowerBound:g,upperBound:t}=e,I=this.to,n=this.from;g.x=Math.min(I.x,n.x),g.y=Math.min(I.y,n.y),g.z=Math.min(I.z,n.z),t.x=Math.max(I.x,n.x),t.y=Math.max(I.y,n.y),t.z=Math.max(I.z,n.z)}_intersectHeightfield(e,g,t,I,n){e.data,e.elementSize;const i=Am;i.from.copy(this.from),i.to.copy(this.to),Bb.pointToLocalFrame(t,g,i.from,i.from),Bb.pointToLocalFrame(t,g,i.to,i.to),i.updateDirection();const C=cm;let o,a,s,l;o=a=0,s=l=e.data.length-1;const r=new cb;i.getAABB(r),e.getIndexOfPosition(r.lowerBound.x,r.lowerBound.y,C,!0),o=Math.max(o,C[0]),a=Math.max(a,C[1]),e.getIndexOfPosition(r.upperBound.x,r.upperBound.y,C,!0),s=Math.min(s,C[0]+1),l=Math.min(l,C[1]+1);for(let C=o;C<s;C++)for(let o=a;o<l;o++){if(this.result.shouldStop)return;if(e.getAabbAtIndex(C,o,r),r.overlapsRay(i)){if(e.getConvexTrianglePillar(C,o,!1),Bb.pointToWorldFrame(t,g,e.pillarOffset,rm),this._intersectConvex(e.pillarConvex,g,rm,I,n,lm),this.result.shouldStop)return;e.getConvexTrianglePillar(C,o,!0),Bb.pointToWorldFrame(t,g,e.pillarOffset,rm),this._intersectConvex(e.pillarConvex,g,rm,I,n,lm)}}}_intersectSphere(e,g,t,I,n){const i=this.from,C=this.to,o=e.radius,a=(C.x-i.x)**2+(C.y-i.y)**2+(C.z-i.z)**2,s=2*((C.x-i.x)*(i.x-t.x)+(C.y-i.y)*(i.y-t.y)+(C.z-i.z)*(i.z-t.z)),l=s**2-4*a*((i.x-t.x)**2+(i.y-t.y)**2+(i.z-t.z)**2-o**2),r=dm,A=um;if(!(l<0))if(0===l)i.lerp(C,l,r),r.vsub(t,A),A.normalize(),this.reportIntersection(A,r,n,I,-1);else{const e=(-s-Math.sqrt(l))/(2*a),g=(-s+Math.sqrt(l))/(2*a);if(e>=0&&e<=1&&(i.lerp(C,e,r),r.vsub(t,A),A.normalize(),this.reportIntersection(A,r,n,I,-1)),this.result.shouldStop)return;g>=0&&g<=1&&(i.lerp(C,g,r),r.vsub(t,A),A.normalize(),this.reportIntersection(A,r,n,I,-1))}}_intersectConvex(e,g,t,I,n,i){const C=hm,o=bm,a=i&&i.faceList||null,s=e.faces,l=e.vertices,r=e.faceNormals,A=this.direction,c=this.from,d=this.to,u=c.distanceTo(d),h=a?a.length:s.length,b=this.result;for(let e=0;!b.shouldStop&&e<h;e++){const i=a?a[e]:e,d=s[i],h=r[i],m=g,p=t;o.copy(l[d[0]]),m.vmult(o,o),o.vadd(p,o),o.vsub(c,o),m.vmult(h,C);const G=A.dot(C);if(Math.abs(G)<this.precision)continue;const B=C.dot(o)/G;if(!(B<0)){A.scale(B,Cm),Cm.vadd(c,Cm),om.copy(l[d[0]]),m.vmult(om,om),p.vadd(om,om);for(let e=1;!b.shouldStop&&e<d.length-1;e++){am.copy(l[d[e]]),sm.copy(l[d[e+1]]),m.vmult(am,am),m.vmult(sm,sm),p.vadd(am,am),p.vadd(sm,sm);const g=Cm.distanceTo(c);!$b.pointInTriangle(Cm,om,am,sm)&&!$b.pointInTriangle(Cm,am,om,sm)||g>u||this.reportIntersection(C,Cm,n,I,i)}}}}_intersectTrimesh(e,g,t,I,n,i){const C=mm,o=vm,a=Wm,s=bm,l=pm,r=Gm,A=Bm,c=ym,d=Zm,u=e.indices;e.vertices;const h=this.from,b=this.to,m=this.direction;a.position.copy(t),a.quaternion.copy(g),Bb.vectorToLocalFrame(t,g,m,l),Bb.pointToLocalFrame(t,g,h,r),Bb.pointToLocalFrame(t,g,b,A),A.x*=e.scale.x,A.y*=e.scale.y,A.z*=e.scale.z,r.x*=e.scale.x,r.y*=e.scale.y,r.z*=e.scale.z,A.vsub(r,l),l.normalize();const p=r.distanceSquared(A);e.tree.rayQuery(this,a,o);for(let i=0,a=o.length;!this.result.shouldStop&&i!==a;i++){const a=o[i];e.getNormal(a,C),e.getVertex(u[3*a],om),om.vsub(r,s);const A=l.dot(C),h=C.dot(s)/A;if(h<0)continue;l.scale(h,Cm),Cm.vadd(r,Cm),e.getVertex(u[3*a+1],am),e.getVertex(u[3*a+2],sm);const b=Cm.distanceSquared(r);!$b.pointInTriangle(Cm,am,om,sm)&&!$b.pointInTriangle(Cm,om,am,sm)||b>p||(Bb.vectorToWorldFrame(g,C,d),Bb.pointToWorldFrame(t,g,Cm,c),this.reportIntersection(d,c,n,I,a))}o.length=0}reportIntersection(e,g,t,I,n){const i=this.from,C=this.to,o=i.distanceTo(g),a=this.result;if(!(this.skipBackfaces&&e.dot(this.direction)>0))switch(a.hitFaceIndex=void 0!==n?n:-1,this.mode){case $b.ALL:this.hasHit=!0,a.set(i,C,e,g,t,I,o),a.hasHit=!0,this.callback(a);break;case $b.CLOSEST:(o<a.distance||!a.hasHit)&&(this.hasHit=!0,a.hasHit=!0,a.set(i,C,e,g,t,I,o));break;case $b.ANY:this.hasHit=!0,a.hasHit=!0,a.set(i,C,e,g,t,I,o),a.shouldStop=!0}}static pointInTriangle(e,g,t,I){I.vsub(g,fm),t.vsub(g,tm),e.vsub(g,Im);const n=fm.dot(fm),i=fm.dot(tm),C=fm.dot(Im),o=tm.dot(tm),a=tm.dot(Im);let s,l;return(s=o*C-i*a)>=0&&(l=n*a-i*C)>=0&&s+l<n*o-i*i}}$b.CLOSEST=1,$b.ANY=2,$b.ALL=4;const em=new cb,gm=[],tm=new sb,Im=new sb,nm=new sb,im=new bb,Cm=new sb,om=new sb,am=new sb,sm=new sb;new sb,new Ub;const lm={faceList:[0]},rm=new sb,Am=new $b,cm=[],dm=new sb,um=new sb,hm=new sb;new sb,new sb;const bm=new sb,mm=new sb,pm=new sb,Gm=new sb,Bm=new sb,Zm=new sb,ym=new sb;new cb;const vm=[],Wm=new Bb,fm=new sb,wm=new sb;new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb;class Rm{constructor(e){void 0===e&&(e={});let g="";"string"==typeof e&&(g=e,e={}),this.name=g,this.id=Rm.idCounter++,this.friction=void 0!==e.friction?e.friction:-1,this.restitution=void 0!==e.restitution?e.restitution:-1}}Rm.idCounter=0,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new $b,new sb,new sb,new sb,new sb(1,0,0),new sb(0,1,0),new sb(0,0,1),new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new cb,new sb,new cb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new cb,new sb,new Bb,new cb,Gb.types.SPHERE,Gb.types.SPHERE,Gb.types.PLANE,Gb.types.BOX,Gb.types.BOX,Gb.types.SPHERE,Gb.types.BOX,Gb.types.PLANE,Gb.types.BOX,Gb.types.CONVEXPOLYHEDRON,Gb.types.SPHERE,Gb.types.CONVEXPOLYHEDRON,Gb.types.PLANE,Gb.types.CONVEXPOLYHEDRON,Gb.types.BOX,Gb.types.CONVEXPOLYHEDRON,Gb.types.SPHERE,Gb.types.HEIGHTFIELD,Gb.types.BOX,Gb.types.HEIGHTFIELD,Gb.types.CONVEXPOLYHEDRON,Gb.types.HEIGHTFIELD,Gb.types.PARTICLE,Gb.types.SPHERE,Gb.types.PLANE,Gb.types.PARTICLE,Gb.types.BOX,Gb.types.PARTICLE,Gb.types.PARTICLE,Gb.types.CONVEXPOLYHEDRON,Gb.types.CYLINDER,Gb.types.SPHERE,Gb.types.CYLINDER,Gb.types.PLANE,Gb.types.CYLINDER,Gb.types.BOX,Gb.types.CYLINDER,Gb.types.CONVEXPOLYHEDRON,Gb.types.CYLINDER,Gb.types.HEIGHTFIELD,Gb.types.CYLINDER,Gb.types.PARTICLE,Gb.types.CYLINDER,Gb.types.SPHERE,Gb.types.TRIMESH,Gb.types.PLANE,Gb.types.TRIMESH,new sb,new sb,new sb,new sb,new sb,new bb,new bb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new cb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new bb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new sb,new cb,new $b;const Vm=globalThis.performance||{};if(!Vm.now){let e=Date.now();Vm.timing&&Vm.timing.navigationStart&&(e=Vm.timing.navigationStart),Vm.now=()=>Date.now()-e}new sb;class Xm{constructor(e){void 0===e&&(e=[0,0,0,0,0,0,0,0,0]),this.elements=e}identity(){const e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}setZero(){const e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0}setTrace(e){const g=this.elements;g[0]=e.x,g[4]=e.y,g[8]=e.z}getTrace(e){void 0===e&&(e=new Ym);const g=this.elements;return e.x=g[0],e.y=g[4],e.z=g[8],e}vmult(e,g){void 0===g&&(g=new Ym);const t=this.elements,I=e.x,n=e.y,i=e.z;return g.x=t[0]*I+t[1]*n+t[2]*i,g.y=t[3]*I+t[4]*n+t[5]*i,g.z=t[6]*I+t[7]*n+t[8]*i,g}smult(e){for(let g=0;g<this.elements.length;g++)this.elements[g]*=e}mmult(e,g){void 0===g&&(g=new Xm);const t=this.elements,I=e.elements,n=g.elements,i=t[0],C=t[1],o=t[2],a=t[3],s=t[4],l=t[5],r=t[6],A=t[7],c=t[8],d=I[0],u=I[1],h=I[2],b=I[3],m=I[4],p=I[5],G=I[6],B=I[7],Z=I[8];return n[0]=i*d+C*b+o*G,n[1]=i*u+C*m+o*B,n[2]=i*h+C*p+o*Z,n[3]=a*d+s*b+l*G,n[4]=a*u+s*m+l*B,n[5]=a*h+s*p+l*Z,n[6]=r*d+A*b+c*G,n[7]=r*u+A*m+c*B,n[8]=r*h+A*p+c*Z,g}scale(e,g){void 0===g&&(g=new Xm);const t=this.elements,I=g.elements;for(let g=0;3!==g;g++)I[3*g+0]=e.x*t[3*g+0],I[3*g+1]=e.y*t[3*g+1],I[3*g+2]=e.z*t[3*g+2];return g}solve(e,g){void 0===g&&(g=new Ym);const t=[];let I,n;for(I=0;I<12;I++)t.push(0);for(I=0;I<3;I++)for(n=0;n<3;n++)t[I+4*n]=this.elements[I+3*n];t[3]=e.x,t[7]=e.y,t[11]=e.z;let i=3;const C=i;let o,a;do{if(I=C-i,0===t[I+4*I])for(n=I+1;n<C;n++)if(0!==t[I+4*n]){o=4;do{a=4-o,t[a+4*I]+=t[a+4*n]}while(--o);break}if(0!==t[I+4*I])for(n=I+1;n<C;n++){const e=t[I+4*n]/t[I+4*I];o=4;do{a=4-o,t[a+4*n]=a<=I?0:t[a+4*n]-t[a+4*I]*e}while(--o)}}while(--i);if(g.z=t[11]/t[10],g.y=(t[7]-t[6]*g.z)/t[5],g.x=(t[3]-t[2]*g.z-t[1]*g.y)/t[0],isNaN(g.x)||isNaN(g.y)||isNaN(g.z)||g.x===1/0||g.y===1/0||g.z===1/0)throw`Could not solve equation! Got x=[${g.toString()}], b=[${e.toString()}], A=[${this.toString()}]`;return g}e(e,g,t){if(void 0===t)return this.elements[g+3*e];this.elements[g+3*e]=t}copy(e){for(let g=0;g<e.elements.length;g++)this.elements[g]=e.elements[g];return this}toString(){let e="";for(let g=0;g<9;g++)e+=this.elements[g]+",";return e}reverse(e){void 0===e&&(e=new Xm);const g=Sm;let t,I;for(t=0;t<3;t++)for(I=0;I<3;I++)g[t+6*I]=this.elements[t+3*I];g[3]=1,g[9]=0,g[15]=0,g[4]=0,g[10]=1,g[16]=0,g[5]=0,g[11]=0,g[17]=1;let n=3;const i=n;let C,o;do{if(t=i-n,0===g[t+6*t])for(I=t+1;I<i;I++)if(0!==g[t+6*I]){C=6;do{o=6-C,g[o+6*t]+=g[o+6*I]}while(--C);break}if(0!==g[t+6*t])for(I=t+1;I<i;I++){const e=g[t+6*I]/g[t+6*t];C=6;do{o=6-C,g[o+6*I]=o<=t?0:g[o+6*I]-g[o+6*t]*e}while(--C)}}while(--n);t=2;do{I=t-1;do{const e=g[t+6*I]/g[t+6*t];C=6;do{o=6-C,g[o+6*I]=g[o+6*I]-g[o+6*t]*e}while(--C)}while(I--)}while(--t);t=2;do{const e=1/g[t+6*t];C=6;do{o=6-C,g[o+6*t]=g[o+6*t]*e}while(--C)}while(t--);t=2;do{I=2;do{if(o=g[3+I+6*t],isNaN(o)||o===1/0)throw`Could not reverse! A=[${this.toString()}]`;e.e(t,I,o)}while(I--)}while(t--);return e}setRotationFromQuaternion(e){const g=e.x,t=e.y,I=e.z,n=e.w,i=g+g,C=t+t,o=I+I,a=g*i,s=g*C,l=g*o,r=t*C,A=t*o,c=I*o,d=n*i,u=n*C,h=n*o,b=this.elements;return b[0]=1-(r+c),b[1]=s-h,b[2]=l+u,b[3]=s+h,b[4]=1-(a+c),b[5]=A-d,b[6]=l-u,b[7]=A+d,b[8]=1-(a+r),this}transpose(e){void 0===e&&(e=new Xm);const g=this.elements,t=e.elements;let I;return t[0]=g[0],t[4]=g[4],t[8]=g[8],I=g[1],t[1]=g[3],t[3]=I,I=g[2],t[2]=g[6],t[6]=I,I=g[5],t[5]=g[7],t[7]=I,e}}const Sm=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];class Ym{constructor(e,g,t){void 0===e&&(e=0),void 0===g&&(g=0),void 0===t&&(t=0),this.x=e,this.y=g,this.z=t}cross(e,g){void 0===g&&(g=new Ym);const t=e.x,I=e.y,n=e.z,i=this.x,C=this.y,o=this.z;return g.x=C*n-o*I,g.y=o*t-i*n,g.z=i*I-C*t,g}set(e,g,t){return this.x=e,this.y=g,this.z=t,this}setZero(){this.x=this.y=this.z=0}vadd(e,g){if(!g)return new Ym(this.x+e.x,this.y+e.y,this.z+e.z);g.x=e.x+this.x,g.y=e.y+this.y,g.z=e.z+this.z}vsub(e,g){if(!g)return new Ym(this.x-e.x,this.y-e.y,this.z-e.z);g.x=this.x-e.x,g.y=this.y-e.y,g.z=this.z-e.z}crossmat(){return new Xm([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])}normalize(){const e=this.x,g=this.y,t=this.z,I=Math.sqrt(e*e+g*g+t*t);if(I>0){const e=1/I;this.x*=e,this.y*=e,this.z*=e}else this.x=0,this.y=0,this.z=0;return I}unit(e){void 0===e&&(e=new Ym);const g=this.x,t=this.y,I=this.z;let n=Math.sqrt(g*g+t*t+I*I);return n>0?(n=1/n,e.x=g*n,e.y=t*n,e.z=I*n):(e.x=1,e.y=0,e.z=0),e}length(){const e=this.x,g=this.y,t=this.z;return Math.sqrt(e*e+g*g+t*t)}lengthSquared(){return this.dot(this)}distanceTo(e){const g=this.x,t=this.y,I=this.z,n=e.x,i=e.y,C=e.z;return Math.sqrt((n-g)*(n-g)+(i-t)*(i-t)+(C-I)*(C-I))}distanceSquared(e){const g=this.x,t=this.y,I=this.z,n=e.x,i=e.y,C=e.z;return(n-g)*(n-g)+(i-t)*(i-t)+(C-I)*(C-I)}scale(e,g){void 0===g&&(g=new Ym);const t=this.x,I=this.y,n=this.z;return g.x=e*t,g.y=e*I,g.z=e*n,g}vmul(e,g){return void 0===g&&(g=new Ym),g.x=e.x*this.x,g.y=e.y*this.y,g.z=e.z*this.z,g}addScaledVector(e,g,t){return void 0===t&&(t=new Ym),t.x=this.x+e*g.x,t.y=this.y+e*g.y,t.z=this.z+e*g.z,t}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}isZero(){return 0===this.x&&0===this.y&&0===this.z}negate(e){return void 0===e&&(e=new Ym),e.x=-this.x,e.y=-this.y,e.z=-this.z,e}tangents(e,g){const t=this.length();if(t>0){const I=Km,n=1/t;I.set(this.x*n,this.y*n,this.z*n);const i=Hm;Math.abs(I.x)<.9?(i.set(1,0,0),I.cross(i,e)):(i.set(0,1,0),I.cross(i,e)),I.cross(e,g)}else e.set(1,0,0),g.set(0,1,0)}toString(){return`${this.x},${this.y},${this.z}`}toArray(){return[this.x,this.y,this.z]}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}lerp(e,g,t){const I=this.x,n=this.y,i=this.z;t.x=I+(e.x-I)*g,t.y=n+(e.y-n)*g,t.z=i+(e.z-i)*g}almostEquals(e,g){return void 0===g&&(g=1e-6),!(Math.abs(this.x-e.x)>g||Math.abs(this.y-e.y)>g||Math.abs(this.z-e.z)>g)}almostZero(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)}isAntiparallelTo(e,g){return this.negate(Nm),Nm.almostEquals(e,g)}clone(){return new Ym(this.x,this.y,this.z)}}Ym.ZERO=new Ym(0,0,0),Ym.UNIT_X=new Ym(1,0,0),Ym.UNIT_Y=new Ym(0,1,0),Ym.UNIT_Z=new Ym(0,0,1);const Km=new Ym,Hm=new Ym,Nm=new Ym;class Fm{constructor(e){void 0===e&&(e={}),this.lowerBound=new Ym,this.upperBound=new Ym,e.lowerBound&&this.lowerBound.copy(e.lowerBound),e.upperBound&&this.upperBound.copy(e.upperBound)}setFromPoints(e,g,t,I){const n=this.lowerBound,i=this.upperBound,C=t;n.copy(e[0]),C&&C.vmult(n,n),i.copy(n);for(let g=1;g<e.length;g++){let t=e[g];C&&(C.vmult(t,xm),t=xm),t.x>i.x&&(i.x=t.x),t.x<n.x&&(n.x=t.x),t.y>i.y&&(i.y=t.y),t.y<n.y&&(n.y=t.y),t.z>i.z&&(i.z=t.z),t.z<n.z&&(n.z=t.z)}return g&&(g.vadd(n,n),g.vadd(i,i)),I&&(n.x-=I,n.y-=I,n.z-=I,i.x+=I,i.y+=I,i.z+=I),this}copy(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this}clone(){return(new Fm).copy(this)}extend(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)}overlaps(e){const g=this.lowerBound,t=this.upperBound,I=e.lowerBound,n=e.upperBound,i=I.x<=t.x&&t.x<=n.x||g.x<=n.x&&n.x<=t.x,C=I.y<=t.y&&t.y<=n.y||g.y<=n.y&&n.y<=t.y,o=I.z<=t.z&&t.z<=n.z||g.z<=n.z&&n.z<=t.z;return i&&C&&o}volume(){const e=this.lowerBound,g=this.upperBound;return(g.x-e.x)*(g.y-e.y)*(g.z-e.z)}contains(e){const g=this.lowerBound,t=this.upperBound,I=e.lowerBound,n=e.upperBound;return g.x<=I.x&&t.x>=n.x&&g.y<=I.y&&t.y>=n.y&&g.z<=I.z&&t.z>=n.z}getCorners(e,g,t,I,n,i,C,o){const a=this.lowerBound,s=this.upperBound;e.copy(a),g.set(s.x,a.y,a.z),t.set(s.x,s.y,a.z),I.set(a.x,s.y,s.z),n.set(s.x,a.y,s.z),i.set(a.x,s.y,a.z),C.set(a.x,a.y,s.z),o.copy(s)}toLocalFrame(e,g){const t=zm,I=t[0],n=t[1],i=t[2],C=t[3],o=t[4],a=t[5],s=t[6],l=t[7];this.getCorners(I,n,i,C,o,a,s,l);for(let g=0;8!==g;g++){const I=t[g];e.pointToLocal(I,I)}return g.setFromPoints(t)}toWorldFrame(e,g){const t=zm,I=t[0],n=t[1],i=t[2],C=t[3],o=t[4],a=t[5],s=t[6],l=t[7];this.getCorners(I,n,i,C,o,a,s,l);for(let g=0;8!==g;g++){const I=t[g];e.pointToWorld(I,I)}return g.setFromPoints(t)}overlapsRay(e){const{direction:g,from:t}=e,I=1/g.x,n=1/g.y,i=1/g.z,C=(this.lowerBound.x-t.x)*I,o=(this.upperBound.x-t.x)*I,a=(this.lowerBound.y-t.y)*n,s=(this.upperBound.y-t.y)*n,l=(this.lowerBound.z-t.z)*i,r=(this.upperBound.z-t.z)*i,A=Math.max(Math.max(Math.min(C,o),Math.min(a,s)),Math.min(l,r)),c=Math.min(Math.min(Math.max(C,o),Math.max(a,s)),Math.max(l,r));return!(c<0||A>c)}}const xm=new Ym,zm=[new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym];class km{constructor(e,g,t,I){void 0===e&&(e=0),void 0===g&&(g=0),void 0===t&&(t=0),void 0===I&&(I=1),this.x=e,this.y=g,this.z=t,this.w=I}set(e,g,t,I){return this.x=e,this.y=g,this.z=t,this.w=I,this}toString(){return`${this.x},${this.y},${this.z},${this.w}`}toArray(){return[this.x,this.y,this.z,this.w]}setFromAxisAngle(e,g){const t=Math.sin(.5*g);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=Math.cos(.5*g),this}toAxisAngle(e){void 0===e&&(e=new Ym),this.normalize();const g=2*Math.acos(this.w),t=Math.sqrt(1-this.w*this.w);return t<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/t,e.y=this.y/t,e.z=this.z/t),[e,g]}setFromVectors(e,g){if(e.isAntiparallelTo(g)){const g=Mm,t=Lm;e.tangents(g,t),this.setFromAxisAngle(g,Math.PI)}else{const t=e.cross(g);this.x=t.x,this.y=t.y,this.z=t.z,this.w=Math.sqrt(e.length()**2*g.length()**2)+e.dot(g),this.normalize()}return this}mult(e,g){void 0===g&&(g=new km);const t=this.x,I=this.y,n=this.z,i=this.w,C=e.x,o=e.y,a=e.z,s=e.w;return g.x=t*s+i*C+I*a-n*o,g.y=I*s+i*o+n*C-t*a,g.z=n*s+i*a+t*o-I*C,g.w=i*s-t*C-I*o-n*a,g}inverse(e){void 0===e&&(e=new km);const g=this.x,t=this.y,I=this.z,n=this.w;this.conjugate(e);const i=1/(g*g+t*t+I*I+n*n);return e.x*=i,e.y*=i,e.z*=i,e.w*=i,e}conjugate(e){return void 0===e&&(e=new km),e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e}normalize(){let e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this}normalizeFast(){const e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this}vmult(e,g){void 0===g&&(g=new Ym);const t=e.x,I=e.y,n=e.z,i=this.x,C=this.y,o=this.z,a=this.w,s=a*t+C*n-o*I,l=a*I+o*t-i*n,r=a*n+i*I-C*t,A=-i*t-C*I-o*n;return g.x=s*a+A*-i+l*-o-r*-C,g.y=l*a+A*-C+r*-i-s*-o,g.z=r*a+A*-o+s*-C-l*-i,g}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}toEuler(e,g){let t,I,n;void 0===g&&(g="YZX");const i=this.x,C=this.y,o=this.z,a=this.w;if("YZX"!==g)throw new Error(`Euler order ${g} not supported yet.`);{const e=i*C+o*a;if(e>.499&&(t=2*Math.atan2(i,a),I=Math.PI/2,n=0),e<-.499&&(t=-2*Math.atan2(i,a),I=-Math.PI/2,n=0),void 0===t){const g=i*i,s=C*C,l=o*o;t=Math.atan2(2*C*a-2*i*o,1-2*s-2*l),I=Math.asin(2*e),n=Math.atan2(2*i*a-2*C*o,1-2*g-2*l)}}e.y=t,e.z=I,e.x=n}setFromEuler(e,g,t,I){void 0===I&&(I="XYZ");const n=Math.cos(e/2),i=Math.cos(g/2),C=Math.cos(t/2),o=Math.sin(e/2),a=Math.sin(g/2),s=Math.sin(t/2);return"XYZ"===I?(this.x=o*i*C+n*a*s,this.y=n*a*C-o*i*s,this.z=n*i*s+o*a*C,this.w=n*i*C-o*a*s):"YXZ"===I?(this.x=o*i*C+n*a*s,this.y=n*a*C-o*i*s,this.z=n*i*s-o*a*C,this.w=n*i*C+o*a*s):"ZXY"===I?(this.x=o*i*C-n*a*s,this.y=n*a*C+o*i*s,this.z=n*i*s+o*a*C,this.w=n*i*C-o*a*s):"ZYX"===I?(this.x=o*i*C-n*a*s,this.y=n*a*C+o*i*s,this.z=n*i*s-o*a*C,this.w=n*i*C+o*a*s):"YZX"===I?(this.x=o*i*C+n*a*s,this.y=n*a*C+o*i*s,this.z=n*i*s-o*a*C,this.w=n*i*C-o*a*s):"XZY"===I&&(this.x=o*i*C-n*a*s,this.y=n*a*C-o*i*s,this.z=n*i*s+o*a*C,this.w=n*i*C+o*a*s),this}clone(){return new km(this.x,this.y,this.z,this.w)}slerp(e,g,t){void 0===t&&(t=new km);const I=this.x,n=this.y,i=this.z,C=this.w;let o,a,s,l,r,A=e.x,c=e.y,d=e.z,u=e.w;return a=I*A+n*c+i*d+C*u,a<0&&(a=-a,A=-A,c=-c,d=-d,u=-u),1-a>1e-6?(o=Math.acos(a),s=Math.sin(o),l=Math.sin((1-g)*o)/s,r=Math.sin(g*o)/s):(l=1-g,r=g),t.x=l*I+r*A,t.y=l*n+r*c,t.z=l*i+r*d,t.w=l*C+r*u,t}integrate(e,g,t,I){void 0===I&&(I=new km);const n=e.x*t.x,i=e.y*t.y,C=e.z*t.z,o=this.x,a=this.y,s=this.z,l=this.w,r=.5*g;return I.x+=r*(n*l+i*s-C*a),I.y+=r*(i*l+C*o-n*s),I.z+=r*(C*l+n*a-i*o),I.w+=r*(-n*o-i*a-C*s),I}}const Mm=new Ym,Lm=new Ym;class Jm{constructor(e){void 0===e&&(e={}),this.id=Jm.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}updateBoundingSphereRadius(){throw`computeBoundingSphereRadius() not implemented for shape type ${this.type}`}volume(){throw`volume() not implemented for shape type ${this.type}`}calculateLocalInertia(e,g){throw`calculateLocalInertia() not implemented for shape type ${this.type}`}calculateWorldAABB(e,g,t,I){throw`calculateWorldAABB() not implemented for shape type ${this.type}`}}Jm.idCounter=0,Jm.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256};class Em{constructor(e){void 0===e&&(e={}),this.position=new Ym,this.quaternion=new km,e.position&&this.position.copy(e.position),e.quaternion&&this.quaternion.copy(e.quaternion)}pointToLocal(e,g){return Em.pointToLocalFrame(this.position,this.quaternion,e,g)}pointToWorld(e,g){return Em.pointToWorldFrame(this.position,this.quaternion,e,g)}vectorToWorldFrame(e,g){return void 0===g&&(g=new Ym),this.quaternion.vmult(e,g),g}static pointToLocalFrame(e,g,t,I){return void 0===I&&(I=new Ym),t.vsub(e,I),g.conjugate(Tm),Tm.vmult(I,I),I}static pointToWorldFrame(e,g,t,I){return void 0===I&&(I=new Ym),g.vmult(t,I),I.vadd(e,I),I}static vectorToWorldFrame(e,g,t){return void 0===t&&(t=new Ym),e.vmult(g,t),t}static vectorToLocalFrame(e,g,t,I){return void 0===I&&(I=new Ym),g.w*=-1,g.vmult(t,I),g.w*=-1,I}}const Tm=new km;new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new km,new Fm,new Xm,new Xm,new Xm,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new km,new Ym,new Ym,new Ym,new Ym;class Um{constructor(){this.rayFromWorld=new Ym,this.rayToWorld=new Ym,this.hitNormalWorld=new Ym,this.hitPointWorld=new Ym,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}reset(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}abort(){this.shouldStop=!0}set(e,g,t,I,n,i,C){this.rayFromWorld.copy(e),this.rayToWorld.copy(g),this.hitNormalWorld.copy(t),this.hitPointWorld.copy(I),this.shape=n,this.body=i,this.distance=C}}let Qm,Dm,Om,jm,Pm,_m,qm;Qm=Jm.types.SPHERE,Dm=Jm.types.PLANE,Om=Jm.types.BOX,jm=Jm.types.CYLINDER,Pm=Jm.types.CONVEXPOLYHEDRON,_m=Jm.types.HEIGHTFIELD,qm=Jm.types.TRIMESH;class $m{get[Qm](){return this._intersectSphere}get[Dm](){return this._intersectPlane}get[Om](){return this._intersectBox}get[jm](){return this._intersectConvex}get[Pm](){return this._intersectConvex}get[_m](){return this._intersectHeightfield}get[qm](){return this._intersectTrimesh}constructor(e,g){void 0===e&&(e=new Ym),void 0===g&&(g=new Ym),this.from=e.clone(),this.to=g.clone(),this.direction=new Ym,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=$m.ANY,this.result=new Um,this.hasHit=!1,this.callback=e=>{}}intersectWorld(e,g){return this.mode=g.mode||$m.ANY,this.result=g.result||new Um,this.skipBackfaces=!!g.skipBackfaces,this.collisionFilterMask=void 0!==g.collisionFilterMask?g.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==g.collisionFilterGroup?g.collisionFilterGroup:-1,this.checkCollisionResponse=void 0===g.checkCollisionResponse||g.checkCollisionResponse,g.from&&this.from.copy(g.from),g.to&&this.to.copy(g.to),this.callback=g.callback||(()=>{}),this.hasHit=!1,this.result.reset(),this.updateDirection(),this.getAABB(ep),gp.length=0,e.broadphase.aabbQuery(e,ep,gp),this.intersectBodies(gp),this.hasHit}intersectBody(e,g){g&&(this.result=g,this.updateDirection());const t=this.checkCollisionResponse;if(t&&!e.collisionResponse)return;if(0==(this.collisionFilterGroup&e.collisionFilterMask)||0==(e.collisionFilterGroup&this.collisionFilterMask))return;const I=np,n=ip;for(let g=0,i=e.shapes.length;g<i;g++){const i=e.shapes[g];if((!t||i.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[g],n),e.quaternion.vmult(e.shapeOffsets[g],I),I.vadd(e.position,I),this.intersectShape(i,n,I,e),this.result.shouldStop))break}}intersectBodies(e,g){g&&(this.result=g,this.updateDirection());for(let g=0,t=e.length;!this.result.shouldStop&&g<t;g++)this.intersectBody(e[g])}updateDirection(){this.to.vsub(this.from,this.direction),this.direction.normalize()}intersectShape(e,g,t,I){const n=function(e,g,t){t.vsub(e,fp);const I=fp.dot(g);g.scale(I,wp),wp.vadd(e,wp);return t.distanceTo(wp)}(this.from,this.direction,t);if(n>e.boundingSphereRadius)return;const i=this[e.type];i&&i.call(this,e,g,t,I,e)}_intersectBox(e,g,t,I,n){return this._intersectConvex(e.convexPolyhedronRepresentation,g,t,I,n)}_intersectPlane(e,g,t,I,n){const i=this.from,C=this.to,o=this.direction,a=new Ym(0,0,1);g.vmult(a,a);const s=new Ym;i.vsub(t,s);const l=s.dot(a);if(C.vsub(t,s),l*s.dot(a)>0)return;if(i.distanceTo(C)<l)return;const r=a.dot(o);if(Math.abs(r)<this.precision)return;const A=new Ym,c=new Ym,d=new Ym;i.vsub(t,A);const u=-a.dot(A)/r;o.scale(u,c),i.vadd(c,d),this.reportIntersection(a,d,n,I,-1)}getAABB(e){const{lowerBound:g,upperBound:t}=e,I=this.to,n=this.from;g.x=Math.min(I.x,n.x),g.y=Math.min(I.y,n.y),g.z=Math.min(I.z,n.z),t.x=Math.max(I.x,n.x),t.y=Math.max(I.y,n.y),t.z=Math.max(I.z,n.z)}_intersectHeightfield(e,g,t,I,n){e.data,e.elementSize;const i=Ap;i.from.copy(this.from),i.to.copy(this.to),Em.pointToLocalFrame(t,g,i.from,i.from),Em.pointToLocalFrame(t,g,i.to,i.to),i.updateDirection();const C=cp;let o,a,s,l;o=a=0,s=l=e.data.length-1;const r=new Fm;i.getAABB(r),e.getIndexOfPosition(r.lowerBound.x,r.lowerBound.y,C,!0),o=Math.max(o,C[0]),a=Math.max(a,C[1]),e.getIndexOfPosition(r.upperBound.x,r.upperBound.y,C,!0),s=Math.min(s,C[0]+1),l=Math.min(l,C[1]+1);for(let C=o;C<s;C++)for(let o=a;o<l;o++){if(this.result.shouldStop)return;if(e.getAabbAtIndex(C,o,r),r.overlapsRay(i)){if(e.getConvexTrianglePillar(C,o,!1),Em.pointToWorldFrame(t,g,e.pillarOffset,rp),this._intersectConvex(e.pillarConvex,g,rp,I,n,lp),this.result.shouldStop)return;e.getConvexTrianglePillar(C,o,!0),Em.pointToWorldFrame(t,g,e.pillarOffset,rp),this._intersectConvex(e.pillarConvex,g,rp,I,n,lp)}}}_intersectSphere(e,g,t,I,n){const i=this.from,C=this.to,o=e.radius,a=(C.x-i.x)**2+(C.y-i.y)**2+(C.z-i.z)**2,s=2*((C.x-i.x)*(i.x-t.x)+(C.y-i.y)*(i.y-t.y)+(C.z-i.z)*(i.z-t.z)),l=s**2-4*a*((i.x-t.x)**2+(i.y-t.y)**2+(i.z-t.z)**2-o**2),r=dp,A=up;if(!(l<0))if(0===l)i.lerp(C,l,r),r.vsub(t,A),A.normalize(),this.reportIntersection(A,r,n,I,-1);else{const e=(-s-Math.sqrt(l))/(2*a),g=(-s+Math.sqrt(l))/(2*a);if(e>=0&&e<=1&&(i.lerp(C,e,r),r.vsub(t,A),A.normalize(),this.reportIntersection(A,r,n,I,-1)),this.result.shouldStop)return;g>=0&&g<=1&&(i.lerp(C,g,r),r.vsub(t,A),A.normalize(),this.reportIntersection(A,r,n,I,-1))}}_intersectConvex(e,g,t,I,n,i){const C=hp,o=bp,a=i&&i.faceList||null,s=e.faces,l=e.vertices,r=e.faceNormals,A=this.direction,c=this.from,d=this.to,u=c.distanceTo(d),h=a?a.length:s.length,b=this.result;for(let e=0;!b.shouldStop&&e<h;e++){const i=a?a[e]:e,d=s[i],h=r[i],m=g,p=t;o.copy(l[d[0]]),m.vmult(o,o),o.vadd(p,o),o.vsub(c,o),m.vmult(h,C);const G=A.dot(C);if(Math.abs(G)<this.precision)continue;const B=C.dot(o)/G;if(!(B<0)){A.scale(B,Cp),Cp.vadd(c,Cp),op.copy(l[d[0]]),m.vmult(op,op),p.vadd(op,op);for(let e=1;!b.shouldStop&&e<d.length-1;e++){ap.copy(l[d[e]]),sp.copy(l[d[e+1]]),m.vmult(ap,ap),m.vmult(sp,sp),p.vadd(ap,ap),p.vadd(sp,sp);const g=Cp.distanceTo(c);!$m.pointInTriangle(Cp,op,ap,sp)&&!$m.pointInTriangle(Cp,ap,op,sp)||g>u||this.reportIntersection(C,Cp,n,I,i)}}}}_intersectTrimesh(e,g,t,I,n,i){const C=mp,o=vp,a=Wp,s=bp,l=pp,r=Gp,A=Bp,c=yp,d=Zp,u=e.indices;e.vertices;const h=this.from,b=this.to,m=this.direction;a.position.copy(t),a.quaternion.copy(g),Em.vectorToLocalFrame(t,g,m,l),Em.pointToLocalFrame(t,g,h,r),Em.pointToLocalFrame(t,g,b,A),A.x*=e.scale.x,A.y*=e.scale.y,A.z*=e.scale.z,r.x*=e.scale.x,r.y*=e.scale.y,r.z*=e.scale.z,A.vsub(r,l),l.normalize();const p=r.distanceSquared(A);e.tree.rayQuery(this,a,o);for(let i=0,a=o.length;!this.result.shouldStop&&i!==a;i++){const a=o[i];e.getNormal(a,C),e.getVertex(u[3*a],op),op.vsub(r,s);const A=l.dot(C),h=C.dot(s)/A;if(h<0)continue;l.scale(h,Cp),Cp.vadd(r,Cp),e.getVertex(u[3*a+1],ap),e.getVertex(u[3*a+2],sp);const b=Cp.distanceSquared(r);!$m.pointInTriangle(Cp,ap,op,sp)&&!$m.pointInTriangle(Cp,op,ap,sp)||b>p||(Em.vectorToWorldFrame(g,C,d),Em.pointToWorldFrame(t,g,Cp,c),this.reportIntersection(d,c,n,I,a))}o.length=0}reportIntersection(e,g,t,I,n){const i=this.from,C=this.to,o=i.distanceTo(g),a=this.result;if(!(this.skipBackfaces&&e.dot(this.direction)>0))switch(a.hitFaceIndex=void 0!==n?n:-1,this.mode){case $m.ALL:this.hasHit=!0,a.set(i,C,e,g,t,I,o),a.hasHit=!0,this.callback(a);break;case $m.CLOSEST:(o<a.distance||!a.hasHit)&&(this.hasHit=!0,a.hasHit=!0,a.set(i,C,e,g,t,I,o));break;case $m.ANY:this.hasHit=!0,a.hasHit=!0,a.set(i,C,e,g,t,I,o),a.shouldStop=!0}}static pointInTriangle(e,g,t,I){I.vsub(g,fp),t.vsub(g,tp),e.vsub(g,Ip);const n=fp.dot(fp),i=fp.dot(tp),C=fp.dot(Ip),o=tp.dot(tp),a=tp.dot(Ip);let s,l;return(s=o*C-i*a)>=0&&(l=n*a-i*C)>=0&&s+l<n*o-i*i}}$m.CLOSEST=1,$m.ANY=2,$m.ALL=4;const ep=new Fm,gp=[],tp=new Ym,Ip=new Ym,np=new Ym,ip=new km,Cp=new Ym,op=new Ym,ap=new Ym,sp=new Ym;new Ym,new Um;const lp={faceList:[0]},rp=new Ym,Ap=new $m,cp=[],dp=new Ym,up=new Ym,hp=new Ym;new Ym,new Ym;const bp=new Ym,mp=new Ym,pp=new Ym,Gp=new Ym,Bp=new Ym,Zp=new Ym,yp=new Ym;new Fm;const vp=[],Wp=new Em,fp=new Ym,wp=new Ym;new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new $m,new Ym,new Ym,new Ym,new Ym(1,0,0),new Ym(0,1,0),new Ym(0,0,1),new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Fm,new Ym,new Fm,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Fm,new Ym,new Em,new Fm,Jm.types.SPHERE,Jm.types.SPHERE,Jm.types.PLANE,Jm.types.BOX,Jm.types.BOX,Jm.types.SPHERE,Jm.types.BOX,Jm.types.PLANE,Jm.types.BOX,Jm.types.CONVEXPOLYHEDRON,Jm.types.SPHERE,Jm.types.CONVEXPOLYHEDRON,Jm.types.PLANE,Jm.types.CONVEXPOLYHEDRON,Jm.types.BOX,Jm.types.CONVEXPOLYHEDRON,Jm.types.SPHERE,Jm.types.HEIGHTFIELD,Jm.types.BOX,Jm.types.HEIGHTFIELD,Jm.types.CONVEXPOLYHEDRON,Jm.types.HEIGHTFIELD,Jm.types.PARTICLE,Jm.types.SPHERE,Jm.types.PLANE,Jm.types.PARTICLE,Jm.types.BOX,Jm.types.PARTICLE,Jm.types.PARTICLE,Jm.types.CONVEXPOLYHEDRON,Jm.types.CYLINDER,Jm.types.SPHERE,Jm.types.CYLINDER,Jm.types.PLANE,Jm.types.CYLINDER,Jm.types.BOX,Jm.types.CYLINDER,Jm.types.CONVEXPOLYHEDRON,Jm.types.CYLINDER,Jm.types.HEIGHTFIELD,Jm.types.CYLINDER,Jm.types.PARTICLE,Jm.types.CYLINDER,Jm.types.SPHERE,Jm.types.TRIMESH,Jm.types.PLANE,Jm.types.TRIMESH,new Ym,new Ym,new Ym,new Ym,new Ym,new km,new km,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Fm,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new km,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Ym,new Fm,new $m;const Rp=globalThis.performance||{};if(!Rp.now){let e=Date.now();Rp.timing&&Rp.timing.navigationStart&&(e=Rp.timing.navigationStart),Rp.now=()=>Date.now()-e}new Ym;const Vp=(0,g.createContext)(null),Xp=()=>(0,g.useContext)(Vp),Sp=(0,g.createContext)(null),Yp=()=>{const e=(0,g.useContext)(Sp);if(!e)throw new Error("Physics context not found. @react-three/cannon & components can only be used within a Physics provider");return e};new TI,new UI(1,1,1),new UI,new Zn;const Kp=new Dn;function Hp(e){return e.charAt(0).toUpperCase()+e.slice(1)}function Np(e,g){const t=void 0===g?"":`/${g}`;return"function"==typeof e?null:e&&e.current&&`${e.current.uuid}${t}`}const Fp=new Yn,xp=new TI,zp=e=>g=>e(Fp.setFromQuaternion(xp.fromArray(g)).toArray());let kp=0;function Mp(e,g,t,I,n,i){return void 0===i&&(i="bodies"),C=>{const o=kp++;t[o]={[I]:C};const a=Np(e,n);return a&&g.subscribe({props:{id:o,target:i,type:I},uuid:a}),()=>{delete t[o],g.unsubscribe({props:o})}}}function Lp(e,g){let{position:t=[0,0,0],rotation:I=[0,0,0],userData:n={}}=g;e.userData=n,e.position.set(...t),e.rotation.set(...I),e.updateMatrix()}function Jp(e,g,t){let{onCollide:I,onCollideBegin:n,onCollideEnd:i}=g;e[t]={collide:I,collideBegin:n,collideEnd:i}}function Ep(e,t,I,n,i){void 0===n&&(n=null),void 0===i&&(i=[]);const C=function(e){const t=(0,g.useRef)(null);return e&&"function"!=typeof e?e:t}(n),{events:o,refs:a,scaleOverrides:s,subscriptions:l,worker:r}=Yp(),A=Xp();(0,g.useLayoutEffect)((()=>{C.current||(C.current=new Dn);const g=C.current,n=r,i=g instanceof $s?(g.instanceMatrix.setUsage(zt),g.count):1,s=g instanceof $s?new Array(i).fill(0).map(((e,t)=>`${g.uuid}/${t}`)):[g.uuid],l=g instanceof $s?s.map(((n,i)=>{const C=t(i);return Lp(Kp,C),g.setMatrixAt(i,Kp.matrix),g.instanceMatrix.needsUpdate=!0,a[n]=g,null==A||A.add(n,C,e),Jp(o,C,n),{...C,args:I(C.args)}})):s.map(((n,i)=>{const C=t(i);return Lp(g,C),a[n]=g,null==A||A.add(n,C,e),Jp(o,C,n),{...C,args:I(C.args)}}));return n.addBodies({props:l.map((e=>{let{onCollide:g,onCollideBegin:t,onCollideEnd:I,...n}=e;return{onCollide:Boolean(g),...n}})),type:e,uuid:s}),()=>{s.forEach((e=>{delete a[e],null==A||A.remove(e),delete o[e]})),n.removeBodies({uuid:s})}}),i);const c=(0,g.useMemo)((()=>{const e=(e,g)=>{const t=`set${Hp(e)}`;return{set:e=>{const I=Np(C,g);I&&r[t]({props:e,uuid:I})},subscribe:Mp(C,r,l,e,g)}},g=e=>({copy:g=>{let{w:t,x:I,y:n,z:i}=g;const o=Np(C,e);o&&r.setQuaternion({props:[I,n,i,t],uuid:o})},set:(g,t,I,n)=>{const i=Np(C,e);i&&r.setQuaternion({props:[g,t,I,n],uuid:i})},subscribe:Mp(C,r,l,"quaternion",e)}),t=e=>({copy:g=>{let{x:t,y:I,z:n}=g;const i=Np(C,e);i&&r.setRotation({props:[t,I,n],uuid:i})},set:(g,t,I)=>{const n=Np(C,e);n&&r.setRotation({props:[g,t,I],uuid:n})},subscribe:g=>{const t=kp++,I="quaternion",n=Np(C,e);return l[t]={[I]:zp(g)},n&&r.subscribe({props:{id:t,target:"bodies",type:I},uuid:n}),()=>{delete l[t],r.unsubscribe({props:t})}}}),I=(e,g)=>{const t=`set${Hp(e)}`;return{copy:e=>{let{x:I,y:n,z:i}=e;const o=Np(C,g);o&&r[t]({props:[I,n,i],uuid:o})},set:(e,I,n)=>{const i=Np(C,g);i&&r[t]({props:[e,I,n],uuid:i})},subscribe:Mp(C,r,l,e,g)}};function n(n){return{allowSleep:e("allowSleep",n),angularDamping:e("angularDamping",n),angularFactor:I("angularFactor",n),angularVelocity:I("angularVelocity",n),applyForce(e,g){const t=Np(C,n);t&&r.applyForce({props:[e,g],uuid:t})},applyImpulse(e,g){const t=Np(C,n);t&&r.applyImpulse({props:[e,g],uuid:t})},applyLocalForce(e,g){const t=Np(C,n);t&&r.applyLocalForce({props:[e,g],uuid:t})},applyLocalImpulse(e,g){const t=Np(C,n);t&&r.applyLocalImpulse({props:[e,g],uuid:t})},applyTorque(e){const g=Np(C,n);g&&r.applyTorque({props:[e],uuid:g})},collisionFilterGroup:e("collisionFilterGroup",n),collisionFilterMask:e("collisionFilterMask",n),collisionResponse:e("collisionResponse",n),fixedRotation:e("fixedRotation",n),isTrigger:e("isTrigger",n),linearDamping:e("linearDamping",n),linearFactor:I("linearFactor",n),mass:e("mass",n),material:e("material",n),position:I("position",n),quaternion:g(n),rotation:t(n),scaleOverride(e){const g=Np(C,n);g&&(s[g]=new UI(...e))},sleep(){const e=Np(C,n);e&&r.sleep({uuid:e})},sleepSpeedLimit:e("sleepSpeedLimit",n),sleepTimeLimit:e("sleepTimeLimit",n),userData:e("userData",n),velocity:I("velocity",n),wakeUp(){const e=Np(C,n);e&&r.wakeUp({uuid:e})}}}const i={};return{...n(void 0),at:e=>i[e]||(i[e]=n(e))}}),[]);return[C,c]}function Tp(e,g,t){const I=[1,1,1];return Ep("Box",e,(function(e){return void 0===e&&(e=I),e}),g,t)}function Up(e,g,t){return Ep("Compound",e,(e=>e),g,t)}const Qp=new UI,Dp=new UI(1,1,1),Op=new TI,jp=new Zn;function Pp(e,g,t,I,n){return void 0===I&&(I=Dp),void 0!==e?(jp.compose(Qp.fromArray(g,3*e),Op.fromArray(t,4*e),I),n&&(n.matrixAutoUpdate=!1,n.matrix.copy(jp)),jp):jp.identity()}const _p=()=>{const e=[];return g=>!e.includes(g)&&!!e.push(g)};function qp(e){let{allowSleep:t=!1,axisIndex:I=0,broadphase:n="Naive",children:i,defaultContactMaterial:C={contactEquationStiffness:1e6},frictionGravity:o=null,gravity:a=[0,-9.81,0],isPaused:s=!1,iterations:l=5,maxSubSteps:r=10,quatNormalizeFast:A=!1,quatNormalizeSkip:c=0,shouldInvalidate:d=!0,size:u=1e3,solver:h="GS",stepSize:b=1/60,tolerance:m=.001}=e;const{invalidate:p}=Fu(),[{bodies:G,events:B,refs:Z,scaleOverrides:y,subscriptions:v,worker:W}]=(0,g.useState)((()=>({bodies:{},events:{},refs:{},scaleOverrides:{},subscriptions:{},worker:new Cb({allowSleep:t,axisIndex:I,broadphase:n,defaultContactMaterial:C,frictionGravity:o,gravity:a,iterations:l,quatNormalizeFast:A,quatNormalizeSkip:c,size:u,solver:h,tolerance:m})})));let f=0;const w=(0,g.useCallback)(((e,g)=>{s||(f+=g,W.step({maxSubSteps:r,stepSize:b,timeSinceLastCalled:f}),f=0)}),[s,r,b]),R=e=>{var g;let{body:t,contact:{bi:I,bj:n,...i},target:C,...o}=e;const a=null==(g=B[C])?void 0:g.collide;a&&a({body:Z[t],contact:{bi:Z[I],bj:Z[n],...i},target:Z[C],...o})},V=e=>{var g,t;let{bodyA:I,bodyB:n}=e;const i=null==(g=B[I])?void 0:g.collideBegin;i&&i({body:Z[n],op:"event",target:Z[I],type:"collideBegin"});const C=null==(t=B[n])?void 0:t.collideBegin;C&&C({body:Z[I],op:"event",target:Z[n],type:"collideBegin"})},X=e=>{var g,t;let{bodyA:I,bodyB:n}=e;const i=null==(g=B[I])?void 0:g.collideEnd;i&&i({body:Z[n],op:"event",target:Z[I],type:"collideEnd"});const C=null==(t=B[n])?void 0:t.collideEnd;C&&C({body:Z[I],op:"event",target:Z[n],type:"collideEnd"})},S=e=>{let{active:g,bodies:t=[],observations:I,positions:n,quaternions:i}=e;for(let e=0;e<t.length;e++)G[t[e]]=e;if(I.forEach((e=>{let[g,t,I]=e;const n=(v[g]||{})[I];n&&n(t)})),g){for(const e of Object.values(Z).filter(_p()))if(e instanceof $s)for(let g=0;g<e.count;g++){const t=`${e.uuid}/${g}`,I=G[t];void 0!==I&&(e.setMatrixAt(g,Pp(I,n,i,y[t])),e.instanceMatrix.needsUpdate=!0)}else{const g=y[e.uuid]||e.scale;Pp(G[e.uuid],n,i,g,e)}d&&p()}},Y=e=>{var g;let{body:t,ray:{uuid:I,...n},...i}=e;const C=null==(g=B[I])?void 0:g.rayhit;C&&C({body:t?Z[t]:null,ray:{uuid:I,...n},...i})};xu(w),(0,g.useEffect)((()=>(W.connect(),W.init(),W.on("collide",R),W.on("collideBegin",V),W.on("collideEnd",X),W.on("frame",S),W.on("rayhit",Y),()=>{W.terminate(),W.removeAllListeners()})),[]),(0,g.useEffect)((()=>{W.axisIndex=I}),[I]),(0,g.useEffect)((()=>{W.broadphase=n}),[n]),(0,g.useEffect)((()=>{W.gravity=a}),[a]),(0,g.useEffect)((()=>{W.iterations=l}),[l]),(0,g.useEffect)((()=>{W.tolerance=m}),[m]);const K=(0,g.useMemo)((()=>({bodies:G,events:B,refs:Z,scaleOverrides:y,subscriptions:v,worker:W})),[G,B,Z,v,W]);return(0,Lh.jsx)(Sp.Provider,{value:K,children:i})}const $p=e=>{let g;const t=new Set,I=(e,I)=>{const n="function"==typeof e?e(g):e;if(!Object.is(n,g)){const e=g;g=(null!=I?I:"object"!=typeof n)?n:Object.assign({},g,n),t.forEach((t=>t(g,e)))}},n=()=>g,i={setState:I,getState:n,subscribe:e=>(t.add(e),()=>t.delete(e)),destroy:()=>{console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),t.clear()}};return g=e(I,n,i),i};var eG=n(798);const{useSyncExternalStoreWithSelector:gG}=eG;let tG=!1;const IG=e=>{"function"!=typeof e&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const t="function"==typeof e?(e=>e?$p(e):$p)(e):e,I=(e,I)=>function(e,t=e.getState,I){I&&!tG&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),tG=!0);const n=gG(e.subscribe,e.getState,e.getServerState||e.getState,t,I);return(0,g.useDebugValue)(n),n}(t,e,I);return Object.assign(I,t),I};function nG(e){return function(e){if(Array.isArray(e))return iG(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,g){if(e){if("string"==typeof e)return iG(e,g);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?iG(e,g):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function iG(e,g){(null==g||g>e.length)&&(g=e.length);for(var t=0,I=new Array(g);t<g;t++)I[t]=e[t];return I}var CG,oG=(CG=function(e){return{players:[],groundObjects:{},actions:{shoot:function(){e((function(e){return{lasers:[].concat(nG(e.lasers),[Date.now()])}}))},shootTurretLaser:function(){e((function(e){return{turretLasers:nG(e.turretLasers)}}))},addPlayer:function(g){e((function(e){return{players:[g]}}))},decreasePlayerHealth:function(){e((function(e){return{playerHealth:e.playerHealth-10}}))},setPlayerHealth:function(g){e({playerHealth:g})}},playerHealth:100,lasers:[],turretLasers:[],mixer:new Lc}})?IG(CG):IG;function aG(e,g){(null==g||g>e.length)&&(g=e.length);for(var t=0,I=new Array(g);t<g;t++)I[t]=e[t];return I}function sG(){var e,t,I=function(e,g){return function(e){if(Array.isArray(e))return e}(e)||function(e,g){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var I,n,i,C,o=[],a=!0,s=!1;try{if(i=(t=t.call(e)).next,0===g){if(Object(t)!==t)return;a=!1}else for(;!(a=(I=i.call(t)).done)&&(o.push(I.value),o.length!==g);a=!0);}catch(e){s=!0,n=e}finally{try{if(!a&&null!=t.return&&(C=t.return(),Object(C)!==C))return}finally{if(s)throw n}}return o}}(e,g)||function(e,g){if(e){if("string"==typeof e)return aG(e,g);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?aG(e,g):void 0}}(e,g)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}((e=function(){return{rotation:[-Math.PI/2,0,0],material:"ground"}},t=(0,g.useRef)(),Ep("Plane",e,(()=>[]),t,undefined)),1)[0],n=oG((function(e){return e.groundObjects}));return(0,g.useEffect)((function(){var e=I.current.id;return n[e]=I.current,function(){delete n[e]}}),[n,I]),(0,Lh.jsx)(Lh.Fragment,{children:(0,Lh.jsxs)("mesh",{ref:I,rotation:[-Math.PI/2,0,0],receiveShadow:!0,children:[(0,Lh.jsx)("planeGeometry",{args:[1e3,1e3]}),(0,Lh.jsx)("meshStandardMaterial",{})]})})}function lG(e,g){return function(e){if(Array.isArray(e))return e}(e)||function(e,g){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var I,n,i,C,o=[],a=!0,s=!1;try{if(i=(t=t.call(e)).next,0===g){if(Object(t)!==t)return;a=!1}else for(;!(a=(I=i.call(t)).done)&&(o.push(I.value),o.length!==g);a=!0);}catch(e){s=!0,n=e}finally{try{if(!a&&null!=t.return&&(C=t.return(),Object(C)!==C))return}finally{if(s)throw n}}return o}}(e,g)||function(e,g){if(e){if("string"==typeof e)return rG(e,g);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?rG(e,g):void 0}}(e,g)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function rG(e,g){(null==g||g>e.length)&&(g=e.length);for(var t=0,I=new Array(g);t<g;t++)I[t]=e[t];return I}var AG=function(e,t){var I=oG((function(e){return e.lasers})),n=(0,g.useRef)(),i=lG((0,g.useState)(!1),2),C=i[0],o=i[1],a=Date.now()-600,s=new Dc,l=Fu().scene,r=lG((0,g.useState)(100),2),A=(r[0],r[1],(0,g.useMemo)((function(){return new CC(.1,.1,1)}),[])),c=(0,g.useMemo)((function(){return new $r({color:16729344})}),[]),d=(0,g.useCallback)((function(e){2===e.button&&o(!0)}),[]),u=(0,g.useCallback)((function(e){2===e.button&&o(!1)}),[]),h=(0,g.useCallback)((function(){var g=Date.now();if(!(g-a<600)){a=g;var t=new nC(A,c);t.position.set(e.current.position.x,e.current.position.y,e.current.position.z),t.quaternion.copy(e.current.quaternion),n.current.add(t),I.push(t)}}),[600,A,c,I,e]),b=(0,g.useCallback)((function(g,t){var i=new UI(0,0,-1).applyQuaternion(e.current.quaternion);s.linePrecision=1e-4,I.forEach((function(e,t){i.set(0,0,-1).applyQuaternion(e.quaternion),e.position.add(i.clone().multiplyScalar(2)),s.set(e.position,i);var C=s.intersectObjects(l.children);e.position.distanceTo(g.current.position)>100&&(n.current.remove(e),I.splice(I.indexOf(e),1)),C.length>.1&&C[0].distance<1&&(n.current.remove(e),I.splice(I.indexOf(e),1))})),C&&h()}),[C,I,h,t]);return{lasers:I,laserGroup:n,isRightMouseDown:C,handleMouseDown:d,handleMouseUp:u,shootLasers:h,updateLasers:b}};function cG(e,g){return function(e){if(Array.isArray(e))return e}(e)||function(e,g){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var I,n,i,C,o=[],a=!0,s=!1;try{if(i=(t=t.call(e)).next,0===g){if(Object(t)!==t)return;a=!1}else for(;!(a=(I=i.call(t)).done)&&(o.push(I.value),o.length!==g);a=!0);}catch(e){s=!0,n=e}finally{try{if(!a&&null!=t.return&&(C=t.return(),Object(C)!==C))return}finally{if(s)throw n}}return o}}(e,g)||function(e,g){if(e){if("string"==typeof e)return dG(e,g);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?dG(e,g):void 0}}(e,g)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function dG(e,g){(null==g||g>e.length)&&(g=e.length);for(var t=0,I=new Array(g);t<g;t++)I[t]=e[t];return I}var uG=[[120,1,0]];function hG(e){var t=e.position,I=e.players,n=new UI,i=new UI,C=new UI,o=new UI,a=new UI,s=new UI,l=(0,g.useMemo)((function(){return 2*Math.sqrt(3)/3}),[]),r=(0,g.useMemo)((function(){return new Dc}),[]),A=oG((function(e){return e.actions})).decreasePlayerHealth,c=(Fu().scene,oG((function(e){return e.turretLasers}))),d=cG((0,g.useState)(100),2),u=d[0],h=d[1],b=cG((0,g.useState)(!0),2),m=b[0],p=b[1],G=(0,g.useRef)(),B=(0,g.useRef)(),Z=(0,g.useRef)(),y=((0,g.useRef)(new UI),AG(Z).lasers),v=Date.now()-W,W=600,f=(0,g.useMemo)((function(){return new CC(.1,.1,1)}),[]),w=(0,g.useRef)(),R=(0,g.useMemo)((function(){return[{args:[1,1,1],position:[0,0,0],type:"Box"},{args:[.25,.5,.5],position:[0,1.25,0],type:"Box"}]})),V=cG(Up((function(){return{mass:1,position:t,shapes:R,material:"slippery"}}),(0,g.useRef)()),2),X=V[0],S=V[1],Y=(0,g.useMemo)((function(){return new $r({color:16729344})}),[]),K=(0,g.useCallback)((function(){var e=Date.now();if(!(e-v<W)){v=e;var g=new nC(f,Y);g.position.copy(Z.current.position),g.quaternion.copy(Z.current.quaternion),G.current.add(g);var t=I[0].clone();t.y+=1,C.subVectors(t,Z.current.position),C.normalize(),g.direction=C.clone(),c.push(g)}}),[W,f,Y,c,Z,G,I]);return xu((function(){if(Z.current&&I.length>0){var e=I[0];n.setFromMatrixPosition(X.current.matrixWorld),Z.current.position.set(n.x,n.y+1,n.z),i.setFromMatrixPosition(Z.current.matrixWorld);var g=i.distanceTo(e);if(g<=50&&(Z.current.lookAt(e.x,e.y+1,e.z),K()),g>20?(C.subVectors(e,i),C.normalize(),S.velocity.set(20*C.x,20*C.y,20*C.z)):g<5&&S.velocity.set(0,0,0),r.linePrecision=1e-4,c.forEach((function(g,t){g.position.add(g.direction.clone().multiplyScalar(1.5)),r.set(g.position,o);var I=g.position.distanceTo(Z.current.position),n=(r.intersectObjects(e),g.position.distanceTo(e));I>60&&(G.current.remove(g),c.splice(c.indexOf(g),1)),n<=1.2&&(G.current.remove(g),c.splice(c.indexOf(g),1),A())})),X.current&&w.current&&w.current.position){var t=new UI;t.setFromMatrixPosition(X.current.matrixWorld),w.current.position.set(t.x,t.y+2,t.z)}}y.forEach((function(e,g){a.copy(e.position),Z.current&&(s.setFromMatrixPosition(X.current.matrixWorld),a.distanceTo(s)<l&&h(u-10))}))})),(0,g.useEffect)((function(){S.angularFactor.set(0,1,0),u<=0&&(X.current.scale.set(0,0,0),S.position.set(t[0],t[1],t[2]),p(!1))}),[u,X,S,t]),m?(0,Lh.jsxs)(Lh.Fragment,{children:[(0,Lh.jsxs)("group",{ref:X,children:[(0,Lh.jsx)(Nh,{ref:w,center:!0,position:[0,2,0],zIndexRange:[1e3,1e3],children:(0,Lh.jsx)("div",{style:{width:"50px",height:"5px",backgroundColor:"white",border:"1px solid black",position:"relative"},children:(0,Lh.jsx)("div",{style:{position:"absolute",top:0,left:0,width:"".concat(u,"%"),height:"100%",backgroundColor:"red"}})})}),(0,Lh.jsxs)("mesh",{castShadow:!0,receiveShadow:!0,children:[(0,Lh.jsx)("boxGeometry",{args:[1,1,1],position:[0,1,0]}),(0,Lh.jsx)("meshStandardMaterial",{color:"grey"})]})]}),(0,Lh.jsxs)("mesh",{ref:Z,position:[0,1,0],children:[(0,Lh.jsx)("boxGeometry",{args:[.3,.4,.8]}),(0,Lh.jsx)("meshStandardMaterial",{color:"grey"})]}),(0,Lh.jsx)("group",{ref:B}),(0,Lh.jsx)("group",{ref:G})]}):null}function bG(){var e=oG((function(e){return e.players}));return(0,Lh.jsx)(Lh.Fragment,{children:uG.map((function(g,t){return(0,Lh.jsx)(hG,{position:g,material:"ground",players:e},t)}))})}const mG=new WeakMap;class pG extends WA{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,g,t,I){const n=new RA(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),n.load(e,(e=>{const t={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,t).then(g).catch(I)}),t,I)}decodeDracoFile(e,g,t,I){const n={attributeIDs:t||this.defaultAttributeIDs,attributeTypes:I||this.defaultAttributeTypes,useUniqueIDs:!!t};this.decodeGeometry(e,n).then(g)}decodeGeometry(e,g){for(const e in g.attributeTypes){const t=g.attributeTypes[e];void 0!==t.BYTES_PER_ELEMENT&&(g.attributeTypes[e]=t.name)}const t=JSON.stringify(g);if(mG.has(e)){const g=mG.get(e);if(g.key===t)return g.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let I;const n=this.workerNextTaskID++,i=e.byteLength,C=this._getWorker(n,i).then((t=>(I=t,new Promise(((t,i)=>{I._callbacks[n]={resolve:t,reject:i},I.postMessage({type:"decode",id:n,taskConfig:g,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return C.catch((()=>!0)).then((()=>{I&&n&&this._releaseTask(I,n)})),mG.set(e,{key:t,promise:C}),C}_createGeometry(e){const g=new Mi;e.index&&g.setIndex(new Zi(e.index.array,1));for(let t=0;t<e.attributes.length;t++){const I=e.attributes[t],n=I.name,i=I.array,C=I.itemSize;g.setAttribute(n,new Zi(i,C))}return g}_loadLibrary(e,g){const t=new RA(this.manager);return t.setPath(this.decoderPath),t.setResponseType(g),t.setWithCredentials(this.withCredentials),new Promise(((g,I)=>{t.load(e,g,void 0,I)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,g=[];return e?g.push(this._loadLibrary("draco_decoder.js","text")):(g.push(this._loadLibrary("draco_wasm_wrapper.js","text")),g.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(g).then((g=>{const t=g[0];e||(this.decoderConfig.wasmBinary=g[1]);const I=GG.toString(),n=["/* draco decoder */",t,"","/* worker */",I.substring(I.indexOf("{")+1,I.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([n]))})),this.decoderPending}_getWorker(e,g){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(g){const t=g.data;switch(t.type){case"decode":e._callbacks[t.id].resolve(t);break;case"error":e._callbacks[t.id].reject(t);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+t.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,g){return e._taskLoad>g._taskLoad?-1:1}));const t=this.workerPool[this.workerPool.length-1];return t._taskCosts[e]=g,t._taskLoad+=g,t}))}_releaseTask(e,g){e._taskLoad-=e._taskCosts[g],delete e._callbacks[g],delete e._taskCosts[g]}debug(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function GG(){let e,g;function t(e,g,t,I,n,i){const C=i.num_components(),o=t.num_points()*C,a=o*n.BYTES_PER_ELEMENT,s=function(e,g){switch(g){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,n),l=e._malloc(a);g.GetAttributeDataArrayForAllPoints(t,i,s,a,l);const r=new n(e.HEAPF32.buffer,l,o).slice();return e._free(l),{name:I,array:r,itemSize:C}}onmessage=function(I){const n=I.data;switch(n.type){case"init":e=n.decoderConfig,g=new Promise((function(g){e.onModuleLoaded=function(e){g({draco:e})},DracoDecoderModule(e)}));break;case"decode":const I=n.buffer,i=n.taskConfig;g.then((e=>{const g=e.draco,C=new g.Decoder,o=new g.DecoderBuffer;o.Init(new Int8Array(I),I.byteLength);try{const e=function(e,g,I,n){const i=n.attributeIDs,C=n.attributeTypes;let o,a;const s=g.GetEncodedGeometryType(I);if(s===e.TRIANGULAR_MESH)o=new e.Mesh,a=g.DecodeBufferToMesh(I,o);else{if(s!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");o=new e.PointCloud,a=g.DecodeBufferToPointCloud(I,o)}if(!a.ok()||0===o.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+a.error_msg());const l={index:null,attributes:[]};for(const I in i){const a=self[C[I]];let s,r;if(n.useUniqueIDs)r=i[I],s=g.GetAttributeByUniqueId(o,r);else{if(r=g.GetAttributeId(o,e[i[I]]),-1===r)continue;s=g.GetAttribute(o,r)}l.attributes.push(t(e,g,o,I,a,s))}return s===e.TRIANGULAR_MESH&&(l.index=function(e,g,t){const I=3*t.num_faces(),n=4*I,i=e._malloc(n);g.GetTrianglesUInt32Array(t,n,i);const C=new Uint32Array(e.HEAPF32.buffer,i,I).slice();return e._free(i),{array:C,itemSize:1}}(e,g,o)),e.destroy(o),l}(g,C,o,i),I=e.attributes.map((e=>e.array.buffer));e.index&&I.push(e.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:e},I)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}finally{g.destroy(o),g.destroy(C)}}))}}}let BG;const ZG=()=>{if(BG)return BG;const e=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),g=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]);if("object"!=typeof WebAssembly)return{supported:!1};let t,I="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB";WebAssembly.validate(e)&&(I="B9h9z9tFBBBFiI9gBB9gLaaaaaFa9gEaaaB9gFaFaEMcBBFBFFGGGEILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBOn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBNI9z9iqlBVc+N9IcIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMk8lLbaE97F9+FaL978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAeDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAeDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBReCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBH8ZCFD9tA8ZAPD9OD9hD9RH8ZDQBTFtGmEYIPLdKeOnHpAIAQJDBIBHyCFD9tAyAPD9OD9hD9RHyAIASJDBIBH8cCFD9tA8cAPD9OD9hD9RH8cDQBTFtGmEYIPLdKeOnH8dDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAeD9uHeDyBjGBAEAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeApA8dDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNiV8ZcpMyS8cQ8df8eb8fHdAyA8cDQNiV8ZcpMyS8cQ8df8eb8fH8ZDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/dLEK97FaF97GXGXAGCI9HQBAF9FQFCBRGEXABABDBBBHECiD+rFCiD+sFD/6FHIAECND+rFCiD+sFD/6FAID/gFAECTD+rFCiD+sFD/6FHLD/gFD/kFD/lFHKCBDtD+2FHOAICUUUU94DtHND9OD9RD/kFHI9DBB/+hDYAIAID/mFAKAKD/mFALAOALAND9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHLD/mF9DBBX9LDYHOD/kFCgFDtD9OAECUUU94DtD9OD9QAIALD/mFAOD/kFCND+rFCU/+EDtD9OD9QAKALD/mFAOD/kFCTD+rFCUU/8ODtD9OD9QDMBBABCTJRBAGCIJHGAF9JQBSGMMAF9FQBCBRGEXABCTJHVAVDBBBHECBDtHOCUU98D8cFCUU98D8cEHND9OABDBBBHKAEDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAKAEDQBFGENVcMTtmYi8ZpyHECTD+sFD/6FHID/gFAECTD+rFCTD+sFD/6FHLD/gFD/kFD/lFHE9DB/+g6DYALAEAOD+2FHOALCUUUU94DtHcD9OD9RD/kFHLALD/mFAEAED/mFAIAOAIAcD9OD9RD/kFHEAED/mFD/kFD/kFD/jFD/nFHID/mF9DBBX9LDYHOD/kFCTD+rFALAID/mFAOD/kFCggEDtD9OD9QHLAEAID/mFAOD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHEDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAKAND9OALAEDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM/hEIGaF97FaL978jUUUUBCTlREGXAF9FQBCBRIEXAEABDBBBHLABCTJHKDBBBHODQILKOSQfbPden8c8d8e8fHNCTD+sFHVCID+rFDMIBAB9DBBU8/DY9D/zI818/DYAVCEDtD9QD/6FD/nFHVALAODQBFGENVcMTtmYi8ZpyHLCTD+rFCTD+sFD/6FD/mFHOAOD/mFAVALCTD+sFD/6FD/mFHcAcD/mFAVANCTD+rFCTD+sFD/6FD/mFHNAND/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHVD/mF9DBBX9LDYHLD/kFCggEDtHMD9OAcAVD/mFALD/kFCTD+rFD9QHcANAVD/mFALD/kFCTD+rFAOAVD/mFALD/kFAMD9OD9QHVDQBFTtGEmYILPdKOenHLD8dBAEDBIBDyB+t+J83EBABCNJALD8dFAEDBIBDyF+t+J83EBAKAcAVDQNVi8ZcMpySQ8c8dfb8e8fHVD8dBAEDBIBDyG+t+J83EBABCiJAVD8dFAEDBIBDyE+t+J83EBABCAJRBAICIJHIAF9JQBMMM9jFF97GXAGCGrAF9sHG9FQBCBRFEXABABDBBBHECND+rFCND+sFD/6FAECiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBABCTJRBAFCIJHFAG9JQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB");const n=WebAssembly.instantiate(function(e){const t=new Uint8Array(e.length);for(let g=0;g<e.length;++g){const I=e.charCodeAt(g);t[g]=I>96?I-71:I>64?I-65:I>47?I+4:I>46?63:62}let I=0;for(let n=0;n<e.length;++n)t[I++]=t[n]<60?g[t[n]]:64*(t[n]-60)+t[++n];return t.buffer.slice(0,I)}(I),{}).then((e=>{t=e.instance,t.exports.__wasm_call_ctors()}));function i(e,g,I,n,i,C){const o=t.exports.sbrk,a=I+3&-4,s=o(a*n),l=o(i.length),r=new Uint8Array(t.exports.memory.buffer);r.set(i,l);const A=e(s,I,n,l,i.length);if(0===A&&C&&C(s,a,n),g.set(r.subarray(s,s+I*n)),o(s-o(0)),0!==A)throw new Error(`Malformed buffer data: ${A}`)}const C={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},o={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return BG={ready:n,supported:!0,decodeVertexBuffer(e,g,I,n,o){i(t.exports.meshopt_decodeVertexBuffer,e,g,I,n,t.exports[C[o]])},decodeIndexBuffer(e,g,I,n){i(t.exports.meshopt_decodeIndexBuffer,e,g,I,n)},decodeIndexSequence(e,g,I,n){i(t.exports.meshopt_decodeIndexSequence,e,g,I,n)},decodeGltfBuffer(e,g,I,n,a,s){i(t.exports[o[a]],e,g,I,n,t.exports[C[s]])}},BG};function yG(e,g){if(g===jg)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(g===_g||g===Pg){let t=e.getIndex();if(null===t){const g=[],I=e.getAttribute("position");if(void 0===I)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<I.count;e++)g.push(e);e.setIndex(g),t=e.getIndex()}const I=t.count-2,n=[];if(t)if(g===_g)for(let e=1;e<=I;e++)n.push(t.getX(0)),n.push(t.getX(e)),n.push(t.getX(e+1));else for(let e=0;e<I;e++)e%2==0?(n.push(t.getX(e)),n.push(t.getX(e+1)),n.push(t.getX(e+2))):(n.push(t.getX(e+2)),n.push(t.getX(e+1)),n.push(t.getX(e)));n.length/3!==I&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=e.clone();return i.setIndex(n),i.clearGroups(),i}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",g),e}const vG=parseInt(p.replace(/\D+/g,""));class WG extends WA{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new SG(e)})),this.register((function(e){return new kG(e)})),this.register((function(e){return new MG(e)})),this.register((function(e){return new LG(e)})),this.register((function(e){return new KG(e)})),this.register((function(e){return new HG(e)})),this.register((function(e){return new NG(e)})),this.register((function(e){return new FG(e)})),this.register((function(e){return new XG(e)})),this.register((function(e){return new xG(e)})),this.register((function(e){return new YG(e)})),this.register((function(e){return new zG(e)})),this.register((function(e){return new RG(e)})),this.register((function(e){return new JG(e)})),this.register((function(e){return new EG(e)}))}load(e,g,t,I){const n=this;let i;i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:gc.extractUrlBase(e),this.manager.itemStart(e);const C=function(g){I?I(g):console.error(g),n.manager.itemError(e),n.manager.itemEnd(e)},o=new RA(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(t){try{n.parse(t,i,(function(t){g(t),n.manager.itemEnd(e)}),C)}catch(e){C(e)}}),t,C)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,g,t,I){let n;const i={},C={};if("string"==typeof e)n=JSON.parse(e);else if(e instanceof ArrayBuffer)if(gc.decodeText(new Uint8Array(e.slice(0,4)))===TG){try{i[wG.KHR_BINARY_GLTF]=new UG(e)}catch(e){return void(I&&I(e))}n=JSON.parse(i[wG.KHR_BINARY_GLTF].content)}else n=JSON.parse(gc.decodeText(new Uint8Array(e)));else n=e;if(void 0===n.asset||n.asset.version[0]<2)return void(I&&I(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const o=new cB(n,{path:g||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});o.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const g=this.pluginCallbacks[e](o);C[g.name]=g,i[g.name]=!0}if(n.extensionsUsed)for(let e=0;e<n.extensionsUsed.length;++e){const g=n.extensionsUsed[e],t=n.extensionsRequired||[];switch(g){case wG.KHR_MATERIALS_UNLIT:i[g]=new VG;break;case wG.KHR_DRACO_MESH_COMPRESSION:i[g]=new QG(n,this.dracoLoader);break;case wG.KHR_TEXTURE_TRANSFORM:i[g]=new DG;break;case wG.KHR_MESH_QUANTIZATION:i[g]=new OG;break;default:t.indexOf(g)>=0&&void 0===C[g]&&console.warn('THREE.GLTFLoader: Unknown extension "'+g+'".')}}o.setExtensions(i),o.setPlugins(C),o.parse(t,I)}parseAsync(e,g){const t=this;return new Promise((function(I,n){t.parse(e,g,I,n)}))}}function fG(){let e={};return{get:function(g){return e[g]},add:function(g,t){e[g]=t},remove:function(g){delete e[g]},removeAll:function(){e={}}}}const wG={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class RG{constructor(e){this.parser=e,this.name=wG.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,g=this.parser.json.nodes||[];for(let t=0,I=g.length;t<I;t++){const I=g[t];I.extensions&&I.extensions[this.name]&&void 0!==I.extensions[this.name].light&&e._addNodeRef(this.cache,I.extensions[this.name].light)}}_loadLight(e){const g=this.parser,t="light:"+e;let I=g.cache.get(t);if(I)return I;const n=g.json,i=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let C;const o=new Ai(16777215);void 0!==i.color&&o.fromArray(i.color);const a=void 0!==i.range?i.range:0;switch(i.type){case"directional":C=new jA(o),C.target.position.set(0,0,-1),C.add(C.target);break;case"point":C=new DA(o),C.distance=a;break;case"spot":C=new JA(o),C.distance=a,i.spot=i.spot||{},i.spot.innerConeAngle=void 0!==i.spot.innerConeAngle?i.spot.innerConeAngle:0,i.spot.outerConeAngle=void 0!==i.spot.outerConeAngle?i.spot.outerConeAngle:Math.PI/4,C.angle=i.spot.outerConeAngle,C.penumbra=1-i.spot.innerConeAngle/i.spot.outerConeAngle,C.target.position.set(0,0,-1),C.add(C.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+i.type)}return C.position.set(0,0,0),C.decay=2,oB(C,i),void 0!==i.intensity&&(C.intensity=i.intensity),C.name=g.createUniqueName(i.name||"light_"+e),I=Promise.resolve(C),g.cache.add(t,I),I}getDependency(e,g){if("light"===e)return this._loadLight(g)}createNodeAttachment(e){const g=this,t=this.parser,I=t.json.nodes[e],n=(I.extensions&&I.extensions[this.name]||{}).light;return void 0===n?null:this._loadLight(n).then((function(e){return t._getNodeRef(g.cache,n,e)}))}}class VG{constructor(){this.name=wG.KHR_MATERIALS_UNLIT}getMaterialType(){return di}extendParams(e,g,t){const I=[];e.color=new Ai(1,1,1),e.opacity=1;const n=g.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const g=n.baseColorFactor;e.color.fromArray(g),e.opacity=g[3]}void 0!==n.baseColorTexture&&I.push(t.assignTexture(e,"map",n.baseColorTexture,3001))}return Promise.all(I)}}class XG{constructor(e){this.parser=e,this.name=wG.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,g){const t=this.parser.json.materials[e];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const I=t.extensions[this.name].emissiveStrength;return void 0!==I&&(g.emissiveIntensity=I),Promise.resolve()}}class SG{constructor(e){this.parser=e,this.name=wG.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const g=this.parser.json.materials[e];return g.extensions&&g.extensions[this.name]?jr:null}extendMaterialParams(e,g){const t=this.parser,I=t.json.materials[e];if(!I.extensions||!I.extensions[this.name])return Promise.resolve();const n=[],i=I.extensions[this.name];if(void 0!==i.clearcoatFactor&&(g.clearcoat=i.clearcoatFactor),void 0!==i.clearcoatTexture&&n.push(t.assignTexture(g,"clearcoatMap",i.clearcoatTexture)),void 0!==i.clearcoatRoughnessFactor&&(g.clearcoatRoughness=i.clearcoatRoughnessFactor),void 0!==i.clearcoatRoughnessTexture&&n.push(t.assignTexture(g,"clearcoatRoughnessMap",i.clearcoatRoughnessTexture)),void 0!==i.clearcoatNormalTexture&&(n.push(t.assignTexture(g,"clearcoatNormalMap",i.clearcoatNormalTexture)),void 0!==i.clearcoatNormalTexture.scale)){const e=i.clearcoatNormalTexture.scale;g.clearcoatNormalScale=new AI(e,e)}return Promise.all(n)}}class YG{constructor(e){this.parser=e,this.name=wG.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const g=this.parser.json.materials[e];return g.extensions&&g.extensions[this.name]?jr:null}extendMaterialParams(e,g){const t=this.parser,I=t.json.materials[e];if(!I.extensions||!I.extensions[this.name])return Promise.resolve();const n=[],i=I.extensions[this.name];return void 0!==i.iridescenceFactor&&(g.iridescence=i.iridescenceFactor),void 0!==i.iridescenceTexture&&n.push(t.assignTexture(g,"iridescenceMap",i.iridescenceTexture)),void 0!==i.iridescenceIor&&(g.iridescenceIOR=i.iridescenceIor),void 0===g.iridescenceThicknessRange&&(g.iridescenceThicknessRange=[100,400]),void 0!==i.iridescenceThicknessMinimum&&(g.iridescenceThicknessRange[0]=i.iridescenceThicknessMinimum),void 0!==i.iridescenceThicknessMaximum&&(g.iridescenceThicknessRange[1]=i.iridescenceThicknessMaximum),void 0!==i.iridescenceThicknessTexture&&n.push(t.assignTexture(g,"iridescenceThicknessMap",i.iridescenceThicknessTexture)),Promise.all(n)}}class KG{constructor(e){this.parser=e,this.name=wG.KHR_MATERIALS_SHEEN}getMaterialType(e){const g=this.parser.json.materials[e];return g.extensions&&g.extensions[this.name]?jr:null}extendMaterialParams(e,g){const t=this.parser,I=t.json.materials[e];if(!I.extensions||!I.extensions[this.name])return Promise.resolve();const n=[];g.sheenColor=new Ai(0,0,0),g.sheenRoughness=0,g.sheen=1;const i=I.extensions[this.name];return void 0!==i.sheenColorFactor&&g.sheenColor.fromArray(i.sheenColorFactor),void 0!==i.sheenRoughnessFactor&&(g.sheenRoughness=i.sheenRoughnessFactor),void 0!==i.sheenColorTexture&&n.push(t.assignTexture(g,"sheenColorMap",i.sheenColorTexture,3001)),void 0!==i.sheenRoughnessTexture&&n.push(t.assignTexture(g,"sheenRoughnessMap",i.sheenRoughnessTexture)),Promise.all(n)}}class HG{constructor(e){this.parser=e,this.name=wG.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const g=this.parser.json.materials[e];return g.extensions&&g.extensions[this.name]?jr:null}extendMaterialParams(e,g){const t=this.parser,I=t.json.materials[e];if(!I.extensions||!I.extensions[this.name])return Promise.resolve();const n=[],i=I.extensions[this.name];return void 0!==i.transmissionFactor&&(g.transmission=i.transmissionFactor),void 0!==i.transmissionTexture&&n.push(t.assignTexture(g,"transmissionMap",i.transmissionTexture)),Promise.all(n)}}class NG{constructor(e){this.parser=e,this.name=wG.KHR_MATERIALS_VOLUME}getMaterialType(e){const g=this.parser.json.materials[e];return g.extensions&&g.extensions[this.name]?jr:null}extendMaterialParams(e,g){const t=this.parser,I=t.json.materials[e];if(!I.extensions||!I.extensions[this.name])return Promise.resolve();const n=[],i=I.extensions[this.name];g.thickness=void 0!==i.thicknessFactor?i.thicknessFactor:0,void 0!==i.thicknessTexture&&n.push(t.assignTexture(g,"thicknessMap",i.thicknessTexture)),g.attenuationDistance=i.attenuationDistance||1/0;const C=i.attenuationColor||[1,1,1];return g.attenuationColor=new Ai(C[0],C[1],C[2]),Promise.all(n)}}class FG{constructor(e){this.parser=e,this.name=wG.KHR_MATERIALS_IOR}getMaterialType(e){const g=this.parser.json.materials[e];return g.extensions&&g.extensions[this.name]?jr:null}extendMaterialParams(e,g){const t=this.parser.json.materials[e];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const I=t.extensions[this.name];return g.ior=void 0!==I.ior?I.ior:1.5,Promise.resolve()}}class xG{constructor(e){this.parser=e,this.name=wG.KHR_MATERIALS_SPECULAR}getMaterialType(e){const g=this.parser.json.materials[e];return g.extensions&&g.extensions[this.name]?jr:null}extendMaterialParams(e,g){const t=this.parser,I=t.json.materials[e];if(!I.extensions||!I.extensions[this.name])return Promise.resolve();const n=[],i=I.extensions[this.name];g.specularIntensity=void 0!==i.specularFactor?i.specularFactor:1,void 0!==i.specularTexture&&n.push(t.assignTexture(g,"specularIntensityMap",i.specularTexture));const C=i.specularColorFactor||[1,1,1];return g.specularColor=new Ai(C[0],C[1],C[2]),void 0!==i.specularColorTexture&&n.push(t.assignTexture(g,"specularColorMap",i.specularColorTexture,3001)),Promise.all(n)}}class zG{constructor(e){this.parser=e,this.name=wG.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const g=this.parser.json.materials[e];return g.extensions&&g.extensions[this.name]?jr:null}extendMaterialParams(e,g){const t=this.parser,I=t.json.materials[e];if(!I.extensions||!I.extensions[this.name])return Promise.resolve();const n=[],i=I.extensions[this.name];return void 0!==i.anisotropyStrength&&(g.anisotropy=i.anisotropyStrength),void 0!==i.anisotropyRotation&&(g.anisotropyRotation=i.anisotropyRotation),void 0!==i.anisotropyTexture&&n.push(t.assignTexture(g,"anisotropyMap",i.anisotropyTexture)),Promise.all(n)}}class kG{constructor(e){this.parser=e,this.name=wG.KHR_TEXTURE_BASISU}loadTexture(e){const g=this.parser,t=g.json,I=t.textures[e];if(!I.extensions||!I.extensions[this.name])return null;const n=I.extensions[this.name],i=g.options.ktx2Loader;if(!i){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return g.loadTextureImage(e,n.source,i)}}class MG{constructor(e){this.parser=e,this.name=wG.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const g=this.name,t=this.parser,I=t.json,n=I.textures[e];if(!n.extensions||!n.extensions[g])return null;const i=n.extensions[g],C=I.images[i.source];let o=t.textureLoader;if(C.uri){const e=t.options.manager.getHandler(C.uri);null!==e&&(o=e)}return this.detectSupport().then((function(n){if(n)return t.loadTextureImage(e,i.source,o);if(I.extensionsRequired&&I.extensionsRequired.indexOf(g)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return t.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const g=new Image;g.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",g.onload=g.onerror=function(){e(1===g.height)}}))),this.isSupported}}class LG{constructor(e){this.parser=e,this.name=wG.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const g=this.name,t=this.parser,I=t.json,n=I.textures[e];if(!n.extensions||!n.extensions[g])return null;const i=n.extensions[g],C=I.images[i.source];let o=t.textureLoader;if(C.uri){const e=t.options.manager.getHandler(C.uri);null!==e&&(o=e)}return this.detectSupport().then((function(n){if(n)return t.loadTextureImage(e,i.source,o);if(I.extensionsRequired&&I.extensionsRequired.indexOf(g)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return t.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const g=new Image;g.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",g.onload=g.onerror=function(){e(1===g.height)}}))),this.isSupported}}class JG{constructor(e){this.name=wG.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const g=this.parser.json,t=g.bufferViews[e];if(t.extensions&&t.extensions[this.name]){const e=t.extensions[this.name],I=this.parser.getDependency("buffer",e.buffer),n=this.parser.options.meshoptDecoder;if(!n||!n.supported){if(g.extensionsRequired&&g.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return I.then((function(g){const t=e.byteOffset||0,I=e.byteLength||0,i=e.count,C=e.byteStride,o=new Uint8Array(g,t,I);return n.decodeGltfBufferAsync?n.decodeGltfBufferAsync(i,C,o,e.mode,e.filter).then((function(e){return e.buffer})):n.ready.then((function(){const g=new ArrayBuffer(i*C);return n.decodeGltfBuffer(new Uint8Array(g),i,C,o,e.mode,e.filter),g}))}))}return null}}class EG{constructor(e){this.name=wG.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const g=this.parser.json,t=g.nodes[e];if(!t.extensions||!t.extensions[this.name]||void 0===t.mesh)return null;const I=g.meshes[t.mesh];for(const e of I.primitives)if(e.mode!==qG.TRIANGLES&&e.mode!==qG.TRIANGLE_STRIP&&e.mode!==qG.TRIANGLE_FAN&&void 0!==e.mode)return null;const n=t.extensions[this.name].attributes,i=[],C={};for(const e in n)i.push(this.parser.getDependency("accessor",n[e]).then((g=>(C[e]=g,C[e]))));return i.length<1?null:(i.push(this.parser.createNodeMesh(e)),Promise.all(i).then((e=>{const g=e.pop(),t=g.isGroup?g.children:[g],I=e[0].count,n=[];for(const e of t){const g=new Zn,t=new UI,i=new TI,o=new UI(1,1,1),a=new $s(e.geometry,e.material,I);for(let e=0;e<I;e++)C.TRANSLATION&&t.fromBufferAttribute(C.TRANSLATION,e),C.ROTATION&&i.fromBufferAttribute(C.ROTATION,e),C.SCALE&&o.fromBufferAttribute(C.SCALE,e),a.setMatrixAt(e,g.compose(t,i,o));for(const g in C)"TRANSLATION"!==g&&"ROTATION"!==g&&"SCALE"!==g&&e.geometry.setAttribute(g,C[g]);Dn.prototype.copy.call(a,e),this.parser.assignFinalMaterial(a),n.push(a)}return g.isGroup?(g.clear(),g.add(...n),g):n[0]})))}}const TG="glTF";class UG{constructor(e){this.name=wG.KHR_BINARY_GLTF,this.content=null,this.body=null;const g=new DataView(e,0,12);if(this.header={magic:gc.decodeText(new Uint8Array(e.slice(0,4))),version:g.getUint32(4,!0),length:g.getUint32(8,!0)},this.header.magic!==TG)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const t=this.header.length-12,I=new DataView(e,12);let n=0;for(;n<t;){const g=I.getUint32(n,!0);n+=4;const t=I.getUint32(n,!0);if(n+=4,1313821514===t){const t=new Uint8Array(e,12+n,g);this.content=gc.decodeText(t)}else if(5130562===t){const t=12+n;this.body=e.slice(t,t+g)}n+=g}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class QG{constructor(e,g){if(!g)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=wG.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=g,this.dracoLoader.preload()}decodePrimitive(e,g){const t=this.json,I=this.dracoLoader,n=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,C={},o={},a={};for(const e in i){const g=IB[e]||e.toLowerCase();C[g]=i[e]}for(const g in e.attributes){const I=IB[g]||g.toLowerCase();if(void 0!==i[g]){const n=t.accessors[e.attributes[g]],i=$G[n.componentType];a[I]=i.name,o[I]=!0===n.normalized}}return g.getDependency("bufferView",n).then((function(e){return new Promise((function(g){I.decodeDracoFile(e,(function(e){for(const g in e.attributes){const t=e.attributes[g],I=o[g];void 0!==I&&(t.normalized=I)}g(e)}),C,a)}))}))}}class DG{constructor(){this.name=wG.KHR_TEXTURE_TRANSFORM}extendTexture(e,g){return void 0!==g.texCoord&&g.texCoord!==e.channel||void 0!==g.offset||void 0!==g.rotation||void 0!==g.scale?(e=e.clone(),void 0!==g.texCoord&&(e.channel=g.texCoord),void 0!==g.offset&&e.offset.fromArray(g.offset),void 0!==g.rotation&&(e.rotation=g.rotation),void 0!==g.scale&&e.repeat.fromArray(g.scale),e.needsUpdate=!0,e):e}}class OG{constructor(){this.name=wG.KHR_MESH_QUANTIZATION}}class jG extends aA{constructor(e,g,t,I){super(e,g,t,I)}copySampleValue_(e){const g=this.resultBuffer,t=this.sampleValues,I=this.valueSize,n=e*I*3+I;for(let e=0;e!==I;e++)g[e]=t[n+e];return g}interpolate_(e,g,t,I){const n=this.resultBuffer,i=this.sampleValues,C=this.valueSize,o=2*C,a=3*C,s=I-g,l=(t-g)/s,r=l*l,A=r*l,c=e*a,d=c-a,u=-2*A+3*r,h=A-r,b=1-u,m=h-r+l;for(let e=0;e!==C;e++){const g=i[d+e+C],t=i[d+e+o]*s,I=i[c+e+C],a=i[c+e]*s;n[e]=b*g+m*t+u*I+h*a}return n}}const PG=new TI;class _G extends jG{interpolate_(e,g,t,I){const n=super.interpolate_(e,g,t,I);return PG.fromArray(n).normalize().toArray(n),n}}const qG={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},$G={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},eB={9728:Re,9729:Ke,9984:Ve,9985:He,9986:Se,9987:Fe},gB={33071:fe,33648:we,10497:We},tB={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},IB={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",...vG>=152?{TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3"}:{TEXCOORD_0:"uv",TEXCOORD_1:"uv2"},COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},nB={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},iB={CUBICSPLINE:void 0,LINEAR:Jg,STEP:Lg};function CB(e,g,t){for(const I in t.extensions)void 0===e[I]&&(g.userData.gltfExtensions=g.userData.gltfExtensions||{},g.userData.gltfExtensions[I]=t.extensions[I])}function oB(e,g){void 0!==g.extras&&("object"==typeof g.extras?Object.assign(e.userData,g.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+g.extras))}function aB(e,g){if(e.updateMorphTargets(),void 0!==g.weights)for(let t=0,I=g.weights.length;t<I;t++)e.morphTargetInfluences[t]=g.weights[t];if(g.extras&&Array.isArray(g.extras.targetNames)){const t=g.extras.targetNames;if(e.morphTargetInfluences.length===t.length){e.morphTargetDictionary={};for(let g=0,I=t.length;g<I;g++)e.morphTargetDictionary[t[g]]=g}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function sB(e){let g;const t=e.extensions&&e.extensions[wG.KHR_DRACO_MESH_COMPRESSION];if(g=t?"draco:"+t.bufferView+":"+t.indices+":"+lB(t.attributes):e.indices+":"+lB(e.attributes)+":"+e.mode,void 0!==e.targets)for(let t=0,I=e.targets.length;t<I;t++)g+=":"+lB(e.targets[t]);return g}function lB(e){let g="";const t=Object.keys(e).sort();for(let I=0,n=t.length;I<n;I++)g+=t[I]+":"+e[t[I]]+";";return g}function rB(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const AB=new Zn;class cB{constructor(e={},g={}){this.json=e,this.extensions={},this.plugins={},this.options=g,this.cache=new fG,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let t=!1,I=!1,n=-1;"undefined"!=typeof navigator&&void 0!==navigator.userAgent&&(t=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),I=navigator.userAgent.indexOf("Firefox")>-1,n=I?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||t||I&&n<98?this.textureLoader=new HA(this.options.manager):this.textureLoader=new ac(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new RA(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,g){const t=this,I=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([t.getDependencies("scene"),t.getDependencies("animation"),t.getDependencies("camera")])})).then((function(g){const i={scene:g[0][I.scene||0],scenes:g[0],animations:g[1],cameras:g[2],asset:I.asset,parser:t,userData:{}};CB(n,i,I),oB(i,I),Promise.all(t._invokeAll((function(e){return e.afterRoot&&e.afterRoot(i)}))).then((function(){e(i)}))})).catch(g)}_markDefs(){const e=this.json.nodes||[],g=this.json.skins||[],t=this.json.meshes||[];for(let t=0,I=g.length;t<I;t++){const I=g[t].joints;for(let g=0,t=I.length;g<t;g++)e[I[g]].isBone=!0}for(let g=0,I=e.length;g<I;g++){const I=e[g];void 0!==I.mesh&&(this._addNodeRef(this.meshCache,I.mesh),void 0!==I.skin&&(t[I.mesh].isSkinnedMesh=!0)),void 0!==I.camera&&this._addNodeRef(this.cameraCache,I.camera)}}_addNodeRef(e,g){void 0!==g&&(void 0===e.refs[g]&&(e.refs[g]=e.uses[g]=0),e.refs[g]++)}_getNodeRef(e,g,t){if(e.refs[g]<=1)return t;const I=t.clone(),n=(e,g)=>{const t=this.associations.get(e);null!=t&&this.associations.set(g,t);for(const[t,I]of e.children.entries())n(I,g.children[t])};return n(t,I),I.name+="_instance_"+e.uses[g]++,I}_invokeOne(e){const g=Object.values(this.plugins);g.push(this);for(let t=0;t<g.length;t++){const I=e(g[t]);if(I)return I}return null}_invokeAll(e){const g=Object.values(this.plugins);g.unshift(this);const t=[];for(let I=0;I<g.length;I++){const n=e(g[I]);n&&t.push(n)}return t}getDependency(e,g){const t=e+":"+g;let I=this.cache.get(t);if(!I){switch(e){case"scene":I=this.loadScene(g);break;case"node":I=this._invokeOne((function(e){return e.loadNode&&e.loadNode(g)}));break;case"mesh":I=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(g)}));break;case"accessor":I=this.loadAccessor(g);break;case"bufferView":I=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(g)}));break;case"buffer":I=this.loadBuffer(g);break;case"material":I=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(g)}));break;case"texture":I=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(g)}));break;case"skin":I=this.loadSkin(g);break;case"animation":I=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(g)}));break;case"camera":I=this.loadCamera(g);break;default:if(I=this._invokeOne((function(t){return t!=this&&t.getDependency&&t.getDependency(e,g)})),!I)throw new Error("Unknown type: "+e)}this.cache.add(t,I)}return I}getDependencies(e){let g=this.cache.get(e);if(!g){const t=this,I=this.json[e+("mesh"===e?"es":"s")]||[];g=Promise.all(I.map((function(g,I){return t.getDependency(e,I)}))),this.cache.add(e,g)}return g}loadBuffer(e){const g=this.json.buffers[e],t=this.fileLoader;if(g.type&&"arraybuffer"!==g.type)throw new Error("THREE.GLTFLoader: "+g.type+" buffer type is not supported.");if(void 0===g.uri&&0===e)return Promise.resolve(this.extensions[wG.KHR_BINARY_GLTF].body);const I=this.options;return new Promise((function(e,n){t.load(gc.resolveURL(g.uri,I.path),e,void 0,(function(){n(new Error('THREE.GLTFLoader: Failed to load buffer "'+g.uri+'".'))}))}))}loadBufferView(e){const g=this.json.bufferViews[e];return this.getDependency("buffer",g.buffer).then((function(e){const t=g.byteLength||0,I=g.byteOffset||0;return e.slice(I,I+t)}))}loadAccessor(e){const g=this,t=this.json,I=this.json.accessors[e];if(void 0===I.bufferView&&void 0===I.sparse){const e=tB[I.type],g=$G[I.componentType],t=!0===I.normalized,n=new g(I.count*e);return Promise.resolve(new Zi(n,e,t))}const n=[];return void 0!==I.bufferView?n.push(this.getDependency("bufferView",I.bufferView)):n.push(null),void 0!==I.sparse&&(n.push(this.getDependency("bufferView",I.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",I.sparse.values.bufferView))),Promise.all(n).then((function(e){const n=e[0],i=tB[I.type],C=$G[I.componentType],o=C.BYTES_PER_ELEMENT,a=o*i,s=I.byteOffset||0,l=void 0!==I.bufferView?t.bufferViews[I.bufferView].byteStride:void 0,r=!0===I.normalized;let A,c;if(l&&l!==a){const e=Math.floor(s/l),t="InterleavedBuffer:"+I.bufferView+":"+I.componentType+":"+e+":"+I.count;let a=g.cache.get(t);a||(A=new C(n,e*l,I.count*l/o),a=new as(A,l/o),g.cache.add(t,a)),c=new ls(a,i,s%l/o,r)}else A=null===n?new C(I.count*i):new C(n,s,I.count*i),c=new Zi(A,i,r);if(void 0!==I.sparse){const g=tB.SCALAR,t=$G[I.sparse.indices.componentType],o=I.sparse.indices.byteOffset||0,a=I.sparse.values.byteOffset||0,s=new t(e[1],o,I.sparse.count*g),l=new C(e[2],a,I.sparse.count*i);null!==n&&(c=new Zi(c.array.slice(),c.itemSize,c.normalized));for(let e=0,g=s.length;e<g;e++){const g=s[e];if(c.setX(g,l[e*i]),i>=2&&c.setY(g,l[e*i+1]),i>=3&&c.setZ(g,l[e*i+2]),i>=4&&c.setW(g,l[e*i+3]),i>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return c}))}loadTexture(e){const g=this.json,t=this.options,I=g.textures[e].source,n=g.images[I];let i=this.textureLoader;if(n.uri){const e=t.manager.getHandler(n.uri);null!==e&&(i=e)}return this.loadTextureImage(e,I,i)}loadTextureImage(e,g,t){const I=this,n=this.json,i=n.textures[e],C=n.images[g],o=(C.uri||C.bufferView)+":"+i.sampler;if(this.textureCache[o])return this.textureCache[o];const a=this.loadImageSource(g,t).then((function(g){g.flipY=!1,g.name=i.name||C.name||"",""===g.name&&"string"==typeof C.uri&&!1===C.uri.startsWith("data:image/")&&(g.name=C.uri);const t=(n.samplers||{})[i.sampler]||{};return g.magFilter=eB[t.magFilter]||Ke,g.minFilter=eB[t.minFilter]||Fe,g.wrapS=gB[t.wrapS]||We,g.wrapT=gB[t.wrapT]||We,I.associations.set(g,{textures:e}),g})).catch((function(){return null}));return this.textureCache[o]=a,a}loadImageSource(e,g){const t=this.json,I=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const n=t.images[e],i=self.URL||self.webkitURL;let C=n.uri||"",o=!1;if(void 0!==n.bufferView)C=this.getDependency("bufferView",n.bufferView).then((function(e){o=!0;const g=new Blob([e],{type:n.mimeType});return C=i.createObjectURL(g),C}));else if(void 0===n.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const a=Promise.resolve(C).then((function(e){return new Promise((function(t,n){let i=t;!0===g.isImageBitmapLoader&&(i=function(e){const g=new NI(e);g.needsUpdate=!0,t(g)}),g.load(gc.resolveURL(e,I.path),i,void 0,n)}))})).then((function(e){var g;return!0===o&&i.revokeObjectURL(C),e.userData.mimeType=n.mimeType||((g=n.uri).search(/\.jpe?g($|\?)/i)>0||0===g.search(/^data\:image\/jpeg/)?"image/jpeg":g.search(/\.webp($|\?)/i)>0||0===g.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",C),e}));return this.sourceCache[e]=a,a}assignTexture(e,g,t,I){const n=this;return this.getDependency("texture",t.index).then((function(i){if(!i)return null;if(void 0!==t.texCoord&&t.texCoord>0&&((i=i.clone()).channel=t.texCoord),n.extensions[wG.KHR_TEXTURE_TRANSFORM]){const e=void 0!==t.extensions?t.extensions[wG.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const g=n.associations.get(i);i=n.extensions[wG.KHR_TEXTURE_TRANSFORM].extendTexture(i,e),n.associations.set(i,g)}}return void 0!==I&&("colorSpace"in i?i.colorSpace=3001===I?"srgb":"srgb-linear":i.encoding=I),e[g]=i,i}))}assignFinalMaterial(e){const g=e.geometry;let t=e.material;const I=void 0===g.attributes.tangent,n=void 0!==g.attributes.color,i=void 0===g.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+t.uuid;let g=this.cache.get(e);g||(g=new rl,oi.prototype.copy.call(g,t),g.color.copy(t.color),g.map=t.map,g.sizeAttenuation=!1,this.cache.add(e,g)),t=g}else if(e.isLine){const e="LineBasicMaterial:"+t.uuid;let g=this.cache.get(e);g||(g=new el,oi.prototype.copy.call(g,t),g.color.copy(t.color),g.map=t.map,this.cache.add(e,g)),t=g}if(I||n||i){let e="ClonedMaterial:"+t.uuid+":";I&&(e+="derivative-tangents:"),n&&(e+="vertex-colors:"),i&&(e+="flat-shading:");let g=this.cache.get(e);g||(g=t.clone(),n&&(g.vertexColors=!0),i&&(g.flatShading=!0),I&&(g.normalScale&&(g.normalScale.y*=-1),g.clearcoatNormalScale&&(g.clearcoatNormalScale.y*=-1)),this.cache.add(e,g),this.associations.set(g,this.associations.get(t))),t=g}e.material=t}getMaterialType(){return Or}loadMaterial(e){const g=this,t=this.json,I=this.extensions,n=t.materials[e];let i;const C={},o=[];if((n.extensions||{})[wG.KHR_MATERIALS_UNLIT]){const e=I[wG.KHR_MATERIALS_UNLIT];i=e.getMaterialType(),o.push(e.extendParams(C,n,g))}else{const t=n.pbrMetallicRoughness||{};if(C.color=new Ai(1,1,1),C.opacity=1,Array.isArray(t.baseColorFactor)){const e=t.baseColorFactor;C.color.fromArray(e),C.opacity=e[3]}void 0!==t.baseColorTexture&&o.push(g.assignTexture(C,"map",t.baseColorTexture,3001)),C.metalness=void 0!==t.metallicFactor?t.metallicFactor:1,C.roughness=void 0!==t.roughnessFactor?t.roughnessFactor:1,void 0!==t.metallicRoughnessTexture&&(o.push(g.assignTexture(C,"metalnessMap",t.metallicRoughnessTexture)),o.push(g.assignTexture(C,"roughnessMap",t.metallicRoughnessTexture))),i=this._invokeOne((function(g){return g.getMaterialType&&g.getMaterialType(e)})),o.push(Promise.all(this._invokeAll((function(g){return g.extendMaterialParams&&g.extendMaterialParams(e,C)}))))}!0===n.doubleSided&&(C.side=Y);const a=n.alphaMode||"OPAQUE";if("BLEND"===a?(C.transparent=!0,C.depthWrite=!1):(C.transparent=!1,"MASK"===a&&(C.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&i!==di&&(o.push(g.assignTexture(C,"normalMap",n.normalTexture)),C.normalScale=new AI(1,1),void 0!==n.normalTexture.scale)){const e=n.normalTexture.scale;C.normalScale.set(e,e)}return void 0!==n.occlusionTexture&&i!==di&&(o.push(g.assignTexture(C,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength&&(C.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&i!==di&&(C.emissive=(new Ai).fromArray(n.emissiveFactor)),void 0!==n.emissiveTexture&&i!==di&&o.push(g.assignTexture(C,"emissiveMap",n.emissiveTexture,3001)),Promise.all(o).then((function(){const t=new i(C);return n.name&&(t.name=n.name),oB(t,n),g.associations.set(t,{materials:e}),n.extensions&&CB(I,t,n),t}))}createUniqueName(e){const g=xc.sanitizeNodeName(e||"");return g in this.nodeNamesUsed?g+"_"+ ++this.nodeNamesUsed[g]:(this.nodeNamesUsed[g]=0,g)}loadGeometries(e){const g=this,t=this.extensions,I=this.primitiveCache;function n(e){return t[wG.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,g).then((function(t){return dB(t,e,g)}))}const i=[];for(let t=0,C=e.length;t<C;t++){const C=e[t],o=sB(C),a=I[o];if(a)i.push(a.promise);else{let e;e=C.extensions&&C.extensions[wG.KHR_DRACO_MESH_COMPRESSION]?n(C):dB(new Mi,C,g),I[o]={primitive:C,promise:e},i.push(e)}}return Promise.all(i)}loadMesh(e){const g=this,t=this.json,I=this.extensions,n=t.meshes[e],i=n.primitives,C=[];for(let e=0,g=i.length;e<g;e++){const g=void 0===i[e].material?(void 0===(o=this.cache).DefaultMaterial&&(o.DefaultMaterial=new Or({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:X})),o.DefaultMaterial):this.getDependency("material",i[e].material);C.push(g)}var o;return C.push(g.loadGeometries(i)),Promise.all(C).then((function(t){const C=t.slice(0,t.length-1),o=t[t.length-1],a=[];for(let t=0,s=o.length;t<s;t++){const s=o[t],l=i[t];let r;const A=C[t];if(l.mode===qG.TRIANGLES||l.mode===qG.TRIANGLE_STRIP||l.mode===qG.TRIANGLE_FAN||void 0===l.mode)r=!0===n.isSkinnedMesh?new ks(s,A):new nC(s,A),!0===r.isSkinnedMesh&&r.normalizeSkinWeights(),l.mode===qG.TRIANGLE_STRIP?r.geometry=yG(r.geometry,Pg):l.mode===qG.TRIANGLE_FAN&&(r.geometry=yG(r.geometry,_g));else if(l.mode===qG.LINES)r=new sl(s,A);else if(l.mode===qG.LINE_STRIP)r=new Cl(s,A);else if(l.mode===qG.LINE_LOOP)r=new ll(s,A);else{if(l.mode!==qG.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+l.mode);r=new hl(s,A)}Object.keys(r.geometry.morphAttributes).length>0&&aB(r,n),r.name=g.createUniqueName(n.name||"mesh_"+e),oB(r,n),l.extensions&&CB(I,r,l),g.assignFinalMaterial(r),a.push(r)}for(let t=0,I=a.length;t<I;t++)g.associations.set(a[t],{meshes:e,primitives:t});if(1===a.length)return n.extensions&&CB(I,a[0],n),a[0];const s=new Pa;n.extensions&&CB(I,s,n),g.associations.set(s,{meshes:e});for(let e=0,g=a.length;e<g;e++)s.add(a[e]);return s}))}loadCamera(e){let g;const t=this.json.cameras[e],I=t[t.type];if(I)return"perspective"===t.type?g=new cC(rI.radToDeg(I.yfov),I.aspectRatio||1,I.znear||1,I.zfar||2e6):"orthographic"===t.type&&(g=new zC(-I.xmag,I.xmag,I.ymag,-I.ymag,I.znear,I.zfar)),t.name&&(g.name=this.createUniqueName(t.name)),oB(g,t),Promise.resolve(g);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const g=this.json.skins[e],t=[];for(let e=0,I=g.joints.length;e<I;e++)t.push(this._loadNodeShallow(g.joints[e]));return void 0!==g.inverseBindMatrices?t.push(this.getDependency("accessor",g.inverseBindMatrices)):t.push(null),Promise.all(t).then((function(e){const t=e.pop(),I=e,n=[],i=[];for(let e=0,C=I.length;e<C;e++){const C=I[e];if(C){n.push(C);const g=new Zn;null!==t&&g.fromArray(t.array,16*e),i.push(g)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',g.joints[e])}return new Ts(n,i)}))}loadAnimation(e){const g=this.json.animations[e],t=g.name?g.name:"animation_"+e,I=[],n=[],i=[],C=[],o=[];for(let e=0,t=g.channels.length;e<t;e++){const t=g.channels[e],a=g.samplers[t.sampler],s=t.target,l=s.node,r=void 0!==g.parameters?g.parameters[a.input]:a.input,A=void 0!==g.parameters?g.parameters[a.output]:a.output;void 0!==s.node&&(I.push(this.getDependency("node",l)),n.push(this.getDependency("accessor",r)),i.push(this.getDependency("accessor",A)),C.push(a),o.push(s))}return Promise.all([Promise.all(I),Promise.all(n),Promise.all(i),Promise.all(C),Promise.all(o)]).then((function(e){const g=e[0],I=e[1],n=e[2],i=e[3],C=e[4],o=[];for(let e=0,t=g.length;e<t;e++){const t=g[e],a=I[e],s=n[e],l=i[e],r=C[e];if(void 0===t)continue;let A;switch(t.updateMatrix(),nB[r.path]){case nB.weights:A=uA;break;case nB.rotation:A=bA;break;default:A=pA}const c=t.name?t.name:t.uuid,d=void 0!==l.interpolation?iB[l.interpolation]:Jg,u=[];nB[r.path]===nB.weights?t.traverse((function(e){e.morphTargetInfluences&&u.push(e.name?e.name:e.uuid)})):u.push(c);let h=s.array;if(s.normalized){const e=rB(h.constructor),g=new Float32Array(h.length);for(let t=0,I=h.length;t<I;t++)g[t]=h[t]*e;h=g}for(let e=0,g=u.length;e<g;e++){const g=new A(u[e]+"."+nB[r.path],a.array,h,d);"CUBICSPLINE"===l.interpolation&&(g.createInterpolant=function(e){return new(this instanceof bA?_G:jG)(this.times,this.values,this.getValueSize()/3,e)},g.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),o.push(g)}}return new GA(t,void 0,o)}))}createNodeMesh(e){const g=this.json,t=this,I=g.nodes[e];return void 0===I.mesh?null:t.getDependency("mesh",I.mesh).then((function(e){const g=t._getNodeRef(t.meshCache,I.mesh,e);return void 0!==I.weights&&g.traverse((function(e){if(e.isMesh)for(let g=0,t=I.weights.length;g<t;g++)e.morphTargetInfluences[g]=I.weights[g]})),g}))}loadNode(e){const g=this,t=this.json.nodes[e],I=g._loadNodeShallow(e),n=[],i=t.children||[];for(let e=0,t=i.length;e<t;e++)n.push(g.getDependency("node",i[e]));const C=void 0===t.skin?Promise.resolve(null):g.getDependency("skin",t.skin);return Promise.all([I,Promise.all(n),C]).then((function(e){const g=e[0],t=e[1],I=e[2];null!==I&&g.traverse((function(e){e.isSkinnedMesh&&e.bind(I,AB)}));for(let e=0,I=t.length;e<I;e++)g.add(t[e]);return g}))}_loadNodeShallow(e){const g=this.json,t=this.extensions,I=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const n=g.nodes[e],i=n.name?I.createUniqueName(n.name):"",C=[],o=I._invokeOne((function(g){return g.createNodeMesh&&g.createNodeMesh(e)}));return o&&C.push(o),void 0!==n.camera&&C.push(I.getDependency("camera",n.camera).then((function(e){return I._getNodeRef(I.cameraCache,n.camera,e)}))),I._invokeAll((function(g){return g.createNodeAttachment&&g.createNodeAttachment(e)})).forEach((function(e){C.push(e)})),this.nodeCache[e]=Promise.all(C).then((function(g){let C;if(C=!0===n.isBone?new Ms:g.length>1?new Pa:1===g.length?g[0]:new Dn,C!==g[0])for(let e=0,t=g.length;e<t;e++)C.add(g[e]);if(n.name&&(C.userData.name=n.name,C.name=i),oB(C,n),n.extensions&&CB(t,C,n),void 0!==n.matrix){const e=new Zn;e.fromArray(n.matrix),C.applyMatrix4(e)}else void 0!==n.translation&&C.position.fromArray(n.translation),void 0!==n.rotation&&C.quaternion.fromArray(n.rotation),void 0!==n.scale&&C.scale.fromArray(n.scale);return I.associations.has(C)||I.associations.set(C,{}),I.associations.get(C).nodes=e,C})),this.nodeCache[e]}loadScene(e){const g=this.extensions,t=this.json.scenes[e],I=this,n=new Pa;t.name&&(n.name=I.createUniqueName(t.name)),oB(n,t),t.extensions&&CB(g,n,t);const i=t.nodes||[],C=[];for(let e=0,g=i.length;e<g;e++)C.push(I.getDependency("node",i[e]));return Promise.all(C).then((function(e){for(let g=0,t=e.length;g<t;g++)n.add(e[g]);return I.associations=(e=>{const g=new Map;for(const[e,t]of I.associations)(e instanceof oi||e instanceof NI)&&g.set(e,t);return e.traverse((e=>{const t=I.associations.get(e);null!=t&&g.set(e,t)})),g})(n),n}))}}function dB(e,g,t){const I=g.attributes,n=[];function i(g,I){return t.getDependency("accessor",g).then((function(g){e.setAttribute(I,g)}))}for(const g in I){const t=IB[g]||g.toLowerCase();t in e.attributes||n.push(i(I[g],t))}if(void 0!==g.indices&&!e.index){const I=t.getDependency("accessor",g.indices).then((function(g){e.setIndex(g)}));n.push(I)}return oB(e,g),function(e,g,t){const I=g.attributes,n=new OI;if(void 0===I.POSITION)return;{const e=t.json.accessors[I.POSITION],g=e.min,i=e.max;if(void 0===g||void 0===i)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(n.set(new UI(g[0],g[1],g[2]),new UI(i[0],i[1],i[2])),e.normalized){const g=rB($G[e.componentType]);n.min.multiplyScalar(g),n.max.multiplyScalar(g)}}const i=g.targets;if(void 0!==i){const e=new UI,g=new UI;for(let I=0,n=i.length;I<n;I++){const n=i[I];if(void 0!==n.POSITION){const I=t.json.accessors[n.POSITION],i=I.min,C=I.max;if(void 0!==i&&void 0!==C){if(g.setX(Math.max(Math.abs(i[0]),Math.abs(C[0]))),g.setY(Math.max(Math.abs(i[1]),Math.abs(C[1]))),g.setZ(Math.max(Math.abs(i[2]),Math.abs(C[2]))),I.normalized){const e=rB($G[I.componentType]);g.multiplyScalar(e)}e.max(g)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(e)}e.boundingBox=n;const C=new cn;n.getCenter(C.center),C.radius=n.min.distanceTo(n.max)/2,e.boundingSphere=C}(e,g,t),Promise.all(n).then((function(){return void 0!==g.targets?function(e,g,t){let I=!1,n=!1,i=!1;for(let e=0,t=g.length;e<t;e++){const t=g[e];if(void 0!==t.POSITION&&(I=!0),void 0!==t.NORMAL&&(n=!0),void 0!==t.COLOR_0&&(i=!0),I&&n&&i)break}if(!I&&!n&&!i)return Promise.resolve(e);const C=[],o=[],a=[];for(let s=0,l=g.length;s<l;s++){const l=g[s];if(I){const g=void 0!==l.POSITION?t.getDependency("accessor",l.POSITION):e.attributes.position;C.push(g)}if(n){const g=void 0!==l.NORMAL?t.getDependency("accessor",l.NORMAL):e.attributes.normal;o.push(g)}if(i){const g=void 0!==l.COLOR_0?t.getDependency("accessor",l.COLOR_0):e.attributes.color;a.push(g)}}return Promise.all([Promise.all(C),Promise.all(o),Promise.all(a)]).then((function(g){const t=g[0],C=g[1],o=g[2];return I&&(e.morphAttributes.position=t),n&&(e.morphAttributes.normal=C),i&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e}))}(e,g.targets,t):e}))}let uB=null,hB="https://www.gstatic.com/draco/versioned/decoders/1.5.5/";function bB(e,g,t){return I=>{t&&t(I),e&&(uB||(uB=new pG),uB.setDecoderPath("string"==typeof e?e:hB),I.setDRACOLoader(uB)),g&&I.setMeshoptDecoder("function"==typeof ZG?ZG():ZG)}}function mB(e,g=!0,t=!0,I){return Mu(WG,e,bB(g,t,I))}function pB(e){return pB="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},pB(e)}function GB(e,g){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var I=Object.getOwnPropertySymbols(e);g&&(I=I.filter((function(g){return Object.getOwnPropertyDescriptor(e,g).enumerable}))),t.push.apply(t,I)}return t}function BB(e){for(var g=1;g<arguments.length;g++){var t=null!=arguments[g]?arguments[g]:{};g%2?GB(Object(t),!0).forEach((function(g){var I,n,i;I=e,n=g,i=t[g],(n=function(e){var g=function(e,g){if("object"!==pB(e)||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var I=t.call(e,"string");if("object"!==pB(I))return I;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===pB(g)?g:String(g)}(n))in I?Object.defineProperty(I,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):I[n]=i})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):GB(Object(t)).forEach((function(g){Object.defineProperty(e,g,Object.getOwnPropertyDescriptor(t,g))}))}return e}function ZB(e){var t=(0,g.useRef)(),I=mB("/armfram2.glb"),n=I.nodes,i=I.materials,C=function(e,t){const I=g.useRef(),[n]=g.useState((()=>t?t instanceof Dn?{current:t}:t:I)),[i]=g.useState((()=>new Lc(void 0)));g.useLayoutEffect((()=>{t&&(n.current=t instanceof Dn?t:t.current),i._root=n.current}));const C=g.useRef({}),o=g.useMemo((()=>{const g={};return e.forEach((e=>Object.defineProperty(g,e.name,{enumerable:!0,get(){if(n.current)return C.current[e.name]||(C.current[e.name]=i.clipAction(e,n.current))},configurable:!0}))),{ref:n,clips:e,actions:g,names:e.map((e=>e.name)),mixer:i}}),[e]);return xu(((e,g)=>i.update(g))),g.useEffect((()=>{const e=n.current;return()=>{C.current={},i.stopAllAction(),Object.values(o.actions).forEach((g=>{e&&i.uncacheAction(g,e)}))}}),[e]),o}(I.animations,t);return C.actions,oG((function(e){return e.activeAction})),(0,Lh.jsx)("group",BB(BB({ref:t},e),{},{dispose:null,scale:[.01,.01,.01],children:(0,Lh.jsxs)("group",{name:"Scene",children:[(0,Lh.jsxs)("group",{name:"Armature",position:[9.254,162.946,-32.294],rotation:[-1.572,Math.PI/2,0],children:[(0,Lh.jsx)("primitive",{object:n.Bone}),(0,Lh.jsx)("primitive",{object:n.Bone006})]}),(0,Lh.jsxs)("group",{name:"Armature001",position:[-32.183,162.946,-32.294],rotation:[-1.572,Math.PI/2,0],children:[(0,Lh.jsx)("primitive",{object:n.Bone_1}),(0,Lh.jsx)("primitive",{object:n.Bone006_1})]}),(0,Lh.jsxs)("group",{name:"Cylinder",position:[-10.948,184.971,-25.408],rotation:[0,Math.PI/2,0],scale:[5.564,6.028,5.334],children:[(0,Lh.jsx)("mesh",{name:"Cylinder002",castShadow:!0,receiveShadow:!0,geometry:n.Cylinder002.geometry,material:i["Pelv.001"]}),(0,Lh.jsx)("mesh",{name:"Cylinder002_1",castShadow:!0,receiveShadow:!0,geometry:n.Cylinder002_1.geometry,material:i["Pelv.003"]}),(0,Lh.jsx)("mesh",{name:"Cylinder002_2",castShadow:!0,receiveShadow:!0,geometry:n.Cylinder002_2.geometry,material:i.Bolt}),(0,Lh.jsx)("mesh",{name:"Cylinder002_3",castShadow:!0,receiveShadow:!0,geometry:n.Cylinder002_3.geometry,material:i.connectors}),(0,Lh.jsx)("mesh",{name:"Cylinder002_4",castShadow:!0,receiveShadow:!0,geometry:n.Cylinder002_4.geometry,material:i["connectors.002"]}),(0,Lh.jsx)("mesh",{name:"Cylinder002_5",castShadow:!0,receiveShadow:!0,geometry:n.Cylinder002_5.geometry,material:i["Bolt.002"]}),(0,Lh.jsx)("group",{name:"Empty",position:[.243,-1.615,-.181],scale:[2.293,2.165,6.662]})]}),(0,Lh.jsx)("group",{name:"walk_Path001",position:[-32.576,-9.466,-35.104],rotation:[Math.PI/2,0,-Math.PI/2],scale:[.672,1,.772]}),(0,Lh.jsx)("group",{name:"walk_Path",position:[9.291,-9.466,-32.055],rotation:[Math.PI/2,0,-Math.PI/2],scale:[.672,1,.772]})]})}))}mB.preload=(e,g=!0,t=!0,I)=>Mu.preload(WG,e,bB(g,t,I)),mB.clear=e=>Mu.clear(WG,e),mB.setDecoderPath=e=>{hB=e},mB.preload("/armfram2.glb");class yB{constructor(e){void 0===e&&(e=[0,0,0,0,0,0,0,0,0]),this.elements=e}identity(){const e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}setZero(){const e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0}setTrace(e){const g=this.elements;g[0]=e.x,g[4]=e.y,g[8]=e.z}getTrace(e){void 0===e&&(e=new WB);const g=this.elements;return e.x=g[0],e.y=g[4],e.z=g[8],e}vmult(e,g){void 0===g&&(g=new WB);const t=this.elements,I=e.x,n=e.y,i=e.z;return g.x=t[0]*I+t[1]*n+t[2]*i,g.y=t[3]*I+t[4]*n+t[5]*i,g.z=t[6]*I+t[7]*n+t[8]*i,g}smult(e){for(let g=0;g<this.elements.length;g++)this.elements[g]*=e}mmult(e,g){void 0===g&&(g=new yB);const t=this.elements,I=e.elements,n=g.elements,i=t[0],C=t[1],o=t[2],a=t[3],s=t[4],l=t[5],r=t[6],A=t[7],c=t[8],d=I[0],u=I[1],h=I[2],b=I[3],m=I[4],p=I[5],G=I[6],B=I[7],Z=I[8];return n[0]=i*d+C*b+o*G,n[1]=i*u+C*m+o*B,n[2]=i*h+C*p+o*Z,n[3]=a*d+s*b+l*G,n[4]=a*u+s*m+l*B,n[5]=a*h+s*p+l*Z,n[6]=r*d+A*b+c*G,n[7]=r*u+A*m+c*B,n[8]=r*h+A*p+c*Z,g}scale(e,g){void 0===g&&(g=new yB);const t=this.elements,I=g.elements;for(let g=0;3!==g;g++)I[3*g+0]=e.x*t[3*g+0],I[3*g+1]=e.y*t[3*g+1],I[3*g+2]=e.z*t[3*g+2];return g}solve(e,g){void 0===g&&(g=new WB);const t=[];let I,n;for(I=0;I<12;I++)t.push(0);for(I=0;I<3;I++)for(n=0;n<3;n++)t[I+4*n]=this.elements[I+3*n];t[3]=e.x,t[7]=e.y,t[11]=e.z;let i=3;const C=i;let o,a;do{if(I=C-i,0===t[I+4*I])for(n=I+1;n<C;n++)if(0!==t[I+4*n]){o=4;do{a=4-o,t[a+4*I]+=t[a+4*n]}while(--o);break}if(0!==t[I+4*I])for(n=I+1;n<C;n++){const e=t[I+4*n]/t[I+4*I];o=4;do{a=4-o,t[a+4*n]=a<=I?0:t[a+4*n]-t[a+4*I]*e}while(--o)}}while(--i);if(g.z=t[11]/t[10],g.y=(t[7]-t[6]*g.z)/t[5],g.x=(t[3]-t[2]*g.z-t[1]*g.y)/t[0],isNaN(g.x)||isNaN(g.y)||isNaN(g.z)||g.x===1/0||g.y===1/0||g.z===1/0)throw`Could not solve equation! Got x=[${g.toString()}], b=[${e.toString()}], A=[${this.toString()}]`;return g}e(e,g,t){if(void 0===t)return this.elements[g+3*e];this.elements[g+3*e]=t}copy(e){for(let g=0;g<e.elements.length;g++)this.elements[g]=e.elements[g];return this}toString(){let e="";for(let g=0;g<9;g++)e+=this.elements[g]+",";return e}reverse(e){void 0===e&&(e=new yB);const g=vB;let t,I;for(t=0;t<3;t++)for(I=0;I<3;I++)g[t+6*I]=this.elements[t+3*I];g[3]=1,g[9]=0,g[15]=0,g[4]=0,g[10]=1,g[16]=0,g[5]=0,g[11]=0,g[17]=1;let n=3;const i=n;let C,o;do{if(t=i-n,0===g[t+6*t])for(I=t+1;I<i;I++)if(0!==g[t+6*I]){C=6;do{o=6-C,g[o+6*t]+=g[o+6*I]}while(--C);break}if(0!==g[t+6*t])for(I=t+1;I<i;I++){const e=g[t+6*I]/g[t+6*t];C=6;do{o=6-C,g[o+6*I]=o<=t?0:g[o+6*I]-g[o+6*t]*e}while(--C)}}while(--n);t=2;do{I=t-1;do{const e=g[t+6*I]/g[t+6*t];C=6;do{o=6-C,g[o+6*I]=g[o+6*I]-g[o+6*t]*e}while(--C)}while(I--)}while(--t);t=2;do{const e=1/g[t+6*t];C=6;do{o=6-C,g[o+6*t]=g[o+6*t]*e}while(--C)}while(t--);t=2;do{I=2;do{if(o=g[3+I+6*t],isNaN(o)||o===1/0)throw`Could not reverse! A=[${this.toString()}]`;e.e(t,I,o)}while(I--)}while(t--);return e}setRotationFromQuaternion(e){const g=e.x,t=e.y,I=e.z,n=e.w,i=g+g,C=t+t,o=I+I,a=g*i,s=g*C,l=g*o,r=t*C,A=t*o,c=I*o,d=n*i,u=n*C,h=n*o,b=this.elements;return b[0]=1-(r+c),b[1]=s-h,b[2]=l+u,b[3]=s+h,b[4]=1-(a+c),b[5]=A-d,b[6]=l-u,b[7]=A+d,b[8]=1-(a+r),this}transpose(e){void 0===e&&(e=new yB);const g=this.elements,t=e.elements;let I;return t[0]=g[0],t[4]=g[4],t[8]=g[8],I=g[1],t[1]=g[3],t[3]=I,I=g[2],t[2]=g[6],t[6]=I,I=g[5],t[5]=g[7],t[7]=I,e}}const vB=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];class WB{constructor(e,g,t){void 0===e&&(e=0),void 0===g&&(g=0),void 0===t&&(t=0),this.x=e,this.y=g,this.z=t}cross(e,g){void 0===g&&(g=new WB);const t=e.x,I=e.y,n=e.z,i=this.x,C=this.y,o=this.z;return g.x=C*n-o*I,g.y=o*t-i*n,g.z=i*I-C*t,g}set(e,g,t){return this.x=e,this.y=g,this.z=t,this}setZero(){this.x=this.y=this.z=0}vadd(e,g){if(!g)return new WB(this.x+e.x,this.y+e.y,this.z+e.z);g.x=e.x+this.x,g.y=e.y+this.y,g.z=e.z+this.z}vsub(e,g){if(!g)return new WB(this.x-e.x,this.y-e.y,this.z-e.z);g.x=this.x-e.x,g.y=this.y-e.y,g.z=this.z-e.z}crossmat(){return new yB([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])}normalize(){const e=this.x,g=this.y,t=this.z,I=Math.sqrt(e*e+g*g+t*t);if(I>0){const e=1/I;this.x*=e,this.y*=e,this.z*=e}else this.x=0,this.y=0,this.z=0;return I}unit(e){void 0===e&&(e=new WB);const g=this.x,t=this.y,I=this.z;let n=Math.sqrt(g*g+t*t+I*I);return n>0?(n=1/n,e.x=g*n,e.y=t*n,e.z=I*n):(e.x=1,e.y=0,e.z=0),e}length(){const e=this.x,g=this.y,t=this.z;return Math.sqrt(e*e+g*g+t*t)}lengthSquared(){return this.dot(this)}distanceTo(e){const g=this.x,t=this.y,I=this.z,n=e.x,i=e.y,C=e.z;return Math.sqrt((n-g)*(n-g)+(i-t)*(i-t)+(C-I)*(C-I))}distanceSquared(e){const g=this.x,t=this.y,I=this.z,n=e.x,i=e.y,C=e.z;return(n-g)*(n-g)+(i-t)*(i-t)+(C-I)*(C-I)}scale(e,g){void 0===g&&(g=new WB);const t=this.x,I=this.y,n=this.z;return g.x=e*t,g.y=e*I,g.z=e*n,g}vmul(e,g){return void 0===g&&(g=new WB),g.x=e.x*this.x,g.y=e.y*this.y,g.z=e.z*this.z,g}addScaledVector(e,g,t){return void 0===t&&(t=new WB),t.x=this.x+e*g.x,t.y=this.y+e*g.y,t.z=this.z+e*g.z,t}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}isZero(){return 0===this.x&&0===this.y&&0===this.z}negate(e){return void 0===e&&(e=new WB),e.x=-this.x,e.y=-this.y,e.z=-this.z,e}tangents(e,g){const t=this.length();if(t>0){const I=fB,n=1/t;I.set(this.x*n,this.y*n,this.z*n);const i=wB;Math.abs(I.x)<.9?(i.set(1,0,0),I.cross(i,e)):(i.set(0,1,0),I.cross(i,e)),I.cross(e,g)}else e.set(1,0,0),g.set(0,1,0)}toString(){return`${this.x},${this.y},${this.z}`}toArray(){return[this.x,this.y,this.z]}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}lerp(e,g,t){const I=this.x,n=this.y,i=this.z;t.x=I+(e.x-I)*g,t.y=n+(e.y-n)*g,t.z=i+(e.z-i)*g}almostEquals(e,g){return void 0===g&&(g=1e-6),!(Math.abs(this.x-e.x)>g||Math.abs(this.y-e.y)>g||Math.abs(this.z-e.z)>g)}almostZero(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)}isAntiparallelTo(e,g){return this.negate(RB),RB.almostEquals(e,g)}clone(){return new WB(this.x,this.y,this.z)}}WB.ZERO=new WB(0,0,0),WB.UNIT_X=new WB(1,0,0),WB.UNIT_Y=new WB(0,1,0),WB.UNIT_Z=new WB(0,0,1);const fB=new WB,wB=new WB,RB=new WB;class VB{constructor(e){void 0===e&&(e={}),this.lowerBound=new WB,this.upperBound=new WB,e.lowerBound&&this.lowerBound.copy(e.lowerBound),e.upperBound&&this.upperBound.copy(e.upperBound)}setFromPoints(e,g,t,I){const n=this.lowerBound,i=this.upperBound,C=t;n.copy(e[0]),C&&C.vmult(n,n),i.copy(n);for(let g=1;g<e.length;g++){let t=e[g];C&&(C.vmult(t,XB),t=XB),t.x>i.x&&(i.x=t.x),t.x<n.x&&(n.x=t.x),t.y>i.y&&(i.y=t.y),t.y<n.y&&(n.y=t.y),t.z>i.z&&(i.z=t.z),t.z<n.z&&(n.z=t.z)}return g&&(g.vadd(n,n),g.vadd(i,i)),I&&(n.x-=I,n.y-=I,n.z-=I,i.x+=I,i.y+=I,i.z+=I),this}copy(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this}clone(){return(new VB).copy(this)}extend(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)}overlaps(e){const g=this.lowerBound,t=this.upperBound,I=e.lowerBound,n=e.upperBound,i=I.x<=t.x&&t.x<=n.x||g.x<=n.x&&n.x<=t.x,C=I.y<=t.y&&t.y<=n.y||g.y<=n.y&&n.y<=t.y,o=I.z<=t.z&&t.z<=n.z||g.z<=n.z&&n.z<=t.z;return i&&C&&o}volume(){const e=this.lowerBound,g=this.upperBound;return(g.x-e.x)*(g.y-e.y)*(g.z-e.z)}contains(e){const g=this.lowerBound,t=this.upperBound,I=e.lowerBound,n=e.upperBound;return g.x<=I.x&&t.x>=n.x&&g.y<=I.y&&t.y>=n.y&&g.z<=I.z&&t.z>=n.z}getCorners(e,g,t,I,n,i,C,o){const a=this.lowerBound,s=this.upperBound;e.copy(a),g.set(s.x,a.y,a.z),t.set(s.x,s.y,a.z),I.set(a.x,s.y,s.z),n.set(s.x,a.y,s.z),i.set(a.x,s.y,a.z),C.set(a.x,a.y,s.z),o.copy(s)}toLocalFrame(e,g){const t=SB,I=t[0],n=t[1],i=t[2],C=t[3],o=t[4],a=t[5],s=t[6],l=t[7];this.getCorners(I,n,i,C,o,a,s,l);for(let g=0;8!==g;g++){const I=t[g];e.pointToLocal(I,I)}return g.setFromPoints(t)}toWorldFrame(e,g){const t=SB,I=t[0],n=t[1],i=t[2],C=t[3],o=t[4],a=t[5],s=t[6],l=t[7];this.getCorners(I,n,i,C,o,a,s,l);for(let g=0;8!==g;g++){const I=t[g];e.pointToWorld(I,I)}return g.setFromPoints(t)}overlapsRay(e){const{direction:g,from:t}=e,I=1/g.x,n=1/g.y,i=1/g.z,C=(this.lowerBound.x-t.x)*I,o=(this.upperBound.x-t.x)*I,a=(this.lowerBound.y-t.y)*n,s=(this.upperBound.y-t.y)*n,l=(this.lowerBound.z-t.z)*i,r=(this.upperBound.z-t.z)*i,A=Math.max(Math.max(Math.min(C,o),Math.min(a,s)),Math.min(l,r)),c=Math.min(Math.min(Math.max(C,o),Math.max(a,s)),Math.max(l,r));return!(c<0||A>c)}}const XB=new WB,SB=[new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB];class YB{addEventListener(e,g){void 0===this._listeners&&(this._listeners={});const t=this._listeners;return void 0===t[e]&&(t[e]=[]),t[e].includes(g)||t[e].push(g),this}hasEventListener(e,g){if(void 0===this._listeners)return!1;const t=this._listeners;return!(void 0===t[e]||!t[e].includes(g))}hasAnyEventListener(e){return void 0!==this._listeners&&void 0!==this._listeners[e]}removeEventListener(e,g){if(void 0===this._listeners)return this;const t=this._listeners;if(void 0===t[e])return this;const I=t[e].indexOf(g);return-1!==I&&t[e].splice(I,1),this}dispatchEvent(e){if(void 0===this._listeners)return this;const g=this._listeners[e.type];if(void 0!==g){e.target=this;for(let t=0,I=g.length;t<I;t++)g[t].call(this,e)}return this}}class KB{constructor(e,g,t,I){void 0===e&&(e=0),void 0===g&&(g=0),void 0===t&&(t=0),void 0===I&&(I=1),this.x=e,this.y=g,this.z=t,this.w=I}set(e,g,t,I){return this.x=e,this.y=g,this.z=t,this.w=I,this}toString(){return`${this.x},${this.y},${this.z},${this.w}`}toArray(){return[this.x,this.y,this.z,this.w]}setFromAxisAngle(e,g){const t=Math.sin(.5*g);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=Math.cos(.5*g),this}toAxisAngle(e){void 0===e&&(e=new WB),this.normalize();const g=2*Math.acos(this.w),t=Math.sqrt(1-this.w*this.w);return t<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/t,e.y=this.y/t,e.z=this.z/t),[e,g]}setFromVectors(e,g){if(e.isAntiparallelTo(g)){const g=HB,t=NB;e.tangents(g,t),this.setFromAxisAngle(g,Math.PI)}else{const t=e.cross(g);this.x=t.x,this.y=t.y,this.z=t.z,this.w=Math.sqrt(e.length()**2*g.length()**2)+e.dot(g),this.normalize()}return this}mult(e,g){void 0===g&&(g=new KB);const t=this.x,I=this.y,n=this.z,i=this.w,C=e.x,o=e.y,a=e.z,s=e.w;return g.x=t*s+i*C+I*a-n*o,g.y=I*s+i*o+n*C-t*a,g.z=n*s+i*a+t*o-I*C,g.w=i*s-t*C-I*o-n*a,g}inverse(e){void 0===e&&(e=new KB);const g=this.x,t=this.y,I=this.z,n=this.w;this.conjugate(e);const i=1/(g*g+t*t+I*I+n*n);return e.x*=i,e.y*=i,e.z*=i,e.w*=i,e}conjugate(e){return void 0===e&&(e=new KB),e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e}normalize(){let e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this}normalizeFast(){const e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this}vmult(e,g){void 0===g&&(g=new WB);const t=e.x,I=e.y,n=e.z,i=this.x,C=this.y,o=this.z,a=this.w,s=a*t+C*n-o*I,l=a*I+o*t-i*n,r=a*n+i*I-C*t,A=-i*t-C*I-o*n;return g.x=s*a+A*-i+l*-o-r*-C,g.y=l*a+A*-C+r*-i-s*-o,g.z=r*a+A*-o+s*-C-l*-i,g}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}toEuler(e,g){let t,I,n;void 0===g&&(g="YZX");const i=this.x,C=this.y,o=this.z,a=this.w;if("YZX"!==g)throw new Error(`Euler order ${g} not supported yet.`);{const e=i*C+o*a;if(e>.499&&(t=2*Math.atan2(i,a),I=Math.PI/2,n=0),e<-.499&&(t=-2*Math.atan2(i,a),I=-Math.PI/2,n=0),void 0===t){const g=i*i,s=C*C,l=o*o;t=Math.atan2(2*C*a-2*i*o,1-2*s-2*l),I=Math.asin(2*e),n=Math.atan2(2*i*a-2*C*o,1-2*g-2*l)}}e.y=t,e.z=I,e.x=n}setFromEuler(e,g,t,I){void 0===I&&(I="XYZ");const n=Math.cos(e/2),i=Math.cos(g/2),C=Math.cos(t/2),o=Math.sin(e/2),a=Math.sin(g/2),s=Math.sin(t/2);return"XYZ"===I?(this.x=o*i*C+n*a*s,this.y=n*a*C-o*i*s,this.z=n*i*s+o*a*C,this.w=n*i*C-o*a*s):"YXZ"===I?(this.x=o*i*C+n*a*s,this.y=n*a*C-o*i*s,this.z=n*i*s-o*a*C,this.w=n*i*C+o*a*s):"ZXY"===I?(this.x=o*i*C-n*a*s,this.y=n*a*C+o*i*s,this.z=n*i*s+o*a*C,this.w=n*i*C-o*a*s):"ZYX"===I?(this.x=o*i*C-n*a*s,this.y=n*a*C+o*i*s,this.z=n*i*s-o*a*C,this.w=n*i*C+o*a*s):"YZX"===I?(this.x=o*i*C+n*a*s,this.y=n*a*C+o*i*s,this.z=n*i*s-o*a*C,this.w=n*i*C-o*a*s):"XZY"===I&&(this.x=o*i*C-n*a*s,this.y=n*a*C-o*i*s,this.z=n*i*s+o*a*C,this.w=n*i*C+o*a*s),this}clone(){return new KB(this.x,this.y,this.z,this.w)}slerp(e,g,t){void 0===t&&(t=new KB);const I=this.x,n=this.y,i=this.z,C=this.w;let o,a,s,l,r,A=e.x,c=e.y,d=e.z,u=e.w;return a=I*A+n*c+i*d+C*u,a<0&&(a=-a,A=-A,c=-c,d=-d,u=-u),1-a>1e-6?(o=Math.acos(a),s=Math.sin(o),l=Math.sin((1-g)*o)/s,r=Math.sin(g*o)/s):(l=1-g,r=g),t.x=l*I+r*A,t.y=l*n+r*c,t.z=l*i+r*d,t.w=l*C+r*u,t}integrate(e,g,t,I){void 0===I&&(I=new KB);const n=e.x*t.x,i=e.y*t.y,C=e.z*t.z,o=this.x,a=this.y,s=this.z,l=this.w,r=.5*g;return I.x+=r*(n*l+i*s-C*a),I.y+=r*(i*l+C*o-n*s),I.z+=r*(C*l+n*a-i*o),I.w+=r*(-n*o-i*a-C*s),I}}const HB=new WB,NB=new WB;class FB{constructor(e){void 0===e&&(e={}),this.id=FB.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}updateBoundingSphereRadius(){throw`computeBoundingSphereRadius() not implemented for shape type ${this.type}`}volume(){throw`volume() not implemented for shape type ${this.type}`}calculateLocalInertia(e,g){throw`calculateLocalInertia() not implemented for shape type ${this.type}`}calculateWorldAABB(e,g,t,I){throw`calculateWorldAABB() not implemented for shape type ${this.type}`}}FB.idCounter=0,FB.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256};class xB{constructor(e){void 0===e&&(e={}),this.position=new WB,this.quaternion=new KB,e.position&&this.position.copy(e.position),e.quaternion&&this.quaternion.copy(e.quaternion)}pointToLocal(e,g){return xB.pointToLocalFrame(this.position,this.quaternion,e,g)}pointToWorld(e,g){return xB.pointToWorldFrame(this.position,this.quaternion,e,g)}vectorToWorldFrame(e,g){return void 0===g&&(g=new WB),this.quaternion.vmult(e,g),g}static pointToLocalFrame(e,g,t,I){return void 0===I&&(I=new WB),t.vsub(e,I),g.conjugate(zB),zB.vmult(I,I),I}static pointToWorldFrame(e,g,t,I){return void 0===I&&(I=new WB),g.vmult(t,I),I.vadd(e,I),I}static vectorToWorldFrame(e,g,t){return void 0===t&&(t=new WB),e.vmult(g,t),t}static vectorToLocalFrame(e,g,t,I){return void 0===I&&(I=new WB),g.w*=-1,g.vmult(t,I),g.w*=-1,I}}const zB=new KB;class kB extends FB{constructor(e){void 0===e&&(e={});const{vertices:g=[],faces:t=[],normals:I=[],axes:n,boundingSphereRadius:i}=e;super({type:FB.types.CONVEXPOLYHEDRON}),this.vertices=g,this.faces=t,this.faceNormals=I,0===this.faceNormals.length&&this.computeNormals(),i?this.boundingSphereRadius=i:this.updateBoundingSphereRadius(),this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.worldFaceNormals=[],this.worldFaceNormalsNeedsUpdate=!0,this.uniqueAxes=n?n.slice():null,this.uniqueEdges=[],this.computeEdges()}computeEdges(){const e=this.faces,g=this.vertices,t=this.uniqueEdges;t.length=0;const I=new WB;for(let n=0;n!==e.length;n++){const i=e[n],C=i.length;for(let e=0;e!==C;e++){const n=(e+1)%C;g[i[e]].vsub(g[i[n]],I),I.normalize();let o=!1;for(let e=0;e!==t.length;e++)if(t[e].almostEquals(I)||t[e].almostEquals(I)){o=!0;break}o||t.push(I.clone())}}}computeNormals(){this.faceNormals.length=this.faces.length;for(let e=0;e<this.faces.length;e++){for(let g=0;g<this.faces[e].length;g++)if(!this.vertices[this.faces[e][g]])throw new Error(`Vertex ${this.faces[e][g]} not found!`);const g=this.faceNormals[e]||new WB;this.getFaceNormal(e,g),g.negate(g),this.faceNormals[e]=g;const t=this.vertices[this.faces[e][0]];if(g.dot(t)<0){console.error(`.faceNormals[${e}] = Vec3(${g.toString()}) looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.`);for(let g=0;g<this.faces[e].length;g++)console.warn(`.vertices[${this.faces[e][g]}] = Vec3(${this.vertices[this.faces[e][g]].toString()})`)}}}getFaceNormal(e,g){const t=this.faces[e],I=this.vertices[t[0]],n=this.vertices[t[1]],i=this.vertices[t[2]];kB.computeNormal(I,n,i,g)}static computeNormal(e,g,t,I){const n=new WB,i=new WB;g.vsub(e,i),t.vsub(g,n),n.cross(i,I),I.isZero()||I.normalize()}clipAgainstHull(e,g,t,I,n,i,C,o,a){const s=new WB;let l=-1,r=-Number.MAX_VALUE;for(let e=0;e<t.faces.length;e++){s.copy(t.faceNormals[e]),n.vmult(s,s);const g=s.dot(i);g>r&&(r=g,l=e)}const A=[];for(let e=0;e<t.faces[l].length;e++){const g=t.vertices[t.faces[l][e]],i=new WB;i.copy(g),n.vmult(i,i),I.vadd(i,i),A.push(i)}l>=0&&this.clipFaceAgainstHull(i,e,g,A,C,o,a)}findSeparatingAxis(e,g,t,I,n,i,C,o){const a=new WB,s=new WB,l=new WB,r=new WB,A=new WB,c=new WB;let d=Number.MAX_VALUE;const u=this;if(u.uniqueAxes)for(let C=0;C!==u.uniqueAxes.length;C++){t.vmult(u.uniqueAxes[C],a);const o=u.testSepAxis(a,e,g,t,I,n);if(!1===o)return!1;o<d&&(d=o,i.copy(a))}else{const o=C?C.length:u.faces.length;for(let s=0;s<o;s++){const o=C?C[s]:s;a.copy(u.faceNormals[o]),t.vmult(a,a);const l=u.testSepAxis(a,e,g,t,I,n);if(!1===l)return!1;l<d&&(d=l,i.copy(a))}}if(e.uniqueAxes)for(let C=0;C!==e.uniqueAxes.length;C++){n.vmult(e.uniqueAxes[C],s);const o=u.testSepAxis(s,e,g,t,I,n);if(!1===o)return!1;o<d&&(d=o,i.copy(s))}else{const C=o?o.length:e.faces.length;for(let a=0;a<C;a++){const C=o?o[a]:a;s.copy(e.faceNormals[C]),n.vmult(s,s);const l=u.testSepAxis(s,e,g,t,I,n);if(!1===l)return!1;l<d&&(d=l,i.copy(s))}}for(let C=0;C!==u.uniqueEdges.length;C++){t.vmult(u.uniqueEdges[C],r);for(let C=0;C!==e.uniqueEdges.length;C++)if(n.vmult(e.uniqueEdges[C],A),r.cross(A,c),!c.almostZero()){c.normalize();const C=u.testSepAxis(c,e,g,t,I,n);if(!1===C)return!1;C<d&&(d=C,i.copy(c))}}return I.vsub(g,l),l.dot(i)>0&&i.negate(i),!0}testSepAxis(e,g,t,I,n,i){kB.project(this,e,t,I,MB),kB.project(g,e,n,i,LB);const C=MB[0],o=MB[1],a=LB[0],s=LB[1];if(C<s||a<o)return!1;const l=C-s,r=a-o;return l<r?l:r}calculateLocalInertia(e,g){const t=new WB,I=new WB;this.computeLocalAABB(I,t);const n=t.x-I.x,i=t.y-I.y,C=t.z-I.z;g.x=1/12*e*(2*i*2*i+2*C*2*C),g.y=1/12*e*(2*n*2*n+2*C*2*C),g.z=1/12*e*(2*i*2*i+2*n*2*n)}getPlaneConstantOfFace(e){const g=this.faces[e],t=this.faceNormals[e],I=this.vertices[g[0]];return-t.dot(I)}clipFaceAgainstHull(e,g,t,I,n,i,C){const o=new WB,a=new WB,s=new WB,l=new WB,r=new WB,A=new WB,c=new WB,d=new WB,u=this,h=I,b=[];let m=-1,p=Number.MAX_VALUE;for(let g=0;g<u.faces.length;g++){o.copy(u.faceNormals[g]),t.vmult(o,o);const I=o.dot(e);I<p&&(p=I,m=g)}if(m<0)return;const G=u.faces[m];G.connectedFaces=[];for(let e=0;e<u.faces.length;e++)for(let g=0;g<u.faces[e].length;g++)-1!==G.indexOf(u.faces[e][g])&&e!==m&&-1===G.connectedFaces.indexOf(e)&&G.connectedFaces.push(e);const B=G.length;for(let e=0;e<B;e++){const I=u.vertices[G[e]],n=u.vertices[G[(e+1)%B]];I.vsub(n,a),s.copy(a),t.vmult(s,s),g.vadd(s,s),l.copy(this.faceNormals[m]),t.vmult(l,l),g.vadd(l,l),s.cross(l,r),r.negate(r),A.copy(I),t.vmult(A,A),g.vadd(A,A);const i=G.connectedFaces[e];c.copy(this.faceNormals[i]);const C=this.getPlaneConstantOfFace(i);d.copy(c),t.vmult(d,d);const o=C-d.dot(g);for(this.clipFaceAgainstPlane(h,b,d,o);h.length;)h.shift();for(;b.length;)h.push(b.shift())}c.copy(this.faceNormals[m]);const Z=this.getPlaneConstantOfFace(m);d.copy(c),t.vmult(d,d);const y=Z-d.dot(g);for(let e=0;e<h.length;e++){let g=d.dot(h[e])+y;if(g<=n&&(console.log(`clamped: depth=${g} to minDist=${n}`),g=n),g<=i){const t=h[e];if(g<=1e-6){const e={point:t,normal:d,depth:g};C.push(e)}}}}clipFaceAgainstPlane(e,g,t,I){let n,i;const C=e.length;if(C<2)return g;let o=e[e.length-1],a=e[0];n=t.dot(o)+I;for(let s=0;s<C;s++){if(a=e[s],i=t.dot(a)+I,n<0)if(i<0){const e=new WB;e.copy(a),g.push(e)}else{const e=new WB;o.lerp(a,n/(n-i),e),g.push(e)}else if(i<0){const e=new WB;o.lerp(a,n/(n-i),e),g.push(e),g.push(a)}o=a,n=i}return g}computeWorldVertices(e,g){for(;this.worldVertices.length<this.vertices.length;)this.worldVertices.push(new WB);const t=this.vertices,I=this.worldVertices;for(let n=0;n!==this.vertices.length;n++)g.vmult(t[n],I[n]),e.vadd(I[n],I[n]);this.worldVerticesNeedsUpdate=!1}computeLocalAABB(e,g){const t=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),g.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let I=0;I<this.vertices.length;I++){const n=t[I];n.x<e.x?e.x=n.x:n.x>g.x&&(g.x=n.x),n.y<e.y?e.y=n.y:n.y>g.y&&(g.y=n.y),n.z<e.z?e.z=n.z:n.z>g.z&&(g.z=n.z)}}computeWorldFaceNormals(e){const g=this.faceNormals.length;for(;this.worldFaceNormals.length<g;)this.worldFaceNormals.push(new WB);const t=this.faceNormals,I=this.worldFaceNormals;for(let n=0;n!==g;n++)e.vmult(t[n],I[n]);this.worldFaceNormalsNeedsUpdate=!1}updateBoundingSphereRadius(){let e=0;const g=this.vertices;for(let t=0;t!==g.length;t++){const I=g[t].lengthSquared();I>e&&(e=I)}this.boundingSphereRadius=Math.sqrt(e)}calculateWorldAABB(e,g,t,I){const n=this.vertices;let i,C,o,a,s,l,r=new WB;for(let t=0;t<n.length;t++){r.copy(n[t]),g.vmult(r,r),e.vadd(r,r);const I=r;(void 0===i||I.x<i)&&(i=I.x),(void 0===a||I.x>a)&&(a=I.x),(void 0===C||I.y<C)&&(C=I.y),(void 0===s||I.y>s)&&(s=I.y),(void 0===o||I.z<o)&&(o=I.z),(void 0===l||I.z>l)&&(l=I.z)}t.set(i,C,o),I.set(a,s,l)}volume(){return 4*Math.PI*this.boundingSphereRadius/3}getAveragePointLocal(e){void 0===e&&(e=new WB);const g=this.vertices;for(let t=0;t<g.length;t++)e.vadd(g[t],e);return e.scale(1/g.length,e),e}transformAllPoints(e,g){const t=this.vertices.length,I=this.vertices;if(g){for(let e=0;e<t;e++){const t=I[e];g.vmult(t,t)}for(let e=0;e<this.faceNormals.length;e++){const t=this.faceNormals[e];g.vmult(t,t)}}if(e)for(let g=0;g<t;g++){const t=I[g];t.vadd(e,t)}}pointIsInside(e){const g=this.vertices,t=this.faces,I=this.faceNormals,n=new WB;this.getAveragePointLocal(n);for(let i=0;i<this.faces.length;i++){let C=I[i];const o=g[t[i][0]],a=new WB;e.vsub(o,a);const s=C.dot(a),l=new WB;n.vsub(o,l);const r=C.dot(l);if(s<0&&r>0||s>0&&r<0)return!1}return-1}static project(e,g,t,I,n){const i=e.vertices.length,C=JB;let o=0,a=0;const s=EB,l=e.vertices;s.setZero(),xB.vectorToLocalFrame(t,I,g,C),xB.pointToLocalFrame(t,I,s,s);const r=s.dot(C);a=o=l[0].dot(C);for(let e=1;e<i;e++){const g=l[e].dot(C);g>o&&(o=g),g<a&&(a=g)}if(a-=r,o-=r,a>o){const e=a;a=o,o=e}n[0]=o,n[1]=a}}const MB=[],LB=[],JB=(new WB,new WB),EB=new WB;class TB extends FB{constructor(e){super({type:FB.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}updateConvexPolyhedronRepresentation(){const e=this.halfExtents.x,g=this.halfExtents.y,t=this.halfExtents.z,I=WB,n=[new I(-e,-g,-t),new I(e,-g,-t),new I(e,g,-t),new I(-e,g,-t),new I(-e,-g,t),new I(e,-g,t),new I(e,g,t),new I(-e,g,t)],i=[new I(0,0,1),new I(0,1,0),new I(1,0,0)],C=new kB({vertices:n,faces:[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],axes:i});this.convexPolyhedronRepresentation=C,C.material=this.material}calculateLocalInertia(e,g){return void 0===g&&(g=new WB),TB.calculateInertia(this.halfExtents,e,g),g}static calculateInertia(e,g,t){const I=e;t.x=1/12*g*(2*I.y*2*I.y+2*I.z*2*I.z),t.y=1/12*g*(2*I.x*2*I.x+2*I.z*2*I.z),t.z=1/12*g*(2*I.y*2*I.y+2*I.x*2*I.x)}getSideNormals(e,g){const t=e,I=this.halfExtents;if(t[0].set(I.x,0,0),t[1].set(0,I.y,0),t[2].set(0,0,I.z),t[3].set(-I.x,0,0),t[4].set(0,-I.y,0),t[5].set(0,0,-I.z),void 0!==g)for(let e=0;e!==t.length;e++)g.vmult(t[e],t[e]);return t}volume(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z}updateBoundingSphereRadius(){this.boundingSphereRadius=this.halfExtents.length()}forEachWorldCorner(e,g,t){const I=this.halfExtents,n=[[I.x,I.y,I.z],[-I.x,I.y,I.z],[-I.x,-I.y,I.z],[-I.x,-I.y,-I.z],[I.x,-I.y,-I.z],[I.x,I.y,-I.z],[-I.x,I.y,-I.z],[I.x,-I.y,I.z]];for(let I=0;I<n.length;I++)UB.set(n[I][0],n[I][1],n[I][2]),g.vmult(UB,UB),e.vadd(UB,UB),t(UB.x,UB.y,UB.z)}calculateWorldAABB(e,g,t,I){const n=this.halfExtents;QB[0].set(n.x,n.y,n.z),QB[1].set(-n.x,n.y,n.z),QB[2].set(-n.x,-n.y,n.z),QB[3].set(-n.x,-n.y,-n.z),QB[4].set(n.x,-n.y,-n.z),QB[5].set(n.x,n.y,-n.z),QB[6].set(-n.x,n.y,-n.z),QB[7].set(n.x,-n.y,n.z);const i=QB[0];g.vmult(i,i),e.vadd(i,i),I.copy(i),t.copy(i);for(let n=1;n<8;n++){const i=QB[n];g.vmult(i,i),e.vadd(i,i);const C=i.x,o=i.y,a=i.z;C>I.x&&(I.x=C),o>I.y&&(I.y=o),a>I.z&&(I.z=a),C<t.x&&(t.x=C),o<t.y&&(t.y=o),a<t.z&&(t.z=a)}}}const UB=new WB,QB=[new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB];class DB extends YB{constructor(e){void 0===e&&(e={}),super(),this.id=DB.idCounter++,this.index=-1,this.world=null,this.vlambda=new WB,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse="boolean"!=typeof e.collisionResponse||e.collisionResponse,this.position=new WB,this.previousPosition=new WB,this.interpolatedPosition=new WB,this.initPosition=new WB,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new WB,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new WB,this.force=new WB;const g="number"==typeof e.mass?e.mass:0;this.mass=g,this.invMass=g>0?1/g:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=g<=0?DB.STATIC:DB.DYNAMIC,typeof e.type==typeof DB.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=DB.AWAKE,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this.wakeUpAfterNarrowphase=!1,this.torque=new WB,this.quaternion=new KB,this.initQuaternion=new KB,this.previousQuaternion=new KB,this.interpolatedQuaternion=new KB,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new WB,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new WB,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new WB,this.invInertia=new WB,this.invInertiaWorld=new yB,this.invMassSolve=0,this.invInertiaSolve=new WB,this.invInertiaWorldSolve=new yB,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new WB(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new WB(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new VB,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new WB,this.isTrigger=Boolean(e.isTrigger),e.shape&&this.addShape(e.shape),this.updateMassProperties()}wakeUp(){const e=this.sleepState;this.sleepState=DB.AWAKE,this.wakeUpAfterNarrowphase=!1,e===DB.SLEEPING&&this.dispatchEvent(DB.wakeupEvent)}sleep(){this.sleepState=DB.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.wakeUpAfterNarrowphase=!1}sleepTick(e){if(this.allowSleep){const g=this.sleepState,t=this.velocity.lengthSquared()+this.angularVelocity.lengthSquared(),I=this.sleepSpeedLimit**2;g===DB.AWAKE&&t<I?(this.sleepState=DB.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(DB.sleepyEvent)):g===DB.SLEEPY&&t>I?this.wakeUp():g===DB.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(DB.sleepEvent))}}updateSolveMassProperties(){this.sleepState===DB.SLEEPING||this.type===DB.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))}pointToLocalFrame(e,g){return void 0===g&&(g=new WB),e.vsub(this.position,g),this.quaternion.conjugate().vmult(g,g),g}vectorToLocalFrame(e,g){return void 0===g&&(g=new WB),this.quaternion.conjugate().vmult(e,g),g}pointToWorldFrame(e,g){return void 0===g&&(g=new WB),this.quaternion.vmult(e,g),g.vadd(this.position,g),g}vectorToWorldFrame(e,g){return void 0===g&&(g=new WB),this.quaternion.vmult(e,g),g}addShape(e,g,t){const I=new WB,n=new KB;return g&&I.copy(g),t&&n.copy(t),this.shapes.push(e),this.shapeOffsets.push(I),this.shapeOrientations.push(n),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=this,this}removeShape(e){const g=this.shapes.indexOf(e);return-1===g?(console.warn("Shape does not belong to the body"),this):(this.shapes.splice(g,1),this.shapeOffsets.splice(g,1),this.shapeOrientations.splice(g,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=null,this)}updateBoundingRadius(){const e=this.shapes,g=this.shapeOffsets,t=e.length;let I=0;for(let n=0;n!==t;n++){const t=e[n];t.updateBoundingSphereRadius();const i=g[n].length(),C=t.boundingSphereRadius;i+C>I&&(I=i+C)}this.boundingRadius=I}updateAABB(){const e=this.shapes,g=this.shapeOffsets,t=this.shapeOrientations,I=e.length,n=OB,i=jB,C=this.quaternion,o=this.aabb,a=PB;for(let s=0;s!==I;s++){const I=e[s];C.vmult(g[s],n),n.vadd(this.position,n),C.mult(t[s],i),I.calculateWorldAABB(n,i,a.lowerBound,a.upperBound),0===s?o.copy(a):o.extend(a)}this.aabbNeedsUpdate=!1}updateInertiaWorld(e){const g=this.invInertia;if(g.x!==g.y||g.y!==g.z||e){const e=_B,t=qB;e.setRotationFromQuaternion(this.quaternion),e.transpose(t),e.scale(g,e),e.mmult(t,this.invInertiaWorld)}}applyForce(e,g){if(void 0===g&&(g=new WB),this.type!==DB.DYNAMIC)return;this.sleepState===DB.SLEEPING&&this.wakeUp();const t=$B;g.cross(e,t),this.force.vadd(e,this.force),this.torque.vadd(t,this.torque)}applyLocalForce(e,g){if(void 0===g&&(g=new WB),this.type!==DB.DYNAMIC)return;const t=eZ,I=gZ;this.vectorToWorldFrame(e,t),this.vectorToWorldFrame(g,I),this.applyForce(t,I)}applyTorque(e){this.type===DB.DYNAMIC&&(this.sleepState===DB.SLEEPING&&this.wakeUp(),this.torque.vadd(e,this.torque))}applyImpulse(e,g){if(void 0===g&&(g=new WB),this.type!==DB.DYNAMIC)return;this.sleepState===DB.SLEEPING&&this.wakeUp();const t=g,I=tZ;I.copy(e),I.scale(this.invMass,I),this.velocity.vadd(I,this.velocity);const n=IZ;t.cross(e,n),this.invInertiaWorld.vmult(n,n),this.angularVelocity.vadd(n,this.angularVelocity)}applyLocalImpulse(e,g){if(void 0===g&&(g=new WB),this.type!==DB.DYNAMIC)return;const t=nZ,I=iZ;this.vectorToWorldFrame(e,t),this.vectorToWorldFrame(g,I),this.applyImpulse(t,I)}updateMassProperties(){const e=CZ;this.invMass=this.mass>0?1/this.mass:0;const g=this.inertia,t=this.fixedRotation;this.updateAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),TB.calculateInertia(e,this.mass,g),this.invInertia.set(g.x>0&&!t?1/g.x:0,g.y>0&&!t?1/g.y:0,g.z>0&&!t?1/g.z:0),this.updateInertiaWorld(!0)}getVelocityAtWorldPoint(e,g){const t=new WB;return e.vsub(this.position,t),this.angularVelocity.cross(t,g),this.velocity.vadd(g,g),g}integrate(e,g,t){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),this.type!==DB.DYNAMIC&&this.type!==DB.KINEMATIC||this.sleepState===DB.SLEEPING)return;const I=this.velocity,n=this.angularVelocity,i=this.position,C=this.force,o=this.torque,a=this.quaternion,s=this.invMass,l=this.invInertiaWorld,r=this.linearFactor,A=s*e;I.x+=C.x*A*r.x,I.y+=C.y*A*r.y,I.z+=C.z*A*r.z;const c=l.elements,d=this.angularFactor,u=o.x*d.x,h=o.y*d.y,b=o.z*d.z;n.x+=e*(c[0]*u+c[1]*h+c[2]*b),n.y+=e*(c[3]*u+c[4]*h+c[5]*b),n.z+=e*(c[6]*u+c[7]*h+c[8]*b),i.x+=I.x*e,i.y+=I.y*e,i.z+=I.z*e,a.integrate(this.angularVelocity,e,this.angularFactor,a),g&&(t?a.normalizeFast():a.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}}DB.idCounter=0,DB.COLLIDE_EVENT_NAME="collide",DB.DYNAMIC=1,DB.STATIC=2,DB.KINEMATIC=4,DB.AWAKE=0,DB.SLEEPY=1,DB.SLEEPING=2,DB.wakeupEvent={type:"wakeup"},DB.sleepyEvent={type:"sleepy"},DB.sleepEvent={type:"sleep"};const OB=new WB,jB=new KB,PB=new VB,_B=new yB,qB=new yB,$B=(new yB,new WB),eZ=new WB,gZ=new WB,tZ=new WB,IZ=new WB,nZ=new WB,iZ=new WB,CZ=new WB;new WB,new WB,new KB,new WB,new WB,new WB,new WB;class oZ{constructor(){this.rayFromWorld=new WB,this.rayToWorld=new WB,this.hitNormalWorld=new WB,this.hitPointWorld=new WB,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}reset(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}abort(){this.shouldStop=!0}set(e,g,t,I,n,i,C){this.rayFromWorld.copy(e),this.rayToWorld.copy(g),this.hitNormalWorld.copy(t),this.hitPointWorld.copy(I),this.shape=n,this.body=i,this.distance=C}}let aZ,sZ,lZ,rZ,AZ,cZ,dZ;aZ=FB.types.SPHERE,sZ=FB.types.PLANE,lZ=FB.types.BOX,rZ=FB.types.CYLINDER,AZ=FB.types.CONVEXPOLYHEDRON,cZ=FB.types.HEIGHTFIELD,dZ=FB.types.TRIMESH;class uZ{get[aZ](){return this._intersectSphere}get[sZ](){return this._intersectPlane}get[lZ](){return this._intersectBox}get[rZ](){return this._intersectConvex}get[AZ](){return this._intersectConvex}get[cZ](){return this._intersectHeightfield}get[dZ](){return this._intersectTrimesh}constructor(e,g){void 0===e&&(e=new WB),void 0===g&&(g=new WB),this.from=e.clone(),this.to=g.clone(),this.direction=new WB,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=uZ.ANY,this.result=new oZ,this.hasHit=!1,this.callback=e=>{}}intersectWorld(e,g){return this.mode=g.mode||uZ.ANY,this.result=g.result||new oZ,this.skipBackfaces=!!g.skipBackfaces,this.collisionFilterMask=void 0!==g.collisionFilterMask?g.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==g.collisionFilterGroup?g.collisionFilterGroup:-1,this.checkCollisionResponse=void 0===g.checkCollisionResponse||g.checkCollisionResponse,g.from&&this.from.copy(g.from),g.to&&this.to.copy(g.to),this.callback=g.callback||(()=>{}),this.hasHit=!1,this.result.reset(),this.updateDirection(),this.getAABB(hZ),bZ.length=0,e.broadphase.aabbQuery(e,hZ,bZ),this.intersectBodies(bZ),this.hasHit}intersectBody(e,g){g&&(this.result=g,this.updateDirection());const t=this.checkCollisionResponse;if(t&&!e.collisionResponse)return;if(0==(this.collisionFilterGroup&e.collisionFilterMask)||0==(e.collisionFilterGroup&this.collisionFilterMask))return;const I=GZ,n=BZ;for(let g=0,i=e.shapes.length;g<i;g++){const i=e.shapes[g];if((!t||i.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[g],n),e.quaternion.vmult(e.shapeOffsets[g],I),I.vadd(e.position,I),this.intersectShape(i,n,I,e),this.result.shouldStop))break}}intersectBodies(e,g){g&&(this.result=g,this.updateDirection());for(let g=0,t=e.length;!this.result.shouldStop&&g<t;g++)this.intersectBody(e[g])}updateDirection(){this.to.vsub(this.from,this.direction),this.direction.normalize()}intersectShape(e,g,t,I){const n=function(e,g,t){t.vsub(e,JZ);const I=JZ.dot(g);g.scale(I,EZ),EZ.vadd(e,EZ);return t.distanceTo(EZ)}(this.from,this.direction,t);if(n>e.boundingSphereRadius)return;const i=this[e.type];i&&i.call(this,e,g,t,I,e)}_intersectBox(e,g,t,I,n){return this._intersectConvex(e.convexPolyhedronRepresentation,g,t,I,n)}_intersectPlane(e,g,t,I,n){const i=this.from,C=this.to,o=this.direction,a=new WB(0,0,1);g.vmult(a,a);const s=new WB;i.vsub(t,s);const l=s.dot(a);if(C.vsub(t,s),l*s.dot(a)>0)return;if(i.distanceTo(C)<l)return;const r=a.dot(o);if(Math.abs(r)<this.precision)return;const A=new WB,c=new WB,d=new WB;i.vsub(t,A);const u=-a.dot(A)/r;o.scale(u,c),i.vadd(c,d),this.reportIntersection(a,d,n,I,-1)}getAABB(e){const{lowerBound:g,upperBound:t}=e,I=this.to,n=this.from;g.x=Math.min(I.x,n.x),g.y=Math.min(I.y,n.y),g.z=Math.min(I.z,n.z),t.x=Math.max(I.x,n.x),t.y=Math.max(I.y,n.y),t.z=Math.max(I.z,n.z)}_intersectHeightfield(e,g,t,I,n){e.data,e.elementSize;const i=RZ;i.from.copy(this.from),i.to.copy(this.to),xB.pointToLocalFrame(t,g,i.from,i.from),xB.pointToLocalFrame(t,g,i.to,i.to),i.updateDirection();const C=VZ;let o,a,s,l;o=a=0,s=l=e.data.length-1;const r=new VB;i.getAABB(r),e.getIndexOfPosition(r.lowerBound.x,r.lowerBound.y,C,!0),o=Math.max(o,C[0]),a=Math.max(a,C[1]),e.getIndexOfPosition(r.upperBound.x,r.upperBound.y,C,!0),s=Math.min(s,C[0]+1),l=Math.min(l,C[1]+1);for(let C=o;C<s;C++)for(let o=a;o<l;o++){if(this.result.shouldStop)return;if(e.getAabbAtIndex(C,o,r),r.overlapsRay(i)){if(e.getConvexTrianglePillar(C,o,!1),xB.pointToWorldFrame(t,g,e.pillarOffset,wZ),this._intersectConvex(e.pillarConvex,g,wZ,I,n,fZ),this.result.shouldStop)return;e.getConvexTrianglePillar(C,o,!0),xB.pointToWorldFrame(t,g,e.pillarOffset,wZ),this._intersectConvex(e.pillarConvex,g,wZ,I,n,fZ)}}}_intersectSphere(e,g,t,I,n){const i=this.from,C=this.to,o=e.radius,a=(C.x-i.x)**2+(C.y-i.y)**2+(C.z-i.z)**2,s=2*((C.x-i.x)*(i.x-t.x)+(C.y-i.y)*(i.y-t.y)+(C.z-i.z)*(i.z-t.z)),l=s**2-4*a*((i.x-t.x)**2+(i.y-t.y)**2+(i.z-t.z)**2-o**2),r=XZ,A=SZ;if(!(l<0))if(0===l)i.lerp(C,l,r),r.vsub(t,A),A.normalize(),this.reportIntersection(A,r,n,I,-1);else{const e=(-s-Math.sqrt(l))/(2*a),g=(-s+Math.sqrt(l))/(2*a);if(e>=0&&e<=1&&(i.lerp(C,e,r),r.vsub(t,A),A.normalize(),this.reportIntersection(A,r,n,I,-1)),this.result.shouldStop)return;g>=0&&g<=1&&(i.lerp(C,g,r),r.vsub(t,A),A.normalize(),this.reportIntersection(A,r,n,I,-1))}}_intersectConvex(e,g,t,I,n,i){const C=YZ,o=KZ,a=i&&i.faceList||null,s=e.faces,l=e.vertices,r=e.faceNormals,A=this.direction,c=this.from,d=this.to,u=c.distanceTo(d),h=a?a.length:s.length,b=this.result;for(let e=0;!b.shouldStop&&e<h;e++){const i=a?a[e]:e,d=s[i],h=r[i],m=g,p=t;o.copy(l[d[0]]),m.vmult(o,o),o.vadd(p,o),o.vsub(c,o),m.vmult(h,C);const G=A.dot(C);if(Math.abs(G)<this.precision)continue;const B=C.dot(o)/G;if(!(B<0)){A.scale(B,ZZ),ZZ.vadd(c,ZZ),yZ.copy(l[d[0]]),m.vmult(yZ,yZ),p.vadd(yZ,yZ);for(let e=1;!b.shouldStop&&e<d.length-1;e++){vZ.copy(l[d[e]]),WZ.copy(l[d[e+1]]),m.vmult(vZ,vZ),m.vmult(WZ,WZ),p.vadd(vZ,vZ),p.vadd(WZ,WZ);const g=ZZ.distanceTo(c);!uZ.pointInTriangle(ZZ,yZ,vZ,WZ)&&!uZ.pointInTriangle(ZZ,vZ,yZ,WZ)||g>u||this.reportIntersection(C,ZZ,n,I,i)}}}}_intersectTrimesh(e,g,t,I,n,i){const C=HZ,o=MZ,a=LZ,s=KZ,l=NZ,r=FZ,A=xZ,c=kZ,d=zZ,u=e.indices;e.vertices;const h=this.from,b=this.to,m=this.direction;a.position.copy(t),a.quaternion.copy(g),xB.vectorToLocalFrame(t,g,m,l),xB.pointToLocalFrame(t,g,h,r),xB.pointToLocalFrame(t,g,b,A),A.x*=e.scale.x,A.y*=e.scale.y,A.z*=e.scale.z,r.x*=e.scale.x,r.y*=e.scale.y,r.z*=e.scale.z,A.vsub(r,l),l.normalize();const p=r.distanceSquared(A);e.tree.rayQuery(this,a,o);for(let i=0,a=o.length;!this.result.shouldStop&&i!==a;i++){const a=o[i];e.getNormal(a,C),e.getVertex(u[3*a],yZ),yZ.vsub(r,s);const A=l.dot(C),h=C.dot(s)/A;if(h<0)continue;l.scale(h,ZZ),ZZ.vadd(r,ZZ),e.getVertex(u[3*a+1],vZ),e.getVertex(u[3*a+2],WZ);const b=ZZ.distanceSquared(r);!uZ.pointInTriangle(ZZ,vZ,yZ,WZ)&&!uZ.pointInTriangle(ZZ,yZ,vZ,WZ)||b>p||(xB.vectorToWorldFrame(g,C,d),xB.pointToWorldFrame(t,g,ZZ,c),this.reportIntersection(d,c,n,I,a))}o.length=0}reportIntersection(e,g,t,I,n){const i=this.from,C=this.to,o=i.distanceTo(g),a=this.result;if(!(this.skipBackfaces&&e.dot(this.direction)>0))switch(a.hitFaceIndex=void 0!==n?n:-1,this.mode){case uZ.ALL:this.hasHit=!0,a.set(i,C,e,g,t,I,o),a.hasHit=!0,this.callback(a);break;case uZ.CLOSEST:(o<a.distance||!a.hasHit)&&(this.hasHit=!0,a.hasHit=!0,a.set(i,C,e,g,t,I,o));break;case uZ.ANY:this.hasHit=!0,a.hasHit=!0,a.set(i,C,e,g,t,I,o),a.shouldStop=!0}}static pointInTriangle(e,g,t,I){I.vsub(g,JZ),t.vsub(g,mZ),e.vsub(g,pZ);const n=JZ.dot(JZ),i=JZ.dot(mZ),C=JZ.dot(pZ),o=mZ.dot(mZ),a=mZ.dot(pZ);let s,l;return(s=o*C-i*a)>=0&&(l=n*a-i*C)>=0&&s+l<n*o-i*i}}uZ.CLOSEST=1,uZ.ANY=2,uZ.ALL=4;const hZ=new VB,bZ=[],mZ=new WB,pZ=new WB,GZ=new WB,BZ=new KB,ZZ=new WB,yZ=new WB,vZ=new WB,WZ=new WB;new WB,new oZ;const fZ={faceList:[0]},wZ=new WB,RZ=new uZ,VZ=[],XZ=new WB,SZ=new WB,YZ=new WB,KZ=(new WB,new WB,new WB),HZ=new WB,NZ=new WB,FZ=new WB,xZ=new WB,zZ=new WB,kZ=new WB;new VB;const MZ=[],LZ=new xB,JZ=new WB,EZ=new WB;class TZ{static defaults(e,g){void 0===e&&(e={});for(let t in g)t in e||(e[t]=g[t]);return e}}class UZ{constructor(e,g,t){void 0===t&&(t={}),t=TZ.defaults(t,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=g,this.id=UZ.idCounter++,this.collideConnected=t.collideConnected,t.wakeUpBodies&&(e&&e.wakeUp(),g&&g.wakeUp())}update(){throw new Error("method update() not implmemented in this Constraint subclass!")}enable(){const e=this.equations;for(let g=0;g<e.length;g++)e[g].enabled=!0}disable(){const e=this.equations;for(let g=0;g<e.length;g++)e[g].enabled=!1}}UZ.idCounter=0;class QZ{constructor(){this.spatial=new WB,this.rotational=new WB}multiplyElement(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)}multiplyVectors(e,g){return e.dot(this.spatial)+g.dot(this.rotational)}}class DZ{constructor(e,g,t,I){void 0===t&&(t=-1e6),void 0===I&&(I=1e6),this.id=DZ.idCounter++,this.minForce=t,this.maxForce=I,this.bi=e,this.bj=g,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new QZ,this.jacobianElementB=new QZ,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}setSpookParams(e,g,t){const I=g,n=e,i=t;this.a=4/(i*(1+4*I)),this.b=4*I/(1+4*I),this.eps=4/(i*i*n*(1+4*I))}computeB(e,g,t){const I=this.computeGW();return-this.computeGq()*e-I*g-this.computeGiMf()*t}computeGq(){const e=this.jacobianElementA,g=this.jacobianElementB,t=this.bi,I=this.bj,n=t.position,i=I.position;return e.spatial.dot(n)+g.spatial.dot(i)}computeGW(){const e=this.jacobianElementA,g=this.jacobianElementB,t=this.bi,I=this.bj,n=t.velocity,i=I.velocity,C=t.angularVelocity,o=I.angularVelocity;return e.multiplyVectors(n,C)+g.multiplyVectors(i,o)}computeGWlambda(){const e=this.jacobianElementA,g=this.jacobianElementB,t=this.bi,I=this.bj,n=t.vlambda,i=I.vlambda,C=t.wlambda,o=I.wlambda;return e.multiplyVectors(n,C)+g.multiplyVectors(i,o)}computeGiMf(){const e=this.jacobianElementA,g=this.jacobianElementB,t=this.bi,I=this.bj,n=t.force,i=t.torque,C=I.force,o=I.torque,a=t.invMassSolve,s=I.invMassSolve;return n.scale(a,OZ),C.scale(s,jZ),t.invInertiaWorldSolve.vmult(i,PZ),I.invInertiaWorldSolve.vmult(o,_Z),e.multiplyVectors(OZ,PZ)+g.multiplyVectors(jZ,_Z)}computeGiMGt(){const e=this.jacobianElementA,g=this.jacobianElementB,t=this.bi,I=this.bj,n=t.invMassSolve,i=I.invMassSolve,C=t.invInertiaWorldSolve,o=I.invInertiaWorldSolve;let a=n+i;return C.vmult(e.rotational,qZ),a+=qZ.dot(e.rotational),o.vmult(g.rotational,qZ),a+=qZ.dot(g.rotational),a}addToWlambda(e){const g=this.jacobianElementA,t=this.jacobianElementB,I=this.bi,n=this.bj,i=$Z;I.vlambda.addScaledVector(I.invMassSolve*e,g.spatial,I.vlambda),n.vlambda.addScaledVector(n.invMassSolve*e,t.spatial,n.vlambda),I.invInertiaWorldSolve.vmult(g.rotational,i),I.wlambda.addScaledVector(e,i,I.wlambda),n.invInertiaWorldSolve.vmult(t.rotational,i),n.wlambda.addScaledVector(e,i,n.wlambda)}computeC(){return this.computeGiMGt()+this.eps}}DZ.idCounter=0;const OZ=new WB,jZ=new WB,PZ=new WB,_Z=new WB,qZ=new WB,$Z=new WB;new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB;class ey{constructor(e,g,t){t=TZ.defaults(t,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=ey.idCounter++,this.materials=[e,g],this.friction=t.friction,this.restitution=t.restitution,this.contactEquationStiffness=t.contactEquationStiffness,this.contactEquationRelaxation=t.contactEquationRelaxation,this.frictionEquationStiffness=t.frictionEquationStiffness,this.frictionEquationRelaxation=t.frictionEquationRelaxation}}ey.idCounter=0;class gy{constructor(e){void 0===e&&(e={});let g="";"string"==typeof e&&(g=e,e={}),this.name=g,this.id=gy.idCounter++,this.friction=void 0!==e.friction?e.friction:-1,this.restitution=void 0!==e.restitution?e.restitution:-1}}gy.idCounter=0,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new uZ,new WB,new WB,new WB,new WB(1,0,0),new WB(0,1,0),new WB(0,0,1),new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new VB,new WB,new VB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new VB,new WB,new xB,new VB,DB.STATIC,FB.types.SPHERE,FB.types.SPHERE,FB.types.PLANE,FB.types.BOX,FB.types.BOX,FB.types.SPHERE,FB.types.BOX,FB.types.PLANE,FB.types.BOX,FB.types.CONVEXPOLYHEDRON,FB.types.SPHERE,FB.types.CONVEXPOLYHEDRON,FB.types.PLANE,FB.types.CONVEXPOLYHEDRON,FB.types.BOX,FB.types.CONVEXPOLYHEDRON,FB.types.SPHERE,FB.types.HEIGHTFIELD,FB.types.BOX,FB.types.HEIGHTFIELD,FB.types.CONVEXPOLYHEDRON,FB.types.HEIGHTFIELD,FB.types.PARTICLE,FB.types.SPHERE,FB.types.PLANE,FB.types.PARTICLE,FB.types.BOX,FB.types.PARTICLE,FB.types.PARTICLE,FB.types.CONVEXPOLYHEDRON,FB.types.CYLINDER,FB.types.SPHERE,FB.types.CYLINDER,FB.types.PLANE,FB.types.CYLINDER,FB.types.BOX,FB.types.CYLINDER,FB.types.CONVEXPOLYHEDRON,FB.types.CYLINDER,FB.types.HEIGHTFIELD,FB.types.CYLINDER,FB.types.PARTICLE,FB.types.CYLINDER,FB.types.SPHERE,FB.types.TRIMESH,FB.types.PLANE,FB.types.TRIMESH,new WB,new WB,new WB,new WB,new WB,new KB,new KB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new VB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new KB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new WB,new VB,new uZ;const ty=globalThis.performance||{};if(!ty.now){let e=Date.now();ty.timing&&ty.timing.navigationStart&&(e=ty.timing.navigationStart),ty.now=()=>Date.now()-e}function Iy(){var e=(0,g.useRef)();return(0,Lh.jsx)(Lh.Fragment,{children:(0,Lh.jsx)("group",{ref:e,children:(0,Lh.jsxs)("mesh",{castShadow:!0,receiveShadow:!0,position:[0,0,0],children:[(0,Lh.jsx)("meshStandardMaterial",{color:"grey"}),(0,Lh.jsx)("boxGeometry",{args:[.3,.4,.8]})]})})})}new WB,DB.COLLIDE_EVENT_NAME;var ny=new zr(.04,16,16),iy=new di({color:16711680});function Cy(e,g){if(e){if("string"==typeof e)return oy(e,g);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?oy(e,g):void 0}}function oy(e,g){(null==g||g>e.length)&&(g=e.length);for(var t=0,I=new Array(g);t<g;t++)I[t]=e[t];return I}var ay=g.memo((function(e){var t,I=e.position,n=(0,g.useRef)(!1),i=(0,g.useRef)(!1),C=(0,g.useRef)(),o=function(e,t){var I=Fu(),n=I.scene,i=I.camera,C=(0,g.useMemo)((function(){return new Dn}),[]),o=(0,g.useMemo)((function(){return new Dn}),[]),a=(0,g.useMemo)((function(){return new Dn}),[]),s=(0,g.useMemo)((function(){return new Dn}),[]),l=(0,g.useMemo)((function(){return new UI}),[]),r=(0,g.useMemo)((function(){return new Dn}),[]),A=Math.PI/180*-75,c=Math.PI/180*50;function d(e){if(document.pointerLockElement){e.preventDefault(),a.rotation.y-=.002*e.movementX;var g=s.rotation.x-.002*e.movementY;g>A&&g<c&&(s.rotation.x=g)}}function u(e){if(document.pointerLockElement){e.preventDefault();var g=i.position.z+.005*e.deltaY;g>=.5&&g<=5&&(i.position.z=g)}}return(0,g.useEffect)((function(){return n.add(C),C.add(o),o.position.y=t[1],o.add(a),a.add(s),s.add(i),i.position.set(t[0],0,t[2]+1),o.add(r),document.addEventListener("mousemove",d),document.addEventListener("mousewheel",u,{passive:!1}),function(){document.removeEventListener("mousemove",d),document.removeEventListener("mousewheel",u)}}),[i]),xu((function(e,g){r.current.getWorldPosition(l),C.position.set(l.x,l.y,l.z)})),{pivot:C,alt:o,yaw:a,pitch:s,secondGroup:r,camera:i}}(0,[0,1,1.5]),a=o.yaw,s=o.pitch,l=o.secondGroup,r=o.updateMouseMovement,A=(0,g.useMemo)((function(){return new UI}),[]),c=(0,g.useMemo)((function(){return new UI}),[]),d=(0,g.useMemo)((function(){return new Yn}),[]),u=(0,g.useMemo)((function(){return new TI}),[]),h=(0,g.useMemo)((function(){return new TI}),[]),b=(0,g.useMemo)((function(){return new UI}),[]),m=(0,g.useMemo)((function(){return new UI}),[]),p=(0,g.useMemo)((function(){return new WB(0,0,0)}),[]),G=(0,g.useMemo)((function(){return new WB(0,-1,0)}),[]),B=(0,g.useMemo)((function(){return new Zn}),[]),Z=(0,g.useRef)(0),y=(t=(0,g.useRef)({}),(0,g.useEffect)((function(){var e=function(e){t.current[e.code]="keydown"===e.type};return document.addEventListener("keydown",e),document.addEventListener("keyup",e),function(){document.removeEventListener("keydown",e),document.removeEventListener("keyup",e)}})),t.current),v=(0,g.useMemo)((function(){return new UI}),[]),W=oG((function(e){return e})),f=W.groundObjects,w=W.actions,R=W.mixer,V=W.setTime,X=W.setFinished,S=oG((function(e){return e.actions})).addPlayer,Y=(0,g.useRef)(),K=function(e){var t=(0,g.useRef)();return(0,g.useEffect)((function(){var g=new nC(ny,iy);return t.current=g,e.current&&e.current.add(g),function(){null!==g&&null!==e.current&&e.current.remove(g)}}),[e]),t}(Y),H=AG(l),N=H.laserGroup,F=H.handleMouseDown,x=H.handleMouseUp,z=H.updateLasers,k=oG((function(e){return{playerHealth:e.playerHealth,decreasePlayerHealth:e.actions.decreasePlayerHealth}})).playerHealth,M=oG((function(e){return e.actions})).setPlayerHealth,L=(0,g.useCallback)((function(e){C.current=e}),[]),J=(0,g.useCallback)((function(e){l.current=e}),[]),E=0,T=1/60;(0,g.useEffect)((function(){return S(C.current.position),document.addEventListener("mousedown",F),document.addEventListener("mouseup",x),document.addEventListener("mousemove",r),function(){document.removeEventListener("mousedown",F),document.removeEventListener("mouseup",x),document.removeEventListener("mousemove",r)}}),[F,x,r]);var U=(0,g.useMemo)((function(){return[{args:[1,1,1],position:[0,.5,0],type:"Box"},{args:[.25,.5,.5],position:[0,1.25,0],type:"Box"}]}),[]),Q=function(e,g){return function(e){if(Array.isArray(e))return e}(e)||function(e,g){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var I,n,i,C,o=[],a=!0,s=!1;try{if(i=(t=t.call(e)).next,0===g){if(Object(t)!==t)return;a=!1}else for(;!(a=(I=i.call(t)).done)&&(o.push(I.value),o.length!==g);a=!0);}catch(e){s=!0,n=e}finally{try{if(!a&&null!=t.return&&(C=t.return(),Object(C)!==C))return}finally{if(s)throw n}}return o}}(e,g)||Cy(e,g)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(Up((function(){return{mass:1,shapes:U,onCollide:function(e){var g;e.contact.bi.id!==e.body.id&&p.set.apply(p,function(e){if(Array.isArray(e))return oy(e)}(g=e.contact.ni)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(g)||Cy(g)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),p.dot(G)>.5&&i.current&&(i.current=!0,w.jump)},material:"slippery",linearDamping:0,position:I}}),(0,g.useRef)()),2),D=Q[0],O=Q[1],j=(0,g.useCallback)((function(e,g){var t=0;return(e.KeyW||e.KeyS||e.KeyA||e.KeyD)&&(t=1),e.Space&&(t=2),t})),P=(0,g.useCallback)((function(e,g,t){n.current=!1,m.copy(g),m.y+=.01,e.set(m,G);for(var I=e.intersectObjects(Object.values(t),!1),i=0;i<I.length;i++)if(I[i].distance<.028){n.current=!0;break}}),[]),_=(0,g.useCallback)((function(e,g,t,I,n,i){I.lookAt(e,g.current.position,g.current.up),t.setFromRotationMatrix(I),n>1e-4&&!g.current.quaternion.equals(t)&&(t.z=0,t.x=0,t.normalize(),g.current.quaternion.rotateTowards(t,6*i))}),[]),q=(0,g.useCallback)((function(e,g,t,I,C,o,s,l,r,A){o.set(0,0,0),n.current&&(e.KeyW&&(o.z=-6),e.KeyS&&(o.z=6),e.KeyA&&(o.x=-6),e.KeyD&&(o.x=6),t!==I.current&&(1!==I.current&&1===t&&(C["ArmatureAction.001"],C.idle),0!==I.current&&0===t&&(C["ArmatureAction.001"],C.walk),I.current=t),e.Space&&n.current&&!i.current&&(i.current=!1,C.jump,o.y=6),r.y=a.rotation.y,r.order="YZX",A.setFromEuler(r),o.applyQuaternion(A),l.set(o.x,o.y,o.z),s.applyImpulse([l.x,l.y,l.z],[0,0,0]))}),[]),$=(0,g.useCallback)((function(e,g,t,I){e.update(1===g?t*I*22.5:t)}),[]),ee=(0,g.useCallback)((function(e,g,t,I,n){M(100),g.velocity.set(0,0,0),g.position.set(0,1,0),t.current.position.set(0,1,0)}),[M]),ge=(0,g.useCallback)((function(e,g,t){g.current.position.lerp(e,.15),t.current.position.lerp(new UI(e.x,e.y+1,e.z),.15)}),[]);return xu((function(e,g){var t=e.raycaster;e.scene,e.camera,e.clock,E+=g,z(C,g),O.angularFactor.set(0,0,0),D.current.getWorldPosition(b),P(t,b,f),O.linearDamping.set(n.current?.9999999:0);var I=b.distanceTo(C.current.position);document.pointerLockElement&&function(){var e=new TI,g=new Yn(s.rotation.x,a.rotation.y,0,"YZX");e.setFromEuler(g),l.current.setRotationFromQuaternion(e)}(),_(b,C,h,B,I,g);for(var i=j(y,g);E>=T;)q(y,T,i,Z,w,c,O,A,d,u),$(R,i,T,I),E-=T;if(ge(b,C,l),k<=0&&ee(b,O,C,X,V),K&&K.current&&l.current){(new Dc).set(l.current.position,new UI(0,0,-1));var o=new UI(0,0,-1).applyQuaternion(l.current.quaternion);o.multiplyScalar(10),K.current.position.copy(l.current.position).add(o).add(new UI(0,0,0)),K.current.material.depthTest=!1,K.current.renderOrder=1}})),(0,Lh.jsx)(Lh.Fragment,{children:(0,Lh.jsxs)("group",{ref:Y,position:I,children:[(0,Lh.jsx)("group",{ref:L,position:I,children:(0,Lh.jsx)(g.Suspense,{fallback:null,children:(0,Lh.jsx)(ZB,{})})}),(0,Lh.jsx)("group",{ref:J,position:v,children:(0,Lh.jsx)(g.Suspense,{fallback:null,children:(0,Lh.jsx)(Iy,{})})}),(0,Lh.jsx)("group",{ref:N})]})})}));const sy=ay;var ly=n(935);function ry(...e){return g=>e.forEach((e=>function(e,g){"function"==typeof e?e(g):null!=e&&(e.current=g)}(e,g)))}function Ay(...e){return(0,g.useCallback)(ry(...e),e)}const cy=(0,g.forwardRef)(((e,t)=>{const{children:I,...n}=e,i=g.Children.toArray(I),C=i.find(hy);if(C){const e=C.props.children,I=i.map((t=>t===C?g.Children.count(e)>1?g.Children.only(null):(0,g.isValidElement)(e)?e.props.children:null:t));return(0,g.createElement)(dy,qu({},n,{ref:t}),(0,g.isValidElement)(e)?(0,g.cloneElement)(e,void 0,I):null)}return(0,g.createElement)(dy,qu({},n,{ref:t}),I)}));cy.displayName="Slot";const dy=(0,g.forwardRef)(((e,t)=>{const{children:I,...n}=e;return(0,g.isValidElement)(I)?(0,g.cloneElement)(I,{...by(n,I.props),ref:t?ry(t,I.ref):I.ref}):g.Children.count(I)>1?g.Children.only(null):null}));dy.displayName="SlotClone";const uy=({children:e})=>(0,g.createElement)(g.Fragment,null,e);function hy(e){return(0,g.isValidElement)(e)&&e.type===uy}function by(e,g){const t={...g};for(const I in g){const n=e[I],i=g[I];/^on[A-Z]/.test(I)?n&&i?t[I]=(...e)=>{i(...e),n(...e)}:n&&(t[I]=n):"style"===I?t[I]={...n,...i}:"className"===I&&(t[I]=[n,i].filter(Boolean).join(" "))}return{...e,...t}}const my=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","span","svg","ul"].reduce(((e,t)=>{const I=(0,g.forwardRef)(((e,I)=>{const{asChild:n,...i}=e,C=n?cy:t;return(0,g.useEffect)((()=>{window[Symbol.for("radix-ui")]=!0}),[]),(0,g.createElement)(C,qu({},i,{ref:I}))}));return I.displayName=`Primitive.${t}`,{...e,[t]:I}}),{}),py=(0,g.forwardRef)(((e,t)=>{var I;const{container:n=(null===globalThis||void 0===globalThis||null===(I=globalThis.document)||void 0===I?void 0:I.body),...i}=e;return n?ly.createPortal((0,g.createElement)(my.div,qu({},i,{ref:t})),n):null})),Gy=py;var By=Object.prototype.hasOwnProperty;function Zy(e,g){var t,I;if(e===g)return!0;if(e&&g&&(t=e.constructor)===g.constructor){if(t===Date)return e.getTime()===g.getTime();if(t===RegExp)return e.toString()===g.toString();if(t===Array){if((I=e.length)===g.length)for(;I--&&Zy(e[I],g[I]););return-1===I}if(!t||"object"==typeof e){for(t in I=0,e){if(By.call(e,t)&&++I&&!By.call(g,t))return!1;if(!(t in g)||!Zy(e[t],g[t]))return!1}return Object.keys(g).length===I}}return e!=e&&g!=g}function yy(e,g){if(Object.is(e,g))return!0;if("object"!=typeof e||null===e||"object"!=typeof g||null===g)return!1;const t=Object.keys(e);if(t.length!==Object.keys(g).length)return!1;for(let I=0;I<t.length;I++)if(!Object.prototype.hasOwnProperty.call(g,t[I])||!Object.is(e[t[I]],g[t[I]]))return!1;return!0}var vy=function(e,g,t,I){this.name=e,this.fn=g,this.args=t,this.modifiers=I};function Wy(e,g){return void 0===g&&(g="simple"),"object"==typeof e?e[g]:e}function fy(e,g,t){if(e.length){var I=e.shift(),n=fy(e,g,t);return I.perform(n,t)}return Wy(g)}function wy(e,g,t){if(e.length){var I=e.shift(),n=wy(e,g,t);return I.performAsync(n,t)}return function(e){return Promise.resolve(Wy(g,"async")(e))}}vy.prototype._test=function(e){var g=this.fn;try{fy(this.modifiers.slice(),g,this)(e)}catch(e){g=function(){return!1}}try{return fy(this.modifiers.slice(),g,this)(e)}catch(e){return!1}},vy.prototype._check=function(e){try{fy(this.modifiers.slice(),this.fn,this)(e)}catch(e){if(fy(this.modifiers.slice(),(function(e){return e}),this)(!1))return}if(!fy(this.modifiers.slice(),this.fn,this)(e))throw null},vy.prototype._testAsync=function(e){var g=this;return new Promise((function(t,I){wy(g.modifiers.slice(),g.fn,g)(e).then((function(g){g?t(e):I(null)})).catch((function(e){return I(e)}))}))};var Ry=function(e,g,t){this.name=e,this.perform=g,this.performAsync=t},Vy=function(e){function g(t,I,n,i){for(var C=[],o=arguments.length-4;o-- >0;)C[o]=arguments[o+4];e.call(this,C),e.captureStackTrace&&e.captureStackTrace(this,g),this.rule=t,this.value=I,this.cause=n,this.target=i}return e&&(g.__proto__=e),g.prototype=Object.create(e&&e.prototype),g.prototype.constructor=g,g}(Error),Xy=function(e,g){void 0===e&&(e=[]),void 0===g&&(g=[]),this.chain=e,this.nextRuleModifiers=g};function Sy(e,g,t,I){if(g.length){var n=g.shift();n._testAsync(e).then((function(){Sy(e,g,t,I)}),(function(g){I(new Vy(n,e,g))}))}else t(e)}Xy.prototype._applyRule=function(e,g){var t=this;return function(){for(var I=[],n=arguments.length;n--;)I[n]=arguments[n];return t.chain.push(new vy(g,e.apply(t,I),I,t.nextRuleModifiers)),t.nextRuleModifiers=[],t}},Xy.prototype._applyModifier=function(e,g){return this.nextRuleModifiers.push(new Ry(g,e.simple,e.async)),this},Xy.prototype._clone=function(){return new Xy(this.chain.slice(),this.nextRuleModifiers.slice())},Xy.prototype.test=function(e){return this.chain.every((function(g){return g._test(e)}))},Xy.prototype.testAll=function(e){var g=[];return this.chain.forEach((function(t){try{t._check(e)}catch(I){g.push(new Vy(t,e,I))}})),g},Xy.prototype.check=function(e){this.chain.forEach((function(g){try{g._check(e)}catch(t){throw new Vy(g,e,t)}}))},Xy.prototype.testAsync=function(e){var g=this;return new Promise((function(t,I){Sy(e,g.chain.slice(),t,I)}))};var Yy=function(e,g){return!(!g||"string"!=typeof e||0!==e.trim().length)||null==e};function Ky(){return"undefined"!=typeof Proxy?Ny(new Xy):Fy(new Xy)}var Hy={};function Ny(e){return new Proxy(e,{get:function(g,t){if(t in g)return g[t];var I=Ny(e._clone());return t in xy?I._applyModifier(xy[t],t):t in Hy?I._applyRule(Hy[t],t):t in My?I._applyRule(My[t],t):void 0}})}function Fy(e){var g=function(e,g){return Object.keys(e).forEach((function(t){g[t]=function(){for(var I=[],n=arguments.length;n--;)I[n]=arguments[n];return Fy(g._clone())._applyRule(e[t],t).apply(void 0,I)}})),g},t=g(My,e),I=g(Hy,t);return Object.keys(xy).forEach((function(e){Object.defineProperty(I,e,{get:function(){return Fy(I._clone())._applyModifier(xy[e],e)}})})),I}Ky.extend=function(e){Object.assign(Hy,e)},Ky.clearCustomRules=function(){Hy={}};var xy={not:{simple:function(e){return function(g){return!e(g)}},async:function(e){return function(g){return Promise.resolve(e(g)).then((function(e){return!e})).catch((function(){return!0}))}}},some:{simple:function(e){return function(g){return ky(g).some((function(g){try{return e(g)}catch(e){return!1}}))}},async:function(e){return function(g){return Promise.all(ky(g).map((function(g){try{return e(g).catch((function(){return!1}))}catch(e){return!1}}))).then((function(e){return e.some(Boolean)}))}}},every:{simple:function(e){return function(g){return!1!==g&&ky(g).every(e)}},async:function(e){return function(g){return Promise.all(ky(g).map(e)).then((function(e){return e.every(Boolean)}))}}},strict:{simple:function(e,g){return function(t){return zy(g)&&t&&"object"==typeof t?Object.keys(g.args[0]).length===Object.keys(t).length&&e(t):e(t)}},async:function(e,g){return function(t){return Promise.resolve(e(t)).then((function(e){return zy(g)&&t&&"object"==typeof t?Object.keys(g.args[0]).length===Object.keys(t).length&&e:e})).catch((function(){return!1}))}}}};function zy(e){return e&&"schema"===e.name&&e.args.length>0&&"object"==typeof e.args[0]}function ky(e){return"string"==typeof e?e.split(""):e}var My={equal:function(e){return function(g){return g==e}},exact:function(e){return function(g){return g===e}},number:function(e){return void 0===e&&(e=!0),function(g){return"number"==typeof g&&(e||isFinite(g))}},integer:function(){return function(e){return(Number.isInteger||Jy)(e)}},numeric:function(){return function(e){return!isNaN(parseFloat(e))&&isFinite(e)}},string:function(){return Ly("string")},boolean:function(){return Ly("boolean")},undefined:function(){return Ly("undefined")},null:function(){return Ly("null")},array:function(){return Ly("array")},object:function(){return Ly("object")},instanceOf:function(e){return function(g){return g instanceof e}},pattern:function(e){return function(g){return e.test(g)}},lowercase:function(){return function(e){return"boolean"==typeof e||e===e.toLowerCase()&&""!==e.trim()}},uppercase:function(){return function(e){return e===e.toUpperCase()&&""!==e.trim()}},vowel:function(){return function(e){return/^[aeiou]+$/i.test(e)}},consonant:function(){return function(e){return/^(?=[^aeiou])([a-z]+)$/i.test(e)}},first:function(e){return function(g){return g[0]==e}},last:function(e){return function(g){return g[g.length-1]==e}},empty:function(){return function(e){return 0===e.length}},length:function(e,g){return function(t){return t.length>=e&&t.length<=(g||e)}},minLength:function(e){return function(g){return g.length>=e}},maxLength:function(e){return function(g){return g.length<=e}},negative:function(){return function(e){return e<0}},positive:function(){return function(e){return e>=0}},between:function(e,g){return function(t){return t>=e&&t<=g}},range:function(e,g){return function(t){return t>=e&&t<=g}},lessThan:function(e){return function(g){return g<e}},lessThanOrEqual:function(e){return function(g){return g<=e}},greaterThan:function(e){return function(g){return g>e}},greaterThanOrEqual:function(e){return function(g){return g>=e}},even:function(){return function(e){return e%2==0}},odd:function(){return function(e){return e%2!=0}},includes:function(e){return function(g){return~g.indexOf(e)}},schema:function(e){return function(e){return{simple:function(g){var t=[];if(Object.keys(e).forEach((function(I){var n=e[I];try{n.check((g||{})[I])}catch(e){e.target=I,t.push(e)}})),t.length>0)throw t;return!0},async:function(g){var t=[],I=Object.keys(e).map((function(I){return e[I].testAsync((g||{})[I]).catch((function(e){e.target=I,t.push(e)}))}));return Promise.all(I).then((function(){if(t.length>0)throw t;return!0}))}}}(e)},passesAnyOf:function(){for(var e=[],g=arguments.length;g--;)e[g]=arguments[g];return function(g){return e.some((function(e){return e.test(g)}))}},optional:function(e,g){return void 0===g&&(g=!1),{simple:function(t){return Yy(t,g)||void 0===e.check(t)},async:function(t){return Yy(t,g)||e.testAsync(t)}}}};function Ly(e){return function(g){return Array.isArray(g)&&"array"===e||null===g&&"null"===e||typeof g===e}}function Jy(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}const Ey=Ky;var Ty="colors",Uy="sizes",Qy="space",Dy={gap:Qy,gridGap:Qy,columnGap:Qy,gridColumnGap:Qy,rowGap:Qy,gridRowGap:Qy,inset:Qy,insetBlock:Qy,insetBlockEnd:Qy,insetBlockStart:Qy,insetInline:Qy,insetInlineEnd:Qy,insetInlineStart:Qy,margin:Qy,marginTop:Qy,marginRight:Qy,marginBottom:Qy,marginLeft:Qy,marginBlock:Qy,marginBlockEnd:Qy,marginBlockStart:Qy,marginInline:Qy,marginInlineEnd:Qy,marginInlineStart:Qy,padding:Qy,paddingTop:Qy,paddingRight:Qy,paddingBottom:Qy,paddingLeft:Qy,paddingBlock:Qy,paddingBlockEnd:Qy,paddingBlockStart:Qy,paddingInline:Qy,paddingInlineEnd:Qy,paddingInlineStart:Qy,top:Qy,right:Qy,bottom:Qy,left:Qy,scrollMargin:Qy,scrollMarginTop:Qy,scrollMarginRight:Qy,scrollMarginBottom:Qy,scrollMarginLeft:Qy,scrollMarginX:Qy,scrollMarginY:Qy,scrollMarginBlock:Qy,scrollMarginBlockEnd:Qy,scrollMarginBlockStart:Qy,scrollMarginInline:Qy,scrollMarginInlineEnd:Qy,scrollMarginInlineStart:Qy,scrollPadding:Qy,scrollPaddingTop:Qy,scrollPaddingRight:Qy,scrollPaddingBottom:Qy,scrollPaddingLeft:Qy,scrollPaddingX:Qy,scrollPaddingY:Qy,scrollPaddingBlock:Qy,scrollPaddingBlockEnd:Qy,scrollPaddingBlockStart:Qy,scrollPaddingInline:Qy,scrollPaddingInlineEnd:Qy,scrollPaddingInlineStart:Qy,fontSize:"fontSizes",background:Ty,backgroundColor:Ty,backgroundImage:Ty,borderImage:Ty,border:Ty,borderBlock:Ty,borderBlockEnd:Ty,borderBlockStart:Ty,borderBottom:Ty,borderBottomColor:Ty,borderColor:Ty,borderInline:Ty,borderInlineEnd:Ty,borderInlineStart:Ty,borderLeft:Ty,borderLeftColor:Ty,borderRight:Ty,borderRightColor:Ty,borderTop:Ty,borderTopColor:Ty,caretColor:Ty,color:Ty,columnRuleColor:Ty,fill:Ty,outline:Ty,outlineColor:Ty,stroke:Ty,textDecorationColor:Ty,fontFamily:"fonts",fontWeight:"fontWeights",lineHeight:"lineHeights",letterSpacing:"letterSpacings",blockSize:Uy,minBlockSize:Uy,maxBlockSize:Uy,inlineSize:Uy,minInlineSize:Uy,maxInlineSize:Uy,width:Uy,minWidth:Uy,maxWidth:Uy,height:Uy,minHeight:Uy,maxHeight:Uy,flexBasis:Uy,gridTemplateColumns:Uy,gridTemplateRows:Uy,borderWidth:"borderWidths",borderTopWidth:"borderWidths",borderRightWidth:"borderWidths",borderBottomWidth:"borderWidths",borderLeftWidth:"borderWidths",borderStyle:"borderStyles",borderTopStyle:"borderStyles",borderRightStyle:"borderStyles",borderBottomStyle:"borderStyles",borderLeftStyle:"borderStyles",borderRadius:"radii",borderTopLeftRadius:"radii",borderTopRightRadius:"radii",borderBottomRightRadius:"radii",borderBottomLeftRadius:"radii",boxShadow:"shadows",textShadow:"shadows",transition:"transitions",zIndex:"zIndices"},Oy=(e,g)=>"function"==typeof g?{"()":Function.prototype.toString.call(g)}:g,jy=()=>{const e=Object.create(null);return(g,t,...I)=>{const n=(e=>JSON.stringify(e,Oy))(g);return n in e?e[n]:e[n]=t(g,...I)}},Py=Symbol.for("sxs.internal"),_y=(e,g)=>Object.defineProperties(e,Object.getOwnPropertyDescriptors(g)),qy=e=>{for(const g in e)return!0;return!1},{hasOwnProperty:$y}=Object.prototype,ev=e=>e.includes("-")?e:e.replace(/[A-Z]/g,(e=>"-"+e.toLowerCase())),gv=/\s+(?![^()]*\))/,tv=e=>g=>e(..."string"==typeof g?String(g).split(gv):[g]),Iv={appearance:e=>({WebkitAppearance:e,appearance:e}),backfaceVisibility:e=>({WebkitBackfaceVisibility:e,backfaceVisibility:e}),backdropFilter:e=>({WebkitBackdropFilter:e,backdropFilter:e}),backgroundClip:e=>({WebkitBackgroundClip:e,backgroundClip:e}),boxDecorationBreak:e=>({WebkitBoxDecorationBreak:e,boxDecorationBreak:e}),clipPath:e=>({WebkitClipPath:e,clipPath:e}),content:e=>({content:e.includes('"')||e.includes("'")||/^([A-Za-z]+\([^]*|[^]*-quote|inherit|initial|none|normal|revert|unset)$/.test(e)?e:`"${e}"`}),hyphens:e=>({WebkitHyphens:e,hyphens:e}),maskImage:e=>({WebkitMaskImage:e,maskImage:e}),maskSize:e=>({WebkitMaskSize:e,maskSize:e}),tabSize:e=>({MozTabSize:e,tabSize:e}),textSizeAdjust:e=>({WebkitTextSizeAdjust:e,textSizeAdjust:e}),userSelect:e=>({WebkitUserSelect:e,userSelect:e}),marginBlock:tv(((e,g)=>({marginBlockStart:e,marginBlockEnd:g||e}))),marginInline:tv(((e,g)=>({marginInlineStart:e,marginInlineEnd:g||e}))),maxSize:tv(((e,g)=>({maxBlockSize:e,maxInlineSize:g||e}))),minSize:tv(((e,g)=>({minBlockSize:e,minInlineSize:g||e}))),paddingBlock:tv(((e,g)=>({paddingBlockStart:e,paddingBlockEnd:g||e}))),paddingInline:tv(((e,g)=>({paddingInlineStart:e,paddingInlineEnd:g||e})))},nv=/([\d.]+)([^]*)/,iv=(e,g)=>e.length?e.reduce(((e,t)=>(e.push(...g.map((e=>e.includes("&")?e.replace(/&/g,/[ +>|~]/.test(t)&&/&.*&/.test(e)?`:is(${t})`:t):t+" "+e))),e)),[]):g,Cv=(e,g)=>e in ov&&"string"==typeof g?g.replace(/^((?:[^]*[^\w-])?)(fit-content|stretch)((?:[^\w-][^]*)?)$/,((g,t,I,n)=>t+("stretch"===I?`-moz-available${n};${ev(e)}:${t}-webkit-fill-available`:`-moz-fit-content${n};${ev(e)}:${t}fit-content`)+n)):String(g),ov={blockSize:1,height:1,inlineSize:1,maxBlockSize:1,maxHeight:1,maxInlineSize:1,maxWidth:1,minBlockSize:1,minHeight:1,minInlineSize:1,minWidth:1,width:1},av=e=>e?e+"-":"",sv=(e,g,t)=>e.replace(/([+-])?((?:\d+(?:\.\d*)?|\.\d+)(?:[Ee][+-]?\d+)?)?(\$|--)([$\w-]+)/g,((e,I,n,i,C)=>"$"==i==!!n?e:(I||"--"==i?"calc(":"")+"var(--"+("$"===i?av(g)+(C.includes("$")?"":av(t))+C.replace(/\$/g,"-"):C)+")"+(I||"--"==i?"*"+(I||"")+(n||"1")+")":""))),lv=/\s*,\s*(?![^()]*\))/,rv=Object.prototype.toString,Av=(e,g,t,I,n)=>{let i,C,o;const a=(e,g,t)=>{let s,l;const r=e=>{for(s in e){const d=64===s.charCodeAt(0),u=d&&Array.isArray(e[s])?e[s]:[e[s]];for(l of u){const e=/[A-Z]/.test(c=s)?c:c.replace(/-[^]/g,(e=>e[1].toUpperCase())),u="object"==typeof l&&l&&l.toString===rv&&(!I.utils[e]||!g.length);if(e in I.utils&&!u){const g=I.utils[e];if(g!==C){C=g,r(g(l)),C=null;continue}}else if(e in Iv){const g=Iv[e];if(g!==o){o=g,r(g(l)),o=null;continue}}if(d&&(A=s.slice(1)in I.media?"@media "+I.media[s.slice(1)]:s,s=A.replace(/\(\s*([\w-]+)\s*(=|<|<=|>|>=)\s*([\w-]+)\s*(?:(<|<=|>|>=)\s*([\w-]+)\s*)?\)/g,((e,g,t,I,n,i)=>{const C=nv.test(g),o=.0625*(C?-1:1),[a,s]=C?[I,g]:[g,I];return"("+("="===t[0]?"":">"===t[0]===C?"max-":"min-")+a+":"+("="!==t[0]&&1===t.length?s.replace(nv,((e,g,I)=>Number(g)+o*(">"===t?1:-1)+I)):s)+(n?") and ("+(">"===n[0]?"min-":"max-")+a+":"+(1===n.length?i.replace(nv,((e,g,t)=>Number(g)+o*(">"===n?-1:1)+t)):i):"")+")"}))),u){const e=d?t.concat(s):[...t],I=d?[...g]:iv(g,s.split(lv));void 0!==i&&n(cv(...i)),i=void 0,a(l,I,e)}else void 0===i&&(i=[[],g,t]),s=d||36!==s.charCodeAt(0)?s:`--${av(I.prefix)}${s.slice(1).replace(/\$/g,"-")}`,l=u?l:"number"==typeof l?l&&e in dv?String(l)+"px":String(l):sv(Cv(e,null==l?"":l),I.prefix,I.themeMap[e]),i[0].push(`${d?`${s} `:`${ev(s)}:`}${l}`)}}var A,c};r(e),void 0!==i&&n(cv(...i)),i=void 0};a(e,g,t)},cv=(e,g,t)=>`${t.map((e=>`${e}{`)).join("")}${g.length?`${g.join(",")}{`:""}${e.join(";")}${g.length?"}":""}${Array(t.length?t.length+1:0).join("}")}`,dv={animationDelay:1,animationDuration:1,backgroundSize:1,blockSize:1,border:1,borderBlock:1,borderBlockEnd:1,borderBlockEndWidth:1,borderBlockStart:1,borderBlockStartWidth:1,borderBlockWidth:1,borderBottom:1,borderBottomLeftRadius:1,borderBottomRightRadius:1,borderBottomWidth:1,borderEndEndRadius:1,borderEndStartRadius:1,borderInlineEnd:1,borderInlineEndWidth:1,borderInlineStart:1,borderInlineStartWidth:1,borderInlineWidth:1,borderLeft:1,borderLeftWidth:1,borderRadius:1,borderRight:1,borderRightWidth:1,borderSpacing:1,borderStartEndRadius:1,borderStartStartRadius:1,borderTop:1,borderTopLeftRadius:1,borderTopRightRadius:1,borderTopWidth:1,borderWidth:1,bottom:1,columnGap:1,columnRule:1,columnRuleWidth:1,columnWidth:1,containIntrinsicSize:1,flexBasis:1,fontSize:1,gap:1,gridAutoColumns:1,gridAutoRows:1,gridTemplateColumns:1,gridTemplateRows:1,height:1,inlineSize:1,inset:1,insetBlock:1,insetBlockEnd:1,insetBlockStart:1,insetInline:1,insetInlineEnd:1,insetInlineStart:1,left:1,letterSpacing:1,margin:1,marginBlock:1,marginBlockEnd:1,marginBlockStart:1,marginBottom:1,marginInline:1,marginInlineEnd:1,marginInlineStart:1,marginLeft:1,marginRight:1,marginTop:1,maxBlockSize:1,maxHeight:1,maxInlineSize:1,maxWidth:1,minBlockSize:1,minHeight:1,minInlineSize:1,minWidth:1,offsetDistance:1,offsetRotate:1,outline:1,outlineOffset:1,outlineWidth:1,overflowClipMargin:1,padding:1,paddingBlock:1,paddingBlockEnd:1,paddingBlockStart:1,paddingBottom:1,paddingInline:1,paddingInlineEnd:1,paddingInlineStart:1,paddingLeft:1,paddingRight:1,paddingTop:1,perspective:1,right:1,rowGap:1,scrollMargin:1,scrollMarginBlock:1,scrollMarginBlockEnd:1,scrollMarginBlockStart:1,scrollMarginBottom:1,scrollMarginInline:1,scrollMarginInlineEnd:1,scrollMarginInlineStart:1,scrollMarginLeft:1,scrollMarginRight:1,scrollMarginTop:1,scrollPadding:1,scrollPaddingBlock:1,scrollPaddingBlockEnd:1,scrollPaddingBlockStart:1,scrollPaddingBottom:1,scrollPaddingInline:1,scrollPaddingInlineEnd:1,scrollPaddingInlineStart:1,scrollPaddingLeft:1,scrollPaddingRight:1,scrollPaddingTop:1,shapeMargin:1,textDecoration:1,textDecorationThickness:1,textIndent:1,textUnderlineOffset:1,top:1,transitionDelay:1,transitionDuration:1,verticalAlign:1,width:1,wordSpacing:1},uv=e=>String.fromCharCode(e+(e>25?39:97)),hv=e=>(e=>{let g,t="";for(g=Math.abs(e);g>52;g=g/52|0)t=uv(g%52)+t;return uv(g%52)+t})(((e,g)=>{let t=g.length;for(;t;)e=33*e^g.charCodeAt(--t);return e})(5381,JSON.stringify(e))>>>0),bv=["themed","global","styled","onevar","resonevar","allvar","inline"],mv=e=>{if(e.href&&!e.href.startsWith(location.origin))return!1;try{return!!e.cssRules}catch(e){return!1}},pv=e=>{let g;const t=()=>{const{cssRules:e}=g.sheet;return[].map.call(e,((t,I)=>{const{cssText:n}=t;let i="";if(n.startsWith("--sxs"))return"";if(e[I-1]&&(i=e[I-1].cssText).startsWith("--sxs")){if(!t.cssRules.length)return"";for(const e in g.rules)if(g.rules[e].group===t)return`--sxs{--sxs:${[...g.rules[e].cache].join(" ")}}${n}`;return t.cssRules.length?`${i}${n}`:""}return n})).join("")},I=()=>{if(g){const{rules:e,sheet:t}=g;if(!t.deleteRule){for(;3===Object(Object(t.cssRules)[0]).type;)t.cssRules.splice(0,1);t.cssRules=[]}for(const g in e)delete e[g]}const n=Object(e).styleSheets||[];for(const e of n)if(mv(e)){for(let n=0,i=e.cssRules;i[n];++n){const C=Object(i[n]);if(1!==C.type)continue;const o=Object(i[n+1]);if(4!==o.type)continue;++n;const{cssText:a}=C;if(!a.startsWith("--sxs"))continue;const s=a.slice(14,-3).trim().split(/\s+/),l=bv[s[0]];l&&(g||(g={sheet:e,reset:I,rules:{},toString:t}),g.rules[l]={group:o,index:n,cache:new Set(s)})}if(g)break}if(!g){const n=(e,g)=>({type:g,cssRules:[],insertRule(e,g){this.cssRules.splice(g,0,n(e,{import:3,undefined:1}[(e.toLowerCase().match(/^@([a-z]+)/)||[])[1]]||4))},get cssText(){return"@media{}"===e?`@media{${[].map.call(this.cssRules,(e=>e.cssText)).join("")}}`:e}});g={sheet:e?(e.head||e).appendChild(document.createElement("style")).sheet:n("","text/css"),rules:{},reset:I,toString:t}}const{sheet:i,rules:C}=g;for(let e=bv.length-1;e>=0;--e){const g=bv[e];if(!C[g]){const t=bv[e+1],I=C[t]?C[t].index:i.cssRules.length;i.insertRule("@media{}",I),i.insertRule(`--sxs{--sxs:${e}}`,I),C[g]={group:i.cssRules[I+1],index:I,cache:new Set([e])}}Gv(C[g])}};return I(),g},Gv=e=>{const g=e.group;let t=g.cssRules.length;e.apply=e=>{try{g.insertRule(e,t),++t}catch(e){}}},Bv=Symbol(),Zv=jy(),yv=(e,g)=>Zv(e,(()=>(...t)=>{let I={type:null,composers:new Set};for(const g of t)if(null!=g)if(g[Py]){null==I.type&&(I.type=g[Py].type);for(const e of g[Py].composers)I.composers.add(e)}else g.constructor!==Object||g.$$typeof?null==I.type&&(I.type=g):I.composers.add(vv(g,e));return null==I.type&&(I.type="span"),I.composers.size||I.composers.add(["PJLV",{},[],[],{},[]]),Wv(e,I,g)})),vv=({variants:e,compoundVariants:g,defaultVariants:t,...I},n)=>{const i=`${av(n.prefix)}c-${hv(I)}`,C=[],o=[],a=Object.create(null),s=[];for(const e in t)a[e]=String(t[e]);if("object"==typeof e&&e)for(const g in e){l=a,r=g,$y.call(l,r)||(a[g]="undefined");const t=e[g];for(const e in t){const I={[g]:String(e)};"undefined"===String(e)&&s.push(g);const n=t[e],i=[I,n,!qy(n)];C.push(i)}}var l,r;if("object"==typeof g&&g)for(const e of g){let{css:g,...t}=e;g="object"==typeof g&&g||{};for(const e in t)t[e]=String(t[e]);const I=[t,g,!qy(g)];o.push(I)}return[i,I,C,o,a,s]},Wv=(e,g,t)=>{const[I,n,i,C]=fv(g.composers),o="function"==typeof g.type||g.type.$$typeof?(e=>{function g(){for(let t=0;t<g[Bv].length;t++){const[I,n]=g[Bv][t];e.rules[I].apply(n)}return g[Bv]=[],null}return g[Bv]=[],g.rules={},bv.forEach((e=>g.rules[e]={apply:t=>g[Bv].push([e,t])})),g})(t):null,a=(o||t).rules,s=`.${I}${n.length>1?`:where(.${n.slice(1).join(".")})`:""}`,l=l=>{l="object"==typeof l&&l||Rv;const{css:r,...A}=l,c={};for(const e in i)if(delete A[e],e in l){let g=l[e];"object"==typeof g&&g?c[e]={"@initial":i[e],...g}:(g=String(g),c[e]="undefined"!==g||C.has(e)?g:i[e])}else c[e]=i[e];const d=new Set([...n]);for(const[I,n,i,C]of g.composers){t.rules.styled.cache.has(I)||(t.rules.styled.cache.add(I),Av(n,[`.${I}`],[],e,(e=>{a.styled.apply(e)})));const g=wv(i,c,e.media),o=wv(C,c,e.media,!0);for(const n of g)if(void 0!==n)for(const[g,i,C]of n){const n=`${I}-${hv(i)}-${g}`;d.add(n);const o=(C?t.rules.resonevar:t.rules.onevar).cache,s=C?a.resonevar:a.onevar;o.has(n)||(o.add(n),Av(i,[`.${n}`],[],e,(e=>{s.apply(e)})))}for(const g of o)if(void 0!==g)for(const[n,i]of g){const g=`${I}-${hv(i)}-${n}`;d.add(g),t.rules.allvar.cache.has(g)||(t.rules.allvar.cache.add(g),Av(i,[`.${g}`],[],e,(e=>{a.allvar.apply(e)})))}}if("object"==typeof r&&r){const g=`${I}-i${hv(r)}-css`;d.add(g),t.rules.inline.cache.has(g)||(t.rules.inline.cache.add(g),Av(r,[`.${g}`],[],e,(e=>{a.inline.apply(e)})))}for(const e of String(l.className||"").trim().split(/\s+/))e&&d.add(e);const u=A.className=[...d].join(" ");return{type:g.type,className:u,selector:s,props:A,toString:()=>u,deferredInjector:o}};return _y(l,{className:I,selector:s,[Py]:g,toString:()=>(t.rules.styled.cache.has(I)||l(),I)})},fv=e=>{let g="";const t=[],I={},n=[];for(const[i,,,,C,o]of e){""===g&&(g=i),t.push(i),n.push(...o);for(const e in C){const g=C[e];(void 0===I[e]||"undefined"!==g||o.includes(g))&&(I[e]=g)}}return[g,t,I,new Set(n)]},wv=(e,g,t,I)=>{const n=[];e:for(let[i,C,o]of e){if(o)continue;let e,a=0,s=!1;for(e in i){const I=i[e];let n=g[e];if(n!==I){if("object"!=typeof n||!n)continue e;{let e,g,i=0;for(const C in n){if(I===String(n[C])){if("@initial"!==C){const e=C.slice(1);(g=g||[]).push(e in t?t[e]:C.replace(/^@media ?/,"")),s=!0}a+=i,e=!0}++i}if(g&&g.length&&(C={["@media "+g.join(", ")]:C}),!e)continue e}}}(n[a]=n[a]||[]).push([I?"cv":`${e}-${i[e]}`,C,s])}return n},Rv={},Vv=jy(),Xv=(e,g)=>Vv(e,(()=>(...t)=>{const I=()=>{for(let I of t){I="object"==typeof I&&I||{};let t=hv(I);if(!g.rules.global.cache.has(t)){if(g.rules.global.cache.add(t),"@import"in I){let e=[].indexOf.call(g.sheet.cssRules,g.rules.themed.group)-1;for(let t of[].concat(I["@import"]))t=t.includes('"')||t.includes("'")?t:`"${t}"`,g.sheet.insertRule(`@import ${t};`,e++);delete I["@import"]}Av(I,[],[],e,(e=>{g.rules.global.apply(e)}))}}return""};return _y(I,{toString:I})})),Sv=jy(),Yv=(e,g)=>Sv(e,(()=>t=>{const I=`${av(e.prefix)}k-${hv(t)}`,n=()=>{if(!g.rules.global.cache.has(I)){g.rules.global.cache.add(I);const n=[];Av(t,[],[],e,(e=>n.push(e)));const i=`@keyframes ${I}{${n.join("")}}`;g.rules.global.apply(i)}return I};return _y(n,{get name(){return n()},toString:n})})),Kv=class{constructor(e,g,t,I){this.token=null==e?"":String(e),this.value=null==g?"":String(g),this.scale=null==t?"":String(t),this.prefix=null==I?"":String(I)}get computedValue(){return"var("+this.variable+")"}get variable(){return"--"+av(this.prefix)+av(this.scale)+this.token}toString(){return this.computedValue}},Hv=jy(),Nv=(e,g)=>Hv(e,(()=>(t,I)=>{I="object"==typeof t&&t||Object(I);const n=`.${t=(t="string"==typeof t?t:"")||`${av(e.prefix)}t-${hv(I)}`}`,i={},C=[];for(const g in I){i[g]={};for(const t in I[g]){const n=`--${av(e.prefix)}${g}-${t}`,o=sv(String(I[g][t]),e.prefix,g);i[g][t]=new Kv(t,o,g,e.prefix),C.push(`${n}:${o}`)}}const o=()=>{if(C.length&&!g.rules.themed.cache.has(t)){g.rules.themed.cache.add(t);const n=`${I===e.theme?":root,":""}.${t}{${C.join(";")}}`;g.rules.themed.apply(n)}return t};return{...i,get className(){return o()},selector:n,toString:o}})),Fv=jy(),xv=jy();const zv={toVector:(e,g)=>(void 0===e&&(e=g),Array.isArray(e)?e:[e,e]),add:(e,g)=>[e[0]+g[0],e[1]+g[1]],sub:(e,g)=>[e[0]-g[0],e[1]-g[1]],addTo(e,g){e[0]+=g[0],e[1]+=g[1]},subTo(e,g){e[0]-=g[0],e[1]-=g[1]}};function kv(e,g,t){return 0===g||Math.abs(g)===1/0?Math.pow(e,5*t):e*g*t/(g+t*e)}function Mv(e,g,t,I=.15){return 0===I?function(e,g,t){return Math.max(g,Math.min(e,t))}(e,g,t):e<g?-kv(g-e,t-g,I)+g:e>t?+kv(e-t,t-g,I)+t:e}function Lv(e,g,t){return(g=function(e){var g=function(e,g){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var I=t.call(e,"string");if("object"!=typeof I)return I;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof g?g:String(g)}(g))in e?Object.defineProperty(e,g,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[g]=t,e}function Jv(e,g){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var I=Object.getOwnPropertySymbols(e);g&&(I=I.filter((function(g){return Object.getOwnPropertyDescriptor(e,g).enumerable}))),t.push.apply(t,I)}return t}function Ev(e){for(var g=1;g<arguments.length;g++){var t=null!=arguments[g]?arguments[g]:{};g%2?Jv(Object(t),!0).forEach((function(g){Lv(e,g,t[g])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Jv(Object(t)).forEach((function(g){Object.defineProperty(e,g,Object.getOwnPropertyDescriptor(t,g))}))}return e}const Tv={pointer:{start:"down",change:"move",end:"up"},mouse:{start:"down",change:"move",end:"up"},touch:{start:"start",change:"move",end:"end"},gesture:{start:"start",change:"change",end:"end"}};function Uv(e){return e?e[0].toUpperCase()+e.slice(1):""}const Qv=["enter","leave"];const Dv=["gotpointercapture","lostpointercapture"];function Ov(e){let g=e.substring(2).toLowerCase();const t=!!~g.indexOf("passive");t&&(g=g.replace("passive",""));const I=Dv.includes(g)?"capturecapture":"capture",n=!!~g.indexOf(I);return n&&(g=g.replace("capture","")),{device:g,capture:n,passive:t}}function jv(e){return"touches"in e}function Pv(e){return jv(e)?"touch":"pointerType"in e?e.pointerType:"mouse"}function _v(e){return jv(e)?function(e){return"touchend"===e.type||"touchcancel"===e.type?e.changedTouches:e.targetTouches}(e)[0]:e}function qv(e){const g=_v(e);return jv(e)?g.identifier:g.pointerId}function $v(e){const g=_v(e);return[g.clientX,g.clientY]}function eW(e,...g){return"function"==typeof e?e(...g):e}function gW(){}function tW(...e){return 0===e.length?gW:1===e.length?e[0]:function(){let g;for(const t of e)g=t.apply(this,arguments)||g;return g}}function IW(e,g){return Object.assign({},g,e||{})}class nW{constructor(e,g,t){this.ctrl=e,this.args=g,this.key=t,this.state||(this.state={},this.computeValues([0,0]),this.computeInitial(),this.init&&this.init(),this.reset())}get state(){return this.ctrl.state[this.key]}set state(e){this.ctrl.state[this.key]=e}get shared(){return this.ctrl.state.shared}get eventStore(){return this.ctrl.gestureEventStores[this.key]}get timeoutStore(){return this.ctrl.gestureTimeoutStores[this.key]}get config(){return this.ctrl.config[this.key]}get sharedConfig(){return this.ctrl.config.shared}get handler(){return this.ctrl.handlers[this.key]}reset(){const{state:e,shared:g,ingKey:t,args:I}=this;g[t]=e._active=e.active=e._blocked=e._force=!1,e._step=[!1,!1],e.intentional=!1,e._movement=[0,0],e._distance=[0,0],e._direction=[0,0],e._delta=[0,0],e._bounds=[[-1/0,1/0],[-1/0,1/0]],e.args=I,e.axis=void 0,e.memo=void 0,e.elapsedTime=e.timeDelta=0,e.direction=[0,0],e.distance=[0,0],e.overflow=[0,0],e._movementBound=[!1,!1],e.velocity=[0,0],e.movement=[0,0],e.delta=[0,0],e.timeStamp=0}start(e){const g=this.state,t=this.config;g._active||(this.reset(),this.computeInitial(),g._active=!0,g.target=e.target,g.currentTarget=e.currentTarget,g.lastOffset=t.from?eW(t.from,g):g.offset,g.offset=g.lastOffset,g.startTime=g.timeStamp=e.timeStamp)}computeValues(e){const g=this.state;g._values=e,g.values=this.config.transform(e)}computeInitial(){const e=this.state;e._initial=e._values,e.initial=e.values}compute(e){const{state:g,config:t,shared:I}=this;g.args=this.args;let n=0;if(e&&(g.event=e,t.preventDefault&&e.cancelable&&g.event.preventDefault(),g.type=e.type,I.touches=this.ctrl.pointerIds.size||this.ctrl.touchIds.size,I.locked=!!document.pointerLockElement,Object.assign(I,function(e){const g={};if("buttons"in e&&(g.buttons=e.buttons),"shiftKey"in e){const{shiftKey:t,altKey:I,metaKey:n,ctrlKey:i}=e;Object.assign(g,{shiftKey:t,altKey:I,metaKey:n,ctrlKey:i})}return g}(e)),I.down=I.pressed=I.buttons%2==1||I.touches>0,n=e.timeStamp-g.timeStamp,g.timeStamp=e.timeStamp,g.elapsedTime=g.timeStamp-g.startTime),g._active){const e=g._delta.map(Math.abs);zv.addTo(g._distance,e)}this.axisIntent&&this.axisIntent(e);const[i,C]=g._movement,[o,a]=t.threshold,{_step:s,values:l}=g;if(t.hasCustomTransform?(!1===s[0]&&(s[0]=Math.abs(i)>=o&&l[0]),!1===s[1]&&(s[1]=Math.abs(C)>=a&&l[1])):(!1===s[0]&&(s[0]=Math.abs(i)>=o&&Math.sign(i)*o),!1===s[1]&&(s[1]=Math.abs(C)>=a&&Math.sign(C)*a)),g.intentional=!1!==s[0]||!1!==s[1],!g.intentional)return;const r=[0,0];if(t.hasCustomTransform){const[e,g]=l;r[0]=!1!==s[0]?e-s[0]:0,r[1]=!1!==s[1]?g-s[1]:0}else r[0]=!1!==s[0]?i-s[0]:0,r[1]=!1!==s[1]?C-s[1]:0;this.restrictToAxis&&!g._blocked&&this.restrictToAxis(r);const A=g.offset,c=g._active&&!g._blocked||g.active;c&&(g.first=g._active&&!g.active,g.last=!g._active&&g.active,g.active=I[this.ingKey]=g._active,e&&(g.first&&("bounds"in t&&(g._bounds=eW(t.bounds,g)),this.setup&&this.setup()),g.movement=r,this.computeOffset()));const[d,u]=g.offset,[[h,b],[m,p]]=g._bounds;g.overflow=[d<h?-1:d>b?1:0,u<m?-1:u>p?1:0],g._movementBound[0]=!!g.overflow[0]&&(!1===g._movementBound[0]?g._movement[0]:g._movementBound[0]),g._movementBound[1]=!!g.overflow[1]&&(!1===g._movementBound[1]?g._movement[1]:g._movementBound[1]);const G=g._active&&t.rubberband||[0,0];if(g.offset=function(e,[g,t],[I,n]){const[[i,C],[o,a]]=e;return[Mv(g,i,C,I),Mv(t,o,a,n)]}(g._bounds,g.offset,G),g.delta=zv.sub(g.offset,A),this.computeMovement(),c&&(!g.last||n>32)){g.delta=zv.sub(g.offset,A);const e=g.delta.map(Math.abs);zv.addTo(g.distance,e),g.direction=g.delta.map(Math.sign),g._direction=g._delta.map(Math.sign),!g.first&&n>0&&(g.velocity=[e[0]/n,e[1]/n],g.timeDelta=n)}}emit(){const e=this.state,g=this.shared,t=this.config;if(e._active||this.clean(),(e._blocked||!e.intentional)&&!e._force&&!t.triggerAllEvents)return;const I=this.handler(Ev(Ev(Ev({},g),e),{},{[this.aliasKey]:e.values}));void 0!==I&&(e.memo=I)}clean(){this.eventStore.clean(),this.timeoutStore.clean()}}class iW extends nW{constructor(...e){super(...e),Lv(this,"aliasKey","xy")}reset(){super.reset(),this.state.axis=void 0}init(){this.state.offset=[0,0],this.state.lastOffset=[0,0]}computeOffset(){this.state.offset=zv.add(this.state.lastOffset,this.state.movement)}computeMovement(){this.state.movement=zv.sub(this.state.offset,this.state.lastOffset)}axisIntent(e){const g=this.state,t=this.config;if(!g.axis&&e){const I="object"==typeof t.axisThreshold?t.axisThreshold[Pv(e)]:t.axisThreshold;g.axis=function([e,g],t){const I=Math.abs(e),n=Math.abs(g);return I>n&&I>t?"x":n>I&&n>t?"y":void 0}(g._movement,I)}g._blocked=(t.lockDirection||!!t.axis)&&!g.axis||!!t.axis&&t.axis!==g.axis}restrictToAxis(e){if(this.config.axis||this.config.lockDirection)switch(this.state.axis){case"x":e[1]=0;break;case"y":e[0]=0}}}const CW=e=>e,oW={enabled:(e=!0)=>e,eventOptions:(e,g,t)=>Ev(Ev({},t.shared.eventOptions),e),preventDefault:(e=!1)=>e,triggerAllEvents:(e=!1)=>e,rubberband(e=0){switch(e){case!0:return[.15,.15];case!1:return[0,0];default:return zv.toVector(e)}},from:e=>"function"==typeof e?e:null!=e?zv.toVector(e):void 0,transform(e,g,t){const I=e||t.shared.transform;return this.hasCustomTransform=!!I,I||CW},threshold:e=>zv.toVector(e,0)},aW=Ev(Ev({},oW),{},{axis(e,g,{axis:t}){if(this.lockDirection="lock"===t,!this.lockDirection)return t},axisThreshold:(e=0)=>e,bounds(e={}){if("function"==typeof e)return g=>aW.bounds(e(g));if("current"in e)return()=>e.current;if("function"==typeof HTMLElement&&e instanceof HTMLElement)return e;const{left:g=-1/0,right:t=1/0,top:I=-1/0,bottom:n=1/0}=e;return[[g,t],[I,n]]}}),sW={ArrowRight:(e,g=1)=>[e*g,0],ArrowLeft:(e,g=1)=>[-1*e*g,0],ArrowUp:(e,g=1)=>[0,-1*e*g],ArrowDown:(e,g=1)=>[0,e*g]},lW="undefined"!=typeof window&&window.document&&window.document.createElement;function rW(){return lW&&"ontouchstart"in window}const AW={isBrowser:lW,gesture:function(){try{return"constructor"in GestureEvent}catch(e){return!1}}(),touch:rW(),touchscreen:rW()||lW&&window.navigator.maxTouchPoints>1,pointer:lW&&"onpointerdown"in window,pointerLock:lW&&"exitPointerLock"in window.document},cW={mouse:0,touch:0,pen:8},dW=Ev(Ev({},aW),{},{device(e,g,{pointer:{touch:t=!1,lock:I=!1,mouse:n=!1}={}}){return this.pointerLock=I&&AW.pointerLock,AW.touch&&t?"touch":this.pointerLock?"mouse":AW.pointer&&!n?"pointer":AW.touch?"touch":"mouse"},preventScrollAxis(e,g,{preventScroll:t}){if(this.preventScrollDelay="number"==typeof t?t:t||void 0===t&&e?250:void 0,AW.touchscreen&&!1!==t)return e||(void 0!==t?"y":void 0)},pointerCapture(e,g,{pointer:{capture:t=!0,buttons:I=1,keys:n=!0}={}}){return this.pointerButtons=I,this.keys=n,!this.pointerLock&&"pointer"===this.device&&t},threshold(e,g,{filterTaps:t=!1,tapsThreshold:I=3,axis:n}){const i=zv.toVector(e,t?I:n?1:0);return this.filterTaps=t,this.tapsThreshold=I,i},swipe({velocity:e=.5,distance:g=50,duration:t=250}={}){return{velocity:this.transform(zv.toVector(e)),distance:this.transform(zv.toVector(g)),duration:t}},delay(e=0){switch(e){case!0:return 180;case!1:return 0;default:return e}},axisThreshold:e=>e?Ev(Ev({},cW),e):cW,keyboardDisplacement:(e=10)=>e});Ev(Ev({},oW),{},{device(e,g,{shared:t,pointer:{touch:I=!1}={}}){if(t.target&&!AW.touch&&AW.gesture)return"gesture";if(AW.touch&&I)return"touch";if(AW.touchscreen){if(AW.pointer)return"pointer";if(AW.touch)return"touch"}},bounds(e,g,{scaleBounds:t={},angleBounds:I={}}){const n=e=>{const g=IW(eW(t,e),{min:-1/0,max:1/0});return[g.min,g.max]},i=e=>{const g=IW(eW(I,e),{min:-1/0,max:1/0});return[g.min,g.max]};return"function"!=typeof t&&"function"!=typeof I?[n(),i()]:e=>[n(e),i(e)]},threshold(e,g,t){return this.lockDirection="lock"===t.axis,zv.toVector(e,this.lockDirection?[.1,3]:0)},modifierKey:e=>void 0===e?"ctrlKey":e,pinchOnWheel:(e=!0)=>e}),Ev(Ev({},aW),{},{mouseOnly:(e=!0)=>e}),Ev(Ev({},aW),{},{mouseOnly:(e=!0)=>e});const uW=new Map,hW=new Map,bW={key:"drag",engine:class extends iW{constructor(...e){super(...e),Lv(this,"ingKey","dragging")}reset(){super.reset();const e=this.state;e._pointerId=void 0,e._pointerActive=!1,e._keyboardActive=!1,e._preventScroll=!1,e._delayed=!1,e.swipe=[0,0],e.tap=!1,e.canceled=!1,e.cancel=this.cancel.bind(this)}setup(){const e=this.state;if(e._bounds instanceof HTMLElement){const g=e._bounds.getBoundingClientRect(),t=e.currentTarget.getBoundingClientRect(),I={left:g.left-t.left+e.offset[0],right:g.right-t.right+e.offset[0],top:g.top-t.top+e.offset[1],bottom:g.bottom-t.bottom+e.offset[1]};e._bounds=aW.bounds(I)}}cancel(){const e=this.state;e.canceled||(e.canceled=!0,e._active=!1,setTimeout((()=>{this.compute(),this.emit()}),0))}setActive(){this.state._active=this.state._pointerActive||this.state._keyboardActive}clean(){this.pointerClean(),this.state._pointerActive=!1,this.state._keyboardActive=!1,super.clean()}pointerDown(e){const g=this.config,t=this.state;if(null!=e.buttons&&(Array.isArray(g.pointerButtons)?!g.pointerButtons.includes(e.buttons):-1!==g.pointerButtons&&g.pointerButtons!==e.buttons))return;const I=this.ctrl.setEventIds(e);g.pointerCapture&&e.target.setPointerCapture(e.pointerId),I&&I.size>1&&t._pointerActive||(this.start(e),this.setupPointer(e),t._pointerId=qv(e),t._pointerActive=!0,this.computeValues($v(e)),this.computeInitial(),g.preventScrollAxis&&"mouse"!==Pv(e)?(t._active=!1,this.setupScrollPrevention(e)):g.delay>0?(this.setupDelayTrigger(e),g.triggerAllEvents&&(this.compute(e),this.emit())):this.startPointerDrag(e))}startPointerDrag(e){const g=this.state;g._active=!0,g._preventScroll=!0,g._delayed=!1,this.compute(e),this.emit()}pointerMove(e){const g=this.state,t=this.config;if(!g._pointerActive)return;const I=qv(e);if(void 0!==g._pointerId&&I!==g._pointerId)return;const n=$v(e);return document.pointerLockElement===e.target?g._delta=[e.movementX,e.movementY]:(g._delta=zv.sub(n,g._values),this.computeValues(n)),zv.addTo(g._movement,g._delta),this.compute(e),g._delayed&&g.intentional?(this.timeoutStore.remove("dragDelay"),g.active=!1,void this.startPointerDrag(e)):t.preventScrollAxis&&!g._preventScroll?g.axis?g.axis===t.preventScrollAxis||"xy"===t.preventScrollAxis?(g._active=!1,void this.clean()):(this.timeoutStore.remove("startPointerDrag"),void this.startPointerDrag(e)):void 0:void this.emit()}pointerUp(e){this.ctrl.setEventIds(e);try{this.config.pointerCapture&&e.target.hasPointerCapture(e.pointerId)&&e.target.releasePointerCapture(e.pointerId)}catch(e){}const g=this.state,t=this.config;if(!g._active||!g._pointerActive)return;const I=qv(e);if(void 0!==g._pointerId&&I!==g._pointerId)return;this.state._pointerActive=!1,this.setActive(),this.compute(e);const[n,i]=g._distance;if(g.tap=n<=t.tapsThreshold&&i<=t.tapsThreshold,g.tap&&t.filterTaps)g._force=!0;else{const[e,I]=g._delta,[n,i]=g._movement,[C,o]=t.swipe.velocity,[a,s]=t.swipe.distance,l=t.swipe.duration;if(g.elapsedTime<l){const t=Math.abs(e/g.timeDelta),l=Math.abs(I/g.timeDelta);t>C&&Math.abs(n)>a&&(g.swipe[0]=Math.sign(e)),l>o&&Math.abs(i)>s&&(g.swipe[1]=Math.sign(I))}}this.emit()}pointerClick(e){!this.state.tap&&e.detail>0&&(e.preventDefault(),e.stopPropagation())}setupPointer(e){const g=this.config,t=g.device;g.pointerLock&&e.currentTarget.requestPointerLock(),g.pointerCapture||(this.eventStore.add(this.sharedConfig.window,t,"change",this.pointerMove.bind(this)),this.eventStore.add(this.sharedConfig.window,t,"end",this.pointerUp.bind(this)),this.eventStore.add(this.sharedConfig.window,t,"cancel",this.pointerUp.bind(this)))}pointerClean(){this.config.pointerLock&&document.pointerLockElement===this.state.currentTarget&&document.exitPointerLock()}preventScroll(e){this.state._preventScroll&&e.cancelable&&e.preventDefault()}setupScrollPrevention(e){this.state._preventScroll=!1,function(e){"persist"in e&&"function"==typeof e.persist&&e.persist()}(e);const g=this.eventStore.add(this.sharedConfig.window,"touch","change",this.preventScroll.bind(this),{passive:!1});this.eventStore.add(this.sharedConfig.window,"touch","end",g),this.eventStore.add(this.sharedConfig.window,"touch","cancel",g),this.timeoutStore.add("startPointerDrag",this.startPointerDrag.bind(this),this.config.preventScrollDelay,e)}setupDelayTrigger(e){this.state._delayed=!0,this.timeoutStore.add("dragDelay",(()=>{this.state._step=[0,0],this.startPointerDrag(e)}),this.config.delay)}keyDown(e){const g=sW[e.key];if(g){const t=this.state,I=e.shiftKey?10:e.altKey?.1:1;this.start(e),t._delta=g(this.config.keyboardDisplacement,I),t._keyboardActive=!0,zv.addTo(t._movement,t._delta),this.compute(e),this.emit()}}keyUp(e){e.key in sW&&(this.state._keyboardActive=!1,this.setActive(),this.compute(e),this.emit())}bind(e){const g=this.config.device;e(g,"start",this.pointerDown.bind(this)),this.config.pointerCapture&&(e(g,"change",this.pointerMove.bind(this)),e(g,"end",this.pointerUp.bind(this)),e(g,"cancel",this.pointerUp.bind(this)),e("lostPointerCapture","",this.pointerUp.bind(this))),this.config.keys&&(e("key","down",this.keyDown.bind(this)),e("key","up",this.keyUp.bind(this))),this.config.filterTaps&&e("click","",this.pointerClick.bind(this),{capture:!0,passive:!1})}},resolver:dW};const mW={target(e){if(e)return()=>"current"in e?e.current:e},enabled:(e=!0)=>e,window:(e=(AW.isBrowser?window:void 0))=>e,eventOptions:({passive:e=!0,capture:g=!1}={})=>({passive:e,capture:g}),transform:e=>e},pW=["target","eventOptions","window","enabled","transform"];function GW(e={},g){const t={};for(const[I,n]of Object.entries(g))switch(typeof n){case"function":t[I]=n.call(t,e[I],I,e);break;case"object":t[I]=GW(e[I],n);break;case"boolean":n&&(t[I]=e[I])}return t}class BW{constructor(e,g){Lv(this,"_listeners",new Set),this._ctrl=e,this._gestureKey=g}add(e,g,t,I,n){const i=this._listeners,C=function(e,g=""){const t=Tv[e];return e+(t&&t[g]||g)}(g,t),o=Ev(Ev({},this._gestureKey?this._ctrl.config[this._gestureKey].eventOptions:{}),n);e.addEventListener(C,I,o);const a=()=>{e.removeEventListener(C,I,o),i.delete(a)};return i.add(a),a}clean(){this._listeners.forEach((e=>e())),this._listeners.clear()}}class ZW{constructor(){Lv(this,"_timeouts",new Map)}add(e,g,t=140,...I){this.remove(e),this._timeouts.set(e,window.setTimeout(g,t,...I))}remove(e){const g=this._timeouts.get(e);g&&window.clearTimeout(g)}clean(){this._timeouts.forEach((e=>{window.clearTimeout(e)})),this._timeouts.clear()}}class yW{constructor(e){var g,t;Lv(this,"gestures",new Set),Lv(this,"_targetEventStore",new BW(this)),Lv(this,"gestureEventStores",{}),Lv(this,"gestureTimeoutStores",{}),Lv(this,"handlers",{}),Lv(this,"config",{}),Lv(this,"pointerIds",new Set),Lv(this,"touchIds",new Set),Lv(this,"state",{shared:{shiftKey:!1,metaKey:!1,ctrlKey:!1,altKey:!1}}),g=this,(t=e).drag&&vW(g,"drag"),t.wheel&&vW(g,"wheel"),t.scroll&&vW(g,"scroll"),t.move&&vW(g,"move"),t.pinch&&vW(g,"pinch"),t.hover&&vW(g,"hover")}setEventIds(e){return jv(e)?(this.touchIds=new Set(function(e){return function(e){return Array.from(e.touches).filter((g=>{var t,I;return g.target===e.currentTarget||(null===(t=e.currentTarget)||void 0===t||null===(I=t.contains)||void 0===I?void 0:I.call(t,g.target))}))}(e).map((e=>e.identifier))}(e)),this.touchIds):"pointerId"in e?("pointerup"===e.type||"pointercancel"===e.type?this.pointerIds.delete(e.pointerId):"pointerdown"===e.type&&this.pointerIds.add(e.pointerId),this.pointerIds):void 0}applyHandlers(e,g){this.handlers=e,this.nativeHandlers=g}applyConfig(e,g){this.config=function(e,g,t={}){const I=e,{target:n,eventOptions:i,window:C,enabled:o,transform:a}=I,s=function(e,g){if(null==e)return{};var t,I,n=function(e,g){if(null==e)return{};var t,I,n={},i=Object.keys(e);for(I=0;I<i.length;I++)t=i[I],g.indexOf(t)>=0||(n[t]=e[t]);return n}(e,g);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(I=0;I<i.length;I++)t=i[I],g.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(n[t]=e[t])}return n}(I,pW);if(t.shared=GW({target:n,eventOptions:i,window:C,enabled:o,transform:a},mW),g){const e=hW.get(g);t[g]=GW(Ev({shared:t.shared},s),e)}else for(const e in s){const g=hW.get(e);g&&(t[e]=GW(Ev({shared:t.shared},s[e]),g))}return t}(e,g,this.config)}clean(){this._targetEventStore.clean();for(const e of this.gestures)this.gestureEventStores[e].clean(),this.gestureTimeoutStores[e].clean()}effect(){return this.config.shared.target&&this.bind(),()=>this._targetEventStore.clean()}bind(...e){const g=this.config.shared,t={};let I;if(!g.target||(I=g.target(),I)){if(g.enabled){for(const g of this.gestures){const n=this.config[g],i=WW(t,n.eventOptions,!!I);n.enabled&&new(uW.get(g))(this,e,g).bind(i)}const n=WW(t,g.eventOptions,!!I);for(const g in this.nativeHandlers)n(g,"",(t=>this.nativeHandlers[g](Ev(Ev({},this.state.shared),{},{event:t,args:e}))),void 0,!0)}for(const e in t)t[e]=tW(...t[e]);if(!I)return t;for(const e in t){const{device:g,capture:n,passive:i}=Ov(e);this._targetEventStore.add(I,g,"",t[e],{capture:n,passive:i})}}}}function vW(e,g){e.gestures.add(g),e.gestureEventStores[g]=new BW(e,g),e.gestureTimeoutStores[g]=new ZW}const WW=(e,g,t)=>(I,n,i,C={},o=!1)=>{var a,s;const l=null!==(a=C.capture)&&void 0!==a?a:g.capture,r=null!==(s=C.passive)&&void 0!==s?s:g.passive;let A=o?I:function(e,g="",t=!1){const I=Tv[e],n=I&&I[g]||g;return"on"+Uv(e)+Uv(n)+(function(e=!1,g){return e&&!Qv.includes(g)}(t,n)?"Capture":"")}(I,n,l);t&&r&&(A+="Passive"),e[A]=e[A]||[],e[A].push(i)};function fW(e,t){var I;return I=bW,uW.set(I.key,I.engine),hW.set(I.key,I.resolver),function(e,t={},I,n){const i=g.useMemo((()=>new yW(e)),[]);if(i.applyHandlers(e,n),i.applyConfig(t,I),g.useEffect(i.effect.bind(i)),g.useEffect((()=>i.clean.bind(i)),[]),void 0===t.target)return i.bind.bind(i)}({drag:e},t||{},"drag")}function wW(e,g,{checkForDefaultPrevented:t=!0}={}){return function(I){if(null==e||e(I),!1===t||!I.defaultPrevented)return null==g?void 0:g(I)}}function RW(e,t=[]){let I=[];const n=()=>{const t=I.map((e=>(0,g.createContext)(e)));return function(I){const n=(null==I?void 0:I[e])||t;return(0,g.useMemo)((()=>({[`__scope${e}`]:{...I,[e]:n}})),[I,n])}};return n.scopeName=e,[function(t,n){const i=(0,g.createContext)(n),C=I.length;function o(t){const{scope:I,children:n,...o}=t,a=(null==I?void 0:I[e][C])||i,s=(0,g.useMemo)((()=>o),Object.values(o));return(0,g.createElement)(a.Provider,{value:s},n)}return I=[...I,n],o.displayName=t+"Provider",[o,function(I,o){const a=(null==o?void 0:o[e][C])||i,s=(0,g.useContext)(a);if(s)return s;if(void 0!==n)return n;throw new Error(`\`${I}\` must be used within \`${t}\``)}]},VW(n,...t)]}function VW(...e){const t=e[0];if(1===e.length)return t;const I=()=>{const I=e.map((e=>({useScope:e(),scopeName:e.scopeName})));return function(e){const n=I.reduce(((g,{useScope:t,scopeName:I})=>({...g,...t(e)[`__scope${I}`]})),{});return(0,g.useMemo)((()=>({[`__scope${t.scopeName}`]:n})),[n])}};return I.scopeName=t.scopeName,I}function XW(e){const t=(0,g.useRef)(e);return(0,g.useEffect)((()=>{t.current=e})),(0,g.useMemo)((()=>(...e)=>{var g;return null===(g=t.current)||void 0===g?void 0:g.call(t,...e)}),[])}const SW="dismissableLayer.update";let YW;const KW=(0,g.createContext)({layers:new Set,layersWithOutsidePointerEventsDisabled:new Set,branches:new Set}),HW=(0,g.forwardRef)(((e,t)=>{var I;const{disableOutsidePointerEvents:n=!1,onEscapeKeyDown:i,onPointerDownOutside:C,onFocusOutside:o,onInteractOutside:a,onDismiss:s,...l}=e,r=(0,g.useContext)(KW),[A,c]=(0,g.useState)(null),d=null!==(I=null==A?void 0:A.ownerDocument)&&void 0!==I?I:null===globalThis||void 0===globalThis?void 0:globalThis.document,[,u]=(0,g.useState)({}),h=Ay(t,(e=>c(e))),b=Array.from(r.layers),[m]=[...r.layersWithOutsidePointerEventsDisabled].slice(-1),p=b.indexOf(m),G=A?b.indexOf(A):-1,B=r.layersWithOutsidePointerEventsDisabled.size>0,Z=G>=p,y=function(e,t=(null===globalThis||void 0===globalThis?void 0:globalThis.document)){const I=XW(e),n=(0,g.useRef)(!1),i=(0,g.useRef)((()=>{}));return(0,g.useEffect)((()=>{const e=e=>{if(e.target&&!n.current){const g={originalEvent:e};function C(){FW("dismissableLayer.pointerDownOutside",I,g,{discrete:!0})}"touch"===e.pointerType?(t.removeEventListener("click",i.current),i.current=C,t.addEventListener("click",i.current,{once:!0})):C()}else t.removeEventListener("click",i.current);n.current=!1},g=window.setTimeout((()=>{t.addEventListener("pointerdown",e)}),0);return()=>{window.clearTimeout(g),t.removeEventListener("pointerdown",e),t.removeEventListener("click",i.current)}}),[t,I]),{onPointerDownCapture:()=>n.current=!0}}((e=>{const g=e.target,t=[...r.branches].some((e=>e.contains(g)));Z&&!t&&(null==C||C(e),null==a||a(e),e.defaultPrevented||null==s||s())}),d),v=function(e,t=(null===globalThis||void 0===globalThis?void 0:globalThis.document)){const I=XW(e),n=(0,g.useRef)(!1);return(0,g.useEffect)((()=>{const e=e=>{e.target&&!n.current&&FW("dismissableLayer.focusOutside",I,{originalEvent:e},{discrete:!1})};return t.addEventListener("focusin",e),()=>t.removeEventListener("focusin",e)}),[t,I]),{onFocusCapture:()=>n.current=!0,onBlurCapture:()=>n.current=!1}}((e=>{const g=e.target;[...r.branches].some((e=>e.contains(g)))||(null==o||o(e),null==a||a(e),e.defaultPrevented||null==s||s())}),d);return function(e,t=(null===globalThis||void 0===globalThis?void 0:globalThis.document)){const I=XW(e);(0,g.useEffect)((()=>{const e=e=>{"Escape"===e.key&&I(e)};return t.addEventListener("keydown",e),()=>t.removeEventListener("keydown",e)}),[I,t])}((e=>{G===r.layers.size-1&&(null==i||i(e),!e.defaultPrevented&&s&&(e.preventDefault(),s()))}),d),(0,g.useEffect)((()=>{if(A)return n&&(0===r.layersWithOutsidePointerEventsDisabled.size&&(YW=d.body.style.pointerEvents,d.body.style.pointerEvents="none"),r.layersWithOutsidePointerEventsDisabled.add(A)),r.layers.add(A),NW(),()=>{n&&1===r.layersWithOutsidePointerEventsDisabled.size&&(d.body.style.pointerEvents=YW)}}),[A,d,n,r]),(0,g.useEffect)((()=>()=>{A&&(r.layers.delete(A),r.layersWithOutsidePointerEventsDisabled.delete(A),NW())}),[A,r]),(0,g.useEffect)((()=>{const e=()=>u({});return document.addEventListener(SW,e),()=>document.removeEventListener(SW,e)}),[]),(0,g.createElement)(my.div,qu({},l,{ref:h,style:{pointerEvents:B?Z?"auto":"none":void 0,...e.style},onFocusCapture:wW(e.onFocusCapture,v.onFocusCapture),onBlurCapture:wW(e.onBlurCapture,v.onBlurCapture),onPointerDownCapture:wW(e.onPointerDownCapture,y.onPointerDownCapture)}))}));function NW(){const e=new CustomEvent(SW);document.dispatchEvent(e)}function FW(e,g,t,{discrete:I}){const n=t.originalEvent.target,i=new CustomEvent(e,{bubbles:!1,cancelable:!0,detail:t});g&&n.addEventListener(e,g,{once:!0}),I?function(e,g){e&&(0,ly.flushSync)((()=>e.dispatchEvent(g)))}(n,i):n.dispatchEvent(i)}const xW=Boolean(null===globalThis||void 0===globalThis?void 0:globalThis.document)?g.useLayoutEffect:()=>{},zW=t["useId".toString()]||(()=>{});let kW=0;const MW=["top","right","bottom","left"],LW=Math.min,JW=Math.max,EW=Math.round,TW=Math.floor,UW=e=>({x:e,y:e}),QW={left:"right",right:"left",bottom:"top",top:"bottom"},DW={start:"end",end:"start"};function OW(e,g,t){return JW(e,LW(g,t))}function jW(e,g){return"function"==typeof e?e(g):e}function PW(e){return e.split("-")[0]}function _W(e){return e.split("-")[1]}function qW(e){return"x"===e?"y":"x"}function $W(e){return"y"===e?"height":"width"}function ef(e){return["top","bottom"].includes(PW(e))?"y":"x"}function gf(e){return qW(ef(e))}function tf(e){return e.replace(/start|end/g,(e=>DW[e]))}function If(e){return e.replace(/left|right|bottom|top/g,(e=>QW[e]))}function nf(e){return"number"!=typeof e?function(e){return{top:0,right:0,bottom:0,left:0,...e}}(e):{top:e,right:e,bottom:e,left:e}}function Cf(e){return{...e,top:e.y,left:e.x,right:e.x+e.width,bottom:e.y+e.height}}function of(e,g,t){let{reference:I,floating:n}=e;const i=ef(g),C=gf(g),o=$W(C),a=PW(g),s="y"===i,l=I.x+I.width/2-n.width/2,r=I.y+I.height/2-n.height/2,A=I[o]/2-n[o]/2;let c;switch(a){case"top":c={x:l,y:I.y-n.height};break;case"bottom":c={x:l,y:I.y+I.height};break;case"right":c={x:I.x+I.width,y:r};break;case"left":c={x:I.x-n.width,y:r};break;default:c={x:I.x,y:I.y}}switch(_W(g)){case"start":c[C]-=A*(t&&s?-1:1);break;case"end":c[C]+=A*(t&&s?-1:1)}return c}async function af(e,g){var t;void 0===g&&(g={});const{x:I,y:n,platform:i,rects:C,elements:o,strategy:a}=e,{boundary:s="clippingAncestors",rootBoundary:l="viewport",elementContext:r="floating",altBoundary:A=!1,padding:c=0}=jW(g,e),d=nf(c),u=o[A?"floating"===r?"reference":"floating":r],h=Cf(await i.getClippingRect({element:null==(t=await(null==i.isElement?void 0:i.isElement(u)))||t?u:u.contextElement||await(null==i.getDocumentElement?void 0:i.getDocumentElement(o.floating)),boundary:s,rootBoundary:l,strategy:a})),b="floating"===r?{...C.floating,x:I,y:n}:C.reference,m=await(null==i.getOffsetParent?void 0:i.getOffsetParent(o.floating)),p=await(null==i.isElement?void 0:i.isElement(m))&&await(null==i.getScale?void 0:i.getScale(m))||{x:1,y:1},G=Cf(i.convertOffsetParentRelativeRectToViewportRelativeRect?await i.convertOffsetParentRelativeRectToViewportRelativeRect({rect:b,offsetParent:m,strategy:a}):b);return{top:(h.top-G.top+d.top)/p.y,bottom:(G.bottom-h.bottom+d.bottom)/p.y,left:(h.left-G.left+d.left)/p.x,right:(G.right-h.right+d.right)/p.x}}const sf=e=>({name:"arrow",options:e,async fn(g){const{x:t,y:I,placement:n,rects:i,platform:C,elements:o,middlewareData:a}=g,{element:s,padding:l=0}=jW(e,g)||{};if(null==s)return{};const r=nf(l),A={x:t,y:I},c=gf(n),d=$W(c),u=await C.getDimensions(s),h="y"===c,b=h?"top":"left",m=h?"bottom":"right",p=h?"clientHeight":"clientWidth",G=i.reference[d]+i.reference[c]-A[c]-i.floating[d],B=A[c]-i.reference[c],Z=await(null==C.getOffsetParent?void 0:C.getOffsetParent(s));let y=Z?Z[p]:0;y&&await(null==C.isElement?void 0:C.isElement(Z))||(y=o.floating[p]||i.floating[d]);const v=G/2-B/2,W=y/2-u[d]/2-1,f=LW(r[b],W),w=LW(r[m],W),R=f,V=y-u[d]-w,X=y/2-u[d]/2+v,S=OW(R,X,V),Y=!a.arrow&&null!=_W(n)&&X!=S&&i.reference[d]/2-(X<R?f:w)-u[d]/2<0,K=Y?X<R?X-R:X-V:0;return{[c]:A[c]+K,data:{[c]:S,centerOffset:X-S-K,...Y&&{alignmentOffset:K}},reset:Y}}}),lf=function(e){return void 0===e&&(e={}),{name:"flip",options:e,async fn(g){var t,I;const{placement:n,middlewareData:i,rects:C,initialPlacement:o,platform:a,elements:s}=g,{mainAxis:l=!0,crossAxis:r=!0,fallbackPlacements:A,fallbackStrategy:c="bestFit",fallbackAxisSideDirection:d="none",flipAlignment:u=!0,...h}=jW(e,g);if(null!=(t=i.arrow)&&t.alignmentOffset)return{};const b=PW(n),m=PW(o)===o,p=await(null==a.isRTL?void 0:a.isRTL(s.floating)),G=A||(m||!u?[If(o)]:function(e){const g=If(e);return[tf(e),g,tf(g)]}(o));A||"none"===d||G.push(...function(e,g,t,I){const n=_W(e);let i=function(e,g,t){const I=["left","right"],n=["right","left"],i=["top","bottom"],C=["bottom","top"];switch(e){case"top":case"bottom":return t?g?n:I:g?I:n;case"left":case"right":return g?i:C;default:return[]}}(PW(e),"start"===t,I);return n&&(i=i.map((e=>e+"-"+n)),g&&(i=i.concat(i.map(tf)))),i}(o,u,d,p));const B=[o,...G],Z=await af(g,h),y=[];let v=(null==(I=i.flip)?void 0:I.overflows)||[];if(l&&y.push(Z[b]),r){const e=function(e,g,t){void 0===t&&(t=!1);const I=_W(e),n=gf(e),i=$W(n);let C="x"===n?I===(t?"end":"start")?"right":"left":"start"===I?"bottom":"top";return g.reference[i]>g.floating[i]&&(C=If(C)),[C,If(C)]}(n,C,p);y.push(Z[e[0]],Z[e[1]])}if(v=[...v,{placement:n,overflows:y}],!y.every((e=>e<=0))){var W,f;const e=((null==(W=i.flip)?void 0:W.index)||0)+1,g=B[e];if(g)return{data:{index:e,overflows:v},reset:{placement:g}};let t=null==(f=v.filter((e=>e.overflows[0]<=0)).sort(((e,g)=>e.overflows[1]-g.overflows[1]))[0])?void 0:f.placement;if(!t)switch(c){case"bestFit":{var w;const e=null==(w=v.map((e=>[e.placement,e.overflows.filter((e=>e>0)).reduce(((e,g)=>e+g),0)])).sort(((e,g)=>e[1]-g[1]))[0])?void 0:w[0];e&&(t=e);break}case"initialPlacement":t=o}if(n!==t)return{reset:{placement:t}}}return{}}}};function rf(e,g){return{top:e.top-g.height,right:e.right-g.width,bottom:e.bottom-g.height,left:e.left-g.width}}function Af(e){return MW.some((g=>e[g]>=0))}const cf=function(e){return void 0===e&&(e={}),{name:"hide",options:e,async fn(g){const{rects:t}=g,{strategy:I="referenceHidden",...n}=jW(e,g);switch(I){case"referenceHidden":{const e=rf(await af(g,{...n,elementContext:"reference"}),t.reference);return{data:{referenceHiddenOffsets:e,referenceHidden:Af(e)}}}case"escaped":{const e=rf(await af(g,{...n,altBoundary:!0}),t.floating);return{data:{escapedOffsets:e,escaped:Af(e)}}}default:return{}}}}},df=function(e){return void 0===e&&(e=0),{name:"offset",options:e,async fn(g){const{x:t,y:I}=g,n=await async function(e,g){const{placement:t,platform:I,elements:n}=e,i=await(null==I.isRTL?void 0:I.isRTL(n.floating)),C=PW(t),o=_W(t),a="y"===ef(t),s=["left","top"].includes(C)?-1:1,l=i&&a?-1:1,r=jW(g,e);let{mainAxis:A,crossAxis:c,alignmentAxis:d}="number"==typeof r?{mainAxis:r,crossAxis:0,alignmentAxis:null}:{mainAxis:0,crossAxis:0,alignmentAxis:null,...r};return o&&"number"==typeof d&&(c="end"===o?-1*d:d),a?{x:c*l,y:A*s}:{x:A*s,y:c*l}}(g,e);return{x:t+n.x,y:I+n.y,data:n}}}},uf=function(e){return void 0===e&&(e={}),{name:"shift",options:e,async fn(g){const{x:t,y:I,placement:n}=g,{mainAxis:i=!0,crossAxis:C=!1,limiter:o={fn:e=>{let{x:g,y:t}=e;return{x:g,y:t}}},...a}=jW(e,g),s={x:t,y:I},l=await af(g,a),r=ef(PW(n)),A=qW(r);let c=s[A],d=s[r];if(i){const e="y"===A?"bottom":"right";c=OW(c+l["y"===A?"top":"left"],c,c-l[e])}if(C){const e="y"===r?"bottom":"right";d=OW(d+l["y"===r?"top":"left"],d,d-l[e])}const u=o.fn({...g,[A]:c,[r]:d});return{...u,data:{x:u.x-t,y:u.y-I}}}}},hf=function(e){return void 0===e&&(e={}),{options:e,fn(g){const{x:t,y:I,placement:n,rects:i,middlewareData:C}=g,{offset:o=0,mainAxis:a=!0,crossAxis:s=!0}=jW(e,g),l={x:t,y:I},r=ef(n),A=qW(r);let c=l[A],d=l[r];const u=jW(o,g),h="number"==typeof u?{mainAxis:u,crossAxis:0}:{mainAxis:0,crossAxis:0,...u};if(a){const e="y"===A?"height":"width",g=i.reference[A]-i.floating[e]+h.mainAxis,t=i.reference[A]+i.reference[e]-h.mainAxis;c<g?c=g:c>t&&(c=t)}if(s){var b,m;const e="y"===A?"width":"height",g=["top","left"].includes(PW(n)),t=i.reference[r]-i.floating[e]+(g&&(null==(b=C.offset)?void 0:b[r])||0)+(g?0:h.crossAxis),I=i.reference[r]+i.reference[e]+(g?0:(null==(m=C.offset)?void 0:m[r])||0)-(g?h.crossAxis:0);d<t?d=t:d>I&&(d=I)}return{[A]:c,[r]:d}}}},bf=function(e){return void 0===e&&(e={}),{name:"size",options:e,async fn(g){const{placement:t,rects:I,platform:n,elements:i}=g,{apply:C=(()=>{}),...o}=jW(e,g),a=await af(g,o),s=PW(t),l=_W(t),r="y"===ef(t),{width:A,height:c}=I.floating;let d,u;"top"===s||"bottom"===s?(d=s,u=l===(await(null==n.isRTL?void 0:n.isRTL(i.floating))?"start":"end")?"left":"right"):(u=s,d="end"===l?"top":"bottom");const h=c-a[d],b=A-a[u],m=!g.middlewareData.shift;let p=h,G=b;if(r){const e=A-a.left-a.right;G=l||m?LW(b,e):e}else{const e=c-a.top-a.bottom;p=l||m?LW(h,e):e}if(m&&!l){const e=JW(a.left,0),g=JW(a.right,0),t=JW(a.top,0),I=JW(a.bottom,0);r?G=A-2*(0!==e||0!==g?e+g:JW(a.left,a.right)):p=c-2*(0!==t||0!==I?t+I:JW(a.top,a.bottom))}await C({...g,availableWidth:G,availableHeight:p});const B=await n.getDimensions(i.floating);return A!==B.width||c!==B.height?{reset:{rects:!0}}:{}}}};function mf(e){return Bf(e)?(e.nodeName||"").toLowerCase():"#document"}function pf(e){var g;return(null==e||null==(g=e.ownerDocument)?void 0:g.defaultView)||window}function Gf(e){var g;return null==(g=(Bf(e)?e.ownerDocument:e.document)||window.document)?void 0:g.documentElement}function Bf(e){return e instanceof Node||e instanceof pf(e).Node}function Zf(e){return e instanceof Element||e instanceof pf(e).Element}function yf(e){return e instanceof HTMLElement||e instanceof pf(e).HTMLElement}function vf(e){return"undefined"!=typeof ShadowRoot&&(e instanceof ShadowRoot||e instanceof pf(e).ShadowRoot)}function Wf(e){const{overflow:g,overflowX:t,overflowY:I,display:n}=Xf(e);return/auto|scroll|overlay|hidden|clip/.test(g+I+t)&&!["inline","contents"].includes(n)}function ff(e){return["table","td","th"].includes(mf(e))}function wf(e){const g=Rf(),t=Xf(e);return"none"!==t.transform||"none"!==t.perspective||!!t.containerType&&"normal"!==t.containerType||!g&&!!t.backdropFilter&&"none"!==t.backdropFilter||!g&&!!t.filter&&"none"!==t.filter||["transform","perspective","filter"].some((e=>(t.willChange||"").includes(e)))||["paint","layout","strict","content"].some((e=>(t.contain||"").includes(e)))}function Rf(){return!("undefined"==typeof CSS||!CSS.supports)&&CSS.supports("-webkit-backdrop-filter","none")}function Vf(e){return["html","body","#document"].includes(mf(e))}function Xf(e){return pf(e).getComputedStyle(e)}function Sf(e){return Zf(e)?{scrollLeft:e.scrollLeft,scrollTop:e.scrollTop}:{scrollLeft:e.pageXOffset,scrollTop:e.pageYOffset}}function Yf(e){if("html"===mf(e))return e;const g=e.assignedSlot||e.parentNode||vf(e)&&e.host||Gf(e);return vf(g)?g.host:g}function Kf(e){const g=Yf(e);return Vf(g)?e.ownerDocument?e.ownerDocument.body:e.body:yf(g)&&Wf(g)?g:Kf(g)}function Hf(e,g,t){var I;void 0===g&&(g=[]),void 0===t&&(t=!0);const n=Kf(e),i=n===(null==(I=e.ownerDocument)?void 0:I.body),C=pf(n);return i?g.concat(C,C.visualViewport||[],Wf(n)?n:[],C.frameElement&&t?Hf(C.frameElement):[]):g.concat(n,Hf(n,[],t))}function Nf(e){const g=Xf(e);let t=parseFloat(g.width)||0,I=parseFloat(g.height)||0;const n=yf(e),i=n?e.offsetWidth:t,C=n?e.offsetHeight:I,o=EW(t)!==i||EW(I)!==C;return o&&(t=i,I=C),{width:t,height:I,$:o}}function Ff(e){return Zf(e)?e:e.contextElement}function xf(e){const g=Ff(e);if(!yf(g))return UW(1);const t=g.getBoundingClientRect(),{width:I,height:n,$:i}=Nf(g);let C=(i?EW(t.width):t.width)/I,o=(i?EW(t.height):t.height)/n;return C&&Number.isFinite(C)||(C=1),o&&Number.isFinite(o)||(o=1),{x:C,y:o}}const zf=UW(0);function kf(e){const g=pf(e);return Rf()&&g.visualViewport?{x:g.visualViewport.offsetLeft,y:g.visualViewport.offsetTop}:zf}function Mf(e,g,t,I){void 0===g&&(g=!1),void 0===t&&(t=!1);const n=e.getBoundingClientRect(),i=Ff(e);let C=UW(1);g&&(I?Zf(I)&&(C=xf(I)):C=xf(e));const o=function(e,g,t){return void 0===g&&(g=!1),!(!t||g&&t!==pf(e))&&g}(i,t,I)?kf(i):UW(0);let a=(n.left+o.x)/C.x,s=(n.top+o.y)/C.y,l=n.width/C.x,r=n.height/C.y;if(i){const e=pf(i),g=I&&Zf(I)?pf(I):I;let t=e.frameElement;for(;t&&I&&g!==e;){const e=xf(t),g=t.getBoundingClientRect(),I=Xf(t),n=g.left+(t.clientLeft+parseFloat(I.paddingLeft))*e.x,i=g.top+(t.clientTop+parseFloat(I.paddingTop))*e.y;a*=e.x,s*=e.y,l*=e.x,r*=e.y,a+=n,s+=i,t=pf(t).frameElement}}return Cf({width:l,height:r,x:a,y:s})}function Lf(e){return Mf(Gf(e)).left+Sf(e).scrollLeft}function Jf(e,g,t){let I;if("viewport"===g)I=function(e,g){const t=pf(e),I=Gf(e),n=t.visualViewport;let i=I.clientWidth,C=I.clientHeight,o=0,a=0;if(n){i=n.width,C=n.height;const e=Rf();(!e||e&&"fixed"===g)&&(o=n.offsetLeft,a=n.offsetTop)}return{width:i,height:C,x:o,y:a}}(e,t);else if("document"===g)I=function(e){const g=Gf(e),t=Sf(e),I=e.ownerDocument.body,n=JW(g.scrollWidth,g.clientWidth,I.scrollWidth,I.clientWidth),i=JW(g.scrollHeight,g.clientHeight,I.scrollHeight,I.clientHeight);let C=-t.scrollLeft+Lf(e);const o=-t.scrollTop;return"rtl"===Xf(I).direction&&(C+=JW(g.clientWidth,I.clientWidth)-n),{width:n,height:i,x:C,y:o}}(Gf(e));else if(Zf(g))I=function(e,g){const t=Mf(e,!0,"fixed"===g),I=t.top+e.clientTop,n=t.left+e.clientLeft,i=yf(e)?xf(e):UW(1);return{width:e.clientWidth*i.x,height:e.clientHeight*i.y,x:n*i.x,y:I*i.y}}(g,t);else{const t=kf(e);I={...g,x:g.x-t.x,y:g.y-t.y}}return Cf(I)}function Ef(e,g){const t=Yf(e);return!(t===g||!Zf(t)||Vf(t))&&("fixed"===Xf(t).position||Ef(t,g))}function Tf(e,g,t){const I=yf(g),n=Gf(g),i="fixed"===t,C=Mf(e,!0,i,g);let o={scrollLeft:0,scrollTop:0};const a=UW(0);if(I||!I&&!i)if(("body"!==mf(g)||Wf(n))&&(o=Sf(g)),I){const e=Mf(g,!0,i,g);a.x=e.x+g.clientLeft,a.y=e.y+g.clientTop}else n&&(a.x=Lf(n));return{x:C.left+o.scrollLeft-a.x,y:C.top+o.scrollTop-a.y,width:C.width,height:C.height}}function Uf(e,g){return yf(e)&&"fixed"!==Xf(e).position?g?g(e):e.offsetParent:null}function Qf(e,g){const t=pf(e);if(!yf(e))return t;let I=Uf(e,g);for(;I&&ff(I)&&"static"===Xf(I).position;)I=Uf(I,g);return I&&("html"===mf(I)||"body"===mf(I)&&"static"===Xf(I).position&&!wf(I))?t:I||function(e){let g=Yf(e);for(;yf(g)&&!Vf(g);){if(wf(g))return g;g=Yf(g)}return null}(e)||t}const Df={convertOffsetParentRelativeRectToViewportRelativeRect:function(e){let{rect:g,offsetParent:t,strategy:I}=e;const n=yf(t),i=Gf(t);if(t===i)return g;let C={scrollLeft:0,scrollTop:0},o=UW(1);const a=UW(0);if((n||!n&&"fixed"!==I)&&(("body"!==mf(t)||Wf(i))&&(C=Sf(t)),yf(t))){const e=Mf(t);o=xf(t),a.x=e.x+t.clientLeft,a.y=e.y+t.clientTop}return{width:g.width*o.x,height:g.height*o.y,x:g.x*o.x-C.scrollLeft*o.x+a.x,y:g.y*o.y-C.scrollTop*o.y+a.y}},getDocumentElement:Gf,getClippingRect:function(e){let{element:g,boundary:t,rootBoundary:I,strategy:n}=e;const i=[..."clippingAncestors"===t?function(e,g){const t=g.get(e);if(t)return t;let I=Hf(e,[],!1).filter((e=>Zf(e)&&"body"!==mf(e))),n=null;const i="fixed"===Xf(e).position;let C=i?Yf(e):e;for(;Zf(C)&&!Vf(C);){const g=Xf(C),t=wf(C);t||"fixed"!==g.position||(n=null),(i?!t&&!n:!t&&"static"===g.position&&n&&["absolute","fixed"].includes(n.position)||Wf(C)&&!t&&Ef(e,C))?I=I.filter((e=>e!==C)):n=g,C=Yf(C)}return g.set(e,I),I}(g,this._c):[].concat(t),I],C=i[0],o=i.reduce(((e,t)=>{const I=Jf(g,t,n);return e.top=JW(I.top,e.top),e.right=LW(I.right,e.right),e.bottom=LW(I.bottom,e.bottom),e.left=JW(I.left,e.left),e}),Jf(g,C,n));return{width:o.right-o.left,height:o.bottom-o.top,x:o.left,y:o.top}},getOffsetParent:Qf,getElementRects:async function(e){let{reference:g,floating:t,strategy:I}=e;const n=this.getOffsetParent||Qf,i=this.getDimensions;return{reference:Tf(g,await n(t),I),floating:{x:0,y:0,...await i(t)}}},getClientRects:function(e){return Array.from(e.getClientRects())},getDimensions:function(e){return Nf(e)},getScale:xf,isElement:Zf,isRTL:function(e){return"rtl"===Xf(e).direction}};const Of=(e,g,t)=>{const I=new Map,n={platform:Df,...t},i={...n.platform,_c:I};return(async(e,g,t)=>{const{placement:I="bottom",strategy:n="absolute",middleware:i=[],platform:C}=t,o=i.filter(Boolean),a=await(null==C.isRTL?void 0:C.isRTL(g));let s=await C.getElementRects({reference:e,floating:g,strategy:n}),{x:l,y:r}=of(s,I,a),A=I,c={},d=0;for(let t=0;t<o.length;t++){const{name:i,fn:u}=o[t],{x:h,y:b,data:m,reset:p}=await u({x:l,y:r,initialPlacement:I,placement:A,strategy:n,middlewareData:c,rects:s,platform:C,elements:{reference:e,floating:g}});l=null!=h?h:l,r=null!=b?b:r,c={...c,[i]:{...c[i],...m}},p&&d<=50&&(d++,"object"==typeof p&&(p.placement&&(A=p.placement),p.rects&&(s=!0===p.rects?await C.getElementRects({reference:e,floating:g,strategy:n}):p.rects),({x:l,y:r}=of(s,A,a))),t=-1)}return{x:l,y:r,placement:A,strategy:n,middlewareData:c}})(e,g,{...n,platform:i})},jf=e=>({name:"arrow",options:e,fn(g){const{element:t,padding:I}="function"==typeof e?e(g):e;return t&&(n=t,{}.hasOwnProperty.call(n,"current"))?null!=t.current?sf({element:t.current,padding:I}).fn(g):{}:t?sf({element:t,padding:I}).fn(g):{};var n}});var Pf="undefined"!=typeof document?g.useLayoutEffect:g.useEffect;function _f(e,g){if(e===g)return!0;if(typeof e!=typeof g)return!1;if("function"==typeof e&&e.toString()===g.toString())return!0;let t,I,n;if(e&&g&&"object"==typeof e){if(Array.isArray(e)){if(t=e.length,t!=g.length)return!1;for(I=t;0!=I--;)if(!_f(e[I],g[I]))return!1;return!0}if(n=Object.keys(e),t=n.length,t!==Object.keys(g).length)return!1;for(I=t;0!=I--;)if(!{}.hasOwnProperty.call(g,n[I]))return!1;for(I=t;0!=I--;){const t=n[I];if(!("_owner"===t&&e.$$typeof||_f(e[t],g[t])))return!1}return!0}return e!=e&&g!=g}function qf(e){return"undefined"==typeof window?1:(e.ownerDocument.defaultView||window).devicePixelRatio||1}function $f(e,g){const t=qf(e);return Math.round(g*t)/t}function ew(e){const t=g.useRef(e);return Pf((()=>{t.current=e})),t}const gw=(0,g.forwardRef)(((e,t)=>{const{children:I,width:n=10,height:i=5,...C}=e;return(0,g.createElement)(my.svg,qu({},C,{ref:t,width:n,height:i,viewBox:"0 0 30 10",preserveAspectRatio:"none"}),e.asChild?I:(0,g.createElement)("polygon",{points:"0,0 30,0 15,10"}))})),tw=gw,Iw="Popper",[nw,iw]=RW(Iw),[Cw,ow]=nw(Iw),aw=(0,g.forwardRef)(((e,t)=>{const{__scopePopper:I,virtualRef:n,...i}=e,C=ow("PopperAnchor",I),o=(0,g.useRef)(null),a=Ay(t,o);return(0,g.useEffect)((()=>{C.onAnchorChange((null==n?void 0:n.current)||o.current)})),n?null:(0,g.createElement)(my.div,qu({},i,{ref:a}))})),sw="PopperContent",[lw,rw]=nw(sw),Aw=(0,g.forwardRef)(((e,t)=>{var I,n,i,C,o,a,s,l;const{__scopePopper:r,side:A="bottom",sideOffset:c=0,align:d="center",alignOffset:u=0,arrowPadding:h=0,avoidCollisions:b=!0,collisionBoundary:m=[],collisionPadding:p=0,sticky:G="partial",hideWhenDetached:B=!1,updatePositionStrategy:Z="optimized",onPlaced:y,...v}=e,W=ow(sw,r),[f,w]=(0,g.useState)(null),R=Ay(t,(e=>w(e))),[V,X]=(0,g.useState)(null),S=function(e){const[t,I]=(0,g.useState)(void 0);return xW((()=>{if(e){I({width:e.offsetWidth,height:e.offsetHeight});const g=new ResizeObserver((g=>{if(!Array.isArray(g))return;if(!g.length)return;const t=g[0];let n,i;if("borderBoxSize"in t){const e=t.borderBoxSize,g=Array.isArray(e)?e[0]:e;n=g.inlineSize,i=g.blockSize}else n=e.offsetWidth,i=e.offsetHeight;I({width:n,height:i})}));return g.observe(e,{box:"border-box"}),()=>g.unobserve(e)}I(void 0)}),[e]),t}(V),Y=null!==(I=null==S?void 0:S.width)&&void 0!==I?I:0,K=null!==(n=null==S?void 0:S.height)&&void 0!==n?n:0,H=A+("center"!==d?"-"+d:""),N="number"==typeof p?p:{top:0,right:0,bottom:0,left:0,...p},F=Array.isArray(m)?m:[m],x=F.length>0,z={padding:N,boundary:F.filter(uw),altBoundary:x},{refs:k,floatingStyles:M,placement:L,isPositioned:J,middlewareData:E}=function(e){void 0===e&&(e={});const{placement:t="bottom",strategy:I="absolute",middleware:n=[],platform:i,elements:{reference:C,floating:o}={},transform:a=!0,whileElementsMounted:s,open:l}=e,[r,A]=g.useState({x:0,y:0,strategy:I,placement:t,middlewareData:{},isPositioned:!1}),[c,d]=g.useState(n);_f(c,n)||d(n);const[u,h]=g.useState(null),[b,m]=g.useState(null),p=g.useCallback((e=>{e!=y.current&&(y.current=e,h(e))}),[h]),G=g.useCallback((e=>{e!==v.current&&(v.current=e,m(e))}),[m]),B=C||u,Z=o||b,y=g.useRef(null),v=g.useRef(null),W=g.useRef(r),f=ew(s),w=ew(i),R=g.useCallback((()=>{if(!y.current||!v.current)return;const e={placement:t,strategy:I,middleware:c};w.current&&(e.platform=w.current),Of(y.current,v.current,e).then((e=>{const g={...e,isPositioned:!0};V.current&&!_f(W.current,g)&&(W.current=g,ly.flushSync((()=>{A(g)})))}))}),[c,t,I,w]);Pf((()=>{!1===l&&W.current.isPositioned&&(W.current.isPositioned=!1,A((e=>({...e,isPositioned:!1}))))}),[l]);const V=g.useRef(!1);Pf((()=>(V.current=!0,()=>{V.current=!1})),[]),Pf((()=>{if(B&&(y.current=B),Z&&(v.current=Z),B&&Z){if(f.current)return f.current(B,Z,R);R()}}),[B,Z,R,f]);const X=g.useMemo((()=>({reference:y,floating:v,setReference:p,setFloating:G})),[p,G]),S=g.useMemo((()=>({reference:B,floating:Z})),[B,Z]),Y=g.useMemo((()=>{const e={position:I,left:0,top:0};if(!S.floating)return e;const g=$f(S.floating,r.x),t=$f(S.floating,r.y);return a?{...e,transform:"translate("+g+"px, "+t+"px)",...qf(S.floating)>=1.5&&{willChange:"transform"}}:{position:I,left:g,top:t}}),[I,a,S.floating,r.x,r.y]);return g.useMemo((()=>({...r,update:R,refs:X,elements:S,floatingStyles:Y})),[r,R,X,S,Y])}({strategy:"fixed",placement:H,whileElementsMounted:(...e)=>function(e,g,t,I){void 0===I&&(I={});const{ancestorScroll:n=!0,ancestorResize:i=!0,elementResize:C="function"==typeof ResizeObserver,layoutShift:o="function"==typeof IntersectionObserver,animationFrame:a=!1}=I,s=Ff(e),l=n||i?[...s?Hf(s):[],...Hf(g)]:[];l.forEach((e=>{n&&e.addEventListener("scroll",t,{passive:!0}),i&&e.addEventListener("resize",t)}));const r=s&&o?function(e,g){let t,I=null;const n=Gf(e);function i(){clearTimeout(t),I&&I.disconnect(),I=null}return function C(o,a){void 0===o&&(o=!1),void 0===a&&(a=1),i();const{left:s,top:l,width:r,height:A}=e.getBoundingClientRect();if(o||g(),!r||!A)return;const c={rootMargin:-TW(l)+"px "+-TW(n.clientWidth-(s+r))+"px "+-TW(n.clientHeight-(l+A))+"px "+-TW(s)+"px",threshold:JW(0,LW(1,a))||1};let d=!0;function u(e){const g=e[0].intersectionRatio;if(g!==a){if(!d)return C();g?C(!1,g):t=setTimeout((()=>{C(!1,1e-7)}),100)}d=!1}try{I=new IntersectionObserver(u,{...c,root:n.ownerDocument})}catch(e){I=new IntersectionObserver(u,c)}I.observe(e)}(!0),i}(s,t):null;let A,c=-1,d=null;C&&(d=new ResizeObserver((e=>{let[I]=e;I&&I.target===s&&d&&(d.unobserve(g),cancelAnimationFrame(c),c=requestAnimationFrame((()=>{d&&d.observe(g)}))),t()})),s&&!a&&d.observe(s),d.observe(g));let u=a?Mf(e):null;return a&&function g(){const I=Mf(e);!u||I.x===u.x&&I.y===u.y&&I.width===u.width&&I.height===u.height||t(),u=I,A=requestAnimationFrame(g)}(),t(),()=>{l.forEach((e=>{n&&e.removeEventListener("scroll",t),i&&e.removeEventListener("resize",t)})),r&&r(),d&&d.disconnect(),d=null,a&&cancelAnimationFrame(A)}}(...e,{animationFrame:"always"===Z}),elements:{reference:W.anchor},middleware:[df({mainAxis:c+K,alignmentAxis:u}),b&&uf({mainAxis:!0,crossAxis:!1,limiter:"partial"===G?hf():void 0,...z}),b&&lf({...z}),bf({...z,apply:({elements:e,rects:g,availableWidth:t,availableHeight:I})=>{const{width:n,height:i}=g.reference,C=e.floating.style;C.setProperty("--radix-popper-available-width",`${t}px`),C.setProperty("--radix-popper-available-height",`${I}px`),C.setProperty("--radix-popper-anchor-width",`${n}px`),C.setProperty("--radix-popper-anchor-height",`${i}px`)}}),V&&jf({element:V,padding:h}),hw({arrowWidth:Y,arrowHeight:K}),B&&cf({strategy:"referenceHidden",...z})]}),[T,U]=bw(L),Q=XW(y);xW((()=>{J&&(null==Q||Q())}),[J,Q]);const D=null===(i=E.arrow)||void 0===i?void 0:i.x,O=null===(C=E.arrow)||void 0===C?void 0:C.y,j=0!==(null===(o=E.arrow)||void 0===o?void 0:o.centerOffset),[P,_]=(0,g.useState)();return xW((()=>{f&&_(window.getComputedStyle(f).zIndex)}),[f]),(0,g.createElement)("div",{ref:k.setFloating,"data-radix-popper-content-wrapper":"",style:{...M,transform:J?M.transform:"translate(0, -200%)",minWidth:"max-content",zIndex:P,"--radix-popper-transform-origin":[null===(a=E.transformOrigin)||void 0===a?void 0:a.x,null===(s=E.transformOrigin)||void 0===s?void 0:s.y].join(" ")},dir:e.dir},(0,g.createElement)(lw,{scope:r,placedSide:T,onArrowChange:X,arrowX:D,arrowY:O,shouldHideArrow:j},(0,g.createElement)(my.div,qu({"data-side":T,"data-align":U},v,{ref:R,style:{...v.style,animation:J?void 0:"none",opacity:null!==(l=E.hide)&&void 0!==l&&l.referenceHidden?0:void 0}}))))})),cw={top:"bottom",right:"left",bottom:"top",left:"right"},dw=(0,g.forwardRef)((function(e,t){const{__scopePopper:I,...n}=e,i=rw("PopperArrow",I),C=cw[i.placedSide];return(0,g.createElement)("span",{ref:i.onArrowChange,style:{position:"absolute",left:i.arrowX,top:i.arrowY,[C]:0,transformOrigin:{top:"",right:"0 0",bottom:"center 0",left:"100% 0"}[i.placedSide],transform:{top:"translateY(100%)",right:"translateY(50%) rotate(90deg) translateX(-50%)",bottom:"rotate(180deg)",left:"translateY(50%) rotate(-90deg) translateX(50%)"}[i.placedSide],visibility:i.shouldHideArrow?"hidden":void 0}},(0,g.createElement)(tw,qu({},n,{ref:t,style:{...n.style,display:"block"}})))}));function uw(e){return null!==e}const hw=e=>({name:"transformOrigin",options:e,fn(g){var t,I,n,i,C;const{placement:o,rects:a,middlewareData:s}=g,l=0!==(null===(t=s.arrow)||void 0===t?void 0:t.centerOffset),r=l?0:e.arrowWidth,A=l?0:e.arrowHeight,[c,d]=bw(o),u={start:"0%",center:"50%",end:"100%"}[d],h=(null!==(I=null===(n=s.arrow)||void 0===n?void 0:n.x)&&void 0!==I?I:0)+r/2,b=(null!==(i=null===(C=s.arrow)||void 0===C?void 0:C.y)&&void 0!==i?i:0)+A/2;let m="",p="";return"bottom"===c?(m=l?u:`${h}px`,p=-A+"px"):"top"===c?(m=l?u:`${h}px`,p=`${a.floating.height+A}px`):"right"===c?(m=-A+"px",p=l?u:`${b}px`):"left"===c&&(m=`${a.floating.width+A}px`,p=l?u:`${b}px`),{data:{x:m,y:p}}}});function bw(e){const[g,t="center"]=e.split("-");return[g,t]}const mw=e=>{const{__scopePopper:t,children:I}=e,[n,i]=(0,g.useState)(null);return(0,g.createElement)(Cw,{scope:t,anchor:n,onAnchorChange:i},I)},pw=aw,Gw=Aw,Bw=dw,Zw=e=>{const{present:t,children:I}=e,n=function(e){const[t,I]=(0,g.useState)(),n=(0,g.useRef)({}),i=(0,g.useRef)(e),C=(0,g.useRef)("none"),o=e?"mounted":"unmounted",[a,s]=function(e,t){return(0,g.useReducer)(((e,g)=>{const I=t[e][g];return null!=I?I:e}),e)}(o,{mounted:{UNMOUNT:"unmounted",ANIMATION_OUT:"unmountSuspended"},unmountSuspended:{MOUNT:"mounted",ANIMATION_END:"unmounted"},unmounted:{MOUNT:"mounted"}});return(0,g.useEffect)((()=>{const e=yw(n.current);C.current="mounted"===a?e:"none"}),[a]),xW((()=>{const g=n.current,t=i.current;if(t!==e){const I=C.current,n=yw(g);e?s("MOUNT"):"none"===n||"none"===(null==g?void 0:g.display)?s("UNMOUNT"):s(t&&I!==n?"ANIMATION_OUT":"UNMOUNT"),i.current=e}}),[e,s]),xW((()=>{if(t){const e=e=>{const g=yw(n.current).includes(e.animationName);e.target===t&&g&&(0,ly.flushSync)((()=>s("ANIMATION_END")))},g=e=>{e.target===t&&(C.current=yw(n.current))};return t.addEventListener("animationstart",g),t.addEventListener("animationcancel",e),t.addEventListener("animationend",e),()=>{t.removeEventListener("animationstart",g),t.removeEventListener("animationcancel",e),t.removeEventListener("animationend",e)}}s("ANIMATION_END")}),[t,s]),{isPresent:["mounted","unmountSuspended"].includes(a),ref:(0,g.useCallback)((e=>{e&&(n.current=getComputedStyle(e)),I(e)}),[])}}(t),i="function"==typeof I?I({present:n.isPresent}):g.Children.only(I),C=Ay(n.ref,i.ref);return"function"==typeof I||n.isPresent?(0,g.cloneElement)(i,{ref:C}):null};function yw(e){return(null==e?void 0:e.animationName)||"none"}Zw.displayName="Presence";const vw=(0,g.forwardRef)(((e,t)=>(0,g.createElement)(my.span,qu({},e,{ref:t,style:{position:"absolute",border:0,width:1,height:1,padding:0,margin:-1,overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",wordWrap:"normal",...e.style}})))),Ww=vw,[fw,ww]=RW("Tooltip",[iw]),Rw=iw(),Vw="tooltip.open",[Xw,Sw]=fw("TooltipProvider"),Yw="Tooltip",[Kw,Hw]=fw(Yw),Nw="TooltipTrigger",Fw=(0,g.forwardRef)(((e,t)=>{const{__scopeTooltip:I,...n}=e,i=Hw(Nw,I),C=Sw(Nw,I),o=Rw(I),a=Ay(t,(0,g.useRef)(null),i.onTriggerChange),s=(0,g.useRef)(!1),l=(0,g.useRef)(!1),r=(0,g.useCallback)((()=>s.current=!1),[]);return(0,g.useEffect)((()=>()=>document.removeEventListener("pointerup",r)),[r]),(0,g.createElement)(pw,qu({asChild:!0},o),(0,g.createElement)(my.button,qu({"aria-describedby":i.open?i.contentId:void 0,"data-state":i.stateAttribute},n,{ref:a,onPointerMove:wW(e.onPointerMove,(e=>{"touch"!==e.pointerType&&(l.current||C.isPointerInTransitRef.current||(i.onTriggerEnter(),l.current=!0))})),onPointerLeave:wW(e.onPointerLeave,(()=>{i.onTriggerLeave(),l.current=!1})),onPointerDown:wW(e.onPointerDown,(()=>{s.current=!0,document.addEventListener("pointerup",r,{once:!0})})),onFocus:wW(e.onFocus,(()=>{s.current||i.onOpen()})),onBlur:wW(e.onBlur,i.onClose),onClick:wW(e.onClick,i.onClose)})))})),[xw,zw]=fw("TooltipPortal",{forceMount:void 0}),kw="TooltipContent",Mw=(0,g.forwardRef)(((e,t)=>{const I=zw(kw,e.__scopeTooltip),{forceMount:n=I.forceMount,side:i="top",...C}=e,o=Hw(kw,e.__scopeTooltip);return(0,g.createElement)(Zw,{present:n||o.open},o.disableHoverableContent?(0,g.createElement)(Tw,qu({side:i},C,{ref:t})):(0,g.createElement)(Lw,qu({side:i},C,{ref:t})))})),Lw=(0,g.forwardRef)(((e,t)=>{const I=Hw(kw,e.__scopeTooltip),n=Sw(kw,e.__scopeTooltip),i=(0,g.useRef)(null),C=Ay(t,i),[o,a]=(0,g.useState)(null),{trigger:s,onClose:l}=I,r=i.current,{onPointerInTransitChange:A}=n,c=(0,g.useCallback)((()=>{a(null),A(!1)}),[A]),d=(0,g.useCallback)(((e,g)=>{const t=e.currentTarget,I={x:e.clientX,y:e.clientY},n=function(e,g,t=5){const I=[];switch(g){case"top":I.push({x:e.x-t,y:e.y+t},{x:e.x+t,y:e.y+t});break;case"bottom":I.push({x:e.x-t,y:e.y-t},{x:e.x+t,y:e.y-t});break;case"left":I.push({x:e.x+t,y:e.y-t},{x:e.x+t,y:e.y+t});break;case"right":I.push({x:e.x-t,y:e.y-t},{x:e.x-t,y:e.y+t})}return I}(I,function(e,g){const t=Math.abs(g.top-e.y),I=Math.abs(g.bottom-e.y),n=Math.abs(g.right-e.x),i=Math.abs(g.left-e.x);switch(Math.min(t,I,n,i)){case i:return"left";case n:return"right";case t:return"top";case I:return"bottom";default:throw new Error("unreachable")}}(I,t.getBoundingClientRect())),i=function(e){const g=e.slice();return g.sort(((e,g)=>e.x<g.x?-1:e.x>g.x?1:e.y<g.y?-1:e.y>g.y?1:0)),function(e){if(e.length<=1)return e.slice();const g=[];for(let t=0;t<e.length;t++){const I=e[t];for(;g.length>=2;){const e=g[g.length-1],t=g[g.length-2];if(!((e.x-t.x)*(I.y-t.y)>=(e.y-t.y)*(I.x-t.x)))break;g.pop()}g.push(I)}g.pop();const t=[];for(let g=e.length-1;g>=0;g--){const I=e[g];for(;t.length>=2;){const e=t[t.length-1],g=t[t.length-2];if(!((e.x-g.x)*(I.y-g.y)>=(e.y-g.y)*(I.x-g.x)))break;t.pop()}t.push(I)}return t.pop(),1===g.length&&1===t.length&&g[0].x===t[0].x&&g[0].y===t[0].y?g:g.concat(t)}(g)}([...n,...function(e){const{top:g,right:t,bottom:I,left:n}=e;return[{x:n,y:g},{x:t,y:g},{x:t,y:I},{x:n,y:I}]}(g.getBoundingClientRect())]);a(i),A(!0)}),[A]);return(0,g.useEffect)((()=>()=>c()),[c]),(0,g.useEffect)((()=>{if(s&&r){const e=e=>d(e,r),g=e=>d(e,s);return s.addEventListener("pointerleave",e),r.addEventListener("pointerleave",g),()=>{s.removeEventListener("pointerleave",e),r.removeEventListener("pointerleave",g)}}}),[s,r,d,c]),(0,g.useEffect)((()=>{if(o){const e=e=>{const g=e.target,t={x:e.clientX,y:e.clientY},I=(null==s?void 0:s.contains(g))||(null==r?void 0:r.contains(g)),n=!function(e,g){const{x:t,y:I}=e;let n=!1;for(let e=0,i=g.length-1;e<g.length;i=e++){const C=g[e].x,o=g[e].y,a=g[i].x,s=g[i].y;o>I!=s>I&&t<(a-C)*(I-o)/(s-o)+C&&(n=!n)}return n}(t,o);I?c():n&&(c(),l())};return document.addEventListener("pointermove",e),()=>document.removeEventListener("pointermove",e)}}),[s,r,o,l,c]),(0,g.createElement)(Tw,qu({},e,{ref:C}))})),[Jw,Ew]=fw(Yw,{isInside:!1}),Tw=(0,g.forwardRef)(((e,t)=>{const{__scopeTooltip:I,children:n,"aria-label":i,onEscapeKeyDown:C,onPointerDownOutside:o,...a}=e,s=Hw(kw,I),l=Rw(I),{onClose:r}=s;return(0,g.useEffect)((()=>(document.addEventListener(Vw,r),()=>document.removeEventListener(Vw,r))),[r]),(0,g.useEffect)((()=>{if(s.trigger){const e=e=>{const g=e.target;null!=g&&g.contains(s.trigger)&&r()};return window.addEventListener("scroll",e,{capture:!0}),()=>window.removeEventListener("scroll",e,{capture:!0})}}),[s.trigger,r]),(0,g.createElement)(HW,{asChild:!0,disableOutsidePointerEvents:!1,onEscapeKeyDown:C,onPointerDownOutside:o,onFocusOutside:e=>e.preventDefault(),onDismiss:r},(0,g.createElement)(Gw,qu({"data-state":s.stateAttribute},l,a,{ref:t,style:{...a.style,"--radix-tooltip-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-tooltip-content-available-width":"var(--radix-popper-available-width)","--radix-tooltip-content-available-height":"var(--radix-popper-available-height)","--radix-tooltip-trigger-width":"var(--radix-popper-anchor-width)","--radix-tooltip-trigger-height":"var(--radix-popper-anchor-height)"}}),(0,g.createElement)(uy,null,n),(0,g.createElement)(Jw,{scope:I,isInside:!0},(0,g.createElement)(Ww,{id:s.contentId,role:"tooltip"},i||n))))})),Uw=(0,g.forwardRef)(((e,t)=>{const{__scopeTooltip:I,...n}=e,i=Rw(I);return Ew("TooltipArrow",I).isInside?null:(0,g.createElement)(Bw,qu({},i,n,{ref:t}))})),Qw=e=>{const{__scopeTooltip:t,children:I,open:n,defaultOpen:i=!1,onOpenChange:C,disableHoverableContent:o,delayDuration:a}=e,s=Sw(Yw,e.__scopeTooltip),l=Rw(t),[r,A]=(0,g.useState)(null),c=function(e){const[t,I]=g.useState(zW());return xW((()=>{I((e=>null!=e?e:String(kW++)))}),[e]),t?`radix-${t}`:""}(),d=(0,g.useRef)(0),u=null!=o?o:s.disableHoverableContent,h=null!=a?a:s.delayDuration,b=(0,g.useRef)(!1),[m=!1,p]=function({prop:e,defaultProp:t,onChange:I=(()=>{})}){const[n,i]=function({defaultProp:e,onChange:t}){const I=(0,g.useState)(e),[n]=I,i=(0,g.useRef)(n),C=XW(t);return(0,g.useEffect)((()=>{i.current!==n&&(C(n),i.current=n)}),[n,i,C]),I}({defaultProp:t,onChange:I}),C=void 0!==e,o=C?e:n,a=XW(I);return[o,(0,g.useCallback)((g=>{if(C){const t="function"==typeof g?g(e):g;t!==e&&a(t)}else i(g)}),[C,e,i,a])]}({prop:n,defaultProp:i,onChange:e=>{e?(s.onOpen(),document.dispatchEvent(new CustomEvent(Vw))):s.onClose(),null==C||C(e)}}),G=(0,g.useMemo)((()=>m?b.current?"delayed-open":"instant-open":"closed"),[m]),B=(0,g.useCallback)((()=>{window.clearTimeout(d.current),b.current=!1,p(!0)}),[p]),Z=(0,g.useCallback)((()=>{window.clearTimeout(d.current),p(!1)}),[p]),y=(0,g.useCallback)((()=>{window.clearTimeout(d.current),d.current=window.setTimeout((()=>{b.current=!0,p(!0)}),h)}),[h,p]);return(0,g.useEffect)((()=>()=>window.clearTimeout(d.current)),[]),(0,g.createElement)(mw,l,(0,g.createElement)(Kw,{scope:t,contentId:c,open:m,stateAttribute:G,trigger:r,onTriggerChange:A,onTriggerEnter:(0,g.useCallback)((()=>{s.isOpenDelayed?y():B()}),[s.isOpenDelayed,y,B]),onTriggerLeave:(0,g.useCallback)((()=>{u?Z():window.clearTimeout(d.current)}),[Z,u]),onOpen:B,onClose:Z,disableHoverableContent:u},I))},Dw=Fw,Ow=Mw,jw=Uw;function Pw(e,g){if(null==e)return{};var t,I,n=function(e,g){if(null==e)return{};var t,I,n={},i=Object.keys(e);for(I=0;I<i.length;I++)t=i[I],g.indexOf(t)>=0||(n[t]=e[t]);return n}(e,g);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(I=0;I<i.length;I++)t=i[I],g.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(n[t]=e[t])}return n}let _w;!function(e){e[e.UNSUPPORTED_INPUT=0]="UNSUPPORTED_INPUT",e[e.NO_COMPONENT_FOR_TYPE=1]="NO_COMPONENT_FOR_TYPE",e[e.UNKNOWN_INPUT=2]="UNKNOWN_INPUT",e[e.DUPLICATE_KEYS=3]="DUPLICATE_KEYS",e[e.ALREADY_REGISTERED_TYPE=4]="ALREADY_REGISTERED_TYPE",e[e.CLIPBOARD_ERROR=5]="CLIPBOARD_ERROR",e[e.THEME_ERROR=6]="THEME_ERROR",e[e.PATH_DOESNT_EXIST=7]="PATH_DOESNT_EXIST",e[e.INPUT_TYPE_OVERRIDE=8]="INPUT_TYPE_OVERRIDE",e[e.EMPTY_KEY=9]="EMPTY_KEY"}(_w||(_w={}));const qw={[_w.UNSUPPORTED_INPUT]:(e,g)=>[`An input with type \`${e}\` input was found at path \`${g}\` but it's not supported yet.`],[_w.NO_COMPONENT_FOR_TYPE]:(e,g)=>[`Type \`${e}\` found at path \`${g}\` can't be displayed in panel because no component supports it yet.`],[_w.UNKNOWN_INPUT]:(e,g)=>[`input at path \`${e}\` is not recognized.`,g],[_w.DUPLICATE_KEYS]:(e,g,t)=>[`Key \`${e}\` of path \`${g}\` already exists at path \`${t}\`. Even nested keys need to be unique. Rename one of the keys.`],[_w.ALREADY_REGISTERED_TYPE]:e=>[`Type ${e} has already been registered. You can't register a component with the same type.`],[_w.CLIPBOARD_ERROR]:e=>["Error copying the value",e],[_w.THEME_ERROR]:(e,g)=>[`Error accessing the theme \`${e}.${g}\` value.`],[_w.PATH_DOESNT_EXIST]:e=>[`Error getting the value at path \`${e}\`. There is probably an error in your \`render\` function.`],[_w.PATH_DOESNT_EXIST]:e=>[`Error accessing the value at path \`${e}\``],[_w.INPUT_TYPE_OVERRIDE]:(e,g,t)=>[`Input at path \`${e}\` already exists with type: \`${g}\`. Its type cannot be overridden with type \`${t}\`.`],[_w.EMPTY_KEY]:()=>["Keys can not be empty, if you want to hide a label use whitespace."]};function $w(e,g,...t){const[I,...n]=qw[g](...t);console[e]("LEVA: "+I,...n)}const eR=$w.bind(null,"warn"),gR=$w.bind(null,"log"),tR=["value"],IR=["schema"],nR=["value"],iR=[],CR={};function oR(e){let{value:g}=e,t=Pw(e,tR);for(let e of iR){const I=e(g,t);if(I)return I}}function aR(e,g){let{schema:t}=g,I=Pw(g,IR);e in CR?eR(_w.ALREADY_REGISTERED_TYPE,e):(iR.push(((g,I)=>t(g,I)&&e)),CR[e]=I)}function sR(e,g,t,I){const{normalize:n}=CR[e];if(n)return n(g,t,I);if("object"!=typeof g||!("value"in g))return{value:g};const{value:i}=g;return{value:i,settings:Pw(g,nR)}}function lR(e,g,t){const{format:I}=CR[e];return I?I(g,t):g}function rR(e,g,t){return g in e?Object.defineProperty(e,g,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[g]=t,e}function AR(e,g){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var I=Object.getOwnPropertySymbols(e);g&&(I=I.filter((function(g){return Object.getOwnPropertyDescriptor(e,g).enumerable}))),t.push.apply(t,I)}return t}function cR(e){for(var g=1;g<arguments.length;g++){var t=null!=arguments[g]?arguments[g]:{};g%2?AR(Object(t),!0).forEach((function(g){rR(e,g,t[g])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):AR(Object(t)).forEach((function(g){Object.defineProperty(e,g,Object.getOwnPropertyDescriptor(t,g))}))}return e}const dR=(e,g,t)=>e>t?t:e<g?g:e,uR=e=>{if(""===e||"number"==typeof e)return e;try{const g=fR(e);if(!isNaN(g))return g}catch(e){}return parseFloat(e)},hR=Math.log(10);function bR(e){let g=Math.abs(+String(e).replace(".",""));if(0===g)return.01;for(;0!==g&&g%10==0;)g/=10;const t=Math.floor(Math.log(g)/hR)+1,I=Math.floor(Math.log10(Math.abs(e))),n=Math.pow(10,I-t);return Math.max(n,.001)}const mR=(e,g,t)=>t===g?0:(dR(e,g,t)-g)/(t-g),pR=(e,g,t)=>e*(t-g)+g,GR=/\(([0-9+\-*/^ .]+)\)/,BR=/(\d+(?:\.\d+)?) ?\^ ?(\d+(?:\.\d+)?)/,ZR=/(\d+(?:\.\d+)?) ?\* ?(\d+(?:\.\d+)?)/,yR=/(\d+(?:\.\d+)?) ?\/ ?(\d+(?:\.\d+)?)/,vR=/(\d+(?:\.\d+)?) ?\+ ?(\d+(?:\.\d+)?)/,WR=/(\d+(?:\.\d+)?) ?- ?(\d+(?:\.\d+)?)/;function fR(e){if(isNaN(Number(e))){if(GR.test(e)){const g=e.replace(GR,((e,g)=>String(fR(g))));return fR(g)}if(BR.test(e))return fR(e.replace(BR,((e,g,t)=>String(Math.pow(Number(g),Number(t))))));if(ZR.test(e)){const g=e.replace(ZR,((e,g,t)=>String(Number(g)*Number(t))));return fR(g)}if(yR.test(e)){const g=e.replace(yR,((e,g,t)=>{if(0!=t)return String(Number(g)/Number(t));throw new Error("Division by zero")}));return fR(g)}if(vR.test(e)){const g=e.replace(vR,((e,g,t)=>String(Number(g)+Number(t))));return fR(g)}if(WR.test(e)){const g=e.replace(WR,((e,g,t)=>String(Number(g)-Number(t))));return fR(g)}return Number(e)}return Number(e)}function wR(e){return"[object Object]"===Object.prototype.toString.call(e)}const RR=e=>wR(e)&&0===Object.keys(e).length;let VR,XR;var SR;(SR=VR||(VR={})).BUTTON="BUTTON",SR.BUTTON_GROUP="BUTTON_GROUP",SR.MONITOR="MONITOR",SR.FOLDER="FOLDER",function(e){e.SELECT="SELECT",e.IMAGE="IMAGE",e.NUMBER="NUMBER",e.COLOR="COLOR",e.STRING="STRING",e.BOOLEAN="BOOLEAN",e.INTERVAL="INTERVAL",e.VECTOR3D="VECTOR3D",e.VECTOR2D="VECTOR2D"}(XR||(XR={}));const YR=["type","__customInput"],KR=["render","label","optional","order","disabled","hint","onChange","onEditStart","onEditEnd","transient"],HR=["type"];function NR(e,g,t={},I){var n,i;if("object"!=typeof e||Array.isArray(e))return{type:I,input:e,options:cR({key:g,label:g,optional:!1,disabled:!1,order:0},t)};if("__customInput"in e){const{type:t,__customInput:I}=e;return NR(I,g,Pw(e,YR),t)}const{render:C,label:o,optional:a,order:s=0,disabled:l,hint:r,onChange:A,onEditStart:c,onEditEnd:d,transient:u}=e,h=Pw(e,KR),b=cR({render:C,key:g,label:null!=o?o:g,hint:r,transient:null!=u?u:!!A,onEditStart:c,onEditEnd:d,disabled:l,optional:a,order:s},t);let m,{type:p}=h,G=Pw(h,HR);return p=null!=I?I:p,p in VR?{type:p,input:G,options:b}:(m=I&&wR(G)&&"value"in G?G.value:RR(G)?void 0:G,{type:p,input:m,options:cR(cR({},b),{},{onChange:A,optional:null!==(n=b.optional)&&void 0!==n&&n,disabled:null!==(i=b.disabled)&&void 0!==i&&i})})}function FR(e,g,t,I){const n=NR(e,g),{type:i,input:C,options:o}=n;if(i)return i in VR?n:{type:i,input:sR(i,C,t,I),options:o};let a=oR(C);return a?{type:a,input:sR(a,C,t,I),options:o}:(a=oR({value:C}),!!a&&{type:a,input:sR(a,{value:C},t,I),options:o})}function xR(e,g,t,I,n){const{value:i,type:C,settings:o}=e;e.value=kR({type:C,value:i,settings:o},g,t,I),e.fromPanel=n}const zR=function(e,g,t){this.type="LEVA_ERROR",this.message="LEVA: "+e,this.previousValue=g,this.error=t};function kR({type:e,value:g,settings:t},I,n,i){const C="SELECT"!==e&&"function"==typeof I?I(g):I;let o;try{o=function(e,g,t,I,n,i){const{sanitize:C}=CR[e];return C?C(g,t,I,n,i):g}(e,C,t,g,n,i)}catch(e){throw new zR(`The value \`${I}\` did not result in a correct value.`,g,e)}return Zy(o,g)?g:o}const MR=(e,g,t=!1)=>{let I=0;return function(){const n=arguments,i=t&&!I,C=()=>e.apply(this,n);window.clearTimeout(I),I=window.setTimeout(C,g),i&&C()}},LR=e=>e.shiftKey?5:e.altKey?.2:1,JR=["value"],ER=["min","max"],TR=(e,{min:g=-1/0,max:t=1/0,suffix:I})=>{const n=parseFloat(e);if(""===e||isNaN(n))throw Error("Invalid number");const i=dR(n,g,t);return I?i+I:i},UR=e=>{let{value:g}=e,t=Pw(e,JR);const{min:I=-1/0,max:n=1/0}=t,i=Pw(t,ER);let C=parseFloat(g);const o="string"==typeof g?g.substring((""+C).length):void 0;C=dR(C,I,n);let a=t.step;a||(Number.isFinite(I)?a=Number.isFinite(n)?+(Math.abs(n-I)/100).toPrecision(1):+(Math.abs(C-I)/100).toPrecision(1):Number.isFinite(n)&&(a=+(Math.abs(n-C)/100).toPrecision(1)));const s=a?10*bR(a):bR(C);return a=a||s/10,{value:o?C+o:C,settings:cR({initialValue:C,step:a,pad:Math.round(dR(Math.log10(1/s),0,2)),min:I,max:n,suffix:o},i)}},QR=(e,{step:g,initialValue:t})=>t+Math.round((e-t)/g)*g;var DR=Object.freeze({__proto__:null,schema:e=>{if("number"==typeof e)return!0;if("string"==typeof e){const g=parseFloat(e);return!isNaN(g)&&e.substring((""+g).length).trim().length<4}return!1},sanitize:TR,format:(e,{pad:g=0,suffix:t})=>{const I=parseFloat(e).toFixed(g);return t?I+t:I},normalize:UR,sanitizeStep:QR});function OR(){return OR=Object.assign?Object.assign.bind():function(e){for(var g=1;g<arguments.length;g++){var t=arguments[g];for(var I in t)Object.prototype.hasOwnProperty.call(t,I)&&(e[I]=t[I])}return e},OR.apply(this,arguments)}const jR=(0,g.createContext)({});function PR(){return(0,g.useContext)(jR)}const _R=(0,g.createContext)(null),qR=(0,g.createContext)(null),$R=(0,g.createContext)(null);function eV(){return(0,g.useContext)(qR)}function gV(e,g){const[t,I]=e.split(" "),n={};return"none"!==t&&(n.boxShadow=`${g.inset?"inset ":""}0 0 0 $borderWidths${[g.key]} $colors${"default"!==t&&t||g.borderColor}`),I&&(n.backgroundColor=I),n}const tV={$inputStyle:()=>e=>gV(e,{key:"$input",borderColor:"$highlight1",inset:!0}),$focusStyle:()=>e=>gV(e,{key:"$focus",borderColor:"$accent2"}),$hoverStyle:()=>e=>gV(e,{key:"$hover",borderColor:"$accent1",inset:!0}),$activeStyle:()=>e=>gV(e,{key:"$active",borderColor:"$accent1",inset:!0})},{styled:IV,css:nV,createTheme:iV,globalCss:CV,keyframes:oV}=(e=>{const t=(e=>{let g=!1;const t=Fv(e,(e=>{g=!0;const t="prefix"in(e="object"==typeof e&&e||{})?String(e.prefix):"",I="object"==typeof e.media&&e.media||{},n="object"==typeof e.root?e.root||null:globalThis.document||null,i="object"==typeof e.theme&&e.theme||{},C={prefix:t,media:I,theme:i,themeMap:"object"==typeof e.themeMap&&e.themeMap||{...Dy},utils:"object"==typeof e.utils&&e.utils||{}},o=pv(n),a={css:yv(C,o),globalCss:Xv(C,o),keyframes:Yv(C,o),createTheme:Nv(C,o),reset(){o.reset(),a.theme.toString()},theme:{},sheet:o,config:C,prefix:t,getCssText:o.toString,toString:o.toString};return String(a.theme=a.createTheme(i)),a}));return g||t.reset(),t})(e);return t.styled=(({config:e,sheet:t})=>xv(e,(()=>{const I=yv(e,t);return(...e)=>{const t=I(...e),n=t[Py].type,i=g.forwardRef(((e,I)=>{const i=e&&e.as||n,{props:C,deferredInjector:o}=t(e);return delete C.as,C.ref=I,o?g.createElement(g.Fragment,null,g.createElement(i,C),g.createElement(o,null)):g.createElement(i,C)}));return i.className=t.className,i.displayName=`Styled.${n.displayName||n.name||n}`,i.selector=t.selector,i.toString=()=>t.selector,i[Py]=t[Py],i}})))(t),t})({prefix:"leva",theme:{colors:{elevation1:"#292d39",elevation2:"#181c20",elevation3:"#373c4b",accent1:"#0066dc",accent2:"#007bff",accent3:"#3c93ff",highlight1:"#535760",highlight2:"#8c92a4",highlight3:"#fefefe",vivid1:"#ffcc00",folderWidgetColor:"$highlight2",folderTextColor:"$highlight3",toolTipBackground:"$highlight3",toolTipText:"$elevation2"},radii:{xs:"2px",sm:"3px",lg:"10px"},space:{xs:"3px",sm:"6px",md:"10px",rowGap:"7px",colGap:"7px"},fonts:{mono:"ui-monospace, SFMono-Regular, Menlo, 'Roboto Mono', monospace",sans:"system-ui, sans-serif"},fontSizes:{root:"11px",toolTip:"$root"},sizes:{rootWidth:"280px",controlWidth:"160px",numberInputMinWidth:"38px",scrubberWidth:"8px",scrubberHeight:"16px",rowHeight:"24px",folderTitleHeight:"20px",checkboxSize:"16px",joystickWidth:"100px",joystickHeight:"100px",colorPickerWidth:"$controlWidth",colorPickerHeight:"100px",imagePreviewWidth:"$controlWidth",imagePreviewHeight:"100px",monitorHeight:"60px",titleBarHeight:"39px"},shadows:{level1:"0 0 9px 0 #00000088",level2:"0 4px 14px #00000033"},borderWidths:{root:"0px",input:"1px",focus:"1px",hover:"1px",active:"1px",folder:"1px"},fontWeights:{label:"normal",folder:"normal",button:"normal"}},utils:cR(cR({},tV),{},{$flex:()=>({display:"flex",alignItems:"center"}),$flexCenter:()=>({display:"flex",alignItems:"center",justifyContent:"center"}),$reset:()=>({outline:"none",fontSize:"inherit",fontWeight:"inherit",color:"inherit",fontFamily:"inherit",border:"none",backgroundColor:"transparent",appearance:"none"}),$draggable:()=>({touchAction:"none",WebkitUserDrag:"none",userSelect:"none"}),$focus:e=>({"&:focus":tV.$focusStyle()(e)}),$focusWithin:e=>({"&:focus-within":tV.$focusStyle()(e)}),$hover:e=>({"&:hover":tV.$hoverStyle()(e)}),$active:e=>({"&:active":tV.$activeStyle()(e)})})}),aV=CV({".leva__panel__dragged":{WebkitUserDrag:"none",userSelect:"none",input:{userSelect:"none"},"*":{cursor:"ew-resize !important"}}});function sV(e,t){const{theme:I}=(0,g.useContext)(_R);if(!(e in I)||!(t in I[e]))return eR(_w.THEME_ERROR,e,t),"";let n=t;for(;;){let g=I[e][n];if("string"!=typeof g||"$"!==g.charAt(0))return g;n=g.substr(1)}}const lV=IV("input",{$reset:"",padding:"0 $sm",width:0,minWidth:0,flex:1,height:"100%",variants:{levaType:{number:{textAlign:"right"}},as:{textarea:{padding:"$sm"}}}}),rV=IV("div",{$draggable:"",height:"100%",$flexCenter:"",position:"relative",padding:"0 $xs",fontSize:"0.8em",opacity:.8,cursor:"default",touchAction:"none",[`& + ${lV}`]:{paddingLeft:0}}),AV=IV(rV,{cursor:"ew-resize",marginRight:"-$xs",textTransform:"uppercase",opacity:.3,"&:hover":{opacity:1},variants:{dragging:{true:{backgroundColor:"$accent2",opacity:1}}}}),cV=IV("div",{$flex:"",position:"relative",borderRadius:"$sm",overflow:"hidden",color:"inherit",height:"$rowHeight",backgroundColor:"$elevation3",$inputStyle:"$elevation1",$hover:"",$focusWithin:"",variants:{textArea:{true:{height:"auto"}}}}),dV=["innerLabel","value","onUpdate","onChange","onKeyDown","type","id","inputType","rows"],uV=["onUpdate"];function hV(e){let{innerLabel:t,value:I,onUpdate:n,onChange:i,onKeyDown:C,type:o,id:a,inputType:s="text",rows:l=0}=e,r=Pw(e,dV);const{id:A,emitOnEditStart:c,emitOnEditEnd:d,disabled:u}=PR(),h=a||A,b=(0,g.useRef)(null),m=l>0,p=m?"textarea":"input",G=(0,g.useCallback)((e=>g=>{const t=g.currentTarget.value;e(t)}),[]);g.useEffect((()=>{const e=b.current,g=G((e=>{n(e),d()}));return null==e||e.addEventListener("blur",g),()=>null==e?void 0:e.removeEventListener("blur",g)}),[G,n,d]);const B=(0,g.useCallback)((e=>{"Enter"===e.key&&G(n)(e)}),[G,n]),Z=Object.assign({as:p},m?{rows:l}:{},r);return g.createElement(cV,{textArea:m},t&&"string"==typeof t?g.createElement(rV,null,t):t,g.createElement(lV,OR({levaType:o,ref:b,id:h,type:s,autoComplete:"off",spellCheck:"false",value:I,onChange:G(i),onFocus:()=>c(),onKeyPress:B,onKeyDown:C,disabled:u},Z)))}function bV(e){let{onUpdate:t}=e,I=Pw(e,uV);const n=(0,g.useCallback)((e=>t(uR(e))),[t]),i=(0,g.useCallback)((e=>{const g="ArrowUp"===e.key?1:"ArrowDown"===e.key?-1:0;if(g){e.preventDefault();const I=e.altKey?.1:e.shiftKey?10:1;t((e=>parseFloat(e)+g*I))}}),[t]);return g.createElement(hV,OR({},I,{onUpdate:n,onKeyDown:i,type:"number"}))}const mV=IV("div",{}),pV=IV("div",{position:"relative",background:"$elevation2",transition:"height 300ms ease",variants:{fill:{true:{},false:{}},flat:{false:{},true:{}},isRoot:{true:{},false:{paddingLeft:"$md","&::after":{content:'""',position:"absolute",left:0,top:0,width:"$borderWidths$folder",height:"100%",backgroundColor:"$folderWidgetColor",opacity:.4,transform:"translateX(-50%)"}}}},compoundVariants:[{isRoot:!0,fill:!1,css:{overflowY:"auto",maxHeight:"calc(100vh - 20px - $$titleBarHeight)"}},{isRoot:!0,flat:!1,css:{borderRadius:"$lg"}}]}),GV=IV("div",{$flex:"",color:"$folderTextColor",userSelect:"none",cursor:"pointer",height:"$folderTitleHeight",fontWeight:"$folder","> svg":{marginLeft:-4,marginRight:4,cursor:"pointer",fill:"$folderWidgetColor",opacity:.6},"&:hover > svg":{fill:"$folderWidgetColor"},[`&:hover + ${pV}::after`]:{opacity:.6},[`${mV}:hover > & + ${pV}::after`]:{opacity:.6},[`${mV}:hover > & > svg`]:{opacity:1}}),BV=IV("div",{position:"relative",display:"grid",gridTemplateColumns:"100%",rowGap:"$rowGap",transition:"opacity 250ms ease",variants:{toggled:{true:{opacity:1,transitionDelay:"250ms"},false:{opacity:0,transitionDelay:"0ms",pointerEvents:"none"}},isRoot:{true:{"& > div":{paddingLeft:"$md",paddingRight:"$md"},"& > div:first-of-type":{paddingTop:"$sm"},"& > div:last-of-type":{paddingBottom:"$sm"},[`> ${mV}:not(:first-of-type)`]:{paddingTop:"$sm",marginTop:"$md",borderTop:"$borderWidths$folder solid $colors$elevation1"}}}}}),ZV=IV("div",{position:"relative",zIndex:100,display:"grid",rowGap:"$rowGap",gridTemplateRows:"minmax($sizes$rowHeight, max-content)",alignItems:"center",color:"$highlight2",[`${BV} > &`]:{"&:first-of-type":{marginTop:"$rowGap"},"&:last-of-type":{marginBottom:"$rowGap"}},variants:{disabled:{true:{pointerEvents:"none"},false:{"&:hover,&:focus-within":{color:"$highlight3"}}}}}),yV=IV(ZV,{gridTemplateColumns:"auto $sizes$controlWidth",columnGap:"$colGap"}),vV=IV("div",{$flex:"",height:"100%",position:"relative",overflow:"hidden","& > div":{marginLeft:"$colGap",padding:"0 $xs",opacity:.4},"& > div:hover":{opacity:.8},"& > div > svg":{display:"none",cursor:"pointer",width:13,minWidth:13,height:13,backgroundColor:"$elevation2"},"&:hover > div > svg":{display:"block"},variants:{align:{top:{height:"100%",alignItems:"flex-start",paddingTop:"$sm"}}}}),WV=IV("input",{$reset:"",height:0,width:0,opacity:0,margin:0,"& + label":{position:"relative",$flexCenter:"",height:"100%",userSelect:"none",cursor:"pointer",paddingLeft:2,paddingRight:"$sm",pointerEvents:"auto"},"& + label:after":{content:'""',width:6,height:6,backgroundColor:"$elevation3",borderRadius:"50%",$activeStyle:""},"&:focus + label:after":{$focusStyle:""},"& + label:active:after":{backgroundColor:"$accent1",$focusStyle:""},"&:checked + label:after":{backgroundColor:"$accent1"}}),fV=IV("label",{fontWeight:"$label",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap","& > svg":{display:"block"}}),wV=IV("div",{opacity:1,variants:{disabled:{true:{opacity:.6,pointerEvents:"none",[`& ${fV}`]:{pointerEvents:"auto"}}}}}),RV=IV("div",{position:"fixed",top:0,bottom:0,right:0,left:0,zIndex:1e3,userSelect:"none"}),VV=IV("div",{background:"$toolTipBackground",fontFamily:"$sans",fontSize:"$toolTip",padding:"$xs $sm",color:"$toolTipText",borderRadius:"$xs",boxShadow:"$level2",maxWidth:260}),XV=IV(jw,{fill:"$toolTipBackground"});function SV({children:e}){const{className:t}=(0,g.useContext)(_R);return g.createElement(Gy,{className:t},e)}const YV=["align"];function KV(){const{id:e,disable:t,disabled:I}=PR();return g.createElement(g.Fragment,null,g.createElement(WV,{id:e+"__disable",type:"checkbox",checked:!I,onChange:()=>t(!I)}),g.createElement("label",{htmlFor:e+"__disable"}))}function HV(e){const{id:t,optional:I,hint:n}=PR(),i=e.htmlFor||(t?{htmlFor:t}:null),C=n||"string"!=typeof e.children?null:{title:e.children};return g.createElement(g.Fragment,null,I&&g.createElement(KV,null),void 0!==n?g.createElement(Qw,null,g.createElement(Dw,{asChild:!0},g.createElement(fV,OR({},i,e))),g.createElement(Ow,{side:"top",sideOffset:2},g.createElement(VV,null,n,g.createElement(XV,null)))):g.createElement(fV,OR({},i,C,e)))}function NV(e){let{align:t}=e,I=Pw(e,YV);const{value:n,label:i,key:C,disabled:o}=PR(),{hideCopyButton:a}=(0,g.useContext)($R),s=!a&&void 0!==C,[l,r]=(0,g.useState)(!1);return g.createElement(vV,{align:t,onPointerLeave:()=>r(!1)},g.createElement(HV,I),s&&!o&&g.createElement("div",{title:`Click to copy ${"string"==typeof i?i:C} value`},l?g.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor"},g.createElement("path",{d:"M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"}),g.createElement("path",{fillRule:"evenodd",d:"M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9.707 5.707a1 1 0 00-1.414-1.414L9 12.586l-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})):g.createElement("svg",{onClick:async()=>{try{await navigator.clipboard.writeText(JSON.stringify({[C]:null!=n?n:""})),r(!0)}catch(e){eR(_w.CLIPBOARD_ERROR,{[C]:n})}},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor"},g.createElement("path",{d:"M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"}),g.createElement("path",{d:"M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"}))))}const FV=["toggled"],xV=IV("svg",{fill:"currentColor",transition:"transform 350ms ease, fill 250ms ease"});function zV(e){let{toggled:t}=e,I=Pw(e,FV);return g.createElement(xV,OR({width:"9",height:"5",viewBox:"0 0 9 5",xmlns:"http://www.w3.org/2000/svg",style:{transform:`rotate(${t?0:-90}deg)`}},I),g.createElement("path",{d:"M3.8 4.4c.4.3 1 .3 1.4 0L8 1.7A1 1 0 007.4 0H1.6a1 1 0 00-.7 1.7l3 2.7z"}))}const kV=["input"];function MV(e){let{input:t}=e,I=Pw(e,kV);return t?g.createElement(yV,I):g.createElement(ZV,I)}function LV({value:e,type:t,settings:I,setValue:n}){const[i,C]=(0,g.useState)(lR(t,e,I)),o=(0,g.useRef)(e),a=(0,g.useRef)(I);a.current=I;const s=(0,g.useCallback)((e=>C(lR(t,e,a.current))),[t]),l=(0,g.useCallback)((e=>{try{n(e)}catch(e){const{type:g,previousValue:t}=e;if("LEVA_ERROR"!==g)throw e;s(t)}}),[s,n]);return(0,g.useEffect)((()=>{Zy(e,o.current)||s(e),o.current=e}),[e,s]),{displayValue:i,onChange:C,onUpdate:l}}function JV(e,g){const{emitOnEditStart:t,emitOnEditEnd:I}=PR();return fW((g=>{g.first&&(document.body.classList.add("leva__panel__dragged"),null==t||t());const n=e(g);return g.last&&(document.body.classList.remove("leva__panel__dragged"),null==I||I()),n}),g)}function EV(){const e=(0,g.useRef)(null),t=(0,g.useRef)({x:0,y:0}),I=(0,g.useCallback)((g=>{Object.assign(t.current,g),e.current&&(e.current.style.transform=`translate3d(${t.current.x}px, ${t.current.y}px, 0)`)}),[]);return[e,I]}const TV=["__refCount"],UV=(e,g)=>e[g]?Pw(e[g],TV):null,QV=IV("div",{variants:{hasRange:{true:{position:"relative",display:"grid",gridTemplateColumns:"auto $sizes$numberInputMinWidth",columnGap:"$colGap",alignItems:"center"}}}}),DV=IV("div",{position:"relative",width:"100%",height:2,borderRadius:"$xs",backgroundColor:"$elevation1"}),OV=IV("div",{position:"absolute",width:"$scrubberWidth",height:"$scrubberHeight",borderRadius:"$xs",boxShadow:"0 0 0 2px $colors$elevation2",backgroundColor:"$accent2",cursor:"pointer",$active:"none $accent1",$hover:"none $accent3",variants:{position:{left:{borderTopRightRadius:0,borderBottomRightRadius:0,transform:"translateX(calc(-0.5 * ($sizes$scrubberWidth + 4px)))"},right:{borderTopLeftRadius:0,borderBottomLeftRadius:0,transform:"translateX(calc(0.5 * ($sizes$scrubberWidth + 4px)))"}}}}),jV=IV("div",{position:"relative",$flex:"",height:"100%",cursor:"pointer",touchAction:"none"}),PV=IV("div",{position:"absolute",height:"100%",backgroundColor:"$accent2"});function _V({value:e,min:t,max:I,onDrag:n,step:i,initialValue:C}){const o=(0,g.useRef)(null),a=(0,g.useRef)(null),s=(0,g.useRef)(0),l=sV("sizes","scrubberWidth"),r=JV((({event:g,first:r,xy:[A],movement:[c],memo:d})=>{if(r){const{width:n,left:i}=o.current.getBoundingClientRect();s.current=n-parseFloat(l),d=(null==g?void 0:g.target)===a.current?e:pR((A-i)/n,t,I)}const u=d+pR(c/s.current,0,I-t);return n(QR(u,{step:i,initialValue:C})),d})),A=mR(e,t,I);return g.createElement(jV,OR({ref:o},r()),g.createElement(DV,null,g.createElement(PV,{style:{left:0,right:100*(1-A)+"%"}})),g.createElement(OV,{ref:a,style:{left:`calc(${A} * (100% - ${l}))`}}))}const qV=g.memo((({label:e,onUpdate:t,step:I,innerLabelTrim:n})=>{const[i,C]=(0,g.useState)(!1),o=JV((({active:e,delta:[g],event:n,memo:i=0})=>(C(e),i+=g/2,Math.abs(i)>=1&&(t((e=>parseFloat(e)+Math.floor(i)*I*LR(n))),i=0),i)));return g.createElement(AV,OR({dragging:i,title:e.length>1?e:""},o()),e.slice(0,n))}));function $V({label:e,id:t,displayValue:I,onUpdate:n,onChange:i,settings:C,innerLabelTrim:o=1}){const a=o>0&&g.createElement(qV,{label:e,step:C.step,onUpdate:n,innerLabelTrim:o});return g.createElement(bV,{id:t,value:String(I),onUpdate:n,onChange:i,innerLabel:a})}const{sanitizeStep:eX}=DR;var gX=cR({component:function(){const e=PR(),{label:t,value:I,onUpdate:n,settings:i,id:C}=e,{min:o,max:a}=i,s=a!==1/0&&o!==-1/0;return g.createElement(MV,{input:!0},g.createElement(NV,null,t),g.createElement(QV,{hasRange:s},s&&g.createElement(_V,OR({value:parseFloat(I),onDrag:n},i)),g.createElement($V,OR({},e,{id:C,label:"value",innerLabelTrim:s?0:1}))))}},Pw(DR,["sanitizeStep"])),tX=Object.freeze({__proto__:null,schema:(e,g)=>Ey().schema({options:Ey().passesAnyOf(Ey().object(),Ey().array())}).test(g),sanitize:(e,{values:g})=>{if(g.indexOf(e)<0)throw Error("Selected value doesn't match Select options");return e},format:(e,{values:g})=>g.indexOf(e),normalize:e=>{let g,t,{value:I,options:n}=e;return Array.isArray(n)?(t=n,g=n.map((e=>String(e)))):(t=Object.values(n),g=Object.keys(n)),"value"in e?t.includes(I)||(g.unshift(String(I)),t.unshift(I)):I=t[0],Object.values(n).includes(I)||(n[String(I)]=I),{value:I,settings:{keys:g,values:t}}}});const IX=IV("div",{$flexCenter:"",position:"relative","> svg":{pointerEvents:"none",position:"absolute",right:"$md"}}),nX=IV("select",{position:"absolute",top:0,left:0,width:"100%",height:"100%",opacity:0}),iX=IV("div",{display:"flex",alignItems:"center",width:"100%",height:"$rowHeight",backgroundColor:"$elevation3",borderRadius:"$sm",padding:"0 $sm",cursor:"pointer",[`${nX}:focus + &`]:{$focusStyle:""},[`${nX}:hover + &`]:{$hoverStyle:""}});function CX({displayValue:e,value:t,onUpdate:I,id:n,settings:i,disabled:C}){const{keys:o,values:a}=i,s=(0,g.useRef)();return t===a[e]&&(s.current=o[e]),g.createElement(IX,null,g.createElement(nX,{id:n,value:e,onChange:e=>I(a[Number(e.currentTarget.value)]),disabled:C},o.map(((e,t)=>g.createElement("option",{key:e,value:t},e)))),g.createElement(iX,null,s.current),g.createElement(zV,{toggled:!0}))}var oX=cR({component:function(){const{label:e,value:t,displayValue:I,onUpdate:n,id:i,disabled:C,settings:o}=PR();return g.createElement(MV,{input:!0},g.createElement(NV,null,e),g.createElement(CX,{id:i,value:t,displayValue:I,onUpdate:n,settings:o,disabled:C}))}},tX),aX=Object.freeze({__proto__:null,schema:e=>Ey().string().test(e),sanitize:e=>{if("string"!=typeof e)throw Error("Invalid string");return e},normalize:({value:e,editable:g=!0,rows:t=!1})=>({value:e,settings:{editable:g,rows:"number"==typeof t?t:t?5:0}})});const sX=["displayValue","onUpdate","onChange","editable"],lX=IV("div",{whiteSpace:"pre-wrap"});function rX(e){let{displayValue:t,onUpdate:I,onChange:n,editable:i=!0}=e,C=Pw(e,sX);return i?g.createElement(hV,OR({value:t,onUpdate:I,onChange:n},C)):g.createElement(lX,null,t)}var AX=cR({component:function(){const{label:e,settings:t,displayValue:I,onUpdate:n,onChange:i}=PR();return g.createElement(MV,{input:!0},g.createElement(NV,null,e),g.createElement(rX,OR({displayValue:I,onUpdate:n,onChange:i},t)))}},aX),cX=Object.freeze({__proto__:null,schema:e=>Ey().boolean().test(e),sanitize:e=>{if("boolean"!=typeof e)throw Error("Invalid boolean");return e}});const dX=IV("div",{position:"relative",$flex:"",height:"$rowHeight",input:{$reset:"",height:0,width:0,opacity:0,margin:0},label:{position:"relative",$flexCenter:"",userSelect:"none",cursor:"pointer",height:"$checkboxSize",width:"$checkboxSize",backgroundColor:"$elevation3",borderRadius:"$sm",$hover:""},"input:focus + label":{$focusStyle:""},"input:focus:checked + label, input:checked + label:hover":{$hoverStyle:"$accent3"},"input + label:active":{backgroundColor:"$accent1"},"input:checked + label:active":{backgroundColor:"$accent1"},"label > svg":{display:"none",width:"90%",height:"90%",stroke:"$highlight3"},"input:checked + label":{backgroundColor:"$accent2"},"input:checked + label > svg":{display:"block"}});function uX({value:e,onUpdate:t,id:I,disabled:n}){return g.createElement(dX,null,g.createElement("input",{id:I,type:"checkbox",checked:e,onChange:e=>t(e.currentTarget.checked),disabled:n}),g.createElement("label",{htmlFor:I},g.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},g.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"}))))}var hX=cR({component:function(){const{label:e,value:t,onUpdate:I,disabled:n,id:i}=PR();return g.createElement(MV,{input:!0},g.createElement(NV,null,e),g.createElement(uX,{value:t,onUpdate:I,id:i,disabled:n}))}},cX);const bX=["locked"];function mX({value:e,id:t,valueKey:I,settings:n,onUpdate:i,innerLabelTrim:C}){const o=(0,g.useRef)(e[I]);o.current=e[I];const a=(0,g.useCallback)((e=>i({[I]:kR({type:"NUMBER",value:o.current,settings:n},e)})),[i,n,I]),s=LV({type:"NUMBER",value:e[I],settings:n,setValue:a});return g.createElement($V,{id:t,label:I,value:e[I],displayValue:s.displayValue,onUpdate:s.onUpdate,onChange:s.onChange,settings:n,innerLabelTrim:C})}const pX=IV("div",{display:"grid",columnGap:"$colGap",gridAutoFlow:"column dense",alignItems:"center",variants:{withLock:{true:{gridTemplateColumns:"10px auto","> svg":{cursor:"pointer"}}}}});function GX(e){let{locked:t}=e,I=Pw(e,bX);return g.createElement("svg",OR({width:"10",height:"10",viewBox:"0 0 15 15",fill:"none",xmlns:"http://www.w3.org/2000/svg"},I),t?g.createElement("path",{d:"M5 4.63601C5 3.76031 5.24219 3.1054 5.64323 2.67357C6.03934 2.24705 6.64582 1.9783 7.5014 1.9783C8.35745 1.9783 8.96306 2.24652 9.35823 2.67208C9.75838 3.10299 10 3.75708 10 4.63325V5.99999H5V4.63601ZM4 5.99999V4.63601C4 3.58148 4.29339 2.65754 4.91049 1.99307C5.53252 1.32329 6.42675 0.978302 7.5014 0.978302C8.57583 0.978302 9.46952 1.32233 10.091 1.99162C10.7076 2.65557 11 3.57896 11 4.63325V5.99999H12C12.5523 5.99999 13 6.44771 13 6.99999V13C13 13.5523 12.5523 14 12 14H3C2.44772 14 2 13.5523 2 13V6.99999C2 6.44771 2.44772 5.99999 3 5.99999H4ZM3 6.99999H12V13H3V6.99999Z",fill:"currentColor",fillRule:"evenodd",clipRule:"evenodd"}):g.createElement("path",{d:"M9 3.63601C9 2.76044 9.24207 2.11211 9.64154 1.68623C10.0366 1.26502 10.6432 1 11.5014 1C12.4485 1 13.0839 1.30552 13.4722 1.80636C13.8031 2.23312 14 2.84313 14 3.63325H15C15 2.68242 14.7626 1.83856 14.2625 1.19361C13.6389 0.38943 12.6743 0 11.5014 0C10.4294 0 9.53523 0.337871 8.91218 1.0021C8.29351 1.66167 8 2.58135 8 3.63601V6H1C0.447715 6 0 6.44772 0 7V13C0 13.5523 0.447715 14 1 14H10C10.5523 14 11 13.5523 11 13V7C11 6.44772 10.5523 6 10 6H9V3.63601ZM1 7H10V13H1V7Z",fill:"currentColor",fillRule:"evenodd",clipRule:"evenodd"}))}function BX({value:e,onUpdate:t,settings:I,innerLabelTrim:n}){const{id:i,setSettings:C}=PR(),{lock:o,locked:a}=I;return g.createElement(pX,{withLock:o},o&&g.createElement(GX,{locked:a,onClick:()=>C({locked:!a})}),Object.keys(e).map(((C,o)=>g.createElement(mX,{id:0===o?i:`${i}.${C}`,key:C,valueKey:C,value:e,settings:I[C],onUpdate:t,innerLabelTrim:n}))))}const ZX=(e,g)=>{const t={};let I=0,n=1/0;Object.entries(e).forEach((([e,i])=>{t[e]=UR(cR({value:i},g[e])).settings,I=Math.max(I,t[e].step),n=Math.min(n,t[e].pad)}));for(let e in t){const{step:i,min:C,max:o}=g[e]||{};isFinite(i)||isFinite(C)&&isFinite(o)||(t[e].step=I,t[e].pad=n)}return t},yX=["lock"],vX=["value"];function WX(e){const g=Ey().array().length(e).every.number();return t=>g.test(t)||(g=>{if(!g||"object"!=typeof g)return!1;const t=Object.values(g);return t.length===e&&t.every((e=>isFinite(e)))})(t)}function fX(e,g,t){return function(e){return Array.isArray(e)?"array":"object"}(e)===g?e:"array"===g?Object.values(e):function(e,g){return e.reduce(((e,t,I)=>Object.assign(e,{[g[I]]:t})),{})}(e,t)}function wX(e){return{schema:WX(e.length),normalize:g=>{let{value:t}=g;return function(e,g,t=[]){const{lock:I=!1}=g,n=Pw(g,yX),i=Array.isArray(e)?"array":"object",C="object"===i?Object.keys(e):t,o=fX(e,"object",C),a=(s=n)&&("step"in s||"min"in s||"max"in s)?C.reduce(((e,g)=>Object.assign(e,{[g]:n})),{}):n;var s;return{value:"array"===i?e:o,settings:cR(cR({},ZX(o,a)),{},{format:i,keys:C,lock:I,locked:!1})}}(t,Pw(g,vX),e)},format:(e,g)=>((e,g)=>fX(e,"object",g.keys))(e,g),sanitize:(e,g,t)=>((e,g,t)=>{const I=fX(e,"object",g.keys);for(let e in I)I[e]=TR(I[e],g[e]);const n=Object.keys(I);let i={};if(n.length===g.keys.length)i=I;else{const e=fX(t,"object",g.keys);if(1===n.length&&g.locked){const g=n[0],t=I[g],C=e[g],o=0!==C?t/C:1;for(let I in e)I===g?i[g]=t:i[I]=e[I]*o}else i=cR(cR({},e),I)}return fX(i,g.format,g.keys)})(e,g,t)}}var RX={grad:.9,turn:360,rad:360/(2*Math.PI)},VX=function(e){return"string"==typeof e?e.length>0:"number"==typeof e},XX=function(e,g,t){return void 0===g&&(g=0),void 0===t&&(t=Math.pow(10,g)),Math.round(t*e)/t+0},SX=function(e,g,t){return void 0===g&&(g=0),void 0===t&&(t=1),e>t?t:e>g?e:g},YX=function(e){return(e=isFinite(e)?e%360:0)>0?e:e+360},KX=function(e){return{r:SX(e.r,0,255),g:SX(e.g,0,255),b:SX(e.b,0,255),a:SX(e.a)}},HX=function(e){return{r:XX(e.r),g:XX(e.g),b:XX(e.b),a:XX(e.a,3)}},NX=/^#([0-9a-f]{3,8})$/i,FX=function(e){var g=e.toString(16);return g.length<2?"0"+g:g},xX=function(e){var g=e.r,t=e.g,I=e.b,n=e.a,i=Math.max(g,t,I),C=i-Math.min(g,t,I),o=C?i===g?(t-I)/C:i===t?2+(I-g)/C:4+(g-t)/C:0;return{h:60*(o<0?o+6:o),s:i?C/i*100:0,v:i/255*100,a:n}},zX=function(e){var g=e.h,t=e.s,I=e.v,n=e.a;g=g/360*6,t/=100,I/=100;var i=Math.floor(g),C=I*(1-t),o=I*(1-(g-i)*t),a=I*(1-(1-g+i)*t),s=i%6;return{r:255*[I,o,C,C,a,I][s],g:255*[a,I,I,o,C,C][s],b:255*[C,C,a,I,I,o][s],a:n}},kX=function(e){return{h:YX(e.h),s:SX(e.s,0,100),l:SX(e.l,0,100),a:SX(e.a)}},MX=function(e){return{h:XX(e.h),s:XX(e.s),l:XX(e.l),a:XX(e.a,3)}},LX=function(e){return zX((t=(g=e).s,{h:g.h,s:(t*=((I=g.l)<50?I:100-I)/100)>0?2*t/(I+t)*100:0,v:I+t,a:g.a}));var g,t,I},JX=function(e){return{h:(g=xX(e)).h,s:(n=(200-(t=g.s))*(I=g.v)/100)>0&&n<200?t*I/100/(n<=100?n:200-n)*100:0,l:n/2,a:g.a};var g,t,I,n},EX=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s*,\s*([+-]?\d*\.?\d+)%\s*,\s*([+-]?\d*\.?\d+)%\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,TX=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s+([+-]?\d*\.?\d+)%\s+([+-]?\d*\.?\d+)%\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,UX=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,QX=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,DX={string:[[function(e){var g=NX.exec(e);return g?(e=g[1]).length<=4?{r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:4===e.length?XX(parseInt(e[3]+e[3],16)/255,2):1}:6===e.length||8===e.length?{r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:8===e.length?XX(parseInt(e.substr(6,2),16)/255,2):1}:null:null},"hex"],[function(e){var g=UX.exec(e)||QX.exec(e);return g?g[2]!==g[4]||g[4]!==g[6]?null:KX({r:Number(g[1])/(g[2]?100/255:1),g:Number(g[3])/(g[4]?100/255:1),b:Number(g[5])/(g[6]?100/255:1),a:void 0===g[7]?1:Number(g[7])/(g[8]?100:1)}):null},"rgb"],[function(e){var g=EX.exec(e)||TX.exec(e);if(!g)return null;var t,I,n=kX({h:(t=g[1],I=g[2],void 0===I&&(I="deg"),Number(t)*(RX[I]||1)),s:Number(g[3]),l:Number(g[4]),a:void 0===g[5]?1:Number(g[5])/(g[6]?100:1)});return LX(n)},"hsl"]],object:[[function(e){var g=e.r,t=e.g,I=e.b,n=e.a,i=void 0===n?1:n;return VX(g)&&VX(t)&&VX(I)?KX({r:Number(g),g:Number(t),b:Number(I),a:Number(i)}):null},"rgb"],[function(e){var g=e.h,t=e.s,I=e.l,n=e.a,i=void 0===n?1:n;if(!VX(g)||!VX(t)||!VX(I))return null;var C=kX({h:Number(g),s:Number(t),l:Number(I),a:Number(i)});return LX(C)},"hsl"],[function(e){var g=e.h,t=e.s,I=e.v,n=e.a,i=void 0===n?1:n;if(!VX(g)||!VX(t)||!VX(I))return null;var C=function(e){return{h:YX(e.h),s:SX(e.s,0,100),v:SX(e.v,0,100),a:SX(e.a)}}({h:Number(g),s:Number(t),v:Number(I),a:Number(i)});return zX(C)},"hsv"]]},OX=function(e,g){for(var t=0;t<g.length;t++){var I=g[t][0](e);if(I)return[I,g[t][1]]}return[null,void 0]},jX=function(e){return"string"==typeof e?OX(e.trim(),DX.string):"object"==typeof e&&null!==e?OX(e,DX.object):[null,void 0]},PX=function(e,g){var t=JX(e);return{h:t.h,s:SX(t.s+100*g,0,100),l:t.l,a:t.a}},_X=function(e){return(299*e.r+587*e.g+114*e.b)/1e3/255},qX=function(e,g){var t=JX(e);return{h:t.h,s:t.s,l:SX(t.l+100*g,0,100),a:t.a}},$X=function(){function e(e){this.parsed=jX(e)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return e.prototype.isValid=function(){return null!==this.parsed},e.prototype.brightness=function(){return XX(_X(this.rgba),2)},e.prototype.isDark=function(){return _X(this.rgba)<.5},e.prototype.isLight=function(){return _X(this.rgba)>=.5},e.prototype.toHex=function(){return g=(e=HX(this.rgba)).r,t=e.g,I=e.b,i=(n=e.a)<1?FX(XX(255*n)):"","#"+FX(g)+FX(t)+FX(I)+i;var e,g,t,I,n,i},e.prototype.toRgb=function(){return HX(this.rgba)},e.prototype.toRgbString=function(){return g=(e=HX(this.rgba)).r,t=e.g,I=e.b,(n=e.a)<1?"rgba("+g+", "+t+", "+I+", "+n+")":"rgb("+g+", "+t+", "+I+")";var e,g,t,I,n},e.prototype.toHsl=function(){return MX(JX(this.rgba))},e.prototype.toHslString=function(){return g=(e=MX(JX(this.rgba))).h,t=e.s,I=e.l,(n=e.a)<1?"hsla("+g+", "+t+"%, "+I+"%, "+n+")":"hsl("+g+", "+t+"%, "+I+"%)";var e,g,t,I,n},e.prototype.toHsv=function(){return e=xX(this.rgba),{h:XX(e.h),s:XX(e.s),v:XX(e.v),a:XX(e.a,3)};var e},e.prototype.invert=function(){return eS({r:255-(e=this.rgba).r,g:255-e.g,b:255-e.b,a:e.a});var e},e.prototype.saturate=function(e){return void 0===e&&(e=.1),eS(PX(this.rgba,e))},e.prototype.desaturate=function(e){return void 0===e&&(e=.1),eS(PX(this.rgba,-e))},e.prototype.grayscale=function(){return eS(PX(this.rgba,-1))},e.prototype.lighten=function(e){return void 0===e&&(e=.1),eS(qX(this.rgba,e))},e.prototype.darken=function(e){return void 0===e&&(e=.1),eS(qX(this.rgba,-e))},e.prototype.rotate=function(e){return void 0===e&&(e=15),this.hue(this.hue()+e)},e.prototype.alpha=function(e){return"number"==typeof e?eS({r:(g=this.rgba).r,g:g.g,b:g.b,a:e}):XX(this.rgba.a,3);var g},e.prototype.hue=function(e){var g=JX(this.rgba);return"number"==typeof e?eS({h:e,s:g.s,l:g.l,a:g.a}):XX(g.h)},e.prototype.isEqual=function(e){return this.toHex()===eS(e).toHex()},e}(),eS=function(e){return e instanceof $X?e:new $X(e)},gS=[];function tS(){return(tS=Object.assign||function(e){for(var g=1;g<arguments.length;g++){var t=arguments[g];for(var I in t)Object.prototype.hasOwnProperty.call(t,I)&&(e[I]=t[I])}return e}).apply(this,arguments)}function IS(e,g){if(null==e)return{};var t,I,n={},i=Object.keys(e);for(I=0;I<i.length;I++)g.indexOf(t=i[I])>=0||(n[t]=e[t]);return n}function nS(e){var t=(0,g.useRef)(e),I=(0,g.useRef)((function(e){t.current&&t.current(e)}));return t.current=e,I.current}var iS=function(e,g,t){return void 0===g&&(g=0),void 0===t&&(t=1),e>t?t:e<g?g:e},CS=function(e){return"touches"in e},oS=function(e){return e&&e.ownerDocument.defaultView||self},aS=function(e,g,t){var I=e.getBoundingClientRect(),n=CS(g)?function(e,g){for(var t=0;t<e.length;t++)if(e[t].identifier===g)return e[t];return e[0]}(g.touches,t):g;return{left:iS((n.pageX-(I.left+oS(e).pageXOffset))/I.width),top:iS((n.pageY-(I.top+oS(e).pageYOffset))/I.height)}},sS=function(e){!CS(e)&&e.preventDefault()},lS=g.memo((function(e){var t=e.onMove,I=e.onKey,n=IS(e,["onMove","onKey"]),i=(0,g.useRef)(null),C=nS(t),o=nS(I),a=(0,g.useRef)(null),s=(0,g.useRef)(!1),l=(0,g.useMemo)((function(){var e=function(e){sS(e),(CS(e)?e.touches.length>0:e.buttons>0)&&i.current?C(aS(i.current,e,a.current)):t(!1)},g=function(){return t(!1)};function t(t){var I=s.current,n=oS(i.current),C=t?n.addEventListener:n.removeEventListener;C(I?"touchmove":"mousemove",e),C(I?"touchend":"mouseup",g)}return[function(e){var g=e.nativeEvent,I=i.current;if(I&&(sS(g),!function(e,g){return g&&!CS(e)}(g,s.current)&&I)){if(CS(g)){s.current=!0;var n=g.changedTouches||[];n.length&&(a.current=n[0].identifier)}I.focus(),C(aS(I,g,a.current)),t(!0)}},function(e){var g=e.which||e.keyCode;g<37||g>40||(e.preventDefault(),o({left:39===g?.05:37===g?-.05:0,top:40===g?.05:38===g?-.05:0}))},t]}),[o,C]),r=l[0],A=l[1],c=l[2];return(0,g.useEffect)((function(){return c}),[c]),g.createElement("div",tS({},n,{onTouchStart:r,onMouseDown:r,className:"react-colorful__interactive",ref:i,onKeyDown:A,tabIndex:0,role:"slider"}))})),rS=function(e){return e.filter(Boolean).join(" ")},AS=function(e){var t=e.color,I=e.left,n=e.top,i=void 0===n?.5:n,C=rS(["react-colorful__pointer",e.className]);return g.createElement("div",{className:C,style:{top:100*i+"%",left:100*I+"%"}},g.createElement("div",{className:"react-colorful__pointer-fill",style:{backgroundColor:t}}))},cS=function(e,g,t){return void 0===g&&(g=0),void 0===t&&(t=Math.pow(10,g)),Math.round(t*e)/t},dS=(Math.PI,function(e){var g=e.s,t=e.v,I=e.a,n=(200-g)*t/100;return{h:cS(e.h),s:cS(n>0&&n<200?g*t/100/(n<=100?n:200-n)*100:0),l:cS(n/2),a:cS(I,2)}}),uS=function(e){var g=dS(e);return"hsl("+g.h+", "+g.s+"%, "+g.l+"%)"},hS=function(e){var g=dS(e);return"hsla("+g.h+", "+g.s+"%, "+g.l+"%, "+g.a+")"},bS=function(e){var g=e.h,t=e.s,I=e.v,n=e.a;g=g/360*6,t/=100,I/=100;var i=Math.floor(g),C=I*(1-t),o=I*(1-(g-i)*t),a=I*(1-(1-g+i)*t),s=i%6;return{r:cS(255*[I,o,C,C,a,I][s]),g:cS(255*[a,I,I,o,C,C][s]),b:cS(255*[C,C,a,I,I,o][s]),a:cS(n,2)}},mS=function(e){var g=e.r,t=e.g,I=e.b,n=e.a,i=Math.max(g,t,I),C=i-Math.min(g,t,I),o=C?i===g?(t-I)/C:i===t?2+(I-g)/C:4+(g-t)/C:0;return{h:cS(60*(o<0?o+6:o)),s:cS(i?C/i*100:0),v:cS(i/255*100),a:n}},pS=g.memo((function(e){var t=e.hue,I=e.onChange,n=rS(["react-colorful__hue",e.className]);return g.createElement("div",{className:n},g.createElement(lS,{onMove:function(e){I({h:360*e.left})},onKey:function(e){I({h:iS(t+360*e.left,0,360)})},"aria-label":"Hue","aria-valuenow":cS(t),"aria-valuemax":"360","aria-valuemin":"0"},g.createElement(AS,{className:"react-colorful__hue-pointer",left:t/360,color:uS({h:t,s:100,v:100,a:1})})))})),GS=g.memo((function(e){var t=e.hsva,I=e.onChange,n={backgroundColor:uS({h:t.h,s:100,v:100,a:1})};return g.createElement("div",{className:"react-colorful__saturation",style:n},g.createElement(lS,{onMove:function(e){I({s:100*e.left,v:100-100*e.top})},onKey:function(e){I({s:iS(t.s+100*e.left,0,100),v:iS(t.v-100*e.top,0,100)})},"aria-label":"Color","aria-valuetext":"Saturation "+cS(t.s)+"%, Brightness "+cS(t.v)+"%"},g.createElement(AS,{className:"react-colorful__saturation-pointer",top:1-t.v/100,left:t.s/100,color:uS(t)})))})),BS=function(e,g){if(e===g)return!0;for(var t in e)if(e[t]!==g[t])return!1;return!0};function ZS(e,t,I){var n=nS(I),i=(0,g.useState)((function(){return e.toHsva(t)})),C=i[0],o=i[1],a=(0,g.useRef)({color:t,hsva:C});(0,g.useEffect)((function(){if(!e.equal(t,a.current.color)){var g=e.toHsva(t);a.current={hsva:g,color:t},o(g)}}),[t,e]),(0,g.useEffect)((function(){var g;BS(C,a.current.hsva)||e.equal(g=e.fromHsva(C),a.current.color)||(a.current={hsva:C,color:g},n(g))}),[C,e,n]);var s=(0,g.useCallback)((function(e){o((function(g){return Object.assign({},g,e)}))}),[]);return[C,s]}var yS="undefined"!=typeof window?g.useLayoutEffect:g.useEffect,vS=new Map,WS=function(e){yS((function(){var g=e.current?e.current.ownerDocument:document;if(void 0!==g&&!vS.has(g)){var t=g.createElement("style");t.innerHTML='.react-colorful{position:relative;display:flex;flex-direction:column;width:200px;height:200px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:default}.react-colorful__saturation{position:relative;flex-grow:1;border-color:transparent;border-bottom:12px solid #000;border-radius:8px 8px 0 0;background-image:linear-gradient(0deg,#000,transparent),linear-gradient(90deg,#fff,hsla(0,0%,100%,0))}.react-colorful__alpha-gradient,.react-colorful__pointer-fill{content:"";position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none;border-radius:inherit}.react-colorful__alpha-gradient,.react-colorful__saturation{box-shadow:inset 0 0 0 1px rgba(0,0,0,.05)}.react-colorful__alpha,.react-colorful__hue{position:relative;height:24px}.react-colorful__hue{background:linear-gradient(90deg,red 0,#ff0 17%,#0f0 33%,#0ff 50%,#00f 67%,#f0f 83%,red)}.react-colorful__last-control{border-radius:0 0 8px 8px}.react-colorful__interactive{position:absolute;left:0;top:0;right:0;bottom:0;border-radius:inherit;outline:none;touch-action:none}.react-colorful__pointer{position:absolute;z-index:1;box-sizing:border-box;width:28px;height:28px;transform:translate(-50%,-50%);background-color:#fff;border:2px solid #fff;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,.2)}.react-colorful__interactive:focus .react-colorful__pointer{transform:translate(-50%,-50%) scale(1.1)}.react-colorful__alpha,.react-colorful__alpha-pointer{background-color:#fff;background-image:url(\'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill-opacity=".05"><path d="M8 0h8v8H8zM0 8h8v8H0z"/></svg>\')}.react-colorful__saturation-pointer{z-index:3}.react-colorful__hue-pointer{z-index:2}',vS.set(g,t);var I=n.nc;I&&t.setAttribute("nonce",I),g.head.appendChild(t)}}),[])},fS=function(e){var t=e.className,I=e.colorModel,n=e.color,i=void 0===n?I.defaultColor:n,C=e.onChange,o=IS(e,["className","colorModel","color","onChange"]),a=(0,g.useRef)(null);WS(a);var s=ZS(I,i,C),l=s[0],r=s[1],A=rS(["react-colorful",t]);return g.createElement("div",tS({},o,{ref:a,className:A}),g.createElement(GS,{hsva:l,onChange:r}),g.createElement(pS,{hue:l.h,onChange:r,className:"react-colorful__last-control"}))},wS=function(e){var t=e.className,I=e.hsva,n=e.onChange,i={backgroundImage:"linear-gradient(90deg, "+hS(Object.assign({},I,{a:0}))+", "+hS(Object.assign({},I,{a:1}))+")"},C=rS(["react-colorful__alpha",t]),o=cS(100*I.a);return g.createElement("div",{className:C},g.createElement("div",{className:"react-colorful__alpha-gradient",style:i}),g.createElement(lS,{onMove:function(e){n({a:e.left})},onKey:function(e){n({a:iS(I.a+e.left)})},"aria-label":"Alpha","aria-valuetext":o+"%","aria-valuenow":o,"aria-valuemin":"0","aria-valuemax":"100"},g.createElement(AS,{className:"react-colorful__alpha-pointer",left:I.a,color:hS(I)})))},RS=function(e){var t=e.className,I=e.colorModel,n=e.color,i=void 0===n?I.defaultColor:n,C=e.onChange,o=IS(e,["className","colorModel","color","onChange"]),a=(0,g.useRef)(null);WS(a);var s=ZS(I,i,C),l=s[0],r=s[1],A=rS(["react-colorful",t]);return g.createElement("div",tS({},o,{ref:a,className:A}),g.createElement(GS,{hsva:l,onChange:r}),g.createElement(pS,{hue:l.h,onChange:r}),g.createElement(wS,{hsva:l,onChange:r,className:"react-colorful__last-control"}))},VS={defaultColor:{r:0,g:0,b:0,a:1},toHsva:mS,fromHsva:bS,equal:BS},XS=function(e){return g.createElement(RS,tS({},e,{colorModel:VS}))},SS={defaultColor:{r:0,g:0,b:0},toHsva:function(e){return mS({r:e.r,g:e.g,b:e.b,a:1})},fromHsva:function(e){return{r:(g=bS(e)).r,g:g.g,b:g.b};var g},equal:BS},YS=function(e){return g.createElement(fS,tS({},e,{colorModel:SS}))},KS=n(697),HS=n.n(KS);function NS(e,g,t,I){return new(t||(t=Promise))((function(n,i){function C(e){try{a(I.next(e))}catch(e){i(e)}}function o(e){try{a(I.throw(e))}catch(e){i(e)}}function a(e){var g;e.done?n(e.value):(g=e.value,g instanceof t?g:new t((function(e){e(g)}))).then(C,o)}a((I=I.apply(e,g||[])).next())}))}function FS(e,g){var t,I,n,i,C={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(a){return function(o){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(C=0)),C;)try{if(t=1,I&&(n=2&o[0]?I.return:o[0]?I.throw||((n=I.return)&&n.call(I),0):I.next)&&!(n=n.call(I,o[1])).done)return n;switch(I=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return C.label++,{value:o[1],done:!1};case 5:C.label++,I=o[1],o=[0];continue;case 7:o=C.ops.pop(),C.trys.pop();continue;default:if(!((n=(n=C.trys).length>0&&n[n.length-1])||6!==o[0]&&2!==o[0])){C=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){C.label=o[1];break}if(6===o[0]&&C.label<n[1]){C.label=n[1],n=o;break}if(n&&C.label<n[2]){C.label=n[2],C.ops.push(o);break}n[2]&&C.ops.pop(),C.trys.pop();continue}o=g.call(e,C)}catch(e){o=[6,e],I=0}finally{t=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function xS(e,g){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var I,n,i=t.call(e),C=[];try{for(;(void 0===g||g-- >0)&&!(I=i.next()).done;)C.push(I.value)}catch(e){n={error:e}}finally{try{I&&!I.done&&(t=i.return)&&t.call(i)}finally{if(n)throw n.error}}return C}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var zS=new Map([["aac","audio/aac"],["abw","application/x-abiword"],["arc","application/x-freearc"],["avif","image/avif"],["avi","video/x-msvideo"],["azw","application/vnd.amazon.ebook"],["bin","application/octet-stream"],["bmp","image/bmp"],["bz","application/x-bzip"],["bz2","application/x-bzip2"],["cda","application/x-cdf"],["csh","application/x-csh"],["css","text/css"],["csv","text/csv"],["doc","application/msword"],["docx","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],["eot","application/vnd.ms-fontobject"],["epub","application/epub+zip"],["gz","application/gzip"],["gif","image/gif"],["heic","image/heic"],["heif","image/heif"],["htm","text/html"],["html","text/html"],["ico","image/vnd.microsoft.icon"],["ics","text/calendar"],["jar","application/java-archive"],["jpeg","image/jpeg"],["jpg","image/jpeg"],["js","text/javascript"],["json","application/json"],["jsonld","application/ld+json"],["mid","audio/midi"],["midi","audio/midi"],["mjs","text/javascript"],["mp3","audio/mpeg"],["mp4","video/mp4"],["mpeg","video/mpeg"],["mpkg","application/vnd.apple.installer+xml"],["odp","application/vnd.oasis.opendocument.presentation"],["ods","application/vnd.oasis.opendocument.spreadsheet"],["odt","application/vnd.oasis.opendocument.text"],["oga","audio/ogg"],["ogv","video/ogg"],["ogx","application/ogg"],["opus","audio/opus"],["otf","font/otf"],["png","image/png"],["pdf","application/pdf"],["php","application/x-httpd-php"],["ppt","application/vnd.ms-powerpoint"],["pptx","application/vnd.openxmlformats-officedocument.presentationml.presentation"],["rar","application/vnd.rar"],["rtf","application/rtf"],["sh","application/x-sh"],["svg","image/svg+xml"],["swf","application/x-shockwave-flash"],["tar","application/x-tar"],["tif","image/tiff"],["tiff","image/tiff"],["ts","video/mp2t"],["ttf","font/ttf"],["txt","text/plain"],["vsd","application/vnd.visio"],["wav","audio/wav"],["weba","audio/webm"],["webm","video/webm"],["webp","image/webp"],["woff","font/woff"],["woff2","font/woff2"],["xhtml","application/xhtml+xml"],["xls","application/vnd.ms-excel"],["xlsx","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],["xml","application/xml"],["xul","application/vnd.mozilla.xul+xml"],["zip","application/zip"],["7z","application/x-7z-compressed"],["mkv","video/x-matroska"],["mov","video/quicktime"],["msg","application/vnd.ms-outlook"]]);function kS(e,g){var t=function(e){var g=e.name;if(g&&-1!==g.lastIndexOf(".")&&!e.type){var t=g.split(".").pop().toLowerCase(),I=zS.get(t);I&&Object.defineProperty(e,"type",{value:I,writable:!1,configurable:!1,enumerable:!0})}return e}(e);if("string"!=typeof t.path){var I=e.webkitRelativePath;Object.defineProperty(t,"path",{value:"string"==typeof g?g:"string"==typeof I&&I.length>0?I:e.name,writable:!1,configurable:!1,enumerable:!0})}return t}var MS=[".DS_Store","Thumbs.db"];function LS(e){return"object"==typeof e&&null!==e}function JS(e){return QS(e.target.files).map((function(e){return kS(e)}))}function ES(e){return NS(this,void 0,void 0,(function(){return FS(this,(function(g){switch(g.label){case 0:return[4,Promise.all(e.map((function(e){return e.getFile()})))];case 1:return[2,g.sent().map((function(e){return kS(e)}))]}}))}))}function TS(e,g){return NS(this,void 0,void 0,(function(){var t;return FS(this,(function(I){switch(I.label){case 0:return null===e?[2,[]]:e.items?(t=QS(e.items).filter((function(e){return"file"===e.kind})),"drop"!==g?[2,t]:[4,Promise.all(t.map(DS))]):[3,2];case 1:return[2,US(OS(I.sent()))];case 2:return[2,US(QS(e.files).map((function(e){return kS(e)})))]}}))}))}function US(e){return e.filter((function(e){return-1===MS.indexOf(e.name)}))}function QS(e){if(null===e)return[];for(var g=[],t=0;t<e.length;t++){var I=e[t];g.push(I)}return g}function DS(e){if("function"!=typeof e.webkitGetAsEntry)return jS(e);var g=e.webkitGetAsEntry();return g&&g.isDirectory?_S(g):jS(e)}function OS(e){return e.reduce((function(e,g){return function(){for(var e=[],g=0;g<arguments.length;g++)e=e.concat(xS(arguments[g]));return e}(e,Array.isArray(g)?OS(g):[g])}),[])}function jS(e){var g=e.getAsFile();if(!g)return Promise.reject(e+" is not a File");var t=kS(g);return Promise.resolve(t)}function PS(e){return NS(this,void 0,void 0,(function(){return FS(this,(function(g){return[2,e.isDirectory?_S(e):qS(e)]}))}))}function _S(e){var g=e.createReader();return new Promise((function(e,t){var I=[];!function n(){var i=this;g.readEntries((function(g){return NS(i,void 0,void 0,(function(){var i,C,o;return FS(this,(function(a){switch(a.label){case 0:if(g.length)return[3,5];a.label=1;case 1:return a.trys.push([1,3,,4]),[4,Promise.all(I)];case 2:return i=a.sent(),e(i),[3,4];case 3:return C=a.sent(),t(C),[3,4];case 4:return[3,6];case 5:o=Promise.all(g.map(PS)),I.push(o),n(),a.label=6;case 6:return[2]}}))}))}),(function(e){t(e)}))}()}))}function qS(e){return NS(this,void 0,void 0,(function(){return FS(this,(function(g){return[2,new Promise((function(g,t){e.file((function(t){var I=kS(t,e.fullPath);g(I)}),(function(e){t(e)}))}))]}))}))}var $S=n(363);function eY(e,g){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var I=Object.getOwnPropertySymbols(e);g&&(I=I.filter((function(g){return Object.getOwnPropertyDescriptor(e,g).enumerable}))),t.push.apply(t,I)}return t}function gY(e){for(var g=1;g<arguments.length;g++){var t=null!=arguments[g]?arguments[g]:{};g%2?eY(Object(t),!0).forEach((function(g){tY(e,g,t[g])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):eY(Object(t)).forEach((function(g){Object.defineProperty(e,g,Object.getOwnPropertyDescriptor(t,g))}))}return e}function tY(e,g,t){return g in e?Object.defineProperty(e,g,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[g]=t,e}function IY(e,g){return function(e){if(Array.isArray(e))return e}(e)||function(e,g){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var I,n,i=[],C=!0,o=!1;try{for(t=t.call(e);!(C=(I=t.next()).done)&&(i.push(I.value),!g||i.length!==g);C=!0);}catch(e){o=!0,n=e}finally{try{C||null==t.return||t.return()}finally{if(o)throw n}}return i}}(e,g)||function(e,g){if(e){if("string"==typeof e)return nY(e,g);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?nY(e,g):void 0}}(e,g)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function nY(e,g){(null==g||g>e.length)&&(g=e.length);for(var t=0,I=new Array(g);t<g;t++)I[t]=e[t];return I}var iY=function(e){e=Array.isArray(e)&&1===e.length?e[0]:e;var g=Array.isArray(e)?"one of ".concat(e.join(", ")):e;return{code:"file-invalid-type",message:"File type must be ".concat(g)}},CY=function(e){return{code:"file-too-large",message:"File is larger than ".concat(e," ").concat(1===e?"byte":"bytes")}},oY=function(e){return{code:"file-too-small",message:"File is smaller than ".concat(e," ").concat(1===e?"byte":"bytes")}},aY={code:"too-many-files",message:"Too many files"};function sY(e,g){var t="application/x-moz-file"===e.type||(0,$S.Z)(e,g);return[t,t?null:iY(g)]}function lY(e,g,t){if(rY(e.size))if(rY(g)&&rY(t)){if(e.size>t)return[!1,CY(t)];if(e.size<g)return[!1,oY(g)]}else{if(rY(g)&&e.size<g)return[!1,oY(g)];if(rY(t)&&e.size>t)return[!1,CY(t)]}return[!0,null]}function rY(e){return null!=e}function AY(e){return"function"==typeof e.isPropagationStopped?e.isPropagationStopped():void 0!==e.cancelBubble&&e.cancelBubble}function cY(e){return e.dataTransfer?Array.prototype.some.call(e.dataTransfer.types,(function(e){return"Files"===e||"application/x-moz-file"===e})):!!e.target&&!!e.target.files}function dY(e){e.preventDefault()}function uY(){for(var e=arguments.length,g=new Array(e),t=0;t<e;t++)g[t]=arguments[t];return function(e){for(var t=arguments.length,I=new Array(t>1?t-1:0),n=1;n<t;n++)I[n-1]=arguments[n];return g.some((function(g){return!AY(e)&&g&&g.apply(void 0,[e].concat(I)),AY(e)}))}}function hY(e){return e="string"==typeof e?e.split(","):e,[{description:"everything",accept:Array.isArray(e)?e.filter((function(e){return"audio/*"===e||"video/*"===e||"image/*"===e||"text/*"===e||/\w+\/[-+.\w]+/g.test(e)})).reduce((function(e,g){return gY(gY({},e),{},tY({},g,[]))}),{}):{}}]}var bY=["children"],mY=["open"],pY=["refKey","role","onKeyDown","onFocus","onBlur","onClick","onDragEnter","onDragOver","onDragLeave","onDrop"],GY=["refKey","onChange","onClick"];function BY(e,g){return function(e){if(Array.isArray(e))return e}(e)||function(e,g){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var I,n,i=[],C=!0,o=!1;try{for(t=t.call(e);!(C=(I=t.next()).done)&&(i.push(I.value),!g||i.length!==g);C=!0);}catch(e){o=!0,n=e}finally{try{C||null==t.return||t.return()}finally{if(o)throw n}}return i}}(e,g)||ZY(e,g)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ZY(e,g){if(e){if("string"==typeof e)return yY(e,g);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?yY(e,g):void 0}}function yY(e,g){(null==g||g>e.length)&&(g=e.length);for(var t=0,I=new Array(g);t<g;t++)I[t]=e[t];return I}function vY(e,g){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var I=Object.getOwnPropertySymbols(e);g&&(I=I.filter((function(g){return Object.getOwnPropertyDescriptor(e,g).enumerable}))),t.push.apply(t,I)}return t}function WY(e){for(var g=1;g<arguments.length;g++){var t=null!=arguments[g]?arguments[g]:{};g%2?vY(Object(t),!0).forEach((function(g){fY(e,g,t[g])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):vY(Object(t)).forEach((function(g){Object.defineProperty(e,g,Object.getOwnPropertyDescriptor(t,g))}))}return e}function fY(e,g,t){return g in e?Object.defineProperty(e,g,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[g]=t,e}function wY(e,g){if(null==e)return{};var t,I,n=function(e,g){if(null==e)return{};var t,I,n={},i=Object.keys(e);for(I=0;I<i.length;I++)t=i[I],g.indexOf(t)>=0||(n[t]=e[t]);return n}(e,g);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(I=0;I<i.length;I++)t=i[I],g.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(n[t]=e[t])}return n}var RY=(0,g.forwardRef)((function(e,t){var I=e.children,n=SY(wY(e,bY)),i=n.open,C=wY(n,mY);return(0,g.useImperativeHandle)(t,(function(){return{open:i}}),[i]),g.createElement(g.Fragment,null,I(WY(WY({},C),{},{open:i})))}));RY.displayName="Dropzone";var VY={disabled:!1,getFilesFromEvent:function(e){return NS(this,void 0,void 0,(function(){return FS(this,(function(g){return LS(e)&&LS(e.dataTransfer)?[2,TS(e.dataTransfer,e.type)]:LS(t=e)&&LS(t.target)?[2,JS(e)]:Array.isArray(e)&&e.every((function(e){return"getFile"in e&&"function"==typeof e.getFile}))?[2,ES(e)]:[2,[]];var t}))}))},maxSize:1/0,minSize:0,multiple:!0,maxFiles:0,preventDropOnDocument:!0,noClick:!1,noKeyboard:!1,noDrag:!1,noDragEventsBubbling:!1,validator:null,useFsAccessApi:!0};RY.defaultProps=VY,RY.propTypes={children:HS().func,accept:HS().oneOfType([HS().string,HS().arrayOf(HS().string)]),multiple:HS().bool,preventDropOnDocument:HS().bool,noClick:HS().bool,noKeyboard:HS().bool,noDrag:HS().bool,noDragEventsBubbling:HS().bool,minSize:HS().number,maxSize:HS().number,maxFiles:HS().number,disabled:HS().bool,getFilesFromEvent:HS().func,onFileDialogCancel:HS().func,onFileDialogOpen:HS().func,useFsAccessApi:HS().bool,onDragEnter:HS().func,onDragLeave:HS().func,onDragOver:HS().func,onDrop:HS().func,onDropAccepted:HS().func,onDropRejected:HS().func,validator:HS().func};var XY={isFocused:!1,isFileDialogActive:!1,isDragActive:!1,isDragAccept:!1,isDragReject:!1,draggedFiles:[],acceptedFiles:[],fileRejections:[]};function SY(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=WY(WY({},VY),e),I=t.accept,n=t.disabled,i=t.getFilesFromEvent,C=t.maxSize,o=t.minSize,a=t.multiple,s=t.maxFiles,l=t.onDragEnter,r=t.onDragLeave,A=t.onDragOver,c=t.onDrop,d=t.onDropAccepted,u=t.onDropRejected,h=t.onFileDialogCancel,b=t.onFileDialogOpen,m=t.useFsAccessApi,p=t.preventDropOnDocument,G=t.noClick,B=t.noKeyboard,Z=t.noDrag,y=t.noDragEventsBubbling,v=t.validator,W=(0,g.useMemo)((function(){return"function"==typeof b?b:KY}),[b]),f=(0,g.useMemo)((function(){return"function"==typeof h?h:KY}),[h]),w=(0,g.useRef)(null),R=(0,g.useRef)(null),V=BY((0,g.useReducer)(YY,XY),2),X=V[0],S=V[1],Y=X.isFocused,K=X.isFileDialogActive,H=X.draggedFiles,N=(0,g.useRef)("undefined"!=typeof window&&window.isSecureContext&&m&&"showOpenFilePicker"in window),F=function(){!N.current&&K&&setTimeout((function(){R.current&&(R.current.files.length||(S({type:"closeDialog"}),f()))}),300)};(0,g.useEffect)((function(){return window.addEventListener("focus",F,!1),function(){window.removeEventListener("focus",F,!1)}}),[R,K,f,N]);var x=(0,g.useRef)([]),z=function(e){w.current&&w.current.contains(e.target)||(e.preventDefault(),x.current=[])};(0,g.useEffect)((function(){return p&&(document.addEventListener("dragover",dY,!1),document.addEventListener("drop",z,!1)),function(){p&&(document.removeEventListener("dragover",dY),document.removeEventListener("drop",z))}}),[w,p]);var k=(0,g.useCallback)((function(e){var g;e.preventDefault(),e.persist(),q(e),x.current=[].concat(function(e){if(Array.isArray(e))return yY(e)}(g=x.current)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(g)||ZY(g)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),[e.target]),cY(e)&&Promise.resolve(i(e)).then((function(g){AY(e)&&!y||(S({draggedFiles:g,isDragActive:!0,type:"setDraggedFiles"}),l&&l(e))}))}),[i,l,y]),M=(0,g.useCallback)((function(e){e.preventDefault(),e.persist(),q(e);var g=cY(e);if(g&&e.dataTransfer)try{e.dataTransfer.dropEffect="copy"}catch(e){}return g&&A&&A(e),!1}),[A,y]),L=(0,g.useCallback)((function(e){e.preventDefault(),e.persist(),q(e);var g=x.current.filter((function(e){return w.current&&w.current.contains(e)})),t=g.indexOf(e.target);-1!==t&&g.splice(t,1),x.current=g,g.length>0||(S({isDragActive:!1,type:"setDraggedFiles",draggedFiles:[]}),cY(e)&&r&&r(e))}),[w,r,y]),J=(0,g.useCallback)((function(e,g){var t=[],n=[];e.forEach((function(e){var g=BY(sY(e,I),2),i=g[0],a=g[1],s=BY(lY(e,o,C),2),l=s[0],r=s[1],A=v?v(e):null;if(i&&l&&!A)t.push(e);else{var c=[a,r];A&&(c=c.concat(A)),n.push({file:e,errors:c.filter((function(e){return e}))})}})),(!a&&t.length>1||a&&s>=1&&t.length>s)&&(t.forEach((function(e){n.push({file:e,errors:[aY]})})),t.splice(0)),S({acceptedFiles:t,fileRejections:n,type:"setFiles"}),c&&c(t,n,g),n.length>0&&u&&u(n,g),t.length>0&&d&&d(t,g)}),[S,a,I,o,C,s,c,d,u,v]),E=(0,g.useCallback)((function(e){e.preventDefault(),e.persist(),q(e),x.current=[],cY(e)&&Promise.resolve(i(e)).then((function(g){AY(e)&&!y||J(g,e)})),S({type:"reset"})}),[i,J,y]),T=(0,g.useCallback)((function(){if(N.current){S({type:"openDialog"}),W();var e={multiple:a,types:hY(I)};window.showOpenFilePicker(e).then((function(e){return i(e)})).then((function(e){J(e,null),S({type:"closeDialog"})})).catch((function(e){!function(e){return e instanceof DOMException&&("AbortError"===e.name||e.code===e.ABORT_ERR)}(e)?function(e){return e instanceof DOMException&&("SecurityError"===e.name||e.code===e.SECURITY_ERR)}(e)&&(N.current=!1,R.current&&(R.current.value=null,R.current.click())):(f(e),S({type:"closeDialog"}))}))}else R.current&&(S({type:"openDialog"}),W(),R.current.value=null,R.current.click())}),[S,W,f,m,J,I,a]),U=(0,g.useCallback)((function(e){w.current&&w.current.isEqualNode(e.target)&&(" "!==e.key&&"Enter"!==e.key&&32!==e.keyCode&&13!==e.keyCode||(e.preventDefault(),T()))}),[w,T]),Q=(0,g.useCallback)((function(){S({type:"focus"})}),[]),D=(0,g.useCallback)((function(){S({type:"blur"})}),[]),O=(0,g.useCallback)((function(){G||(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.navigator.userAgent;return function(e){return-1!==e.indexOf("MSIE")||-1!==e.indexOf("Trident/")}(e)||function(e){return-1!==e.indexOf("Edge/")}(e)}()?setTimeout(T,0):T())}),[G,T]),j=function(e){return n?null:e},P=function(e){return B?null:j(e)},_=function(e){return Z?null:j(e)},q=function(e){y&&e.stopPropagation()},$=(0,g.useMemo)((function(){return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},g=e.refKey,t=void 0===g?"ref":g,I=e.role,i=e.onKeyDown,C=e.onFocus,o=e.onBlur,a=e.onClick,s=e.onDragEnter,l=e.onDragOver,r=e.onDragLeave,A=e.onDrop,c=wY(e,pY);return WY(WY(fY({onKeyDown:P(uY(i,U)),onFocus:P(uY(C,Q)),onBlur:P(uY(o,D)),onClick:j(uY(a,O)),onDragEnter:_(uY(s,k)),onDragOver:_(uY(l,M)),onDragLeave:_(uY(r,L)),onDrop:_(uY(A,E)),role:"string"==typeof I&&""!==I?I:"button"},t,w),n||B?{}:{tabIndex:0}),c)}}),[w,U,Q,D,O,k,M,L,E,B,Z,n]),ee=(0,g.useCallback)((function(e){e.stopPropagation()}),[]),ge=(0,g.useMemo)((function(){return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},g=e.refKey,t=void 0===g?"ref":g,n=e.onChange,i=e.onClick,C=wY(e,GY);return WY(WY({},fY({accept:I,multiple:a,type:"file",style:{display:"none"},onChange:j(uY(n,E)),onClick:j(uY(i,ee)),tabIndex:-1},t,R)),C)}}),[R,I,a,E,n]),te=H.length,Ie=te>0&&function(e){var g=e.files,t=e.accept,I=e.minSize,n=e.maxSize,i=e.multiple,C=e.maxFiles;return!(!i&&g.length>1||i&&C>=1&&g.length>C)&&g.every((function(e){var g=IY(sY(e,t),1)[0],i=IY(lY(e,I,n),1)[0];return g&&i}))}({files:H,accept:I,minSize:o,maxSize:C,multiple:a,maxFiles:s}),ne=te>0&&!Ie;return WY(WY({},X),{},{isDragAccept:Ie,isDragReject:ne,isFocused:Y&&!n,getRootProps:$,getInputProps:ge,rootRef:w,inputRef:R,open:j(T)})}function YY(e,g){switch(g.type){case"focus":return WY(WY({},e),{},{isFocused:!0});case"blur":return WY(WY({},e),{},{isFocused:!1});case"openDialog":return WY(WY({},XY),{},{isFileDialogActive:!0});case"closeDialog":return WY(WY({},e),{},{isFileDialogActive:!1});case"setDraggedFiles":var t=g.isDragActive,I=g.draggedFiles;return WY(WY({},e),{},{draggedFiles:I,isDragActive:t});case"setFiles":return WY(WY({},e),{},{acceptedFiles:g.acceptedFiles,fileRejections:g.fileRejections});case"reset":return WY({},XY);default:return e}}function KY(){}const HY="undefined"==typeof window||!window.navigator||/ServerSideRendering|^Deno\//.test(window.navigator.userAgent)?g.useEffect:g.useLayoutEffect;Object.defineProperty,Object.getOwnPropertySymbols,Object.prototype.hasOwnProperty,Object.prototype.propertyIsEnumerable,Object.defineProperty,Object.getOwnPropertySymbols,Object.prototype.hasOwnProperty,Object.prototype.propertyIsEnumerable;var NY=n(529),FY=n.n(NY);const xY=(...e)=>e.filter(Boolean).join(".");function zY(e=3){const t=(0,g.useRef)(null),I=(0,g.useRef)(null),[n,i]=(0,g.useState)(!1),C=(0,g.useCallback)((()=>i(!0)),[]),o=(0,g.useCallback)((()=>i(!1)),[]);return(0,g.useLayoutEffect)((()=>{if(n){const{bottom:g,top:n,left:i}=t.current.getBoundingClientRect(),{height:C}=I.current.getBoundingClientRect(),o=g+C>window.innerHeight-40?"up":"down";I.current.style.position="fixed",I.current.style.zIndex="10000",I.current.style.left=i+"px","down"===o?I.current.style.top=g+e+"px":I.current.style.bottom=window.innerHeight-n+e+"px"}}),[e,n]),{popinRef:t,wrapperRef:I,shown:n,show:C,hide:o}}!function(e){e.forEach((function(e){gS.indexOf(e)<0&&(e($X,DX),gS.push(e))}))}([function(e,g){var t={white:"#ffffff",bisque:"#ffe4c4",blue:"#0000ff",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",antiquewhite:"#faebd7",aqua:"#00ffff",azure:"#f0ffff",whitesmoke:"#f5f5f5",papayawhip:"#ffefd5",plum:"#dda0dd",blanchedalmond:"#ffebcd",black:"#000000",gold:"#ffd700",goldenrod:"#daa520",gainsboro:"#dcdcdc",cornsilk:"#fff8dc",cornflowerblue:"#6495ed",burlywood:"#deb887",aquamarine:"#7fffd4",beige:"#f5f5dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkkhaki:"#bdb76b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",peachpuff:"#ffdab9",darkmagenta:"#8b008b",darkred:"#8b0000",darkorchid:"#9932cc",darkorange:"#ff8c00",darkslateblue:"#483d8b",gray:"#808080",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",deeppink:"#ff1493",deepskyblue:"#00bfff",wheat:"#f5deb3",firebrick:"#b22222",floralwhite:"#fffaf0",ghostwhite:"#f8f8ff",darkviolet:"#9400d3",magenta:"#ff00ff",green:"#008000",dodgerblue:"#1e90ff",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",blueviolet:"#8a2be2",forestgreen:"#228b22",lawngreen:"#7cfc00",indianred:"#cd5c5c",indigo:"#4b0082",fuchsia:"#ff00ff",brown:"#a52a2a",maroon:"#800000",mediumblue:"#0000cd",lightcoral:"#f08080",darkturquoise:"#00ced1",lightcyan:"#e0ffff",ivory:"#fffff0",lightyellow:"#ffffe0",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",linen:"#faf0e6",mediumaquamarine:"#66cdaa",lemonchiffon:"#fffacd",lime:"#00ff00",khaki:"#f0e68c",mediumseagreen:"#3cb371",limegreen:"#32cd32",mediumspringgreen:"#00fa9a",lightskyblue:"#87cefa",lightblue:"#add8e6",midnightblue:"#191970",lightpink:"#ffb6c1",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",mintcream:"#f5fffa",lightslategray:"#778899",lightslategrey:"#778899",navajowhite:"#ffdead",navy:"#000080",mediumvioletred:"#c71585",powderblue:"#b0e0e6",palegoldenrod:"#eee8aa",oldlace:"#fdf5e6",paleturquoise:"#afeeee",mediumturquoise:"#48d1cc",mediumorchid:"#ba55d3",rebeccapurple:"#663399",lightsteelblue:"#b0c4de",mediumslateblue:"#7b68ee",thistle:"#d8bfd8",tan:"#d2b48c",orchid:"#da70d6",mediumpurple:"#9370db",purple:"#800080",pink:"#ffc0cb",skyblue:"#87ceeb",springgreen:"#00ff7f",palegreen:"#98fb98",red:"#ff0000",yellow:"#ffff00",slateblue:"#6a5acd",lavenderblush:"#fff0f5",peru:"#cd853f",palevioletred:"#db7093",violet:"#ee82ee",teal:"#008080",slategray:"#708090",slategrey:"#708090",aliceblue:"#f0f8ff",darkseagreen:"#8fbc8f",darkolivegreen:"#556b2f",greenyellow:"#adff2f",seagreen:"#2e8b57",seashell:"#fff5ee",tomato:"#ff6347",silver:"#c0c0c0",sienna:"#a0522d",lavender:"#e6e6fa",lightgreen:"#90ee90",orange:"#ffa500",orangered:"#ff4500",steelblue:"#4682b4",royalblue:"#4169e1",turquoise:"#40e0d0",yellowgreen:"#9acd32",salmon:"#fa8072",saddlebrown:"#8b4513",sandybrown:"#f4a460",rosybrown:"#bc8f8f",darksalmon:"#e9967a",lightgoldenrodyellow:"#fafad2",snow:"#fffafa",lightgrey:"#d3d3d3",lightgray:"#d3d3d3",dimgray:"#696969",dimgrey:"#696969",olivedrab:"#6b8e23",olive:"#808000"},I={};for(var n in t)I[t[n]]=n;var i={};e.prototype.toName=function(g){if(!(this.rgba.a||this.rgba.r||this.rgba.g||this.rgba.b))return"transparent";var n,C,o=I[this.toHex()];if(o)return o;if(null==g?void 0:g.closest){var a=this.toRgb(),s=1/0,l="black";if(!i.length)for(var r in t)i[r]=new e(t[r]).toRgb();for(var A in t){var c=(n=a,C=i[A],Math.pow(n.r-C.r,2)+Math.pow(n.g-C.g,2)+Math.pow(n.b-C.b,2));c<s&&(s=c,l=A)}return l}},g.string.push([function(g){var I=g.toLowerCase(),n="transparent"===I?"#0000":t[I];return n?new e(n).toRgb():null},"name"])}]);const kY={rgb:"toRgb",hsl:"toHsl",hsv:"toHsv",hex:"toHex"};function MY(e,{format:g,hasAlpha:t,isString:I}){const n=e[kY[g]+(I&&"hex"!==g?"String":"")]();return"object"!=typeof n||t?n:function(e,g){const t=cR({},e);return["a"].forEach((g=>g in e&&delete t[g])),t}(n)}Ey.extend({color:()=>e=>eS(e).isValid()});const LY=(e,g)=>{const t=eS(e);if(!t.isValid())throw Error("Invalid color");return MY(t,g)};var JY=Object.freeze({__proto__:null,schema:e=>Ey().color().test(e),sanitize:LY,format:(e,g)=>MY(eS(e),cR(cR({},g),{},{isString:!0,format:"hex"})),normalize:({value:e})=>{const g=function(e){return jX(e)[1]}(e),t={format:"name"===g?"hex":g,hasAlpha:"object"==typeof e?"a"in e:"hex"===g&&8===e.length||/^(rgba)|(hsla)|(hsva)/.test(e),isString:"string"==typeof e};return{value:LY(e,t),settings:t}}});const EY=IV("div",{position:"relative",boxSizing:"border-box",borderRadius:"$sm",overflow:"hidden",cursor:"pointer",height:"$rowHeight",width:"$rowHeight",backgroundColor:"#fff",backgroundImage:'url(\'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill-opacity=".05"><path d="M8 0h8v8H8zM0 8h8v8H0z"/></svg>\')',$inputStyle:"",$hover:"",zIndex:1,variants:{active:{true:{$inputStyle:"$accent1"}}},"&::before":{content:'""',position:"absolute",top:0,bottom:0,right:0,left:0,backgroundColor:"currentColor",zIndex:1}}),TY=IV("div",{position:"relative",display:"grid",gridTemplateColumns:"$sizes$rowHeight auto",columnGap:"$colGap",alignItems:"center"}),UY=IV("div",{width:"$colorPickerWidth",height:"$colorPickerHeight",".react-colorful":{width:"100%",height:"100%",boxShadow:"$level2",cursor:"crosshair"},".react-colorful__saturation":{borderRadius:"$sm $sm 0 0"},".react-colorful__alpha, .react-colorful__hue":{height:10},".react-colorful__last-control":{borderRadius:"0 0 $sm $sm"},".react-colorful__pointer":{height:12,width:12}});function QY(e,g){return"rgb"!==g?eS(e).toRgb():e}function DY({value:e,displayValue:t,settings:I,onUpdate:n}){const{emitOnEditStart:i,emitOnEditEnd:C}=PR(),{format:o,hasAlpha:a}=I,{popinRef:s,wrapperRef:l,shown:r,show:A,hide:c}=zY(),d=(0,g.useRef)(0),[u,h]=(0,g.useState)((()=>QY(e,o))),b=a?XS:YS,m=()=>{c(),C(),window.clearTimeout(d.current)};return(0,g.useEffect)((()=>()=>window.clearTimeout(d.current)),[]),g.createElement(g.Fragment,null,g.createElement(EY,{ref:s,active:r,onClick:()=>(h(QY(e,o)),A(),void i()),style:{color:t}}),r&&g.createElement(SV,null,g.createElement(RV,{onPointerUp:m}),g.createElement(UY,{ref:l,onMouseEnter:()=>window.clearTimeout(d.current),onMouseLeave:e=>0===e.buttons&&void(d.current=window.setTimeout(m,500))},g.createElement(b,{color:u,onChange:n}))))}var OY=cR({component:function(){const{value:e,displayValue:t,label:I,onChange:n,onUpdate:i,settings:C}=PR();return g.createElement(MV,{input:!0},g.createElement(NV,null,I),g.createElement(TY,null,g.createElement(DY,{value:e,displayValue:t,onChange:n,onUpdate:i,settings:C}),g.createElement(hV,{value:t,onChange:n,onUpdate:i})))}},JY),jY=cR({component:function(){const{label:e,displayValue:t,onUpdate:I,settings:n}=PR();return g.createElement(MV,{input:!0},g.createElement(NV,null,e),g.createElement(BX,{value:t,settings:n,onUpdate:I}))}},wX(["x","y","z"]));const PY=IV("div",{$flexCenter:"",position:"relative",backgroundColor:"$elevation3",borderRadius:"$sm",cursor:"pointer",height:"$rowHeight",width:"$rowHeight",touchAction:"none",$draggable:"",$hover:"","&:active":{cursor:"none"},"&::after":{content:'""',backgroundColor:"$accent2",height:4,width:4,borderRadius:2}}),_Y=IV("div",{$flexCenter:"",width:"$joystickWidth",height:"$joystickHeight",borderRadius:"$sm",boxShadow:"$level2",position:"fixed",zIndex:1e4,overflow:"hidden",$draggable:"",transform:"translate(-50%, -50%)",variants:{isOutOfBounds:{true:{backgroundColor:"$elevation1"},false:{backgroundColor:"$elevation3"}}},"> div":{position:"absolute",$flexCenter:"",borderStyle:"solid",borderWidth:1,borderColor:"$highlight1",backgroundColor:"$elevation3",width:"80%",height:"80%","&::after,&::before":{content:'""',position:"absolute",zindex:10,backgroundColor:"$highlight1"},"&::before":{width:"100%",height:1},"&::after":{height:"100%",width:1}},"> span":{position:"relative",zindex:100,width:10,height:10,backgroundColor:"$accent2",borderRadius:"50%"}});function qY({value:e,settings:t,onUpdate:I}){const n=(0,g.useRef)(),i=(0,g.useRef)(0),C=(0,g.useRef)(0),o=(0,g.useRef)(1),[a,s]=(0,g.useState)(!1),[l,r]=(0,g.useState)(!1),[A,c]=EV(),d=(0,g.useRef)(null),u=(0,g.useRef)(null);(0,g.useLayoutEffect)((()=>{if(a){const{top:e,left:g,width:t,height:I}=d.current.getBoundingClientRect();u.current.style.left=g+t/2+"px",u.current.style.top=e+I/2+"px"}}),[a]);const{keys:[h,b],joystick:m}=t,p="invertY"===m?1:-1,{[h]:{step:G},[b]:{step:B}}=t,Z=sV("sizes","joystickWidth"),y=sV("sizes","joystickHeight"),v=.8*parseFloat(Z)/2,W=.8*parseFloat(y)/2,f=(0,g.useCallback)((()=>{n.current||(r(!0),i.current&&c({x:i.current*v}),C.current&&c({y:C.current*-W}),n.current=window.setInterval((()=>{I((e=>{const g=G*i.current*o.current,t=p*B*C.current*o.current;return Array.isArray(e)?{[h]:e[0]+g,[b]:e[1]+t}:{[h]:e[h]+g,[b]:e[b]+t}}))}),16))}),[v,W,I,c,G,B,h,b,p]),w=(0,g.useCallback)((()=>{window.clearTimeout(n.current),n.current=void 0,r(!1)}),[]);(0,g.useEffect)((()=>{function e(e){o.current=LR(e)}return window.addEventListener("keydown",e),window.addEventListener("keyup",e),()=>{window.clearTimeout(n.current),window.removeEventListener("keydown",e),window.removeEventListener("keyup",e)}}),[]);const R=JV((({first:g,active:t,delta:[n,a],movement:[l,r]})=>{g&&s(!0);const A=dR(l,-v,v),d=dR(r,-W,W);i.current=Math.abs(l)>Math.abs(A)?Math.sign(l-A):0,C.current=Math.abs(r)>Math.abs(d)?Math.sign(d-r):0;let u=e[h],m=e[b];t?(i.current||(u+=n*G*o.current,c({x:A})),C.current||(m-=p*a*B*o.current,c({y:d})),i.current||C.current?f():w(),I({[h]:u,[b]:m})):(s(!1),i.current=0,C.current=0,c({x:0,y:0}),w())}));return g.createElement(PY,OR({ref:d},R()),a&&g.createElement(SV,null,g.createElement(_Y,{ref:u,isOutOfBounds:l},g.createElement("div",null),g.createElement("span",{ref:A}))))}const $Y=IV("div",{display:"grid",columnGap:"$colGap",variants:{withJoystick:{true:{gridTemplateColumns:"$sizes$rowHeight auto"},false:{gridTemplateColumns:"auto"}}}}),eK=["joystick"],gK=wX(["x","y"]);var tK=cR(cR({component:function(){const{label:e,displayValue:t,onUpdate:I,settings:n}=PR();return g.createElement(MV,{input:!0},g.createElement(NV,null,e),g.createElement($Y,{withJoystick:!!n.joystick},n.joystick&&g.createElement(qY,{value:t,settings:n,onUpdate:I}),g.createElement(BX,{value:t,settings:n,onUpdate:I})))}},gK),{},{normalize:e=>{let{joystick:g=!0}=e,t=Pw(e,eK);const{value:I,settings:n}=gK.normalize(t);return{value:I,settings:cR(cR({},n),{},{joystick:g})}}}),IK=Object.freeze({__proto__:null,sanitize:e=>{if(void 0!==e){if(e instanceof File)try{return URL.createObjectURL(e)}catch(e){return}if("string"==typeof e&&0===e.indexOf("blob:"))return e;throw Error("Invalid image format [undefined | blob |File].")}},schema:(e,g)=>"object"==typeof g&&"image"in g,normalize:({image:e})=>({value:e})});const nK=IV("div",{position:"relative",display:"grid",gridTemplateColumns:"$sizes$rowHeight auto 20px",columnGap:"$colGap",alignItems:"center"}),iK=IV("div",{$flexCenter:"",overflow:"hidden",height:"$rowHeight",background:"$elevation3",textAlign:"center",color:"inherit",borderRadius:"$sm",outline:"none",userSelect:"none",cursor:"pointer",$inputStyle:"",$hover:"",$focusWithin:"",$active:"$accent1 $elevation1",variants:{isDragAccept:{true:{$inputStyle:"$accent1",backgroundColor:"$elevation1"}}}}),CK=IV("div",{boxSizing:"border-box",borderRadius:"$sm",height:"$rowHeight",width:"$rowHeight",$inputStyle:"",backgroundSize:"cover",backgroundPosition:"center",variants:{hasImage:{true:{cursor:"pointer",$hover:"",$active:""}}}}),oK=IV("div",{$flexCenter:"",width:"$imagePreviewWidth",height:"$imagePreviewHeight",borderRadius:"$sm",boxShadow:"$level2",pointerEvents:"none",$inputStyle:"",backgroundSize:"cover",backgroundPosition:"center"}),aK=IV("div",{fontSize:"0.8em",height:"100%",padding:"$rowGap $md"}),sK=IV("div",{$flexCenter:"",top:"0",right:"0",marginRight:"$sm",height:"100%",cursor:"pointer",variants:{disabled:{true:{color:"$elevation3",cursor:"default"}}},"&::after,&::before":{content:'""',position:"absolute",height:2,width:10,borderRadius:1,backgroundColor:"currentColor"},"&::after":{transform:"rotate(45deg)"},"&::before":{transform:"rotate(-45deg)"}});var lK=cR({component:function(){const{label:e,value:t,onUpdate:I,disabled:n}=PR(),{popinRef:i,wrapperRef:C,shown:o,show:a,hide:s}=zY(),l=(0,g.useCallback)((e=>{e.length&&I(e[0])}),[I]),r=(0,g.useCallback)((e=>{e.stopPropagation(),I(void 0)}),[I]),{getRootProps:A,getInputProps:c,isDragAccept:d}=SY({maxFiles:1,accept:"image/*",onDrop:l,disabled:n});return g.createElement(MV,{input:!0},g.createElement(NV,null,e),g.createElement(nK,null,g.createElement(CK,{ref:i,hasImage:!!t,onPointerDown:()=>!!t&&a(),onPointerUp:s,style:{backgroundImage:t?`url(${t})`:"none"}}),o&&!!t&&g.createElement(SV,null,g.createElement(RV,{onPointerUp:s,style:{cursor:"pointer"}}),g.createElement(oK,{ref:C,style:{backgroundImage:`url(${t})`}})),g.createElement(iK,A({isDragAccept:d}),g.createElement("input",c()),g.createElement(aK,null,d?"drop image":"click or drop")),g.createElement(sK,{onClick:r,disabled:!t})))}},IK);const rK=Ey().number(),AK=e=>({min:e[0],max:e[1]}),cK=(e,{bounds:[g,t]},I)=>{const n=Array.isArray(e)?AK(e):e,i={min:I[0],max:I[1]},{min:C,max:o}=cR(cR({},i),n);return[dR(Number(C),g,Math.max(g,o)),dR(Number(o),Math.min(t,C),t)]};var dK=Object.freeze({__proto__:null,schema:(e,g)=>Ey().array().length(2).every.number().test(e)&&Ey().schema({min:rK,max:rK}).test(g),format:AK,sanitize:cK,normalize:({value:e,min:g,max:t})=>{const I={min:g,max:t},n=[g,t],i=cR(cR({},ZX(AK(e),{min:I,max:I})),{},{bounds:n});return{value:cK(AK(e),i,e),settings:i}}});const uK=["value","bounds","onDrag"],hK=["bounds"],bK=IV("div",{display:"grid",columnGap:"$colGap",gridTemplateColumns:"auto calc($sizes$numberInputMinWidth * 2 + $space$rowGap)"});function mK(e){let{value:t,bounds:[I,n],onDrag:i}=e,C=Pw(e,uK);const o=(0,g.useRef)(null),a=(0,g.useRef)(null),s=(0,g.useRef)(null),l=(0,g.useRef)(0),r=sV("sizes","scrubberWidth"),A=JV((({event:e,first:g,xy:[A],movement:[c],memo:d={}})=>{if(g){const{width:g,left:i}=o.current.getBoundingClientRect();l.current=g-parseFloat(r);const C=(null==e?void 0:e.target)===a.current||(null==e?void 0:e.target)===s.current;d.pos=pR((A-i)/g,I,n);const c=Math.abs(d.pos-t.min)-Math.abs(d.pos-t.max);d.key=c<0||0===c&&d.pos<=t.min?"min":"max",C&&(d.pos=t[d.key])}const u=d.pos+pR(c/l.current,0,n-I);return i({[d.key]:eX(u,C[d.key])}),d})),c=`calc(${mR(t.min,I,n)} * (100% - ${r} - 8px) + 4px)`,d=`calc(${1-mR(t.max,I,n)} * (100% - ${r} - 8px) + 4px)`;return g.createElement(jV,OR({ref:o},A()),g.createElement(DV,null,g.createElement(PV,{style:{left:c,right:d}})),g.createElement(OV,{position:"left",ref:a,style:{left:c}}),g.createElement(OV,{position:"right",ref:s,style:{right:d}}))}var pK=cR({component:function(){const{label:e,displayValue:t,onUpdate:I,settings:n}=PR(),i=Pw(n,hK);return g.createElement(g.Fragment,null,g.createElement(MV,{input:!0},g.createElement(NV,null,e),g.createElement(bK,null,g.createElement(mK,OR({value:t},n,{onDrag:I})),g.createElement(BX,{value:t,settings:i,onUpdate:I,innerLabelTrim:0}))))}},dK);const GK=["type","value"],BK=["onChange","transient","onEditStart","onEditEnd"];new function(){const e=function(e){const t="function"==typeof e?function(e){let g;const t=new Set,I=(e,I)=>{const n="function"==typeof e?e(g):e;if(n!==g){const e=g;g=I?n:Object.assign({},g,n),t.forEach((t=>t(g,e)))}},n=()=>g,i={setState:I,getState:n,subscribe:(e,I,i)=>I||i?((e,I=n,i=Object.is)=>{console.warn("[DEPRECATED] Please use `subscribeWithSelector` middleware");let C=I(g);function o(){const t=I(g);if(!i(C,t)){const g=C;e(C=t,g)}}return t.add(o),()=>t.delete(o)})(e,I,i):(t.add(e),()=>t.delete(e)),destroy:()=>t.clear()};return g=e(I,n,i),i}(e):e,I=(e=t.getState,I=Object.is)=>{const[,n]=(0,g.useReducer)((e=>e+1),0),i=t.getState(),C=(0,g.useRef)(i),o=(0,g.useRef)(e),a=(0,g.useRef)(I),s=(0,g.useRef)(!1),l=(0,g.useRef)();let r;void 0===l.current&&(l.current=e(i));let A=!1;(C.current!==i||o.current!==e||a.current!==I||s.current)&&(r=e(i),A=!I(l.current,r)),HY((()=>{A&&(l.current=r),C.current=i,o.current=e,a.current=I,s.current=!1}));const c=(0,g.useRef)(i);HY((()=>{const e=()=>{try{const e=t.getState(),g=o.current(e);a.current(l.current,g)||(C.current=e,l.current=g,n())}catch(e){s.current=!0,n()}},g=t.subscribe(e);return t.getState()!==c.current&&e(),g}),[]);const d=A?r:l.current;return(0,g.useDebugValue)(d),d};return Object.assign(I,t),I[Symbol.iterator]=function(){console.warn("[useStore, api] = create() is deprecated and will be removed in v4");const e=[I,t];return{next(){const g=e.length<=0;return{value:e.shift(),done:g}}}},I}((()=>({data:{}}),(e,g,t)=>{const I=t.subscribe;return t.subscribe=(e,g,n)=>{let i=e;if(g){const I=(null==n?void 0:n.equalityFn)||Object.is;let C=e(t.getState());i=t=>{const n=e(t);if(!I(C,n)){const e=C;g(C=n,e)}},(null==n?void 0:n.fireImmediately)&&g(C,C)}return I(i)},{data:{}}}));const t=(()=>{const e=new Map;return{on:(g,t)=>{let I=e.get(g);void 0===I&&(I=new Set,e.set(g,I)),I.add(t)},off:(g,t)=>{const I=e.get(g);void 0!==I&&(I.delete(t),0===I.size&&e.delete(g))},emit:(g,...t)=>{const I=e.get(g);if(void 0!==I)for(const e of I)e(...t)}}})();this.storeId="_"+Math.random().toString(36).substr(2,9),this.useStore=e;const I={},n=new Set;this.getVisiblePaths=()=>{const e=this.getData(),g=Object.keys(e),t=[];Object.entries(I).forEach((([e,I])=>{I.render&&g.some((g=>0===g.indexOf(e)))&&!I.render(this.get)&&t.push(e+".")}));const i=[];return n.forEach((g=>{g in e&&e[g].__refCount>0&&t.every((e=>-1===g.indexOf(e)))&&(!e[g].render||e[g].render(this.get))&&i.push(g)})),i},this.setOrderedPaths=e=>{e.forEach((e=>n.add(e)))},this.orderPaths=e=>(this.setOrderedPaths(e),e),this.disposePaths=g=>{e.setState((e=>{const t=e.data;return g.forEach((e=>{if(e in t){const g=t[e];g.__refCount--,0===g.__refCount&&g.type in VR&&delete t[e]}})),{data:t}}))},this.dispose=()=>{e.setState((()=>({data:{}})))},this.getFolderSettings=e=>I[e]||{},this.getData=()=>e.getState().data,this.addData=(g,t)=>{e.setState((e=>{const I=e.data;return Object.entries(g).forEach((([e,g])=>{let n=I[e];if(n){const{type:e,value:I}=g,i=Pw(g,GK);e!==n.type?eR(_w.INPUT_TYPE_OVERRIDE,e):((0===n.__refCount||t)&&Object.assign(n,i),n.__refCount++)}else I[e]=cR(cR({},g),{},{__refCount:1})})),{data:I}}))},this.setValueAtPath=(g,t,I)=>{e.setState((e=>{const n=e.data;return xR(n[g],t,g,this,I),{data:n}}))},this.setSettingsAtPath=(g,t)=>{e.setState((e=>{const I=e.data;return I[g].settings=cR(cR({},I[g].settings),t),{data:I}}))},this.disableInputAtPath=(g,t)=>{e.setState((e=>{const I=e.data;return I[g].disabled=t,{data:I}}))},this.set=(g,t)=>{e.setState((e=>{const I=e.data;return Object.entries(g).forEach((([e,g])=>{try{xR(I[e],g,void 0,void 0,t)}catch(e){}})),{data:I}}))},this.getInput=e=>{try{return this.getData()[e]}catch(g){eR(_w.PATH_DOESNT_EXIST,e)}},this.get=e=>{var g;return null===(g=this.getInput(e))||void 0===g?void 0:g.value},this.emitOnEditStart=e=>{t.emit(`onEditStart:${e}`,this.get(e),e,cR(cR({},this.getInput(e)),{},{get:this.get}))},this.emitOnEditEnd=e=>{t.emit(`onEditEnd:${e}`,this.get(e),e,cR(cR({},this.getInput(e)),{},{get:this.get}))},this.subscribeToEditStart=(e,g)=>{const I=`onEditStart:${e}`;return t.on(I,g),()=>t.off(I,g)},this.subscribeToEditEnd=(e,g)=>{const I=`onEditEnd:${e}`;return t.on(I,g),()=>t.off(I,g)};const i=(e,g,t)=>{const n={};return Object.entries(e).forEach((([e,C])=>{if(""===e)return eR(_w.EMPTY_KEY);let o=xY(g,e);if(C.type===VR.FOLDER){const e=i(C.schema,o,t);Object.assign(n,e),o in I||(I[o]=C.settings)}else if(e in t)eR(_w.DUPLICATE_KEYS,e,o,t[e].path);else{const g=FR(C,e,o,n);if(g){const{type:I,options:i,input:C}=g,{onChange:a,transient:s,onEditStart:l,onEditEnd:r}=i,A=Pw(i,BK);n[o]=cR(cR(cR({type:I},A),C),{},{fromPanel:!0}),t[e]={path:o,onChange:a,transient:s,onEditStart:l,onEditEnd:r}}else eR(_w.UNKNOWN_INPUT,o,C)}})),n};this.getDataFromSchema=e=>{const g={};return[i(e,"",g),g]}};const ZK=e=>"__levaInput"in e,yK=["type","label","path","valueKey","value","settings","setValue","disabled"];function vK(e){let{type:t,label:I,path:n,valueKey:i,value:C,settings:o,setValue:a,disabled:s}=e,l=Pw(e,yK);const{displayValue:r,onChange:A,onUpdate:c}=LV({type:t,value:C,settings:o,setValue:a}),d=CR[t].component;return d?g.createElement(jR.Provider,{value:cR({key:i,path:n,id:""+n,label:I,displayValue:r,value:C,onChange:A,onUpdate:c,settings:o,setValue:a,disabled:s},l)},g.createElement(wV,{disabled:s},g.createElement(d,null))):(eR(_w.NO_COMPONENT_FOR_TYPE,t,n),null)}const WK=IV("button",{display:"block",$reset:"",fontWeight:"$button",height:"$rowHeight",borderStyle:"none",borderRadius:"$sm",backgroundColor:"$elevation1",color:"$highlight1","&:not(:disabled)":{color:"$highlight3",backgroundColor:"$accent2",cursor:"pointer",$hover:"$accent3",$active:"$accent3 $accent1",$focus:""}}),fK=IV("div",{$flex:"",justifyContent:"flex-end",gap:"$colGap"}),wK=IV("button",{$reset:"",cursor:"pointer",borderRadius:"$xs","&:hover":{backgroundColor:"$elevation3"}}),RK=IV("canvas",{height:"$monitorHeight",width:"100%",display:"block",borderRadius:"$sm"}),VK=(0,g.forwardRef)((function({initialValue:e},t){const I=sV("colors","highlight3"),n=sV("colors","elevation2"),i=sV("colors","highlight1"),[C,o]=(0,g.useMemo)((()=>[eS(i).alpha(.4).toRgbString(),eS(i).alpha(.1).toRgbString()]),[i]),a=(0,g.useRef)([e]),s=(0,g.useRef)(e),l=(0,g.useRef)(e),r=(0,g.useRef)(),A=(0,g.useCallback)(((e,g)=>{if(!e)return;const{width:t,height:i}=e,r=new Path2D,A=t/100,c=.05*i;for(let e=0;e<a.current.length;e++){const g=A*e,t=i-mR(a.current[e],s.current,l.current)*(i-2*c)-c;r.lineTo(g,t)}g.clearRect(0,0,t,i);const d=new Path2D(r);d.lineTo(A*(a.current.length+1),i),d.lineTo(0,i),d.lineTo(0,0);const u=g.createLinearGradient(0,0,0,i);u.addColorStop(0,C),u.addColorStop(1,o),g.fillStyle=u,g.fill(d),g.strokeStyle=n,g.lineJoin="round",g.lineWidth=14,g.stroke(r),g.strokeStyle=I,g.lineWidth=2,g.stroke(r)}),[I,n,C,o]),[c,d]=function(e){const t=(0,g.useRef)(null),I=(0,g.useRef)(null),n=(0,g.useRef)(!1);return(0,g.useEffect)((()=>{const g=MR((()=>{t.current.width=t.current.offsetWidth*window.devicePixelRatio,t.current.height=t.current.offsetHeight*window.devicePixelRatio,e(t.current,I.current)}),250);return window.addEventListener("resize",g),n.current||(g(),n.current=!0),()=>window.removeEventListener("resize",g)}),[e]),(0,g.useEffect)((()=>{I.current=t.current.getContext("2d")}),[]),[t,I]}(A);return(0,g.useImperativeHandle)(t,(()=>({frame:e=>{(void 0===s.current||e<s.current)&&(s.current=e),(void 0===l.current||e>l.current)&&(l.current=e),function(e,g){e.push(g),e.length>100&&e.shift()}(a.current,e),r.current=requestAnimationFrame((()=>A(c.current,d.current)))}})),[c,d,A]),(0,g.useEffect)((()=>()=>cancelAnimationFrame(r.current)),[]),g.createElement(RK,{ref:c})})),XK=e=>Number.isFinite(e)?e.toPrecision(2):e.toString(),SK=(0,g.forwardRef)((function({initialValue:e},t){const[I,n]=(0,g.useState)(XK(e));return(0,g.useImperativeHandle)(t,(()=>({frame:e=>n(XK(e))})),[]),g.createElement("div",null,I)}));function YK(e){return"function"==typeof e?e():e.current}const KK=["type","label","key"],HK={[VR.BUTTON]:function({onClick:e,settings:t,label:I}){const n=eV();return g.createElement(MV,null,g.createElement(WK,{disabled:t.disabled,onClick:()=>e(n.get)},I))},[VR.BUTTON_GROUP]:function(e){const{label:t,opts:I}=(({label:e,opts:g})=>{let t="string"==typeof e&&""===e.trim()?null:e,I=g;return"object"==typeof g.opts&&(void 0!==I.label&&(t=g.label),I=g.opts),{label:t,opts:I}})(e),n=eV();return g.createElement(MV,{input:!!t},t&&g.createElement(NV,null,t),g.createElement(fK,null,Object.entries(I).map((([e,t])=>g.createElement(wK,{key:e,onClick:()=>t(n.get)},e)))))},[VR.MONITOR]:function({label:e,objectOrFn:t,settings:I}){const n=(0,g.useRef)(),i=(0,g.useRef)(YK(t));return(0,g.useEffect)((()=>{const e=window.setInterval((()=>{var e;document.hidden||null===(e=n.current)||void 0===e||e.frame(YK(t))}),I.interval);return()=>window.clearInterval(e)}),[t,I.interval]),g.createElement(MV,{input:!0},g.createElement(NV,{align:"top"},e),I.graph?g.createElement(VK,{ref:n,initialValue:i.current}):g.createElement(SK,{ref:n,initialValue:i.current}))}},NK=g.memo((({path:e})=>{const[t,{set:I,setSettings:n,disable:i,storeId:C,emitOnEditStart:o,emitOnEditEnd:a}]=function(e){const t=eV(),[I,n]=(0,g.useState)(UV(t.getData(),e)),i=(0,g.useCallback)((g=>t.setValueAtPath(e,g,!0)),[e,t]),C=(0,g.useCallback)((g=>t.setSettingsAtPath(e,g)),[e,t]),o=(0,g.useCallback)((g=>t.disableInputAtPath(e,g)),[e,t]),a=(0,g.useCallback)((()=>t.emitOnEditStart(e)),[e,t]),s=(0,g.useCallback)((()=>t.emitOnEditEnd(e)),[e,t]);return(0,g.useEffect)((()=>{n(UV(t.getData(),e));const g=t.useStore.subscribe((g=>UV(g.data,e)),n,{equalityFn:yy});return()=>g()}),[t,e]),[I,{set:i,setSettings:C,disable:o,storeId:t.storeId,emitOnEditStart:a,emitOnEditEnd:s}]}(e);if(!t)return null;const{type:s,label:l,key:r}=t,A=Pw(t,KK);if(s in VR){const t=HK[s];return g.createElement(t,OR({label:l,path:e},A))}return s in CR?g.createElement(vK,OR({key:C+e,type:s,label:l,storeId:C,path:e,valueKey:r,setValue:I,setSettings:n,disable:i,emitOnEditStart:o,emitOnEditEnd:a},A)):(gR(_w.UNSUPPORTED_INPUT,s,e),null)}));function FK({toggle:e,toggled:t,name:I}){return g.createElement(GV,{onClick:()=>e()},g.createElement(zV,{toggled:t}),g.createElement("div",null,I))}const xK=({name:e,path:t,tree:I})=>{const n=eV(),i=xY(t,e),{collapsed:C,color:o}=n.getFolderSettings(i),[a,s]=(0,g.useState)(!C),l=(0,g.useRef)(null),r=sV("colors","folderWidgetColor"),A=sV("colors","folderTextColor");return(0,g.useLayoutEffect)((()=>{l.current.style.setProperty("--leva-colors-folderWidgetColor",o||r),l.current.style.setProperty("--leva-colors-folderTextColor",o||A)}),[o,r,A]),g.createElement(mV,{ref:l},g.createElement(FK,{name:e,toggled:a,toggle:()=>s((e=>!e))}),g.createElement(zK,{parent:i,tree:I,toggled:a}))},zK=g.memo((({isRoot:e=!1,fill:t=!1,flat:I=!1,parent:n,tree:i,toggled:C})=>{const{wrapperRef:o,contentRef:a}=function(e){const t=(0,g.useRef)(null),I=(0,g.useRef)(null),n=(0,g.useRef)(!0);return(0,g.useLayoutEffect)((()=>{e||(t.current.style.height="0px",t.current.style.overflow="hidden")}),[]),(0,g.useEffect)((()=>{if(n.current)return void(n.current=!1);let g;const i=t.current,C=()=>{e&&(i.style.removeProperty("height"),i.style.removeProperty("overflow"),I.current.scrollIntoView({behavior:"smooth",block:"nearest"}))};i.addEventListener("transitionend",C,{once:!0});const{height:o}=I.current.getBoundingClientRect();return i.style.height=o+"px",e||(i.style.overflow="hidden",g=window.setTimeout((()=>i.style.height="0px"),50)),()=>{i.removeEventListener("transitionend",C),clearTimeout(g)}}),[e]),{wrapperRef:t,contentRef:I}}(C),s=eV(),l=([e,g])=>{var t;return(ZK(g)?null===(t=s.getInput(g.path))||void 0===t?void 0:t.order:s.getFolderSettings(xY(n,e)).order)||0},r=Object.entries(i).sort(((e,g)=>l(e)-l(g)));return g.createElement(pV,{ref:o,isRoot:e,fill:t,flat:I},g.createElement(BV,{ref:a,isRoot:e,toggled:C},r.map((([e,t])=>ZK(t)?g.createElement(NK,{key:t.path,valueKey:t.valueKey,path:t.path}):g.createElement(xK,{key:e,name:e,path:n,tree:t})))))})),kK=IV("div",{position:"relative",fontFamily:"$mono",fontSize:"$root",color:"$rootText",backgroundColor:"$elevation1",variants:{fill:{false:{position:"fixed",top:"10px",right:"10px",zIndex:1e3,width:"$rootWidth"},true:{position:"relative",width:"100%"}},flat:{false:{borderRadius:"$lg",boxShadow:"$level1"}},oneLineLabels:{true:{[`${yV}`]:{gridTemplateColumns:"auto",gridAutoColumns:"minmax(max-content, 1fr)",gridAutoRows:"minmax($sizes$rowHeight), auto)",rowGap:0,columnGap:0,marginTop:"$rowGap"}}},hideTitleBar:{true:{$$titleBarHeight:"0px"},false:{$$titleBarHeight:"$sizes$titleBarHeight"}}},"&,*,*:after,*:before":{boxSizing:"border-box"},"*::selection":{backgroundColor:"$accent2"}}),MK=IV("i",{$flexCenter:"",width:40,userSelect:"none",cursor:"pointer","> svg":{fill:"$highlight1",transition:"transform 350ms ease, fill 250ms ease"},"&:hover > svg":{fill:"$highlight3"},variants:{active:{true:{"> svg":{fill:"$highlight2"}}}}}),LK=IV("div",{display:"flex",alignItems:"stretch",justifyContent:"space-between",height:"$titleBarHeight",variants:{mode:{drag:{cursor:"grab"}}}}),JK=IV("div",{$flex:"",position:"relative",width:"100%",overflow:"hidden",transition:"height 250ms ease",color:"$highlight3",paddingLeft:"$md",[`> ${MK}`]:{height:30},variants:{toggled:{true:{height:30},false:{height:0}}}}),EK=IV("input",{$reset:"",flex:1,position:"relative",height:30,width:"100%",backgroundColor:"transparent",fontSize:"10px",borderRadius:"$root","&:focus":{},"&::placeholder":{color:"$highlight2"}}),TK=IV("div",{touchAction:"none",$flexCenter:"",flex:1,"> svg":{fill:"$highlight1"},color:"$highlight1",variants:{drag:{true:{$draggable:"","> svg":{transition:"fill 250ms ease"},"&:hover":{color:"$highlight3"},"&:hover > svg":{fill:"$highlight3"}}},filterEnabled:{false:{paddingRight:40}}}}),UK=g.forwardRef((({setFilter:e,toggle:t},I)=>{const[n,i]=(0,g.useState)(""),C=(0,g.useMemo)((()=>MR(e,250)),[e]);return(0,g.useEffect)((()=>{C(n)}),[n,C]),g.createElement(g.Fragment,null,g.createElement(EK,{ref:I,value:n,placeholder:"[Open filter with CMD+SHIFT+L]",onPointerDown:e=>e.stopPropagation(),onChange:e=>{const g=e.currentTarget.value;t(!0),i(g)}}),g.createElement(MK,{onClick:()=>(e(""),void i("")),style:{visibility:n?"visible":"hidden"}},g.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"14",width:"14",viewBox:"0 0 20 20",fill:"currentColor"},g.createElement("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"}))))}));function QK({setFilter:e,onDrag:t,onDragStart:I,onDragEnd:n,toggle:i,toggled:C,title:o,drag:a,filterEnabled:s,from:l}){const[r,A]=(0,g.useState)(!1),c=(0,g.useRef)(null);(0,g.useEffect)((()=>{var e,g;r?null===(e=c.current)||void 0===e||e.focus():null===(g=c.current)||void 0===g||g.blur()}),[r]);const d=JV((({offset:[e,g],first:i,last:C})=>{t({x:e,y:g}),i&&I({x:e,y:g}),C&&n({x:e,y:g})}),{filterTaps:!0,from:({offset:[e,g]})=>[(null==l?void 0:l.x)||e,(null==l?void 0:l.y)||g]});return(0,g.useEffect)((()=>{const e=e=>{"L"===e.key&&e.shiftKey&&e.metaKey&&A((e=>!e))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)}),[]),g.createElement(g.Fragment,null,g.createElement(LK,{mode:a?"drag":void 0},g.createElement(MK,{active:!C,onClick:()=>i()},g.createElement(zV,{toggled:C,width:12,height:8})),g.createElement(TK,OR({},a?d():{},{drag:a,filterEnabled:s}),void 0===o&&a?g.createElement("svg",{width:"20",height:"10",viewBox:"0 0 28 14",xmlns:"http://www.w3.org/2000/svg"},g.createElement("circle",{cx:"2",cy:"2",r:"2"}),g.createElement("circle",{cx:"14",cy:"2",r:"2"}),g.createElement("circle",{cx:"26",cy:"2",r:"2"}),g.createElement("circle",{cx:"2",cy:"12",r:"2"}),g.createElement("circle",{cx:"14",cy:"12",r:"2"}),g.createElement("circle",{cx:"26",cy:"12",r:"2"})):o),s&&g.createElement(MK,{active:r,onClick:()=>A((e=>!e))},g.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",height:"20",viewBox:"0 0 20 20"},g.createElement("path",{d:"M9 9a2 2 0 114 0 2 2 0 01-4 0z"}),g.createElement("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a4 4 0 00-3.446 6.032l-2.261 2.26a1 1 0 101.414 1.415l2.261-2.261A4 4 0 1011 5z",clipRule:"evenodd"})))),g.createElement(JK,{toggled:r},g.createElement(UK,{ref:c,setFilter:e,toggle:i})))}g.memo((({store:e,rootClass:t,fill:I=!1,flat:n=!1,neverHide:i=!1,oneLineLabels:C=!1,titleBar:o={title:void 0,drag:!0,filter:!0,position:void 0,onDrag:void 0,onDragStart:void 0,onDragEnd:void 0},hideCopyButton:a=!1,toggled:s,setToggle:l})=>{var r,A;const c=(e=>{const[t,I]=(0,g.useState)(e.getVisiblePaths());return(0,g.useEffect)((()=>{I(e.getVisiblePaths());const g=e.useStore.subscribe(e.getVisiblePaths,I,{equalityFn:yy});return()=>g()}),[e]),t})(e),[d,u]=(0,g.useState)(""),h=(0,g.useMemo)((()=>((e,g)=>{const t={},I=g?g.toLowerCase():null;return e.forEach((e=>{const[g,n]=function(e){const g=e.split(".");return[g.pop(),g.join(".")||void 0]}(e);(!I||g.toLowerCase().indexOf(I)>-1)&&FY()(t,n,{[g]:{__levaInput:!0,path:e}})})),t})(c,d)),[c,d]),[b,m]=EV(),p=i||c.length>0,G="object"==typeof o&&o.title||void 0,B="object"!=typeof o||null===(r=o.drag)||void 0===r||r,Z="object"!=typeof o||null===(A=o.filter)||void 0===A||A,y="object"==typeof o&&o.position||void 0,v="object"==typeof o&&o.onDrag||void 0,W="object"==typeof o&&o.onDragStart||void 0,f="object"==typeof o&&o.onDragEnd||void 0;return g.useEffect((()=>{m({x:null==y?void 0:y.x,y:null==y?void 0:y.y})}),[y,m]),aV(),g.createElement($R.Provider,{value:{hideCopyButton:a}},g.createElement(kK,{ref:b,className:t,fill:I,flat:n,oneLineLabels:C,hideTitleBar:!o,style:{display:p?"block":"none"}},o&&g.createElement(QK,{onDrag:e=>{m(e),null==v||v(e)},onDragStart:e=>null==W?void 0:W(e),onDragEnd:e=>null==f?void 0:f(e),setFilter:u,toggle:e=>l((g=>null!=e?e:!g)),toggled:s,title:G,drag:B,filterEnabled:Z,from:y}),p&&g.createElement(qR.Provider,{value:e},g.createElement(zK,{isRoot:!0,fill:I,flat:n,tree:h,toggled:s}))))})),aR(XR.SELECT,oX),aR(XR.IMAGE,lK),aR(XR.NUMBER,gX),aR(XR.COLOR,OY),aR(XR.STRING,AX),aR(XR.BOOLEAN,hX),aR(XR.INTERVAL,pK),aR(XR.VECTOR3D,jY),aR(XR.VECTOR2D,tK);var DK=Object.defineProperty,OK=(e,g,t)=>(((e,g,t)=>{g in e?DK(e,g,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[g]=t})(e,"symbol"!=typeof g?g+"":g,t),t);const jK={uniforms:{turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new UI},up:{value:new UI(0,1,0)}},vertexShader:"\n      uniform vec3 sunPosition;\n      uniform float rayleigh;\n      uniform float turbidity;\n      uniform float mieCoefficient;\n      uniform vec3 up;\n\n      varying vec3 vWorldPosition;\n      varying vec3 vSunDirection;\n      varying float vSunfade;\n      varying vec3 vBetaR;\n      varying vec3 vBetaM;\n      varying float vSunE;\n\n      // constants for atmospheric scattering\n      const float e = 2.71828182845904523536028747135266249775724709369995957;\n      const float pi = 3.141592653589793238462643383279502884197169;\n\n      // wavelength of used primaries, according to preetham\n      const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );\n      // this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:\n      // (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))\n      const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );\n\n      // mie stuff\n      // K coefficient for the primaries\n      const float v = 4.0;\n      const vec3 K = vec3( 0.686, 0.678, 0.666 );\n      // MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K\n      const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );\n\n      // earth shadow hack\n      // cutoffAngle = pi / 1.95;\n      const float cutoffAngle = 1.6110731556870734;\n      const float steepness = 1.5;\n      const float EE = 1000.0;\n\n      float sunIntensity( float zenithAngleCos ) {\n        zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );\n        return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );\n      }\n\n      vec3 totalMie( float T ) {\n        float c = ( 0.2 * T ) * 10E-18;\n        return 0.434 * c * MieConst;\n      }\n\n      void main() {\n\n        vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n        vWorldPosition = worldPosition.xyz;\n\n        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        gl_Position.z = gl_Position.w; // set z to camera.far\n\n        vSunDirection = normalize( sunPosition );\n\n        vSunE = sunIntensity( dot( vSunDirection, up ) );\n\n        vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );\n\n        float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );\n\n      // extinction (absorbtion + out scattering)\n      // rayleigh coefficients\n        vBetaR = totalRayleigh * rayleighCoefficient;\n\n      // mie coefficients\n        vBetaM = totalMie( turbidity ) * mieCoefficient;\n\n      }\n    ",fragmentShader:`\n      varying vec3 vWorldPosition;\n      varying vec3 vSunDirection;\n      varying float vSunfade;\n      varying vec3 vBetaR;\n      varying vec3 vBetaM;\n      varying float vSunE;\n\n      uniform float mieDirectionalG;\n      uniform vec3 up;\n\n      const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );\n\n      // constants for atmospheric scattering\n      const float pi = 3.141592653589793238462643383279502884197169;\n\n      const float n = 1.0003; // refractive index of air\n      const float N = 2.545E25; // number of molecules per unit volume for air at 288.15K and 1013mb (sea level -45 celsius)\n\n      // optical length at zenith for molecules\n      const float rayleighZenithLength = 8.4E3;\n      const float mieZenithLength = 1.25E3;\n      // 66 arc seconds -> degrees, and the cosine of that\n      const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;\n\n      // 3.0 / ( 16.0 * pi )\n      const float THREE_OVER_SIXTEENPI = 0.05968310365946075;\n      // 1.0 / ( 4.0 * pi )\n      const float ONE_OVER_FOURPI = 0.07957747154594767;\n\n      float rayleighPhase( float cosTheta ) {\n        return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );\n      }\n\n      float hgPhase( float cosTheta, float g ) {\n        float g2 = pow( g, 2.0 );\n        float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );\n        return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );\n      }\n\n      void main() {\n\n        vec3 direction = normalize( vWorldPosition - cameraPos );\n\n      // optical length\n      // cutoff angle at 90 to avoid singularity in next formula.\n        float zenithAngle = acos( max( 0.0, dot( up, direction ) ) );\n        float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );\n        float sR = rayleighZenithLength * inverse;\n        float sM = mieZenithLength * inverse;\n\n      // combined extinction factor\n        vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );\n\n      // in scattering\n        float cosTheta = dot( direction, vSunDirection );\n\n        float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );\n        vec3 betaRTheta = vBetaR * rPhase;\n\n        float mPhase = hgPhase( cosTheta, mieDirectionalG );\n        vec3 betaMTheta = vBetaM * mPhase;\n\n        vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );\n        Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );\n\n      // nightsky\n        float theta = acos( direction.y ); // elevation --\x3e y-axis, [-pi/2, pi/2]\n        float phi = atan( direction.z, direction.x ); // azimuth --\x3e x-axis [-pi/2, pi/2]\n        vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );\n        vec3 L0 = vec3( 0.1 ) * Fex;\n\n      // composition + solar disc\n        float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );\n        L0 += ( vSunE * 19000.0 * Fex ) * sundisk;\n\n        vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );\n\n        vec3 retColor = pow( texColor, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );\n\n        gl_FragColor = vec4( retColor, 1.0 );\n\n      #include <tonemapping_fragment>\n      #include <${vG>=154?"colorspace_fragment":"encodings_fragment"}>\n\n      }\n    `},PK=new rC({name:"SkyShader",fragmentShader:jK.fragmentShader,vertexShader:jK.vertexShader,uniforms:lC.clone(jK.uniforms),side:S,depthWrite:!1});class _K extends nC{constructor(){super(new CC(1,1,1),PK)}}function qK(e,g,t=new UI){const I=Math.PI*(e-.5),n=2*Math.PI*(g-.5);return t.x=Math.cos(n),t.y=Math.sin(I),t.z=Math.sin(n),t}OK(_K,"SkyShader",jK),OK(_K,"material",PK);const $K=g.forwardRef((({inclination:e=.6,azimuth:t=.1,distance:I=1e3,mieCoefficient:n=.005,mieDirectionalG:i=.8,rayleigh:C=.5,turbidity:o=10,sunPosition:a=qK(e,t),...s},l)=>{const r=g.useMemo((()=>(new UI).setScalar(I)),[I]),[A]=g.useState((()=>new _K));return g.createElement("primitive",qu({object:A,ref:l,"material-uniforms-mieCoefficient-value":n,"material-uniforms-mieDirectionalG-value":i,"material-uniforms-rayleigh-value":C,"material-uniforms-sunPosition-value":a,"material-uniforms-turbidity-value":o,scale:r},s))}));class eH extends nC{constructor(e,g){var t,I;const n=(i=e)&&i.isCubeTexture;var i;const C=(null!=(I=n?null==(t=e.image[0])?void 0:t.width:e.image.width)?I:1024)/4,o=Math.floor(Math.log2(C)),a=Math.pow(2,o),s=[n?"#define ENVMAP_TYPE_CUBE":"","#define CUBEUV_TEXEL_WIDTH "+1/(3*Math.max(a,112)),"#define CUBEUV_TEXEL_HEIGHT "+1/(4*a),`#define CUBEUV_MAX_MIP ${o}.0`].join("\n")+`\n        #define ENVMAP_TYPE_CUBE_UV\n        varying vec3 vWorldPosition;\n        uniform float radius;\n        uniform float height;\n        uniform float angle;\n        #ifdef ENVMAP_TYPE_CUBE\n            uniform samplerCube map;\n        #else\n            uniform sampler2D map;\n        #endif\n        // From: https://www.shadertoy.com/view/4tsBD7\n        float diskIntersectWithBackFaceCulling( vec3 ro, vec3 rd, vec3 c, vec3 n, float r ) \n        {\n            float d = dot ( rd, n );\n            \n            if( d > 0.0 ) { return 1e6; }\n            \n            vec3  o = ro - c;\n            float t = - dot( n, o ) / d;\n            vec3  q = o + rd * t;\n            \n            return ( dot( q, q ) < r * r ) ? t : 1e6;\n        }\n        // From: https://www.iquilezles.org/www/articles/intersectors/intersectors.htm\n        float sphereIntersect( vec3 ro, vec3 rd, vec3 ce, float ra ) \n        {\n            vec3 oc = ro - ce;\n            float b = dot( oc, rd );\n            float c = dot( oc, oc ) - ra * ra;\n            float h = b * b - c;\n            \n            if( h < 0.0 ) { return -1.0; }\n            \n            h = sqrt( h );\n            \n            return - b + h;\n        }\n        vec3 project() \n        {\n            vec3 p = normalize( vWorldPosition );\n            vec3 camPos = cameraPosition;\n            camPos.y -= height;\n            float intersection = sphereIntersect( camPos, p, vec3( 0.0 ), radius );\n            if( intersection > 0.0 ) {\n                \n                vec3 h = vec3( 0.0, - height, 0.0 );\n                float intersection2 = diskIntersectWithBackFaceCulling( camPos, p, h, vec3( 0.0, 1.0, 0.0 ), radius );\n                p = ( camPos + min( intersection, intersection2 ) * p ) / radius;\n            } else {\n                p = vec3( 0.0, 1.0, 0.0 );\n            }\n            return p;\n        }\n        #include <common>\n        #include <cube_uv_reflection_fragment>\n        void main() \n        {\n            vec3 projectedWorldPosition = project();\n            \n            #ifdef ENVMAP_TYPE_CUBE\n                vec3 outcolor = textureCube( map, projectedWorldPosition ).rgb;\n            #else\n                vec3 direction = normalize( projectedWorldPosition );\n                vec2 uv = equirectUv( direction );\n                vec3 outcolor = texture2D( map, uv ).rgb;\n            #endif\n            gl_FragColor = vec4( outcolor, 1.0 );\n            #include <tonemapping_fragment>\n            #include <${parseInt(p.replace(/\D+/g,""))>=154?"colorspace_fragment":"encodings_fragment"}>\n        }\n        `,l={map:{value:e},height:{value:(null==g?void 0:g.height)||15},radius:{value:(null==g?void 0:g.radius)||100}};super(new Hr(1,16),new rC({uniforms:l,fragmentShader:s,vertexShader:"\n        varying vec3 vWorldPosition;\n        void main() \n        {\n            vec4 worldPosition = ( modelMatrix * vec4( position, 1.0 ) );\n            vWorldPosition = worldPosition.xyz;\n            \n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }\n        ",side:Y}))}set radius(e){this.material.uniforms.radius.value=e}get radius(){return this.material.uniforms.radius.value}set height(e){this.material.uniforms.height.value=e}get height(){return this.material.uniforms.height.value}}class gH extends KA{constructor(e){super(e),this.type=Ue}parse(e){const g=function(e,g){switch(e){case 1:console.error("THREE.RGBELoader Read Error: "+(g||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(g||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(g||""));break;default:console.error("THREE.RGBELoader: Error: "+(g||""))}return-1},t=function(e,g,t){g=g||1024;let I=e.pos,n=-1,i=0,C="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(I,I+128)));for(;0>(n=o.indexOf("\n"))&&i<g&&I<e.byteLength;)C+=o,i+=o.length,I+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(I,I+128)));return-1<n&&(!1!==t&&(e.pos+=i+n+1),C+o.slice(0,n))},I=function(e,g,t,I){const n=e[g+3],i=Math.pow(2,n-128)/255;t[I+0]=e[g+0]*i,t[I+1]=e[g+1]*i,t[I+2]=e[g+2]*i,t[I+3]=1},n=function(e,g,t,I){const n=e[g+3],i=Math.pow(2,n-128)/255;t[I+0]=pi.toHalfFloat(Math.min(e[g+0]*i,65504)),t[I+1]=pi.toHalfFloat(Math.min(e[g+1]*i,65504)),t[I+2]=pi.toHalfFloat(Math.min(e[g+2]*i,65504)),t[I+3]=pi.toHalfFloat(1)},i=new Uint8Array(e);i.pos=0;const C=function(e){const I=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,n=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*FORMAT=(\S+)\s*$/,C=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let a,s;if(e.pos>=e.byteLength||!(a=t(e)))return g(1,"no header found");if(!(s=a.match(/^#\?(\S+)/)))return g(3,"bad initial token");for(o.valid|=1,o.programtype=s[1],o.string+=a+"\n";a=t(e),!1!==a;)if(o.string+=a+"\n","#"!==a.charAt(0)){if((s=a.match(I))&&(o.gamma=parseFloat(s[1])),(s=a.match(n))&&(o.exposure=parseFloat(s[1])),(s=a.match(i))&&(o.valid|=2,o.format=s[1]),(s=a.match(C))&&(o.valid|=4,o.height=parseInt(s[1],10),o.width=parseInt(s[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=a+"\n";return 2&o.valid?4&o.valid?o:g(3,"missing image size specifier"):g(3,"missing format specifier")}(i);if(-1!==C){const e=C.width,t=C.height,o=function(e,t,I){const n=t;if(n<8||n>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(n!==(e[2]<<8|e[3]))return g(3,"wrong scanline width");const i=new Uint8Array(4*t*I);if(!i.length)return g(4,"unable to allocate buffer space");let C=0,o=0;const a=4*n,s=new Uint8Array(4),l=new Uint8Array(a);let r=I;for(;r>0&&o<e.byteLength;){if(o+4>e.byteLength)return g(1);if(s[0]=e[o++],s[1]=e[o++],s[2]=e[o++],s[3]=e[o++],2!=s[0]||2!=s[1]||(s[2]<<8|s[3])!=n)return g(3,"bad rgbe scanline format");let t,I=0;for(;I<a&&o<e.byteLength;){t=e[o++];const n=t>128;if(n&&(t-=128),0===t||I+t>a)return g(3,"bad scanline data");if(n){const g=e[o++];for(let e=0;e<t;e++)l[I++]=g}else l.set(e.subarray(o,o+t),I),I+=t,o+=t}const A=n;for(let e=0;e<A;e++){let g=0;i[C]=l[e+g],g+=n,i[C+1]=l[e+g],g+=n,i[C+2]=l[e+g],g+=n,i[C+3]=l[e+g],C+=4}r--}return i}(i.subarray(i.pos),e,t);if(-1!==o){let g,i,a;switch(this.type){case Te:a=o.length/4;const e=new Float32Array(4*a);for(let g=0;g<a;g++)I(o,4*g,e,4*g);g=e,i=Te;break;case Ue:a=o.length/4;const t=new Uint16Array(4*a);for(let e=0;e<a;e++)n(o,4*e,t,4*e);g=t,i=Ue;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:e,height:t,data:g,header:C.string,gamma:C.gamma,exposure:C.exposure,type:i}}}return null}setDataType(e){return this.type=e,this}load(e,g,t,I){return super.load(e,(function(e,t){switch(e.type){case Te:case Ue:"colorSpace"in e?e.colorSpace="srgb-linear":e.encoding=3e3,e.minFilter=Ke,e.magFilter=Ke,e.generateMipmaps=!1,e.flipY=!0}g&&g(e,t)}),t,I)}}var tH=Uint8Array,IH=Uint16Array,nH=Uint32Array,iH=new tH([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),CH=new tH([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),oH=new tH([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),aH=function(e,g){for(var t=new IH(31),I=0;I<31;++I)t[I]=g+=1<<e[I-1];var n=new nH(t[30]);for(I=1;I<30;++I)for(var i=t[I];i<t[I+1];++i)n[i]=i-t[I]<<5|I;return[t,n]},sH=aH(iH,2),lH=sH[0],rH=sH[1];lH[28]=258,rH[258]=28;for(var AH=aH(CH,0),cH=AH[0],dH=(AH[1],new IH(32768)),uH=0;uH<32768;++uH){var hH=(43690&uH)>>>1|(21845&uH)<<1;hH=(61680&(hH=(52428&hH)>>>2|(13107&hH)<<2))>>>4|(3855&hH)<<4,dH[uH]=((65280&hH)>>>8|(255&hH)<<8)>>>1}var bH=function(e,g,t){for(var I=e.length,n=0,i=new IH(g);n<I;++n)++i[e[n]-1];var C,o=new IH(g);for(n=0;n<g;++n)o[n]=o[n-1]+i[n-1]<<1;if(t){C=new IH(1<<g);var a=15-g;for(n=0;n<I;++n)if(e[n])for(var s=n<<4|e[n],l=g-e[n],r=o[e[n]-1]++<<l,A=r|(1<<l)-1;r<=A;++r)C[dH[r]>>>a]=s}else for(C=new IH(I),n=0;n<I;++n)e[n]&&(C[n]=dH[o[e[n]-1]++]>>>15-e[n]);return C},mH=new tH(288);for(uH=0;uH<144;++uH)mH[uH]=8;for(uH=144;uH<256;++uH)mH[uH]=9;for(uH=256;uH<280;++uH)mH[uH]=7;for(uH=280;uH<288;++uH)mH[uH]=8;var pH=new tH(32);for(uH=0;uH<32;++uH)pH[uH]=5;var GH=bH(mH,9,1),BH=bH(pH,5,1),ZH=function(e){for(var g=e[0],t=1;t<e.length;++t)e[t]>g&&(g=e[t]);return g},yH=function(e,g,t){var I=g/8|0;return(e[I]|e[I+1]<<8)>>(7&g)&t},vH=function(e,g){var t=g/8|0;return(e[t]|e[t+1]<<8|e[t+2]<<16)>>(7&g)},WH=function(e){return(e/8|0)+(7&e&&1)},fH=function(e,g,t){var I=e.length;if(!I||t&&!t.l&&I<5)return g||new tH(0);var n=!g||t,i=!t||t.i;t||(t={}),g||(g=new tH(3*I));var C=function(e){var t=g.length;if(e>t){var I=new tH(Math.max(2*t,e));I.set(g),g=I}},o=t.f||0,a=t.p||0,s=t.b||0,l=t.l,r=t.d,A=t.m,c=t.n,d=8*I;do{if(!l){t.f=o=yH(e,a,1);var u=yH(e,a+1,3);if(a+=3,!u){var h=e[(w=WH(a)+4)-4]|e[w-3]<<8,b=w+h;if(b>I){if(i)throw"unexpected EOF";break}n&&C(s+h),g.set(e.subarray(w,b),s),t.b=s+=h,t.p=a=8*b;continue}if(1==u)l=GH,r=BH,A=9,c=5;else{if(2!=u)throw"invalid block type";var m=yH(e,a,31)+257,p=yH(e,a+10,15)+4,G=m+yH(e,a+5,31)+1;a+=14;for(var B=new tH(G),Z=new tH(19),y=0;y<p;++y)Z[oH[y]]=yH(e,a+3*y,7);a+=3*p;var v=ZH(Z),W=(1<<v)-1,f=bH(Z,v,1);for(y=0;y<G;){var w,R=f[yH(e,a,W)];if(a+=15&R,(w=R>>>4)<16)B[y++]=w;else{var V=0,X=0;for(16==w?(X=3+yH(e,a,3),a+=2,V=B[y-1]):17==w?(X=3+yH(e,a,7),a+=3):18==w&&(X=11+yH(e,a,127),a+=7);X--;)B[y++]=V}}var S=B.subarray(0,m),Y=B.subarray(m);A=ZH(S),c=ZH(Y),l=bH(S,A,1),r=bH(Y,c,1)}if(a>d){if(i)throw"unexpected EOF";break}}n&&C(s+131072);for(var K=(1<<A)-1,H=(1<<c)-1,N=a;;N=a){var F=(V=l[vH(e,a)&K])>>>4;if((a+=15&V)>d){if(i)throw"unexpected EOF";break}if(!V)throw"invalid length/literal";if(F<256)g[s++]=F;else{if(256==F){N=a,l=null;break}var x=F-254;if(F>264){var z=iH[y=F-257];x=yH(e,a,(1<<z)-1)+lH[y],a+=z}var k=r[vH(e,a)&H],M=k>>>4;if(!k)throw"invalid distance";if(a+=15&k,Y=cH[M],M>3&&(z=CH[M],Y+=vH(e,a)&(1<<z)-1,a+=z),a>d){if(i)throw"unexpected EOF";break}n&&C(s+131072);for(var L=s+x;s<L;s+=4)g[s]=g[s-Y],g[s+1]=g[s+1-Y],g[s+2]=g[s+2-Y],g[s+3]=g[s+3-Y];s=L}}t.l=l,t.p=N,t.b=s,l&&(o=1,t.m=A,t.d=r,t.n=c)}while(!o);return s==g.length?g:function(e,g,t){(null==g||g<0)&&(g=0),(null==t||t>e.length)&&(t=e.length);var I=new(e instanceof IH?IH:e instanceof nH?nH:tH)(t-g);return I.set(e.subarray(g,t)),I}(g,0,s)},wH=new tH(0);function RH(e,g){return fH((function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"}(e),e.subarray(2,-4)),g)}var VH="undefined"!=typeof TextDecoder&&new TextDecoder;try{VH.decode(wH,{stream:!0})}catch(e){}const XH="colorSpace"in new NI;class SH extends KA{constructor(e){super(e),this.type=Ue}parse(e){const g=65536,t=14,I=65537,n=Math.pow(2.7182818,2.2),i={l:0,c:0,lc:0};function C(e,g,t,I,n){for(;t<e;)g=g<<8|x(I,n),t+=8;t-=e,i.l=g>>t&(1<<e)-1,i.c=g,i.lc=t}const o=new Array(59);function a(e){return 63&e}function s(e){return e>>6}const l={c:0,lc:0};function r(e,g,t,I){e=e<<8|x(t,I),g+=8,l.c=e,l.lc=g}const A={c:0,lc:0};function c(e,g,t,I,n,i,C,o,a,s){if(e==g){I<8&&(r(t,I,n,C),t=l.c,I=l.lc);var c=t>>(I-=8);if(c=new Uint8Array([c])[0],a.value+c>s)return!1;for(var d=o[a.value-1];c-- >0;)o[a.value++]=d}else{if(!(a.value<s))return!1;o[a.value++]=e}A.c=t,A.lc=I}function d(e){return 65535&e}function u(e){var g=d(e);return g>32767?g-65536:g}const h={a:0,b:0};function b(e,g){var t=u(e),I=u(g),n=t+(1&I)+(I>>1),i=n,C=n-I;h.a=i,h.b=C}function m(e,g){var t=d(e),I=d(g),n=t-(I>>1)&65535,i=I+n-32768&65535;h.a=i,h.b=n}function p(e,g,t,I,n,i,C){for(var o,a=C<16384,s=t>n?n:t,l=1;l<=s;)l<<=1;for(o=l>>=1,l>>=1;l>=1;){for(var r,A,c,d,u=0,p=u+i*(n-o),G=i*l,B=i*o,Z=I*l,y=I*o;u<=p;u+=B){for(var v=u,W=u+I*(t-o);v<=W;v+=y){var f=v+Z,w=(R=v+G)+Z;a?(b(e[v+g],e[R+g]),r=h.a,c=h.b,b(e[f+g],e[w+g]),A=h.a,d=h.b,b(r,A),e[v+g]=h.a,e[f+g]=h.b,b(c,d),e[R+g]=h.a,e[w+g]=h.b):(m(e[v+g],e[R+g]),r=h.a,c=h.b,m(e[f+g],e[w+g]),A=h.a,d=h.b,m(r,A),e[v+g]=h.a,e[f+g]=h.b,m(c,d),e[R+g]=h.a,e[w+g]=h.b)}if(t&l){var R=v+G;a?b(e[v+g],e[R+g]):m(e[v+g],e[R+g]),r=h.a,e[R+g]=h.b,e[v+g]=r}}if(n&l)for(v=u,W=u+I*(t-o);v<=W;v+=y)f=v+Z,a?b(e[v+g],e[f+g]):m(e[v+g],e[f+g]),r=h.a,e[f+g]=h.b,e[v+g]=r;o=l,l>>=1}return u}function G(e,g,n,d,u,h){var b=n.value,m=F(g,n),p=F(g,n);n.value+=4;var G=F(g,n);if(n.value+=4,m<0||m>=I||p<0||p>=I)throw"Something wrong with HUF_ENCSIZE";var B=new Array(I),Z=new Array(16384);if(function(e){for(var g=0;g<16384;g++)e[g]={},e[g].len=0,e[g].lit=0,e[g].p=null}(Z),function(e,g,t,n,a,s,l){for(var r=t,A=0,c=0;a<=s;a++){if(r.value-t.value>n)return!1;C(6,A,c,e,r);var d=i.l;if(A=i.c,c=i.lc,l[a]=d,63==d){if(r.value-t.value>n)throw"Something wrong with hufUnpackEncTable";C(8,A,c,e,r);var u=i.l+6;if(A=i.c,c=i.lc,a+u>s+1)throw"Something wrong with hufUnpackEncTable";for(;u--;)l[a++]=0;a--}else if(d>=59){if(a+(u=d-59+2)>s+1)throw"Something wrong with hufUnpackEncTable";for(;u--;)l[a++]=0;a--}}!function(e){for(var g=0;g<=58;++g)o[g]=0;for(g=0;g<I;++g)o[e[g]]+=1;var t=0;for(g=58;g>0;--g){var n=t+o[g]>>1;o[g]=t,t=n}for(g=0;g<I;++g){var i=e[g];i>0&&(e[g]=i|o[i]++<<6)}}(l)}(e,0,n,d-(n.value-b),m,p,B),G>8*(d-(n.value-b)))throw"Something wrong with hufUncompress";!function(e,g,I,n){for(;g<=I;g++){var i=s(e[g]),C=a(e[g]);if(i>>C)throw"Invalid table entry";if(C>t){if((A=n[i>>C-t]).len)throw"Invalid table entry";if(A.lit++,A.p){var o=A.p;A.p=new Array(A.lit);for(var l=0;l<A.lit-1;++l)A.p[l]=o[l]}else A.p=new Array(1);A.p[A.lit-1]=g}else if(C){var r=0;for(l=1<<t-C;l>0;l--){var A;if((A=n[(i<<t-C)+r]).len||A.p)throw"Invalid table entry";A.len=C,A.lit=g,r++}}}}(B,m,p,Z),function(e,g,I,n,i,C,o,d,u,h){for(var b=0,m=0,p=d,G=Math.trunc(i.value+(C+7)/8);i.value<G;)for(r(b,m,I,i),b=l.c,m=l.lc;m>=t;)if((v=g[b>>m-t&16383]).len)m-=v.len,c(v.lit,o,b,m,I,0,i,u,h,p),b=A.c,m=A.lc;else{if(!v.p)throw"hufDecode issues";var B;for(B=0;B<v.lit;B++){for(var Z=a(e[v.p[B]]);m<Z&&i.value<G;)r(b,m,I,i),b=l.c,m=l.lc;if(m>=Z&&s(e[v.p[B]])==(b>>m-Z&(1<<Z)-1)){m-=Z,c(v.p[B],o,b,m,I,0,i,u,h,p),b=A.c,m=A.lc;break}}if(B==v.lit)throw"hufDecode issues"}var y=8-C&7;for(b>>=y,m-=y;m>0;){var v;if(!(v=g[b<<t-m&16383]).len)throw"hufDecode issues";m-=v.len,c(v.lit,o,b,m,I,0,i,u,h,p),b=A.c,m=A.lc}}(B,Z,e,0,n,G,p,h,u,{value:0})}function B(e){for(var g=1;g<e.length;g++){var t=e[g-1]+e[g]-128;e[g]=t}}function Z(e,g){for(var t=0,I=Math.floor((e.length+1)/2),n=0,i=e.length-1;!(n>i||(g[n++]=e[t++],n>i));)g[n++]=e[I++]}function y(e){for(var g=e.byteLength,t=new Array,I=0,n=new DataView(e);g>0;){var i=n.getInt8(I++);if(i<0){g-=1+(o=-i);for(var C=0;C<o;C++)t.push(n.getUint8(I++))}else{var o=i;g-=2;var a=n.getUint8(I++);for(C=0;C<o+1;C++)t.push(a)}}return t}function v(e,g,t){for(var I,n=1;n<64;)65280==(I=g[e.value])?n=64:I>>8==255?n+=255&I:(t[n]=I,n++),e.value++}function W(e){const g=.5*Math.cos(.7853975),t=.5*Math.cos(3.14159/16),I=.5*Math.cos(3.14159/8),n=.5*Math.cos(3*3.14159/16),i=.5*Math.cos(.981746875),C=.5*Math.cos(3*3.14159/8),o=.5*Math.cos(1.374445625);for(var a=new Array(4),s=new Array(4),l=new Array(4),r=new Array(4),A=0;A<8;++A){var c=8*A;a[0]=I*e[c+2],a[1]=C*e[c+2],a[2]=I*e[c+6],a[3]=C*e[c+6],s[0]=t*e[c+1]+n*e[c+3]+i*e[c+5]+o*e[c+7],s[1]=n*e[c+1]-o*e[c+3]-t*e[c+5]-i*e[c+7],s[2]=i*e[c+1]-t*e[c+3]+o*e[c+5]+n*e[c+7],s[3]=o*e[c+1]-i*e[c+3]+n*e[c+5]-t*e[c+7],l[0]=g*(e[c+0]+e[c+4]),l[3]=g*(e[c+0]-e[c+4]),l[1]=a[0]+a[3],l[2]=a[1]-a[2],r[0]=l[0]+l[1],r[1]=l[3]+l[2],r[2]=l[3]-l[2],r[3]=l[0]-l[1],e[c+0]=r[0]+s[0],e[c+1]=r[1]+s[1],e[c+2]=r[2]+s[2],e[c+3]=r[3]+s[3],e[c+4]=r[3]-s[3],e[c+5]=r[2]-s[2],e[c+6]=r[1]-s[1],e[c+7]=r[0]-s[0]}for(var d=0;d<8;++d)a[0]=I*e[16+d],a[1]=C*e[16+d],a[2]=I*e[48+d],a[3]=C*e[48+d],s[0]=t*e[8+d]+n*e[24+d]+i*e[40+d]+o*e[56+d],s[1]=n*e[8+d]-o*e[24+d]-t*e[40+d]-i*e[56+d],s[2]=i*e[8+d]-t*e[24+d]+o*e[40+d]+n*e[56+d],s[3]=o*e[8+d]-i*e[24+d]+n*e[40+d]-t*e[56+d],l[0]=g*(e[d]+e[32+d]),l[3]=g*(e[d]-e[32+d]),l[1]=a[0]+a[3],l[2]=a[1]-a[2],r[0]=l[0]+l[1],r[1]=l[3]+l[2],r[2]=l[3]-l[2],r[3]=l[0]-l[1],e[0+d]=r[0]+s[0],e[8+d]=r[1]+s[1],e[16+d]=r[2]+s[2],e[24+d]=r[3]+s[3],e[32+d]=r[3]-s[3],e[40+d]=r[2]-s[2],e[48+d]=r[1]-s[1],e[56+d]=r[0]-s[0]}function f(e){for(var g=0;g<64;++g){var t=e[0][g],I=e[1][g],n=e[2][g];e[0][g]=t+1.5747*n,e[1][g]=t-.1873*I-.4682*n,e[2][g]=t+1.8556*I}}function w(e,g,t){for(var I=0;I<64;++I)g[t+I]=pi.toHalfFloat((i=e[I])<=1?Math.sign(i)*Math.pow(Math.abs(i),2.2):Math.sign(i)*Math.pow(n,Math.abs(i)-1));var i}function R(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function V(e){var g=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),t=new Uint8Array(y(g)),I=new Uint8Array(t.length);return B(t),Z(t,I),new DataView(I.buffer)}function X(e){var g=RH(e.array.slice(e.offset.value,e.offset.value+e.size)),t=new Uint8Array(g.length);return B(g),Z(g,t),new DataView(t.buffer)}function S(e){for(var t=e.viewer,I={value:e.offset.value},n=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),i=new Uint8Array(8192),C=0,o=new Array(e.channels),a=0;a<e.channels;a++)o[a]={},o[a].start=C,o[a].end=o[a].start,o[a].nx=e.width,o[a].ny=e.lines,o[a].size=e.type,C+=o[a].nx*o[a].ny*o[a].size;var s=E(t,I),l=E(t,I);if(l>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(s<=l)for(a=0;a<l-s+1;a++)i[a+s]=z(t,I);var r=new Uint16Array(g),A=function(e,t){for(var I=0,n=0;n<g;++n)(0==n||e[n>>3]&1<<(7&n))&&(t[I++]=n);for(var i=I-1;I<g;)t[I++]=0;return i}(i,r),c=F(t,I);for(G(e.array,t,I,c,n,C),a=0;a<e.channels;++a)for(var d=o[a],u=0;u<o[a].size;++u)p(n,d.start+u,d.nx,d.size,d.ny,d.nx*d.size,A);!function(e,g,t){for(var I=0;I<t;++I)g[I]=e[g[I]]}(r,n,C);for(var h=0,b=new Uint8Array(n.buffer.byteLength),m=0;m<e.lines;m++)for(var B=0;B<e.channels;B++){var Z=(d=o[B]).nx*d.size,y=new Uint8Array(n.buffer,2*d.end,2*Z);b.set(y,h),h+=2*Z,d.end+=Z}return new DataView(b.buffer)}function Y(e){var g=RH(e.array.slice(e.offset.value,e.offset.value+e.size));const t=e.lines*e.channels*e.width,I=1==e.type?new Uint16Array(t):new Uint32Array(t);let n=0,i=0;const C=new Array(4);for(let t=0;t<e.lines;t++)for(let t=0;t<e.channels;t++){let t=0;switch(e.type){case 1:C[0]=n,C[1]=C[0]+e.width,n=C[1]+e.width;for(let n=0;n<e.width;++n)t+=g[C[0]++]<<8|g[C[1]++],I[i]=t,i++;break;case 2:C[0]=n,C[1]=C[0]+e.width,C[2]=C[1]+e.width,n=C[2]+e.width;for(let n=0;n<e.width;++n)t+=g[C[0]++]<<24|g[C[1]++]<<16|g[C[2]++]<<8,I[i]=t,i++}}return new DataView(I.buffer)}function K(e){var g=e.viewer,t={value:e.offset.value},I=new Uint8Array(e.width*e.lines*(e.channels*e.type*2)),n={version:k(g,t),unknownUncompressedSize:k(g,t),unknownCompressedSize:k(g,t),acCompressedSize:k(g,t),dcCompressedSize:k(g,t),rleCompressedSize:k(g,t),rleUncompressedSize:k(g,t),rleRawSize:k(g,t),totalAcUncompressedCount:k(g,t),totalDcUncompressedCount:k(g,t),acCompression:k(g,t)};if(n.version<2)throw"EXRLoader.parse: "+j.compression+" version "+n.version+" is unsupported";for(var i=new Array,C=E(g,t)-2;C>0;){var o=H(g.buffer,t),a=z(g,t),s=a>>2&3,l=new Int8Array([(a>>4)-1])[0],r=z(g,t);i.push({name:o,index:l,type:r,compression:s}),C-=o.length+3}for(var A=j.channels,c=new Array(e.channels),d=0;d<e.channels;++d){var u=c[d]={},h=A[d];u.name=h.name,u.compression=0,u.decoded=!1,u.type=h.pixelType,u.pLinear=h.pLinear,u.width=e.width,u.height=e.lines}for(var b={idx:new Array(3)},m=0;m<e.channels;++m)for(u=c[m],d=0;d<i.length;++d){var p=i[d];u.name==p.name&&(u.compression=p.compression,p.index>=0&&(b.idx[p.index]=m),u.offset=m)}if(n.acCompressedSize>0)switch(n.acCompression){case 0:var B=new Uint16Array(n.totalAcUncompressedCount);G(e.array,g,t,n.acCompressedSize,B,n.totalAcUncompressedCount);break;case 1:var Z=RH(e.array.slice(t.value,t.value+n.totalAcUncompressedCount));B=new Uint16Array(Z.buffer),t.value+=n.totalAcUncompressedCount}if(n.dcCompressedSize>0){var R={array:e.array,offset:t,size:n.dcCompressedSize},V=new Uint16Array(X(R).buffer);t.value+=n.dcCompressedSize}if(n.rleRawSize>0){var S=y((Z=RH(e.array.slice(t.value,t.value+n.rleCompressedSize))).buffer);t.value+=n.rleCompressedSize}var Y=0,K=new Array(c.length);for(d=0;d<K.length;++d)K[d]=new Array;for(var N=0;N<e.lines;++N)for(var F=0;F<c.length;++F)K[F].push(Y),Y+=c[F].width*e.type*2;for(function(e,g,t,I,n,i){var C,o,a=new DataView(i.buffer),s=t[e.idx[0]].width,l=t[e.idx[0]].height,r=Math.floor(s/8),A=Math.ceil(s/8),c=Math.ceil(l/8),d=s-8*(A-1),u=l-8*(c-1),h={value:0},b=new Array(3),m=new Array(3),p=new Array(3),G=new Array(3),B=new Array(3);for(let t=0;t<3;++t)B[t]=g[e.idx[t]],b[t]=t<1?0:b[t-1]+A*c,m[t]=new Float32Array(64),p[t]=new Uint16Array(64),G[t]=new Uint16Array(64*A);for(let g=0;g<c;++g){var Z=8;g==c-1&&(Z=u);var y=8;for(let e=0;e<A;++e){e==A-1&&(y=d);for(let e=0;e<3;++e)p[e].fill(0),p[e][0]=n[b[e]++],v(h,I,p[e]),C=p[e],(o=m[e])[0]=J(C[0]),o[1]=J(C[1]),o[2]=J(C[5]),o[3]=J(C[6]),o[4]=J(C[14]),o[5]=J(C[15]),o[6]=J(C[27]),o[7]=J(C[28]),o[8]=J(C[2]),o[9]=J(C[4]),o[10]=J(C[7]),o[11]=J(C[13]),o[12]=J(C[16]),o[13]=J(C[26]),o[14]=J(C[29]),o[15]=J(C[42]),o[16]=J(C[3]),o[17]=J(C[8]),o[18]=J(C[12]),o[19]=J(C[17]),o[20]=J(C[25]),o[21]=J(C[30]),o[22]=J(C[41]),o[23]=J(C[43]),o[24]=J(C[9]),o[25]=J(C[11]),o[26]=J(C[18]),o[27]=J(C[24]),o[28]=J(C[31]),o[29]=J(C[40]),o[30]=J(C[44]),o[31]=J(C[53]),o[32]=J(C[10]),o[33]=J(C[19]),o[34]=J(C[23]),o[35]=J(C[32]),o[36]=J(C[39]),o[37]=J(C[45]),o[38]=J(C[52]),o[39]=J(C[54]),o[40]=J(C[20]),o[41]=J(C[22]),o[42]=J(C[33]),o[43]=J(C[38]),o[44]=J(C[46]),o[45]=J(C[51]),o[46]=J(C[55]),o[47]=J(C[60]),o[48]=J(C[21]),o[49]=J(C[34]),o[50]=J(C[37]),o[51]=J(C[47]),o[52]=J(C[50]),o[53]=J(C[56]),o[54]=J(C[59]),o[55]=J(C[61]),o[56]=J(C[35]),o[57]=J(C[36]),o[58]=J(C[48]),o[59]=J(C[49]),o[60]=J(C[57]),o[61]=J(C[58]),o[62]=J(C[62]),o[63]=J(C[63]),W(m[e]);f(m);for(let g=0;g<3;++g)w(m[g],G[g],64*e)}let i=0;for(let I=0;I<3;++I){const n=t[e.idx[I]].type;for(let e=8*g;e<8*g+Z;++e){i=B[I][e];for(let g=0;g<r;++g){const t=64*g+8*(7&e);a.setUint16(i+0*n,G[I][t+0],!0),a.setUint16(i+2*n,G[I][t+1],!0),a.setUint16(i+4*n,G[I][t+2],!0),a.setUint16(i+6*n,G[I][t+3],!0),a.setUint16(i+8*n,G[I][t+4],!0),a.setUint16(i+10*n,G[I][t+5],!0),a.setUint16(i+12*n,G[I][t+6],!0),a.setUint16(i+14*n,G[I][t+7],!0),i+=16*n}}if(r!=A)for(let e=8*g;e<8*g+Z;++e){const g=B[I][e]+8*r*2*n,t=64*r+8*(7&e);for(let e=0;e<y;++e)a.setUint16(g+2*e*n,G[I][t+e],!0)}}}for(var R=new Uint16Array(s),V=(a=new DataView(i.buffer),0);V<3;++V){t[e.idx[V]].decoded=!0;var X=t[e.idx[V]].type;if(2==t[V].type)for(var S=0;S<l;++S){const e=B[V][S];for(var Y=0;Y<s;++Y)R[Y]=a.getUint16(e+2*Y*X,!0);for(Y=0;Y<s;++Y)a.setFloat32(e+2*Y*X,J(R[Y]),!0)}}}(b,K,c,B,V,I),d=0;d<c.length;++d)if(!(u=c[d]).decoded){if(2!==u.compression)throw"EXRLoader.parse: unsupported channel compression";var x=0,M=0;for(N=0;N<e.lines;++N){for(var L=K[d][x],T=0;T<u.width;++T){for(var U=0;U<2*u.type;++U)I[L++]=S[M+U*u.width*u.height];M++}x++}}return new DataView(I.buffer)}function H(e,g){for(var t=new Uint8Array(e),I=0;0!=t[g.value+I];)I+=1;var n=(new TextDecoder).decode(t.slice(g.value,g.value+I));return g.value=g.value+I+1,n}function N(e,g){var t=e.getInt32(g.value,!0);return g.value=g.value+4,t}function F(e,g){var t=e.getUint32(g.value,!0);return g.value=g.value+4,t}function x(e,g){var t=e[g.value];return g.value=g.value+1,t}function z(e,g){var t=e.getUint8(g.value);return g.value=g.value+1,t}const k=function(e,g){let t;return t="getBigInt64"in DataView.prototype?Number(e.getBigInt64(g.value,!0)):e.getUint32(g.value+4,!0)+Number(e.getUint32(g.value,!0)<<32),g.value+=8,t};function M(e,g){var t=e.getFloat32(g.value,!0);return g.value+=4,t}function L(e,g){return pi.toHalfFloat(M(e,g))}function J(e){var g=(31744&e)>>10,t=1023&e;return(e>>15?-1:1)*(g?31===g?t?NaN:1/0:Math.pow(2,g-15)*(1+t/1024):t/1024*6103515625e-14)}function E(e,g){var t=e.getUint16(g.value,!0);return g.value+=2,t}function T(e,g){return J(E(e,g))}function U(e,g,t,I,n){return"string"===I||"stringvector"===I||"iccProfile"===I?function(e,g,t){var I=(new TextDecoder).decode(new Uint8Array(e).slice(g.value,g.value+t));return g.value=g.value+t,I}(g,t,n):"chlist"===I?function(e,g,t,I){for(var n=t.value,i=[];t.value<n+I-1;){var C=H(g,t),o=N(e,t),a=z(e,t);t.value+=3;var s=N(e,t),l=N(e,t);i.push({name:C,pixelType:o,pLinear:a,xSampling:s,ySampling:l})}return t.value+=1,i}(e,g,t,n):"chromaticities"===I?function(e,g){return{redX:M(e,g),redY:M(e,g),greenX:M(e,g),greenY:M(e,g),blueX:M(e,g),blueY:M(e,g),whiteX:M(e,g),whiteY:M(e,g)}}(e,t):"compression"===I?function(e,g){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][z(e,g)]}(e,t):"box2i"===I?function(e,g){return{xMin:F(e,g),yMin:F(e,g),xMax:F(e,g),yMax:F(e,g)}}(e,t):"lineOrder"===I?function(e,g){return["INCREASING_Y"][z(e,g)]}(e,t):"float"===I?M(e,t):"v2f"===I?function(e,g){return[M(e,g),M(e,g)]}(e,t):"v3f"===I?function(e,g){return[M(e,g),M(e,g),M(e,g)]}(e,t):"int"===I?N(e,t):"rational"===I?function(e,g){return[N(e,g),F(e,g)]}(e,t):"timecode"===I?function(e,g){return[F(e,g),F(e,g)]}(e,t):"preview"===I?(t.value+=n,"skipped"):void(t.value+=n)}const Q=new DataView(e),D=new Uint8Array(e),O={value:0},j=function(e,g,t){const I={};if(20000630!=e.getUint32(0,!0))throw"THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.";I.version=e.getUint8(4);const n=e.getUint8(5);I.spec={singleTile:!!(2&n),longName:!!(4&n),deepFormat:!!(8&n),multiPart:!!(16&n)},t.value=8;for(var i=!0;i;){var C=H(g,t);if(0==C)i=!1;else{var o=H(g,t),a=U(e,g,t,o,F(e,t));void 0===a?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${o}'.`):I[C]=a}}if(0!=n)throw console.error("EXRHeader:",I),"THREE.EXRLoader: provided file is currently unsupported.";return I}(Q,e,O),P=function(e,g,t,I,n){const i={size:0,viewer:g,array:t,offset:I,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:e.channels[0].pixelType,uncompress:null,getter:null,format:null,[XH?"colorSpace":"encoding"]:null};switch(e.compression){case"NO_COMPRESSION":i.lines=1,i.uncompress=R;break;case"RLE_COMPRESSION":i.lines=1,i.uncompress=V;break;case"ZIPS_COMPRESSION":i.lines=1,i.uncompress=X;break;case"ZIP_COMPRESSION":i.lines=16,i.uncompress=X;break;case"PIZ_COMPRESSION":i.lines=32,i.uncompress=S;break;case"PXR24_COMPRESSION":i.lines=16,i.uncompress=Y;break;case"DWAA_COMPRESSION":i.lines=32,i.uncompress=K;break;case"DWAB_COMPRESSION":i.lines=256,i.uncompress=K;break;default:throw"EXRLoader.parse: "+e.compression+" is unsupported"}if(i.scanlineBlockSize=i.lines,1==i.type)switch(n){case Te:i.getter=T,i.inputSize=2;break;case Ue:i.getter=E,i.inputSize=2}else{if(2!=i.type)throw"EXRLoader.parse: unsupported pixelType "+i.type+" for "+e.compression+".";switch(n){case Te:i.getter=M,i.inputSize=4;break;case Ue:i.getter=L,i.inputSize=4}}i.blockCount=(e.dataWindow.yMax+1)/i.scanlineBlockSize;for(var C=0;C<i.blockCount;C++)k(g,I);i.outputChannels=3==i.channels?4:i.channels;const o=i.width*i.height*i.outputChannels;switch(n){case Te:i.byteArray=new Float32Array(o),i.channels<i.outputChannels&&i.byteArray.fill(1,0,o);break;case Ue:i.byteArray=new Uint16Array(o),i.channels<i.outputChannels&&i.byteArray.fill(15360,0,o);break;default:console.error("THREE.EXRLoader: unsupported type: ",n)}return i.bytesPerLine=i.width*i.inputSize*i.channels,4==i.outputChannels?i.format=Pe:i.format=gg,XH?i.colorSpace="srgb-linear":i.encoding=3e3,i}(j,Q,D,O,this.type),_={value:0},q={R:0,G:1,B:2,A:3,Y:0};for(let e=0;e<P.height/P.scanlineBlockSize;e++){const g=F(Q,O);P.size=F(Q,O),P.lines=g+P.scanlineBlockSize>P.height?P.height-g:P.scanlineBlockSize;const t=P.size<P.lines*P.bytesPerLine?P.uncompress(P):R(P);O.value+=P.size;for(let g=0;g<P.scanlineBlockSize;g++){const I=g+e*P.scanlineBlockSize;if(I>=P.height)break;for(let e=0;e<P.channels;e++){const n=q[j.channels[e].name];for(let i=0;i<P.width;i++){_.value=(g*(P.channels*P.width)+e*P.width+i)*P.inputSize;const C=(P.height-1-I)*(P.width*P.outputChannels)+i*P.outputChannels+n;P.byteArray[C]=P.getter(t,_)}}}}return{header:j,width:P.width,height:P.height,data:P.byteArray,format:P.format,[XH?"colorSpace":"encoding"]:P[XH?"colorSpace":"encoding"],type:this.type}}setDataType(e){return this.type=e,this}load(e,g,t,I){return super.load(e,(function(e,t){XH?e.colorSpace=t.colorSpace:e.encoding=t.encoding,e.minFilter=Ke,e.magFilter=Ke,e.generateMipmaps=!1,e.flipY=!1,g&&g(e,t)}),t,I)}}const YH={apartment:"lebombo_1k.hdr",city:"potsdamer_platz_1k.hdr",dawn:"kiara_1_dawn_1k.hdr",forest:"forest_slope_1k.hdr",lobby:"st_fagans_interior_1k.hdr",night:"dikhololo_night_1k.hdr",park:"rooitou_park_1k.hdr",studio:"studio_small_03_1k.hdr",sunset:"venice_sunset_1k.hdr",warehouse:"empty_warehouse_01_1k.hdr"},KH="https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/",HH=e=>Array.isArray(e);function NH({files:e=["/px.png","/nx.png","/py.png","/ny.png","/pz.png","/nz.png"],path:g="",preset:t,encoding:I,extensions:n}={}){var i,C,o;let a,s=null,l=!1;if(t){if(!(t in YH))throw new Error("Preset must be one of: "+Object.keys(YH).join(", "));e=YH[t],g=KH}if(l=HH(e),a=HH(e)?"cube":e.startsWith("data:application/exr")?"exr":e.startsWith("data:application/hdr")?"hdr":null==(i=e.split(".").pop())||null==(C=i.split("?"))||null==(o=C.shift())?void 0:o.toLowerCase(),s=l?YA:"hdr"===a?gH:"exr"===a?SH:null,!s)throw new Error("useEnvironment: Unrecognized file extension: "+e);const r=Mu(s,l?[e]:e,(e=>{null==e.setPath||e.setPath(g),n&&n(e)})),A=l?r[0]:r;return A.mapping=l?Ge:Ze,"colorSpace"in A?A.colorSpace=(null!=I?I:l)?"srgb":"srgb-linear":A.encoding=(null!=I?I:l)?3001:3e3,A}const FH=e=>{return(g=e).current&&g.current.isScene?e.current:e;var g};function xH(e,g,t,I,n=0){const i=FH(g||t),C=i.background,o=i.environment,a=i.backgroundBlurriness||0;return"only"!==e&&(i.environment=I),e&&(i.background=I),e&&void 0!==i.backgroundBlurriness&&(i.backgroundBlurriness=n),()=>{"only"!==e&&(i.environment=o),e&&(i.background=C),e&&void 0!==i.backgroundBlurriness&&(i.backgroundBlurriness=a)}}function zH({scene:e,background:t=!1,blur:I,map:n}){const i=Fu((e=>e.scene));return g.useLayoutEffect((()=>{if(n)return xH(t,e,i,n,I)}),[i,e,n,t,I]),null}function kH({background:e=!1,scene:t,blur:I,...n}){const i=NH(n),C=Fu((e=>e.scene));return g.useLayoutEffect((()=>xH(e,t,C,i,I)),[i,e,t,C,I]),null}function MH({children:e,near:t=1,far:I=1e3,resolution:n=256,frames:i=1,map:C,background:o=!1,blur:a,scene:s,files:l,path:r,preset:A,extensions:c}){const d=Fu((e=>e.gl)),u=Fu((e=>e.scene)),h=g.useRef(null),[b]=g.useState((()=>new os)),m=g.useMemo((()=>{const e=new bC(n);return e.texture.type=Ue,e}),[n]);g.useLayoutEffect((()=>(1===i&&h.current.update(d,b),xH(o,s,u,m.texture,a))),[e,b,m.texture,s,u,o,i,d]);let p=1;return xu((()=>{(i===1/0||p<i)&&(h.current.update(d,b),p++)})),g.createElement(g.Fragment,null,function(e,t,I){return g.createElement(_u,{key:t.uuid,children:e,container:t,state:void 0})}(g.createElement(g.Fragment,null,e,g.createElement("cubeCamera",{ref:h,args:[t,I,m]}),l||A?g.createElement(kH,{background:!0,files:l,preset:A,path:r,extensions:c}):C?g.createElement(zH,{background:!0,map:C,extensions:c}):null),b))}function LH(e){var t,I,n,i;const C=NH(e),o=e.map||C;g.useMemo((()=>Qd({GroundProjectedEnvImpl:eH})),[]);const a=g.useMemo((()=>[o]),[o]),s=null==(t=e.ground)?void 0:t.height,l=null==(I=e.ground)?void 0:I.radius,r=null!==(n=null==(i=e.ground)?void 0:i.scale)&&void 0!==n?n:1e3;return g.createElement(g.Fragment,null,g.createElement(zH,qu({},e,{map:o})),g.createElement("groundProjectedEnvImpl",{args:a,scale:r,height:s,radius:l}))}function JH(e){return e.ground?g.createElement(LH,e):e.map?g.createElement(zH,e):e.children?g.createElement(MH,e):g.createElement(kH,e)}function EH(e,g){return function(e){if(Array.isArray(e))return e}(e)||function(e,g){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var I,n,i,C,o=[],a=!0,s=!1;try{if(i=(t=t.call(e)).next,0===g){if(Object(t)!==t)return;a=!1}else for(;!(a=(I=i.call(t)).done)&&(o.push(I.value),o.length!==g);a=!0);}catch(e){s=!0,n=e}finally{try{if(!a&&null!=t.return&&(C=t.return(),Object(C)!==C))return}finally{if(s)throw n}}return o}}(e,g)||function(e,g){if(e){if("string"==typeof e)return TH(e,g);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?TH(e,g):void 0}}(e,g)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function TH(e,g){(null==g||g>e.length)&&(g=e.length);for(var t=0,I=new Array(g);t<g;t++)I[t]=e[t];return I}function UH(e){var g=EH(Tp((function(){return{mass:0,position:[0,0,-10],args:[20,20,1]}})),1)[0],t=EH(Tp((function(){return{mass:0,position:[10,0,0],args:[1,20,20]}})),1)[0];return(0,Lh.jsxs)("group",{children:[(0,Lh.jsxs)("mesh",{ref:g,position:[0,0,-10],children:[(0,Lh.jsx)("boxGeometry",{args:[20,20,1]}),(0,Lh.jsx)("meshStandardMaterial",{color:"brown"})]}),(0,Lh.jsxs)("mesh",{ref:t,position:[10,0,0],children:[(0,Lh.jsx)("boxGeometry",{args:[1,20,20]}),(0,Lh.jsx)("meshStandardMaterial",{color:"brown"})]}),(0,Lh.jsxs)("mesh",{ref:t,position:[-10,0,0],children:[(0,Lh.jsx)("boxGeometry",{args:[1,20,20]}),(0,Lh.jsx)("meshStandardMaterial",{color:"brown"})]})]})}function QH(){return function(e,t,I,n){void 0===n&&(n=[]);const{worker:i}=Yp(),[C]=(0,g.useState)((()=>rI.generateUUID()));(0,g.useEffect)((()=>(i.addContactMaterial({props:["ground","slippery",I],uuid:C}),()=>{i.removeContactMaterial({uuid:C})})),n)}(0,0,{friction:0,restitution:.3,contactEquationStiffness:1e8,contactEquationRelaxation:3}),console.log("running"),(0,Lh.jsxs)(Lh.Fragment,{children:[(0,Lh.jsx)($K,{distance:45e4,sunPosition:[0,90,0],inclination:0,azimuth:.25}),(0,Lh.jsx)(JH,{preset:"sunset",background:!0}),(0,Lh.jsx)(sG,{}),(0,Lh.jsx)(UH,{}),(0,Lh.jsx)(bG,{}),(0,Lh.jsx)(sy,{position:[0,.5,0]})]})}mB.preload("/uploads_files_4048489_City+center+at+night+.gltf"),mB.preload("/uploads_files_4048489_City+center+at+night+.gltf"),mB.preload("/uploads_files_4048489_City+center+at+night+.gltf"),mB.preload("/uploads_files_4048489_City+center+at+night+.gltf");const DH=g.memo(QH),OH=function(e){var g=e.health;return(0,Lh.jsx)("div",{style:{position:"fixed",bottom:"10px",left:"10px",width:"200px",height:"25px",border:"1px solid black",backgroundColor:"white"},children:(0,Lh.jsx)("div",{style:{width:"".concat(g,"%"),height:"100%",backgroundColor:"red"}})})};function jH(){var e=fh().progress;return(0,Lh.jsxs)(Nh,{center:!0,children:[e," % loaded"]})}function PH(){var e=oG((function(e){return{playerHealth:e.playerHealth}})).playerHealth;return(0,Lh.jsxs)(Lh.Fragment,{children:[(0,Lh.jsx)(yh,{shadows:!0,onPointerDown:function(e){return e.target.requestPointerLock()},children:(0,Lh.jsxs)(g.Suspense,{fallback:(0,Lh.jsx)(jH,{}),children:[(0,Lh.jsx)("ambientLight",{}),(0,Lh.jsx)("spotLight",{position:[2.5,5,5],angle:Math.PI/3,penumbra:.5,castShadow:!0,"shadow-mapSize-height":2048,"shadow-mapSize-width":2048,intensity:25*Math.PI}),(0,Lh.jsx)(qp,{children:(0,Lh.jsx)(DH,{})}),(0,Lh.jsx)(kh,{})]})}),(0,Lh.jsx)(OH,{health:e})]})}(0,I.s)(document.getElementById("root")).render((0,Lh.jsx)(g.StrictMode,{children:(0,Lh.jsx)(PH,{})}))})()})();